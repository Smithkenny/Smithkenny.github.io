<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>k8s网路通信 - My New Hugo Site</title><meta name=Description content="This is my cool site"><meta property="og:title" content="k8s网路通信"><meta property="og:description" content="基于k8s中cni插件calico网络原理使用总结 1.实验环境 name version ip cni master v1.22.2 ens33:10.4.7.60 calico worker1 v1.22.2 ens33:10.4.7.61 calico worker2 v1.22.2 ens33:10.4.7.62 calico 2.实验整体拓扑 3.部署一个deployment 问题1 pod的ip从哪里来？
由kube-controller-manager来分配。
root@master:~# cat /etc/kubernetes/manifests/kube-controller-manager.yaml | grep cidr - --allocate-node-cidrs=true - --cluster-cidr=10.244.0.0/16 问题2 如何确定集群上正在使用的cni网络插件?
在master节点上查看
问题3 在k8s中，docker 使用的是bridge（网桥）模式，并且始终处于Down状态，那么calico使用的也是网桥模式码？
使用ip -d a可以查看网卡模式.
calico使用都是vxlan技术。
root@master:~# ip -d a 1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 promiscuity 0 minmtu 0 maxmtu 0 numtxqueues 1 numrxqueues 1 gso_max_size 65536 gso_max_segs 65535 inet 127."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.haipengv.com/posts/k8s%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-03-25T22:44:37+00:00"><meta property="article:modified_time" content="2022-03-25T22:44:37+00:00"><meta property="og:site_name" content="My cool site"><meta name=twitter:card content="summary"><meta name=twitter:title content="k8s网路通信"><meta name=twitter:description content="基于k8s中cni插件calico网络原理使用总结 1.实验环境 name version ip cni master v1.22.2 ens33:10.4.7.60 calico worker1 v1.22.2 ens33:10.4.7.61 calico worker2 v1.22.2 ens33:10.4.7.62 calico 2.实验整体拓扑 3.部署一个deployment 问题1 pod的ip从哪里来？
由kube-controller-manager来分配。
root@master:~# cat /etc/kubernetes/manifests/kube-controller-manager.yaml | grep cidr - --allocate-node-cidrs=true - --cluster-cidr=10.244.0.0/16 问题2 如何确定集群上正在使用的cni网络插件?
在master节点上查看
问题3 在k8s中，docker 使用的是bridge（网桥）模式，并且始终处于Down状态，那么calico使用的也是网桥模式码？
使用ip -d a可以查看网卡模式.
calico使用都是vxlan技术。
root@master:~# ip -d a 1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 promiscuity 0 minmtu 0 maxmtu 0 numtxqueues 1 numrxqueues 1 gso_max_size 65536 gso_max_segs 65535 inet 127."><meta name=application-name content="My cool site"><meta name=apple-mobile-web-app-title content="My cool site"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://blog.haipengv.com/posts/k8s%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1/><link rel=prev href=https://blog.haipengv.com/posts/pam%E6%A8%A1%E5%9D%97%E9%99%90%E5%88%B6%E7%99%BB%E5%BD%95/><link rel=next href=https://blog.haipengv.com/posts/%E6%A8%A1%E5%9D%97%E4%B8%8E%E5%8C%85/><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"k8s网路通信","inLanguage":"en-us","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.haipengv.com\/posts\/k8s%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1\/"},"genre":"posts","wordcount":622,"url":"https:\/\/blog.haipengv.com\/posts\/k8s%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1\/","datePublished":"2022-03-25T22:44:37+00:00","dateModified":"2022-03-25T22:44:37+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Author"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="My New Hugo Site">My cool site</a></div><div class=menu><div class=menu-inner><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="My New Hugo Site">My cool site</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">k8s网路通信</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Author</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2022-03-25>2022-03-25</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;622 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;3 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#基于k8s中cni插件calico网络原理使用总结>基于k8s中cni插件calico网络原理使用总结</a><ul><li><a href=#1实验环境>1.实验环境</a></li><li><a href=#2实验整体拓扑>2.实验整体拓扑</a></li><li><a href=#3部署一个deployment>3.部署一个deployment</a></li></ul></li></ul></nav></div></div><div class=content id=content><h2 id=基于k8s中cni插件calico网络原理使用总结>基于k8s中cni插件calico网络原理使用总结</h2><h3 id=1实验环境>1.实验环境</h3><table><thead><tr><th style=text-align:center>name</th><th style=text-align:center>version</th><th style=text-align:center>ip</th><th style=text-align:center>cni</th></tr></thead><tbody><tr><td style=text-align:center>master</td><td style=text-align:center>v1.22.2</td><td style=text-align:center>ens33:10.4.7.60</td><td style=text-align:center>calico</td></tr><tr><td style=text-align:center>worker1</td><td style=text-align:center>v1.22.2</td><td style=text-align:center>ens33:10.4.7.61</td><td style=text-align:center>calico</td></tr><tr><td style=text-align:center>worker2</td><td style=text-align:center>v1.22.2</td><td style=text-align:center>ens33:10.4.7.62</td><td style=text-align:center>calico</td></tr></tbody></table><h3 id=2实验整体拓扑>2.实验整体拓扑</h3><p><img class=lazyload src=/svg/loading.min.svg data-src=/img/postimages/%e6%95%b4%e4%bd%93%e6%8b%93%e6%89%91.webp data-srcset="/img/postimages/%e6%95%b4%e4%bd%93%e6%8b%93%e6%89%91.webp, /img/postimages/%e6%95%b4%e4%bd%93%e6%8b%93%e6%89%91.webp 1.5x, /img/postimages/%e6%95%b4%e4%bd%93%e6%8b%93%e6%89%91.webp 2x" data-sizes=auto alt=/img/postimages/整体拓扑.webp title=整体拓扑></p><h3 id=3部署一个deployment>3.部署一个deployment</h3><p><img class=lazyload src=/svg/loading.min.svg data-src=/img/postimages/deploy1.webp data-srcset="/img/postimages/deploy1.webp, /img/postimages/deploy1.webp 1.5x, /img/postimages/deploy1.webp 2x" data-sizes=auto alt=/img/postimages/deploy1.webp title=deploy1></p><h4 id=问题1>问题1</h4><p>pod的ip从哪里来？</p><p>由<code>kube-controller-manager</code>来分配。</p><pre tabindex=0><code>root@master:~# cat /etc/kubernetes/manifests/kube-controller-manager.yaml | grep cidr
    - --allocate-node-cidrs=true
    - --cluster-cidr=10.244.0.0/16
</code></pre><h4 id=问题2>问题2</h4><p>如何确定集群上正在使用的cni网络插件?</p><p>在master节点上查看</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/img/postimages/calico.webp data-srcset="/img/postimages/calico.webp, /img/postimages/calico.webp 1.5x, /img/postimages/calico.webp 2x" data-sizes=auto alt=/img/postimages/calico.webp title=calico></p><h4 id=问题3>问题3</h4><p>在k8s中，docker 使用的是bridge（网桥）模式，并且始终处于Down状态，那么calico使用的也是网桥模式码？</p><p>使用<code>ip -d a</code>可以查看网卡模式.</p><p>calico使用都是vxlan技术。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>root@master:~# ip -d a  
</span></span><span style=display:flex><span>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span style=color:#ae81ff>65536</span> qdisc noqueue state UNKNOWN group default qlen <span style=color:#ae81ff>1000</span>
</span></span><span style=display:flex><span>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 promiscuity <span style=color:#ae81ff>0</span> minmtu <span style=color:#ae81ff>0</span> maxmtu <span style=color:#ae81ff>0</span> numtxqueues <span style=color:#ae81ff>1</span> numrxqueues <span style=color:#ae81ff>1</span> gso_max_size <span style=color:#ae81ff>65536</span> gso_max_segs <span style=color:#ae81ff>65535</span> 
</span></span><span style=display:flex><span>    inet 127.0.0.1/8 scope host lo
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span><span style=display:flex><span>    inet6 ::1/128 scope host 
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span><span style=display:flex><span>2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style=color:#ae81ff>1500</span> qdisc fq_codel state UP group default qlen <span style=color:#ae81ff>1000</span>
</span></span><span style=display:flex><span>    link/ether 00:0c:29:30:56:5c brd ff:ff:ff:ff:ff:ff promiscuity <span style=color:#ae81ff>0</span> minmtu <span style=color:#ae81ff>46</span> maxmtu <span style=color:#ae81ff>16110</span> numtxqueues <span style=color:#ae81ff>1</span> numrxqueues <span style=color:#ae81ff>1</span> gso_max_size <span style=color:#ae81ff>65536</span> gso_max_segs <span style=color:#ae81ff>65535</span> 
</span></span><span style=display:flex><span>    inet 10.4.7.60/24 brd 10.4.7.255 scope global ens33
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span><span style=display:flex><span>    inet6 fe80::20c:29ff:fe30:565c/64 scope link 
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span><span style=display:flex><span>3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu <span style=color:#ae81ff>1500</span> qdisc noqueue state DOWN group default 
</span></span><span style=display:flex><span>    link/ether 02:42:97:3a:db:c3 brd ff:ff:ff:ff:ff:ff promiscuity <span style=color:#ae81ff>0</span> minmtu <span style=color:#ae81ff>68</span> maxmtu <span style=color:#ae81ff>65535</span> 
</span></span><span style=display:flex><span>    bridge forward_delay <span style=color:#ae81ff>1500</span> hello_time <span style=color:#ae81ff>200</span> max_age <span style=color:#ae81ff>2000</span> ageing_time <span style=color:#ae81ff>30000</span> stp_state <span style=color:#ae81ff>0</span> priority <span style=color:#ae81ff>32768</span> vlan_filtering <span style=color:#ae81ff>0</span> vlan_protocol 802.1Q bridge_id 8000.2:42:97:3a:db:c3 designated_root 8000.2:42:97:3a:db:c3 root_port <span style=color:#ae81ff>0</span> root_path_cost <span style=color:#ae81ff>0</span> topology_change <span style=color:#ae81ff>0</span> topology_change_detected <span style=color:#ae81ff>0</span> hello_timer    0.00 tcn_timer    0.00 topology_change_timer    0.00 gc_timer  102.44 vlan_default_pvid <span style=color:#ae81ff>1</span> vlan_stats_enabled <span style=color:#ae81ff>0</span> vlan_stats_per_port <span style=color:#ae81ff>0</span> group_fwd_mask <span style=color:#ae81ff>0</span> group_address 01:80:c2:00:00:00 mcast_snooping <span style=color:#ae81ff>1</span> mcast_router <span style=color:#ae81ff>1</span> mcast_query_use_ifaddr <span style=color:#ae81ff>0</span> mcast_querier <span style=color:#ae81ff>0</span> mcast_hash_elasticity <span style=color:#ae81ff>16</span> mcast_hash_max <span style=color:#ae81ff>4096</span> mcast_last_member_count <span style=color:#ae81ff>2</span> mcast_startup_query_count <span style=color:#ae81ff>2</span> mcast_last_member_interval <span style=color:#ae81ff>100</span> mcast_membership_interval <span style=color:#ae81ff>26000</span> mcast_querier_interval <span style=color:#ae81ff>25500</span> mcast_query_interval <span style=color:#ae81ff>12500</span> mcast_query_response_interval <span style=color:#ae81ff>1000</span> mcast_startup_query_interval <span style=color:#ae81ff>3124</span> mcast_stats_enabled <span style=color:#ae81ff>0</span> mcast_igmp_version <span style=color:#ae81ff>2</span> mcast_mld_version <span style=color:#ae81ff>1</span> nf_call_iptables <span style=color:#ae81ff>0</span> nf_call_ip6tables <span style=color:#ae81ff>0</span> nf_call_arptables <span style=color:#ae81ff>0</span> numtxqueues <span style=color:#ae81ff>1</span> numrxqueues <span style=color:#ae81ff>1</span> gso_max_size <span style=color:#ae81ff>65536</span> gso_max_segs <span style=color:#ae81ff>65535</span> 
</span></span><span style=display:flex><span>    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span><span style=display:flex><span>4: cali64bc2599f1b@if3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style=color:#ae81ff>1450</span> qdisc noqueue state UP group default 
</span></span><span style=display:flex><span>    link/ether ee:ee:ee:ee:ee:ee brd ff:ff:ff:ff:ff:ff link-netnsid <span style=color:#ae81ff>0</span> promiscuity <span style=color:#ae81ff>0</span> minmtu <span style=color:#ae81ff>68</span> maxmtu <span style=color:#ae81ff>65535</span> 
</span></span><span style=display:flex><span>    veth numtxqueues <span style=color:#ae81ff>1</span> numrxqueues <span style=color:#ae81ff>1</span> gso_max_size <span style=color:#ae81ff>65536</span> gso_max_segs <span style=color:#ae81ff>65535</span> 
</span></span><span style=display:flex><span>    inet6 fe80::ecee:eeff:feee:eeee/64 scope link 
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span><span style=display:flex><span>5: cali186813c9403@if3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style=color:#ae81ff>1450</span> qdisc noqueue state UP group default 
</span></span><span style=display:flex><span>    link/ether ee:ee:ee:ee:ee:ee brd ff:ff:ff:ff:ff:ff link-netnsid <span style=color:#ae81ff>1</span> promiscuity <span style=color:#ae81ff>0</span> minmtu <span style=color:#ae81ff>68</span> maxmtu <span style=color:#ae81ff>65535</span> 
</span></span><span style=display:flex><span>    veth numtxqueues <span style=color:#ae81ff>1</span> numrxqueues <span style=color:#ae81ff>1</span> gso_max_size <span style=color:#ae81ff>65536</span> gso_max_segs <span style=color:#ae81ff>65535</span> 
</span></span><span style=display:flex><span>    inet6 fe80::ecee:eeff:feee:eeee/64 scope link 
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span><span style=display:flex><span>6: calia0e2fa62436@if3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style=color:#ae81ff>1450</span> qdisc noqueue state UP group default 
</span></span><span style=display:flex><span>    link/ether ee:ee:ee:ee:ee:ee brd ff:ff:ff:ff:ff:ff link-netnsid <span style=color:#ae81ff>2</span> promiscuity <span style=color:#ae81ff>0</span> minmtu <span style=color:#ae81ff>68</span> maxmtu <span style=color:#ae81ff>65535</span> 
</span></span><span style=display:flex><span>    veth numtxqueues <span style=color:#ae81ff>1</span> numrxqueues <span style=color:#ae81ff>1</span> gso_max_size <span style=color:#ae81ff>65536</span> gso_max_segs <span style=color:#ae81ff>65535</span> 
</span></span><span style=display:flex><span>    inet6 fe80::ecee:eeff:feee:eeee/64 scope link 
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span><span style=display:flex><span>7: calia67de3f32d9@if3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style=color:#ae81ff>1450</span> qdisc noqueue state UP group default 
</span></span><span style=display:flex><span>    link/ether ee:ee:ee:ee:ee:ee brd ff:ff:ff:ff:ff:ff link-netnsid <span style=color:#ae81ff>3</span> promiscuity <span style=color:#ae81ff>0</span> minmtu <span style=color:#ae81ff>68</span> maxmtu <span style=color:#ae81ff>65535</span> 
</span></span><span style=display:flex><span>    veth numtxqueues <span style=color:#ae81ff>1</span> numrxqueues <span style=color:#ae81ff>1</span> gso_max_size <span style=color:#ae81ff>65536</span> gso_max_segs <span style=color:#ae81ff>65535</span> 
</span></span><span style=display:flex><span>    inet6 fe80::ecee:eeff:feee:eeee/64 scope link 
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span><span style=display:flex><span>10: vxlan.calico: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style=color:#ae81ff>1450</span> qdisc noqueue state UNKNOWN group default 
</span></span><span style=display:flex><span>    link/ether 66:4f:26:ae:af:db brd ff:ff:ff:ff:ff:ff promiscuity <span style=color:#ae81ff>0</span> minmtu <span style=color:#ae81ff>68</span> maxmtu <span style=color:#ae81ff>65535</span> 
</span></span><span style=display:flex><span>    vxlan id <span style=color:#ae81ff>4096</span> local 10.4.7.60 dev ens33 srcport <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>0</span> dstport <span style=color:#ae81ff>4789</span> nolearning ttl auto ageing <span style=color:#ae81ff>300</span> udpcsum noudp6zerocsumtx noudp6zerocsumrx numtxqueues <span style=color:#ae81ff>1</span> numrxqueues <span style=color:#ae81ff>1</span> gso_max_size <span style=color:#ae81ff>65536</span> gso_max_segs <span style=color:#ae81ff>65535</span> 
</span></span><span style=display:flex><span>    inet 10.244.219.64/32 scope global vxlan.calico
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span><span style=display:flex><span>    inet6 fe80::644f:26ff:feae:afdb/64 scope link 
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span></code></pre></div><h4 id=问题4>问题4</h4><p>pod通信网口和woker网口之间有什么关系？</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/img/postimages/pod%e7%bd%91%e7%bb%9c.webp data-srcset="/img/postimages/pod%e7%bd%91%e7%bb%9c.webp, /img/postimages/pod%e7%bd%91%e7%bb%9c.webp 1.5x, /img/postimages/pod%e7%bd%91%e7%bb%9c.webp 2x" data-sizes=auto alt=/img/postimages/pod网络.webp title=pod网络></p><pre tabindex=0><code>worker1:
my-dep-5b7868d854-4rlld   eth0@if14 10.244.235.135/32  --&gt;对应worker1 上 14: cali6ff8e3ade03@if3  网卡
</code></pre><p><img class=lazyload src=/svg/loading.min.svg data-src=/img/postimages/pod%e4%b8%8eworker%e8%81%94%e7%b3%bb1.webp data-srcset="/img/postimages/pod%e4%b8%8eworker%e8%81%94%e7%b3%bb1.webp, /img/postimages/pod%e4%b8%8eworker%e8%81%94%e7%b3%bb1.webp 1.5x, /img/postimages/pod%e4%b8%8eworker%e8%81%94%e7%b3%bb1.webp 2x" data-sizes=auto alt=/img/postimages/pod与worker联系1.webp title=pod与worker联系1></p><p><img class=lazyload src=/svg/loading.min.svg data-src=/img/postimages/pod%e4%b8%8eworker%e8%81%94%e7%b3%bb2.webp data-srcset="/img/postimages/pod%e4%b8%8eworker%e8%81%94%e7%b3%bb2.webp, /img/postimages/pod%e4%b8%8eworker%e8%81%94%e7%b3%bb2.webp 1.5x, /img/postimages/pod%e4%b8%8eworker%e8%81%94%e7%b3%bb2.webp 2x" data-sizes=auto alt=/img/postimages/pod与worker联系2.webp title=pod与worker联系2></p><p><img class=lazyload src=/svg/loading.min.svg data-src=/img/postimages/pod%e4%b8%8eworker%e8%81%94%e7%b3%bb3.webp data-srcset="/img/postimages/pod%e4%b8%8eworker%e8%81%94%e7%b3%bb3.webp, /img/postimages/pod%e4%b8%8eworker%e8%81%94%e7%b3%bb3.webp 1.5x, /img/postimages/pod%e4%b8%8eworker%e8%81%94%e7%b3%bb3.webp 2x" data-sizes=auto alt=/img/postimages/pod与worker联系3.webp title=pod与worker联系3></p><h4 id=问题5>问题5</h4><p>pod上为什么会有169.254.1.1 的默认路由？地址可达吗？</p><p>地址不可达。calico使用了proxy arp 技术，地址不是真实存在的。</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/img/postimages/%e9%97%ae%e9%a2%985-1.webp data-srcset="/img/postimages/%e9%97%ae%e9%a2%985-1.webp, /img/postimages/%e9%97%ae%e9%a2%985-1.webp 1.5x, /img/postimages/%e9%97%ae%e9%a2%985-1.webp 2x" data-sizes=auto alt=/img/postimages/问题5-1.webp title=问题5-1></p><p><img class=lazyload src=/svg/loading.min.svg data-src=/img/postimages/%e9%97%ae%e9%a2%985-2.webp data-srcset="/img/postimages/%e9%97%ae%e9%a2%985-2.webp, /img/postimages/%e9%97%ae%e9%a2%985-2.webp 1.5x, /img/postimages/%e9%97%ae%e9%a2%985-2.webp 2x" data-sizes=auto alt=/img/postimages/问题5-2.webp title=问题5-2></p><p><img class=lazyload src=/svg/loading.min.svg data-src=/img/postimages/%e9%97%ae%e9%a2%985-3.webp data-srcset="/img/postimages/%e9%97%ae%e9%a2%985-3.webp, /img/postimages/%e9%97%ae%e9%a2%985-3.webp 1.5x, /img/postimages/%e9%97%ae%e9%a2%985-3.webp 2x" data-sizes=auto alt=/img/postimages/问题5-3.webp title=问题5-3></p><h4 id=问题6>问题6</h4><p>相同worker之间的pod是如何通信的？</p><table><thead><tr><th style=text-align:center>pod</th><th style=text-align:center>ip</th><th style=text-align:center>pod interface</th><th style=text-align:center>node interface</th><th style=text-align:center>node</th></tr></thead><tbody><tr><td style=text-align:center>my-dep-5b7868d854-4rlld</td><td style=text-align:center>10.244.235.135</td><td style=text-align:center>3: eth0@if14</td><td style=text-align:center>14: cali6ff8e3ade03@if3</td><td style=text-align:center>worker1</td></tr><tr><td style=text-align:center>my-dep-5b7868d854-mzp9z</td><td style=text-align:center>10.244.235.140</td><td style=text-align:center>3: eth0@if15</td><td style=text-align:center>15: cali1292bd788a2@if3</td><td style=text-align:center>worker1</td></tr></tbody></table><p>从10.244.235.135ping 10.244.235.140。</p><p>分别在②、③、④上抓包查看网络接口数据包发送接收状态。</p><p>网络路径：</p><p><code>4rlld(10.244.235.135)->14: cali6ff8e3ade03@if3->15: cali1292bd788a2@if3->mzp9z(10.244.235.140)</code></p><p>​ ① ② ③ ④</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/img/postimages/%e7%9b%b8%e5%90%8cworker%e7%9a%84pod%e4%b9%8b%e9%97%b4%e9%80%9a%e4%bf%a11.webp data-srcset="/img/postimages/%e7%9b%b8%e5%90%8cworker%e7%9a%84pod%e4%b9%8b%e9%97%b4%e9%80%9a%e4%bf%a11.webp, /img/postimages/%e7%9b%b8%e5%90%8cworker%e7%9a%84pod%e4%b9%8b%e9%97%b4%e9%80%9a%e4%bf%a11.webp 1.5x, /img/postimages/%e7%9b%b8%e5%90%8cworker%e7%9a%84pod%e4%b9%8b%e9%97%b4%e9%80%9a%e4%bf%a11.webp 2x" data-sizes=auto alt=/img/postimages/相同worker的pod之间通信1.webp title=相同worker的pod之间通信1></p><p><img class=lazyload src=/svg/loading.min.svg data-src=/img/postimages/%e7%9b%b8%e5%90%8cworker%e7%9a%84pod%e4%b9%8b%e9%97%b4%e9%80%9a%e4%bf%a1135.webp data-srcset="/img/postimages/%e7%9b%b8%e5%90%8cworker%e7%9a%84pod%e4%b9%8b%e9%97%b4%e9%80%9a%e4%bf%a1135.webp, /img/postimages/%e7%9b%b8%e5%90%8cworker%e7%9a%84pod%e4%b9%8b%e9%97%b4%e9%80%9a%e4%bf%a1135.webp 1.5x, /img/postimages/%e7%9b%b8%e5%90%8cworker%e7%9a%84pod%e4%b9%8b%e9%97%b4%e9%80%9a%e4%bf%a1135.webp 2x" data-sizes=auto alt=/img/postimages/相同worker的pod之间通信135.webp title=相同worker的pod之间通信135></p><p><img class=lazyload src=/svg/loading.min.svg data-src=/img/postimages/%e7%9b%b8%e5%90%8cworker%e7%9a%84pod%e4%b9%8b%e9%97%b4%e9%80%9a%e4%bf%a1worker14.webp data-srcset="/img/postimages/%e7%9b%b8%e5%90%8cworker%e7%9a%84pod%e4%b9%8b%e9%97%b4%e9%80%9a%e4%bf%a1worker14.webp, /img/postimages/%e7%9b%b8%e5%90%8cworker%e7%9a%84pod%e4%b9%8b%e9%97%b4%e9%80%9a%e4%bf%a1worker14.webp 1.5x, /img/postimages/%e7%9b%b8%e5%90%8cworker%e7%9a%84pod%e4%b9%8b%e9%97%b4%e9%80%9a%e4%bf%a1worker14.webp 2x" data-sizes=auto alt=/img/postimages/相同worker的pod之间通信worker14.webp title=相同worker的pod之间通信worker14></p><p><img class=lazyload src=/svg/loading.min.svg data-src=/img/postimages/%e7%9b%b8%e5%90%8cworker%e7%9a%84pod%e4%b9%8b%e9%97%b4%e9%80%9a%e4%bf%a1worker15.webp data-srcset="/img/postimages/%e7%9b%b8%e5%90%8cworker%e7%9a%84pod%e4%b9%8b%e9%97%b4%e9%80%9a%e4%bf%a1worker15.webp, /img/postimages/%e7%9b%b8%e5%90%8cworker%e7%9a%84pod%e4%b9%8b%e9%97%b4%e9%80%9a%e4%bf%a1worker15.webp 1.5x, /img/postimages/%e7%9b%b8%e5%90%8cworker%e7%9a%84pod%e4%b9%8b%e9%97%b4%e9%80%9a%e4%bf%a1worker15.webp 2x" data-sizes=auto alt=/img/postimages/相同worker的pod之间通信worker15.webp title=相同worker的pod之间通信worker15></p><p><img class=lazyload src=/svg/loading.min.svg data-src=/img/postimages/%e7%9b%b8%e5%90%8cworker%e7%9a%84pod%e4%b9%8b%e9%97%b4%e9%80%9a%e4%bf%a1140.webp data-srcset="/img/postimages/%e7%9b%b8%e5%90%8cworker%e7%9a%84pod%e4%b9%8b%e9%97%b4%e9%80%9a%e4%bf%a1140.webp, /img/postimages/%e7%9b%b8%e5%90%8cworker%e7%9a%84pod%e4%b9%8b%e9%97%b4%e9%80%9a%e4%bf%a1140.webp 1.5x, /img/postimages/%e7%9b%b8%e5%90%8cworker%e7%9a%84pod%e4%b9%8b%e9%97%b4%e9%80%9a%e4%bf%a1140.webp 2x" data-sizes=auto alt=/img/postimages/相同worker的pod之间通信140.webp title=相同worker的pod之间通信140></p><h4 id=问题7>问题7</h4><p>不同worker之间的pod是如何通信的？</p><p>worker1 的pod1和worker2的pod3通信过程。跨子网使用vxlan进行通信。</p><table><thead><tr><th style=text-align:center>pod</th><th style=text-align:center>ip</th><th style=text-align:center>pod interface</th><th style=text-align:center>node interface</th><th style=text-align:center>node</th></tr></thead><tbody><tr><td style=text-align:center>my-dep-5b7868d854-4rlld</td><td style=text-align:center>10.244.235.135/32</td><td style=text-align:center>3:eth0@if14</td><td style=text-align:center>14: cali6ff8e3ade03@if3</td><td style=text-align:center>worker1</td></tr><tr><td style=text-align:center>my-dep-5b7868d854-4dj4p</td><td style=text-align:center>10.244.189.91/32</td><td style=text-align:center>3:eth0@if15</td><td style=text-align:center>15: calic18ddbeaf18@if3</td><td style=text-align:center>worker2</td></tr></tbody></table><p>从10.244.235.135ping 10.244.189.91。</p><p>网络路径：</p><p><code>4rlld(10.244.235.135)->vxlan.calico(10.244.235.128)->14: cali6ff8e3ade03@if3->vxlan.calico(10.244.189.64)->15: calic18ddbeaf18@if3->4dj4p(10.244.189.91)</code></p><p><code>4rlld</code>上的路由信息</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/img/postimages/%e4%b8%8d%e5%90%8cworker%e7%9a%84pod%e4%b9%8b%e9%97%b4%e9%80%9a%e4%bf%a1135.webp data-srcset="/img/postimages/%e4%b8%8d%e5%90%8cworker%e7%9a%84pod%e4%b9%8b%e9%97%b4%e9%80%9a%e4%bf%a1135.webp, /img/postimages/%e4%b8%8d%e5%90%8cworker%e7%9a%84pod%e4%b9%8b%e9%97%b4%e9%80%9a%e4%bf%a1135.webp 1.5x, /img/postimages/%e4%b8%8d%e5%90%8cworker%e7%9a%84pod%e4%b9%8b%e9%97%b4%e9%80%9a%e4%bf%a1135.webp 2x" data-sizes=auto alt=/img/postimages/不同worker的pod之间通信135.webp title=不同worker的pod之间通信135></p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://images-1316789231.cos.ap-shanghai.myqcloud.com/%E4%BA%91%E8%AE%A1%E7%AE%97/pod1%E8%B7%AF%E7%94%B1%E4%BF%A1%E6%81%AF.webp data-srcset="https://images-1316789231.cos.ap-shanghai.myqcloud.com/%E4%BA%91%E8%AE%A1%E7%AE%97/pod1%E8%B7%AF%E7%94%B1%E4%BF%A1%E6%81%AF.webp, https://images-1316789231.cos.ap-shanghai.myqcloud.com/%E4%BA%91%E8%AE%A1%E7%AE%97/pod1%E8%B7%AF%E7%94%B1%E4%BF%A1%E6%81%AF.webp 1.5x, https://images-1316789231.cos.ap-shanghai.myqcloud.com/%E4%BA%91%E8%AE%A1%E7%AE%97/pod1%E8%B7%AF%E7%94%B1%E4%BF%A1%E6%81%AF.webp 2x" data-sizes=auto alt=https://images-1316789231.cos.ap-shanghai.myqcloud.com/%E4%BA%91%E8%AE%A1%E7%AE%97/pod1%E8%B7%AF%E7%94%B1%E4%BF%A1%E6%81%AF.webp title=pod1路由信息></p><p>根据路由信息，ping 10.244.189.91，会匹配到第一条。第一条路由的意思是：去往任何网段的数据包都发往网管169.254.1.1，然后从eth0网卡发送出去。</p><p>路由表中Flags标志的含义：</p><p>U up表示当前为启动状态</p><p>H host表示该路由为一个主机，多为达到数据包的路由</p><p>G Gateway 表示该路由是一个网关，如果没有说明目的地是直连的</p><p>D Dynamicaly 表示该路由是重定向报文修改</p><p>M 表示该路由已被重定向报文修改</p><p>worker1上路由信息</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/img/postimages/worker1%e8%b7%af%e7%94%b1%e4%bf%a1%e6%81%af.webp data-srcset="/img/postimages/worker1%e8%b7%af%e7%94%b1%e4%bf%a1%e6%81%af.webp, /img/postimages/worker1%e8%b7%af%e7%94%b1%e4%bf%a1%e6%81%af.webp 1.5x, /img/postimages/worker1%e8%b7%af%e7%94%b1%e4%bf%a1%e6%81%af.webp 2x" data-sizes=auto alt=/img/postimages/worker1路由信息.webp title=worker1路由信息></p><p>当ping包来到worker1节点上，会匹配到路由eth3。该路由的意思是：去往10.244.189.64/26的网段的数据包都发往网关10.4.7.62。因为pod1在7.61，pod3在7.62。所以数据包就通过设备eth3发往到worker2节点上。</p><p>worker2上路由信息</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/img/postimages/worker2%e8%b7%af%e7%94%b1%e4%bf%a1%e6%81%af.webp data-srcset="/img/postimages/worker2%e8%b7%af%e7%94%b1%e4%bf%a1%e6%81%af.webp, /img/postimages/worker2%e8%b7%af%e7%94%b1%e4%bf%a1%e6%81%af.webp 1.5x, /img/postimages/worker2%e8%b7%af%e7%94%b1%e4%bf%a1%e6%81%af.webp 2x" data-sizes=auto alt=/img/postimages/worker2路由信息.webp title=worker2路由信息></p><p>当worker2节点网卡收到数据包之后，发现发往的目的ip为10.244.189.91，于是匹配到红线的路由。该路由的意思是：10.244.189.91是本机直连设备，去往设备的数据包发往calic18ddbeaf18。</p><p>绿色框是回程路由。</p><p>那么该设备是什么呢？这个设备就是veth pair的一端。在创建pod3时calico会给pod3创建一个veth pair设备。一端是pod3的网卡，另一端就是我们看到的calic18ddbeaf18。下面我们验证一下。在pod3中安装ethtool工具，然后使用ethtool -S eth0,查看veth pair另一端的设备号。</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/img/postimages/pod3%e4%b8%8a%e5%af%b9%e7%ab%afveth.webp data-srcset="/img/postimages/pod3%e4%b8%8a%e5%af%b9%e7%ab%afveth.webp, /img/postimages/pod3%e4%b8%8a%e5%af%b9%e7%ab%afveth.webp 1.5x, /img/postimages/pod3%e4%b8%8a%e5%af%b9%e7%ab%afveth.webp 2x" data-sizes=auto alt=/img/postimages/pod3上对端veth.webp title=pod3上对端veth></p><p>pod3 网卡另一端的设备好号是15，在worker2上查看编号为15的网络设备，可以发现该网络设备就是calic18ddbeaf18。</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/img/postimages/worker2%e4%b8%8aveth.webp data-srcset="/img/postimages/worker2%e4%b8%8aveth.webp, /img/postimages/worker2%e4%b8%8aveth.webp 1.5x, /img/postimages/worker2%e4%b8%8aveth.webp 2x" data-sizes=auto alt=/img/postimages/worker2上veth.webp title=worker2上veth></p><p>所以，worker2上的路由，发送calic18ddbeaf18的数据其实就是发送到pod3的网卡中。ping包的旅行到这里就到了目的地。</p><p>查看一下pod3中的路由信息，发现该路由信息和pod1中是一样的。</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/img/postimages/pod3%e8%b7%af%e7%94%b1%e4%bf%a1%e6%81%af.webp data-srcset="/img/postimages/pod3%e8%b7%af%e7%94%b1%e4%bf%a1%e6%81%af.webp, /img/postimages/pod3%e8%b7%af%e7%94%b1%e4%bf%a1%e6%81%af.webp 1.5x, /img/postimages/pod3%e8%b7%af%e7%94%b1%e4%bf%a1%e6%81%af.webp 2x" data-sizes=auto alt=/img/postimages/pod3路由信息.webp title=pod3路由信息></p><h4 id=问题8>问题8</h4><p>pod是如何访问互联网的？</p><p>演示：worker1中pod1访问baidu.com</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/img/postimages/pod1%e5%a4%96%e7%bd%91%e6%b5%8b%e8%af%951.webp data-srcset="/img/postimages/pod1%e5%a4%96%e7%bd%91%e6%b5%8b%e8%af%951.webp, /img/postimages/pod1%e5%a4%96%e7%bd%91%e6%b5%8b%e8%af%951.webp 1.5x, /img/postimages/pod1%e5%a4%96%e7%bd%91%e6%b5%8b%e8%af%951.webp 2x" data-sizes=auto alt=/img/postimages/pod1外网测试1.webp title=pod1外网测试1></p><p>查看coredns</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/img/postimages/pod1%e5%a4%96%e7%bd%91%e6%b5%8b%e8%af%952.webp data-srcset="/img/postimages/pod1%e5%a4%96%e7%bd%91%e6%b5%8b%e8%af%952.webp, /img/postimages/pod1%e5%a4%96%e7%bd%91%e6%b5%8b%e8%af%952.webp 1.5x, /img/postimages/pod1%e5%a4%96%e7%bd%91%e6%b5%8b%e8%af%952.webp 2x" data-sizes=auto alt=/img/postimages/pod1外网测试2.webp title=pod1外网测试2></p><p>cluster dns由kubelet分配。</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/img/postimages/pod1%e5%a4%96%e7%bd%91%e6%b5%8b%e8%af%953.webp data-srcset="/img/postimages/pod1%e5%a4%96%e7%bd%91%e6%b5%8b%e8%af%953.webp, /img/postimages/pod1%e5%a4%96%e7%bd%91%e6%b5%8b%e8%af%953.webp 1.5x, /img/postimages/pod1%e5%a4%96%e7%bd%91%e6%b5%8b%e8%af%953.webp 2x" data-sizes=auto alt=/img/postimages/pod1外网测试3.webp title=pod1外网测试3></p><p>worker1节点收到pod1的ping请求后数据包从eth3网卡发往baidu.com</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/img/postimages/pod1%e5%a4%96%e7%bd%91%e6%b5%8b%e8%af%954.webp data-srcset="/img/postimages/pod1%e5%a4%96%e7%bd%91%e6%b5%8b%e8%af%954.webp, /img/postimages/pod1%e5%a4%96%e7%bd%91%e6%b5%8b%e8%af%954.webp 1.5x, /img/postimages/pod1%e5%a4%96%e7%bd%91%e6%b5%8b%e8%af%954.webp 2x" data-sizes=auto alt=/img/postimages/pod1外网测试4.webp title=pod1外网测试4></p><p>查看iptable转发规则</p><p><code>iptables -nvL -t nat</code></p><p><img class=lazyload src=/svg/loading.min.svg data-src=/img/postimages/pod1%e5%a4%96%e7%bd%91%e6%b5%8b%e8%af%955.webp data-srcset="/img/postimages/pod1%e5%a4%96%e7%bd%91%e6%b5%8b%e8%af%955.webp, /img/postimages/pod1%e5%a4%96%e7%bd%91%e6%b5%8b%e8%af%955.webp 1.5x, /img/postimages/pod1%e5%a4%96%e7%bd%91%e6%b5%8b%e8%af%955.webp 2x" data-sizes=auto alt=/img/postimages/pod1外网测试5.webp title=pod1外网测试5></p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2022-03-25</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://blog.haipengv.com/posts/k8s%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1/ data-title=k8s网路通信><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://blog.haipengv.com/posts/k8s%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1/><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://blog.haipengv.com/posts/k8s%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1/ data-title=k8s网路通信><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://blog.haipengv.com/posts/k8s%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1/ data-title=k8s网路通信><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@6.20.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=https://blog.haipengv.com/posts/k8s%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1/ data-title=k8s网路通信><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/pam%E6%A8%A1%E5%9D%97%E9%99%90%E5%88%B6%E7%99%BB%E5%BD%95/ class=prev rel=prev title=pam模块限制登录><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>pam模块限制登录</a>
<a href=/posts/%E6%A8%A1%E5%9D%97%E4%B8%8E%E5%8C%85/ class=next rel=next title=模块与包>模块与包<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.115.3">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank></a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.1/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>