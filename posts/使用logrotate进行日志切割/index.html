<!doctype html><html lang=zh-CN><head><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><meta name=description content="使用logrotate进行日志切割 - https://haipengv.com/posts/%E4%BD%BF%E7%94%A8logrotate%E8%BF%9B%E8%A1%8C%E6%97%A5%E5%BF%97%E5%88%87%E5%89%B2/"><meta name=author content="Smith - https://haipengv.com/"><meta name=msvalidate.01 content="B46311949B856F2A7015F366FB3CE878"><title>使用logrotate进行日志切割</title><base target=_blank><link rel=icon type=image/png href=/favicon.ico><link rel=stylesheet href=https://haipengv.com/style.min.9a0cea23154ac1941e15c25aa2d31b77285a217d2606ec05b55236428cf1c3e6.css><script>const DARK=!1</script><script type=text/javascript src=/main.js defer></script></head><body class=active-animate><div class=cool-before></div><div id=header><div class=container-header><div class=right><h1 class=title>使用logrotate进行日志切割</h1><div id=toc>📜</div></div></div></div><div id=content><div class="container-main container-page"><div class=rel><div class=curtag-desc><a href=https://haipengv.com/tags/linux%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/><img src=/imgs/icons/tag.svg width=16> 相关文章：Linux基础知识 <sup>38</sup></a></div><div class=curtag-post><div class=curtag-post-item><a href=https://haipengv.com/posts/centos7-%E5%8D%87%E7%BA%A7%E5%86%85%E6%A0%B8/>CentOS7 升级内核</a></div><div class=curtag-post-item><a href=https://haipengv.com/posts/centos7.9%E5%AE%89%E8%A3%85mysql8.0/>Centos7.9安装Mysql8.0</a></div><div class=curtag-post-item><a href=https://haipengv.com/posts/centos7.9%E6%9B%B4%E6%8D%A2%E7%BD%91%E5%8D%A1%E5%90%8D%E7%A7%B0/>Centos7.9更换网卡名称</a></div><div class=curtag-post-item><a href=https://haipengv.com/posts/centos7%E4%BD%BF%E7%94%A8systemd%E7%AE%A1%E7%90%86%E7%A8%8B%E5%BA%8F/>Centos7使用systemd管理程序</a></div><div class=curtag-post-item><a href=https://haipengv.com/posts/centos7-%E5%B8%B8%E8%A7%84%E5%91%BD%E4%BB%A4/>CentOS7常规命令</a></div><div class=curtag-post-item><a href=https://haipengv.com/posts/centos7%E7%BD%91%E5%8D%A1%E6%94%B9%E5%9B%9Eeth0%E6%98%BE%E7%A4%BA/>Centos7网卡改回eth0显示</a></div><div class=curtag-post-item><a href=https://haipengv.com/posts/centos8%E9%85%8D%E7%BD%AEyum%E6%BA%90/>CentOS8配置yum源</a></div><div class=curtag-post-item><a href=https://haipengv.com/posts/centos%E6%90%AD%E5%BB%BA%E5%86%85%E7%BD%91%E9%82%AE%E4%BB%B6%E6%9C%8D%E5%8A%A1%E5%99%A8/>Centos搭建内网邮件服务器</a></div><div class=curtag-post-item><a href=https://haipengv.com/posts/crontab%E8%B8%A9%E5%9D%91%E8%AE%B0/>Crontab踩坑记</a></div><div class=curtag-post-item><a href=https://haipengv.com/posts/git%E5%85%A5%E9%97%A8/>Git入门</a></div><div class=curtag-post-item><a href=https://haipengv.com/posts/http%E5%92%8Chttps%E5%90%84%E7%A7%8D%E6%96%B9%E6%B3%95%E6%B5%8B%E8%AF%95/>Http和Https各种方法测试</a></div><div class=curtag-post-item><a href=https://haipengv.com/posts/iptables%E5%B8%B8%E7%94%A8%E6%80%BB%E7%BB%93/>Iptables常用总结</a></div><div class=curtag-post-item><a href=https://haipengv.com/posts/linux%E4%B8%8B%E6%B7%B7%E6%9D%82%E6%A8%A1%E5%BC%8F%E5%88%A4%E6%96%AD/>Linux下混杂模式判断</a></div><div class=curtag-post-item><a href=https://haipengv.com/posts/linux%E4%B8%AD%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/>Linux中环境变量</a></div><div class=curtag-post-item><a href=https://haipengv.com/posts/linux%E4%B8%AD%E7%9A%84%E9%9A%94%E7%A6%BB/>Linux中的隔离</a></div><div class=curtag-post-item><a href=https://haipengv.com/posts/linux%E4%BF%A1%E6%81%AF%E6%9F%A5%E8%AF%A2%E5%91%BD%E4%BB%A4/>Linux信息查询命令</a></div><div class=curtag-post-item><a href=https://haipengv.com/posts/linux%E5%9E%83%E5%9C%BE%E6%A1%B6/>Linux垃圾桶</a></div><div class=curtag-post-item><a href=https://haipengv.com/posts/linux%E5%B0%8F%E6%8A%80%E5%B7%A7%E6%B1%87%E6%80%BB/>Linux小技巧汇总</a></div><div class=curtag-post-item><a href=https://haipengv.com/posts/linux%E6%97%A5%E5%BF%97%E5%A4%A7%E6%96%87%E4%BB%B6%E5%88%87%E5%89%B2/>Linux日志大文件切割</a></div><div class=curtag-post-item><a href=https://haipengv.com/posts/linux%E6%9F%A5%E7%9C%8B%E7%A8%8B%E5%BA%8F%E8%BF%9B%E7%A8%8B%E5%90%AF%E5%8A%A8%E6%97%B6%E9%97%B4/>Linux查看程序进程启动时间</a></div><div class=curtag-post-item><a href=https://haipengv.com/posts/linux%E6%A0%B9%E5%88%86%E5%8C%BA%E6%BB%A1%E4%BA%86%E5%A4%84%E7%90%86%E6%96%B9%E6%B3%95/>Linux根分区满了处理方法</a></div><div class=curtag-post-item><a href=https://haipengv.com/posts/pam%E6%A8%A1%E5%9D%97%E9%99%90%E5%88%B6%E7%99%BB%E5%BD%95/>Pam模块限制登录</a></div><div class=curtag-post-item><a href=https://haipengv.com/posts/redhat6.3yum%E6%BA%90%E5%A4%B1%E6%95%88%E8%A7%A3%E5%86%B3/>Redhat6.3yum源失效解决</a></div><div class=curtag-post-item><a href=https://haipengv.com/posts/rsyslog%E6%97%A5%E5%BF%97%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA/>Rsyslog日志服务器搭建</a></div><div class=curtag-post-item><a href=https://haipengv.com/posts/ssh%E7%9B%B8%E5%85%B3%E8%AF%B4%E6%98%8E/>SSH相关说明</a></div><div class=curtag-post-item><a href=https://haipengv.com/posts/ubuntu%E4%BD%BF%E7%94%A8%E4%B8%8A%E7%AF%87/>Ubuntu使用上篇</a></div><div class=curtag-post-item><a href=https://haipengv.com/posts/ubuntu%E4%BD%BF%E7%94%A8%E4%B8%8B%E7%AF%87/>Ubuntu使用下篇</a></div><div class=curtag-post-item><a href=https://haipengv.com/posts/vsftpd%E7%9B%B8%E5%85%B3%E9%85%8D%E7%BD%AE/>Vsftpd相关配置</a></div><div class=curtag-post-item><a href=https://haipengv.com/posts/vsftp%E4%B8%8D%E5%90%8C%E7%94%A8%E6%88%B7%E6%8B%A5%E6%9C%89%E4%B8%8D%E5%90%8C%E6%9D%83%E9%99%90/>Vsftp不同用户拥有不同权限</a></div><div class="curtag-post-item curtag-post-item--active"><a href=https://haipengv.com/posts/%E4%BD%BF%E7%94%A8logrotate%E8%BF%9B%E8%A1%8C%E6%97%A5%E5%BF%97%E5%88%87%E5%89%B2/>使用logrotate进行日志切割</a></div><div class=curtag-post-item><a href=https://haipengv.com/posts/%E4%BD%BF%E7%94%A8sed%E6%89%B9%E9%87%8F%E4%BF%AE%E6%94%B9%E7%BD%91%E5%9D%80/>使用sed批量修改网址</a></div><div class=curtag-post-item><a href=https://haipengv.com/posts/%E4%BD%BF%E7%94%A8%E6%B5%8F%E8%A7%88%E5%99%A8%E7%99%BB%E5%BD%95linux%E6%9C%8D%E5%8A%A1%E5%99%A8/>使用浏览器登录linux服务器</a></div><div class=curtag-post-item><a href=https://haipengv.com/posts/%E5%8A%9F%E8%83%BD%E5%BC%BA%E5%A4%A7%E7%9A%84%E7%A1%AC%E4%BB%B6%E4%BF%A1%E6%81%AF%E8%8E%B7%E5%8F%96%E5%B7%A5%E5%85%B7-inxi/>功能强大的硬件信息获取工具-Inxi</a></div><div class=curtag-post-item><a href=https://haipengv.com/posts/%E5%8E%8B%E7%BC%A9%E4%B8%8E%E8%A7%A3%E5%8E%8B/>压缩与解压</a></div><div class=curtag-post-item><a href=https://haipengv.com/posts/%E5%A6%82%E4%BD%95%E7%AD%9B%E9%80%89%E6%8C%87%E5%AE%9A%E6%97%B6%E9%97%B4%E6%AE%B5%E5%86%85%E7%9A%84%E6%97%A5%E5%BF%97/>如何筛选指定时间段内的日志</a></div><div class=curtag-post-item><a href=https://haipengv.com/posts/%E6%90%AD%E5%BB%BArss%E8%AE%A2%E9%98%85%E5%99%A8/>搭建rss订阅器</a></div><div class=curtag-post-item><a href=https://haipengv.com/posts/%E6%9F%A5%E7%9C%8B%E7%B3%BB%E7%BB%9F%E5%AE%89%E8%A3%85%E6%97%B6%E9%97%B4/>查看系统安装时间</a></div><div class=curtag-post-item><a href=https://haipengv.com/posts/%E6%A8%A1%E6%8B%9Fssh%E6%89%A7%E8%A1%8C%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4/>模拟ssh执行远程命令</a></div></div></div><div class=desc><span><svg t="1656736000388" class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="7409" width="12" height="12"><path d="M524.885333 338.986667l-324.522666 324.48c-17.28 15.274667-27.989333 36.693333-29.696 56.234666v133.76l130.730666.085334c22.784-1.621333 43.989333-12.245333 61.013334-31.701334L685.098667 499.2 524.885333 338.986667zM585.258667 278.656l160.170666 160.213333 102.144-102.144a19.712 19.712.0 000-27.861333l-132.48-132.437333a19.456 19.456.0 00-27.605333.0L585.258667 278.613333zM701.312 85.333333c27.946667.0 54.741333 11.136 74.282667 30.848L907.904 248.490667a105.045333 105.045333.0 010 148.565333L424.874667 879.957333C395.050667 914.304 352.768 935.424 304.426667 938.752H85.333333v-42.666667l.128-179.84c3.626667-44.970667 24.576-86.826667 56.448-114.944l485.12-485.034666a104.789333 104.789333.0 0174.24-30.933334z" p-id="7410" fill="#adb5bd"/></svg>2025-03-16&nbsp;&nbsp;&nbsp;<svg t="1656737270708" class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="23838" width="11" height="11"><path d="M824.264 95.36c0-23.859 25.043-44.16 48.902-44.16s49.714 20.301 49.714 44.16v190.08c0 23.859-19.054 52.868-42.913 52.868h-190.08c-23.859.0-46.696-25.96-46.696-49.819s22.55-46.249 46.409-46.249h82.025C702.344 175.534 610.22 155.853 512 155.853c-206.775.0-360.398 149.372-360.398 356.147S305.225 870.23 512 870.23c206.775.0 357.467-151.455 357.467-358.23.0-23.859 23.634-50.706 53.413-50.706 29.78.0 49.92 26.847 49.92 50.706.0 254.493-206.307 460.8-460.8 460.8s-460.8-206.307-460.8-460.8C51.2 257.507 257.507 51.2 512 51.2c122.4.0 226.684 33.296 312.264 117.369.358.351.358-24.052.0-73.209z" p-id="23839" fill="#adb5bd"/></svg>
2025-03-16&nbsp;&nbsp;&nbsp;</span>
<span><svg t="1656737548689" class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="33866" width="12" height="12"><path d="M832.038608 64.662657H192.030028c-70.774903.0-128.089859 57.325793-128.089859 128.03206v446.793671c0 70.7171050000001 57.314956 128.154884 128.089859 128.154884h133.353183a63.940169 63.940169.0 0155.219742 31.576328l76.099638 129.83828c12.358154 21.093031 33.790754 31.626903 55.216129 31.626903s42.832688-10.544709 55.198067-31.619678l76.222461-129.870792a63.940169 63.940169.0 0155.212517-31.551041h133.54103c70.576219.0 127.732228-57.289669 127.732227-127.800865V192.391272c0-70.536482-57.181295-127.728615-127.786414-127.728615zM895.884854 639.842407A63.85347 63.85347.0 01832.092795 703.703103h-133.54103a127.753903 127.753903.0 00-110.349172 63.09847l-76.222461 129.856342a.274545.274545.0 010-.050574h-.032512s-.021675.061411-.032512.061412l-76.1466-129.85273a127.804477 127.804477.0 00-110.385297-63.11292H192.030028A64.207489 64.207489.0 01127.880338 639.488388V192.694717a64.102729 64.102729.0 0164.14969-64.091891h640.00858a63.799284 63.799284.0 0163.846246 63.788446v447.451135z" fill="#adb5bd" p-id="33867"/><path d="M608.154093 288.092004a31.970084 31.970084.0 00-31.970084 31.970085v160.078006L441.53396 300.861976a31.970084 31.970084.0 00-57.531702 19.200113v255.760676a31.970084 31.970084.0 0063.940169.0V415.863969l134.650048 179.274507a31.970084 31.970084.0 0057.531703-19.200113V320.062089a31.970084 31.970084.0 00-31.970085-31.970085z" fill="#adb5bd" p-id="33868"/></svg>6930 字</span>&nbsp;
<span><svg t="1656737462334" class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="32892" width="12" height="12"><path d="M512 74.666667C270.933333 74.666667 74.666667 270.933333 74.666667 512S270.933333 949.333333 512 949.333333 949.333333 753.066667 949.333333 512 753.066667 74.666667 512 74.666667zm0 810.666666C307.2 885.333333 138.666667 716.8 138.666667 512S307.2 138.666667 512 138.666667 885.333333 307.2 885.333333 512 716.8 885.333333 512 885.333333z" p-id="32893" fill="#adb5bd"/><path d="M695.466667 567.466667 544 497.066667V277.333333c0-17.066667-14.933333-32-32-32s-32 14.933333-32 32v238.933334c0 12.8 6.4 23.466667 19.2 29.866666L669.866667 627.2c4.266667 2.133333 8.533333 2.133333 12.8 2.133333 12.8.0 23.466667-6.4 29.866666-19.2 6.4-14.933333.0-34.133333-17.066666-42.666666z" p-id="32894" fill="#adb5bd"/></svg>14 分钟</span><div class=container-ctgtag><div class=taxonomy><div class=tag><a href=/tags/linux%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86>Linux基础知识</a></div></div></div></div><div class=toc><div class=container-page-operation><div class=page-operation><div><a href=/><img src=/imgs/icons/home-2.svg alt></a></div><div><a href=/nav><img src=/imgs/icons/iov-navigate-1.svg alt></a></div><div><a href=/wiki><img src=/imgs/icons/wiki.svg alt></a></div><div><a href=/tags><img src=/imgs/icons/treetags.svg alt></a></div><div id=light-dark><a><img src=/imgs/icons/moon2.svg alt></a></div><div><a href=#><img src=/imgs/icons/up2.svg alt></a></div></div></div><nav id=TableOfContents><ul><li><a href=#logrotateconf配置>logrotate.conf配置</a><ul><li><a href=#切割nginx日志的配置>切割nginx日志的配置</a></li></ul></li><li><a href=#关于-usr1-信号解释>关于 USR1 信号解释</a><ul><li><a href=#分享一例曾经使用过的nginx日志切割处理脚本><strong>分享一例曾经使用过的nginx日志切割处理脚本：</strong></a></li><li><a href=#尝试解决logrotate无法自动轮询日志的办法><strong>尝试解决logrotate无法自动轮询日志的办法</strong></a></li><li><a href=#其他工具实现日志切割>其他工具实现日志切割</a></li></ul></li></ul></nav></div><div class=content><h1 id=简介>简介</h1><p>logrotate 程序是一个日志文件管理工具。用于分割日志文件，删除旧的日志文件，并创建新的日志文件，起到“转储”作用。可以节省磁盘空间。下面就对 logrotate 日志轮转操作做一梳理记录。</p><p>logrotate 是基于 crontab 运行的，所以这个时间点是由 crontab 控制的，具体可以查询 crontab 的配置文件 /etc/anacrontab。 系统会按照计划的频率运行 logrotate，通常是每天。在大多数的 Linux 发行版本上，计划每天运行的脚本位于 /etc/cron.daily/logrotate。</p><p>主流 Linux 发行版上都默认安装有 logrotate 包，如果你的 linux 系统中找不到 logrotate, 可以使用 apt-get 或 yum 命令来安装。</p><h1 id=logrotate运行机制>logrotate运行机制</h1><p>logrotate 在很多 Linux 发行版上都是默认安装的。系统会定时运行 logrotate，一般是每天一次。系统是这么实现按天执行的。crontab 会每天定时执行 /etc/cron.daily 目录下的脚本，而这个目录下有个文件叫 logrotate。在 centos 上脚本内容是这样的：</p><p>系统自带 cron task：<code>/etc/cron.daily/logrotate</code>，每天运行一次。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#000;font-weight:700>[</span>root@localhost logrotate.d<span style=color:#000;font-weight:700>]</span><span style=color:#998;font-style:italic># cat /etc/cron.daily/logrotate</span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>#!/bin/sh</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>/usr/sbin/logrotate -s /var/lib/logrotate/logrotate.status /etc/logrotate.conf
</span></span><span style=display:flex><span><span style=color:teal>EXITVALUE</span><span style=color:#000;font-weight:700>=</span><span style=color:teal>$?</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>if</span> <span style=color:#000;font-weight:700>[</span> <span style=color:teal>$EXITVALUE</span> !<span style=color:#000;font-weight:700>=</span> <span style=color:#099>0</span> <span style=color:#000;font-weight:700>]</span>; <span style=color:#000;font-weight:700>then</span>
</span></span><span style=display:flex><span>    /usr/bin/logger -t logrotate <span style=color:#d14>&#34;ALERT exited abnormally with [</span><span style=color:teal>$EXITVALUE</span><span style=color:#d14>]&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>fi</span>
</span></span><span style=display:flex><span><span style=color:#0086b3>exit</span> <span style=color:#099>0</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到这个脚本主要做的事就是以 <code>/etc/logrotate.conf</code> 为配置文件执行了 logrotate。就是这样实现了每天执行一次 logrotate。</p><h1 id=自定义周期滚动日志>自定义周期滚动日志</h1><p>因为我的系统执行 <code>/etc/cron.daily</code> 目录下的脚本不是我想滚动日志的时间，所以我把 <code>/etc/cron.daily/logrotate</code> 拷了出来，改了一下 logrotate 配置文件的路径，然后在 crontab 里加上一条指定时间执行这个脚本的记录，自定义周期滚动日志就大功告成了。这种自定义的方式有两点要注意：</p><ol><li>配置文件里一定要配置 <code>rotate 文件数目</code>这个参数。如果不配置默认是 0 个，也就是只允许存在一份日志，刚切分出来的日志会马上被删除。</li><li>执行 logrotate 命令最好加 <code>-f</code> 参数，不然有时候配置文件修改的内容不生效。</li></ol><p>很多程序的会用到 logrotate 滚动日志，比如 nginx。它们安装后，会在 <code>/etc/logrotate.d</code> 这个目录下增加自己的 logrotate 的配置文件。logrotate 什么时候执行 <code>/etc/logrotate.d</code> 下的配置呢？看到 <code>/etc/logrotate.conf</code> 里这行，一切就不言而喻了。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>include /etc/logrotate.d
</span></span></code></pre></td></tr></table></div></div><h1 id=安装>安装</h1><p>先检查服务器有没有安装</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>rpm -qa | grep crontab
</span></span></code></pre></td></tr></table></div></div><p>安装</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>yum -y install vixie-cron
</span></span><span style=display:flex><span>yum -y install crontabs
</span></span></code></pre></td></tr></table></div></div><p>简单说明：
vixie-cron 是 cron 的主程序；
crontabs 是用来安装、卸装、或列举用来驱动 cron 守护进程的表格的程序。</p><p>安装好后启动和配置服务</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>service crond start     //启动服务
</span></span><span style=display:flex><span>service crond stop      //关闭服务
</span></span><span style=display:flex><span>service crond restart   //重启服务
</span></span><span style=display:flex><span>service crond reload    //重新载入配置
</span></span><span style=display:flex><span>service crond status    //查看crontab服务状态
</span></span></code></pre></td></tr></table></div></div><p>设置开机自启</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>chkconfig --level <span style=color:#099>345</span> crond on
</span></span></code></pre></td></tr></table></div></div><p>简单定时脚本</p><p>[root@localhost ~]# vim test.sh</p><pre tabindex=0><code>nowtime=`date +&#34;%Y-%m-%d %H:%M:%S&#34;`
echo &#34;hello cron &#34;$nowtime
</code></pre><p>添加执行权限
[root@localhost~]# chmod +x test.sh
运行：
[root@localhost ~]# ./test.sh
hello cron 2022-01-09 19:54:30</p><p>添加定时任务。每一分钟执行一次</p><p>运行crontab -e</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>*/1 * * * * /root/test.sh  &gt;&gt; /root/test.log
</span></span></code></pre></td></tr></table></div></div><h1 id=配置文件介绍>配置文件介绍</h1><p>Linux系统默认安装logrotate工具，它默认的配置文件在：</p><pre tabindex=0><code>/etc/logrotate.conf
/etc/logrotate.d/
</code></pre><p>logrotate.conf 才是主要的配置文件，logrotate.d 是一个目录，该目录里的所有文件都会被主动的读入/etc/logrotate.conf中执行。另外，如果 /etc/logrotate.d/ 里面的文件中没有设定一些细节，则会以/etc/logrotate.conf这个文件的设定来作为默认值。</p><p>Logrotate是基于CRON来运行的，其脚本是/etc/cron.daily/logrotate，日志轮转是系统自动完成的。实际运行时，Logrotate会调用配置文件/etc/logrotate.conf。可以在/etc/logrotate.d目录里放置自定义好的配置文件，用来覆盖Logrotate的缺省值。</p><p>[root@localhost ~]# cat /etc/cron.daily/logrotate</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic>#!/bin/sh
</span></span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic></span>/usr/sbin/logrotate /etc/logrotate.conf &gt;/dev/null 2&gt;&amp;<span style=color:#099>1</span>
</span></span><span style=display:flex><span><span style=color:teal>EXITVALUE</span><span style=color:#000;font-weight:700>=</span><span style=color:teal>$?</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>if</span> <span style=color:#000;font-weight:700>[</span> <span style=color:teal>$EXITVALUE</span> !<span style=color:#000;font-weight:700>=</span> <span style=color:#099>0</span> <span style=color:#000;font-weight:700>]</span>; <span style=color:#000;font-weight:700>then</span>
</span></span><span style=display:flex><span>  /usr/bin/logger -t logrotate <span style=color:#d14>&#34;ALERT exited abnormally with [</span><span style=color:teal>$EXITVALUE</span><span style=color:#d14>]&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>fi</span>
</span></span><span style=display:flex><span><span style=color:#0086b3>exit</span> <span style=color:#099>0</span>
</span></span></code></pre></td></tr></table></div></div><p>如果等不及cron自动执行日志轮转，想手动强制切割日志，需要加-f参数；不过正式执行前最好通过Debug选项来验证一下（-d参数），这对调试也很重要：</p><pre tabindex=0><code>/usr/sbin/logrotate -f /etc/logrotate.d/nginx
/usr/sbin/logrotate -d -f /etc/logrotate.d/nginx
</code></pre><p>logrotate 命令格式：</p><pre tabindex=0><code>logrotate [OPTION...] &lt;configfile&gt;

-d, --debug ：debug模式，测试配置文件是否有错误。
-f, --force ：强制转储文件。
-m, --mail=command ：压缩日志后，发送日志到指定邮箱。
-s, --state=statefile ：使用指定的状态文件。
-v, --verbose ：显示转储过程。
</code></pre><p>根据日志切割设置进行操作，并显示详细信息：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#000;font-weight:700>[</span>root@localhost ~<span style=color:#000;font-weight:700>]</span><span style=color:#998;font-style:italic># /usr/sbin/logrotate -v /etc/logrotate.conf</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>[</span>root@localhost ~<span style=color:#000;font-weight:700>]</span><span style=color:#998;font-style:italic># /usr/sbin/logrotate -v /etc/logrotate.d/php</span>
</span></span></code></pre></td></tr></table></div></div><p>根据日志切割设置进行执行，并显示详细信息,但是不进行具体操作，debug模式</p><pre tabindex=0><code>[root@localhost ~]# /usr/sbin/logrotate -d /etc/logrotate.conf
[root@localhost ~]# /usr/sbin/logrotate -d /etc/logrotate.d/nginx
</code></pre><p>查看各log文件的具体执行情况</p><pre tabindex=0><code>[root@localhost ~]# cat /var/lib/logrotate.status
</code></pre><h1 id=切割介绍>切割介绍</h1><p>比如以系统日志/var/log/message做切割来简单说明下：</p><ul><li>第一次执行完rotate(轮转)之后，原本的messages会变成messages.1，而且会制造一个空的messages给系统来储存日志；</li><li>第二次执行之后，messages.1会变成messages.2，而messages会变成messages.1，又造成一个空的messages来储存日志！</li></ul><p>如果仅设定保留三个日志（即轮转3次）的话，那么执行第三次时，则 messages.3这个档案就会被删除，并由后面的较新的保存日志所取代！也就是会保存最新的几个日志。</p><p>日志究竟轮换几次，这个是根据配置文件中的dateext 参数来判定的。</p><h2 id=logrotateconf配置>logrotate.conf配置</h2><pre tabindex=0><code>cat /etc/logrotate.conf
</code></pre><p>底下的设定是 &ldquo;logrotate 的默认值&rdquo; ，如果別的文件设定了其他的值，就会以其它文件的设定为主</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>weekly		//默认每一周执行一次rotate轮转工作
</span></span><span style=display:flex><span>rotate 4	// 保留多少个日志文件<span style=color:#000;font-weight:700>(</span>轮转几次<span style=color:#000;font-weight:700>)</span>.默认保留四个.就是指定日志文件删除之前轮转的次数，0 指没有备份
</span></span><span style=display:flex><span>create	//自动创建新的日志文件，新的日志文件具有和原来的文件相同的权限；因为日志被改名,因此要创建一个新的来继续存储之前的日志
</span></span><span style=display:flex><span>dateext	// 这个参数很重要！就是切割后的日志文件以当前日期为格式结尾，如xxx.log-20131216这样,如果注释掉,切割出来是按数字递增,即前面说的 xxx.log-1这种格式
</span></span><span style=display:flex><span>compress //是否通过gzip压缩转储以后的日志文件，如xxx.log-20131216.gz ；如果不需要压缩，注释掉就行
</span></span><span style=display:flex><span>include /etc/logrotate.d  	//将 /etc/logrotate.d/ 目录中的所有文件都加载进来
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>/var/log/wtmp <span style=color:#000;font-weight:700>{</span>         //仅针对 /var/log/wtmp 所设定的参数
</span></span><span style=display:flex><span>monthly          //每月一次切割,取代默认的一周
</span></span><span style=display:flex><span>minsize 1M       //文件大小超过 1M 后才会切割
</span></span><span style=display:flex><span>create <span style=color:#099>0664</span> root utmp      //指定新建的日志文件权限以及所属用户和组
</span></span><span style=display:flex><span>rotate <span style=color:#099>1</span>          //只保留一个日志.
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这个 wtmp 可记录用户登录系统及系统重启的时间.因为有 minsize 的参数，因此不见得每个月一定会执行一次,要看文件大小。</p><p>由这个文件的设定可以知道/etc/logrotate.d其实就是由/etc/logrotate.conf 所规划出来的目录，虽然可以将所有的配置都写入 /etc/logrotate.conf ，但是这样一来这个文件就实在是太复杂了，尤其是当使用很多的服务在系统上面时， 每个服务都要去修改 /etc/logrotate.conf 的设定也似乎不太合理了。</p><p>所以，如果独立出来一个目录，那么每个要切割日志的服务， 就可以独自成为一个文件，并且放置到 /etc/logrotate.d/ 当中。</p><p>其他重要参数说明：</p><table><thead><tr><th style=text-align:center>参数</th><th style=text-align:center>说明</th></tr></thead><tbody><tr><td style=text-align:center>compress</td><td style=text-align:center>通过gzip 压缩转储以后的日志</td></tr><tr><td style=text-align:center>nocompress</td><td style=text-align:center>不做gzip压缩处理</td></tr><tr><td style=text-align:center>copytruncate</td><td style=text-align:center>用于还在打开中的日志文件，把当前日志备份并截断；是先拷贝再清空的方式，拷贝和清空之间有一个时间差，可能会丢失部分日志数据。</td></tr><tr><td style=text-align:center>nocopytruncate</td><td style=text-align:center>备份日志文件不过不截断</td></tr><tr><td style=text-align:center>create mode owner group</td><td style=text-align:center>轮转时指定创建新文件的属性，如create 0777 nobody nobody</td></tr><tr><td style=text-align:center>nocreate</td><td style=text-align:center>不建立新的日志文件</td></tr><tr><td style=text-align:center>delaycompress</td><td style=text-align:center>和compress 一起使用时，转储的日志文件到下一次转储时才压缩</td></tr><tr><td style=text-align:center>nodelaycompress</td><td style=text-align:center>覆盖 delaycompress 选项，转储同时压缩。</td></tr><tr><td style=text-align:center>missingok</td><td style=text-align:center>如果日志丢失，不报错继续滚动下一个日志</td></tr><tr><td style=text-align:center>errors address</td><td style=text-align:center>转储时的错误信息发送到指定的Email 地址</td></tr><tr><td style=text-align:center>ifempty</td><td style=text-align:center>即使日志文件为空文件也做轮转，这个是logrotate的缺省选项。</td></tr><tr><td style=text-align:center>notifempty</td><td style=text-align:center>当日志文件为空时，不进行轮转</td></tr><tr><td style=text-align:center>mail address</td><td style=text-align:center>把转储的日志文件发送到指定的E-mail 地址</td></tr><tr><td style=text-align:center>nomail</td><td style=text-align:center>转储时不发送日志文件</td></tr><tr><td style=text-align:center>olddir directory</td><td style=text-align:center>转储后的日志文件放入指定的目录，必须和当前日志文件在同一个文件系统</td></tr><tr><td style=text-align:center>noolddir</td><td style=text-align:center>转储后的日志文件和当前日志文件放在同一个目录下</td></tr><tr><td style=text-align:center>sharedscripts</td><td style=text-align:center>运行postrotate脚本，作用是在所有日志都轮转后统一执行一次脚本。如果没有配置这个，那么每个日志轮转后都会执行一次脚本</td></tr><tr><td style=text-align:center>prerotate</td><td style=text-align:center>在logrotate转储之前需要执行的指令，例如修改文件的属性等动作；必须独立成行</td></tr><tr><td style=text-align:center>postrotate</td><td style=text-align:center>在logrotate转储之后需要执行的指令，例如重新启动 (kill -HUP) 某个服务！必须独立成行</td></tr><tr><td style=text-align:center>daily</td><td style=text-align:center>指定转储周期为每天</td></tr><tr><td style=text-align:center>weekly</td><td style=text-align:center>指定转储周期为每周</td></tr><tr><td style=text-align:center>monthly</td><td style=text-align:center>指定转储周期为每月</td></tr><tr><td style=text-align:center>rotate count</td><td style=text-align:center>指定日志文件删除之前转储的次数，0 指没有备份，5 指保留5 个备份</td></tr><tr><td style=text-align:center>dateext</td><td style=text-align:center>使用当期日期作为命名格式</td></tr><tr><td style=text-align:center>dateformat .%s</td><td style=text-align:center>配合dateext使用，紧跟在下一行出现，定义文件切割后的文件名，必须配合dateext使用，只支持 %Y %m %d %s 这四个参数</td></tr><tr><td style=text-align:center>size(或minsize) log-size</td><td style=text-align:center>当日志文件到达指定的大小时才转储，log-size能指定bytes(缺省)及KB (sizek)或MB(sizem).</td></tr><tr><td style=text-align:center></td><td style=text-align:center>当日志文件 >= log-size 的时候就转储。 以下为合法格式：（其他格式的单位大小写没有试过） size = 5 或 size 5 （>= 5 个字节就转储） size = 100k 或 size 100k size = 100M 或 size 100M</td></tr></tbody></table><h3 id=切割nginx日志的配置>切割nginx日志的配置</h3><p>[root@localhost ~]# vim /etc/logrotate.d/nginx</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>/usr/local/nginx/logs/*.log <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>daily
</span></span><span style=display:flex><span>rotate <span style=color:#099>7</span>
</span></span><span style=display:flex><span>missingok
</span></span><span style=display:flex><span>notifempty
</span></span><span style=display:flex><span>dateext
</span></span><span style=display:flex><span>sharedscripts
</span></span><span style=display:flex><span>postrotate
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>if</span> <span style=color:#000;font-weight:700>[</span> -f /usr/local/nginx/logs/nginx.pid <span style=color:#000;font-weight:700>]</span>; <span style=color:#000;font-weight:700>then</span>
</span></span><span style=display:flex><span>	<span style=color:#0086b3>kill</span> -USR1 <span style=color:#d14>`</span>cat /usr/local/nginx/logs/nginx.pid<span style=color:#d14>`</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>fi</span>
</span></span><span style=display:flex><span>endscript
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=关于-usr1-信号解释>关于 USR1 信号解释</h2><p>USR1 通常被用来告知应用程序重载配置文件；例如，向 Apache HTTP 服务器发送一个 USR1 信号将导致以下步骤的发生：停止接受新的连接，等待当前连接停止，重新载入配置文件，重新打开日志文件，重启服务器，从而实现相对平滑的不关机的更改。</p><p>对于 USR1 和 2 都可以用户自定义的，在 POSIX 兼容的平台上，SIGUSR1 和 SIGUSR2 是发送给一个进程的信号，它表示了用户定义的情况。它们的符号常量在头文件 signal.h 中定义。在不同的平台上，信号的编号可能发生变化，因此需要使用符号名称。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>kill -HUP pid
</span></span><span style=display:flex><span>killall -HUP pName
</span></span></code></pre></td></tr></table></div></div><p>其中 pid 是进程标识，pName 是进程的名称。</p><p>如果想要更改配置而不需停止并重新启动服务，可以使用上面两个命令。在对配置文件作必要的更改后，发出该命令以动态更新服务配置。根据约定，当你发送一个挂起信号 (信号 1 或 HUP) 时，大多数服务器进程 (所有常用的进程) 都会进行复位操作并重新加载它们的配置文件。</p><h3 id=分享一例曾经使用过的nginx日志切割处理脚本><strong>分享一例曾经使用过的nginx日志切割处理脚本：</strong></h3><h4 id=logrotate日志分割配置><strong>logrotate日志分割配置</strong></h4><p>[root@localhost ~# vim /etc/logrotate.d/nginx</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>/data/nginx_logs/*.access_log
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>nocompress                  
</span></span><span style=display:flex><span>daily                 
</span></span><span style=display:flex><span>copytruncate                 
</span></span><span style=display:flex><span>create               
</span></span><span style=display:flex><span>ifempty                  
</span></span><span style=display:flex><span>olddir /data/nginx_logs/days      
</span></span><span style=display:flex><span>rotate <span style=color:#099>0</span>                    
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=日志分割脚本><strong>日志分割脚本</strong></h4><p>[root@localhost ~# vim /usr/local/sbin/logrotate-nginx.sh</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic></span><span style=color:#998;font-style:italic>#创建转储日志压缩存放目录</span>
</span></span><span style=display:flex><span>mkdir -p /data/nginx_logs/days
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>#手工对nginx日志进行切割转换</span>
</span></span><span style=display:flex><span>/usr/sbin/logrotate -vf /etc/logrotate.d/nginx
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>#当前时间</span>
</span></span><span style=display:flex><span><span style=color:teal>time</span><span style=color:#000;font-weight:700>=</span><span style=color:#000;font-weight:700>$(</span>date -d <span style=color:#d14>&#34;yesterday&#34;</span> +<span style=color:#d14>&#34;%Y-%m-%d&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>#进入转储日志存放目录</span>
</span></span><span style=display:flex><span><span style=color:#0086b3>cd</span> /data/nginx_logs/days
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>#对目录中的转储日志文件的文件名进行统一转换</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>for</span> i in <span style=color:#000;font-weight:700>$(</span>ls ./ | grep <span style=color:#d14>&#34;^\(.*\)\.[[:digit:]]</span>$<span style=color:#d14>&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>do</span>
</span></span><span style=display:flex><span>mv <span style=color:#d14>${</span><span style=color:teal>i</span><span style=color:#d14>}</span> ./<span style=color:#000;font-weight:700>$(</span><span style=color:#0086b3>echo</span> <span style=color:#d14>${</span><span style=color:teal>i</span><span style=color:#d14>}</span>|sed -n <span style=color:#d14>&#39;s/^\(.*\)\.\([[:digit:]]\)$/\1/p&#39;</span><span style=color:#000;font-weight:700>)</span>-<span style=color:#000;font-weight:700>$(</span><span style=color:#0086b3>echo</span> <span style=color:teal>$time</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>done</span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>#对转储的日志文件进行压缩存放，并删除原有转储的日志文件，只保存压缩后的日志文件。以节约存储空间</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>for</span> i in <span style=color:#000;font-weight:700>$(</span>ls ./ | grep <span style=color:#d14>&#34;^\(.*\)\-\([[:digit:]-]\+\)</span>$<span style=color:#d14>&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>do</span>
</span></span><span style=display:flex><span>tar jcvf <span style=color:#d14>${</span><span style=color:teal>i</span><span style=color:#d14>}</span>.bz2 ./<span style=color:#d14>${</span><span style=color:teal>i</span><span style=color:#d14>}</span>
</span></span><span style=display:flex><span>rm -rf ./<span style=color:#d14>${</span><span style=color:teal>i</span><span style=color:#d14>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>done</span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>#只保留最近7天的压缩转储日志文件</span>
</span></span><span style=display:flex><span>find /data/nginx_logs/days/* -name <span style=color:#d14>&#34;*.bz2&#34;</span> -mtime <span style=color:#099>7</span> -type f -exec rm -rf <span style=color:#000;font-weight:700>{}</span> <span style=color:#d14>\;</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=crontab定时执行><strong>crontab定时执行</strong></h4><p>[root@localhost ~# crontab -e</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#998;font-style:italic>#logrotate</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#099>0</span> <span style=color:#099>0</span> * * * /bin/bash -x /usr/local/sbin/logrotate-nginx.sh &gt; /dev/null 2&gt;&amp;<span style=color:#099>1</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>手动执行脚本，测试下看看：</strong></p><pre tabindex=0><code>[root@localhost ~# /bin/bash -x /usr/local/sbin/logrotate-nginx.sh

[root@localhost ~# cd /data/nginx_logs/days

[root@localhost days# ls

huantest.access_log-2017-01-18.bz2
</code></pre><h4 id=php脚本切割><strong>php脚本切割</strong></h4><p>[root@localhost ~]# cat /etc/logrotate.d/php</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>/Data/logs/php/*log <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    daily
</span></span><span style=display:flex><span>    rotate <span style=color:#099>365</span>
</span></span><span style=display:flex><span>    missingok
</span></span><span style=display:flex><span>    notifempty
</span></span><span style=display:flex><span>    compress
</span></span><span style=display:flex><span>    dateext
</span></span><span style=display:flex><span>    sharedscripts
</span></span><span style=display:flex><span>    postrotate
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>if</span> <span style=color:#000;font-weight:700>[</span> -f /Data/app/php5.6.26/var/run/php-fpm.pid <span style=color:#000;font-weight:700>]</span>; <span style=color:#000;font-weight:700>then</span>
</span></span><span style=display:flex><span>            <span style=color:#0086b3>kill</span> -USR1 <span style=color:#d14>`</span>cat /Data/app/php5.6.26/var/run/php-fpm.pid<span style=color:#d14>`</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>fi</span>
</span></span><span style=display:flex><span>    endscript
</span></span><span style=display:flex><span>    postrotate
</span></span><span style=display:flex><span>        /bin/chmod <span style=color:#099>644</span> /Data/logs/php/*gz
</span></span><span style=display:flex><span>    endscript
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></td></tr></table></div></div><p>结果</p><pre tabindex=0><code>[root@localhost ~]# ll /Data/app/php5.6.26/var/run/php-fpm.pid
-rw-r--r-- 1 root root 4 Dec 28 17:03 /Data/app/php5.6.26/var/run/php-fpm.pid
[root@localhost ~]# cd /Data/logs/php

[root@localhost php]# ll

total 25676

-rw-r--r-- 1 root  root     0 Jun 1 2016 error.log
-rw-r--r-- 1 nobody nobody   182 Aug 30 2015 error.log-20150830.gz
-rw-r--r-- 1 nobody nobody   371 Sep 1 2015 error.log-20150901.gz
-rw-r--r-- 1 nobody nobody   315 Sep 7 2015 error.log-20150907.gz
</code></pre><h4 id=nginx日志切割一例><strong>nginx日志切割一例</strong></h4><p>[root@localhost ~]# cat /etc/logrotate.d/nginx</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>/Data/logs/nginx/*/*log <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    daily
</span></span><span style=display:flex><span>    rotate <span style=color:#099>365</span>
</span></span><span style=display:flex><span>    missingok
</span></span><span style=display:flex><span>    notifempty
</span></span><span style=display:flex><span>    compress
</span></span><span style=display:flex><span>    dateext
</span></span><span style=display:flex><span>    sharedscripts
</span></span><span style=display:flex><span>    postrotate
</span></span><span style=display:flex><span>    /etc/init.d/nginx reload
</span></span><span style=display:flex><span>    endscript
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></td></tr></table></div></div><p>结果</p><pre tabindex=0><code>[root@localhost ~]# ll /Data/logs/nginx/www.huanqiu.com/
..........
-rw-r--r-- 1 root root      1652 Jan  1 00:00 error.log-20170101.gz
-rw-r--r-- 1 root root      1289 Jan  2 00:00 error.log-20170102.gz
-rw-r--r-- 1 root root      1633 Jan  3 00:00 error.log-20170103.gz
-rw-r--r-- 1 root root      3239 Jan  4 00:00 error.log-20170104.gz
</code></pre><h4 id=系统日志切割一例><strong>系统日志切割一例</strong></h4><p>[root@localhost ~]# cat /etc/logrotate.d/syslog</p><pre tabindex=0><code>/var/log/cron
/var/log/maillog
/var/log/messages
/var/log/secure
/var/log/spooler
{
    sharedscripts
    postrotate
    /bin/kill -HUP `cat /var/run/syslogd.pid 2&gt; /dev/null` 2&gt; /dev/null || true
    endscript
}
</code></pre><p>结果</p><pre tabindex=0><code>[root@localhost ~]# ll /var/log/messages*
-rw------- 1 root root 34248975 Jan 19 18:42 /var/log/messages
-rw------- 1 root root 51772994 Dec 25 03:11 /var/log/messages-20161225
-rw------- 1 root root 51800210 Jan  1 03:05 /var/log/messages-20170101
-rw------- 1 root root 51981366 Jan  8 03:36 /var/log/messages-20170108
-rw------- 1 root root 51843025 Jan 15 03:40 /var/log/messages-20170115
[root@localhost ~]# ll /var/log/cron*
-rw------- 1 root root 2155681 Jan 19 18:43 /var/log/cron
-rw------- 1 root root 2932618 Dec 25 03:11 /var/log/cron-20161225
-rw------- 1 root root 2939305 Jan  1 03:06 /var/log/cron-20170101
-rw------- 1 root root 2951820 Jan  8 03:37 /var/log/cron-20170108
-rw------- 1 root root 3203992 Jan 15 03:41 /var/log/cron-20170115
[root@localhost ~]# ll /var/log/secure*
-rw------- 1 root root  275343 Jan 19 18:36 /var/log/secure
-rw------- 1 root root 2111936 Dec 25 03:06 /var/log/secure-20161225
-rw------- 1 root root 2772744 Jan  1 02:57 /var/log/secure-20170101
-rw------- 1 root root 1115543 Jan  8 03:26 /var/log/secure-20170108
-rw------- 1 root root  731599 Jan 15 03:40 /var/log/secure-20170115
[root@localhost ~]# ll /var/log/spooler*
-rw------- 1 root root 0 Jan 15 03:41 /var/log/spooler
-rw------- 1 root root 0 Dec 18 03:21 /var/log/spooler-20161225
-rw------- 1 root root 0 Dec 25 03:11 /var/log/spooler-20170101
-rw------- 1 root root 0 Jan  1 03:06 /var/log/spooler-20170108
-rw------- 1 root root 0 Jan  8 03:37 /var/log/spooler-20170115
</code></pre><h4 id=tomcat日志切割一例><strong>tomcat日志切割一例</strong></h4><p>[root@localhost ~]# cat /etc/logrotate.d/tomcat</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>/Data/app/tomcat-7-huanqiu/logs/catalina.out <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>rotate <span style=color:#099>14</span>
</span></span><span style=display:flex><span>daily
</span></span><span style=display:flex><span>copytruncate
</span></span><span style=display:flex><span>compress
</span></span><span style=display:flex><span>notifempty
</span></span><span style=display:flex><span>missingok
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></td></tr></table></div></div><p>结果</p><pre tabindex=0><code>[root@localhost ~]# ll /Data/app/tomcat-7-huanqiu/logs/catalina.*
-rw-r--r--. 1 root root     0 Jan 19 19:11 /Data/app/tomcat-7-huanqiu/logs/catalina.out
-rw-r--r--. 1 root root 95668 Jan 19 19:11 /Data/app/tomcat-7-huanqiu/logs/catalina.out.1.gz
</code></pre><h4 id=早期用过的nginx日志处理一例><strong>早期用过的nginx日志处理一例</strong></h4><p>[root@localhost ~]# vim /letv/sh/cut_nginx_log.sh</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic></span><span style=color:#998;font-style:italic># 你的日志文件存放目录</span>
</span></span><span style=display:flex><span><span style=color:teal>logs_path</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;/letv/logs/&#34;</span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic># 日志文件的名字，多个需要空格隔开</span>
</span></span><span style=display:flex><span><span style=color:teal>logs_names</span><span style=color:#000;font-weight:700>=(</span>error access pv_access<span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:teal>dates</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>`</span>date -d <span style=color:#d14>&#34;yesterday&#34;</span> +<span style=color:#d14>&#34;%Y%m%d&#34;</span><span style=color:#d14>`</span>
</span></span><span style=display:flex><span>mkdir -p <span style=color:#d14>${</span><span style=color:teal>logs_path</span><span style=color:#d14>}</span><span style=color:teal>$dates</span>/
</span></span><span style=display:flex><span><span style=color:teal>num</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>${#</span><span style=color:teal>logs_names</span>[@]<span style=color:#d14>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>for</span><span style=color:#000;font-weight:700>((</span><span style=color:teal>i</span><span style=color:#000;font-weight:700>=</span>0;i&lt;num;i++<span style=color:#000;font-weight:700>))</span>;<span style=color:#000;font-weight:700>do</span>
</span></span><span style=display:flex><span>mv <span style=color:#d14>${</span><span style=color:teal>logs_path</span><span style=color:#d14>}${</span><span style=color:teal>logs_names</span>[i]<span style=color:#d14>}</span>.log <span style=color:#d14>${</span><span style=color:teal>logs_path</span><span style=color:#d14>}</span><span style=color:teal>$dates</span>/<span style=color:#d14>${</span><span style=color:teal>logs_names</span>[i]<span style=color:#d14>}</span>.log
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>done</span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>#nginx平滑重启</span>
</span></span><span style=display:flex><span><span style=color:#0086b3>kill</span> -USR1 <span style=color:#d14>`</span>cat /letv/logs/nginx/nginx.pid<span style=color:#d14>`</span> 
</span></span></code></pre></td></tr></table></div></div><p>结合crontab定时执行</p><p>[root@localhost ~]# crontab -e</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#998;font-style:italic>#nginx日志切割</span>
</span></span><span style=display:flex><span><span style=color:#099>00</span> <span style=color:#099>00</span> * * * <span style=color:#0086b3>cd</span> /letv/logs;/bin/bash /letv/sh/cut_nginx_log.sh &gt; /dev/null 2&gt;&amp;<span style=color:#099>1</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=尝试解决logrotate无法自动轮询日志的办法><strong>尝试解决logrotate无法自动轮询日志的办法</strong></h3><p>现象说明：</p><p>使用logrotate轮询nginx日志，配置好之后，发现nginx日志连续两天没被切割，这是为什么呢？？</p><p>然后开始检查日志切割的配置文件是否有问题，检查后确定配置文件一切正常。</p><p>于是怀疑是logrotate预定的cron没执行，查看了cron的日志，发现有一条Dec 7 04:02:01 www crond[18959]: (root) CMD (run-parts /etc/cron.daily)这样的日志，证明cron在04:02分时已经执行/etc/cron.daily目录下的程序。</p><p>接着查看/etc /cron.daily/logrotate（这是logrotate自动轮转的脚本）的内容：</p><p>[root@localhost~]# cat /etc/cron.daily/logrotate</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic>#!/bin/sh
</span></span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic></span>/usr/sbin/logrotate /etc/logrotate.conf &gt;/dev/null 2&gt;&amp;<span style=color:#099>1</span>
</span></span><span style=display:flex><span><span style=color:teal>EXITVALUE</span><span style=color:#000;font-weight:700>=</span><span style=color:teal>$?</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>if</span> <span style=color:#000;font-weight:700>[</span> <span style=color:teal>$EXITVALUE</span> !<span style=color:#000;font-weight:700>=</span> <span style=color:#099>0</span> <span style=color:#000;font-weight:700>]</span>; <span style=color:#000;font-weight:700>then</span>
</span></span><span style=display:flex><span>    /usr/bin/logger -t logrotate <span style=color:#d14>&#34;ALERT exited abnormally with [</span><span style=color:teal>$EXITVALUE</span><span style=color:#d14>]&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>fi</span>
</span></span><span style=display:flex><span><span style=color:#0086b3>exit</span> <span style=color:#099>0</span>
</span></span></code></pre></td></tr></table></div></div><p>没有发现异常，配置好的日志轮转操作都是由这个脚本完成的，一切运行正常，脚本应该就没问题。</p><p>直接执行命令：</p><p>[root@localhost ~]# /usr/sbin/logrotate /etc/logrotate.conf</p><p>这些系统日志是正常轮询了，但nginx日志却还是没轮询。接着强行启动记录文件维护操作，纵使logrotate指令认为没有需要，应该有可能是logroate认为nginx日志太小，不进行轮询。</p><p>故需要强制轮询，即在/etc/cron.daily/logrotate脚本中将 -t 参数替换成 -f 参数</p><p>[root@localhost ~]# cat /etc/cron.daily/logrotate</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic>#!/bin/sh
</span></span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic></span>/usr/sbin/logrotate /etc/logrotate.conf &gt;/dev/null 2&gt;&amp;<span style=color:#099>1</span>
</span></span><span style=display:flex><span><span style=color:teal>EXITVALUE</span><span style=color:#000;font-weight:700>=</span><span style=color:teal>$?</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>if</span> <span style=color:#000;font-weight:700>[</span> <span style=color:teal>$EXITVALUE</span> !<span style=color:#000;font-weight:700>=</span> <span style=color:#099>0</span> <span style=color:#000;font-weight:700>]</span>; <span style=color:#000;font-weight:700>then</span>
</span></span><span style=display:flex><span>	/usr/bin/logger -f logrotate <span style=color:#d14>&#34;ALERT exited abnormally with [</span><span style=color:teal>$EXITVALUE</span><span style=color:#d14>]&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>fi</span>
</span></span><span style=display:flex><span><span style=color:#0086b3>exit</span> 
</span></span></code></pre></td></tr></table></div></div><p>最后重启下cron服务：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#000;font-weight:700>[</span>root@localhost ~<span style=color:#000;font-weight:700>]</span><span style=color:#998;font-style:italic># /etc/init.d/crond restart</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Stopping crond: <span style=color:#000;font-weight:700>[</span> OK <span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span>Starting crond: <span style=color:#000;font-weight:700>[</span> OK <span style=color:#000;font-weight:700>]</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>logrotate默认自动切割生效时间</strong></p><p>Logrotate是基于CRON来运行的，其脚本是/etc/cron.daily/logrotate，实际运行时，Logrotate会调用配置文件/etc/logrotate.conf。</p><p>[root@test ~]# cat /etc/cron.daily/logrotate</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic>#!/bin/sh
</span></span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic></span>/usr/sbin/logrotate /etc/logrotate.conf
</span></span><span style=display:flex><span><span style=color:teal>EXITVALUE</span><span style=color:#000;font-weight:700>=</span><span style=color:teal>$?</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>if</span> <span style=color:#000;font-weight:700>[</span> <span style=color:teal>$EXITVALUE</span> !<span style=color:#000;font-weight:700>=</span> <span style=color:#099>0</span> <span style=color:#000;font-weight:700>]</span>; <span style=color:#000;font-weight:700>then</span>
</span></span><span style=display:flex><span>    /usr/bin/logger -t logrotate <span style=color:#d14>&#34;ALERT exited abnormally with [</span><span style=color:teal>$EXITVALUE</span><span style=color:#d14>]&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>fi</span>
</span></span><span style=display:flex><span><span style=color:#0086b3>exit</span> <span style=color:#099>0</span>
</span></span></code></pre></td></tr></table></div></div><p>时间是由CRON控制的，具体可以查询CRON的配置文件/etc/anacrontab（老版本的文件是/etc/crontab）</p><p>[root@test ~]# cat /etc/anacrontab</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#998;font-style:italic># /etc/anacrontab: configuration file for anacron</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic># See anacron(8) and anacrontab(5) for details.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:teal>SHELL</span><span style=color:#000;font-weight:700>=</span>/bin/sh
</span></span><span style=display:flex><span><span style=color:teal>PATH</span><span style=color:#000;font-weight:700>=</span>/sbin:/bin:/usr/sbin:/usr/bin
</span></span><span style=display:flex><span><span style=color:teal>MAILTO</span><span style=color:#000;font-weight:700>=</span>root
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic># the maximal random delay added to the base delay of the jobs</span>
</span></span><span style=display:flex><span><span style=color:teal>RANDOM_DELAY</span><span style=color:#000;font-weight:700>=</span><span style=color:#099>45</span>                                                                  //这个是随机的延迟时间，表示最大45分钟
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic># the jobs will be started during the following hours only</span>
</span></span><span style=display:flex><span><span style=color:teal>START_HOURS_RANGE</span><span style=color:#000;font-weight:700>=</span>3-22                                                           //这个是开始时间
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>#period in days   delay in minutes   job-identifier   command</span>
</span></span><span style=display:flex><span><span style=color:#099>1</span> <span style=color:#099>5</span> cron.daily    nice run-parts /etc/cron.daily
</span></span><span style=display:flex><span><span style=color:#099>7</span> <span style=color:#099>25</span>  cron.weekly   nice run-parts /etc/cron.weekly
</span></span><span style=display:flex><span>@monthly <span style=color:#099>45</span> cron.monthly    nice run-parts /etc/cron.monthly
</span></span></code></pre></td></tr></table></div></div><p>第一个是Recurrence period</p><p>第二个是延迟时间</p><p>所以cron.daily会在3:22+(5,45)这个时间段执行，/etc/cron.daily是个文件夹.</p><p>通过默认/etc/anacrontab文件配置，会发现logrotate自动切割日志文件的默认时间是凌晨3点多。</p><p>==================================================================================================</p><p>现在需要将切割时间调整到每天的晚上12点，即每天切割的日志是前一天的0-24点之间的内容。</p><p>操作如下：</p><p>[root@localhost ~]# mv /etc/anacrontab /etc/anacrontab.bak //取消日志自动轮转的设置</p><p>[root@localhost logrotate.d]# cat nstc_nohup.out</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>/data/nstc/nohup.out <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>rotate <span style=color:#099>30</span>
</span></span><span style=display:flex><span>dateext
</span></span><span style=display:flex><span>daily
</span></span><span style=display:flex><span>copytruncate
</span></span><span style=display:flex><span>compress
</span></span><span style=display:flex><span>notifempty
</span></span><span style=display:flex><span>missingok
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></td></tr></table></div></div><p>[root@localhost logrotate.d]# cat syslog</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>/var/log/cron
</span></span><span style=display:flex><span>/var/log/maillog
</span></span><span style=display:flex><span>/var/log/messages
</span></span><span style=display:flex><span>/var/log/secure
</span></span><span style=display:flex><span>/var/log/history
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    sharedscripts
</span></span><span style=display:flex><span>    compress
</span></span><span style=display:flex><span>    rotate <span style=color:#099>30</span>
</span></span><span style=display:flex><span>    daily
</span></span><span style=display:flex><span>    dateext
</span></span><span style=display:flex><span>    postrotate
</span></span><span style=display:flex><span>    /bin/kill -HUP <span style=color:#d14>`</span>cat /var/run/syslogd.pid 2&gt; /dev/null<span style=color:#d14>`</span> 2&gt; /dev/null <span style=color:#000;font-weight:700>||</span> <span style=color:#0086b3>true</span>
</span></span><span style=display:flex><span>    endscript
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></td></tr></table></div></div><p>结合crontab进行自定义的定时轮转操作</p><p>[root@localhost ~]# crontab -l</p><pre tabindex=0><code>#log logrotate
59 23 * * * /usr/sbin/logrotate -f /etc/logrotate.d/syslog &gt;/dev/null 2&gt;&amp;1
59 23 * * * /usr/sbin/logrotate -f /etc/logrotate.d/nstc_nohup.out &gt;/dev/null 2&gt;&amp;1
</code></pre><p>结果</p><pre tabindex=0><code>[root@localhost ~]# ll /data/nstc/nohup.out*
-rw------- 1 app app 33218 1月  25 09:43 /data/nstc/nohup.out
-rw------- 1 app app 67678 1月  25 23:59 /data/nstc/nohup.out-20180125.gz
</code></pre><p>除了利用自带的Logrotate工具实现日志切割之外，还可以编写python脚本或shell脚本以实现日志切割。下面就简单列出几个实例说明下：</p><h3 id=其他工具实现日志切割>其他工具实现日志切割</h3><h4 id=python脚本实现日志切割><strong>Python脚本实现日志切割</strong></h4><p>实例1：对jumpserver日志进行切割</p><p>[root@localhost mnt]# cat log_rotate.py</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic>#!/usr/bin/env python
</span></span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic></span>import datetime,os,sys,shutil
</span></span><span style=display:flex><span><span style=color:teal>log_path</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>&#39;/opt/jumpserver/logs/&#39;</span>
</span></span><span style=display:flex><span><span style=color:teal>log_file</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>&#39;jumpserver.log&#39;</span>
</span></span><span style=display:flex><span><span style=color:teal>yesterday</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>(</span>datetime.datetime.now<span style=color:#000;font-weight:700>()</span> - datetime.timedelta<span style=color:#000;font-weight:700>(</span><span style=color:teal>days</span> <span style=color:#000;font-weight:700>=</span> 1<span style=color:#000;font-weight:700>))</span>
</span></span><span style=display:flex><span>try:
</span></span><span style=display:flex><span>    os.makedirs<span style=color:#000;font-weight:700>(</span>log_path + yesterday.strftime<span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#39;%Y&#39;</span><span style=color:#000;font-weight:700>)</span> + os.sep + <span style=color:#d14>\
</span></span></span><span style=display:flex><span><span style=color:#d14></span>                yesterday.strftime<span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#39;%m&#39;</span><span style=color:#000;font-weight:700>))</span>
</span></span><span style=display:flex><span>except OSError,e:
</span></span><span style=display:flex><span>    print
</span></span><span style=display:flex><span>    print e
</span></span><span style=display:flex><span>    sys.exit<span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>shutil.move<span style=color:#000;font-weight:700>(</span>log_path + log_file,log_path <span style=color:#d14>\
</span></span></span><span style=display:flex><span><span style=color:#d14></span>            + yesterday.strftime<span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#39;%Y&#39;</span><span style=color:#000;font-weight:700>)</span> + os.sep <span style=color:#d14>\
</span></span></span><span style=display:flex><span><span style=color:#d14></span>            + yesterday.strftime<span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#39;%m&#39;</span><span style=color:#000;font-weight:700>)</span> + os.sep <span style=color:#d14>\
</span></span></span><span style=display:flex><span><span style=color:#d14></span>            + log_file + <span style=color:#d14>&#39;_&#39;</span> + yesterday.strftime<span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#39;%Y%m%d&#39;</span><span style=color:#000;font-weight:700>)</span> + <span style=color:#d14>&#39;.log&#39;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>os.popen<span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#34;sudo /opt/jumpserver/service.sh restart&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span></code></pre></td></tr></table></div></div><p>手动执行这个脚本：</p><pre tabindex=0><code>[root@localhost mnt]# chmod 755 log_rotate.py
[root@localhost mnt]# python log_rotate.py
</code></pre><p>查看日志切割后的效果：</p><pre tabindex=0><code>[root@localhost mnt]# ls /opt/jumpserver/logs/
2017  jumpserver.log 
[root@localhost mnt]# ls /opt/jumpserver/logs/2017/
09
[root@localhost mnt]# ls /opt/jumpserver/logs/2017/09/
jumpserver.log_20170916.log
</code></pre><p>然后做每日的定时切割任务：</p><p>[root@localhost mnt]# crontab -e</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#099>30</span> <span style=color:#099>1</span> * * * /usr/bin/python /mnt/log_rotate.py &gt; /dev/null 2&gt;&amp;<span style=color:#099>1</span>
</span></span></code></pre></td></tr></table></div></div><p>实例2:对nginx日志进行切割</p><p>[root@localhost mnt]# vim log_rotate.py</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic>#!/usr/bin/env python
</span></span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic></span>import datetime,os,sys,shutil
</span></span><span style=display:flex><span><span style=color:teal>log_path</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>&#39;/app/nginx/logs/&#39;</span>
</span></span><span style=display:flex><span><span style=color:teal>log_file</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>&#39;www_access.log&#39;</span>
</span></span><span style=display:flex><span><span style=color:teal>yesterday</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>(</span>datetime.datetime.now<span style=color:#000;font-weight:700>()</span> - datetime.timedelta<span style=color:#000;font-weight:700>(</span><span style=color:teal>days</span> <span style=color:#000;font-weight:700>=</span> 1<span style=color:#000;font-weight:700>))</span>
</span></span><span style=display:flex><span>try:
</span></span><span style=display:flex><span>    os.makedirs<span style=color:#000;font-weight:700>(</span>log_path + yesterday.strftime<span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#39;%Y&#39;</span><span style=color:#000;font-weight:700>)</span> + os.sep + <span style=color:#d14>\
</span></span></span><span style=display:flex><span><span style=color:#d14></span>                yesterday.strftime<span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#39;%m&#39;</span><span style=color:#000;font-weight:700>))</span>
</span></span><span style=display:flex><span>except OSError,e:
</span></span><span style=display:flex><span>    print
</span></span><span style=display:flex><span>    print e
</span></span><span style=display:flex><span>    sys.exit<span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>shutil.move<span style=color:#000;font-weight:700>(</span>log_path + log_file,log_path <span style=color:#d14>\
</span></span></span><span style=display:flex><span><span style=color:#d14></span>            + yesterday.strftime<span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#39;%Y&#39;</span><span style=color:#000;font-weight:700>)</span> + os.sep <span style=color:#d14>\
</span></span></span><span style=display:flex><span><span style=color:#d14></span>            + yesterday.strftime<span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#39;%m&#39;</span><span style=color:#000;font-weight:700>)</span> + os.sep <span style=color:#d14>\
</span></span></span><span style=display:flex><span><span style=color:#d14></span>            + log_file + <span style=color:#d14>&#39;_&#39;</span> + yesterday.strftime<span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#39;%Y%m%d&#39;</span><span style=color:#000;font-weight:700>)</span> + <span style=color:#d14>&#39;.log&#39;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>os.popen<span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#34;sudo kill -USR1 `cat /app/nginx/logs/nginx.pid`&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=shell脚本实现日志切割><strong>shell脚本实现日志切割</strong></h4><p>[root@localhost ~]# cat /app/script/log_rotate.sh</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic>#!/bin/sh
</span></span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic></span><span style=color:#000;font-weight:700>function</span> rotate<span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span><span style=color:teal>logs_path</span><span style=color:#000;font-weight:700>=</span><span style=color:teal>$1</span>
</span></span><span style=display:flex><span><span style=color:#0086b3>echo</span> Rotating Log: <span style=color:teal>$1</span>
</span></span><span style=display:flex><span>cp <span style=color:#d14>${</span><span style=color:teal>logs_path</span><span style=color:#d14>}</span> <span style=color:#d14>${</span><span style=color:teal>logs_path</span><span style=color:#d14>}</span>.<span style=color:#000;font-weight:700>$(</span>date -d <span style=color:#d14>&#34;yesterday&#34;</span> +<span style=color:#d14>&#34;%Y%m%d&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>&gt; <span style=color:#d14>${</span><span style=color:teal>logs_path</span><span style=color:#d14>}</span>
</span></span><span style=display:flex><span>    rm -f <span style=color:#d14>${</span><span style=color:teal>logs_path</span><span style=color:#d14>}</span>.<span style=color:#000;font-weight:700>$(</span>date -d <span style=color:#d14>&#34;7 days ago&#34;</span> +<span style=color:#d14>&#34;%Y%m%d&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>for</span> i in <span style=color:teal>$*</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>do</span>
</span></span><span style=display:flex><span>        rotate <span style=color:teal>$i</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>done</span>
</span></span></code></pre></td></tr></table></div></div><p>每天定时切割日志的任务制定（比如对python的一个业务/data/log/xcspam/下的日志进行切割，0K的日志不进行切割）：</p><p>[root@localhost ~]# crontab -e</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#998;font-style:italic>#xcspam 日志切割</span>
</span></span><span style=display:flex><span><span style=color:#099>30</span> <span style=color:#099>0</span> * * * find /data/log/xcspam/ -size +0 -name <span style=color:#d14>&#39;*.log&#39;</span> | xargs /app/script/log_rotate.sh
</span></span></code></pre></td></tr></table></div></div><p>手动执行切割：</p><p>[root@localhost ~]# find /data/log/xcspam/ -size +0 -name &lsquo;*.log&rsquo; | xargs /app/script/log_rotate.sh</p><p>切割后的日志效果：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#000;font-weight:700>[</span>root@qd-vpc-op-consumer01 ~<span style=color:#000;font-weight:700>]</span><span style=color:#998;font-style:italic># ls /data/log/xcspam/</span>
</span></span><span style=display:flex><span>xcspam_error.log xcspam_error.log-20170926
</span></span></code></pre></td></tr></table></div></div><p>比如对maridb日志进行切割</p><p>[root@localhost ~]# crontab -e</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#998;font-style:italic>#xcspam 日志切割</span>
</span></span><span style=display:flex><span><span style=color:#099>30</span> <span style=color:#099>0</span> * * * find /var/log/mariadb/ -size +0 -name <span style=color:#d14>&#39;*.log&#39;</span> | xargs /app/script/log_rotate.sh
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#000;font-weight:700>[</span>root@localhost ~<span style=color:#000;font-weight:700>]</span><span style=color:#998;font-style:italic># find /var/log/mariadb/ -size +0 -name &#39;*.log&#39; | xargs /app/script/log_rotate.sh</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>[</span>root@localhost ~<span style=color:#000;font-weight:700>]</span><span style=color:#998;font-style:italic># ll /var/log/mariadb/</span>
</span></span><span style=display:flex><span>总用量 <span style=color:#099>8</span>
</span></span><span style=display:flex><span>-rw-r-----. <span style=color:#099>1</span> mysql mysql    <span style=color:#099>0</span> 9月  <span style=color:#099>17</span> 20:31 mariadb.log
</span></span><span style=display:flex><span>-rw-r-----. <span style=color:#099>1</span> root  root  <span style=color:#099>4532</span> 9月  <span style=color:#099>17</span> 20:31 mariadb.log.20170916
</span></span></code></pre></td></tr></table></div></div><p>日志压缩脚本：</p><pre tabindex=0><code>[root@localhost ~]# ls /var/log/fss/nginx/

nginx.20190506.log nginx.20190507.log nginx.20190508.log
</code></pre><p>[root@localhost ~]# cat /root/log_clean.sh</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic>#!/usr/bin/sh
</span></span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic></span><span style=color:#998;font-style:italic>#根据系统/服务/日志保留天数三个参数压缩日志</span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>#usage: sh clearlog.sh sysname appname keepdays</span>
</span></span><span style=display:flex><span><span style=color:teal>sysName</span><span style=color:#000;font-weight:700>=</span><span style=color:teal>$1</span>
</span></span><span style=display:flex><span><span style=color:teal>appName</span><span style=color:#000;font-weight:700>=</span><span style=color:teal>$2</span>
</span></span><span style=display:flex><span><span style=color:teal>keepDay</span><span style=color:#000;font-weight:700>=</span><span style=color:teal>$3</span>
</span></span><span style=display:flex><span><span style=color:teal>logDir</span><span style=color:#000;font-weight:700>=</span>/var/log/<span style=color:#d14>${</span><span style=color:teal>sysName</span><span style=color:#d14>}</span>/<span style=color:#d14>${</span><span style=color:teal>appName</span><span style=color:#d14>}</span>
</span></span><span style=display:flex><span><span style=color:teal>logFile</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>${</span><span style=color:teal>appName</span><span style=color:#d14>}</span>.*<span style=color:#000;font-weight:700>[</span>0-9<span style=color:#000;font-weight:700>][</span>0-9<span style=color:#000;font-weight:700>]</span>.log
</span></span><span style=display:flex><span><span style=color:#0086b3>cd</span> <span style=color:#d14>${</span><span style=color:teal>logDir</span><span style=color:#d14>}</span>
</span></span><span style=display:flex><span>find ./ -name <span style=color:#d14>&#34;</span><span style=color:#d14>${</span><span style=color:teal>logFile</span><span style=color:#d14>}</span><span style=color:#d14>&#34;</span> -mtime -<span style=color:#d14>${</span><span style=color:teal>keepDay</span><span style=color:#d14>}</span> -exec gzip <span style=color:#000;font-weight:700>{}</span> <span style=color:#d14>\;</span>
</span></span></code></pre></td></tr></table></div></div><pre tabindex=0><code>[root@localhost ~]# sh /root/log_clean.sh fss nginx 3
[root@localhost ~]# ls /var/log/fss/nginx/
nginx.20190506.log.gz  nginx.20190507.log.gz  nginx.20190508.log.gz
</code></pre><p>还可以针对日志保留策略，调整成日志清理脚本。</p><p>推荐用的Nginx日志轮转方法 [部署在nginx的日志目录下]</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic></span><span style=color:teal>yesterday</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>`</span>date -d <span style=color:#d14>&#34;-1 days&#34;</span> +<span style=color:#d14>&#39;%Y%m%d&#39;</span><span style=color:#d14>`</span>
</span></span><span style=display:flex><span><span style=color:#0086b3>cd</span> <span style=color:#d14>`</span>dirname <span style=color:teal>$0</span><span style=color:#d14>`</span>
</span></span><span style=display:flex><span><span style=color:teal>basedir</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>`</span><span style=color:#0086b3>pwd</span><span style=color:#d14>`</span>
</span></span><span style=display:flex><span><span style=color:teal>logdir</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;</span><span style=color:#d14>${</span><span style=color:teal>basedir</span><span style=color:#d14>}</span><span style=color:#d14>/bak&#34;</span>
</span></span><span style=display:flex><span><span style=color:teal>bindir</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;</span><span style=color:#d14>${</span><span style=color:teal>basedir</span>%/*<span style=color:#d14>}</span><span style=color:#d14>/sbin&#34;</span>
</span></span><span style=display:flex><span>mkdir -p <span style=color:#d14>${</span><span style=color:teal>logdir</span><span style=color:#d14>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>for</span> log in <span style=color:#d14>`</span>ls *.log 2&gt;/dev/null<span style=color:#d14>`</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>do</span>
</span></span><span style=display:flex><span>    mv <span style=color:#d14>${</span><span style=color:teal>log</span><span style=color:#d14>}</span> <span style=color:#d14>${</span><span style=color:teal>logdir</span><span style=color:#d14>}</span>/<span style=color:#d14>${</span><span style=color:teal>log</span><span style=color:#d14>}</span>.<span style=color:#d14>${</span><span style=color:teal>yesterday</span><span style=color:#d14>}</span>.bak
</span></span><span style=display:flex><span>    <span style=color:#998;font-style:italic># gzip ${logdir}/${log}.${yesterday}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>done</span>
</span></span><span style=display:flex><span><span style=color:#d14>${</span><span style=color:teal>bindir</span><span style=color:#d14>}</span>/nginx -s reload
</span></span><span style=display:flex><span><span style=color:#0086b3>cd</span> <span style=color:#d14>${</span><span style=color:teal>logdir</span><span style=color:#d14>}</span>
</span></span><span style=display:flex><span>find . -type f -name <span style=color:#d14>&#34;*.bak&#34;</span> -mtime +7 | xargs rm -f
</span></span></code></pre></td></tr></table></div></div></div></div></div><div id=footer><div class=container-footer><div class=beian><a target=_blank href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode="></a><a href target=_blank><span class=some>icp...<span></a></div><div class=info><a href=https://github.com/loveminimal/hugo-theme-virgo>🕊️</a> 2021 - <span id=info-date></span></div></div></div><div class=cool-after></div></body></html>