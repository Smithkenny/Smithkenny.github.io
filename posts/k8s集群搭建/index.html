<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>k8s集群搭建 - My New Hugo Site</title><meta name=Description content="This is my cool site"><meta property="og:title" content="k8s集群搭建"><meta property="og:description" content="Kubernetes （1.22.2）安装手册（Ubuntu非高可用版） 安装前准备工作 （重要！）安装k8s 1.22.2 版本需要的硬件条件： 所有节点：
cpu数量2个及以上
4G 以上内存
不用开虚拟化
(重要！！)虚拟机不要用克隆，每台都要单独创建否则会出问题。
未安装docker 之前创建一个快照。
安装docker、kubelet，并初始化集群后在创建一个快照。
未安装cni插件之前创建一个快照，以便于随时更改calico 和fluence
kubeadm 初始化失败检查，重置kubeadm。
ip 地址规划：
master: 10.4.7.60/24 gw:10.4.7.254 dns:114.114.114.114 worker1: 10.4.7.61/24 gw:10.4.7.254 dns:114.114.114.114 worker1: 10.4.7.61/24 gw:10.4.7.254 dns:114.114.114.114 各节点安装时需要更换apt源：(更新和安装deb包都很快！！！)
http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ 1. 设置hosts解析 操作节点：所有节点（master）均需执行
修改hostname hostname必须只能包含小写字母、数字、&#34;,&#34;、&#34;-&#34;，且开头结尾必须是小写字母或数字 # 在master节点 hostnamectl set-hostname master #设置master节点的hostname # slave1节点 hostnamectl set-hostname worker1 # slave2节点 hostnamectl set-hostname worker2 2. 调整系统配置 操作节点： 所有的master和slave节点（master,k8s-slave）需要执行
本章下述操作均以master为例，其他节点均是相同的操作（ip和hostname的值换成对应机器的真实值）
设置iptables
iptables -P FORWARD ACCEPT /etc/init.d/ufw stop ufw disable 关闭swap swapoff -a # 防止开机自动挂载 swap 分区 rm /swap."><meta property="og:type" content="article"><meta property="og:url" content="http://example.org/posts/k8s%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-01-02T18:15:28+00:00"><meta property="article:modified_time" content="2022-01-02T18:15:28+00:00"><meta property="og:site_name" content="My cool site"><meta name=twitter:card content="summary"><meta name=twitter:title content="k8s集群搭建"><meta name=twitter:description content="Kubernetes （1.22.2）安装手册（Ubuntu非高可用版） 安装前准备工作 （重要！）安装k8s 1.22.2 版本需要的硬件条件： 所有节点：
cpu数量2个及以上
4G 以上内存
不用开虚拟化
(重要！！)虚拟机不要用克隆，每台都要单独创建否则会出问题。
未安装docker 之前创建一个快照。
安装docker、kubelet，并初始化集群后在创建一个快照。
未安装cni插件之前创建一个快照，以便于随时更改calico 和fluence
kubeadm 初始化失败检查，重置kubeadm。
ip 地址规划：
master: 10.4.7.60/24 gw:10.4.7.254 dns:114.114.114.114 worker1: 10.4.7.61/24 gw:10.4.7.254 dns:114.114.114.114 worker1: 10.4.7.61/24 gw:10.4.7.254 dns:114.114.114.114 各节点安装时需要更换apt源：(更新和安装deb包都很快！！！)
http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ 1. 设置hosts解析 操作节点：所有节点（master）均需执行
修改hostname hostname必须只能包含小写字母、数字、&#34;,&#34;、&#34;-&#34;，且开头结尾必须是小写字母或数字 # 在master节点 hostnamectl set-hostname master #设置master节点的hostname # slave1节点 hostnamectl set-hostname worker1 # slave2节点 hostnamectl set-hostname worker2 2. 调整系统配置 操作节点： 所有的master和slave节点（master,k8s-slave）需要执行
本章下述操作均以master为例，其他节点均是相同的操作（ip和hostname的值换成对应机器的真实值）
设置iptables
iptables -P FORWARD ACCEPT /etc/init.d/ufw stop ufw disable 关闭swap swapoff -a # 防止开机自动挂载 swap 分区 rm /swap."><meta name=application-name content="My cool site"><meta name=apple-mobile-web-app-title content="My cool site"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=http://example.org/posts/k8s%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/><link rel=prev href=http://example.org/posts/ubuntu%E7%B3%BB%E7%BB%9F%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E/><link rel=next href=http://example.org/posts/nginx%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"k8s集群搭建","inLanguage":"en-us","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/example.org\/posts\/k8s%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA\/"},"genre":"posts","wordcount":1435,"url":"http:\/\/example.org\/posts\/k8s%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA\/","datePublished":"2022-01-02T18:15:28+00:00","dateModified":"2022-01-02T18:15:28+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Author"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="My New Hugo Site">My cool site</a></div><div class=menu><div class=menu-inner><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="My New Hugo Site">My cool site</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">k8s集群搭建</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Author</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2022-01-02>2022-01-02</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;1435 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;7 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#安装前准备工作>安装前准备工作</a><ul><li><a href=#重要安装k8s-1222-版本需要的硬件条件>（重要！）安装k8s 1.22.2 版本需要的硬件条件：</a></li><li><a href=#1-设置hosts解析>1. 设置hosts解析</a></li><li><a href=#2-调整系统配置>2. 调整系统配置</a></li><li><a href=#3-安装docker>3. 安装docker</a></li><li><a href=#给kubectl-设置别名为k永久生效>给kubectl 设置别名为k，永久生效。</a></li><li><a href=#使用kubectl中的强制删除命令>使用kubectl中的强制删除命令</a></li><li><a href=#自动补全>自动补全</a></li></ul></li><li><a href=#部署kubernetes>部署kubernetes</a><ul><li><a href=#1-安装-kubeadm-kubelet-和-kubectl>1. 安装 kubeadm, kubelet 和 kubectl</a></li><li><a href=#2-初始化配置文件>2. 初始化配置文件</a></li><li><a href=#3-提前下载镜像>3. 提前下载镜像</a></li><li><a href=#4-初始化master节点>4. 初始化master节点</a></li><li><a href=#5-添加slave节点到集群中>5. 添加slave节点到集群中</a></li><li><a href=#6-安装calico插件>6. 安装calico插件</a></li><li><a href=#7-验证集群>7. 验证集群</a></li><li><a href=#8-清理环境>8. 清理环境</a></li></ul></li></ul></nav></div></div><div class=content id=content><h1 id=kubernetes-1222安装手册ubuntu非高可用版>Kubernetes （1.22.2）安装手册（Ubuntu非高可用版）</h1><h2 id=安装前准备工作>安装前准备工作</h2><h3 id=重要安装k8s-1222-版本需要的硬件条件>（重要！）安装k8s 1.22.2 版本需要的硬件条件：</h3><p>所有节点：</p><p><strong>cpu数量2个及以上</strong></p><p>4G 以上内存</p><p>不用开虚拟化</p><p><strong>(重要！！)虚拟机不要用克隆，每台都要单独创建否则会出问题。</strong></p><p>未安装docker 之前创建一个快照。</p><p>安装docker、kubelet，并初始化集群后在创建一个快照。</p><p>未安装cni插件之前创建一个快照，以便于随时更改calico 和fluence</p><p>kubeadm 初始化失败检查，重置kubeadm。</p><p>ip 地址规划：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>master: 10.4.7.60/24 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>gw:10.4.7.254
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>dns:114.114.114.114
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>worker1: 10.4.7.61/24
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>gw:10.4.7.254
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>dns:114.114.114.114
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>worker1: 10.4.7.61/24
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>gw:10.4.7.254
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>dns:114.114.114.114
</span></span></code></pre></div><p><strong>各节点安装时需要更换apt源：(更新和安装deb包都很快！！！)</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>http://mirrors.tuna.tsinghua.edu.cn/ubuntu/
</span></span></code></pre></div><h3 id=1-设置hosts解析>1. 设置hosts解析</h3><p>操作节点：所有节点（<code>master</code>）均需执行</p><ul><li><strong>修改hostname</strong>
hostname必须只能包含小写字母、数字、","、"-"，且开头结尾必须是小写字母或数字</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span><span style=color:#75715e># 在master节点</span>
</span></span><span style=display:flex><span>hostnamectl set-hostname master <span style=color:#75715e>#设置master节点的hostname</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># slave1节点</span>
</span></span><span style=display:flex><span>hostnamectl set-hostname worker1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># slave2节点</span>
</span></span><span style=display:flex><span>hostnamectl set-hostname worker2
</span></span></code></pre></div><h3 id=2-调整系统配置>2. 调整系统配置</h3><p>操作节点： 所有的master和slave节点（<code>master,k8s-slave</code>）需要执行</p><blockquote><p>本章下述操作均以master为例，其他节点均是相同的操作（ip和hostname的值换成对应机器的真实值）</p></blockquote><p><strong>设置iptables</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>iptables -P FORWARD ACCEPT
</span></span><span style=display:flex><span>/etc/init.d/ufw stop
</span></span><span style=display:flex><span>ufw disable
</span></span></code></pre></div><ul><li><strong>关闭swap</strong></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>swapoff -a
</span></span><span style=display:flex><span><span style=color:#75715e># 防止开机自动挂载 swap 分区</span>
</span></span><span style=display:flex><span>rm /swap.img  
</span></span><span style=display:flex><span>sed -i <span style=color:#e6db74>&#39;/ swap / s/^\(.*\)$/#\1/g&#39;</span> /etc/fstab
</span></span></code></pre></div><ul><li><strong>修改内核参数</strong></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>cat <span style=color:#e6db74>&lt;&lt;EOF &gt;  /etc/sysctl.d/k8s.conf
</span></span></span><span style=display:flex><span><span style=color:#e6db74>net.bridge.bridge-nf-call-ip6tables = 1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>net.bridge.bridge-nf-call-iptables = 1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>net.ipv4.ip_forward=1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>vm.max_map_count=262144
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span>modprobe br_netfilter
</span></span><span style=display:flex><span>sysctl -p /etc/sysctl.d/k8s.conf
</span></span></code></pre></div><ul><li>设置apt源</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>apt-get update <span style=color:#f92672>&amp;&amp;</span> apt-get install -y apt-transport-https ca-certificates software-properties-common 
</span></span><span style=display:flex><span>curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | apt-key add - 
</span></span><span style=display:flex><span>curl -fsSL https://mirrors.ustc.edu.cn/docker-ce/linux/ubuntu/gpg | sudo apt-key add -
</span></span><span style=display:flex><span>add-apt-repository <span style=color:#e6db74>&#34;deb [arch=amd64] https://mirrors.ustc.edu.cn/docker-ce/linux/ubuntu </span><span style=color:#66d9ef>$(</span>lsb_release -cs<span style=color:#66d9ef>)</span><span style=color:#e6db74> stable&#34;</span>
</span></span><span style=display:flex><span>add-apt-repository <span style=color:#e6db74>&#34;deb [arch=amd64] https://mirrors.aliyun.com/kubernetes/apt kubernetes-xenial main&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>apt-get update   
</span></span><span style=display:flex><span><span style=color:#75715e>#若上步出现NO_PUBLICKEY问题，参考https://www.cnblogs.com/jiangzuo/p/13667011.html</span>
</span></span></code></pre></div><h3 id=3-安装docker>3. 安装docker</h3><p>操作节点： 所有节点</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>apt<span style=color:#f92672>-</span>get install docker<span style=color:#f92672>-</span>ce<span style=color:#f92672>=</span><span style=color:#ae81ff>5</span>:<span style=color:#ae81ff>20.10.9</span><span style=color:#f92672>~</span><span style=color:#ae81ff>3</span><span style=color:#f92672>-</span><span style=color:#ae81ff>0</span><span style=color:#f92672>~</span>ubuntu<span style=color:#f92672>-</span>focal
</span></span><span style=display:flex><span>systemctl enable docker <span style=color:#f92672>&amp;&amp;</span> systemctl start docker
</span></span></code></pre></div><p>注意要关闭docker 默认的cgroup 否则会出现kubeadm 初始化失败！！！！</p><p>这是cgroup驱动问题。默认情况下Kubernetes cgroup驱动程序设置为system，但docker设置为systemd。我们需要更改Docker cgroup驱动，通过创建配置文件<code>/etc/docker/daemon.json</code>并添加以下行：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>{<span style=color:#e6db74>&#34;exec-opts&#34;</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#34;native.cgroupdriver=systemd&#34;</span>]}
</span></span></code></pre></div><p>然后，为使配置生效，你必须重启docker和kubelet。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>systemctl daemon-reloadsystemctl restart dockersystemctl restart kubelet
</span></span></code></pre></div><p>重置kubeadm</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>sudo kubeadm reset
</span></span></code></pre></div><p>查看所有节点是否有污点</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>kubectl get nodes -o json | jq <span style=color:#e6db74>&#39;.items[].spec.taints&#39;</span>
</span></span></code></pre></div><h3 id=给kubectl-设置别名为k永久生效>给kubectl 设置别名为k，永久生效。</h3><p>退出当前用户在进入就生效了。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>vi .bashrc
</span></span><span style=display:flex><span>alias k<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;kubectl&#39;</span>
</span></span><span style=display:flex><span>source ~/.bashrc
</span></span></code></pre></div><p>删除master节点上的污点，删除后pod可以调度到master上。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>kubectl taint nodes --all node-role.kubernetes.io/master-
</span></span></code></pre></div><h3 id=使用kubectl中的强制删除命令>使用kubectl中的强制删除命令</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>kubectl delete pod podName -n NAMESPACE --force --grace-period<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span></code></pre></div><h3 id=自动补全>自动补全</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>apt install bash-completion
</span></span><span style=display:flex><span>// locate bash_completion
</span></span><span style=display:flex><span>source /usr/share/bash-completion/bash_completion
</span></span><span style=display:flex><span>source &lt;<span style=color:#f92672>(</span>kubectl completion bash<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;source &lt;(kubectl completion bash)&#34;</span> &gt;&gt; ~/.bashrc
</span></span><span style=display:flex><span>source ~/.bashrc
</span></span></code></pre></div><p>查看所有pod</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>kubectl get po -owide  -A 
</span></span></code></pre></div><h2 id=部署kubernetes>部署kubernetes</h2><h3 id=1-安装-kubeadm-kubelet-和-kubectl>1. 安装 kubeadm, kubelet 和 kubectl</h3><p>操作节点： 所有的master和slave节点(<code>master,k8s-slave</code>) 需要执行</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>apt-get install kubelet<span style=color:#f92672>=</span>1.22.2-00 kubectl<span style=color:#f92672>=</span>1.22.2-00 kubeadm<span style=color:#f92672>=</span>1.22.2-00
</span></span><span style=display:flex><span><span style=color:#75715e>## 查看kubeadm 版本</span>
</span></span><span style=display:flex><span>kubeadm version
</span></span><span style=display:flex><span><span style=color:#75715e>## 设置kubelet开机启动</span>
</span></span><span style=display:flex><span>systemctl enable kubelet 
</span></span></code></pre></div><h3 id=2-初始化配置文件>2. 初始化配置文件</h3><p>操作节点： 只在master节点（<code>master</code>）执行</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>kubeadm config print init-defaults &gt; kubeadm.yaml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>apiVersion: kubeadm.k8s.io/v1beta3
</span></span><span style=display:flex><span>bootstrapTokens:
</span></span><span style=display:flex><span>- groups:
</span></span><span style=display:flex><span>  - system:bootstrappers:kubeadm:default-node-token
</span></span><span style=display:flex><span>  token: abcdef.0123456789abcdef
</span></span><span style=display:flex><span>  ttl: 24h0m0s
</span></span><span style=display:flex><span>  usages:
</span></span><span style=display:flex><span>  - signing
</span></span><span style=display:flex><span>  - authentication
</span></span><span style=display:flex><span>kind: InitConfigurationx
</span></span><span style=display:flex><span>localAPIEndpoint:
</span></span><span style=display:flex><span>  advertiseAddress: 10.4.7.60 <span style=color:#75715e>#修改为master 的IP</span>
</span></span><span style=display:flex><span>  bindPort: <span style=color:#ae81ff>6443</span>
</span></span><span style=display:flex><span>nodeRegistration:
</span></span><span style=display:flex><span>  criSocket: /var/run/dockershim.sock
</span></span><span style=display:flex><span>  name: node     <span style=color:#75715e># 删掉此行，删掉此行，删掉此行</span>
</span></span><span style=display:flex><span>  imagePullPolicy: IfNotPresent
</span></span><span style=display:flex><span>  taints: null
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>apiServer:
</span></span><span style=display:flex><span>  timeoutForControlPlane: 4m0s
</span></span><span style=display:flex><span>apiVersion: kubeadm.k8s.io/v1beta3
</span></span><span style=display:flex><span>certificatesDir: /etc/kubernetes/pki
</span></span><span style=display:flex><span>clusterName: kubernetes
</span></span><span style=display:flex><span>controllerManager: <span style=color:#f92672>{}</span>
</span></span><span style=display:flex><span>dns: <span style=color:#f92672>{}</span>
</span></span><span style=display:flex><span>etcd:
</span></span><span style=display:flex><span>  local:
</span></span><span style=display:flex><span>    dataDir: /var/lib/etcd
</span></span><span style=display:flex><span>imageRepository: registry.aliyuncs.com/google_containers
</span></span><span style=display:flex><span>kind: ClusterConfiguration
</span></span><span style=display:flex><span>kubernetesVersion: 1.22.2
</span></span><span style=display:flex><span>networking:
</span></span><span style=display:flex><span>  dnsDomain: cluster.local
</span></span><span style=display:flex><span>  podSubnet: 10.244.0.0/16   <span style=color:#75715e>#添加此行</span>
</span></span><span style=display:flex><span>  serviceSubnet: 10.96.0.0/12
</span></span><span style=display:flex><span>scheduler: <span style=color:#f92672>{}</span>
</span></span></code></pre></div><h3 id=3-提前下载镜像>3. 提前下载镜像</h3><p>操作节点：只在master节点（<code>master</code>）执行</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span><span style=color:#75715e># 提前下载镜像到本地</span>
</span></span><span style=display:flex><span>kubeadm config images pull --config kubeadm.yaml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>config/images<span style=color:#f92672>]</span> Pulled registry.aliyuncs.com/google_containers/kube-apiserver:v1.22.2
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>config/images<span style=color:#f92672>]</span> Pulled registry.aliyuncs.com/google_containers/kube-controller-manager:v1.22.2
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>config/images<span style=color:#f92672>]</span> Pulled registry.aliyuncs.com/google_containers/kube-scheduler:v1.22.2
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>config/images<span style=color:#f92672>]</span> Pulled registry.aliyuncs.com/google_containers/kube-proxy:v1.22.2
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>config/images<span style=color:#f92672>]</span> Pulled registry.aliyuncs.com/google_containers/pause:3.5
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>config/images<span style=color:#f92672>]</span> Pulled registry.aliyuncs.com/google_containers/etcd:3.5.0-0
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>config/images<span style=color:#f92672>]</span> Pulled registry.aliyuncs.com/google_containers/coredns:v1.8.4
</span></span></code></pre></div><h3 id=4-初始化master节点>4. 初始化master节点</h3><p>操作节点：只在master节点（<code>k8s-master</code>）执行</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>kubeadm init --config kubeadm.yaml
</span></span></code></pre></div><p>若初始化成功后，最后会提示如下信息：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>...
</span></span><span style=display:flex><span>To start using your cluster, you need to run the following as a regular user:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  mkdir -p $HOME/.kube
</span></span><span style=display:flex><span>  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
</span></span><span style=display:flex><span>  sudo chown <span style=color:#66d9ef>$(</span>id -u<span style=color:#66d9ef>)</span>:<span style=color:#66d9ef>$(</span>id -g<span style=color:#66d9ef>)</span> $HOME/.kube/config
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Alternatively, <span style=color:#66d9ef>if</span> you are the root user, you can run:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  export KUBECONFIG<span style=color:#f92672>=</span>/etc/kubernetes/admin.conf
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>You should now deploy a pod network to the cluster.
</span></span><span style=display:flex><span>Run <span style=color:#e6db74>&#34;kubectl apply -f [podnetwork].yaml&#34;</span> with one of the options listed at:
</span></span><span style=display:flex><span>  https://kubernetes.io/docs/concepts/cluster-administration/addons/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Then you can join any number of worker nodes by running the following on each as root:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubeadm join 10.4.7.60:6443 --token abcdef.0123456789abcdef <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        --discovery-token-ca-cert-hash sha256:3a7987c9f5007ebac7980e6614281ee0e064c760c8db012471f9f662289cc9ce
</span></span></code></pre></div><p>接下来按照上述提示信息操作，配置kubectl客户端的认证</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>mkdir -p $HOME/.kube
</span></span><span style=display:flex><span>sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
</span></span><span style=display:flex><span>sudo chown <span style=color:#66d9ef>$(</span>id -u<span style=color:#66d9ef>)</span>:<span style=color:#66d9ef>$(</span>id -g<span style=color:#66d9ef>)</span> $HOME/.kube/config
</span></span></code></pre></div><blockquote><p>**⚠️注意：**此时使用 kubectl get nodes查看节点应该处于notReady状态，因为还未配置网络插件</p><p>若执行初始化过程中出错，根据错误信息调整后，执行kubeadm reset后再次执行init操作即可</p></blockquote><h3 id=5-添加slave节点到集群中>5. 添加slave节点到集群中</h3><p>操作节点：所有的slave节点（<code>worker1</code>`worker2`）需要执行
在每台slave节点，执行如下命令，该命令是在kubeadm init成功后提示信息中打印出来的，需要替换成实际init后打印出的命令。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>kubeadm join 10.4.7.60:6443 --token abcdef.0123456789abcdef <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        --discovery-token-ca-cert-hash sha256:3a7987c9f5007ebac7980e6614281ee0e064c760c8db012471f9f662289cc9ce
</span></span></code></pre></div><h3 id=6-安装calico插件>6. 安装calico插件</h3><p>操作节点：只在master节点（<code>master</code>）执行</p><p><strong>方式一：直接安装</strong>（未使用！！！）</p><ul><li><p>下载资源文件</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>wget https://docs.projectcalico.org/manifests/calico-etcd.yaml
</span></span></code></pre></div></li><li><p>修改配置</p><ul><li><p>注释掉文件的前22行</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ae81ff>1</span> ---
</span></span><span style=display:flex><span>  <span style=color:#f92672>2 # Source</span>: <span style=color:#ae81ff>calico/templates/calico-etcd-secrets.yaml</span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>3</span> <span style=color:#75715e># The following contains k8s Secrets for use with a TLS enabled etcd cluster.</span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>4</span> <span style=color:#75715e># For information on populating Secrets, see http://kubernetes.io/docs/user-guide/secrets/</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>5 #apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>6 #kind</span>: <span style=color:#ae81ff>Secret</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>7 #type</span>: <span style=color:#ae81ff>Opaque</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>8 #metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>9 #  name</span>: <span style=color:#ae81ff>calico-etcd-secrets</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>10 #  namespace</span>: <span style=color:#ae81ff>kube-system</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>11 #data</span>:
</span></span><span style=display:flex><span> <span style=color:#ae81ff>12</span>   <span style=color:#75715e># Populate the following with etcd TLS configuration if desired, but leave blank if</span>
</span></span><span style=display:flex><span> <span style=color:#ae81ff>13</span>   <span style=color:#75715e># not using TLS for etcd.</span>
</span></span><span style=display:flex><span> <span style=color:#ae81ff>14</span>   <span style=color:#75715e># The keys below should be uncommented and the values populated with the base64</span>
</span></span><span style=display:flex><span> <span style=color:#ae81ff>15</span>   <span style=color:#75715e># encoded contents of each file that would be associated with the TLS data.</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>16   # Example command for encoding a file contents</span>: <span style=color:#ae81ff>cat &lt;file&gt; | base64 -w 0</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>17   # etcd-key</span>: <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>18   # etcd-cert</span>: <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>19   # etcd-ca</span>: <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span> <span style=color:#ae81ff>20</span> ---
</span></span><span style=display:flex><span> <span style=color:#f92672>21 # Source</span>: <span style=color:#ae81ff>calico/templates/calico-config.yaml</span>
</span></span><span style=display:flex><span> <span style=color:#ae81ff>22</span> <span style=color:#75715e># This ConfigMap is used to configure a self-hosted Calico installation.</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>23 kind</span>: <span style=color:#ae81ff>ConfigMap</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>24 apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>25 metadata</span>:
</span></span><span style=display:flex><span> <span style=color:#f92672>26   name</span>: <span style=color:#ae81ff>calico-config</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>27   namespace</span>: <span style=color:#ae81ff>kube-system</span>
</span></span><span style=display:flex><span> <span style=color:#ae81ff>...</span>
</span></span></code></pre></div></li><li><p>修改configmap</p><p>注意30-35行，其中etcd_endpoints换成环境的etcd地址</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span> <span style=color:#f92672>23 kind</span>: <span style=color:#ae81ff>ConfigMap</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>24 apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>25 metadata</span>:
</span></span><span style=display:flex><span> <span style=color:#f92672>26   name</span>: <span style=color:#ae81ff>calico-config</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>27   namespace</span>: <span style=color:#ae81ff>kube-system</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>28 data</span>:
</span></span><span style=display:flex><span> <span style=color:#ae81ff>29</span>   <span style=color:#75715e># Configure this with the location of your etcd cluster.</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>30   etcd_endpoints</span>: <span style=color:#e6db74>&#34;https://10.4.7.60:2379&#34;</span>
</span></span><span style=display:flex><span> <span style=color:#ae81ff>31</span>   <span style=color:#75715e># If you&#39;re using TLS enabled etcd uncomment the following.</span>
</span></span><span style=display:flex><span> <span style=color:#ae81ff>32</span>   <span style=color:#75715e># You must also populate the Secret below with these files.</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>33   etcd_ca</span>: <span style=color:#e6db74>&#34;/calico-secrets/etcd-ca&#34;</span>   <span style=color:#75715e># &#34;/calico-secrets/etcd-ca&#34;</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>34   etcd_cert</span>: <span style=color:#e6db74>&#34;/calico-secrets/etcd-cert&#34;</span> <span style=color:#75715e># &#34;/calico-secrets/etcd-cert&#34;</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>35   etcd_key</span>: <span style=color:#e6db74>&#34;/calico-secrets/etcd-key&#34;</span>  <span style=color:#75715e># &#34;/calico-secrets/etcd-key&#34;</span>
</span></span><span style=display:flex><span> <span style=color:#ae81ff>36</span>   <span style=color:#75715e># Typha is disabled.</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>37   typha_service_name</span>: <span style=color:#e6db74>&#34;none&#34;</span>
</span></span><span style=display:flex><span> <span style=color:#ae81ff>38</span>   <span style=color:#75715e># Configure the backend to use.</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>39   calico_backend</span>: <span style=color:#e6db74>&#34;bird&#34;</span>
</span></span></code></pre></div></li><li><p>添加calico-node环境变量</p><p>注意297-302行为新添加</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>285       containers</span>:
</span></span><span style=display:flex><span><span style=color:#ae81ff>286</span>         <span style=color:#75715e># Runs calico-node container on each Kubernetes node. This</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>287</span>         <span style=color:#75715e># container programs network policy and routes on each</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>288</span>         <span style=color:#75715e># host.</span>
</span></span><span style=display:flex><span><span style=color:#f92672>289         - name</span>: <span style=color:#ae81ff>calico-node</span>
</span></span><span style=display:flex><span><span style=color:#f92672>290           image</span>: <span style=color:#ae81ff>docker.io/calico/node:v3.20.0</span>
</span></span><span style=display:flex><span><span style=color:#f92672>291           envFrom</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>292           - configMapRef</span>:
</span></span><span style=display:flex><span><span style=color:#ae81ff>293</span>               <span style=color:#75715e># Allow KUBERNETES_SERVICE_HOST and KUBERNETES_SERVICE_PORT to be overridden for eBPF mode.</span>
</span></span><span style=display:flex><span><span style=color:#f92672>294               name</span>: <span style=color:#ae81ff>kubernetes-services-endpoint</span>
</span></span><span style=display:flex><span><span style=color:#f92672>295               optional</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span><span style=color:#f92672>296           env</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>297             - name</span>: <span style=color:#ae81ff>KUBERNETES_SERVICE_HOST</span>
</span></span><span style=display:flex><span><span style=color:#f92672>298               value</span>: <span style=color:#e6db74>&#34;10.4.7.60&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>299             - name</span>: <span style=color:#ae81ff>KUBERNETES_SERVICE_PORT</span>
</span></span><span style=display:flex><span><span style=color:#f92672>300               value</span>: <span style=color:#e6db74>&#34;6443&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>301             - name</span>: <span style=color:#ae81ff>KUBERNETES_SERVICE_PORT_HTTPS</span>
</span></span><span style=display:flex><span><span style=color:#f92672>302               value</span>: <span style=color:#e6db74>&#34;6443&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>303</span>             <span style=color:#75715e># The location of the etcd cluster.</span>
</span></span><span style=display:flex><span><span style=color:#f92672>304             - name</span>: <span style=color:#ae81ff>ETCD_ENDPOINTS</span>
</span></span><span style=display:flex><span><span style=color:#f92672>305               valueFrom</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>306                 configMapKeyRef</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>307                   name</span>: <span style=color:#ae81ff>calico-config</span>
</span></span><span style=display:flex><span><span style=color:#f92672>308                   key</span>: <span style=color:#ae81ff>etcd_endpoints</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>309</span>             <span style=color:#75715e># Location of the CA certificate for etcd.</span>
</span></span><span style=display:flex><span><span style=color:#f92672>310             - name</span>: <span style=color:#ae81ff>ETCD_CA_CERT_FILE</span>
</span></span></code></pre></div></li><li><p>修改CIDR</p><p>注意371-372行，value值为k8s集群初始化的pod-network-cidr</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ae81ff>370</span>             <span style=color:#75715e># no effect. This should fall within `--cluster-cidr`.</span>
</span></span><span style=display:flex><span><span style=color:#f92672>371             - name</span>: <span style=color:#ae81ff>CALICO_IPV4POOL_CIDR</span>
</span></span><span style=display:flex><span><span style=color:#f92672>372               value</span>: <span style=color:#e6db74>&#34;10.244.0.0/16&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>373</span>             <span style=color:#75715e># Disable file logging so `kubectl logs` works.</span>
</span></span><span style=display:flex><span><span style=color:#f92672>374             - name</span>: <span style=color:#ae81ff>CALICO_DISABLE_FILE_LOGGING</span>
</span></span><span style=display:flex><span><span style=color:#f92672>375               value</span>: <span style=color:#e6db74>&#34;true&#34;</span>
</span></span></code></pre></div><p>创建secret</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>kubectl -n kube-system create secret generic calico-etcd-secrets --from-file<span style=color:#f92672>=</span>etcd-ca<span style=color:#f92672>=</span>/etc/kubernetes/pki/etcd/ca.crt --from-file<span style=color:#f92672>=</span>etcd-cert<span style=color:#f92672>=</span>/etc/kubernetes/pki/etcd/healthcheck-client.crt --from-file<span style=color:#f92672>=</span>etcd-key<span style=color:#f92672>=</span>/etc/kubernetes/pki/etcd/healthcheck-client.key
</span></span></code></pre></div><p>创建calico资源清单</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>kubectl apply -f calico-etcd.yaml
</span></span></code></pre></div></li></ul></li></ul><p>​ 等待pod启动完成</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>kubectl -n kube-system get po 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME                                       READY   STATUS    RESTARTS   AGE
</span></span><span style=display:flex><span>calico-kube-controllers-59db5cf8fd-fpzdq   1/1     Running   <span style=color:#ae81ff>1</span>          32m
</span></span><span style=display:flex><span>calico-node-d2xq4                          1/1     Running   <span style=color:#ae81ff>1</span>          32m
</span></span><span style=display:flex><span>calico-node-ppzjk     
</span></span></code></pre></div><p>calico插件包：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>docker.io/calico/cni:v3.20.2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker.io/calico/pod2daemon-flexvol:v3.20.2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker.io/calico/node:v3.20.2
</span></span></code></pre></div><p><strong>方式二：使用operator安装</strong>(已成功！！！！！！)</p><ul><li><p>安装operator</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>kubectl create -f https://docs.projectcalico.org/manifests/tigera-operator.yaml
</span></span></code></pre></div></li><li><p>等待operator pod安装启动完成</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>kubectl -n tigera-operator get po
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME                               READY   STATUS    RESTARTS   AGE
</span></span><span style=display:flex><span>tigera-operator-698876cbb5-kfpb2   1/1     Running   <span style=color:#ae81ff>0</span>          38m
</span></span></code></pre></div><blockquote><p>镜像拉取比较慢，可以手动去节点docker pull拉取</p></blockquote></li><li><p>编辑calico配置</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>vim custom-resources.yaml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>apiVersion: operator.tigera.io/v1
</span></span><span style=display:flex><span>kind: Installation
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: default
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  <span style=color:#75715e># Configures Calico networking.</span>
</span></span><span style=display:flex><span>  calicoNetwork:
</span></span><span style=display:flex><span>    <span style=color:#75715e># Note: The ipPools section cannot be modified post-install.</span>
</span></span><span style=display:flex><span>    ipPools:
</span></span><span style=display:flex><span>    - blockSize: <span style=color:#ae81ff>26</span>
</span></span><span style=display:flex><span>      cidr: 10.244.0.0/16        <span style=color:#75715e>#修改和pod cidr一致</span>
</span></span><span style=display:flex><span>      encapsulation: VXLANCrossSubnet
</span></span><span style=display:flex><span>      natOutgoing: Enabled
</span></span><span style=display:flex><span>      nodeSelector: all<span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># This section configures the Calico API server.</span>
</span></span><span style=display:flex><span><span style=color:#75715e># For more information, see: https://docs.projectcalico.org/v3.20/reference/installation/api#operator.tigera.io/v1.APIServer</span>
</span></span><span style=display:flex><span>apiVersion: operator.tigera.io/v1
</span></span><span style=display:flex><span>kind: APIServer
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: default
</span></span><span style=display:flex><span>spec: <span style=color:#f92672>{}</span>
</span></span></code></pre></div></li><li><p>创建calico配置</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>kubectl apply -f custom-resources.yaml
</span></span></code></pre></div></li><li><p>等待operator自动创建calico的pod</p></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span><span style=color:#75715e># operator会自动创建calico-apiserver和calico-system两个命名空间以及必要的pod，等待pod启动完成即可</span>
</span></span><span style=display:flex><span>kubectl get ns
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME               STATUS   AGE
</span></span><span style=display:flex><span>calico-apiserver   Active   13m
</span></span><span style=display:flex><span>calico-system      Active   19m
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl -n calico-apiserver get po
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME                                READY   STATUS    RESTARTS   AGE
</span></span><span style=display:flex><span>calico-apiserver-554fbf9554-b6kzv   1/1     Running   <span style=color:#ae81ff>0</span>          13m
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl -n calico-system get po
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME                                       READY   STATUS    RESTARTS   AGE
</span></span><span style=display:flex><span>calico-kube-controllers-868b656ff4-hn6qv   1/1     Running   <span style=color:#ae81ff>0</span>          20m
</span></span><span style=display:flex><span>calico-node-qqrp9                          1/1     Running   <span style=color:#ae81ff>0</span>          20m
</span></span><span style=display:flex><span>calico-node-r45z2                          1/1     Running   <span style=color:#ae81ff>0</span>          20m
</span></span><span style=display:flex><span>calico-typha-5b64cf4b48-vws5j              1/1     Running   <span style=color:#ae81ff>0</span>          20m
</span></span><span style=display:flex><span>calico-typha-5b64cf4b48-w6wqf              1/1     Running   <span style=color:#ae81ff>0</span>          20m
</span></span></code></pre></div><h3 id=7-验证集群>7. 验证集群</h3><p>操作节点： 在master节点（<code>k8s-master</code>）执行</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>kubectl get nodes  <span style=color:#75715e>#观察集群节点是否全部Ready</span>
</span></span></code></pre></div><p>创建测试nginx服务</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>kubectl run  test-nginx --image<span style=color:#f92672>=</span>nginx:alpine
</span></span></code></pre></div><p>查看pod是否创建成功，并访问pod ip测试是否可用</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>kubectl get po -o wide
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME                          READY   STATUS    RESTARTS   AGE   IP           NODE         NOMINATED NODE   READINESS GATES
</span></span><span style=display:flex><span>test-nginx-5bd8859b98-5nnnw   1/1     Running   <span style=color:#ae81ff>0</span>          9s    10.244.1.2   k8s-slave1   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>curl 10.244.1.2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;
</span></span><span style=display:flex><span>&lt;p&gt;If you see this page, the nginx web server is successfully installed and
</span></span><span style=display:flex><span>working. Further configuration is required.&lt;/p&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&lt;p&gt;For online documentation and support please refer to
</span></span><span style=display:flex><span>&lt;a href<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;http://nginx.org/&#34;</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;
</span></span><span style=display:flex><span>Commercial support is available at
</span></span><span style=display:flex><span>&lt;a href<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;http://nginx.com/&#34;</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&lt;p&gt;&lt;em&gt;Thank you <span style=color:#66d9ef>for</span> using nginx.&lt;/em&gt;&lt;/p&gt;
</span></span><span style=display:flex><span>&lt;/body&gt;
</span></span><span style=display:flex><span>&lt;/html&gt;
</span></span></code></pre></div><h3 id=8-清理环境>8. 清理环境</h3><p>如果你的集群安装过程中遇到了其他问题，我们可以使用下面的命令来进行重置：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span><span style=color:#75715e># 在全部集群节点执行</span>
</span></span><span style=display:flex><span>kubeadm reset
</span></span><span style=display:flex><span>ifconfig cni0 down <span style=color:#f92672>&amp;&amp;</span> ip link delete cni0
</span></span><span style=display:flex><span>ifconfig flannel.1 down <span style=color:#f92672>&amp;&amp;</span> ip link delete flannel.1
</span></span><span style=display:flex><span>rm -rf /run/flannel/subnet.env
</span></span><span style=display:flex><span>rm -rf /var/lib/cni/
</span></span><span style=display:flex><span>mv /etc/kubernetes/ /tmp
</span></span><span style=display:flex><span>mv /var/lib/etcd /tmp
</span></span><span style=display:flex><span>mv ~/.kube /tmp
</span></span><span style=display:flex><span>iptables -F
</span></span><span style=display:flex><span>iptables -t nat -F
</span></span><span style=display:flex><span>ipvsadm -C
</span></span><span style=display:flex><span>ip link del kube-ipvs0
</span></span><span style=display:flex><span>ip link del dummy0
</span></span></code></pre></div><p>设置apt源报错。换源</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>apt-get update <span style=color:#f92672>&amp;&amp;</span> apt-get install -y apt-transport-https ca-certificates software-properties-common 
</span></span><span style=display:flex><span>curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | apt-key add - 
</span></span><span style=display:flex><span>curl -fsSL http://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | apt-key add -
</span></span><span style=display:flex><span>add-apt-repository <span style=color:#e6db74>&#34;deb [arch=amd64] http://mirrors.aliyun.com/docker-ce/linux/ubuntu </span><span style=color:#66d9ef>$(</span>lsb_release -cs<span style=color:#66d9ef>)</span><span style=color:#e6db74> stable&#34;</span>
</span></span><span style=display:flex><span>add-apt-repository <span style=color:#e6db74>&#34;deb [arch=amd64] https://mirrors.aliyun.com/kubernetes/apt kubernetes-xenial main&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>apt-get update   
</span></span><span style=display:flex><span><span style=color:#75715e>#若上步出现NO_PUBLICKEY问题，参考https://www.cnblogs.com/jiangzuo/p/13667011.html</span>
</span></span></code></pre></div><p>未安装cni插件pod状态</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span> coredns-7f6cbbb7b8-c778v pod 不能启动因为未安装cni插件。 
</span></span><span style=display:flex><span>  events:
</span></span><span style=display:flex><span>  Warning  FailedScheduling  43s <span style=color:#f92672>(</span>x2 over 2m13s<span style=color:#f92672>)</span>  default-scheduler  0/3 nodes are available: <span style=color:#ae81ff>3</span> node<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span> had taint <span style=color:#f92672>{</span>node.kubernetes.io/not-ready: <span style=color:#f92672>}</span>, that the pod didn<span style=color:#960050;background-color:#1e0010>&#39;</span>t tolerate.
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  root@master:~# k get po -A -owide 
</span></span><span style=display:flex><span>NAMESPACE     NAME                             READY   STATUS    RESTARTS   AGE     IP          NODE      NOMINATED NODE   READINESS GATES
</span></span><span style=display:flex><span>kube-system   coredns-7f6cbbb7b8-c778v         0/1     Pending   <span style=color:#ae81ff>0</span>          3m54s   &lt;none&gt;      &lt;none&gt;    &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>kube-system   coredns-7f6cbbb7b8-px7cm         0/1     Pending   <span style=color:#ae81ff>0</span>          3m54s   &lt;none&gt;      &lt;none&gt;    &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>kube-system   etcd-master                      1/1     Running   <span style=color:#ae81ff>0</span>          4m7s    10.4.7.70   master    &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>kube-system   kube-apiserver-master            1/1     Running   <span style=color:#ae81ff>0</span>          4m7s    10.4.7.70   master    &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>kube-system   kube-controller-manager-master   1/1     Running   <span style=color:#ae81ff>0</span>          4m7s    10.4.7.70   master    &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>kube-system   kube-proxy-5w6c4                 1/1     Running   <span style=color:#ae81ff>0</span>          3m23s   10.4.7.71   worker1   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>kube-system   kube-proxy-6jnkr                 1/1     Running   <span style=color:#ae81ff>0</span>          3m20s   10.4.7.72   worker2   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>kube-system   kube-proxy-hcwtz                 1/1     Running   <span style=color:#ae81ff>0</span>          3m54s   10.4.7.70   master    &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>kube-system   kube-scheduler-master            1/1     Running   <span style=color:#ae81ff>0</span>          4m8s    10.4.7.70   master    &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2022-01-02</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=http://example.org/posts/k8s%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/ data-title=k8s集群搭建><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=http://example.org/posts/k8s%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=http://example.org/posts/k8s%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/ data-title=k8s集群搭建><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=http://example.org/posts/k8s%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/ data-title=k8s集群搭建><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=http://example.org/posts/k8s%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/ data-title=k8s集群搭建><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/ubuntu%E7%B3%BB%E7%BB%9F%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E/ class=prev rel=prev title=ubuntu系统使用说明><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>ubuntu系统使用说明</a>
<a href=/posts/nginx%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8/ class=next rel=next title=nginx安装与使用>nginx安装与使用<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.115.3">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank></a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>