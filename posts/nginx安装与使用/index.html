<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>nginx安装与使用 - My New Hugo Site</title><meta name=Description content="This is my cool site"><meta property="og:title" content="nginx安装与使用"><meta property="og:description" content="nginx 1.16.1 安装使用说明 1.创建目录
mkdir -p /var/temp/nginx
下载：
https://nginx.org/en/download.html
解压
tar -zxvf nginx-1.16.1.tar.gz
安装编译依赖包：
yum install -y gcc gcc-c++ pcre pcre-devel zlib zlib-devel openssl openssl-devel
2.进入nginx-1.16.1
编译参数
./configure \ --prefix=/usr/local/nginx \ --pid-path=/var/run/nginx/nginx.pid \ --lock-path=/var/lock/nginx.lock \ --error-log-path=/var/log/nginx/error.log \ --http-log-path=/var/log/nginx/access.log \ --with-http_gzip_static_module \ --http-client-body-temp-path=/var/temp/nginx/client \ --http-proxy-temp-path=/var/temp/nginx/proxy \ --http-fastcgi-temp-path=/var/temp/nginx/fastcgi \ --http-uwsgi-temp-path=/var/temp/nginx/uwsgi \ --http-scgi-temp-path=/var/temp/nginx/scgi https://nginx.org/en/download.html
config 编译参数 nginx1.16编译安装configure参数： [root@363ee3055cf0 nginx-1.16.1]# ./configure --help --help print this message 打印帮助信息 --prefix=PATH set installation prefix 设置安装目录 --sbin-path=PATH set nginx binary pathname 设置sbin路径 --modules-path=PATH set modules path 设置模块路径 --conf-path=PATH set nginx."><meta property="og:type" content="article"><meta property="og:url" content="http://example.org/posts/nginx%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-01-02T21:32:47+00:00"><meta property="article:modified_time" content="2022-01-02T21:32:47+00:00"><meta property="og:site_name" content="My cool site"><meta name=twitter:card content="summary"><meta name=twitter:title content="nginx安装与使用"><meta name=twitter:description content="nginx 1.16.1 安装使用说明 1.创建目录
mkdir -p /var/temp/nginx
下载：
https://nginx.org/en/download.html
解压
tar -zxvf nginx-1.16.1.tar.gz
安装编译依赖包：
yum install -y gcc gcc-c++ pcre pcre-devel zlib zlib-devel openssl openssl-devel
2.进入nginx-1.16.1
编译参数
./configure \ --prefix=/usr/local/nginx \ --pid-path=/var/run/nginx/nginx.pid \ --lock-path=/var/lock/nginx.lock \ --error-log-path=/var/log/nginx/error.log \ --http-log-path=/var/log/nginx/access.log \ --with-http_gzip_static_module \ --http-client-body-temp-path=/var/temp/nginx/client \ --http-proxy-temp-path=/var/temp/nginx/proxy \ --http-fastcgi-temp-path=/var/temp/nginx/fastcgi \ --http-uwsgi-temp-path=/var/temp/nginx/uwsgi \ --http-scgi-temp-path=/var/temp/nginx/scgi https://nginx.org/en/download.html
config 编译参数 nginx1.16编译安装configure参数： [root@363ee3055cf0 nginx-1.16.1]# ./configure --help --help print this message 打印帮助信息 --prefix=PATH set installation prefix 设置安装目录 --sbin-path=PATH set nginx binary pathname 设置sbin路径 --modules-path=PATH set modules path 设置模块路径 --conf-path=PATH set nginx."><meta name=application-name content="My cool site"><meta name=apple-mobile-web-app-title content="My cool site"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=http://example.org/posts/nginx%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8/><link rel=prev href=http://example.org/posts/k8s%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/><link rel=next href=http://example.org/posts/mysql%E4%B8%BB%E4%BB%8E%E6%9E%B6%E6%9E%84/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"nginx安装与使用","inLanguage":"en-us","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/example.org\/posts\/nginx%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8\/"},"genre":"posts","wordcount":2902,"url":"http:\/\/example.org\/posts\/nginx%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8\/","datePublished":"2022-01-02T21:32:47+00:00","dateModified":"2022-01-02T21:32:47+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Author"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="My New Hugo Site">My cool site</a></div><div class=menu><div class=menu-inner><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="My New Hugo Site">My cool site</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">nginx安装与使用</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Author</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2022-01-02>2022-01-02</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;2902 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;14 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#nginx-1161-安装使用说明>nginx 1.16.1 安装使用说明</a><ul><li><a href=#config-编译参数>config 编译参数</a></li></ul></li><li><a href=#nginx-的进程模型>nginx 的进程模型</a><ul><li><a href=#nginx事件处理异步非阻塞>nginx事件处理。异步非阻塞。</a></li></ul></li><li><a href=#配置文件详解>配置文件详解：</a></li><li><a href=#常见pid报错>常见pid报错</a><ul><li><a href=#nginxpid打开失败>nginx.pid打开失败：</a></li></ul></li><li><a href=#日志切割手动>日志切割：(手动)</a></li><li><a href=#日志切割定时>日志切割：(定时)</a></li><li><a href=#虚拟主机-使用nginx为静态资源提供服务>虚拟主机-使用nginx为静态资源提供服务</a></li><li><a href=#gzip压缩提升请求效率>gzip压缩提升请求效率</a></li><li><a href=#location匹配规则>location匹配规则</a></li><li><a href=#dns解析域名>DNS解析域名</a></li><li><a href=#用switchhosts-模拟本地域名解析访问>用switchhosts 模拟本地域名解析访问</a></li><li><a href=#跨域访问>跨域访问</a></li><li><a href=#nginx-防盗链技术支持>nginx 防盗链技术支持</a></li><li><a href=#nginx-模块化体系>nginx 模块化体系</a></li><li><a href=#负载均衡>负载均衡</a><ul><li><a href=#四层负载均衡>四层负载均衡</a></li><li><a href=#七层负载均衡>七层负载均衡</a></li><li><a href=#dns-地域负载均衡>DNS 地域负载均衡</a></li></ul></li><li><a href=#使用nginx搭建三台tomcat集群>使用Nginx搭建三台tomcat集群</a></li><li><a href=#负载均衡之轮询>负载均衡之轮询</a></li><li><a href=#负载均衡之权重-加权轮询>负载均衡之权重-加权轮询</a></li><li><a href=#upstream-指令参数>upstream 指令参数</a></li><li><a href=#使用keepalive提高吞吐量>使用keepalive提高吞吐量</a></li><li><a href=#负载均衡之ip_hash>负载均衡之ip_hash</a><ul><li><a href=#负载均衡之url_hash>负载均衡之<strong>url_hash</strong></a></li></ul></li><li><a href=#nginx控制浏览器缓存>nginx控制浏览器缓存</a></li><li><a href=#上游服务静态内容缓存>上游服务静态内容缓存</a></li><li><a href=#使用nginx-配置https域名证书>使用nginx 配置https域名证书</a></li><li><a href=#配置ssl>配置ssl</a></li><li><a href=#动静分离>动静分离</a></li><li><a href=#nginx高可用ha-keepalived-双机主备>nginx高可用HA keepalived 双机主备</a></li><li><a href=#安装keepalived>安装keepalived</a><ul><li><a href=#核心配置文件>核心配置文件：</a></li><li><a href=#keepalived配置nginx自动启动>keepalived配置Nginx自动启动</a></li></ul></li></ul></nav></div></div><div class=content id=content><h2 id=nginx-1161-安装使用说明>nginx 1.16.1 安装使用说明</h2><p>1.创建目录</p><p>mkdir -p /var/temp/nginx</p><p>下载：</p><p><a href=https://nginx.org/en/download.html target=_blank rel="noopener noreffer">https://nginx.org/en/download.html</a></p><p>解压</p><p>tar -zxvf nginx-1.16.1.tar.gz</p><p>安装编译依赖包：</p><p>yum install -y gcc gcc-c++ pcre pcre-devel zlib zlib-devel openssl openssl-devel</p><p>2.进入nginx-1.16.1</p><p>编译参数</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>./configure <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--prefix<span style=color:#f92672>=</span>/usr/local/nginx <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--pid-path<span style=color:#f92672>=</span>/var/run/nginx/nginx.pid <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--lock-path<span style=color:#f92672>=</span>/var/lock/nginx.lock <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--error-log-path<span style=color:#f92672>=</span>/var/log/nginx/error.log <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--http-log-path<span style=color:#f92672>=</span>/var/log/nginx/access.log <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--with-http_gzip_static_module <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--http-client-body-temp-path<span style=color:#f92672>=</span>/var/temp/nginx/client <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--http-proxy-temp-path<span style=color:#f92672>=</span>/var/temp/nginx/proxy <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--http-fastcgi-temp-path<span style=color:#f92672>=</span>/var/temp/nginx/fastcgi <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--http-uwsgi-temp-path<span style=color:#f92672>=</span>/var/temp/nginx/uwsgi <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--http-scgi-temp-path<span style=color:#f92672>=</span>/var/temp/nginx/scgi
</span></span></code></pre></div><p><a href=https://nginx.org/en/download.html target=_blank rel="noopener noreffer">https://nginx.org/en/download.html</a></p><h3 id=config-编译参数>config 编译参数</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>nginx1.16编译安装configure参数：
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@363ee3055cf0 nginx-1.16.1<span style=color:#f92672>]</span><span style=color:#75715e># ./configure --help</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  --help                             print this message 打印帮助信息
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  --prefix<span style=color:#f92672>=</span>PATH                      set installation prefix 设置安装目录
</span></span><span style=display:flex><span>  --sbin-path<span style=color:#f92672>=</span>PATH                   set nginx binary pathname 设置sbin路径
</span></span><span style=display:flex><span>  --modules-path<span style=color:#f92672>=</span>PATH                set modules path 设置模块路径
</span></span><span style=display:flex><span>  --conf-path<span style=color:#f92672>=</span>PATH                   set nginx.conf pathname 设置配置文件路径
</span></span><span style=display:flex><span>  --error-log-path<span style=color:#f92672>=</span>PATH              set error log pathname 设置错误日志的路径
</span></span><span style=display:flex><span>  --pid-path<span style=color:#f92672>=</span>PATH                    set nginx.pid pathname 设置pid路径
</span></span><span style=display:flex><span>  --lock-path<span style=color:#f92672>=</span>PATH                   set nginx.lock pathname 设置锁路径
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  --user<span style=color:#f92672>=</span>USER                        set non-privileged user <span style=color:#66d9ef>for</span> 设置用户
</span></span><span style=display:flex><span>                                     worker processes
</span></span><span style=display:flex><span>  --group<span style=color:#f92672>=</span>GROUP                      set non-privileged group <span style=color:#66d9ef>for</span> 设置组
</span></span><span style=display:flex><span>                                     worker processes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  --build<span style=color:#f92672>=</span>NAME                       set build name 设置构建名
</span></span><span style=display:flex><span>  --builddir<span style=color:#f92672>=</span>DIR                     set build directory 设置构建文件夹
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  --with-select_module               enable <span style=color:#66d9ef>select</span> module 开启select模块
</span></span><span style=display:flex><span>  --without-select_module            disable <span style=color:#66d9ef>select</span> module关闭
</span></span><span style=display:flex><span>  --with-poll_module                 enable poll module
</span></span><span style=display:flex><span>  --without-poll_module              disable poll module
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  --with-threads                     enable thread pool support
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  --with-file-aio                    enable file AIO support
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  --with-http_ssl_module             enable ngx_http_ssl_module
</span></span><span style=display:flex><span>  --with-http_v2_module              enable ngx_http_v2_module
</span></span><span style=display:flex><span>  --with-http_realip_module          enable ngx_http_realip_module
</span></span><span style=display:flex><span>  --with-http_addition_module        enable ngx_http_addition_module
</span></span><span style=display:flex><span>  --with-http_xslt_module            enable ngx_http_xslt_module
</span></span><span style=display:flex><span>  --with-http_xslt_module<span style=color:#f92672>=</span>dynamic    enable dynamic ngx_http_xslt_module
</span></span><span style=display:flex><span>  --with-http_image_filter_module    enable ngx_http_image_filter_module
</span></span><span style=display:flex><span>  --with-http_image_filter_module<span style=color:#f92672>=</span>dynamic
</span></span><span style=display:flex><span>                                     enable dynamic ngx_http_image_filter_module
</span></span><span style=display:flex><span>  --with-http_geoip_module           enable ngx_http_geoip_module
</span></span><span style=display:flex><span>  --with-http_geoip_module<span style=color:#f92672>=</span>dynamic   enable dynamic ngx_http_geoip_module
</span></span><span style=display:flex><span>  --with-http_sub_module             enable ngx_http_sub_module
</span></span><span style=display:flex><span>  --with-http_dav_module             enable ngx_http_dav_module
</span></span><span style=display:flex><span>  --with-http_flv_module             enable ngx_http_flv_module
</span></span><span style=display:flex><span>  --with-http_mp4_module             enable ngx_http_mp4_module
</span></span><span style=display:flex><span>  --with-http_gunzip_module          enable ngx_http_gunzip_module
</span></span><span style=display:flex><span>  --with-http_gzip_static_module     enable ngx_http_gzip_static_module
</span></span><span style=display:flex><span>  --with-http_auth_request_module    enable ngx_http_auth_request_module
</span></span><span style=display:flex><span>  --with-http_random_index_module    enable ngx_http_random_index_module
</span></span><span style=display:flex><span>  --with-http_secure_link_module     enable ngx_http_secure_link_module
</span></span><span style=display:flex><span>  --with-http_degradation_module     enable ngx_http_degradation_module
</span></span><span style=display:flex><span>  --with-http_slice_module           enable ngx_http_slice_module
</span></span><span style=display:flex><span>  --with-http_stub_status_module     enable ngx_http_stub_status_module
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  --without-http_charset_module      disable ngx_http_charset_module
</span></span><span style=display:flex><span>  --without-http_gzip_module         disable ngx_http_gzip_module
</span></span><span style=display:flex><span>  --without-http_ssi_module          disable ngx_http_ssi_module
</span></span><span style=display:flex><span>  --without-http_userid_module       disable ngx_http_userid_module
</span></span><span style=display:flex><span>  --without-http_access_module       disable ngx_http_access_module
</span></span><span style=display:flex><span>  --without-http_auth_basic_module   disable ngx_http_auth_basic_module
</span></span><span style=display:flex><span>  --without-http_mirror_module       disable ngx_http_mirror_module
</span></span><span style=display:flex><span>  --without-http_autoindex_module    disable ngx_http_autoindex_module
</span></span><span style=display:flex><span>  --without-http_geo_module          disable ngx_http_geo_module
</span></span><span style=display:flex><span>  --without-http_map_module          disable ngx_http_map_module
</span></span><span style=display:flex><span>  --without-http_split_clients_module disable ngx_http_split_clients_module
</span></span><span style=display:flex><span>  --without-http_referer_module      disable ngx_http_referer_module
</span></span><span style=display:flex><span>  --without-http_rewrite_module      disable ngx_http_rewrite_module
</span></span><span style=display:flex><span>  --without-http_proxy_module        disable ngx_http_proxy_module
</span></span><span style=display:flex><span>  --without-http_fastcgi_module      disable ngx_http_fastcgi_module
</span></span><span style=display:flex><span>  --without-http_uwsgi_module        disable ngx_http_uwsgi_module
</span></span><span style=display:flex><span>  --without-http_scgi_module         disable ngx_http_scgi_module
</span></span><span style=display:flex><span>  --without-http_grpc_module         disable ngx_http_grpc_module
</span></span><span style=display:flex><span>  --without-http_memcached_module    disable ngx_http_memcached_module
</span></span><span style=display:flex><span>  --without-http_limit_conn_module   disable ngx_http_limit_conn_module
</span></span><span style=display:flex><span>  --without-http_limit_req_module    disable ngx_http_limit_req_module
</span></span><span style=display:flex><span>  --without-http_empty_gif_module    disable ngx_http_empty_gif_module
</span></span><span style=display:flex><span>  --without-http_browser_module      disable ngx_http_browser_module
</span></span><span style=display:flex><span>  --without-http_upstream_hash_module
</span></span><span style=display:flex><span>                                     disable ngx_http_upstream_hash_module
</span></span><span style=display:flex><span>  --without-http_upstream_ip_hash_module
</span></span><span style=display:flex><span>                                     disable ngx_http_upstream_ip_hash_module
</span></span><span style=display:flex><span>  --without-http_upstream_least_conn_module
</span></span><span style=display:flex><span>                                     disable ngx_http_upstream_least_conn_module
</span></span><span style=display:flex><span>  --without-http_upstream_random_module
</span></span><span style=display:flex><span>                                     disable ngx_http_upstream_random_module
</span></span><span style=display:flex><span>  --without-http_upstream_keepalive_module
</span></span><span style=display:flex><span>                                     disable ngx_http_upstream_keepalive_module
</span></span><span style=display:flex><span>  --without-http_upstream_zone_module
</span></span><span style=display:flex><span>                                     disable ngx_http_upstream_zone_module
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  --with-http_perl_module            enable ngx_http_perl_module
</span></span><span style=display:flex><span>  --with-http_perl_module<span style=color:#f92672>=</span>dynamic    enable dynamic ngx_http_perl_module
</span></span><span style=display:flex><span>  --with-perl_modules_path<span style=color:#f92672>=</span>PATH      set Perl modules path
</span></span><span style=display:flex><span>  --with-perl<span style=color:#f92672>=</span>PATH                   set perl binary pathname
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  --http-log-path<span style=color:#f92672>=</span>PATH               set http access log pathname
</span></span><span style=display:flex><span>  --http-client-body-temp-path<span style=color:#f92672>=</span>PATH  set path to store
</span></span><span style=display:flex><span>                                     http client request body temporary files
</span></span><span style=display:flex><span>  --http-proxy-temp-path<span style=color:#f92672>=</span>PATH        set path to store
</span></span><span style=display:flex><span>                                     http proxy temporary files
</span></span><span style=display:flex><span>  --http-fastcgi-temp-path<span style=color:#f92672>=</span>PATH      set path to store
</span></span><span style=display:flex><span>                                     http fastcgi temporary files
</span></span><span style=display:flex><span>  --http-uwsgi-temp-path<span style=color:#f92672>=</span>PATH        set path to store
</span></span><span style=display:flex><span>                                     http uwsgi temporary files
</span></span><span style=display:flex><span>  --http-scgi-temp-path<span style=color:#f92672>=</span>PATH         set path to store
</span></span><span style=display:flex><span>                                     http scgi temporary files
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  --without-http                     disable HTTP server
</span></span><span style=display:flex><span>  --without-http-cache               disable HTTP cache
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  --with-mail                        enable POP3/IMAP4/SMTP proxy module
</span></span><span style=display:flex><span>  --with-mail<span style=color:#f92672>=</span>dynamic                enable dynamic POP3/IMAP4/SMTP proxy module
</span></span><span style=display:flex><span>  --with-mail_ssl_module             enable ngx_mail_ssl_module
</span></span><span style=display:flex><span>  --without-mail_pop3_module         disable ngx_mail_pop3_module
</span></span><span style=display:flex><span>  --without-mail_imap_module         disable ngx_mail_imap_module
</span></span><span style=display:flex><span>  --without-mail_smtp_module         disable ngx_mail_smtp_module
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  --with-stream                      enable TCP/UDP proxy module
</span></span><span style=display:flex><span>  --with-stream<span style=color:#f92672>=</span>dynamic              enable dynamic TCP/UDP proxy module
</span></span><span style=display:flex><span>  --with-stream_ssl_module           enable ngx_stream_ssl_module
</span></span><span style=display:flex><span>  --with-stream_realip_module        enable ngx_stream_realip_module
</span></span><span style=display:flex><span>  --with-stream_geoip_module         enable ngx_stream_geoip_module
</span></span><span style=display:flex><span>  --with-stream_geoip_module<span style=color:#f92672>=</span>dynamic enable dynamic ngx_stream_geoip_module
</span></span><span style=display:flex><span>  --with-stream_ssl_preread_module   enable ngx_stream_ssl_preread_module
</span></span><span style=display:flex><span>  --without-stream_limit_conn_module disable ngx_stream_limit_conn_module
</span></span><span style=display:flex><span>  --without-stream_access_module     disable ngx_stream_access_module
</span></span><span style=display:flex><span>  --without-stream_geo_module        disable ngx_stream_geo_module
</span></span><span style=display:flex><span>  --without-stream_map_module        disable ngx_stream_map_module
</span></span><span style=display:flex><span>  --without-stream_split_clients_module
</span></span><span style=display:flex><span>                                     disable ngx_stream_split_clients_module
</span></span><span style=display:flex><span>  --without-stream_return_module     disable ngx_stream_return_module
</span></span><span style=display:flex><span>  --without-stream_upstream_hash_module
</span></span><span style=display:flex><span>                                     disable ngx_stream_upstream_hash_module
</span></span><span style=display:flex><span>  --without-stream_upstream_least_conn_module
</span></span><span style=display:flex><span>                                     disable ngx_stream_upstream_least_conn_module
</span></span><span style=display:flex><span>  --without-stream_upstream_random_module
</span></span><span style=display:flex><span>                                     disable ngx_stream_upstream_random_module
</span></span><span style=display:flex><span>  --without-stream_upstream_zone_module
</span></span><span style=display:flex><span>                                     disable ngx_stream_upstream_zone_module
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  --with-google_perftools_module     enable ngx_google_perftools_module
</span></span><span style=display:flex><span>  --with-cpp_test_module             enable ngx_cpp_test_module
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  --add-module<span style=color:#f92672>=</span>PATH                  enable external module
</span></span><span style=display:flex><span>  --add-dynamic-module<span style=color:#f92672>=</span>PATH          enable dynamic external module
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  --with-compat                      dynamic modules compatibility
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  --with-cc<span style=color:#f92672>=</span>PATH                     set C compiler pathname
</span></span><span style=display:flex><span>  --with-cpp<span style=color:#f92672>=</span>PATH                    set C preprocessor pathname
</span></span><span style=display:flex><span>  --with-cc-opt<span style=color:#f92672>=</span>OPTIONS              set additional C compiler options
</span></span><span style=display:flex><span>  --with-ld-opt<span style=color:#f92672>=</span>OPTIONS              set additional linker options
</span></span><span style=display:flex><span>  --with-cpu-opt<span style=color:#f92672>=</span>CPU                 build <span style=color:#66d9ef>for</span> the specified CPU, valid values:
</span></span><span style=display:flex><span>                                     pentium, pentiumpro, pentium3, pentium4,
</span></span><span style=display:flex><span>                                     athlon, opteron, sparc32, sparc64, ppc64
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  --without-pcre                     disable PCRE library usage
</span></span><span style=display:flex><span>  --with-pcre                        force PCRE library usage
</span></span><span style=display:flex><span>  --with-pcre<span style=color:#f92672>=</span>DIR                    set path to PCRE library sources
</span></span><span style=display:flex><span>  --with-pcre-opt<span style=color:#f92672>=</span>OPTIONS            set additional build options <span style=color:#66d9ef>for</span> PCRE
</span></span><span style=display:flex><span>  --with-pcre-jit                    build PCRE with JIT compilation support
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  --with-zlib<span style=color:#f92672>=</span>DIR                    set path to zlib library sources
</span></span><span style=display:flex><span>  --with-zlib-opt<span style=color:#f92672>=</span>OPTIONS            set additional build options <span style=color:#66d9ef>for</span> zlib
</span></span><span style=display:flex><span>  --with-zlib-asm<span style=color:#f92672>=</span>CPU                use zlib assembler sources optimized
</span></span><span style=display:flex><span>                                     <span style=color:#66d9ef>for</span> the specified CPU, valid values:
</span></span><span style=display:flex><span>                                     pentium, pentiumpro
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  --with-libatomic                   force libatomic_ops library usage
</span></span><span style=display:flex><span>  --with-libatomic<span style=color:#f92672>=</span>DIR               set path to libatomic_ops library sources
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  --with-openssl<span style=color:#f92672>=</span>DIR                 set path to OpenSSL library sources
</span></span><span style=display:flex><span>  --with-openssl-opt<span style=color:#f92672>=</span>OPTIONS         set additional build options <span style=color:#66d9ef>for</span> OpenSSL
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  --with-debug                       enable debug logging
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span><span style=color:#75715e>#编译</span>
</span></span><span style=display:flex><span>make
</span></span><span style=display:flex><span><span style=color:#75715e>#安装</span>
</span></span><span style=display:flex><span>make install 
</span></span></code></pre></div><p>whereis nginx</p><p>在/usr/local/nginx/sbin/内</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>./nginx 启动
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> ./nginx -s stop 强制停止
</span></span><span style=display:flex><span> ./nginx -s quit 优雅停止
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>./nginx -s reload 重新加载
</span></span><span style=display:flex><span>./nginx -t 配置检测
</span></span><span style=display:flex><span>./nginx -v 版本信息
</span></span><span style=display:flex><span>./nginx -V 详细信息
</span></span><span style=display:flex><span>./nginx -h 帮助
</span></span><span style=display:flex><span>./nginx -c 指定配置文件
</span></span></code></pre></div><p>注意：</p><p>1.云服务器需要默认开启nginx 80</p><p>2.虚拟机安装，需要关闭防火墙</p><p>3.本机win或mac需要关闭防火墙</p><p>nginx.conf</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>    <span style=color:#a6e22e>server</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>listen</span>       <span style=color:#ae81ff>80</span>; 						<span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>监听端口</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>server_name</span>  <span style=color:#a6e22e>localhost</span>;					<span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>域名</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>location</span> <span style=color:#f92672>/</span> {							<span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#f92672>/</span> <span style=color:#a6e22e>从根开始匹配</span><span style=color:#960050;background-color:#1e0010>。</span><span style=color:#a6e22e>html文件夹内的index</span> <span style=color:#a6e22e>index</span>.<span style=color:#a6e22e>html</span> <span style=color:#a6e22e>index</span>.<span style=color:#a6e22e>htm</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>root</span>   <span style=color:#a6e22e>html</span>;
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>index</span>  <span style=color:#a6e22e>index</span>.<span style=color:#a6e22e>html</span> <span style=color:#a6e22e>index</span>.<span style=color:#a6e22e>htm</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>error_page</span>   <span style=color:#ae81ff>500</span> <span style=color:#ae81ff>502</span> <span style=color:#ae81ff>503</span> <span style=color:#ae81ff>504</span>  <span style=color:#f92672>/</span><span style=color:#ae81ff>50</span><span style=color:#a6e22e>x</span>.<span style=color:#a6e22e>html</span>;   <span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>匹配不到自动转到错误页</span><span style=color:#960050;background-color:#1e0010>。</span><span style=color:#a6e22e>html</span><span style=color:#f92672>/</span><span style=color:#ae81ff>50</span><span style=color:#a6e22e>x</span>.<span style=color:#a6e22e>html</span> 
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>location</span> <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>/50x.html {</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>root</span>   <span style=color:#a6e22e>html</span>;
</span></span><span style=display:flex><span>        }
</span></span></code></pre></div><p>更改 80 端口后需重新加载。</p><p>cd /usr/local/nginx/sbin</p><p>./nginx -s reload</p><p>访问：ip+监听端口</p><h2 id=nginx-的进程模型>nginx 的进程模型</h2><p>master 主进程</p><p>worker 工作进程</p><p>worker_processes 2; # 默认为1,配置为n-1 .n为cpu数量。</p><h3 id=nginx事件处理异步非阻塞>nginx事件处理。异步非阻塞。</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>events</span> {
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#a6e22e>默认使用epoll</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>use</span> <span style=color:#a6e22e>epoll</span>;
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#a6e22e>每个worker</span> <span style=color:#a6e22e>允许连接的客户端最大连接数</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>worker_connections</span>  <span style=color:#ae81ff>10240</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=配置文件详解>配置文件详解：</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>    <span style=color:#a6e22e>server</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>listen</span>       <span style=color:#ae81ff>89</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>server_name</span>  <span style=color:#a6e22e>localhost</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>location</span> <span style=color:#f92672>/</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>root</span>   <span style=color:#a6e22e>html</span>;
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>index</span>  <span style=color:#a6e22e>imooc</span>.<span style=color:#a6e22e>html</span> <span style=color:#a6e22e>index</span>.<span style=color:#a6e22e>htm</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        }
</span></span></code></pre></div><p>/usr/local/nginx/html/imooc.html</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span><span style=color:#75715e>&lt;!DOCTYPE html&gt;</span>
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>html</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>head</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>title</span>&gt;Welcome to immoc!&lt;/<span style=color:#f92672>title</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>style</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#f92672>body</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>width</span>: <span style=color:#ae81ff>35</span><span style=color:#66d9ef>em</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>margin</span>: <span style=color:#ae81ff>0</span> <span style=color:#66d9ef>auto</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>font-family</span>: Tahoma, Verdana, Arial, <span style=color:#66d9ef>sans-serif</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>style</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>head</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>body</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>h1</span>&gt;Welcome imooc!&lt;/<span style=color:#f92672>h1</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>body</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>html</span>&gt;
</span></span></code></pre></div><p>或者：</p><p>nginx.conf中添加</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>  include       imooc.conf;
</span></span></code></pre></div><p>创建imooc.conf文件。</p><p>/usr/local/nginx/conf/imooc.conf</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>   <span style=color:#a6e22e>server</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>listen</span>       <span style=color:#ae81ff>89</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>server_name</span>  <span style=color:#a6e22e>localhost</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>location</span> <span style=color:#f92672>/</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>root</span>   <span style=color:#a6e22e>html</span>;
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>index</span>  <span style=color:#a6e22e>imooc</span>.<span style=color:#a6e22e>html</span> <span style=color:#a6e22e>index</span>.<span style=color:#a6e22e>htm</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        }
</span></span></code></pre></div><p>每次更改后都要重启服务。</p><h2 id=常见pid报错>常见pid报错</h2><h3 id=nginxpid打开失败>nginx.pid打开失败：</h3><p>1.nginx: [error] invalid PID number "" in &ldquo;/usr/local/nginx/logs/nginx.pid&rdquo;</p><p>解决方法：</p><p>使用nginx -c的参数指定nginx.conf文件的位置
然后再重新启动，解决问题，可以通过ps -ef|grep nginx 看到服务已经启动成功。</p><p>/usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/nginx.conf</p><p>2.nginx: [error] open() &ldquo;/var/run/nginx/nginx.pid&rdquo; failed (2: No such file or directory)</p><p>提示信息说明在 <strong>/var/run/nginx/</strong> 目录下找不到 <strong>nginx.pid</strong> 文件，解决方式有两种</p><p>第一种方式：创建默认目录 <strong>/var/run/nginx/</strong> ；</p><p>第二种方式：修改 <strong>nginx.conf</strong> 文件，指定 <strong>pid文件</strong> 所在目录。</p><h2 id=日志切割手动>日志切割：(手动)</h2><p>cat_my_log.sh</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>LOG_PATH<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/var/log/nginx/&#34;</span>
</span></span><span style=display:flex><span>RECORD_TIME<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>date -d <span style=color:#e6db74>&#34;yesterday&#34;</span> +%Y-%m-%d+%H:%M<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>PID<span style=color:#f92672>=</span>/var/run/nginx/nginx.pid
</span></span><span style=display:flex><span>mv <span style=color:#e6db74>${</span>LOG_PATH<span style=color:#e6db74>}</span>/access.log <span style=color:#e6db74>${</span>LOG_PATH<span style=color:#e6db74>}</span>/access.<span style=color:#e6db74>${</span>RECORD_TIME<span style=color:#e6db74>}</span>.log
</span></span><span style=display:flex><span>mv <span style=color:#e6db74>${</span>LOG_PATH<span style=color:#e6db74>}</span>/error.log <span style=color:#e6db74>${</span>LOG_PATH<span style=color:#e6db74>}</span>/error.<span style=color:#e6db74>${</span>RECORD_TIME<span style=color:#e6db74>}</span>.log
</span></span><span style=display:flex><span><span style=color:#75715e>#向nginx主进程发送信号，用于重新打开日志文件</span>
</span></span><span style=display:flex><span>kill -USR1 <span style=color:#e6db74>`</span>cat $PID<span style=color:#e6db74>`</span>
</span></span></code></pre></div><p>chmod +x cat_my_log.sh</p><h2 id=日志切割定时>日志切割：(定时)</h2><p>1.安装定时任务</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>yum install crontabs
</span></span></code></pre></div><p>2.crontab -e 编辑并添加一行新的任务</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>*/1 * * * * /usr/local/nginx/sbin/cut_my_log.sh
</span></span></code></pre></div><p>3.重启定时任务</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>service crond restart 
</span></span></code></pre></div><p>4.常用定时任务</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>service crond start 
</span></span><span style=display:flex><span>service crond stop 
</span></span><span style=display:flex><span>service crond reload <span style=color:#75715e>#重新加载</span>
</span></span><span style=display:flex><span>service crond restart  <span style=color:#75715e>#重启服务</span>
</span></span><span style=display:flex><span>crontab -l <span style=color:#75715e>#查看任务列表</span>
</span></span><span style=display:flex><span>crontab -e <span style=color:#75715e># 编辑任务</span>
</span></span></code></pre></div><p>每分钟执行</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>*/1 * * * *
</span></span></code></pre></div><p>每日凌晨（每天晚上23：59）执行：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span><span style=color:#ae81ff>59</span> <span style=color:#ae81ff>23</span> * * *
</span></span></code></pre></div><p>每日凌晨1点执行：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span><span style=color:#ae81ff>0</span> <span style=color:#ae81ff>1</span> * * *
</span></span></code></pre></div><p>每天为数据库定时备份：<a href=https://www.cnblogs.com/leechenxiang/p/7110382.html target=_blank rel="noopener noreffer">参考</a></p><h2 id=虚拟主机-使用nginx为静态资源提供服务>虚拟主机-使用nginx为静态资源提供服务</h2><p>静态资源可以是mp4、png、jpg等等。</p><p>/usr/local/nginx/conf/imooc.conf中创建静态资源路径。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>    <span style=color:#a6e22e>server</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>listen</span>       <span style=color:#ae81ff>90</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>server_name</span>  <span style=color:#a6e22e>localhost</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>location</span> <span style=color:#f92672>/</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>root</span>   <span style=color:#f92672>/</span><span style=color:#a6e22e>home</span><span style=color:#f92672>/</span><span style=color:#a6e22e>foodie</span><span style=color:#f92672>-</span><span style=color:#a6e22e>shop</span>;
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>index</span>  <span style=color:#a6e22e>index</span>.<span style=color:#a6e22e>html</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>location</span> <span style=color:#f92672>/</span><span style=color:#66d9ef>static</span> {
</span></span><span style=display:flex><span>	    <span style=color:#a6e22e>alias</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>home</span><span style=color:#f92672>/</span><span style=color:#a6e22e>imooc</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>location</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>imooc</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>root</span>   <span style=color:#f92672>/</span><span style=color:#a6e22e>home</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        }
</span></span></code></pre></div><p>请求/home/imooc下的资源。</p><p>两种写法：</p><p>一、正常请求：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>        <span style=color:#a6e22e>location</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>imooc</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>root</span>   <span style=color:#f92672>/</span><span style=color:#a6e22e>home</span>;
</span></span><span style=display:flex><span>        }
</span></span></code></pre></div><p>直接请求：</p><p>http://10.4.7.129:90/imooc/456.jpg</p><p>二、给路径起别名：</p><p>将/home/imooc创建别名 为/static</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>        <span style=color:#a6e22e>location</span> <span style=color:#f92672>/</span><span style=color:#66d9ef>static</span> {
</span></span><span style=display:flex><span>	    <span style=color:#a6e22e>alias</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>home</span><span style=color:#f92672>/</span><span style=color:#a6e22e>imooc</span>;
</span></span><span style=display:flex><span>        }
</span></span></code></pre></div><p>请求时用别名请求</p><p>http://10.4.7.129:90/static/456.jpg</p><p>将imooc.conf文件内容应用到nginx.conf中</p><p>编辑/usr/local/nginx/conf/nginx.conf</p><p>单独添加一行：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>    include       imooc.conf;
</span></span></code></pre></div><p>检测配置是否正确：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>/usr/local/nginx/sbin/nginx -t 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>nginx: the configuration file /usr/local/nginx/conf/nginx.conf syntax is ok
</span></span><span style=display:flex><span>nginx: configuration file /usr/local/nginx/conf/nginx.conf test is successful
</span></span></code></pre></div><p>重启nginx</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>/usr/local/nginx/sbin/nginx -s reload 
</span></span></code></pre></div><p>测试结果：</p><p>http://10.4.7.129:90/imooc/456.jpg</p><p>http://10.4.7.129:90/static/456.jpg</p><h2 id=gzip压缩提升请求效率>gzip压缩提升请求效率</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span><span style=color:#75715e>#开启gzip压缩功能，目的：提高传输效率，节约带宽</span>
</span></span><span style=display:flex><span>gzip  on;
</span></span><span style=display:flex><span><span style=color:#75715e>#限制最小压缩，小于1字节的文件不会压缩</span>
</span></span><span style=display:flex><span>gzip_min_length 1;
</span></span><span style=display:flex><span><span style=color:#75715e>#的定义压缩的级别（压缩比，文件越大，压缩越多，但是cpu使用会越多） </span>
</span></span><span style=display:flex><span>gzip_comp_level 3;
</span></span><span style=display:flex><span><span style=color:#75715e>#定义压缩文件类型</span>
</span></span><span style=display:flex><span>gzip_types text/plain application/javascript application/x-javascript test/css application/xml text/javascript application/x-httpd/php image/jpeg image/gif image/png application/json;
</span></span></code></pre></div><h2 id=location匹配规则>location匹配规则</h2><p>空格：默认匹配，普通匹配</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>    <span style=color:#a6e22e>server</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>listen</span>       <span style=color:#ae81ff>91</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>server_name</span>  <span style=color:#a6e22e>localhost</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>location</span>  <span style=color:#f92672>/</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>root</span>   <span style=color:#a6e22e>html</span>;
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>index</span>  <span style=color:#a6e22e>imooc</span>.<span style=color:#a6e22e>html</span> <span style=color:#a6e22e>index</span>.<span style=color:#a6e22e>htm</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        }
</span></span></code></pre></div><p>= ：精确匹配</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>    <span style=color:#a6e22e>server</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>listen</span>       <span style=color:#ae81ff>91</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>server_name</span>  <span style=color:#a6e22e>localhost</span>;
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>精确匹配</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>location</span> <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>/ {</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>root</span>   <span style=color:#a6e22e>html</span>;
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>index</span>  <span style=color:#a6e22e>imooc</span>.<span style=color:#a6e22e>html</span> <span style=color:#a6e22e>index</span>.<span style=color:#a6e22e>htm</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        }
</span></span></code></pre></div><p>正则表达式。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>/home/imooc/img
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 img<span style=color:#f92672>]</span><span style=color:#75715e># ll</span>
</span></span><span style=display:flex><span>total <span style=color:#ae81ff>808</span>
</span></span><span style=display:flex><span>-rw-r--r--. <span style=color:#ae81ff>1</span> root root  <span style=color:#ae81ff>25125</span> Jun <span style=color:#ae81ff>30</span> 19:40 456.jpg
</span></span><span style=display:flex><span>-rw-r--r--. <span style=color:#ae81ff>1</span> root root  <span style=color:#ae81ff>25125</span> Dec <span style=color:#ae81ff>19</span> 00:12 456.JPG
</span></span><span style=display:flex><span>-rw-r--r--. <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>383222</span> Dec <span style=color:#ae81ff>13</span> 19:25 AutoPlayOptIn.gif
</span></span><span style=display:flex><span>-rw-r--r--. <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>383222</span> Dec <span style=color:#ae81ff>19</span> 00:17 AutoPlayOptIn.GIF
</span></span></code></pre></div><p>~* ：匹配正则表达式，*代表不区分大小写</p><p>http://10.4.7.129:92/imooc/img/456.JGP (可以访问)不论是否定义了.JPG这种类型都能访问。</p><p>~ ：匹配正则表达式，区分大小写</p><p>http://10.4.7.129:92/imooc/img/456.JGP (不能访问)因为没有定义.JPG这种类型能访问。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>    <span style=color:#a6e22e>server</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>listen</span>       <span style=color:#ae81ff>92</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>server_name</span>  <span style=color:#a6e22e>localhost</span>;
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>正则表达式</span><span style=color:#960050;background-color:#1e0010>。</span><span style=color:#f92672>*</span><span style=color:#a6e22e>代表不区分大小写</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>location</span> <span style=color:#f92672>~*</span> <span style=color:#960050;background-color:#1e0010>\</span>.(<span style=color:#a6e22e>GIF</span><span style=color:#f92672>|</span><span style=color:#a6e22e>png</span><span style=color:#f92672>|</span><span style=color:#a6e22e>bmp</span><span style=color:#f92672>|</span><span style=color:#a6e22e>jpg</span><span style=color:#f92672>|</span><span style=color:#a6e22e>jpeg</span>) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>root</span>   <span style=color:#f92672>/</span><span style=color:#a6e22e>home</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>server</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>listen</span>       <span style=color:#ae81ff>92</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>server_name</span>  <span style=color:#a6e22e>localhost</span>;
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>正则表达式</span><span style=color:#960050;background-color:#1e0010>。</span><span style=color:#f92672>*</span><span style=color:#a6e22e>代表不区分大小写</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>location</span> <span style=color:#f92672>~</span> <span style=color:#960050;background-color:#1e0010>\</span>.(<span style=color:#a6e22e>GIF</span><span style=color:#f92672>|</span><span style=color:#a6e22e>png</span><span style=color:#f92672>|</span><span style=color:#a6e22e>bmp</span><span style=color:#f92672>|</span><span style=color:#a6e22e>jpg</span><span style=color:#f92672>|</span><span style=color:#a6e22e>jpeg</span>) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>root</span>   <span style=color:#f92672>/</span><span style=color:#a6e22e>home</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        }
</span></span></code></pre></div><p>^~ 以某个字符路径开头请求</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>    <span style=color:#a6e22e>server</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>listen</span>       <span style=color:#ae81ff>93</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>server_name</span>  <span style=color:#a6e22e>localhost</span>;
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>#</span><span style=color:#f92672>^~</span> <span style=color:#a6e22e>以某个字符路径开头请求</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>location</span> <span style=color:#f92672>^~</span> <span style=color:#e6db74>/imooc/img</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>root</span>   <span style=color:#f92672>/</span><span style=color:#a6e22e>home</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        }
</span></span></code></pre></div><h2 id=dns解析域名>DNS解析域名</h2><p>user-> client(<a href=https://www.imooc.com target=_blank rel="noopener noreffer">www.imooc.com</a>) -> nginx(代理服务器192.168.1.88 小区大门) &mdash;> tomcat1 （目标服务器 内网） ##号楼##室</p><p>​ &mdash;> tomcat2 （目标服务器 内网）##号楼##室</p><h2 id=用switchhosts-模拟本地域名解析访问>用switchhosts 模拟本地域名解析访问</h2><p><a href=https://cloud.tencent.com/developer/article/1408956 target=_blank rel="noopener noreffer">https://cloud.tencent.com/developer/article/1408956</a></p><p><a href="https://links.jianshu.com/go?to=https%3A%2F%2Fgithub.com%2Foldj%2FSwitchHosts%2Freleases%2Fdownload%2Fv3.3.12%2FSwitchHosts-win32-ia32_v3.3.12.5349.zip" target=_blank rel="noopener noreffer">https://links.jianshu.com/go?to=https%3A%2F%2Fgithub.com%2Foldj%2FSwitchHosts%2Freleases%2Fdownload%2Fv3.3.12%2FSwitchHosts-win32-ia32_v3.3.12.5349.zip</a></p><p>自定义hosts 一键切换。不用更改本机hosts</p><p>定义nginx-dev-imooc 的hosts</p><p>添加映射：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>10.4.7.129 www.imooc.com
</span></span></code></pre></div><p>访问：</p><p><a href=https://www.imooc.com target=_blank rel="noopener noreffer">www.imooc.com</a> 显示10.4.7.129 默认界面</p><h2 id=跨域访问>跨域访问</h2><p><img class=lazyload src=/svg/loading.min.svg data-src=/img/postimages/nginx%e8%b7%a8%e5%9f%9f.webp data-srcset="/img/postimages/nginx%e8%b7%a8%e5%9f%9f.webp, /img/postimages/nginx%e8%b7%a8%e5%9f%9f.webp 1.5x, /img/postimages/nginx%e8%b7%a8%e5%9f%9f.webp 2x" data-sizes=auto alt=/img/postimages/nginx跨域.webp title=nginx跨域></p><p><img class=lazyload src=/svg/loading.min.svg data-src=/img/postimages/nginx%e8%b7%a8%e5%9f%9f%e8%ae%bf%e9%97%aesuccess.webp data-srcset="/img/postimages/nginx%e8%b7%a8%e5%9f%9f%e8%ae%bf%e9%97%aesuccess.webp, /img/postimages/nginx%e8%b7%a8%e5%9f%9f%e8%ae%bf%e9%97%aesuccess.webp 1.5x, /img/postimages/nginx%e8%b7%a8%e5%9f%9f%e8%ae%bf%e9%97%aesuccess.webp 2x" data-sizes=auto alt=/img/postimages/nginx跨域访问success.webp title=nginx跨域访问success></p><p><img class=lazyload src=/svg/loading.min.svg data-src=/img/postimages/cors%e8%b7%a8%e5%9f%9f%e8%b5%84%e6%ba%90%e5%85%b1%e4%ba%ab.webp data-srcset="/img/postimages/cors%e8%b7%a8%e5%9f%9f%e8%b5%84%e6%ba%90%e5%85%b1%e4%ba%ab.webp, /img/postimages/cors%e8%b7%a8%e5%9f%9f%e8%b5%84%e6%ba%90%e5%85%b1%e4%ba%ab.webp 1.5x, /img/postimages/cors%e8%b7%a8%e5%9f%9f%e8%b5%84%e6%ba%90%e5%85%b1%e4%ba%ab.webp 2x" data-sizes=auto alt=/img/postimages/cors跨域资源共享.webp title=cors跨域资源共享></p><p>当出现403跨域错误的时候 <code>No 'Access-Control-Allow-Origin' header is present on the requested resource</code>，需要给Nginx服务器配置响应的header参数：</p><p>只需要在Nginx的配置文件中配置以下参数：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>location</span> <span style=color:#f92672>/</span> { 
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>允许跨域请求的域</span><span style=color:#960050;background-color:#1e0010>，</span><span style=color:#f92672>*</span><span style=color:#a6e22e>代表所有</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>add_header</span> <span style=color:#e6db74>&#39;Access-Control-Allow-Origin&#39;</span> <span style=color:#f92672>*</span>;
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>允许请求的方法</span><span style=color:#960050;background-color:#1e0010>，</span><span style=color:#a6e22e>比如GET</span>, <span style=color:#a6e22e>POST</span>, <span style=color:#a6e22e>DELETE</span><span style=color:#960050;background-color:#1e0010>，</span><span style=color:#a6e22e>PUT</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>add_header</span> <span style=color:#e6db74>&#39;Access-Control-Allow-Methods&#39;</span> <span style=color:#f92672>*</span>;
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>允许带上cookie请求</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>add_header</span> <span style=color:#e6db74>&#39;Access-Control-Allow-Credentails&#39;</span> <span style=color:#e6db74>&#39;true&#39;</span>;
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>允许请求的HEADER</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>add_header</span> <span style=color:#e6db74>&#39;Access-Control-Allow-Headers&#39;</span> <span style=color:#f92672>*</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>$request_method</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;OPTIONS&#39;</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>204</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>} 
</span></span></code></pre></div><h2 id=nginx-防盗链技术支持>nginx 防盗链技术支持</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>对源站点验证</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>valid_referers</span> <span style=color:#f92672>*</span>.<span style=color:#a6e22e>imooc</span>.<span style=color:#a6e22e>com</span>;
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>非法引入会进入下方判断</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>$invalid_referer</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>404</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=nginx-模块化体系>nginx 模块化体系</h2><p><img class=lazyload src=/svg/loading.min.svg data-src=/img/postimages/nginx%e6%a8%a1%e5%9d%97%e5%8c%96%e4%bd%93%e7%b3%bb.webp data-srcset="/img/postimages/nginx%e6%a8%a1%e5%9d%97%e5%8c%96%e4%bd%93%e7%b3%bb.webp, /img/postimages/nginx%e6%a8%a1%e5%9d%97%e5%8c%96%e4%bd%93%e7%b3%bb.webp 1.5x, /img/postimages/nginx%e6%a8%a1%e5%9d%97%e5%8c%96%e4%bd%93%e7%b3%bb.webp 2x" data-sizes=auto alt=/img/postimages/nginx模块化体系.webp title=nginx模块化体系></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 nginx-1.16.1<span style=color:#f92672>]</span><span style=color:#75715e># ll</span>
</span></span><span style=display:flex><span>total <span style=color:#ae81ff>756</span>
</span></span><span style=display:flex><span>drwxr-xr-x. <span style=color:#ae81ff>6</span> <span style=color:#ae81ff>1001</span> <span style=color:#ae81ff>1001</span>   <span style=color:#ae81ff>4096</span> Dec <span style=color:#ae81ff>17</span> 04:04 auto       <span style=color:#75715e>#一些判断操作系统支持，编译等相关的文件</span>
</span></span><span style=display:flex><span>-rw-r--r--. <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1001</span> <span style=color:#ae81ff>1001</span> <span style=color:#ae81ff>296463</span> Aug <span style=color:#ae81ff>13</span>  <span style=color:#ae81ff>2019</span> CHANGES    <span style=color:#75715e>#版本的更改日志</span>
</span></span><span style=display:flex><span>-rw-r--r--. <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1001</span> <span style=color:#ae81ff>1001</span> <span style=color:#ae81ff>452171</span> Aug <span style=color:#ae81ff>13</span>  <span style=color:#ae81ff>2019</span> CHANGES.ru <span style=color:#75715e>#俄版版本的更改日志</span>
</span></span><span style=display:flex><span>drwxr-xr-x. <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>1001</span> <span style=color:#ae81ff>1001</span>    <span style=color:#ae81ff>168</span> Dec <span style=color:#ae81ff>17</span> 04:04 conf      <span style=color:#75715e>#配置文件夹</span>
</span></span><span style=display:flex><span>-rwxr-xr-x. <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1001</span> <span style=color:#ae81ff>1001</span>   <span style=color:#ae81ff>2502</span> Aug <span style=color:#ae81ff>13</span>  <span style=color:#ae81ff>2019</span> configure <span style=color:#75715e>#编译配置程序</span>
</span></span><span style=display:flex><span>drwxr-xr-x. <span style=color:#ae81ff>4</span> <span style=color:#ae81ff>1001</span> <span style=color:#ae81ff>1001</span>     <span style=color:#ae81ff>72</span> Dec <span style=color:#ae81ff>17</span> 04:04 contrib   <span style=color:#75715e>#提供了语法高亮支持脚本，让vim打开时，语法高亮。需要拷贝contrib														中到 本地vim目录(如果根目录没有该目录，先mkdir ~/.vim)</span>
</span></span><span style=display:flex><span>drwxr-xr-x. <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>1001</span> <span style=color:#ae81ff>1001</span>     <span style=color:#ae81ff>40</span> Dec <span style=color:#ae81ff>17</span> 04:04 html      <span style=color:#75715e>#默认页面</span>
</span></span><span style=display:flex><span>-rw-r--r--. <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1001</span> <span style=color:#ae81ff>1001</span>   <span style=color:#ae81ff>1397</span> Aug <span style=color:#ae81ff>13</span>  <span style=color:#ae81ff>2019</span> LICENSE   <span style=color:#75715e>#许可证书</span>
</span></span><span style=display:flex><span>-rw-r--r--. <span style=color:#ae81ff>1</span> root root    <span style=color:#ae81ff>355</span> Dec <span style=color:#ae81ff>17</span> 04:19 Makefile  <span style=color:#75715e>#编译后的文件</span>
</span></span><span style=display:flex><span>drwxr-xr-x. <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>1001</span> <span style=color:#ae81ff>1001</span>     <span style=color:#ae81ff>21</span> Dec <span style=color:#ae81ff>17</span> 04:04 man       <span style=color:#75715e>#使用手册</span>
</span></span><span style=display:flex><span>drwxr-xr-x. <span style=color:#ae81ff>3</span> root root    <span style=color:#ae81ff>174</span> Dec <span style=color:#ae81ff>17</span> 04:20 objs      <span style=color:#75715e>#第三方插件</span>
</span></span><span style=display:flex><span>-rw-r--r--. <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1001</span> <span style=color:#ae81ff>1001</span>     <span style=color:#ae81ff>49</span> Aug <span style=color:#ae81ff>13</span>  <span style=color:#ae81ff>2019</span> README
</span></span><span style=display:flex><span>drwxr-xr-x. <span style=color:#ae81ff>9</span> <span style=color:#ae81ff>1001</span> <span style=color:#ae81ff>1001</span>     <span style=color:#ae81ff>91</span> Dec <span style=color:#ae81ff>17</span> 04:04 src      <span style=color:#75715e>#源码</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>cd conf
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 conf<span style=color:#f92672>]</span><span style=color:#75715e># ll</span>
</span></span><span style=display:flex><span>total <span style=color:#ae81ff>40</span>
</span></span><span style=display:flex><span>-rw-r--r--. <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1001</span> <span style=color:#ae81ff>1001</span> <span style=color:#ae81ff>1077</span> Aug <span style=color:#ae81ff>13</span>  <span style=color:#ae81ff>2019</span> fastcgi.conf
</span></span><span style=display:flex><span>-rw-r--r--. <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1001</span> <span style=color:#ae81ff>1001</span> <span style=color:#ae81ff>1007</span> Aug <span style=color:#ae81ff>13</span>  <span style=color:#ae81ff>2019</span> fastcgi_params
</span></span><span style=display:flex><span>-rw-r--r--. <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1001</span> <span style=color:#ae81ff>1001</span> <span style=color:#ae81ff>2837</span> Aug <span style=color:#ae81ff>13</span>  <span style=color:#ae81ff>2019</span> koi-utf
</span></span><span style=display:flex><span>-rw-r--r--. <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1001</span> <span style=color:#ae81ff>1001</span> <span style=color:#ae81ff>2223</span> Aug <span style=color:#ae81ff>13</span>  <span style=color:#ae81ff>2019</span> koi-win
</span></span><span style=display:flex><span>-rw-r--r--. <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1001</span> <span style=color:#ae81ff>1001</span> <span style=color:#ae81ff>5231</span> Aug <span style=color:#ae81ff>13</span>  <span style=color:#ae81ff>2019</span> mime.types
</span></span><span style=display:flex><span>-rw-r--r--. <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1001</span> <span style=color:#ae81ff>1001</span> <span style=color:#ae81ff>2656</span> Aug <span style=color:#ae81ff>13</span>  <span style=color:#ae81ff>2019</span> nginx.conf <span style=color:#75715e># 核心配置文件</span>
</span></span><span style=display:flex><span>-rw-r--r--. <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1001</span> <span style=color:#ae81ff>1001</span>  <span style=color:#ae81ff>636</span> Aug <span style=color:#ae81ff>13</span>  <span style=color:#ae81ff>2019</span> scgi_params
</span></span><span style=display:flex><span>-rw-r--r--. <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1001</span> <span style=color:#ae81ff>1001</span>  <span style=color:#ae81ff>664</span> Aug <span style=color:#ae81ff>13</span>  <span style=color:#ae81ff>2019</span> uwsgi_params
</span></span><span style=display:flex><span>-rw-r--r--. <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1001</span> <span style=color:#ae81ff>1001</span> <span style=color:#ae81ff>3610</span> Aug <span style=color:#ae81ff>13</span>  <span style=color:#ae81ff>2019</span> win-utf
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 html<span style=color:#f92672>]</span><span style=color:#75715e># ll</span>
</span></span><span style=display:flex><span>total <span style=color:#ae81ff>8</span>
</span></span><span style=display:flex><span>-rw-r--r--. <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1001</span> <span style=color:#ae81ff>1001</span> <span style=color:#ae81ff>494</span> Aug <span style=color:#ae81ff>13</span>  <span style=color:#ae81ff>2019</span> 50x.html
</span></span><span style=display:flex><span>-rw-r--r--. <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1001</span> <span style=color:#ae81ff>1001</span> <span style=color:#ae81ff>612</span> Aug <span style=color:#ae81ff>13</span>  <span style=color:#ae81ff>2019</span> index.html
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 objs<span style=color:#f92672>]</span><span style=color:#75715e># ll</span>
</span></span><span style=display:flex><span>total <span style=color:#ae81ff>3888</span>
</span></span><span style=display:flex><span>-rw-r--r--. <span style=color:#ae81ff>1</span> root root   <span style=color:#ae81ff>17763</span> Dec <span style=color:#ae81ff>17</span> 04:19 autoconf.err
</span></span><span style=display:flex><span>-rw-r--r--. <span style=color:#ae81ff>1</span> root root   <span style=color:#ae81ff>40485</span> Dec <span style=color:#ae81ff>17</span> 04:19 Makefile
</span></span><span style=display:flex><span>-rwxr-xr-x. <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>3857136</span> Dec <span style=color:#ae81ff>17</span> 04:20 nginx
</span></span><span style=display:flex><span>-rw-r--r--. <span style=color:#ae81ff>1</span> root root    <span style=color:#ae81ff>5327</span> Dec <span style=color:#ae81ff>17</span> 04:20 nginx.8
</span></span><span style=display:flex><span>-rw-r--r--. <span style=color:#ae81ff>1</span> root root    <span style=color:#ae81ff>7363</span> Dec <span style=color:#ae81ff>17</span> 04:19 ngx_auto_config.h
</span></span><span style=display:flex><span>-rw-r--r--. <span style=color:#ae81ff>1</span> root root     <span style=color:#ae81ff>657</span> Dec <span style=color:#ae81ff>17</span> 04:19 ngx_auto_headers.h
</span></span><span style=display:flex><span>-rw-r--r--. <span style=color:#ae81ff>1</span> root root    <span style=color:#ae81ff>5975</span> Dec <span style=color:#ae81ff>17</span> 04:19 ngx_modules.c
</span></span><span style=display:flex><span>-rw-r--r--. <span style=color:#ae81ff>1</span> root root   <span style=color:#ae81ff>32552</span> Dec <span style=color:#ae81ff>17</span> 04:20 ngx_modules.o
</span></span><span style=display:flex><span>drwxr-xr-x. <span style=color:#ae81ff>9</span> root root      <span style=color:#ae81ff>91</span> Dec <span style=color:#ae81ff>17</span> 04:19 src
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 src<span style=color:#f92672>]</span><span style=color:#75715e># ll</span>
</span></span><span style=display:flex><span>total <span style=color:#ae81ff>20</span>
</span></span><span style=display:flex><span>drwxr-xr-x. <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>1001</span> <span style=color:#ae81ff>1001</span> <span style=color:#ae81ff>4096</span> Dec <span style=color:#ae81ff>17</span> 04:04 core   <span style=color:#75715e>#核心源码</span>
</span></span><span style=display:flex><span>drwxr-xr-x. <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>1001</span> <span style=color:#ae81ff>1001</span> <span style=color:#ae81ff>4096</span> Dec <span style=color:#ae81ff>17</span> 04:04 event  <span style=color:#75715e>#事件</span>
</span></span><span style=display:flex><span>drwxr-xr-x. <span style=color:#ae81ff>4</span> <span style=color:#ae81ff>1001</span> <span style=color:#ae81ff>1001</span> <span style=color:#ae81ff>4096</span> Dec <span style=color:#ae81ff>17</span> 04:04 http
</span></span><span style=display:flex><span>drwxr-xr-x. <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>1001</span> <span style=color:#ae81ff>1001</span> <span style=color:#ae81ff>4096</span> Dec <span style=color:#ae81ff>17</span> 04:04 mail
</span></span><span style=display:flex><span>drwxr-xr-x. <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>1001</span> <span style=color:#ae81ff>1001</span>   <span style=color:#ae81ff>74</span> Dec <span style=color:#ae81ff>17</span> 04:04 misc   <span style=color:#75715e>#辅助代码</span>
</span></span><span style=display:flex><span>drwxr-xr-x. <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>1001</span> <span style=color:#ae81ff>1001</span>   <span style=color:#ae81ff>18</span> Dec <span style=color:#ae81ff>17</span> 04:04 os     <span style=color:#75715e>#系统</span>
</span></span><span style=display:flex><span>drwxr-xr-x. <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>1001</span> <span style=color:#ae81ff>1001</span> <span style=color:#ae81ff>4096</span> Aug <span style=color:#ae81ff>13</span>  <span style=color:#ae81ff>2019</span> stream 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 http<span style=color:#f92672>]</span><span style=color:#75715e># ls</span>
</span></span><span style=display:flex><span>modules                        ngx_http_file_cache.c              ngx_http_request.h               ngx_http_upstream_round_robin.h
</span></span><span style=display:flex><span>ngx_http.c                     ngx_http.h                         ngx_http_script.c                ngx_http_variables.c
</span></span><span style=display:flex><span>ngx_http_cache.h               ngx_http_header_filter_module.c    ngx_http_script.h                ngx_http_variables.h
</span></span><span style=display:flex><span>ngx_http_config.h              ngx_http_parse.c                   ngx_http_special_response.c      ngx_http_write_filter_module.c
</span></span><span style=display:flex><span>ngx_http_copy_filter_module.c  ngx_http_postpone_filter_module.c  ngx_http_upstream.c              v2
</span></span><span style=display:flex><span>ngx_http_core_module.c         ngx_http_request_body.c            ngx_http_upstream.h
</span></span><span style=display:flex><span>ngx_http_core_module.h         ngx_http_request.c                 ngx_http_upstream_round_robin.c
</span></span></code></pre></div><h2 id=负载均衡>负载均衡</h2><h3 id=四层负载均衡>四层负载均衡</h3><p>主要是为了将请求分流到不同服务器</p><p>F5 硬负载均衡 基于硬件、商业化</p><p>LVS 四层负载均衡</p><p>Haproxy 四层负载均衡</p><p>Nginx 四层负载均衡</p><h3 id=七层负载均衡>七层负载均衡</h3><p>基于应用层HTTP协议进行负载均衡</p><p>Nginx 七层负载均衡</p><p>Haproxy 七层负载均衡</p><p>apache 七层负载均衡</p><p>四层主要是tcp、udp转发请求，而不是处理请求
七层会处理请求，可以过滤、压缩、缓存等</p><h3 id=dns-地域负载均衡>DNS 地域负载均衡</h3><p><img class=lazyload src=/svg/loading.min.svg data-src=/img/postimages/DNS%e5%9c%b0%e5%9f%9f%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1.webp data-srcset="/img/postimages/DNS%e5%9c%b0%e5%9f%9f%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1.webp, /img/postimages/DNS%e5%9c%b0%e5%9f%9f%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1.webp 1.5x, /img/postimages/DNS%e5%9c%b0%e5%9f%9f%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1.webp 2x" data-sizes=auto alt=/img/postimages/DNS地域负载均衡.webp title=DNS地域负载均衡></p><p>可以根据请求者地域，分配到最近的服务器
减少网络传输的损耗</p><h2 id=使用nginx搭建三台tomcat集群>使用Nginx搭建三台tomcat集群</h2><p>tomcat1 :10.4.7.11</p><p>tomcat2 :10.4.7.12</p><p>tomcat3 :10.4.7.21</p><p>tomcat安装：10.4.7.{11,12,21}都要安装</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>yum install tomcat -y
</span></span><span style=display:flex><span>yum install tomcat-webapps tomcat-admin-webapps tomcat-docs-webapp tomcat-javadoc
</span></span><span style=display:flex><span><span style=color:#75715e>#关闭防火墙</span>
</span></span><span style=display:flex><span>systemctl stop firewalld
</span></span><span style=display:flex><span>systemctl disable firewalld
</span></span><span style=display:flex><span><span style=color:#75715e>#启动tomcat</span>
</span></span><span style=display:flex><span>systemctl restart tomcat
</span></span></code></pre></div><p>10.4.7.129 (nginx服务器)上配置tomcat集群</p><p>vim imooc.conf</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>upstream</span> <span style=color:#a6e22e>tomcats</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>server</span> <span style=color:#ae81ff>10.4</span>.<span style=color:#ae81ff>7.11</span><span style=color:#f92672>:</span><span style=color:#ae81ff>8080</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>server</span> <span style=color:#ae81ff>10.4</span>.<span style=color:#ae81ff>7.12</span><span style=color:#f92672>:</span><span style=color:#ae81ff>8080</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>server</span> <span style=color:#ae81ff>10.4</span>.<span style=color:#ae81ff>7.21</span><span style=color:#f92672>:</span><span style=color:#ae81ff>8080</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>server</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>listen</span>       <span style=color:#ae81ff>80</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>server_name</span>  <span style=color:#a6e22e>www</span>.<span style=color:#a6e22e>tomcats</span>.<span style=color:#a6e22e>com</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>location</span> <span style=color:#f92672>/</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>proxy_pass</span> <span style=color:#a6e22e>http</span><span style=color:#f92672>:</span><span style=color:#75715e>//tomcats;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        }
</span></span><span style=display:flex><span>        }
</span></span></code></pre></div><p>重启nginx</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>/usr/local/nginx/sbin/nginx -s reload 
</span></span></code></pre></div><p>windwos配置hosts规则：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>10.4.7.129 www.tomcats.com
</span></span></code></pre></div><p>测试访问。</p><p><a href=https://www.tomcats.com target=_blank rel="noopener noreffer">www.tomcats.com</a></p><p>请求会平均分配给后面三台tomcat.</p><p>参考：http://tengine.taobao.org/book/chapter_05.html</p><h2 id=负载均衡之轮询>负载均衡之轮询</h2><p>默认nginx使用的是轮询。交替出现。出现次数均等。</p><p>修改每台tomcat默认页面</p><p>/usr/share/tomcat/webapps/ROOT/index.jsp</p><p>第37行。home改成对应IP最后一位。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span> 37 &lt;<span style=color:#f92672>span</span> <span style=color:#a6e22e>id</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;nav-home&#34;</span>&gt;&lt;<span style=color:#f92672>a</span> <span style=color:#a6e22e>href</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;${tomcatUrl}&#34;</span>&gt;12&lt;/<span style=color:#f92672>a</span>&gt;&lt;/<span style=color:#f92672>span</span>&gt;
</span></span></code></pre></div><p>重启tomcat</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>systemctl restart tomcat 
</span></span></code></pre></div><p>![nginx 轮询](/img/postimages/nginx 轮询.webp)</p><p>11 12 21 会交替出现。</p><h2 id=负载均衡之权重-加权轮询>负载均衡之权重-加权轮询</h2><p>weight 值越大，出现的次数越多（后端服务器被访问的次数就越多）。</p><p>配置在upstream 模块内。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>upstream</span> <span style=color:#a6e22e>tomcats</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>server</span> <span style=color:#ae81ff>10.4</span>.<span style=color:#ae81ff>7.11</span><span style=color:#f92672>:</span><span style=color:#ae81ff>8080</span> <span style=color:#a6e22e>weight</span><span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>server</span> <span style=color:#ae81ff>10.4</span>.<span style=color:#ae81ff>7.12</span><span style=color:#f92672>:</span><span style=color:#ae81ff>8080</span> <span style=color:#a6e22e>weight</span><span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>server</span> <span style=color:#ae81ff>10.4</span>.<span style=color:#ae81ff>7.21</span><span style=color:#f92672>:</span><span style=color:#ae81ff>8080</span> <span style=color:#a6e22e>weight</span><span style=color:#f92672>=</span><span style=color:#ae81ff>3</span>;
</span></span><span style=display:flex><span>        }
</span></span></code></pre></div><p>11:12:21 = 1:2:3</p><p>21出现几率最大。</p><h2 id=upstream-指令参数>upstream 指令参数</h2><p>max_conns :限制<code>*number*</code>到代理服务器的最大同时活动连接数.默认值为零，表示没有限制。如果启用了<a href=https://nginx.org/en/docs/http/ngx_http_upstream_module.html#keepalive target=_blank rel="noopener noreffer">idle keepalive</a>连接、多个<a href=https://nginx.org/en/docs/ngx_core_module.html#worker_processes target=_blank rel="noopener noreffer">worker</a>和<a href=https://nginx.org/en/docs/http/ngx_http_upstream_module.html#zone target=_blank rel="noopener noreffer">共享内存</a>，则代理服务器的 active 和 idle 连接总数可能会超过该<code>max_conns</code>值。允许最大连接数。</p><p>限制每台server的连接数，用于保护避免过载起到限流作用。</p><p>测试参考配置如下：</p><p>#worker 进程设置1个，便于测试观察成功的连接数。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>worker_processes</span> <span style=color:#ae81ff>1</span> 
</span></span><span style=display:flex><span><span style=color:#a6e22e>upstream</span> <span style=color:#a6e22e>tomcats</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>server</span> <span style=color:#ae81ff>10.4</span>.<span style=color:#ae81ff>7.11</span><span style=color:#f92672>:</span><span style=color:#ae81ff>8080</span> <span style=color:#a6e22e>max_conns</span><span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>server</span> <span style=color:#ae81ff>10.4</span>.<span style=color:#ae81ff>7.12</span><span style=color:#f92672>:</span><span style=color:#ae81ff>8080</span> <span style=color:#a6e22e>max_conns</span><span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>server</span> <span style=color:#ae81ff>10.4</span>.<span style=color:#ae81ff>7.21</span><span style=color:#f92672>:</span><span style=color:#ae81ff>8080</span> <span style=color:#a6e22e>max_conns</span><span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>        }
</span></span></code></pre></div><p>slow_start:当节点恢复，不立即加入,而是等待 slow_start 后加入服务对列.(仅商业版支持)</p><p>测试参考配置如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>upstream</span> <span style=color:#a6e22e>tomcats</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>server</span> <span style=color:#ae81ff>10.4</span>.<span style=color:#ae81ff>7.11</span><span style=color:#f92672>:</span><span style=color:#ae81ff>8080</span> <span style=color:#a6e22e>weight</span><span style=color:#f92672>=</span><span style=color:#ae81ff>6</span> <span style=color:#a6e22e>slow_start</span><span style=color:#f92672>=</span><span style=color:#ae81ff>60</span><span style=color:#a6e22e>s</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>server</span> <span style=color:#ae81ff>10.4</span>.<span style=color:#ae81ff>7.12</span><span style=color:#f92672>:</span><span style=color:#ae81ff>8080</span> <span style=color:#a6e22e>weight</span><span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>server</span> <span style=color:#ae81ff>10.4</span>.<span style=color:#ae81ff>7.21</span><span style=color:#f92672>:</span><span style=color:#ae81ff>8080</span> <span style=color:#a6e22e>weight</span><span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>        }
</span></span></code></pre></div><p>注意：</p><p>该参数不能使用在hash 和random load balancing中</p><p>如果在upstream中只有一台server，则该参数失效。</p><p>down :将服务器标记为永久不可用。</p><p>测试参考配置如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>upstream</span> <span style=color:#a6e22e>tomcats</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>server</span> <span style=color:#ae81ff>10.4</span>.<span style=color:#ae81ff>7.11</span><span style=color:#f92672>:</span><span style=color:#ae81ff>8080</span> <span style=color:#a6e22e>down</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>server</span> <span style=color:#ae81ff>10.4</span>.<span style=color:#ae81ff>7.12</span><span style=color:#f92672>:</span><span style=color:#ae81ff>8080</span> <span style=color:#a6e22e>weight</span><span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>server</span> <span style=color:#ae81ff>10.4</span>.<span style=color:#ae81ff>7.21</span><span style=color:#f92672>:</span><span style=color:#ae81ff>8080</span> <span style=color:#a6e22e>weight</span><span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>        }
</span></span></code></pre></div><p>backup:将服务器标记为备份服务器,只有在其他的服务器都宕机以后，自己才会加入到集群中，被用户访问到。</p><p>该参数不能与 <a href=https://nginx.org/en/docs/http/ngx_http_upstream_module.html#hash target=_blank rel="noopener noreffer">hash</a>、<a href=https://nginx.org/en/docs/http/ngx_http_upstream_module.html#ip_hash target=_blank rel="noopener noreffer">ip_hash</a>和<a href=https://nginx.org/en/docs/http/ngx_http_upstream_module.html#random target=_blank rel="noopener noreffer">随机</a> 负载平衡方法一起使用。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>upstream</span> <span style=color:#a6e22e>tomcats</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>server</span> <span style=color:#ae81ff>10.4</span>.<span style=color:#ae81ff>7.11</span><span style=color:#f92672>:</span><span style=color:#ae81ff>8080</span> <span style=color:#a6e22e>backup</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>server</span> <span style=color:#ae81ff>10.4</span>.<span style=color:#ae81ff>7.12</span><span style=color:#f92672>:</span><span style=color:#ae81ff>8080</span> <span style=color:#a6e22e>weight</span><span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>server</span> <span style=color:#ae81ff>10.4</span>.<span style=color:#ae81ff>7.21</span><span style=color:#f92672>:</span><span style=color:#ae81ff>8080</span> <span style=color:#a6e22e>weight</span><span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>        }
</span></span></code></pre></div><p>max_fails:失败几次，则标记server已宕机，剔出上游服务。</p><p>fail_timeout:表示失败的重试时间。</p><p>假设目前设置如下：</p><p>max_fails=2 fail_timeout=15s</p><p>则表示在15秒内请求某一server失败达到2次后，则认为该server已经挂了或者宕机了，随后再过15s，这15s内不会有新的请求到达刚刚挂掉的节点上，而是会请求到正常运作的server，15秒后会在有新请求尝试连接挂掉的server，如果还是失败，重复上一过程，直到恢复。</p><h2 id=使用keepalive提高吞吐量>使用keepalive提高吞吐量</h2><p><a href=https://nginx.org/en/docs/http/ngx_http_upstream_module.html#keepalive target=_blank rel="noopener noreffer">https://nginx.org/en/docs/http/ngx_http_upstream_module.html#keepalive</a></p><p>测试配置：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>upstream</span> <span style=color:#a6e22e>tomcats</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>server</span> <span style=color:#ae81ff>10.4</span>.<span style=color:#ae81ff>7.11</span><span style=color:#f92672>:</span><span style=color:#ae81ff>8080</span> <span style=color:#a6e22e>weight</span><span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>server</span> <span style=color:#ae81ff>10.4</span>.<span style=color:#ae81ff>7.12</span><span style=color:#f92672>:</span><span style=color:#ae81ff>8080</span> <span style=color:#a6e22e>weight</span><span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>server</span> <span style=color:#ae81ff>10.4</span>.<span style=color:#ae81ff>7.21</span><span style=color:#f92672>:</span><span style=color:#ae81ff>8080</span> <span style=color:#a6e22e>weight</span><span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>keepalive</span> <span style=color:#ae81ff>32</span>; <span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>配置长连接的数量</span><span style=color:#960050;background-color:#1e0010>，</span><span style=color:#a6e22e>保持连接可以提高吞吐量</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>server</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>listen</span>       <span style=color:#ae81ff>80</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>server_name</span>  <span style=color:#a6e22e>www</span>.<span style=color:#a6e22e>tomcats</span>.<span style=color:#a6e22e>com</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>location</span> <span style=color:#f92672>/</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>proxy_pass</span> <span style=color:#a6e22e>http</span><span style=color:#f92672>:</span><span style=color:#75715e>//tomcats;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#a6e22e>proxy_http_version</span> <span style=color:#ae81ff>1.1</span>; <span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>代表上面长连接的版本号</span><span style=color:#960050;background-color:#1e0010>，（</span><span style=color:#a6e22e>默认1</span>.<span style=color:#ae81ff>0</span><span style=color:#960050;background-color:#1e0010>，</span><span style=color:#a6e22e>但1</span>.<span style=color:#ae81ff>0</span><span style=color:#a6e22e>不是长链接</span><span style=color:#960050;background-color:#1e0010>）</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>proxy_set_header</span> <span style=color:#a6e22e>Connection</span> <span style=color:#e6db74>&#34;&#34;</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        }
</span></span></code></pre></div><h2 id=负载均衡之ip_hash>负载均衡之ip_hash</h2><p>hash算法</p><p>hash(ip) % node_counts = index</p><p>算出用户访问的服务器具体是哪一台</p><p>保证用户访问的服务器是同一台，保持会话一致</p><p>测试配置：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>upstream</span> <span style=color:#a6e22e>tomcats</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ip_hash</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>server</span> <span style=color:#ae81ff>10.4</span>.<span style=color:#ae81ff>7.11</span><span style=color:#f92672>:</span><span style=color:#ae81ff>8080</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>server</span> <span style=color:#ae81ff>10.4</span>.<span style=color:#ae81ff>7.12</span><span style=color:#f92672>:</span><span style=color:#ae81ff>8080</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>server</span> <span style=color:#ae81ff>10.4</span>.<span style=color:#ae81ff>7.21</span><span style=color:#f92672>:</span><span style=color:#ae81ff>8080</span>;
</span></span><span style=display:flex><span>        }
</span></span></code></pre></div><p>10.4.7.110
10.4.7.120 &mdash;> hash(10 4 7)
10.4.7.210</p><p>分段进行计算，同一片区域，会访问到一个里</p><h3 id=负载均衡之url_hash>负载均衡之<strong>url_hash</strong></h3><p><img class=lazyload src=/svg/loading.min.svg data-src=/img/postimages/url_hash.webp data-srcset="/img/postimages/url_hash.webp, /img/postimages/url_hash.webp 1.5x, /img/postimages/url_hash.webp 2x" data-sizes=auto alt=/img/postimages/url_hash.webp title=url_hash></p><p>通过配置hash $request_uri
开启url_hash</p><h2 id=nginx控制浏览器缓存>nginx控制浏览器缓存</h2><p><img class=lazyload src=/svg/loading.min.svg data-src=/img/postimages/nginx%e7%bc%93%e5%ad%98.webp data-srcset="/img/postimages/nginx%e7%bc%93%e5%ad%98.webp, /img/postimages/nginx%e7%bc%93%e5%ad%98.webp 1.5x, /img/postimages/nginx%e7%bc%93%e5%ad%98.webp 2x" data-sizes=auto alt=/img/postimages/nginx缓存.webp title=nginx缓存></p><p>1、设置静态内容的过期时间(expires time;)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>location</span>  <span style=color:#f92672>/</span><span style=color:#66d9ef>static</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>alias</span>  <span style=color:#f92672>/</span><span style=color:#a6e22e>home</span><span style=color:#f92672>/</span><span style=color:#a6e22e>naga</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>expires</span>  <span style=color:#ae81ff>10</span><span style=color:#a6e22e>s</span>;   
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>2、固定时间 expires @[time]</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>expires  @22h30s;   代表晚上10:30pm失效，浏览器会自动计算时间差
</span></span></code></pre></div><p>3、 expires -[time]</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span> expires  -1h;  距离现在的1小时之前就失效了，相当于不用缓存
</span></span></code></pre></div><p>4、expires eposh; 不使用缓存</p><p>5、expires off; 默认值，其实就是不管，由浏览器自己使用自己的默认缓存</p><p>6、expires max; 缓存不会过期，除非修改过。</p><h2 id=上游服务静态内容缓存>上游服务静态内容缓存</h2><p>keys_zone 是内存缓存 max_size 是硬盘缓存</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>upstream</span> <span style=color:#a6e22e>xxx</span> {  ...  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#a6e22e>proxy_cache_path</span>  <span style=color:#a6e22e>设置缓存保存的地址</span><span style=color:#960050;background-color:#1e0010>，</span><span style=color:#a6e22e>目录会自动创建</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span>   <span style=color:#a6e22e>keys_zone</span> <span style=color:#a6e22e>设置共享内存</span><span style=color:#960050;background-color:#1e0010>，</span><span style=color:#a6e22e>以及占用的空间大小</span> <span style=color:#960050;background-color:#1e0010>##</span> <span style=color:#a6e22e>内存缓存</span> <span style=color:#960050;background-color:#1e0010>##</span>  (<span style=color:#a6e22e>mycache是共享内存名</span><span style=color:#960050;background-color:#1e0010>，</span><span style=color:#a6e22e>下面</span>)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span>   <span style=color:#a6e22e>max_size</span> <span style=color:#a6e22e>设置缓存大小</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span>   <span style=color:#a6e22e>inactive</span> <span style=color:#a6e22e>超过此时间</span><span style=color:#960050;background-color:#1e0010>，</span><span style=color:#a6e22e>缓存自动清理</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span>   <span style=color:#a6e22e>use_temp_path</span><span style=color:#f92672>=</span><span style=color:#a6e22e>off</span>  <span style=color:#a6e22e>关闭临时目录</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>proxy_cache_path</span>  <span style=color:#f92672>/</span><span style=color:#a6e22e>usr</span><span style=color:#f92672>/</span><span style=color:#a6e22e>local</span><span style=color:#f92672>/</span><span style=color:#a6e22e>nginx</span><span style=color:#f92672>/</span><span style=color:#a6e22e>upstream_cache</span>  <span style=color:#a6e22e>keys_zone</span><span style=color:#f92672>=</span><span style=color:#a6e22e>mycache</span><span style=color:#f92672>:</span><span style=color:#ae81ff>50</span><span style=color:#a6e22e>m</span>  <span style=color:#a6e22e>max_size</span><span style=color:#f92672>=</span><span style=color:#ae81ff>30</span><span style=color:#a6e22e>g</span>  <span style=color:#a6e22e>inactive</span><span style=color:#f92672>=</span><span style=color:#ae81ff>8</span><span style=color:#a6e22e>h</span>  <span style=color:#a6e22e>use_temp_path</span><span style=color:#f92672>=</span><span style=color:#a6e22e>off</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>server</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>listen</span>  <span style=color:#ae81ff>80</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>server_name</span>  <span style=color:#a6e22e>www</span>.<span style=color:#a6e22e>naga</span>.<span style=color:#a6e22e>cn</span>;
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>开启并且使用缓存</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>proxy_cache</span>  <span style=color:#a6e22e>mycache</span>;
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>针对200和304状态码的缓存设置过期时间</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>proxy_cache_valid</span>   <span style=color:#ae81ff>200</span>  <span style=color:#ae81ff>304</span>  <span style=color:#ae81ff>8</span><span style=color:#a6e22e>h</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=使用nginx-配置https域名证书>使用nginx 配置https域名证书</h2><ol><li><p>安装ssl模块</p><p>要在nginx中配置https,及必须安装ssl模块，也就是‘http_ssl_module’.</p><p>进入到nginx解压目录：nginx-1.16.1</p><p>新增ssl模块（原来的模块需要保留）&ndash;with-http_ssl_module</p></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>./configure <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--prefix<span style=color:#f92672>=</span>/usr/local/nginx <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--pid-path<span style=color:#f92672>=</span>/var/run/nginx/nginx.pid <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--lock-path<span style=color:#f92672>=</span>/var/lock/nginx.lock <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--error-log-path<span style=color:#f92672>=</span>/var/log/nginx/error.log <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--http-log-path<span style=color:#f92672>=</span>/var/log/nginx/access.log <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--with-http_gzip_static_module <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--http-client-body-temp-path<span style=color:#f92672>=</span>/var/temp/nginx/client <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--http-proxy-temp-path<span style=color:#f92672>=</span>/var/temp/nginx/proxy <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--http-fastcgi-temp-path<span style=color:#f92672>=</span>/var/temp/nginx/fastcgi <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--http-uwsgi-temp-path<span style=color:#f92672>=</span>/var/temp/nginx/uwsgi <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--http-scgi-temp-path<span style=color:#f92672>=</span>/var/temp/nginx/scgi <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--with-http_ssl_module
</span></span></code></pre></div><p>编译和安装：</p><p>make</p><p>make install</p><h2 id=配置ssl>配置ssl</h2><p>1、云上申请证书，审核完成后将证书下载下来，nginx包含两个文件，一个crt证书文件，一个key密钥文件</p><p>2、将文件上传到云服务器，可以放在conf下</p><p>3、修改nginx.conf (事先在nginx里面加入ssl模块 &ndash;with-http_ssl_module, 安装后通过 ./nginx -V 查看 )</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>server</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>listen</span>  <span style=color:#ae81ff>443</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>server_name</span>  <span style=color:#a6e22e>localhost</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#a6e22e>开启ssl</span> 
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ssl</span> <span style=color:#a6e22e>on</span>; 
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#a6e22e>配置ssl证书</span>   <span style=color:#a6e22e>因为放在conf下的</span><span style=color:#960050;background-color:#1e0010>，</span><span style=color:#a6e22e>和nginx</span>.<span style=color:#a6e22e>conf同一路径</span><span style=color:#960050;background-color:#1e0010>，</span><span style=color:#a6e22e>就这样写就行</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ssl_certificate</span> <span style=color:#ae81ff>1_</span><span style=color:#a6e22e>www</span>.<span style=color:#a6e22e>imoocdsp</span>.<span style=color:#a6e22e>com_bundle</span>.<span style=color:#a6e22e>crt</span>; 
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#a6e22e>配置证书秘钥</span> 
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ssl_certificate_key</span> <span style=color:#ae81ff>2_</span><span style=color:#a6e22e>www</span>.<span style=color:#a6e22e>imoocdsp</span>.<span style=color:#a6e22e>com</span>.<span style=color:#a6e22e>key</span>; 
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#a6e22e>ssl会话cache</span> 
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ssl_session_cache</span> <span style=color:#a6e22e>shared</span><span style=color:#f92672>:</span><span style=color:#a6e22e>SSL</span><span style=color:#f92672>:</span><span style=color:#ae81ff>1</span><span style=color:#a6e22e>m</span>; 
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#a6e22e>ssl会话超时时间</span> 
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ssl_session_timeout</span> <span style=color:#ae81ff>5</span><span style=color:#a6e22e>m</span>; 
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#a6e22e>配置加密套件</span><span style=color:#960050;background-color:#1e0010>，</span><span style=color:#a6e22e>写法遵循</span> <span style=color:#a6e22e>openssl</span> <span style=color:#a6e22e>标准</span> 
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ssl_protocols</span> <span style=color:#a6e22e>TLSv1</span> <span style=color:#a6e22e>TLSv1</span>.<span style=color:#ae81ff>1</span> <span style=color:#a6e22e>TLSv1</span>.<span style=color:#ae81ff>2</span>; 
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ssl_ciphers</span> <span style=color:#a6e22e>ECDHE</span><span style=color:#f92672>-</span><span style=color:#a6e22e>RSA</span><span style=color:#f92672>-</span><span style=color:#a6e22e>AES128</span><span style=color:#f92672>-</span><span style=color:#a6e22e>GCM</span><span style=color:#f92672>-</span><span style=color:#a6e22e>SHA256</span><span style=color:#f92672>:</span><span style=color:#a6e22e>HIGH</span><span style=color:#f92672>:!</span><span style=color:#a6e22e>aNULL</span><span style=color:#f92672>:!</span><span style=color:#a6e22e>MD5</span><span style=color:#f92672>:!</span><span style=color:#a6e22e>RC4</span><span style=color:#f92672>:!</span><span style=color:#a6e22e>DHE</span>; 
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ssl_prefer_server_ciphers</span> <span style=color:#a6e22e>on</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>###</span> <span style=color:#a6e22e>将http的请求转发到https</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>server</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>listen</span> <span style=color:#ae81ff>80</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>server_name</span> <span style=color:#a6e22e>localhost</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#a6e22e>排除法</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>$http_name</span> <span style=color:#f92672>~*</span> <span style=color:#e6db74>&#34;^online$&#34;</span> ) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>rewrite</span> <span style=color:#f92672>^</span><span style=color:#e6db74>/(.*)$ https:/</span><span style=color:#f92672>/</span><span style=color:#a6e22e>localhost</span><span style=color:#f92672>/</span><span style=color:#a6e22e>online</span><span style=color:#f92672>/</span> <span style=color:#a6e22e>permanent</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rewrite</span> <span style=color:#f92672>^</span> <span style=color:#a6e22e>https</span><span style=color:#f92672>:</span><span style=color:#75715e>//$host$1 permanent;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><h2 id=动静分离>动静分离</h2><p>1.分布式</p><p>2.前后端解耦</p><p>3.静态归nginx</p><p>4.接口服务化</p><p>静态数据：css/js/html/images/audios/videos/&mldr;</p><p>动态数据：得到的响应可能会和上次不同。</p><p>动静分离的问题</p><p>跨域：</p><p>springboot</p><p>nginx</p><p>jsonp</p><p>分布式会话： 分布式缓存中间件Redis</p><h2 id=nginx高可用ha-keepalived-双机主备>nginx高可用HA keepalived 双机主备</h2><p>keepalived 使用的是虚拟路由冗余协议 VRRP ，这个协议的特点如下：</p><p>1、解决内网单机故障的路由协议，</p><p>2、用于构建过个路由MASTER BACKUP，将几台提供相同服务的路由器组成一个路由器组。一个路由就是nginx</p><p>3、虚拟IP-VIP（Virtual IP Address）</p><p>过程：用户不直接访问nginx，访问虚拟IP，这个虚拟IP是绑定了nginx的master节点，会根据这个关系解析出来结果。 master主节点挂了，心跳检测到后会让虚拟IP找到备用机，多个备用机会根据权重选择。</p><p>此外，主备节点的硬件配置应一样。</p><h2 id=安装keepalived>安装keepalived</h2><p>解压后进入文件夹进行配置，类似nginx，但是需要用 &ndash;sysconf=/etc指定配置文件地址</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>yum -y install libnl libnl-devel
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>./configure --prefix<span style=color:#f92672>=</span>/usr/local/keepalived  --sysconf<span style=color:#f92672>=</span>/etc
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>make <span style=color:#f92672>&amp;&amp;</span> make install
</span></span></code></pre></div><p>prefix：keepalived安装的位置</p><p>sysconf：keepalived核心配置文件所在位置，固定位置，改成其他位置则keepalived启动不了。会报错。</p><p>libnl libnl-devel 是libnl/libnl-3依赖包。</p><h3 id=核心配置文件>核心配置文件：</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#f92672>!</span><span style=color:#a6e22e>Configuration</span> <span style=color:#a6e22e>File</span> <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>keepalived</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#a6e22e>全局配置</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>global_defs</span> {
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#a6e22e>节点故障</span><span style=color:#960050;background-color:#1e0010>，</span><span style=color:#a6e22e>切换了节点之后会通知管理员</span><span style=color:#960050;background-color:#1e0010>，</span><span style=color:#a6e22e>下面还要配置邮箱的协议等</span><span style=color:#960050;background-color:#1e0010>，</span><span style=color:#a6e22e>可以不要</span>
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>notification_email</span> {
</span></span><span style=display:flex><span>     <span style=color:#ae81ff>123456</span><span style=color:#960050;background-color:#1e0010>@</span><span style=color:#a6e22e>qq</span>.<span style=color:#a6e22e>com</span>
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>notification_email_from</span> <span style=color:#a6e22e>Alexandre</span>.<span style=color:#a6e22e>Cassen</span><span style=color:#960050;background-color:#1e0010>@</span><span style=color:#a6e22e>firewall</span>.<span style=color:#a6e22e>loc</span>
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>smtp_server</span> <span style=color:#ae81ff>192.168</span>.<span style=color:#ae81ff>200.1</span>
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>smtp_connect_timeout</span> <span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#a6e22e>路由ID</span><span style=color:#960050;background-color:#1e0010>：</span><span style=color:#a6e22e>当前安装keepalived节点主机的标识符</span><span style=color:#960050;background-color:#1e0010>，</span><span style=color:#a6e22e>全局唯一</span>
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>router_id</span> <span style=color:#a6e22e>naga_170</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>vrrp_skip_check_adv_addr</span>
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>vrrp_strict</span>
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>vrrp_garp_interval</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>vrrp_gna_interval</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>基于VRRP协议的对象</span><span style=color:#960050;background-color:#1e0010>，</span><span style=color:#a6e22e>计算机节点</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>vrrp_instance</span> <span style=color:#a6e22e>VI_1</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>state</span> <span style=color:#a6e22e>MASTER</span>            <span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#a6e22e>表示当前为nginx的master主节点</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>eth0</span>          <span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#a6e22e>当前实例绑定的网卡</span><span style=color:#960050;background-color:#1e0010>，</span> <span style=color:#a6e22e>用</span> <span style=color:#a6e22e>ip</span> <span style=color:#a6e22e>addr查看</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>virtual_router_id</span> <span style=color:#ae81ff>51</span>     <span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>虚拟路由ID</span><span style=color:#960050;background-color:#1e0010>，</span><span style=color:#a6e22e>主备节点需要一致</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>priority</span> <span style=color:#ae81ff>100</span>            <span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>权重</span><span style=color:#960050;background-color:#1e0010>，</span><span style=color:#a6e22e>备机优先级越高就成为新的master</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>advert_int</span> <span style=color:#ae81ff>1</span>            <span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#a6e22e>主备心跳检查</span><span style=color:#960050;background-color:#1e0010>，</span><span style=color:#a6e22e>时间间隔1s</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>authentication</span> {        <span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#a6e22e>认证授权</span><span style=color:#960050;background-color:#1e0010>，</span><span style=color:#a6e22e>防止非法节点</span><span style=color:#960050;background-color:#1e0010>。</span><span style=color:#a6e22e>每个节点一样就可以</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>auth_type</span> <span style=color:#a6e22e>PASS</span>      
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>auth_pass</span> <span style=color:#ae81ff>1111</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>virtual_ipaddress</span> {     <span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#a6e22e>虚拟IP</span><span style=color:#960050;background-color:#1e0010>，</span><span style=color:#a6e22e>用一个就可以了</span>
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>192.168</span>.<span style=color:#ae81ff>17.17</span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>#</span><span style=color:#ae81ff>192.168</span>.<span style=color:#ae81ff>200.17</span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>#</span><span style=color:#ae81ff>192.168</span>.<span style=color:#ae81ff>200.18</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>下面的都可以不要</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>virtual_server</span> <span style=color:#ae81ff>192.168</span>.<span style=color:#ae81ff>200.100</span> <span style=color:#ae81ff>443</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>delay_loop</span> <span style=color:#ae81ff>6</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>lb_algo</span> <span style=color:#a6e22e>rr</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>lb_kind</span> <span style=color:#a6e22e>NAT</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>persistence_timeout</span> <span style=color:#ae81ff>50</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>protocol</span> <span style=color:#a6e22e>TCP</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>real_server</span> <span style=color:#ae81ff>192.168</span>.<span style=color:#ae81ff>201.100</span> <span style=color:#ae81ff>443</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>weight</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>SSL_GET</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>url</span> {
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>path</span> <span style=color:#f92672>/</span>
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>digest</span> <span style=color:#a6e22e>ff20ad2481f97b1754ef3e12ecd3a9cc</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>url</span> {
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>path</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>mrtg</span><span style=color:#f92672>/</span>
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>digest</span> <span style=color:#ae81ff>9</span><span style=color:#a6e22e>b3a0c85a887a256d6939da88aabd8cd</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>connect_timeout</span> <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>retry</span> <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>delay_before_retry</span> <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>virtual_server</span> <span style=color:#ae81ff>10.10</span>.<span style=color:#ae81ff>10.2</span> <span style=color:#ae81ff>1358</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>delay_loop</span> <span style=color:#ae81ff>6</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>lb_algo</span> <span style=color:#a6e22e>rr</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>lb_kind</span> <span style=color:#a6e22e>NAT</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>persistence_timeout</span> <span style=color:#ae81ff>50</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>protocol</span> <span style=color:#a6e22e>TCP</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sorry_server</span> <span style=color:#ae81ff>192.168</span>.<span style=color:#ae81ff>200.200</span> <span style=color:#ae81ff>1358</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>real_server</span> <span style=color:#ae81ff>192.168</span>.<span style=color:#ae81ff>200.2</span> <span style=color:#ae81ff>1358</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>weight</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>HTTP_GET</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>url</span> {
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>path</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>testurl</span><span style=color:#f92672>/</span><span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>jsp</span>
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>digest</span> <span style=color:#ae81ff>640205</span><span style=color:#a6e22e>b7b0fc66c1ea91c463fac6334d</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>url</span> {
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>path</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>testurl2</span><span style=color:#f92672>/</span><span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>jsp</span>
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>digest</span> <span style=color:#ae81ff>640205</span><span style=color:#a6e22e>b7b0fc66c1ea91c463fac6334d</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>url</span> {
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>path</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>testurl3</span><span style=color:#f92672>/</span><span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>jsp</span>
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>digest</span> <span style=color:#ae81ff>640205</span><span style=color:#a6e22e>b7b0fc66c1ea91c463fac6334d</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>connect_timeout</span> <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>retry</span> <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>delay_before_retry</span> <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>real_server</span> <span style=color:#ae81ff>192.168</span>.<span style=color:#ae81ff>200.3</span> <span style=color:#ae81ff>1358</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>weight</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>HTTP_GET</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>url</span> {
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>path</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>testurl</span><span style=color:#f92672>/</span><span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>jsp</span>
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>digest</span> <span style=color:#ae81ff>640205</span><span style=color:#a6e22e>b7b0fc66c1ea91c463fac6334c</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>url</span> {
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>path</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>testurl2</span><span style=color:#f92672>/</span><span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>jsp</span>
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>digest</span> <span style=color:#ae81ff>640205</span><span style=color:#a6e22e>b7b0fc66c1ea91c463fac6334c</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>connect_timeout</span> <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>retry</span> <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>delay_before_retry</span> <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>virtual_server</span> <span style=color:#ae81ff>10.10</span>.<span style=color:#ae81ff>10.3</span> <span style=color:#ae81ff>1358</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>delay_loop</span> <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>lb_algo</span> <span style=color:#a6e22e>rr</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>lb_kind</span> <span style=color:#a6e22e>NAT</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>persistence_timeout</span> <span style=color:#ae81ff>50</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>protocol</span> <span style=color:#a6e22e>TCP</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>real_server</span> <span style=color:#ae81ff>192.168</span>.<span style=color:#ae81ff>200.4</span> <span style=color:#ae81ff>1358</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>weight</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>HTTP_GET</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>url</span> {
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>path</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>testurl</span><span style=color:#f92672>/</span><span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>jsp</span>
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>digest</span> <span style=color:#ae81ff>640205</span><span style=color:#a6e22e>b7b0fc66c1ea91c463fac6334d</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>url</span> {
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>path</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>testurl2</span><span style=color:#f92672>/</span><span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>jsp</span>
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>digest</span> <span style=color:#ae81ff>640205</span><span style=color:#a6e22e>b7b0fc66c1ea91c463fac6334d</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>url</span> {
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>path</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>testurl3</span><span style=color:#f92672>/</span><span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>jsp</span>
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>digest</span> <span style=color:#ae81ff>640205</span><span style=color:#a6e22e>b7b0fc66c1ea91c463fac6334d</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>connect_timeout</span> <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>retry</span> <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>delay_before_retry</span> <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>real_server</span> <span style=color:#ae81ff>192.168</span>.<span style=color:#ae81ff>200.5</span> <span style=color:#ae81ff>1358</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>weight</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>HTTP_GET</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>url</span> {
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>path</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>testurl</span><span style=color:#f92672>/</span><span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>jsp</span>
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>digest</span> <span style=color:#ae81ff>640205</span><span style=color:#a6e22e>b7b0fc66c1ea91c463fac6334d</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>url</span> {
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>path</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>testurl2</span><span style=color:#f92672>/</span><span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>jsp</span>
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>digest</span> <span style=color:#ae81ff>640205</span><span style=color:#a6e22e>b7b0fc66c1ea91c463fac6334d</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>url</span> {
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>path</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>testurl3</span><span style=color:#f92672>/</span><span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>jsp</span>
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>digest</span> <span style=color:#ae81ff>640205</span><span style=color:#a6e22e>b7b0fc66c1ea91c463fac6334d</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>connect_timeout</span> <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>retry</span> <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>delay_before_retry</span> <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>示例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>####</span> <span style=color:#a6e22e>第一台</span> <span style=color:#960050;background-color:#1e0010>####</span>
</span></span><span style=display:flex><span><span style=color:#f92672>!</span> <span style=color:#a6e22e>Configuration</span> <span style=color:#a6e22e>File</span> <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>keepalived</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>全局变量</span><span style=color:#f92672>-</span><span style=color:#a6e22e>路由id</span><span style=color:#960050;background-color:#1e0010>，</span><span style=color:#a6e22e>标识主机id</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>global_defs</span> {
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>router_id</span> <span style=color:#a6e22e>keep_140</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>计算机节点</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>vrrp_instance</span> <span style=color:#a6e22e>VI_1</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>state</span> <span style=color:#a6e22e>MASTER</span>	<span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>标示当前机器为主节点</span><span style=color:#960050;background-color:#1e0010>，</span><span style=color:#a6e22e>从节点BACKUP</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>ens33</span>	<span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>当前网卡</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>virtual_router_id</span> <span style=color:#ae81ff>51</span>	<span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>保持主备机一致</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>priority</span> <span style=color:#ae81ff>100</span>	<span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>权重</span><span style=color:#960050;background-color:#1e0010>，</span><span style=color:#a6e22e>最高的当选下一任主机</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>advert_int</span> <span style=color:#ae81ff>1</span>	<span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>检查时间间隔1s</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>authentication</span> {	<span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>认证授权</span><span style=color:#960050;background-color:#1e0010>，</span><span style=color:#a6e22e>防止非法节点进入</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>auth_type</span> <span style=color:#a6e22e>PASS</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>auth_pass</span> <span style=color:#ae81ff>1111</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>virtual_ipaddress</span> {	<span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>虚拟ip</span>
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>10.4</span>.<span style=color:#ae81ff>7.211</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>####</span> <span style=color:#a6e22e>第二台</span> <span style=color:#960050;background-color:#1e0010>####</span>
</span></span><span style=display:flex><span><span style=color:#f92672>!</span> <span style=color:#a6e22e>Configuration</span> <span style=color:#a6e22e>File</span> <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>keepalived</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>全局变量</span><span style=color:#f92672>-</span><span style=color:#a6e22e>路由id</span><span style=color:#960050;background-color:#1e0010>，</span><span style=color:#a6e22e>标识主机id</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>global_defs</span> {
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>router_id</span> <span style=color:#a6e22e>keep_141</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>计算机节点</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>vrrp_instance</span> <span style=color:#a6e22e>VI_1</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>state</span> <span style=color:#a6e22e>BACKUP</span>	<span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>标示当前机器为从节点</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>ens33</span>	<span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>当前网卡</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>virtual_router_id</span> <span style=color:#ae81ff>51</span>	<span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>保持主备机一致</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>priority</span> <span style=color:#ae81ff>80</span>	<span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>权重</span><span style=color:#960050;background-color:#1e0010>，</span><span style=color:#a6e22e>最高的当选下一任主机</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>advert_int</span> <span style=color:#ae81ff>1</span>	<span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>检查时间间隔1s</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>authentication</span> {	<span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>认证授权</span><span style=color:#960050;background-color:#1e0010>，</span><span style=color:#a6e22e>防止非法节点进入</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>auth_type</span> <span style=color:#a6e22e>PASS</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>auth_pass</span> <span style=color:#ae81ff>1111</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>virtual_ipaddress</span> {	<span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>虚拟ip</span><span style=color:#960050;background-color:#1e0010>，</span><span style=color:#a6e22e>保持和主节点一致</span>
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>10.4</span>.<span style=color:#ae81ff>7.211</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>测试：</p><p>两台机器nginx 和keeplived进程都在。两台一主一备的目的是，主服务器keeplived挂了，vip切到备服务器上，业务不中断。默认vip是在主上生效的。主备的keepalived进程都在，vip会在主上生效。vip切到备服务器上时.主服务器上的keepalived恢复了。vip会再次切回到主服务器上。</p><h3 id=keepalived配置nginx自动启动>keepalived配置Nginx自动启动</h3><p>这时如果nginx挂了，keepalived没有挂，还是会无法访问。</p><p>1.脚本（主从都配置）</p><p>cd /etc/keepalived
vim check_nginx_alive.sh</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>A<span style=color:#f92672>=</span><span style=color:#e6db74>`</span>ps -C nginx --no-header | wc -l<span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 进程数是0的话，就尝试重启nginx</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> $A -eq <span style=color:#ae81ff>0</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>    /usr/local/nginx/sbin/nginx
</span></span><span style=display:flex><span>    <span style=color:#75715e># 等一会儿再次检查ngxin，如果nginx没有启动成功，则停止当前机器的keepalived，使用备用机器</span>
</span></span><span style=display:flex><span>    sleep <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>`</span>ps -C nginx --no-header | wc -l<span style=color:#e6db74>`</span> -eq <span style=color:#ae81ff>0</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        killall keepalived  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>      
</span></span></code></pre></div><p>执行这个脚本后，会检测nginx，挂掉会重启nginx。</p><p>我们将它配置到keepalived配置文件里。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#f92672>!</span> <span style=color:#a6e22e>Configuration</span> <span style=color:#a6e22e>File</span> <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>keepalived</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>global_defs</span> {
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>router_id</span> <span style=color:#a6e22e>keep_140</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>vrrp_script</span> <span style=color:#a6e22e>check_nginx_alive</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>script</span> <span style=color:#e6db74>&#34;/etc/keepalived/check_nginx_alive.sh&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>interval</span> <span style=color:#ae81ff>2</span> <span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>每隔两秒钟运行脚本检测</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>weight</span> <span style=color:#ae81ff>10</span> <span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>脚本运行成功</span><span style=color:#960050;background-color:#1e0010>，</span><span style=color:#a6e22e>升级权重</span><span style=color:#f92672>+</span><span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>vrrp_instance</span> <span style=color:#a6e22e>VI_1</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>state</span> <span style=color:#a6e22e>MASTER</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>ens33</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>virtual_router_id</span> <span style=color:#ae81ff>51</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>priority</span> <span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>advert_int</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>authentication</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>auth_type</span> <span style=color:#a6e22e>PASS</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>auth_pass</span> <span style=color:#ae81ff>1111</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>virtual_ipaddress</span> {
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>10.4</span>.<span style=color:#ae81ff>7.211</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>在此执行上面的定时器</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>track_script</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>check_nginx_alive</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=双机主备缺点>双机主备缺点</h4><p>这样我们就能保证高可用的架构了，但是双机主备会有资源浪费的问题，主机永远不挂机，备机白干活儿。</p><h4 id=keepalived-双主热备>Keepalived 双主热备</h4><p><img class=lazyload src=/svg/loading.min.svg data-src=/img/postimages/nginx%e5%8f%8c%e4%b8%bb1.webp data-srcset="/img/postimages/nginx%e5%8f%8c%e4%b8%bb1.webp, /img/postimages/nginx%e5%8f%8c%e4%b8%bb1.webp 1.5x, /img/postimages/nginx%e5%8f%8c%e4%b8%bb1.webp 2x" data-sizes=auto alt=/img/postimages/nginx双主1.webp title=nginx双主1></p><p><img class=lazyload src=/svg/loading.min.svg data-src=/img/postimages/nginx%e5%8f%8c%e4%b8%bb2.webp data-srcset="/img/postimages/nginx%e5%8f%8c%e4%b8%bb2.webp, /img/postimages/nginx%e5%8f%8c%e4%b8%bb2.webp 1.5x, /img/postimages/nginx%e5%8f%8c%e4%b8%bb2.webp 2x" data-sizes=auto alt=/img/postimages/nginx双主2.webp title=nginx双主2></p><p>双机使用两个虚拟IP，互为主备。</p><p>使用DNS轮询两个虚拟IP进行访问，这样两台服务器都可以使用了。解析域名的时候，给域名解析两个云服务器的ip地址，再均衡权重即可。</p><p>配置（原主节点）：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#f92672>!</span> <span style=color:#a6e22e>Configuration</span> <span style=color:#a6e22e>File</span> <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>keepalived</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>global_defs</span> {
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>router_id</span> <span style=color:#a6e22e>keep_140</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>vrrp_script</span> <span style=color:#a6e22e>check_nginx_alive</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>script</span> <span style=color:#e6db74>&#34;/etc/keepalived/check_nginx_alive.sh&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>interval</span> <span style=color:#ae81ff>2</span> <span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>每隔两秒钟运行脚本检测</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>weight</span> <span style=color:#ae81ff>10</span> <span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>脚本运行成功</span><span style=color:#960050;background-color:#1e0010>，</span><span style=color:#a6e22e>升级权重</span><span style=color:#f92672>+</span><span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span><span style=color:#ae81ff>211</span><span style=color:#a6e22e>主节点</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>vrrp_instance</span> <span style=color:#a6e22e>VI_1</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>state</span> <span style=color:#a6e22e>MASTER</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>ens33</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>virtual_router_id</span> <span style=color:#ae81ff>51</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>priority</span> <span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>advert_int</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>authentication</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>auth_type</span> <span style=color:#a6e22e>PASS</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>auth_pass</span> <span style=color:#ae81ff>1111</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>virtual_ipaddress</span> {
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>10.4</span>.<span style=color:#ae81ff>7.211</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>track_script</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>check_nginx_alive</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span><span style=color:#ae81ff>212</span><span style=color:#a6e22e>从节点</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>vrrp_instance</span> <span style=color:#a6e22e>VI_2</span> {        <span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>名字要改</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>state</span> <span style=color:#a6e22e>BACKUP</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>ens33</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>virtual_router_id</span> <span style=color:#ae81ff>52</span>        <span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>换了一组实例</span><span style=color:#960050;background-color:#1e0010>，</span><span style=color:#a6e22e>改</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>priority</span> <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>advert_int</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>authentication</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>auth_type</span> <span style=color:#a6e22e>PASS</span>      
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>auth_pass</span> <span style=color:#ae81ff>1111</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>track_script</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>check_nginx_alive</span> 
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>virtual_ipaddress</span> {
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>10.4</span>.<span style=color:#ae81ff>7.212</span>           <span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>VIP更改</span>  <span style=color:#a6e22e>虚拟ip</span>  <span style=color:#a6e22e>virtual</span> <span style=color:#a6e22e>IP</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>track_script</span>{
</span></span><span style=display:flex><span>    	<span style=color:#a6e22e>check_nginx_alive</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>配置（原从节点）：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#f92672>!</span> <span style=color:#a6e22e>Configuration</span> <span style=color:#a6e22e>File</span> <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>keepalived</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>global_defs</span> {
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>router_id</span> <span style=color:#a6e22e>keep_141</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>vrrp_script</span> <span style=color:#a6e22e>check_nginx_alive</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>script</span> <span style=color:#e6db74>&#34;/etc/keepalived/check_nginx_alive.sh&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>interval</span> <span style=color:#ae81ff>2</span> <span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>每隔两秒钟运行脚本检测</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>weight</span> <span style=color:#ae81ff>10</span> <span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>脚本运行成功</span><span style=color:#960050;background-color:#1e0010>，</span><span style=color:#a6e22e>升级权重</span><span style=color:#f92672>+</span><span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span><span style=color:#ae81ff>211</span><span style=color:#a6e22e>从节点</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>vrrp_instance</span> <span style=color:#a6e22e>VI_1</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>state</span> <span style=color:#a6e22e>BACKUP</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>ens33</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>virtual_router_id</span> <span style=color:#ae81ff>51</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>priority</span> <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>advert_int</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>authentication</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>auth_type</span> <span style=color:#a6e22e>PASS</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>auth_pass</span> <span style=color:#ae81ff>1111</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>virtual_ipaddress</span> {
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>10.4</span>.<span style=color:#ae81ff>7.211</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>track_script</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>check_nginx_alive</span> 
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span><span style=color:#ae81ff>212</span><span style=color:#a6e22e>主节点</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>vrrp_instance</span> <span style=color:#a6e22e>VI_2</span> {           <span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>第二组实例</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>state</span> <span style=color:#a6e22e>MASTER</span>            
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>ens33</span>          
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>virtual_router_id</span> <span style=color:#ae81ff>52</span>        <span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>第二组router_id</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>priority</span> <span style=color:#ae81ff>100</span>            
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>advert_int</span> <span style=color:#ae81ff>1</span>            
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>authentication</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>auth_type</span> <span style=color:#a6e22e>PASS</span>      
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>auth_pass</span> <span style=color:#ae81ff>1111</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>virtual_ipaddress</span> {     
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>10.4</span>.<span style=color:#ae81ff>7.212</span>           <span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>改为第二个虚拟ip</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>track_script</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>check_nginx_alive</span> 
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2022-01-02</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=http://example.org/posts/nginx%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8/ data-title=nginx安装与使用><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=http://example.org/posts/nginx%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8/><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=http://example.org/posts/nginx%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8/ data-title=nginx安装与使用><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=http://example.org/posts/nginx%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8/ data-title=nginx安装与使用><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=http://example.org/posts/nginx%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8/ data-title=nginx安装与使用><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/k8s%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/ class=prev rel=prev title=k8s集群搭建><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>k8s集群搭建</a>
<a href=/posts/mysql%E4%B8%BB%E4%BB%8E%E6%9E%B6%E6%9E%84/ class=next rel=next title=mysql主从架构>mysql主从架构<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.115.3">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank></a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>