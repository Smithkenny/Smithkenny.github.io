<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>ceph - My New Hugo Site</title><meta name=Description content="This is my cool site"><meta property="og:title" content="ceph"><meta property="og:description" content="基于k8s的ceph集群搭建 环境 master-139 mon,osd 既做管理节点又做子节点 node1-140 mon,osd 做子节点 node2-141 mon,osd 做子节点 ceph 版本 13.2.10 mimic (stable) 系统配置 系统配置工作， 三台节点依次执行
1、修改主机名称 [root@master-139 ~]# vi /etc/hostname master-139 2、编辑hosts文件 10.4.7.139 master-139 10.4.7.140 node1-140 10.4.7.141	node2-141 注意， 这里面的主机名称要和节点名称保持一致， 否则安装的时候会出现问题
3.修改yum源 cat << EOF > /etc/yum.repos.d/ceph.repo [ceph] name=Ceph packages for $basearch baseurl=https://mirrors.tuna.tsinghua.edu.cn/ceph/rpm-mimic/el7/x86_64/ enabled=1 gpgcheck=1 type=rpm-md gpgkey=https://download.ceph.com/keys/release.asc [ceph-noarch] name=Ceph noarch packages # 官方源 #baseurl=http://download.ceph.com/rpm-mimic/el7/noarch # 清华源 baseurl=https://mirrors.tuna.tsinghua.edu.cn/ceph/rpm-mimic/el7/noarch/ enabled=1 gpgcheck=1 type=rpm-md gpgkey=https://download.ceph.com/keys/release.asc [ceph-source] name=Ceph source packages baseurl=https://mirrors.tuna.tsinghua.edu.cn/ceph/rpm-mimic/el7/SRPMS/ enabled=1 gpgcheck=1 type=rpm-md gpgkey=https://download."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.haipengv.com/posts/ceph/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-05-16T10:10:00+00:00"><meta property="article:modified_time" content="2022-05-16T10:10:00+00:00"><meta property="og:site_name" content="My cool site"><meta name=twitter:card content="summary"><meta name=twitter:title content="ceph"><meta name=twitter:description content="基于k8s的ceph集群搭建 环境 master-139 mon,osd 既做管理节点又做子节点 node1-140 mon,osd 做子节点 node2-141 mon,osd 做子节点 ceph 版本 13.2.10 mimic (stable) 系统配置 系统配置工作， 三台节点依次执行
1、修改主机名称 [root@master-139 ~]# vi /etc/hostname master-139 2、编辑hosts文件 10.4.7.139 master-139 10.4.7.140 node1-140 10.4.7.141	node2-141 注意， 这里面的主机名称要和节点名称保持一致， 否则安装的时候会出现问题
3.修改yum源 cat << EOF > /etc/yum.repos.d/ceph.repo [ceph] name=Ceph packages for $basearch baseurl=https://mirrors.tuna.tsinghua.edu.cn/ceph/rpm-mimic/el7/x86_64/ enabled=1 gpgcheck=1 type=rpm-md gpgkey=https://download.ceph.com/keys/release.asc [ceph-noarch] name=Ceph noarch packages # 官方源 #baseurl=http://download.ceph.com/rpm-mimic/el7/noarch # 清华源 baseurl=https://mirrors.tuna.tsinghua.edu.cn/ceph/rpm-mimic/el7/noarch/ enabled=1 gpgcheck=1 type=rpm-md gpgkey=https://download.ceph.com/keys/release.asc [ceph-source] name=Ceph source packages baseurl=https://mirrors.tuna.tsinghua.edu.cn/ceph/rpm-mimic/el7/SRPMS/ enabled=1 gpgcheck=1 type=rpm-md gpgkey=https://download."><meta name=application-name content="My cool site"><meta name=apple-mobile-web-app-title content="My cool site"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://blog.haipengv.com/posts/ceph/><link rel=prev href=https://blog.haipengv.com/posts/%E5%AE%89%E8%A3%85%E4%BB%BB%E6%84%8F%E7%89%88%E6%9C%ACpython/><link rel=next href=https://blog.haipengv.com/posts/python%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E6%80%BB%E7%BB%93/><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"ceph","inLanguage":"en-us","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.haipengv.com\/posts\/ceph\/"},"genre":"posts","wordcount":1613,"url":"https:\/\/blog.haipengv.com\/posts\/ceph\/","datePublished":"2022-05-16T10:10:00+00:00","dateModified":"2022-05-16T10:10:00+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Author"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="My New Hugo Site">My cool site</a></div><div class=menu><div class=menu-inner><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="My New Hugo Site">My cool site</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">ceph</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Author</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2022-05-16>2022-05-16</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;1613 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;8 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><ul><li><a href=#基于k8s的ceph集群搭建>基于k8s的ceph集群搭建</a></li><li><a href=#环境>环境</a></li></ul></li><li><a href=#系统配置>系统配置</a><ul><li></li><li><a href=#免密码ssh登陆>免密码SSH登陆</a></li></ul></li><li><a href=#集群搭建配置><strong>集群搭建配置</strong></a><ul><li></li><li><a href=#安装osd对象存储设备>安装OSD(对象存储设备)</a></li></ul></li><li><a href=#安装管理后台可选><strong>安装管理后台</strong>（可选）</a><ul><li></li></ul></li><li><a href=#创建cephfs>创建Cephfs</a><ul><li></li><li><a href=#采用fuse挂载>采用fuse挂载</a></li></ul></li><li><a href=#ceph常用命令>ceph常用命令</a><ul><li></li></ul></li><li><a href=#日志文件汇总>日志文件汇总</a><ul><li><a href=#参考文档>参考文档</a></li></ul></li></ul></nav></div></div><div class=content id=content><h3 id=基于k8s的ceph集群搭建>基于k8s的ceph集群搭建</h3><h3 id=环境>环境</h3><ul><li>master-139 mon,osd 既做管理节点又做子节点</li><li>node1-140 mon,osd 做子节点</li><li>node2-141 mon,osd 做子节点</li><li>ceph 版本 13.2.10 mimic (stable)</li></ul><h2 id=系统配置>系统配置</h2><p>系统配置工作， 三台节点依次执行</p><h4 id=1修改主机名称>1、修改主机名称</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@master-139 ~<span style=color:#f92672>]</span><span style=color:#75715e># vi /etc/hostname</span>
</span></span><span style=display:flex><span>master-139
</span></span></code></pre></div><h4 id=2编辑hosts文件>2、编辑hosts文件</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>10.4.7.139   master-139
</span></span><span style=display:flex><span>10.4.7.140   node1-140
</span></span><span style=display:flex><span>10.4.7.141	 node2-141
</span></span></code></pre></div><p>注意， 这里面的主机名称要和节点名称保持一致， 否则安装的时候会出现问题</p><h4 id=3修改yum源>3.修改yum源</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat <span style=color:#e6db74>&lt;&lt; EOF &gt; /etc/yum.repos.d/ceph.repo 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>[ceph] 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>name=Ceph packages for $basearch
</span></span></span><span style=display:flex><span><span style=color:#e6db74>baseurl=https://mirrors.tuna.tsinghua.edu.cn/ceph/rpm-mimic/el7/x86_64/ 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>enabled=1 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>gpgcheck=1 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>type=rpm-md 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>gpgkey=https://download.ceph.com/keys/release.asc
</span></span></span><span style=display:flex><span><span style=color:#e6db74> 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>[ceph-noarch] 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>name=Ceph noarch packages 
</span></span></span><span style=display:flex><span><span style=color:#e6db74># 官方源 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>#baseurl=http://download.ceph.com/rpm-mimic/el7/noarch 
</span></span></span><span style=display:flex><span><span style=color:#e6db74># 清华源 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>baseurl=https://mirrors.tuna.tsinghua.edu.cn/ceph/rpm-mimic/el7/noarch/ 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>enabled=1 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>gpgcheck=1 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>type=rpm-md 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>gpgkey=https://download.ceph.com/keys/release.asc
</span></span></span><span style=display:flex><span><span style=color:#e6db74> 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>[ceph-source] 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>name=Ceph source packages
</span></span></span><span style=display:flex><span><span style=color:#e6db74>baseurl=https://mirrors.tuna.tsinghua.edu.cn/ceph/rpm-mimic/el7/SRPMS/ 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>enabled=1 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>gpgcheck=1 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>type=rpm-md 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>gpgkey=https://download.ceph.com/keys/release.asc
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span></code></pre></div><h4 id=4安装ceph与ceph-deploy组件>4、安装ceph与ceph-deploy组件</h4><pre tabindex=0><code>yum clean all &amp;&amp; yum makecache 
yum -y install python-setuptools epel-release
yum -y install python2-pip ceph-deploy ceph
</code></pre><h4 id=5安装ntp时间同步工具>5.安装NTP时间同步工具</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yum install ntp ntpdate ntp-doc -y
</span></span></code></pre></div><p>确保时区是正确， 设置开机启动：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl enable ntpd
</span></span></code></pre></div><p>并将时间每隔1小时自动校准同步。编辑 vi /etc/rc.d/rc.local 追加：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>/usr/sbin/ntpdate ntp1.aliyun.com &gt; /dev/null 2&gt;&amp;1; /sbin/hwclock -w
</span></span></code></pre></div><p>配置定时任务, 执行crontab -e 加入：</p><h3 id=免密码ssh登陆>免密码SSH登陆</h3><h4 id=6开放端口-非生产环境-可以直接禁用防火墙>6.开放端口， 非生产环境， 可以直接禁用防火墙：</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl stop firewalld.service 
</span></span><span style=display:flex><span>systemctl disable firewalld.service
</span></span></code></pre></div><h4 id=7selinux设置>7.SELINUX设置</h4><p>SELinux 设为禁用：</p><p>永久生效：
编辑 vi /etc/selinux/config 修改：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>SELINUX<span style=color:#f92672>=</span>disabled
</span></span></code></pre></div><h4 id=8生成密钥>8.生成密钥</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>执行 ssh-keygen ，一直按默认提示点击生成 RSA 密钥信息。
</span></span></code></pre></div><h4 id=9分发密钥至各机器节点>9.分发密钥至各机器节点</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ssh-copy-id root@master-139
</span></span><span style=display:flex><span>ssh-copy-id root@node1-140
</span></span><span style=display:flex><span>ssh-copy-id root@node2-141
</span></span></code></pre></div><p><strong>注意：以上1-9步骤在所有节点上执行！！</strong></p><h2 id=集群搭建配置><strong>集群搭建配置</strong></h2><h4 id=1采用root身份进行安装在管理节点创建集群配置目录>1.采用root身份进行安装，在管理节点创建集群配置目录</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cd /usr/local/
</span></span><span style=display:flex><span>mkdir ceph-cluster 
</span></span><span style=display:flex><span>cd ceph-cluster
</span></span></code></pre></div><p>注意： 此目录作为 ceph 操作命令的基准目录， 会存储处理配置信息。</p><h4 id=2创建集群-包含三台机器节点>2.创建集群， 包含三台机器节点：</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ceph-deploy new master-139 node1-140 node2-141
</span></span></code></pre></div><p>创建成功后， 会生一个配置文件。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@master-139 ceph-cluster<span style=color:#f92672>]</span><span style=color:#75715e># ll</span>
</span></span><span style=display:flex><span>total <span style=color:#ae81ff>16</span>
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#ae81ff>1</span> root root  <span style=color:#ae81ff>242</span> May <span style=color:#ae81ff>15</span> 03:15 ceph.conf
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>5559</span> May <span style=color:#ae81ff>15</span> 03:15 ceph-deploy-ceph.log
</span></span><span style=display:flex><span>-rw------- <span style=color:#ae81ff>1</span> root root   <span style=color:#ae81ff>73</span> May <span style=color:#ae81ff>15</span> 03:15 ceph.mon.keyring
</span></span></code></pre></div><h4 id=3如果接下来集群的安装配置出现问题-可以执行以下命令清除-再重新安装可选>3.如果接下来集群的安装配置出现问题， 可以执行以下命令清除， 再重新安装(可选)</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ceph-deploy purge master-139 node1-140 node2-141
</span></span><span style=display:flex><span>ceph-deploy purgedata master-139 node1-140 node2-141
</span></span><span style=display:flex><span>ceph-deploy forgetkeys
</span></span></code></pre></div><h4 id=4将三台节点的mon信息也删除可选>4.将三台节点的mon信息也删除（可选）</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>rm -rf /var/run/ceph/
</span></span></code></pre></div><h4 id=5修改配置文件-有些配置后面需用到>5.修改配置文件， 有些配置后面需用到</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>vi /usr/local/ceph-cluster/ceph.conf
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>global<span style=color:#f92672>]</span> 
</span></span><span style=display:flex><span><span style=color:#75715e># 设置pool池默认分配数量 默认副本数为3 </span>
</span></span><span style=display:flex><span>osd pool default size <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span> 
</span></span><span style=display:flex><span><span style=color:#75715e># 容忍更多的时钟误差 </span>
</span></span><span style=display:flex><span>mon clock drift allowed <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span> 
</span></span><span style=display:flex><span>mon clock drift warn backoff <span style=color:#f92672>=</span> <span style=color:#ae81ff>30</span> 
</span></span><span style=display:flex><span><span style=color:#75715e># 允许删除pool </span>
</span></span><span style=display:flex><span>mon_allow_pool_delete <span style=color:#f92672>=</span> true
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>mgr<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 开启WEB仪表盘 </span>
</span></span><span style=display:flex><span>mgr modules <span style=color:#f92672>=</span> dashboard
</span></span></code></pre></div><p>第一项为副本数， 设为 3 份。
第二、三项为允许一定时间的漂移误差。</p><p><strong>设置完成后的配置如下</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>global<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>fsid <span style=color:#f92672>=</span> 67dcaf50-275b-442f-b69d-677fd8afcc94
</span></span><span style=display:flex><span>mon_initial_members <span style=color:#f92672>=</span> master-139, node1-140, node2-141
</span></span><span style=display:flex><span>mon_host <span style=color:#f92672>=</span> 10.4.7.139,10.4.7.140,10.4.7.141
</span></span><span style=display:flex><span>auth_cluster_required <span style=color:#f92672>=</span> cephx
</span></span><span style=display:flex><span>auth_service_required <span style=color:#f92672>=</span> cephx
</span></span><span style=display:flex><span>auth_client_required <span style=color:#f92672>=</span> cephx
</span></span><span style=display:flex><span><span style=color:#75715e># 设置pool池默认分配数量 默认副本数为3</span>
</span></span><span style=display:flex><span>osd pool default size <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 容忍更多的时钟误差</span>
</span></span><span style=display:flex><span>mon clock drift allowed <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>mon clock drift warn backoff <span style=color:#f92672>=</span> <span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 允许删除pool</span>
</span></span><span style=display:flex><span>mon_allow_pool_delete <span style=color:#f92672>=</span> true
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>mgr<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 开启WEB仪表盘</span>
</span></span><span style=display:flex><span>mgr modules <span style=color:#f92672>=</span> dashboard
</span></span></code></pre></div><h4 id=6执行安装>6.执行安装</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ceph-deploy install master-139 node1-140 node2-141
</span></span></code></pre></div><p>如果出现错误：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ceph_deploy<span style=color:#f92672>][</span>ERROR <span style=color:#f92672>]</span> RuntimeError: Failed to execute command: ceph --version
</span></span></code></pre></div><p>可以在各节点上单独进行安装：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yum -y install ceph 
</span></span></code></pre></div><p>如果没有仓库文件 ceph.repo ， 按上面的步骤手工创建。</p><h4 id=7初始monitor信息>7.初始monitor信息</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ceph-deploy mon create-initial <span style=color:#75715e>## ceph-deploy --overwrite-conf mon create-initial</span>
</span></span></code></pre></div><p><strong>初始化后生成以下信息</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>ceph_deploy.gatherkeys<span style=color:#f92672>][</span>INFO  <span style=color:#f92672>]</span> Storing ceph.client.admin.keyring
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>ceph_deploy.gatherkeys<span style=color:#f92672>][</span>INFO  <span style=color:#f92672>]</span> Storing ceph.bootstrap-mds.keyring
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>ceph_deploy.gatherkeys<span style=color:#f92672>][</span>INFO  <span style=color:#f92672>]</span> Storing ceph.bootstrap-mgr.keyring
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>ceph_deploy.gatherkeys<span style=color:#f92672>][</span>INFO  <span style=color:#f92672>]</span> keyring <span style=color:#e6db74>&#39;ceph.mon.keyring&#39;</span> already exists
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>ceph_deploy.gatherkeys<span style=color:#f92672>][</span>INFO  <span style=color:#f92672>]</span> Storing ceph.bootstrap-osd.keyring
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>ceph_deploy.gatherkeys<span style=color:#f92672>][</span>INFO  <span style=color:#f92672>]</span> Storing ceph.bootstrap-rgw.keyring
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>ceph_deploy.gatherkeys<span style=color:#f92672>][</span>INFO  <span style=color:#f92672>]</span> Destroy temp directory /tmp/tmpuBxetx
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@master-139 ceph-cluster<span style=color:#f92672>]</span><span style=color:#75715e># ll</span>
</span></span><span style=display:flex><span>total <span style=color:#ae81ff>220</span>
</span></span><span style=display:flex><span>-rw------- <span style=color:#ae81ff>1</span> root root    <span style=color:#ae81ff>113</span> May <span style=color:#ae81ff>15</span> 03:29 ceph.bootstrap-mds.keyring
</span></span><span style=display:flex><span>-rw------- <span style=color:#ae81ff>1</span> root root    <span style=color:#ae81ff>113</span> May <span style=color:#ae81ff>15</span> 03:29 ceph.bootstrap-mgr.keyring
</span></span><span style=display:flex><span>-rw------- <span style=color:#ae81ff>1</span> root root    <span style=color:#ae81ff>113</span> May <span style=color:#ae81ff>15</span> 03:29 ceph.bootstrap-osd.keyring
</span></span><span style=display:flex><span>-rw------- <span style=color:#ae81ff>1</span> root root    <span style=color:#ae81ff>113</span> May <span style=color:#ae81ff>15</span> 03:29 ceph.bootstrap-rgw.keyring
</span></span><span style=display:flex><span>-rw------- <span style=color:#ae81ff>1</span> root root    <span style=color:#ae81ff>151</span> May <span style=color:#ae81ff>15</span> 03:29 ceph.client.admin.keyring
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#ae81ff>1</span> root root    <span style=color:#ae81ff>529</span> May <span style=color:#ae81ff>15</span> 03:22 ceph.conf
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>167370</span> May <span style=color:#ae81ff>15</span> 03:29 ceph-deploy-ceph.log
</span></span><span style=display:flex><span>-rw------- <span style=color:#ae81ff>1</span> root root     <span style=color:#ae81ff>73</span> May <span style=color:#ae81ff>15</span> 03:22 ceph.mon.keyring
</span></span></code></pre></div><h4 id=8同步管理信息>8.同步管理信息</h4><p>下发配置文件和管理信息至各节点：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ceph-deploy admin master-139 node1-140 node2-141
</span></span></code></pre></div><h4 id=9安装mgr管理守护进程-大于12x版本需安装-我们装的是最新版需执行>9.安装mgr(管理守护进程)， 大于12.x版本需安装， 我们装的是最新版，需执行：</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ceph-deploy mgr create master-139 node1-140 node2-141
</span></span></code></pre></div><h4 id=10查看当前ceph版本>10.查看当前ceph版本</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># ceph -v</span>
</span></span><span style=display:flex><span>ceph version 13.2.10 <span style=color:#f92672>(</span>564bdc4ae87418a232fc901524470e1a0f76d641<span style=color:#f92672>)</span> mimic <span style=color:#f92672>(</span>stable<span style=color:#f92672>)</span>
</span></span></code></pre></div><p><strong>以上操作都在管理节点master-139上执行！！</strong></p><h3 id=安装osd对象存储设备>安装OSD(对象存储设备)</h3><p>注意： 新版本的 OSD 没有 prepare 与 activate 命令。
这里需要新的硬盘作为 OSD 存储设备， 关闭虚拟机， 增加一块硬盘， 不用格式化。</p><p>各节点都添加100G硬盘。</p><p>重启， fdisk -l 查看新磁盘名称：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Disk /dev/sdb: 107.4 GB, <span style=color:#ae81ff>107374182400</span> bytes, <span style=color:#ae81ff>209715200</span> sectors
</span></span><span style=display:flex><span>Units <span style=color:#f92672>=</span> sectors of <span style=color:#ae81ff>1</span> * 512 <span style=color:#f92672>=</span> <span style=color:#ae81ff>512</span> bytes
</span></span><span style=display:flex><span>Sector size <span style=color:#f92672>(</span>logical/physical<span style=color:#f92672>)</span>: <span style=color:#ae81ff>512</span> bytes / <span style=color:#ae81ff>512</span> bytes
</span></span><span style=display:flex><span>I/O size <span style=color:#f92672>(</span>minimum/optimal<span style=color:#f92672>)</span>: <span style=color:#ae81ff>512</span> bytes / <span style=color:#ae81ff>512</span> bytes
</span></span></code></pre></div><h4 id=1执行创建osd命令>1.执行创建OSD命令</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ceph-deploy osd create --data /dev/sdb master-139 
</span></span><span style=display:flex><span>ceph-deploy osd create --data /dev/sdb node1-140 
</span></span><span style=display:flex><span>ceph-deploy osd create --data /dev/sdb node2-141
</span></span></code></pre></div><p>三台节点都需分别依次执行。</p><p>都切换到/usr/local/ceph-cluster下执行</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ceph-deploy gatherkeys master-139
</span></span></code></pre></div><h4 id=2验证节点>2.验证节点：</h4><p>输入 ceph health 或 ceph -s 查看， 出现 HEALTH_OK 代表正常。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@master-139 ceph-cluster<span style=color:#f92672>]</span><span style=color:#75715e># ceph -s </span>
</span></span><span style=display:flex><span>  cluster:
</span></span><span style=display:flex><span>    id:     4f74ac9a-b5f5-4bf5-9107-15ab8ea41f76
</span></span><span style=display:flex><span>    health: HEALTH_OK
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>  services:
</span></span><span style=display:flex><span>    mon: <span style=color:#ae81ff>3</span> daemons, quorum master-139,node1-140,node2-141
</span></span><span style=display:flex><span>    mgr: master-139<span style=color:#f92672>(</span>active<span style=color:#f92672>)</span>, standbys: node1-140, node2-141
</span></span><span style=display:flex><span>    osd: <span style=color:#ae81ff>3</span> osds: <span style=color:#ae81ff>3</span> up, <span style=color:#ae81ff>3</span> in
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>  data:
</span></span><span style=display:flex><span>    pools:   <span style=color:#ae81ff>0</span> pools, <span style=color:#ae81ff>0</span> pgs
</span></span><span style=display:flex><span>    objects: <span style=color:#ae81ff>0</span>  objects, <span style=color:#ae81ff>0</span> B
</span></span><span style=display:flex><span>    usage:   3.0 GiB used, <span style=color:#ae81ff>297</span> GiB / <span style=color:#ae81ff>300</span> GiB avail
</span></span><span style=display:flex><span>    pgs:     
</span></span></code></pre></div><h4 id=3如果出现错误各节点上执行确保时间一致>3.如果出现错误，各节点上执行,确保时间一致。</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span> ntpdate ntp1.aliyun.com
</span></span></code></pre></div><h2 id=安装管理后台可选><strong>安装管理后台</strong>（可选）</h2><h4 id=1开启dashboard模块>1.开启dashboard模块</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ceph mgr module enable dashboard
</span></span></code></pre></div><h4 id=2生成签名>2.生成签名</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ceph dashboard create-self-signed-cert
</span></span></code></pre></div><h4 id=3创建目录>3.创建目录</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir mgr-dashboard
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@master-139 mgr-dashboard<span style=color:#f92672>]</span><span style=color:#75715e># pwd </span>
</span></span><span style=display:flex><span>/usr/local/ceph-cluster/mgr-dashboard
</span></span></code></pre></div><h4 id=4生成密钥对>4.生成密钥对</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cd /usr/local/ceph-cluster/mgr-dashboard
</span></span><span style=display:flex><span>openssl req -new -nodes -x509 -subj <span style=color:#e6db74>&#34;/O=IT/CN=ceph-mgr-dashboard&#34;</span> -days <span style=color:#ae81ff>3650</span> -keyout dashboard.key -out dashboard.crt -extensions v3_ca
</span></span></code></pre></div><h4 id=5启动dashboard>5.启动dashboard</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ceph mgr module disable dashboard 
</span></span><span style=display:flex><span>ceph mgr module enable dashboard
</span></span></code></pre></div><h4 id=6设置ip与port>6.设置IP与PORT</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ceph config set mgr mgr/dashboard/server_addr 10.4.7.139
</span></span><span style=display:flex><span>ceph config set mgr mgr/dashboard/server_port <span style=color:#ae81ff>18843</span>
</span></span></code></pre></div><p>注意：ip为管理节点的主IP</p><h4 id=7关闭https>7.关闭HTTPS</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ceph config set mgr mgr/dashboard/ssl false
</span></span></code></pre></div><h4 id=8查看服务信息>8.查看服务信息</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@master-139 mgr-dashboard<span style=color:#f92672>]</span><span style=color:#75715e># ceph mgr services</span>
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;dashboard&#34;</span>: <span style=color:#e6db74>&#34;https://master-139:8443/&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h4 id=9设置管理用户与密码>9.设置管理用户与密码</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ceph dashboard set-login-credentials admin admin
</span></span></code></pre></div><h4 id=10访问>10.访问</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>http://10.4.7.139:18843
</span></span></code></pre></div><h2 id=创建cephfs>创建Cephfs</h2><p>集群创建完后， 默认没有文件系统， 我们创建一个 Cephfs 可以支持对外访问的文件系统。</p><h4 id=1创建两个存储池-执行两条命令>1.创建两个存储池, 执行两条命令</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ceph osd pool create cephfs_data <span style=color:#ae81ff>128</span> 
</span></span><span style=display:flex><span>ceph osd pool create cephfs_metadata <span style=color:#ae81ff>64</span>
</span></span></code></pre></div><p>少于 5 个 OSD 可把 pg_num 设置为 128
OSD 数量在 5 到 10 ，可以设置 pg_num 为 512
OSD 数量在 10 到 50 ，可以设置 pg_num 为 4096
OSD 数量大于 50 ，需要计算 pg_num 的值</p><p>通过下面命令可以列出当前创建的存储池：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@master-139 ceph-cluster<span style=color:#f92672>]</span><span style=color:#75715e># ceph osd lspools</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> cephfs_data
</span></span><span style=display:flex><span><span style=color:#ae81ff>2</span> cephfs_metadata
</span></span></code></pre></div><h4 id=2创建fs-名称为cephfs>2.创建fs, 名称为cephfs</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ceph fs new cephfs cephfs_metadata cephfs_data
</span></span></code></pre></div><h4 id=3状态查看-以下信息代表正常>3.状态查看， 以下信息代表正常</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@master-139 ceph-cluster<span style=color:#f92672>]</span><span style=color:#75715e># ceph fs ls </span>
</span></span><span style=display:flex><span>name: cephfs, metadata pool: cephfs_metadata, data pools: <span style=color:#f92672>[</span>cephfs_data <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@haproxy ceph-cluster<span style=color:#f92672>]</span><span style=color:#75715e># ceph mds stat</span>
</span></span><span style=display:flex><span>cephfs-1/1/1 up  <span style=color:#f92672>{</span>0<span style=color:#f92672>=</span>haproxy<span style=color:#f92672>=</span>up:active<span style=color:#f92672>}</span>, <span style=color:#ae81ff>1</span> up:standby
</span></span></code></pre></div><p>这里mds如果只显示cephfs-1/1/1 up 后面没内容说明mds没创建需要手动创建。如果不创建后面ceph挂载会报错。提示mds不存在。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@master-139 ceph-cluster<span style=color:#f92672>]</span><span style=color:#75715e># ceph mds stat </span>
</span></span><span style=display:flex><span>cephfs-0/0/1 up
</span></span><span style=display:flex><span><span style=color:#75715e>#挂载时报错信息</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@node1-140 ceph-cluster<span style=color:#f92672>]</span><span style=color:#75715e># ceph-fuse -k /etc/ceph/ceph.client.admin.keyring -m 10.4.7.139:6789 /usr/local/cephfs_directory </span>
</span></span><span style=display:flex><span>ceph-fuse<span style=color:#f92672>[</span>42676<span style=color:#f92672>]</span>: starting ceph client
</span></span><span style=display:flex><span>2022-05-15 03:43:48.136 7f84eb7cac00 -1 init, newargv <span style=color:#f92672>=</span> 0x561dca3c0240 newargc<span style=color:#f92672>=</span><span style=color:#ae81ff>7</span>
</span></span><span style=display:flex><span>ceph-fuse<span style=color:#f92672>[</span>42676<span style=color:#f92672>]</span>: probably no MDS server is up?
</span></span><span style=display:flex><span>ceph-fuse<span style=color:#f92672>[</span>42676<span style=color:#f92672>]</span>: ceph mount failed with <span style=color:#f92672>(</span>65536<span style=color:#f92672>)</span> Unknown error <span style=color:#ae81ff>65536</span>
</span></span></code></pre></div><p>手动创建mds</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ceph-deploy mds create master-139 node1-140 node2-141
</span></span></code></pre></div><p>附： 如果创建错误， 需要删除， 执行：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ceph fs rm cephfs --yes-i-really-mean-it 
</span></span><span style=display:flex><span>ceph osd pool delete cephfs_data cephfs_data --yes-i-really-really-mean-it
</span></span></code></pre></div><p>确保在ceph.conf中开启以下配置：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>mon<span style=color:#f92672>]</span> mon allow pool delete <span style=color:#f92672>=</span> true
</span></span></code></pre></div><h3 id=采用fuse挂载>采用fuse挂载</h3><p>先确定 ceph-fuse 命令能执行， 如果没有， 则安装：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yum -y install ceph-fuse
</span></span></code></pre></div><h4 id=1创建挂载目录>1.创建挂载目录</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir -p /usr/local/cephfs_directory
</span></span></code></pre></div><h4 id=2挂载cephfs>2.挂载cephfs</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ceph-fuse -k /etc/ceph/ceph.client.admin.keyring -m 10.4.7.139:6789 /usr/local/cephfs_directory
</span></span></code></pre></div><h4 id=3查看磁盘挂载信息>3.查看磁盘挂载信息</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#df -hT</span>
</span></span></code></pre></div><p>/usr/local/cephfs_directory 目录已成功挂载。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@node1-140 ceph-cluster<span style=color:#f92672>]</span><span style=color:#75715e># df -hT | grep cephfs </span>
</span></span><span style=display:flex><span>ceph-fuse                  fuse.ceph-fuse   94G     <span style=color:#ae81ff>0</span>   94G   0% /usr/local/cephfs_directory
</span></span></code></pre></div><p>注意查看当前ceph 的主节点是谁。三台机器中如果有一台突然宕机，然后又恢复了。此时出问题的那台将成为主节点。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@node1-140 ceph-cluster<span style=color:#f92672>]</span><span style=color:#75715e># ceph -s </span>
</span></span><span style=display:flex><span>  cluster:
</span></span><span style=display:flex><span>    id:     4f74ac9a-b5f5-4bf5-9107-15ab8ea41f76
</span></span><span style=display:flex><span>    health: HEALTH_OK
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>  services:
</span></span><span style=display:flex><span>    mon: <span style=color:#ae81ff>3</span> daemons, quorum master-139,node1-140,node2-141
</span></span><span style=display:flex><span>    mgr: master-139<span style=color:#f92672>(</span>active<span style=color:#f92672>)</span>, standbys: node1-140, node2-141
</span></span><span style=display:flex><span>    mds: cephfs-1/1/1 up  <span style=color:#f92672>{</span>0<span style=color:#f92672>=</span>master-139<span style=color:#f92672>=</span>up:active<span style=color:#f92672>}</span>, <span style=color:#ae81ff>2</span> up:standby
</span></span><span style=display:flex><span>    osd: <span style=color:#ae81ff>3</span> osds: <span style=color:#ae81ff>3</span> up, <span style=color:#ae81ff>3</span> in
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>  data:
</span></span><span style=display:flex><span>    pools:   <span style=color:#ae81ff>2</span> pools, <span style=color:#ae81ff>192</span> pgs
</span></span><span style=display:flex><span>    objects: <span style=color:#ae81ff>21</span>  objects, 2.2 KiB
</span></span><span style=display:flex><span>    usage:   3.0 GiB used, <span style=color:#ae81ff>297</span> GiB / <span style=color:#ae81ff>300</span> GiB avail
</span></span><span style=display:flex><span>    pgs:     <span style=color:#ae81ff>192</span> active+clean
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>  io:
</span></span><span style=display:flex><span>    client:   5.0 KiB/s wr, <span style=color:#ae81ff>0</span> op/s rd, <span style=color:#ae81ff>9</span> op/s wr
</span></span></code></pre></div><p>active的是主节点， standbys是备用节点。</p><h2 id=ceph常用命令>ceph常用命令</h2><h4 id=ceph>ceph</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 查看机器的监控状态</span>
</span></span><span style=display:flex><span>ceph health
</span></span><span style=display:flex><span><span style=color:#75715e># 查看ceph的实时运行状态</span>
</span></span><span style=display:flex><span>ceph -w
</span></span><span style=display:flex><span><span style=color:#75715e># 检查信息状态信息</span>
</span></span><span style=display:flex><span>ceph -s
</span></span><span style=display:flex><span><span style=color:#75715e># 查看ceph存储空间</span>
</span></span><span style=display:flex><span>ceph df
</span></span></code></pre></div><h4 id=ceph认证>ceph认证</h4><h4 id=创建管理用户>创建管理用户</h4><p>为ceph创建一个admin用户并为admin用户创建一个密钥，把密钥保存到/etc/ceph目录下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ceph auth get-or-create client.admin mds <span style=color:#e6db74>&#39;allow&#39;</span> osd <span style=color:#e6db74>&#39;allow *&#39;</span> mon <span style=color:#e6db74>&#39;allow *&#39;</span> &gt; /etc/ceph/ceph.client.admin.keyring
</span></span><span style=display:flex><span>或
</span></span><span style=display:flex><span>ceph auth get-or-create client.admin mds <span style=color:#e6db74>&#39;allow&#39;</span> osd <span style=color:#e6db74>&#39;allow *&#39;</span> mon <span style=color:#e6db74>&#39;allow *&#39;</span> -o /etc/ceph/ceph.client.admin.keyring
</span></span></code></pre></div><p>为osd.0创建一个用户并创建一个key</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ceph auth get-or-create osd.0 mon <span style=color:#e6db74>&#39;allow rwx&#39;</span> osd <span style=color:#e6db74>&#39;allow *&#39;</span> -o /var/lib/ceph/osd/ceph-0/keyring
</span></span></code></pre></div><p>为mds.node1创建一个用户并创建一个key</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ceph auth get-or-create mds.node1 mon <span style=color:#e6db74>&#39;allow rwx&#39;</span> osd <span style=color:#e6db74>&#39;allow *&#39;</span> mds <span style=color:#e6db74>&#39;allow *&#39;</span> -o /var/lib/ceph/mds/ceph-node1/keyring
</span></span></code></pre></div><p>查看ceph集群中的认证用户及相关的key</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ceph auth list
</span></span></code></pre></div><p>删除集群中的一个认证用户</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ceph auth del osd.0
</span></span></code></pre></div><h4 id=集群相关>集群相关</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 查看集群的详细配置</span>
</span></span><span style=display:flex><span>ceph daemon mon.node1 config show | more
</span></span><span style=display:flex><span><span style=color:#75715e># 查看集群健康状态细节</span>
</span></span><span style=display:flex><span>ceph health detail
</span></span><span style=display:flex><span><span style=color:#75715e># 查看ceph log日志所在的目录</span>
</span></span><span style=display:flex><span>ceph-conf --name mon.node1 --show-config-value log_file
</span></span></code></pre></div><h4 id=mon命令>mon命令</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ceph mon stat#查看mon的状态信息
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ceph mon dump#查看你ceph映射信息
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ceph mon remove node1 <span style=color:#75715e>#删除一个mon节点  ceph-deploy mon destroy {host-name [host-name]...}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ceph mon add node1 node1_ip <span style=color:#75715e>#添加一个mon节点  ceph-deploy mon create {host-name [host-name]...} </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>mon节点的/var/lib/ceph/mon/ceph-node2/store.db文件内容一致，添加mon注意先改配置目录配置文件，再推送到所有节点
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ceph-deploy --overwrite-conf config push  node1 node2 node3
</span></span></code></pre></div><h4 id=mds命令>mds命令</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ceph mds stat <span style=color:#75715e>#查看msd状态</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ceph mds dump <span style=color:#75715e>#msd的映射信息</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ceph mds rm <span style=color:#ae81ff>0</span> mds.node1#删除一个mds节点
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ceph-deploy mds create <span style=color:#f92672>{</span>host-name<span style=color:#f92672>}[</span>:<span style=color:#f92672>{</span>daemon-name<span style=color:#f92672>}]</span> <span style=color:#f92672>[{</span>host-name<span style=color:#f92672>}[</span>:<span style=color:#f92672>{</span>daemon-name<span style=color:#f92672>}]</span> ...<span style=color:#f92672>]</span>
</span></span></code></pre></div><h4 id=osd命令>osd命令</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ceph osd stat <span style=color:#75715e>#查看osd状态</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ceph osd dump <span style=color:#75715e>#osd的映射信息</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ceph osd tree#查看osd目录树
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ceph osd down <span style=color:#ae81ff>0</span>   <span style=color:#75715e>#down掉osd.0节点</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ceph osd rm 0#集群删除一个osd硬盘
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ceph osd crush remove osd.4#删除标记
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ceph osd getmaxosd#查看最大osd个数
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ceph osd setmaxosd 10#设置osd的个数
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ceph osd out osd.3#把一个osd节点逐出集群
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ceph osd in osd.3#把逐出的osd加入集群
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ceph osd pause#暂停osd （暂停后整个集群不再接收数据）
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ceph osd unpause#再次开启osd （开启后再次接收数据）
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ceph osd lspools#查看ceph集群中的pool数量
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ceph osd pool create jiayuan 100#创建一个pool  这里的100指的是PG组
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ceph osd pool delete jiayuan  jiayuan  --yes-i-really-really-mean-it  <span style=color:#75715e>#集群名字需要重复两次</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>rados df#显示集群中pool的详细信息
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ceph osd pool get data pg_num  <span style=color:#75715e>#查看data池的pg数量</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ceph osd pool set data target_max_bytes 100000000000000#设置data池的最大存储空间为100T（默认是1T<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ceph osd pool set data size <span style=color:#ae81ff>3</span>  <span style=color:#75715e>#设置data池的副本数是3</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ceph osd pool set data min_size <span style=color:#ae81ff>2</span> <span style=color:#75715e>#设置data池能接受写操作的最小副本为2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ceph osd pool set data pg_num 100#设置一个pool的pg数量
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ceph osd pool set data pgp_num 100#设置一个pool的pgp数量
</span></span></code></pre></div><h4 id=pg命令>pg命令</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ceph pg stat#查看pg状态
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ceph pg dump#查看pg组的映射信息
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ceph pg map 0.3f#查看一个pg的map
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ceph pg  0.26 query#查看pg详细信息
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ceph pg dump --format plain#显示一个集群中的所有的pg统计
</span></span></code></pre></div><h4 id=rados和rbd命令>rados和rbd命令</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>rados lspools#查看ceph集群中有多少个pool （只是查看pool<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>rados df <span style=color:#75715e>#查看ceph集群中有多少个pool,并且每个pool容量及利用情况</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>rados mkpool test#创建一个pool
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>rados create test-object -p test#创建一个对象object 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>rados rm test-object-1 -p test#删除一个对象object 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>rados -p test ls
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>rbd ls pool_name#查看ceph中一个pool里的所有镜像
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>rbd info -p pool_name --image 74cb427c-cee9-47d0-b467-af217a67e60a <span style=color:#75715e>#查看ceph pool中一个镜像的信息</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>rbd create -p test --size <span style=color:#ae81ff>10000</span> zhanguo#在test池中创建一个命名为zhanguo的10000M的镜像
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>rbd rm  -p test  lizhanguo <span style=color:#75715e>#删除一个镜像</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>rbd resize -p test --size <span style=color:#ae81ff>20000</span> zhanguo  <span style=color:#75715e>#调整一个镜像的尺寸</span>
</span></span></code></pre></div><h4 id=crush映射>CRUSH映射</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ceph osd getcrushmap -o MAP   <span style=color:#75715e>#获取一个CRUSH映射</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>crushtool -d MAP -o MAP.TXT   <span style=color:#75715e>#反编译一个CRUSH映射</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>crushtool -c MAP.TXT -o MAP   <span style=color:#75715e>#编译一个CRUSH映射</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ceph osd setcrushmap -i MAP    <span style=color:#75715e>#设置一个CRUSH映射</span>
</span></span></code></pre></div><h4 id=块设备的一些命令>块设备的一些命令</h4><p>单位为M，默认在rbd pool中</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>创建块设备：rbd create <span style=color:#f92672>{</span>image-name<span style=color:#f92672>}</span>  --size <span style=color:#f92672>{</span>megabytes<span style=color:#f92672>}</span>  --pool <span style=color:#f92672>{</span>pool-name<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>列出块设备：rbd ls <span style=color:#f92672>{</span>poolname<span style=color:#f92672>}</span> -l
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>检索块信息：rbd --image <span style=color:#f92672>{</span>image-name<span style=color:#f92672>}</span> info
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>更改块大小：rbd resize --image <span style=color:#f92672>{</span>image-name<span style=color:#f92672>}</span> --size <span style=color:#f92672>{</span>megabytes<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>删除块设备：rbd rm <span style=color:#f92672>{</span>image-name<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>映射块设备：rbd map <span style=color:#f92672>{</span>image-name<span style=color:#f92672>}</span> --pool <span style=color:#f92672>{</span>pool-name<span style=color:#f92672>}</span> --id <span style=color:#f92672>{</span>user-name<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>查看已映射块设备：rbd showmapped
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>取消映射：rbd unmap /dev/rbd/<span style=color:#f92672>{</span>poolname<span style=color:#f92672>}</span>/<span style=color:#f92672>{</span>imagename<span style=color:#f92672>}</span>
</span></span></code></pre></div><h4 id=快照和克隆相关命令>快照和克隆相关命令</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>创建快照：
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>rbd --pool <span style=color:#f92672>{</span>pool-name<span style=color:#f92672>}</span> snap create --snap <span style=color:#f92672>{</span>snap-name<span style=color:#f92672>}</span> <span style=color:#f92672>{</span>image-name<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>rbd snap create <span style=color:#f92672>{</span>pool-name<span style=color:#f92672>}</span>/<span style=color:#f92672>{</span>image-name<span style=color:#f92672>}</span>@<span style=color:#f92672>{</span>snap-name<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>快照回滚：
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>rbd --pool <span style=color:#f92672>{</span>pool-name<span style=color:#f92672>}</span> snap rollback --snap <span style=color:#f92672>{</span>snap-name<span style=color:#f92672>}</span> <span style=color:#f92672>{</span>image-name<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>rbd snap rollback <span style=color:#f92672>{</span>pool-name<span style=color:#f92672>}</span>/<span style=color:#f92672>{</span>image-name<span style=color:#f92672>}</span>@<span style=color:#f92672>{</span>snap-name<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>清除快照：
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>rbd --pool <span style=color:#f92672>{</span>pool-name<span style=color:#f92672>}</span> snap purge <span style=color:#f92672>{</span>image-name<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>rbd snap purge <span style=color:#f92672>{</span>pool-name<span style=color:#f92672>}</span>/<span style=color:#f92672>{</span>image-name<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>删除快照：
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>rbd --pool <span style=color:#f92672>{</span>pool-name<span style=color:#f92672>}</span> snap rm --snap <span style=color:#f92672>{</span>snap-name<span style=color:#f92672>}</span> <span style=color:#f92672>{</span>image-name<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>rbd snap rm <span style=color:#f92672>{</span>pool-name<span style=color:#f92672>}</span>/<span style=color:#f92672>{</span>image-name<span style=color:#f92672>}</span>@<span style=color:#f92672>{</span>snap-name<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>列出快照：
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>rbd --pool <span style=color:#f92672>{</span>pool-name<span style=color:#f92672>}</span> snap ls <span style=color:#f92672>{</span>image-name<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>rbd snap ls <span style=color:#f92672>{</span>pool-name<span style=color:#f92672>}</span>/<span style=color:#f92672>{</span>image-name<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>保护快照：
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>rbd --pool <span style=color:#f92672>{</span>pool-name<span style=color:#f92672>}</span> snap protect --image <span style=color:#f92672>{</span>image-name<span style=color:#f92672>}</span> --snap <span style=color:#f92672>{</span>snapshot-name<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>rbd snap protect <span style=color:#f92672>{</span>pool-name<span style=color:#f92672>}</span>/<span style=color:#f92672>{</span>image-name<span style=color:#f92672>}</span>@<span style=color:#f92672>{</span>snapshot-name<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>取消保护快照：
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>rbd --pool <span style=color:#f92672>{</span>pool-name<span style=color:#f92672>}</span> snap unprotect --image <span style=color:#f92672>{</span>image-name<span style=color:#f92672>}</span> --snap <span style=color:#f92672>{</span>snapshot-name<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>rbd snap unprotect <span style=color:#f92672>{</span>pool-name<span style=color:#f92672>}</span>/<span style=color:#f92672>{</span>image-name<span style=color:#f92672>}</span>@<span style=color:#f92672>{</span>snapshot-name<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>快照克隆
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>rbd clone <span style=color:#f92672>{</span>pool-name<span style=color:#f92672>}</span>/<span style=color:#f92672>{</span>parent-image<span style=color:#f92672>}</span>@<span style=color:#f92672>{</span>snap-name<span style=color:#f92672>}</span> <span style=color:#f92672>{</span>pool-name<span style=color:#f92672>}</span>/<span style=color:#f92672>{</span>child-image-name<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>查看快照的克隆
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>rbd --pool <span style=color:#f92672>{</span>pool-name<span style=color:#f92672>}</span> children --image <span style=color:#f92672>{</span>image-name<span style=color:#f92672>}</span> --snap <span style=color:#f92672>{</span>snap-name<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>rbd children <span style=color:#f92672>{</span>pool-name<span style=color:#f92672>}</span>/<span style=color:#f92672>{</span>image-name<span style=color:#f92672>}</span>@<span style=color:#f92672>{</span>snapshot-name<span style=color:#f92672>}</span>
</span></span></code></pre></div><h4 id=快照克隆相关例子>快照克隆相关例子</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>创建快照：rbd  snap create vms/yjk01@yjk01_s1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>列出快照：rbd snap list  --pool vms yjk01
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>快照回滚：rbd snap rollback vms/yjk01@yjk01_s1<span style=color:#f92672>(</span>先卸载已挂载目录<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>删除快照：rbd snap rm vms/yjk01@yjk01_s2<span style=color:#f92672>(</span>单个<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>清除快照：rbd snap purge vms/yjk01<span style=color:#f92672>(</span>所有<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>保护快照：rbd snap protect vms/yjk01@yjk01_s1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>取消保护：rbd snap unprotect vms/yjk01@yjk01_s1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>快照克隆：rbd clone vms/yjk01@yjk01_s3 vms/yjk01_s3_clone1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>查看克隆：rbd children vms/yjk01@yjk01_s3
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>克隆只能基于快照，并且只能快照处于保护状态，而且ceph仅支持克隆format 2映像。
</span></span></code></pre></div><h2 id=日志文件汇总>日志文件汇总</h2><p>mon ,mgr , osd 等安装报错信息均在对应日志文件中。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>/usr/local/ceph-cluster/ceph-deploy-ceph.log
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># tree /var/log/ceph/</span>
</span></span><span style=display:flex><span>/var/log/ceph/
</span></span><span style=display:flex><span>├── ceph.audit.log
</span></span><span style=display:flex><span>├── ceph-client.admin.log
</span></span><span style=display:flex><span>├── ceph.log
</span></span><span style=display:flex><span>├── ceph-mds.haproxy.log
</span></span><span style=display:flex><span>├── ceph-mgr.haproxy.log
</span></span><span style=display:flex><span>├── ceph-mon.haproxy.log
</span></span><span style=display:flex><span>├── ceph-osd.0.log
</span></span><span style=display:flex><span>└── ceph-volume.log
</span></span></code></pre></div><h3 id=参考文档>参考文档</h3><p><a href=https://blog.csdn.net/fake_hydra/article/details/109235907 target=_blank rel="noopener noreffer">1</a></p><p><a href=https://mp.weixin.qq.com/s/nWZWhnaudueuJwmp-Ktuxw target=_blank rel="noopener noreffer">2</a></p><p><a href=https://blog.csdn.net/xiaoweite1/article/details/124059228 target=_blank rel="noopener noreffer">3</a></p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2022-05-16</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://blog.haipengv.com/posts/ceph/ data-title=ceph><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://blog.haipengv.com/posts/ceph/><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://blog.haipengv.com/posts/ceph/ data-title=ceph><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://blog.haipengv.com/posts/ceph/ data-title=ceph><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@6.20.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=https://blog.haipengv.com/posts/ceph/ data-title=ceph><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/%E5%AE%89%E8%A3%85%E4%BB%BB%E6%84%8F%E7%89%88%E6%9C%ACpython/ class=prev rel=prev title=基于centos7/8安装任意版本python><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>基于centos7/8安装任意版本python</a>
<a href=/posts/python%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E6%80%BB%E7%BB%93/ class=next rel=next title=Python数据结构总结>Python数据结构总结<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.115.3">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank></a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.1/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>