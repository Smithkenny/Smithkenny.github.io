<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>CKS初始环境搭建 - My New Hugo Site</title><meta name=Description content="This is my cool site"><meta property="og:title" content="CKS初始环境搭建"><meta property="og:description" content="准备工作 k8s主机名 IP地址 系统版本号 k8s组件版本 CKS-master 10.4.7.180 ubuntu 20.04 1.24.4 CKS-node1 10.4.7.181 ubuntu 20.04 1.24.4 CKS-node2 10.4.7.182 ubuntu 20.04 1.24.4 配置前准备 # 开root用户设置密码 sudo passwd root # 切换root用户 su - root # 更新 apt update # 安装ssh apt install ssh -y # 允许root用户远程登录 PermitRootLogin yes UseDNS no # 重启 systemctl restart ssh 配置域名 # 需要对应的机器执行如下命令 hostnamectl set-hostname CKS-master hostnamectl set-hostname CKS-node1 hostnamectl set-hostname CKS-node2 域名解析 echo -e &#34;10.4.7.180 CKS-master\n10.4.7.181 CKS-node1\n10.4.7.182 CKS-node2&#34; >> /etc/hosts # 拷贝到远程集群机器 scp /etc/hosts root@10."><meta property="og:type" content="article"><meta property="og:url" content="http://example.org/posts/cks%E5%88%9D%E5%A7%8B%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-08-22T23:02:12+00:00"><meta property="article:modified_time" content="2022-08-22T23:02:12+00:00"><meta property="og:site_name" content="My cool site"><meta name=twitter:card content="summary"><meta name=twitter:title content="CKS初始环境搭建"><meta name=twitter:description content="准备工作 k8s主机名 IP地址 系统版本号 k8s组件版本 CKS-master 10.4.7.180 ubuntu 20.04 1.24.4 CKS-node1 10.4.7.181 ubuntu 20.04 1.24.4 CKS-node2 10.4.7.182 ubuntu 20.04 1.24.4 配置前准备 # 开root用户设置密码 sudo passwd root # 切换root用户 su - root # 更新 apt update # 安装ssh apt install ssh -y # 允许root用户远程登录 PermitRootLogin yes UseDNS no # 重启 systemctl restart ssh 配置域名 # 需要对应的机器执行如下命令 hostnamectl set-hostname CKS-master hostnamectl set-hostname CKS-node1 hostnamectl set-hostname CKS-node2 域名解析 echo -e &#34;10.4.7.180 CKS-master\n10.4.7.181 CKS-node1\n10.4.7.182 CKS-node2&#34; >> /etc/hosts # 拷贝到远程集群机器 scp /etc/hosts root@10."><meta name=application-name content="My cool site"><meta name=apple-mobile-web-app-title content="My cool site"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=http://example.org/posts/cks%E5%88%9D%E5%A7%8B%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/><link rel=prev href=http://example.org/posts/python%E5%A4%9A%E7%BA%BF%E7%A8%8B/><link rel=next href=http://example.org/posts/%E4%BD%BF%E7%94%A8python%E5%AE%9E%E7%8E%B0unix%E6%97%B6%E9%97%B4%E6%88%B3%E8%BD%AC%E6%8D%A2/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"CKS初始环境搭建","inLanguage":"en-us","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/example.org\/posts\/cks%E5%88%9D%E5%A7%8B%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA\/"},"genre":"posts","wordcount":1208,"url":"http:\/\/example.org\/posts\/cks%E5%88%9D%E5%A7%8B%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA\/","datePublished":"2022-08-22T23:02:12+00:00","dateModified":"2022-08-22T23:02:12+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Author"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="My New Hugo Site">My cool site</a></div><div class=menu><div class=menu-inner><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="My New Hugo Site">My cool site</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">CKS初始环境搭建</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Author</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2022-08-22>2022-08-22</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;1208 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;6 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><ul><li><a href=#准备工作>准备工作</a></li><li><a href=#配置前准备>配置前准备</a></li><li><a href=#配置域名>配置域名</a></li><li><a href=#域名解析>域名解析</a></li><li><a href=#初始化部分>初始化部分</a></li><li><a href=#vnc服务搭建选做>vnc服务搭建（选做）</a></li></ul></li><li><a href=#安装containerd>安装containerd</a><ul><li><a href=#运行时runc安装>运行时Runc安装</a></li><li><a href=#安装前准备>安装前准备</a></li><li><a href=#开始安装>开始安装</a></li><li><a href=#检测版本>检测版本</a></li><li><a href=#启动关闭服务及查看服务状态>启动、关闭服务及查看服务状态</a></li><li><a href=#更换国内镜像仓库>更换国内镜像仓库</a></li><li><a href=#安装cni插件选做>安装cni插件(选做)</a></li></ul></li><li><a href=#安装三件套kubectl-kubelet-kubeadm>安装三件套kubectl kubelet kubeadm</a><ul><li><a href=#运行crictl-images-时报错>运行crictl images 时报错</a></li><li><a href=#排错>排错</a></li><li><a href=#集群初始化cks-master上操作>集群初始化（cks-master上操作）</a></li><li><a href=#部署dashboardk8s-可视化页面>部署dashboard（k8s 可视化页面）</a></li></ul></li></ul></nav></div></div><div class=content id=content><h3 id=准备工作>准备工作</h3><table><thead><tr><th style=text-align:center>k8s主机名</th><th style=text-align:center>IP地址</th><th style=text-align:center>系统版本号</th><th style=text-align:center>k8s组件版本</th></tr></thead><tbody><tr><td style=text-align:center>CKS-master</td><td style=text-align:center>10.4.7.180</td><td style=text-align:center>ubuntu 20.04</td><td style=text-align:center>1.24.4</td></tr><tr><td style=text-align:center>CKS-node1</td><td style=text-align:center>10.4.7.181</td><td style=text-align:center>ubuntu 20.04</td><td style=text-align:center>1.24.4</td></tr><tr><td style=text-align:center>CKS-node2</td><td style=text-align:center>10.4.7.182</td><td style=text-align:center>ubuntu 20.04</td><td style=text-align:center>1.24.4</td></tr></tbody></table><h3 id=配置前准备>配置前准备</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># 开root用户设置密码</span>
</span></span><span style=display:flex><span>sudo passwd root
</span></span><span style=display:flex><span><span style=color:#75715e># 切换root用户</span>
</span></span><span style=display:flex><span>su - root
</span></span><span style=display:flex><span><span style=color:#75715e># 更新</span>
</span></span><span style=display:flex><span>apt update 
</span></span><span style=display:flex><span><span style=color:#75715e># 安装ssh</span>
</span></span><span style=display:flex><span>apt install ssh -y 
</span></span><span style=display:flex><span><span style=color:#75715e># 允许root用户远程登录</span>
</span></span><span style=display:flex><span>PermitRootLogin yes
</span></span><span style=display:flex><span>UseDNS no
</span></span><span style=display:flex><span><span style=color:#75715e># 重启</span>
</span></span><span style=display:flex><span>systemctl restart ssh
</span></span></code></pre></div><h3 id=配置域名>配置域名</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># 需要对应的机器执行如下命令</span>
</span></span><span style=display:flex><span>hostnamectl set-hostname CKS-master
</span></span><span style=display:flex><span>hostnamectl set-hostname CKS-node1
</span></span><span style=display:flex><span>hostnamectl set-hostname CKS-node2
</span></span></code></pre></div><h3 id=域名解析>域名解析</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>echo -e <span style=color:#e6db74>&#34;10.4.7.180 CKS-master\n10.4.7.181 CKS-node1\n10.4.7.182 CKS-node2&#34;</span> &gt;&gt; /etc/hosts
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 拷贝到远程集群机器</span>
</span></span><span style=display:flex><span>scp /etc/hosts root@10.4.7.181:/etc/
</span></span><span style=display:flex><span>scp /etc/hosts root@10.4.7.182:/etc/
</span></span></code></pre></div><h3 id=初始化部分>初始化部分</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># 关闭防火墙</span>
</span></span><span style=display:flex><span>systemctl stop ufw.service <span style=color:#f92672>&amp;&amp;</span> systemctl disable ufw.service
</span></span><span style=display:flex><span>iptables -F 
</span></span><span style=display:flex><span>iptables-save 
</span></span><span style=display:flex><span><span style=color:#75715e># 关闭swap</span>
</span></span><span style=display:flex><span>swapoff -a
</span></span><span style=display:flex><span>sed -ri <span style=color:#e6db74>&#39;s/.*swap.*/#&amp;/&#39;</span> /etc/fstab
</span></span></code></pre></div><h3 id=vnc服务搭建选做>vnc服务搭建（选做）</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># 安装vnc远程服务</span>
</span></span><span style=display:flex><span>apt install xfce4 xfce4-goodies -y
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 选lightdm</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>apt install tightvncserver -y
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 设置远程密码</span>
</span></span><span style=display:flex><span>123qwe.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 开启远程发现空白</span>
</span></span><span style=display:flex><span>vncserver
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 更改配置文件</span>
</span></span><span style=display:flex><span>mv .vnc/xstartup .vnc/xstartup.bak
</span></span><span style=display:flex><span>nano .vnc/xstartup
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#!/bin/bash</span>
</span></span><span style=display:flex><span>xrdb $HOME/.Xresources
</span></span><span style=display:flex><span>startxfce4 &amp;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 给权限</span>
</span></span><span style=display:flex><span>chmod +x .vnc/xstartup
</span></span><span style=display:flex><span><span style=color:#75715e># 杀进程</span>
</span></span><span style=display:flex><span>vncserver -kill :2
</span></span><span style=display:flex><span><span style=color:#75715e># 再次启动远程</span>
</span></span><span style=display:flex><span>vncserver
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 测试：用vncview连接</span>
</span></span><span style=display:flex><span>ip:2
</span></span></code></pre></div><h2 id=安装containerd>安装containerd</h2><h3 id=运行时runc安装>运行时Runc安装</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># 下载二进制包 https://github.com/opencontainers/runc/releases/download/</span>
</span></span><span style=display:flex><span>wget https://github.com/opencontainers/runc/releases/download/v1.1.3/runc.amd64
</span></span><span style=display:flex><span><span style=color:#75715e># 执行Path和权限设置</span>
</span></span><span style=display:flex><span>mv runc.amd64 /usr/local/sbin/runc 
</span></span><span style=display:flex><span>chmod +x /usr/local/sbin/runc
</span></span></code></pre></div><h3 id=安装前准备>安装前准备</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 添加加载内核模块</span>
</span></span><span style=display:flex><span>cat <span style=color:#e6db74>&lt;&lt; EOF | sudo tee /etc/modules-load.d/containerd.conf
</span></span></span><span style=display:flex><span><span style=color:#e6db74>overlay
</span></span></span><span style=display:flex><span><span style=color:#e6db74>br_netfilter
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 加载内核模块</span>
</span></span><span style=display:flex><span>modprobe overlay
</span></span><span style=display:flex><span>modprobe br_netfilter
</span></span><span style=display:flex><span><span style=color:#75715e>#设置内核参数</span>
</span></span><span style=display:flex><span>cat <span style=color:#e6db74>&lt;&lt; EOF | sudo tee /etc/sysctl.d/99-kubernetes-cri.conf
</span></span></span><span style=display:flex><span><span style=color:#e6db74>net.bridge.bridge-nf-call-iptables  = 1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>net.ipv4.ip_forward                 = 1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>net.bridge.bridge-nf-call-ip6tables = 1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 应用内核参数</span>
</span></span><span style=display:flex><span>sysctl --system
</span></span></code></pre></div><h3 id=开始安装>开始安装</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 下载二进制包 https://github.com/containerd/containerd/releases/</span>
</span></span><span style=display:flex><span>wget https://github.com/containerd/containerd/releases/download/v1.6.8/containerd-1.6.8-linux-amd64.tar.gz
</span></span><span style=display:flex><span><span style=color:#75715e># 解压</span>
</span></span><span style=display:flex><span>tar -zxvf containerd-1.6.8-linux-amd64.tar.gz 
</span></span><span style=display:flex><span><span style=color:#75715e># 执行文件放置系统Path</span>
</span></span><span style=display:flex><span>mv ./bin/* /usr/local/bin/
</span></span><span style=display:flex><span><span style=color:#75715e># systemd 服务启动脚本文件配置</span>
</span></span><span style=display:flex><span>cat &gt; /lib/systemd/system/containerd.service <span style=color:#e6db74>&lt;&lt; EOF
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74># Copyright The containerd Authors.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>#
</span></span></span><span style=display:flex><span><span style=color:#e6db74># Licensed under the Apache License, Version 2.0 (the &#34;License&#34;);
</span></span></span><span style=display:flex><span><span style=color:#e6db74># you may not use this file except in compliance with the License.
</span></span></span><span style=display:flex><span><span style=color:#e6db74># You may obtain a copy of the License at
</span></span></span><span style=display:flex><span><span style=color:#e6db74>#
</span></span></span><span style=display:flex><span><span style=color:#e6db74>#     http://www.apache.org/licenses/LICENSE-2.0
</span></span></span><span style=display:flex><span><span style=color:#e6db74>#
</span></span></span><span style=display:flex><span><span style=color:#e6db74># Unless required by applicable law or agreed to in writing, software
</span></span></span><span style=display:flex><span><span style=color:#e6db74># distributed under the License is distributed on an &#34;AS IS&#34; BASIS,
</span></span></span><span style=display:flex><span><span style=color:#e6db74># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
</span></span></span><span style=display:flex><span><span style=color:#e6db74># See the License for the specific language governing permissions and
</span></span></span><span style=display:flex><span><span style=color:#e6db74># limitations under the License.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>[Unit]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Description=containerd container runtime
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Documentation=https://containerd.io
</span></span></span><span style=display:flex><span><span style=color:#e6db74>After=network.target local-fs.target
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>[Service]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>ExecStartPre=-/sbin/modprobe overlay
</span></span></span><span style=display:flex><span><span style=color:#e6db74>ExecStart=/usr/local/bin/containerd
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Type=notify
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Delegate=yes
</span></span></span><span style=display:flex><span><span style=color:#e6db74>KillMode=process
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Restart=always
</span></span></span><span style=display:flex><span><span style=color:#e6db74>RestartSec=5
</span></span></span><span style=display:flex><span><span style=color:#e6db74># Having non-zero Limit*s causes performance problems due to accounting overhead
</span></span></span><span style=display:flex><span><span style=color:#e6db74># in the kernel. We recommend using cgroups to do container-local accounting.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>LimitNPROC=infinity
</span></span></span><span style=display:flex><span><span style=color:#e6db74>LimitCORE=infinity
</span></span></span><span style=display:flex><span><span style=color:#e6db74>LimitNOFILE=infinity
</span></span></span><span style=display:flex><span><span style=color:#e6db74># Comment TasksMax if your systemd version does not supports it.
</span></span></span><span style=display:flex><span><span style=color:#e6db74># Only systemd 226 and above support this version.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>TasksMax=infinity
</span></span></span><span style=display:flex><span><span style=color:#e6db74>OOMScoreAdjust=-999
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>[Install]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>WantedBy=multi-user.target
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span></code></pre></div><h3 id=检测版本>检测版本</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>runc -v
</span></span><span style=display:flex><span>ctr -v
</span></span></code></pre></div><h3 id=启动关闭服务及查看服务状态>启动、关闭服务及查看服务状态</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>systemctl start containerd
</span></span><span style=display:flex><span>systemctl restart containerd
</span></span><span style=display:flex><span>systemctl status containerd
</span></span><span style=display:flex><span>systemctl enable containerd
</span></span></code></pre></div><h3 id=更换国内镜像仓库>更换国内镜像仓库</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>mkdir -p /etc/containerd/
</span></span><span style=display:flex><span>containerd config default | sudo tee /etc/containerd/config.toml
</span></span><span style=display:flex><span>将
</span></span><span style=display:flex><span>    sandbox_image <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;k8s.gcr.io/pause:3.6&#34;</span>
</span></span><span style=display:flex><span>改为
</span></span><span style=display:flex><span>    sandbox_image <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;registry.aliyuncs.com/google_containers/pause:3.6&#34;</span>
</span></span><span style=display:flex><span>将
</span></span><span style=display:flex><span>    systemd_cgroup <span style=color:#f92672>=</span> false
</span></span><span style=display:flex><span>改为
</span></span><span style=display:flex><span>    systemd_cgroup <span style=color:#f92672>=</span> true
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>重启containerd
</span></span><span style=display:flex><span>systemctl restart containerd
</span></span></code></pre></div><h3 id=安装cni插件选做>安装cni插件(选做)</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>wget https://github.com/containernetworking/plugins/releases/download/v1.1.1/cni-plugins-linux-amd64-v1.1.1.tgz
</span></span><span style=display:flex><span>mkdir -p /opt/cni/bin
</span></span><span style=display:flex><span>tar Cxzvf /opt/cni/bin cni-plugins-linux-amd64-v1.1.1.tgz
</span></span></code></pre></div><h2 id=安装三件套kubectl-kubelet-kubeadm>安装三件套kubectl kubelet kubeadm</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>apt-get update <span style=color:#f92672>&amp;&amp;</span> apt-get install -y apt-transport-https
</span></span><span style=display:flex><span>curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | apt-key add - 
</span></span><span style=display:flex><span>cat <span style=color:#e6db74>&lt;&lt;EOF &gt;/etc/apt/sources.list.d/kubernetes.list
</span></span></span><span style=display:flex><span><span style=color:#e6db74>deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span>apt-get update
</span></span><span style=display:flex><span><span style=color:#75715e># 查看可用版本</span>
</span></span><span style=display:flex><span>apt-cache madison kubelet 
</span></span><span style=display:flex><span>apt-get install -y kubelet kubeadm kubectl
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>systemctl enable kubelet
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># tab补全</span>
</span></span><span style=display:flex><span>apt-get install bash-completion
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>source &lt;<span style=color:#f92672>(</span>kubectl completion bash<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>source &lt;<span style=color:#f92672>(</span>kubeadm completion bash<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 加到.bashrc 里</span>
</span></span><span style=display:flex><span>nano .bashrc
</span></span><span style=display:flex><span>source &lt;<span style=color:#f92672>(</span>kubeadm completion bash<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>source &lt;<span style=color:#f92672>(</span>kubectl completion bash<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 给crictl添加tab补全</span>
</span></span><span style=display:flex><span>source &lt;<span style=color:#f92672>(</span>crictl completion bash<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 加到.bashrc 里</span>
</span></span><span style=display:flex><span>nano .bashrc
</span></span><span style=display:flex><span>source &lt;<span style=color:#f92672>(</span>crictl completion bash<span style=color:#f92672>)</span>
</span></span></code></pre></div><h3 id=运行crictl-images-时报错>运行crictl images 时报错</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>WARN<span style=color:#f92672>[</span>0000<span style=color:#f92672>]</span> image connect using default endpoints: <span style=color:#f92672>[</span>unix:///var/run/dockershim.sock unix:///run/containerd/containerd.sock unix:///run/crio/crio.sock unix:///var/run/cri-dockerd.sock<span style=color:#f92672>]</span>. As the default settings are now deprecated, you should set the endpoint instead. 
</span></span><span style=display:flex><span>ERRO<span style=color:#f92672>[</span>0000<span style=color:#f92672>]</span> unable to determine image API version: rpc error: code <span style=color:#f92672>=</span> Unavailable desc <span style=color:#f92672>=</span> connection error: desc <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;transport: Error while dialing dial unix /var/run/dockershim.sock: connect: no such file or directory&#34;</span> 
</span></span><span style=display:flex><span>E0820 17:31:44.920882    <span style=color:#ae81ff>5408</span> remote_image.go:121<span style=color:#f92672>]</span> <span style=color:#e6db74>&#34;ListImages with filter from image service failed&#34;</span> err<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;rpc error: code = Unimplemented desc = unknown service runtime.v1alpha2.ImageService&#34;</span> filter<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&amp;ImageFilter{Image:&amp;ImageSpec{Image:,Annotations:map[string]string{},},}&#34;</span>
</span></span><span style=display:flex><span>FATA<span style=color:#f92672>[</span>0000<span style=color:#f92672>]</span> listing images: rpc error: code <span style=color:#f92672>=</span> Unimplemented desc <span style=color:#f92672>=</span> unknown service runtime.v1alpha2.ImageService 
</span></span></code></pre></div><h3 id=排错>排错</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>ll /run/containerd/
</span></span><span style=display:flex><span>srw-rw----  <span style=color:#ae81ff>1</span> root root   <span style=color:#ae81ff>0</span> Aug <span style=color:#ae81ff>20</span> 17:20 containerd.sock<span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>crictl config runtime-endpoint unix:///run/containerd/containerd.sock
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 更改配置</span>
</span></span><span style=display:flex><span>nano /etc/crictl.yaml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>runtime-endpoint: <span style=color:#e6db74>&#34;unix:///run/containerd/containerd.sock&#34;</span>
</span></span><span style=display:flex><span>image-endpoint: <span style=color:#e6db74>&#34;unix:///run/containerd/containerd.sock&#34;</span>
</span></span><span style=display:flex><span>timeout: <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 重新加载</span>
</span></span><span style=display:flex><span>systemctl daemon-reload
</span></span><span style=display:flex><span><span style=color:#75715e># 发现还是报错</span>
</span></span><span style=display:flex><span>E0820 17:37:56.265740    <span style=color:#ae81ff>5708</span> remote_image.go:121<span style=color:#f92672>]</span> <span style=color:#e6db74>&#34;ListImages with filter from image service failed&#34;</span> err<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;rpc error: code = Unimplemented desc = unknown service runtime.v1alpha2.ImageService&#34;</span> filter<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&amp;ImageFilter{Image:&amp;ImageSpec{Image:,Annotations:map[string]string{},},}&#34;</span>
</span></span><span style=display:flex><span>FATA<span style=color:#f92672>[</span>0000<span style=color:#f92672>]</span> listing images: rpc error: code <span style=color:#f92672>=</span> Unimplemented desc <span style=color:#f92672>=</span> unknown service runtime.v1alpha2.ImageService 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 这是因为还需要手动设置runtime_type</span>
</span></span><span style=display:flex><span>nano /etc/containerd/config.toml
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>plugins.<span style=color:#e6db74>&#34;io.containerd.grpc.v1.cri&#34;</span>.containerd.default_runtime<span style=color:#f92672>]</span> 下的
</span></span><span style=display:flex><span>        runtime_type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>改成
</span></span><span style=display:flex><span>        runtime_type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;io.containerd.runtime.v1.linux&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 重启containerd </span>
</span></span><span style=display:flex><span>systemctl daemon-reload
</span></span><span style=display:flex><span>systemctl restart containerd
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 正常了</span>
</span></span><span style=display:flex><span>root@cks-master:~# crictl images
</span></span><span style=display:flex><span>IMAGE               TAG                 IMAGE ID            SIZE
</span></span></code></pre></div><h3 id=集群初始化cks-master上操作>集群初始化（cks-master上操作）</h3><p><code>kubeadm config print init-defaults > init.yaml nano init.yaml</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>  advertiseAddress: 10.4.7.180
</span></span><span style=display:flex><span>  name: cks-master
</span></span><span style=display:flex><span>imageRepository: registry.aliyuncs.com/google_containers
</span></span><span style=display:flex><span>kubernetesVersion: 1.24.4
</span></span></code></pre></div><p><code>kubeadm init --config=init.yaml</code></p><h4 id=各个节点加入集群>各个节点加入集群</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubeadm join 10.4.7.180:6443 --token abcdef.0123456789abcdef <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	--discovery-token-ca-cert-hash sha256:96f4398d1e19fbaed92c0401a2d38031f89470dc1faf84669306c6d85ba8cc45
</span></span></code></pre></div><p>master 节点上输入以下命令，用kubectl 控制集群。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  mkdir -p $HOME/.kube
</span></span><span style=display:flex><span>  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
</span></span><span style=display:flex><span>  sudo chown <span style=color:#66d9ef>$(</span>id -u<span style=color:#66d9ef>)</span>:<span style=color:#66d9ef>$(</span>id -g<span style=color:#66d9ef>)</span> $HOME/.kube/config
</span></span></code></pre></div><h4 id=安装cni插件calico>安装cni插件（calico）</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>https://projectcalico.docs.tigera.io/getting-started/kubernetes/self-managed-onprem/onpremises
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># 小于50个node用这个连接</span>
</span></span><span style=display:flex><span>curl https://raw.githubusercontent.com/projectcalico/calico/v3.24.0/manifests/calico.yaml -O
</span></span></code></pre></div><h4 id=更改calicoyaml-文件>更改calico.yaml 文件</h4><p>nano 用<code>ctrl+ w</code>搜索。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>            - name: CALICO_IPV4POOL_CIDR
</span></span><span style=display:flex><span>              value: <span style=color:#e6db74>&#34;10.96.0.0/12&#34;</span>
</span></span></code></pre></div><p>开始创建</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl apply -f calico.yaml
</span></span></code></pre></div><p>等待慢慢创建pod</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl get po -A 
</span></span></code></pre></div><p>都running后集群搭建成功</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>root@cks-master:~# kubectl get po -A -w
</span></span><span style=display:flex><span>NAMESPACE     NAME                                       READY   STATUS    RESTARTS   AGE
</span></span><span style=display:flex><span>kube-system   calico-kube-controllers-5b97f5d8cf-glx5x   1/1     Running   <span style=color:#ae81ff>0</span>          15m
</span></span><span style=display:flex><span>kube-system   calico-node-87vt9                          1/1     Running   <span style=color:#ae81ff>0</span>          15m
</span></span><span style=display:flex><span>kube-system   calico-node-dd8nk                          1/1     Running   <span style=color:#ae81ff>0</span>          15m
</span></span><span style=display:flex><span>kube-system   calico-node-jgmfk                          1/1     Running   <span style=color:#ae81ff>0</span>          15m
</span></span><span style=display:flex><span>kube-system   coredns-74586cf9b6-46xtt                   1/1     Running   <span style=color:#ae81ff>0</span>          27m
</span></span><span style=display:flex><span>kube-system   coredns-74586cf9b6-7jkkd                   1/1     Running   <span style=color:#ae81ff>0</span>          27m
</span></span><span style=display:flex><span>kube-system   etcd-cks-master                            1/1     Running   <span style=color:#ae81ff>0</span>          27m
</span></span><span style=display:flex><span>kube-system   kube-apiserver-cks-master                  1/1     Running   <span style=color:#ae81ff>0</span>          27m
</span></span><span style=display:flex><span>kube-system   kube-controller-manager-cks-master         1/1     Running   <span style=color:#ae81ff>0</span>          27m
</span></span><span style=display:flex><span>kube-system   kube-proxy-dhgbc                           1/1     Running   <span style=color:#ae81ff>0</span>          24m
</span></span><span style=display:flex><span>kube-system   kube-proxy-pvkgx                           1/1     Running   <span style=color:#ae81ff>0</span>          27m
</span></span><span style=display:flex><span>kube-system   kube-proxy-zckg5                           1/1     Running   <span style=color:#ae81ff>0</span>          24m
</span></span><span style=display:flex><span>kube-system   kube-scheduler-cks-master                  1/1     Running   <span style=color:#ae81ff>0</span>          27m
</span></span></code></pre></div><p>由于<code>coredns</code>都在被分配在同一个节点上，没冗余，需要重新分配在不同节点上。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>root@cks-master:~# kubectl get po -A -owide | grep coredns
</span></span><span style=display:flex><span>kube-system   coredns-74586cf9b6-46xtt                   1/1     Running   <span style=color:#ae81ff>0</span>          30m   10.106.109.130   cks-node2    &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>kube-system   coredns-74586cf9b6-7jkkd                   1/1     Running   <span style=color:#ae81ff>0</span>          30m   10.106.109.131   cks-node2    &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><h4 id=重新分配coredns>重新分配coredns</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>root@cks-master:~# kubectl -n kube-system rollout restart deployment coredns 
</span></span><span style=display:flex><span>root@cks-master:~# kubectl get po -A -owide -w | grep coredns 
</span></span><span style=display:flex><span>kube-system   coredns-75ffbc4979-gjxjn                   1/1     Running   <span style=color:#ae81ff>0</span>          2m37s   10.106.109.132   cks-node2    &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>kube-system   coredns-75ffbc4979-pbfmt                   1/1     Running   <span style=color:#ae81ff>0</span>          2m37s   10.104.127.129   cks-node1    &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><h4 id=延长证书有效期>延长证书有效期</h4><p>证书默认1年后就会过期。可以通过如下方式修改为10年。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ cd /etc/kubernetes/pki
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看当前证书有效期</span>
</span></span><span style=display:flex><span>$ <span style=color:#66d9ef>for</span> i in <span style=color:#66d9ef>$(</span>ls *.crt<span style=color:#66d9ef>)</span>; <span style=color:#66d9ef>do</span> echo <span style=color:#e6db74>&#34;===== </span>$i<span style=color:#e6db74> =====&#34;</span>; openssl x509 -in $i -text -noout | grep -A <span style=color:#ae81ff>3</span> <span style=color:#e6db74>&#39;Validity&#39;</span> ; <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ mkdir backup_key; cp -rp ./* backup_key/
</span></span><span style=display:flex><span>$ git clone https://github.com/yuyicai/update-kube-cert.git
</span></span><span style=display:flex><span>$ cd update-kube-cert/ 
</span></span><span style=display:flex><span>$ bash update-kubeadm-cert.sh all
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 重建管理服务</span>
</span></span><span style=display:flex><span>$ kubectl -n kube-system delete po kube-apiserver-k8s-master kube-controller-manager-k8s-master kube-scheduler-k8s-master
</span></span></code></pre></div><h3 id=部署dashboardk8s-可视化页面>部署dashboard（k8s 可视化页面）</h3><p>github上搜索dashboard</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>https://github.com/kubernetes/dashboard/blob/master/docs/user/installation.md
</span></span></code></pre></div><p>下载默认配置文件</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>https://raw.githubusercontent.com/kubernetes/dashboard/v2.6.1/aio/deploy/recommended.yaml
</span></span></code></pre></div><p>不用更改配置直接部署,等待部署完成。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl apply -f recommended.yaml
</span></span></code></pre></div><p>默认部署后dashboard是ClusterIP 类型，只允许集群内部访问。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>root@cks-master:~# kubectl -n kubernetes-dashboard get svc 
</span></span><span style=display:flex><span>NAME                        TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span style=color:#f92672>(</span>S<span style=color:#f92672>)</span>    AGE
</span></span><span style=display:flex><span>dashboard-metrics-scraper   ClusterIP   10.96.205.151   &lt;none&gt;        8000/TCP   14m
</span></span><span style=display:flex><span>kubernetes-dashboard        ClusterIP   10.110.3.32     &lt;none&gt;        443/TCP    14m
</span></span></code></pre></div><p>更改类型为NodePort，暴露端口，可以在集群外部访问。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>root@cks-master:~# kubectl -n kubernetes-dashboard edit svc kubernetes-dashboard
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  ports:
</span></span><span style=display:flex><span>  - port: <span style=color:#ae81ff>443</span>
</span></span><span style=display:flex><span>    protocol: TCP
</span></span><span style=display:flex><span>    targetPort: <span style=color:#ae81ff>8443</span>
</span></span><span style=display:flex><span>    nodePort: <span style=color:#ae81ff>30003</span>
</span></span><span style=display:flex><span>  selector:
</span></span><span style=display:flex><span>    k8s-app: kubernetes-dashboard
</span></span><span style=display:flex><span>  sessionAffinity: None
</span></span><span style=display:flex><span>  type: Nodeport
</span></span></code></pre></div><p>保存退出会自动重启pod</p><p>此时可以用ip+端口号形式访问dashboard.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>root@cks-master:~# kubectl -n kubernetes-dashboard get svc -w 
</span></span><span style=display:flex><span>NAME                        TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span style=color:#f92672>(</span>S<span style=color:#f92672>)</span>         AGE
</span></span><span style=display:flex><span>dashboard-metrics-scraper   ClusterIP   10.96.205.151   &lt;none&gt;        8000/TCP        46m
</span></span><span style=display:flex><span>kubernetes-dashboard        NodePort    10.110.3.32     &lt;none&gt;        443:30003/TCP   46m
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>https://10.4.7.180:30003
</span></span></code></pre></div><p>然后使用token来登录</p><h4 id=登录前根据官方文档要先创建用户>登录前根据官方文档要先创建用户</h4><p>官网说明</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>https://github.com/kubernetes/dashboard/blob/master/docs/user/access-control/creating-sample-user.md
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>admin.yaml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: ServiceAccount
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: admin-user
</span></span><span style=display:flex><span>  namespace: kubernetes-dashboard
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>apiVersion: rbac.authorization.k8s.io/v1
</span></span><span style=display:flex><span>kind: ClusterRoleBinding
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: admin-user
</span></span><span style=display:flex><span>roleRef:
</span></span><span style=display:flex><span>  apiGroup: rbac.authorization.k8s.io
</span></span><span style=display:flex><span>  kind: ClusterRole
</span></span><span style=display:flex><span>  name: cluster-admin
</span></span><span style=display:flex><span>subjects:
</span></span><span style=display:flex><span>- kind: ServiceAccount
</span></span><span style=display:flex><span>  name: admin-user
</span></span><span style=display:flex><span>  namespace: kubernetes-dashboard
</span></span></code></pre></div><p>创建用户</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl apply -f admin.yaml
</span></span></code></pre></div><p>查看</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>root@cks-master:~# kubectl -n kubernetes-dashboard get sa
</span></span><span style=display:flex><span>NAME                   SECRETS   AGE
</span></span><span style=display:flex><span>admin-user             <span style=color:#ae81ff>0</span>         66s
</span></span><span style=display:flex><span>default                <span style=color:#ae81ff>0</span>         56m
</span></span><span style=display:flex><span>kubernetes-dashboard   <span style=color:#ae81ff>0</span>         56m
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 1.24版本已经默认不支持自动创建token，需要手动创建</span>
</span></span><span style=display:flex><span>root@cks-master:~# kubectl -n kubernetes-dashboard describe sa admin-user 
</span></span><span style=display:flex><span>Name:                admin-user
</span></span><span style=display:flex><span>Namespace:           kubernetes-dashboard
</span></span><span style=display:flex><span>Labels:              &lt;none&gt;
</span></span><span style=display:flex><span>Annotations:         &lt;none&gt;
</span></span><span style=display:flex><span>Image pull secrets:  &lt;none&gt;
</span></span><span style=display:flex><span>Mountable secrets:   &lt;none&gt;
</span></span><span style=display:flex><span>Tokens:              &lt;none&gt;
</span></span><span style=display:flex><span>Events:              &lt;none&gt;
</span></span></code></pre></div><p>手动创建token</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>root@cks-master:~# kubectl -n kubernetes-dashboard create token admin-user 
</span></span><span style=display:flex><span>eyJhbGciOiJSUzI1NiIsImtpZCI6ImVlLTUwa0JWcm5seXlfemJ2Ui15MnpuTXJQVXctLXVPWFBsc3IzQl92dTAifQ.eyJhdWQiOlsiaHR0cHM6Ly9rdWJlcm5ldGVzLmRlZmF1bHQuc3ZjLmNsdXN0ZXIubG9jYWwiXSwiZXhwIjoxNjYxMDA4NzkzLCJpYXQiOjE2NjEwMDUxOTMsImlzcyI6Imh0dHBzOi8va3ViZXJuZXRlcy5kZWZhdWx0LnN2Yy5jbHVzdGVyLmxvY2FsIiwia3ViZXJuZXRlcy5pbyI6eyJuYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsInNlcnZpY2VhY2NvdW50Ijp7Im5hbWUiOiJhZG1pbi11c2VyIiwidWlkIjoiNmE3YWU1ODAtNDhiNi00NGVmLWFmNzUtNjY2MTQzOGUzMTcyIn19LCJuYmYiOjE2NjEwMDUxOTMsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlcm5ldGVzLWRhc2hib2FyZDphZG1pbi11c2VyIn0.kvcfZmYX_CbX6_qaV1GQrT6Z7FCjGwOvG40OZ1cMEUhNQdV9G5XuCjSMJ4FrnKsiNOcSLv6_wdwWMZpWIgvbWYbBJQQ7Q-0Djie_iPzbGbJKbEvEsaNMLqIb7liiM52nKl0TJJweQpIoUHHWf0oRiGDjSkms5QVqDmlddnr5i8z2NotwW7FyIfml1E_OZFCQ-vHnVlo8ONGflkJyAutqGxRghBOBMuInMKSXfpk3AaXf6cjtButHRVqp_jDgErVVkKqtRJrqSHoDwMBV7NRn__fqdrfCGiEVKYlucMdv78TgKPsK2313OE3Arbrf0q_prP3Cs6VAILHETGdmhNHFlA
</span></span></code></pre></div><p>使用token登录dashboard</p><p>每次登录都需要重新创建token</p><p>k8s 不能干什么？</p><p>修改内核的应用</p><p>不建议部署数据库,很容易丢数据。</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2022-08-22</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=http://example.org/posts/cks%E5%88%9D%E5%A7%8B%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/ data-title=CKS初始环境搭建><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=http://example.org/posts/cks%E5%88%9D%E5%A7%8B%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=http://example.org/posts/cks%E5%88%9D%E5%A7%8B%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/ data-title=CKS初始环境搭建><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=http://example.org/posts/cks%E5%88%9D%E5%A7%8B%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/ data-title=CKS初始环境搭建><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=http://example.org/posts/cks%E5%88%9D%E5%A7%8B%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/ data-title=CKS初始环境搭建><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/python%E5%A4%9A%E7%BA%BF%E7%A8%8B/ class=prev rel=prev title=python多线程><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>python多线程</a>
<a href=/posts/%E4%BD%BF%E7%94%A8python%E5%AE%9E%E7%8E%B0unix%E6%97%B6%E9%97%B4%E6%88%B3%E8%BD%AC%E6%8D%A2/ class=next rel=next title=使用python实现unix时间戳转换>使用python实现unix时间戳转换<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.115.3">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank></a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>