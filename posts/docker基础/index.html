<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>docker基础 - My New Hugo Site</title><meta name=Description content="This is my cool site"><meta property="og:title" content="docker基础"><meta property="og:description" content="安装及命令 Docker命令 常用 docker version docker info docker pull docker login docker logout docker images docker ps -a docker start|stop|restart docker rm xxxx docker rmi xxxx docker exec -it `name OR id` /bin/bash 批量停止删除容器和镜像 停止所有容器
docker stop $(docker ps -aq) 删除所有的容器
docker rm $(docker ps -aq) 删除所有的镜像
docker rmi $(docker images -q) Docker目录拷贝 本机/root/test目录拷贝到容器内/root目录内
docker cp /root/test 28a186bbebd4:/root/ 本机/root/test目录拷贝到容器内,并更名为/test123.注意命令后没有/.
docker cp /root/test 28a186bbebd4:/test123 将容器内的/test目录拷贝到主机的/root目录内.
docker cp 28a186bbebd4:/test /root/ Docker 文件拷贝 本机1."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.haipengv.com/posts/docker%E5%9F%BA%E7%A1%80/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-02-24T20:51:17+00:00"><meta property="article:modified_time" content="2022-02-24T20:51:17+00:00"><meta property="og:site_name" content="My cool site"><meta name=twitter:card content="summary"><meta name=twitter:title content="docker基础"><meta name=twitter:description content="安装及命令 Docker命令 常用 docker version docker info docker pull docker login docker logout docker images docker ps -a docker start|stop|restart docker rm xxxx docker rmi xxxx docker exec -it `name OR id` /bin/bash 批量停止删除容器和镜像 停止所有容器
docker stop $(docker ps -aq) 删除所有的容器
docker rm $(docker ps -aq) 删除所有的镜像
docker rmi $(docker images -q) Docker目录拷贝 本机/root/test目录拷贝到容器内/root目录内
docker cp /root/test 28a186bbebd4:/root/ 本机/root/test目录拷贝到容器内,并更名为/test123.注意命令后没有/.
docker cp /root/test 28a186bbebd4:/test123 将容器内的/test目录拷贝到主机的/root目录内.
docker cp 28a186bbebd4:/test /root/ Docker 文件拷贝 本机1."><meta name=application-name content="My cool site"><meta name=apple-mobile-web-app-title content="My cool site"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://blog.haipengv.com/posts/docker%E5%9F%BA%E7%A1%80/><link rel=prev href=https://blog.haipengv.com/posts/harbor%E4%BD%BF%E7%94%A8%E8%87%AA%E7%AD%BE%E5%90%8D%E8%AF%81%E4%B9%A6%E5%AE%9E%E7%8E%B0https%E7%99%BB%E5%BD%95/><link rel=next href=https://blog.haipengv.com/posts/jupyter%E6%9B%B4%E6%94%B9%E7%99%BB%E5%BD%95%E5%AF%86%E7%A0%81/><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"docker基础","inLanguage":"en-us","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.haipengv.com\/posts\/docker%E5%9F%BA%E7%A1%80\/"},"genre":"posts","wordcount":944,"url":"https:\/\/blog.haipengv.com\/posts\/docker%E5%9F%BA%E7%A1%80\/","datePublished":"2022-02-24T20:51:17+00:00","dateModified":"2022-02-24T20:51:17+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Author"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="My New Hugo Site">My cool site</a></div><div class=menu><div class=menu-inner><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="My New Hugo Site">My cool site</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">docker基础</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Author</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2022-02-24>2022-02-24</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;944 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;5 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#安装及命令>安装及命令</a><ul><li><a href=#docker命令>Docker命令</a></li><li><a href=#docker镜像>Docker镜像</a></li><li><a href=#导入导出镜像>导入导出镜像</a></li><li><a href=#docker-hub>Docker hub</a></li><li><a href=#docker安装>Docker安装</a></li><li><a href=#docker启动命令>Docker启动命令</a></li><li><a href=#docker-compose-安装>Docker-compose 安装</a></li><li><a href=#docker配置镜像加速及私有仓库>Docker配置镜像加速及私有仓库</a></li><li><a href=#配置镜像加速>配置镜像加速</a></li><li><a href=#私有镜像加速>私有镜像加速</a></li><li><a href=#配置私有仓库>配置私有仓库</a></li></ul></li><li><a href=#docker迁移varlibdocker目录>Docker迁移/var/lib/docker目录</a><ul><li><a href=#前言>前言</a></li><li><a href=#docker-私有镜像仓库>Docker 私有镜像仓库</a></li><li><a href=#配置客户端>配置客户端</a></li><li><a href=#使用>使用</a></li></ul></li></ul></nav></div></div><div class=content id=content><h2 id=安装及命令>安装及命令</h2><h3 id=docker命令>Docker命令</h3><h4 id=常用>常用</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker version  
</span></span><span style=display:flex><span>docker info  
</span></span><span style=display:flex><span>docker pull  
</span></span><span style=display:flex><span>docker login  
</span></span><span style=display:flex><span>docker logout  
</span></span><span style=display:flex><span>docker images  
</span></span><span style=display:flex><span>docker ps -a  
</span></span><span style=display:flex><span>docker start|stop|restart  
</span></span><span style=display:flex><span>docker rm xxxx  
</span></span><span style=display:flex><span>docker rmi xxxx  
</span></span><span style=display:flex><span>docker exec -it <span style=color:#e6db74>`</span>name OR id<span style=color:#e6db74>`</span> /bin/bash
</span></span></code></pre></div><h4 id=批量停止删除容器和镜像>批量停止删除容器和镜像</h4><p>停止所有容器</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker stop <span style=color:#66d9ef>$(</span>docker ps -aq<span style=color:#66d9ef>)</span>
</span></span></code></pre></div><p>删除所有的容器</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker rm <span style=color:#66d9ef>$(</span>docker ps -aq<span style=color:#66d9ef>)</span>
</span></span></code></pre></div><p>删除所有的镜像</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker rmi <span style=color:#66d9ef>$(</span>docker images -q<span style=color:#66d9ef>)</span>
</span></span></code></pre></div><h4 id=docker目录拷贝>Docker目录拷贝</h4><p>本机<code>/root/test</code>目录拷贝到容器内<code>/root</code>目录内</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker cp /root/test 28a186bbebd4:/root/
</span></span></code></pre></div><p>本机<code>/root/test</code>目录拷贝到容器内,并更名为<code>/test123</code>.注意命令后没有<code>/</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker cp /root/test 28a186bbebd4:/test123
</span></span></code></pre></div><p>将容器内的<code>/test</code>目录拷贝到主机的<code>/root</code>目录内.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker cp  28a186bbebd4:/test /root/
</span></span></code></pre></div><h4 id=docker-文件拷贝>Docker 文件拷贝</h4><p>本机<code>1.db</code>文件拷贝到容器内<code>root</code>目录内.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker cp 1.db 28a186bbebd4:/root/
</span></span></code></pre></div><p>将容器内的<code>/root/1.db</code>文件拷贝到主机的当前目录.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker cp 28a186bbebd4:/root/1.db .
</span></span></code></pre></div><h4 id=docker命令补全>Docker命令补全</h4><p>安装 bash-completion</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo yum install -y bash-completion
</span></span></code></pre></div><p>根据官方文档进一步配置</p><p><a href=https://gdevillele.github.io/compose/completion/ target=_blank rel="noopener noreffer">官网链接</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -L https://raw.githubusercontent.com/docker/compose/<span style=color:#66d9ef>$(</span>docker-compose version --short<span style=color:#66d9ef>)</span>/contrib/completion/bash/docker-compose &gt; /etc/bash_completion.d/docker-compose
</span></span></code></pre></div><p>重新进入终端即可补全命令。</p><h3 id=docker镜像>Docker镜像</h3><h4 id=容器创建镜像>容器创建镜像</h4><p>通过容器提交生成镜像</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker commit 容器名 镜像名
</span></span></code></pre></div><p>保存镜像到文件</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker save 镜像名 &gt; 文件名.tar 
</span></span></code></pre></div><p>从文件恢复到镜像</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker load &lt; 文件名.tar
</span></span></code></pre></div><p>通过镜像启动新容器</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker run --name 容器名 相关参数 最后接新的镜像名
</span></span></code></pre></div><p>例如</p><p>赋予容器所有权限</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker run -it --name test -d --privileged<span style=color:#f92672>=</span>true centos:7.6.1810 /usr/sbin/init 
</span></span></code></pre></div><p>容器暴露端口给外面访问,容器内20、80，容器外2000、8080</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker run -it --name test -p 2000:20 -p 8080:80 -d centos:7.6.1810 /usr/sbin/init
</span></span></code></pre></div><p>容器不间断运行，docker重启容器会自动重启不用人工干预。</p><p>做数据持久化存储。本地目录容器目录映射。容器内端口5000 容器外端口5000。</p><p>容器内目录：/var/lib/registry</p><p>容器外目录：/opt/registry</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker run -it --name registry -v /opt/registry:/var/lib/registry -p 5000:5000 --restart<span style=color:#f92672>=</span>always registry
</span></span></code></pre></div><p>退出容器后立即销毁</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker run -it --rm --name test2 alpine sh
</span></span></code></pre></div><p>进入容器</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker exec -it 容器名/容器id /bin/bash 
</span></span></code></pre></div><h3 id=导入导出镜像>导入导出镜像</h3><p>导出镜像</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker images
</span></span><span style=display:flex><span><span style=color:#75715e># 查看IMAGE ID</span>
</span></span><span style=display:flex><span>docker save bb2b73d4a4a6 &gt; xxx.tar
</span></span></code></pre></div><p>导入镜像</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker load &lt; xxx.tar
</span></span></code></pre></div><p>修改镜像名</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker tag bb2b73d4a4a6 xxx/xxx:latest
</span></span></code></pre></div><h3 id=docker-hub>Docker hub</h3><h4 id=上传本地镜像>上传本地镜像</h4><p>登录</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker login -u 用户名 ip/域名 -p 密码
</span></span></code></pre></div><p>上传镜像前打标签</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker tag SOURCE_IMAGE<span style=color:#f92672>[</span>:TAG<span style=color:#f92672>]</span> harbor.lhp.com/images/IMAGE<span style=color:#f92672>[</span>:TAG<span style=color:#f92672>]</span>
</span></span></code></pre></div><p>上传镜像</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker push harbor.lhp.com/images/IMAGE<span style=color:#f92672>[</span>:TAG<span style=color:#f92672>]</span>
</span></span></code></pre></div><p>下载镜像</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker pull harbor.lhp.com/images/alpine:latest
</span></span></code></pre></div><p>登录成功信息查看</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat /root/.docker/config.json
</span></span><span style=display:flex><span>auth后面字段可以用base64进行解码
</span></span><span style=display:flex><span><span style=color:#75715e>#加密</span>
</span></span><span style=display:flex><span>echo test|base64
</span></span><span style=display:flex><span>dGVzdAo<span style=color:#f92672>=</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#解密</span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;YWRtaW46SGFyYm9yMTIzNDU=&#34;</span> | base64 -d
</span></span></code></pre></div><h4 id=自动构建镜像>自动构建镜像</h4><p>Docker hub创建仓库</p><ul><li>链接 GitHub</li><li>配置 Build Rules</li></ul><table><thead><tr><th><strong>Source Type</strong></th><th><strong>Source</strong></th><th><strong>Docker Tag</strong></th><th><strong>Dockerfile location</strong></th></tr></thead><tbody><tr><td>Branch</td><td>Master</td><td>Latest</td><td>/</td></tr><tr><td>Tag</td><td>/^v([0-9.]+)$/</td><td>{\1}</td><td>/</td></tr></tbody></table><p>Tag</p><p>Github Tag</p><ul><li><code>/^v([0-9.]+)$/</code> 对应 v1.0 或 v1.0.0</li><li><code>/^([0-9.]+)$/</code> 对应 1.0 或 1.0.0</li><li><code>/^([0-9]+)$/</code> 对应 20210101</li></ul><p>Docker Tag</p><ul><li><code>{sourceref}</code> 对应 Github Tag</li><li><code>{\1}</code> 对应 Github Tag 去除 v</li></ul><p>Github push</p><ul><li>正常 commit 并 push 到 GitHub</li><li>Docker Hub 自动构建 master 分支为 latest 镜像</li><li>本地 tag commit 并 push tag</li><li>Docker Hub 自动构建 tag 标签为 tag名 镜像</li></ul><p>创建标签</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>git log
</span></span><span style=display:flex><span><span style=color:#75715e># 复制 commit ID</span>
</span></span><span style=display:flex><span>git tag -a v1.0.0 commitID -m <span style=color:#e6db74>&#34;v1.0.0&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 本地 tag 版本号标签</span>
</span></span><span style=display:flex><span>git push origin v1.0.0 
</span></span><span style=display:flex><span><span style=color:#75715e># 提交本地标签到 GitHub</span>
</span></span></code></pre></div><p>删除标签</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>git tag -d 标签名
</span></span><span style=display:flex><span>git push origin :refs/tags/标签名
</span></span></code></pre></div><h3 id=docker安装>Docker安装</h3><h4 id=docker官方脚本安装>Docker官方脚本安装</h4><p>下载一键安装脚本</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -fsSL https://get.docker.com -o get-docker.sh
</span></span></code></pre></div><p>运行一键安装脚本(阿里云加速镜像)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo sh get-docker.sh --mirror Aliyun
</span></span></code></pre></div><h4 id=docker官方手动升级>Docker官方手动升级</h4><p>升级yum</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>yum update
</span></span></code></pre></div><p>安装依赖包</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo yum install -y yum-utils <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  device-mapper-persistent-data <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  lvm2
</span></span></code></pre></div><p>配置仓库(国内用户推荐使用下面阿里云加速镜像)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo yum-config-manager <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --add-repo <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    https://download.docker.com/linux/centos/docker-ce.repo
</span></span></code></pre></div><p>配置仓库(阿里云加速镜像)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo yum-config-manager <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --add-repo <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
</span></span></code></pre></div><p>排序查看仓库内文件</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>yum list docker-ce --showduplicates | sort -r
</span></span></code></pre></div><p>安装最新版Docker</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo yum install docker-ce docker-ce-cli containerd.io
</span></span></code></pre></div><h3 id=docker启动命令>Docker启动命令</h3><p>启动Docker</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo systemctl start docker
</span></span><span style=display:flex><span>或
</span></span><span style=display:flex><span>sudo /etc/init.d/docker restart
</span></span></code></pre></div><p>查看Docker版本</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo docker version
</span></span></code></pre></div><p>设置Docker开机自动启动</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo systemctl enable docker
</span></span></code></pre></div><h3 id=docker-compose-安装>Docker-compose 安装</h3><ol><li>官方安装 - 速度慢,有可能被DNS污染导致失败.</li><li>手动安装 - 手动下载,离线安装.</li><li>PIP 在线安装 - 使用 Python 的 pip 包管理工具在线安装.</li></ol><h4 id=官方安装>官方安装</h4><p>官网选择版本 <a href=https://github.com/docker/compose/releases target=_blank rel="noopener noreffer">https://github.com/docker/compose/releases</a>
<strong>以下命令手动修改版本号,例如<code>v2.2.3</code></strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -L https://github.com/docker/compose/releases/download/v2.2.3/docker-compose-<span style=color:#e6db74>`</span>uname -s<span style=color:#e6db74>`</span>-<span style=color:#e6db74>`</span>uname -m<span style=color:#e6db74>`</span> -o /usr/local/bin/docker-compose
</span></span></code></pre></div><p>执行权限</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>chmod +x /usr/local/bin/docker-compose
</span></span></code></pre></div><p>检查 docker compose 版本</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker-compose version
</span></span></code></pre></div><h4 id=手动安装>手动安装</h4><p>官网选择版本 <a href=https://github.com/docker/compose/releases target=_blank rel="noopener noreffer">https://github.com/docker/compose/releases</a>
选择相应版本,下载到本地或者服务器中.
更名为<code>docker-compose</code>,并移动到<code>/usr/local/bin</code>目录下.</p><p>添加执行权限</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>chmod +x /usr/local/bin/docker-compose
</span></span></code></pre></div><p>检查 docker compose 版本</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker-compose version
</span></span></code></pre></div><h4 id=pip在线安装>pip在线安装</h4><p>安装依赖</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>yum -y install epel-release
</span></span></code></pre></div><p>安装 PIP</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>yum -y install python-pip
</span></span></code></pre></div><p>升级 PIP</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>pip install --upgrade pip
</span></span></code></pre></div><p>升级报错</p><p>You are using pip version 8.1.2, however version 22.0.3 is available</p><p>解决</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl https://bootstrap.pypa.io/pip/2.7/get-pip.py &gt;&gt; get-pip.py
</span></span><span style=display:flex><span>python get-pip.py
</span></span></code></pre></div><p>3.6版本的get-pip.py</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl https://bootstrap.pypa.io/get-pip.py &gt;&gt; get-pip.py
</span></span><span style=display:flex><span>python get-pip.py
</span></span></code></pre></div><p>检查 PIP 版本</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>pip --version
</span></span><span style=display:flex><span>pip 21.3.1 from /usr/local/lib/python3.6/site-packages/pip <span style=color:#f92672>(</span>python 3.6<span style=color:#f92672>)</span>
</span></span></code></pre></div><p>安装 docker compose。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>pip install -U docker-compose
</span></span></code></pre></div><p>检查 docker compose 版本</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker-compose version
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker-compose version 1.29.2, build unknown
</span></span><span style=display:flex><span>docker-py version: 5.0.3
</span></span><span style=display:flex><span>CPython version: 3.6.8
</span></span><span style=display:flex><span>OpenSSL version: OpenSSL 1.0.2k-fips  <span style=color:#ae81ff>26</span> Jan <span style=color:#ae81ff>2017</span>
</span></span></code></pre></div><h3 id=docker配置镜像加速及私有仓库>Docker配置镜像加速及私有仓库</h3><p>配置保存命令</p><p>配置<code>daemon.json</code>需要重载并重启生效</p><p>编辑 daemon.json</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>vi /etc/docker/daemon.json
</span></span></code></pre></div><p>重新加载 daemon.json</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo systemctl daemon-reload
</span></span></code></pre></div><p>重启 Docker</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo systemctl restart docker
</span></span></code></pre></div><h3 id=配置镜像加速>配置镜像加速</h3><p>公共镜像加速</p><p>添加<code>Docker 中国官方镜像加速</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;registry-mirrors&#34;</span>: [<span style=color:#e6db74>&#34;https://registry.docker-cn.com&#34;</span>]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>更多公共镜像加速服务</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;registry-mirrors&#34;</span>: [
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;https://hub-mirror.c.163.com&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;https://mirror.baidubce.com&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;https://registry.docker-cn.com&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;https://reg-mirror.qiniu.com&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;https://dockerhub.azk8s.cn&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;https://docker.mirrors.ustc.edu.cn&#34;</span>
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=私有镜像加速>私有镜像加速</h3><p>可使用<code>IP</code>或<code>反向代理域名</code>来配置私有镜像加速服务.
请注意镜像加速的 HTTP/HTTPS 协议,以及开放防火墙端口.</p><p>私有域名镜像加速</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;registry-mirrors&#34;</span>: <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;https://registry.yourdomain.com&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>私有IP镜像加速</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;registry-mirrors&#34;</span>: <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;http://101.102.103.104:5000&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=配置私有仓库>配置私有仓库</h3><p>私有仓库可以使用<code>内网 IP</code>和<code>公网 IP</code>的形式配置.</p><p>使用反向代理配置了域名的私有仓库无需配置<code>daemon.json</code>.</p><p>内网IP</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;insecure-registries&#34;</span>: <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;192.168.1.5:5000&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>公网IP</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;insecure-registries&#34;</span>: <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;101.102.103.104:5000&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>同时配置镜像加速和私有仓库</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;registry-mirrors&#34;</span>: <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;https://registry.yourdomain.com&#34;</span><span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;insecure-registries&#34;</span>: <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;192.168.1.5:5000&#34;</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>更多的镜像加速服务和私有仓库</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;registry-mirrors&#34;</span>: [
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;https://registry.yourdomain.com&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;https://hub-mirror.c.163.com&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;https://mirror.baidubce.com&#34;</span>
</span></span><span style=display:flex><span>    ],
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;insecure-registries&#34;</span>: [
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;192.168.1.5:5000&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;101.102.103.104:5000&#34;</span>
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=docker迁移varlibdocker目录>Docker迁移/var/lib/docker目录</h2><h3 id=前言>前言</h3><p>由于<code>/var/lib/docker/overlay2</code>目录占用磁盘空间过大,即使使用<code>docker system prune -a</code>命令也无法清理<code>overlay2</code>目录下的文件,手动删除则会导致容器无法启动.所以只有将 docker 根目录迁移至空间更大的目录.</p><h4 id=迁移流程>迁移流程</h4><p>停止docker服务</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>systemctl stop docker
</span></span></code></pre></div><h4 id=迁移目录>迁移目录</h4><p>创建新的 docker 根目录,确保创建的目录空间容量够大.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>mkdir -p /home/docker/lib
</span></span></code></pre></div><p>迁移<code>/var/lib/docker</code>目录至<code>/home/docker/lib</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>rsync -avz /var/lib/docker /home/docker/lib/
</span></span></code></pre></div><p>配置<code>devicemapper.conf</code>,先查看该文件是否存在.如不存在则新建.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>mkdir -p /etc/systemd/system/docker.service.d/
</span></span><span style=display:flex><span>vi /etc/systemd/system/docker.service.d/devicemapper.conf
</span></span></code></pre></div><p>写入以下代码保存:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>Service<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>ExecStart<span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>ExecStart<span style=color:#f92672>=</span>/usr/bin/dockerd  --graph<span style=color:#f92672>=</span>/home/docker/lib/docker
</span></span></code></pre></div><p>重加载 docker</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>systemctl daemon-reload
</span></span><span style=display:flex><span>systemctl restart docker
</span></span><span style=display:flex><span>systemctl enable docker
</span></span></code></pre></div><h4 id=检查>检查</h4><p>执行以下命令检查</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker info
</span></span></code></pre></div><p>确认显示信息中 Docker Root Dir 路径正确</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span> <span style=color:#960050;background-color:#1e0010>Docker</span> <span style=color:#960050;background-color:#1e0010>Root</span> <span style=color:#960050;background-color:#1e0010>Dir:</span> <span style=color:#960050;background-color:#1e0010>/home/docker/lib/docker</span>
</span></span><span style=display:flex><span> <span style=color:#960050;background-color:#1e0010>Debug</span> <span style=color:#960050;background-color:#1e0010>Mode:</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span> <span style=color:#960050;background-color:#1e0010>Registry:</span> <span style=color:#960050;background-color:#1e0010>https:</span><span style=color:#75715e>//index.docker.io/v1/
</span></span></span></code></pre></div><h4 id=完成>完成</h4><p>再次启动容器,检查无误后可删除原路径<code>/var/lib/docker/</code>中的文件.</p><h3 id=docker-私有镜像仓库>Docker 私有镜像仓库</h3><h4 id=安装服务端>安装服务端</h4><p><strong>本文以部署至公网,开启账号密码,并配置域名反向代理为例.</strong>
命令参数过多,为方便配置参数,建议使用<code>docker compose</code>部署.</p><p>创建htpasswd账号密码</p><p>启动一个一次性容器用于创建账号密码.密码文件路径以<code>/root/registry/htpasswd</code>为例,账号密码以<code>admin</code>和<code>12345678</code>为例.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker run --rm --entrypoint <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    htpasswd httpd:2 -Bbn <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    admin <span style=color:#ae81ff>12345678</span> &gt; /root/registry/htpasswd
</span></span></code></pre></div><p>docker-compose.yml</p><p><strong>volumes</strong> 挂载<code>htpasswd</code>密码文件,数据目录,时区文件.配置文件<code>config.yml</code>作为高级用户可选挂载.
<strong>environment</strong> 环境变量开启认证,并开启删除镜像功能.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>version: <span style=color:#e6db74>&#34;3&#34;</span>
</span></span><span style=display:flex><span>services:
</span></span><span style=display:flex><span>  registry:
</span></span><span style=display:flex><span>    image: registry:2
</span></span><span style=display:flex><span>    container_name: registry
</span></span><span style=display:flex><span>    volumes:
</span></span><span style=display:flex><span>      <span style=color:#75715e># - ./config.yml:/etc/docker/registry/config.yml</span>
</span></span><span style=display:flex><span>      - ./htpasswd:/auth/htpasswd
</span></span><span style=display:flex><span>      - ./registry:/var/lib/registry
</span></span><span style=display:flex><span>      - /etc/localtime:/etc/localtime
</span></span><span style=display:flex><span>    ports:
</span></span><span style=display:flex><span>      - 5000:5000
</span></span><span style=display:flex><span>    environment:
</span></span><span style=display:flex><span>      - REGISTRY_AUTH<span style=color:#f92672>=</span>htpasswd
</span></span><span style=display:flex><span>      - REGISTRY_AUTH_HTPASSWD_PATH<span style=color:#f92672>=</span>/auth/htpasswd
</span></span><span style=display:flex><span>      - REGISTRY_AUTH_HTPASSWD_REALM<span style=color:#f92672>=</span>Registry Realm
</span></span><span style=display:flex><span>      - REGISTRY_STORAGE_DELETE_ENABLED<span style=color:#f92672>=</span>true
</span></span><span style=display:flex><span>    networks:
</span></span><span style=display:flex><span>      - registry
</span></span><span style=display:flex><span>    restart: always
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>networks:
</span></span><span style=display:flex><span>  registry:
</span></span></code></pre></div><p>启动</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker-compose up -d
</span></span></code></pre></div><p>成功启动后私有镜像仓库内网地址为: <strong>192.168.1.5:5000</strong>
可根据需求使用域名配置反向代理,例如: <strong><a href=https://registry.yourdomain.com target=_blank rel="noopener noreffer">https://registry.yourdomain.com</a></strong></p><p>注意需开放防火墙 5000 端口</p><h3 id=配置客户端>配置客户端</h3><p>以<code>CentOS</code>为例,创建或修改<code>/etc/docker/daemon.json</code>文件.</p><p><strong>注意,如使用域名配置反向代理并开启<code>HTTPS</code>,则无需配<code>daemon.json</code>文件.</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;insecure-registries&#34;</span>: [
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;192.168.1.5:5000&#34;</span>
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>或</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;insecure-registries&#34;</span>: [
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;101.102.103.104:5000&#34;</span>
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=使用>使用</h3><h4 id=登录>登录</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker login registry.yourdomain.com
</span></span><span style=display:flex><span>docker login 192.168.1.5:5000
</span></span><span style=display:flex><span>docker login 101.102.103.104:5000
</span></span><span style=display:flex><span><span style=color:#75715e># 使用上文创建的账号密码 admin 12345678 登录</span>
</span></span></code></pre></div><h4 id=登出>登出</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker logout registry.yourdomain.com
</span></span><span style=display:flex><span>docker logout 192.168.1.5:5000
</span></span><span style=display:flex><span>docker logout 101.102.103.104:5000
</span></span></code></pre></div><h4 id=push>Push</h4><p>将现有镜像 tag 为私有仓库镜像名</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker images
</span></span><span style=display:flex><span><span style=color:#75715e># 获取现有镜像的 IMAGE ID</span>
</span></span><span style=display:flex><span>docker tag 102816b1ee7d registry.yourdomain.com/mysql:8.0.13
</span></span><span style=display:flex><span>docker tag 102816b1ee7d 192.168.1.5:5000/mysql:8.0.13
</span></span><span style=display:flex><span>docker tag 102816b1ee7d 101.102.103.104:5000/mysql:8.0.13
</span></span></code></pre></div><p>Push 至私有镜像仓库</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker push registry.yourdomain.com/mysql:8.0.13
</span></span><span style=display:flex><span>docker push 192.168.1.5:5000/mysql:8.0.13
</span></span><span style=display:flex><span>docker push 101.102.103.104:5000/mysql:8.0.13
</span></span></code></pre></div><h4 id=pull>Pull</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker pull registry.yourdomain.com/mysql:8.0.13
</span></span><span style=display:flex><span>docker pull 192.168.1.5:5000/mysql:8.0.13
</span></span><span style=display:flex><span>docker pull 101.102.103.104:5000/mysql:8.0.13
</span></span></code></pre></div><h4 id=查看镜像仓库清单>查看镜像仓库清单</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -u admin:12345678 -X GET https://registry.yourdomain.com/v2/_catalog
</span></span></code></pre></div><h4 id=查看镜像-tag-清单>查看镜像 tag 清单</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -u admin:12345678 -X GET https://registry.yourdomain.com/v2/mysql/tags/list
</span></span></code></pre></div><h4 id=删除镜像>删除镜像</h4><pre tabindex=0><code>docker-compose.yml`环境变量中开启`REGISTRY_STORAGE_DELETE_ENABLED=true
</code></pre><h5 id=获取镜像-digest-hash>获取镜像 digest hash</h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -u admin:12345678 --header <span style=color:#e6db74>&#34;Accept: application/vnd.docker.distribution.manifest.v2+json&#34;</span> -I -X GET https://registry.yourdomain.com/v2/mysql/manifests/8.0.13
</span></span><span style=display:flex><span><span style=color:#75715e># 获取 digest hash 如下</span>
</span></span><span style=display:flex><span>sha256:45a2a291xxx223123fc03d9be551e362b460exxs56787736919baa
</span></span></code></pre></div><h5 id=删除镜像清单>删除镜像清单</h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -u admin:12345678 -I -X DELETE https://registry.yourdomain.com/v2/mysql/manifests/sha256:45a2a291xxx223123fc03d9be551e362b460exxs56787736919baa
</span></span></code></pre></div><h5 id=清理磁盘空间>清理磁盘空间</h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker exec registry bin/registry garbage-collect /etc/docker/registry/config.yml
</span></span></code></pre></div><h5 id=手动删除目录>手动删除目录</h5><p>完成上述操作后还可以删除存储目录中的空目录文件,如不删除依旧可以被上述<code>查看镜像仓库</code>的命令查询到结果.
<strong>依照上文示例,挂载存储目录路径如下:</strong></p><p>./registry/docker/registry/v2/repositories</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2022-02-24</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://blog.haipengv.com/posts/docker%E5%9F%BA%E7%A1%80/ data-title=docker基础><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://blog.haipengv.com/posts/docker%E5%9F%BA%E7%A1%80/><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://blog.haipengv.com/posts/docker%E5%9F%BA%E7%A1%80/ data-title=docker基础><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://blog.haipengv.com/posts/docker%E5%9F%BA%E7%A1%80/ data-title=docker基础><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@6.20.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=https://blog.haipengv.com/posts/docker%E5%9F%BA%E7%A1%80/ data-title=docker基础><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/harbor%E4%BD%BF%E7%94%A8%E8%87%AA%E7%AD%BE%E5%90%8D%E8%AF%81%E4%B9%A6%E5%AE%9E%E7%8E%B0https%E7%99%BB%E5%BD%95/ class=prev rel=prev title=harbor使用自签名证书实现https登录><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>harbor使用自签名证书实现https登录</a>
<a href=/posts/jupyter%E6%9B%B4%E6%94%B9%E7%99%BB%E5%BD%95%E5%AF%86%E7%A0%81/ class=next rel=next title=jupyter更改登录密码>jupyter更改登录密码<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.115.3">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank></a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.1/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>