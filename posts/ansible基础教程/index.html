<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>ansible基础教程 - My New Hugo Site</title><meta name=Description content="This is my cool site"><meta property="og:title" content="ansible基础教程"><meta property="og:description" content="ansible的配置文件 全局配置文件 ansible默认的全局配置文件是/etc/ansible/ansible.cfg，可认为是全局配置的入口。
Ansible支持4种方式指定配置文件，它们的解析顺序从上到下
ANSIBLE_CFG 环境变量指定的配置文件 ansible.cfg 当前目录下的ansible.cfg ~/.ansible.cfg 家目录下的.ansible.cfg /etc/ansible/ansible.cfg 默认全局配置文件 修改默认配置文件/etc/ansible/ansible.cfg：
$ cat /etc/ansible/ansible.cfg | grep -vE &#34;^$|^#&#34; [defaults] inventory = /etc/ansible/hosts	# inventory文件：ansible管理的主机清单 library = /usr/share/my_modules/ forks = 5	# ansbile的并发连接数 sudo_user = root remote_port = 22 host_key_checking = False timeout = 10 log_path = /var/log/ansible.log 文件中其它的可配置项：
stdout_callback = debug # 可将输出变得人性化；默认输出会挤在一行，配置后会换行输出； inventory主机文件 inventory文件默认路径是/etc/ansible/hosts，在这里配置目标主机，ansible便可以对其进行控制。
在/etc/ansible/hosts文件里配置node主机名或ip：
$ cat hosts [default]	#	主机分组 node1	#	172.18.0.101 node2	#	172.18.0.102 可以通过/etc/ansible/ansible."><meta property="og:type" content="article"><meta property="og:url" content="http://example.org/posts/ansible%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-04-22T13:50:33+00:00"><meta property="article:modified_time" content="2022-04-22T13:50:33+00:00"><meta property="og:site_name" content="My cool site"><meta name=twitter:card content="summary"><meta name=twitter:title content="ansible基础教程"><meta name=twitter:description content="ansible的配置文件 全局配置文件 ansible默认的全局配置文件是/etc/ansible/ansible.cfg，可认为是全局配置的入口。
Ansible支持4种方式指定配置文件，它们的解析顺序从上到下
ANSIBLE_CFG 环境变量指定的配置文件 ansible.cfg 当前目录下的ansible.cfg ~/.ansible.cfg 家目录下的.ansible.cfg /etc/ansible/ansible.cfg 默认全局配置文件 修改默认配置文件/etc/ansible/ansible.cfg：
$ cat /etc/ansible/ansible.cfg | grep -vE &#34;^$|^#&#34; [defaults] inventory = /etc/ansible/hosts	# inventory文件：ansible管理的主机清单 library = /usr/share/my_modules/ forks = 5	# ansbile的并发连接数 sudo_user = root remote_port = 22 host_key_checking = False timeout = 10 log_path = /var/log/ansible.log 文件中其它的可配置项：
stdout_callback = debug # 可将输出变得人性化；默认输出会挤在一行，配置后会换行输出； inventory主机文件 inventory文件默认路径是/etc/ansible/hosts，在这里配置目标主机，ansible便可以对其进行控制。
在/etc/ansible/hosts文件里配置node主机名或ip：
$ cat hosts [default]	#	主机分组 node1	#	172.18.0.101 node2	#	172.18.0.102 可以通过/etc/ansible/ansible."><meta name=application-name content="My cool site"><meta name=apple-mobile-web-app-title content="My cool site"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=http://example.org/posts/ansible%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/><link rel=prev href=http://example.org/posts/shell%E8%84%9A%E6%9C%AC%E5%BA%94%E7%94%A8%E9%95%BF%E6%9C%9F%E6%9B%B4%E6%96%B0/><link rel=next href=http://example.org/posts/git%E5%85%A5%E9%97%A8/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"ansible基础教程","inLanguage":"en-us","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/example.org\/posts\/ansible%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B\/"},"genre":"posts","wordcount":3191,"url":"http:\/\/example.org\/posts\/ansible%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B\/","datePublished":"2022-04-22T13:50:33+00:00","dateModified":"2022-04-22T13:50:33+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Author"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="My New Hugo Site">My cool site</a></div><div class=menu><div class=menu-inner><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="My New Hugo Site">My cool site</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">ansible基础教程</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Author</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2022-04-22>2022-04-22</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;3191 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;15 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#ansible的配置文件>ansible的配置文件</a><ul><li><a href=#全局配置文件>全局配置文件</a></li><li><a href=#inventory主机文件>inventory主机文件</a></li><li><a href=#查看inventory>查看inventory</a></li></ul></li><li><a href=#运行ansible命令>运行ansible命令</a><ul><li><a href=#ping模块>ping模块</a></li><li><a href=#debug模块>debug模块</a></li></ul></li><li><a href=#playbook>playbook</a><ul><li><a href=#playbookplaytask的关系>playbook、play、task的关系</a></li><li><a href=#编写一个playbook并执行>编写一个playbook并执行</a></li><li><a href=#playbook文件各配置指令及含义>playbook文件各配置指令及含义</a></li><li><a href=#向模块传递参数>向模块传递参数</a></li><li><a href=#默认的任务执行策略>默认的任务执行策略</a></li></ul></li><li><a href=#常见模块>常见模块</a><ul><li><a href=#shell模块>shell模块</a></li><li><a href=#script模块>script模块</a></li><li><a href=#hostname模块>hostname模块</a></li></ul></li><li><a href=#在playbook中设置变量>在playbook中设置变量</a><ul><li><a href=#字典变量的定义和引用><strong>字典变量的定义和引用</strong></a></li><li><a href=#列表变量的定义和引用><strong>列表变量的定义和引用</strong></a></li></ul></li><li><a href=#when指令进行条件判断>when指令进行条件判断</a></li><li><a href=#loop循环结构>loop循环结构</a><ul><li><a href=#直接迭代列表>直接迭代列表</a></li><li><a href=#迭代字典>迭代字典</a></li></ul></li><li><a href=#notify和handlers>notify和handlers</a></li><li><a href=#组织playbook>组织playbook</a></li><li><a href=#组织各类内容taskhandler变量>组织各类内容：task、handler、变量</a><ul><li><a href=#组织tasks>组织tasks</a></li><li><a href=#组织handlers>组织handlers</a></li><li><a href=#组织变量>组织变量</a></li></ul></li><li><a href=#使用role>使用role</a><ul><li><a href=#role的文件结构>role的文件结构</a></li><li><a href=#编写一个role>编写一个role</a></li></ul></li><li><a href=#playbook的执行顺序>playbook的执行顺序</a><ul><li><a href=#理解委托任务>理解委托任务</a></li></ul></li></ul></nav></div></div><div class=content id=content><h2 id=ansible的配置文件>ansible的配置文件</h2><h3 id=全局配置文件>全局配置文件</h3><p>ansible默认的全局配置文件是<code>/etc/ansible/ansible.cfg</code>，可认为是全局配置的入口。</p><p>Ansible支持4种方式指定配置文件，它们的解析顺序从上到下</p><ul><li>ANSIBLE_CFG 环境变量指定的配置文件</li><li>ansible.cfg 当前目录下的ansible.cfg</li><li>~/.ansible.cfg 家目录下的.ansible.cfg</li><li><code>/etc/ansible/ansible.cfg</code> 默认全局配置文件</li></ul><p>修改默认配置文件/etc/ansible/ansible.cfg：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cat /etc/ansible/ansible.cfg | grep -vE <span style=color:#e6db74>&#34;^</span>$<span style=color:#e6db74>|^#&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>defaults<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>inventory      <span style=color:#f92672>=</span> /etc/ansible/hosts			<span style=color:#75715e># inventory文件：ansible管理的主机清单</span>
</span></span><span style=display:flex><span>library        <span style=color:#f92672>=</span> /usr/share/my_modules/
</span></span><span style=display:flex><span>forks          <span style=color:#f92672>=</span> 5					<span style=color:#75715e># ansbile的并发连接数</span>
</span></span><span style=display:flex><span>sudo_user      <span style=color:#f92672>=</span> root
</span></span><span style=display:flex><span>remote_port    <span style=color:#f92672>=</span> <span style=color:#ae81ff>22</span>
</span></span><span style=display:flex><span>host_key_checking <span style=color:#f92672>=</span> False
</span></span><span style=display:flex><span>timeout <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>log_path <span style=color:#f92672>=</span> /var/log/ansible.log
</span></span></code></pre></div><p>文件中其它的可配置项：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>stdout_callback <span style=color:#f92672>=</span> debug        <span style=color:#75715e># 可将输出变得人性化；默认输出会挤在一行，配置后会换行输出；</span>
</span></span></code></pre></div><h3 id=inventory主机文件>inventory主机文件</h3><p><code>inventory</code>文件默认路径是<code>/etc/ansible/hosts</code>，在这里配置目标主机，ansible便可以对其进行控制。</p><p>在<code>/etc/ansible/hosts</code>文件里配置node主机名或ip：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cat hosts
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>default<span style=color:#f92672>]</span>				<span style=color:#75715e>#	主机分组</span>
</span></span><span style=display:flex><span>node1					<span style=color:#75715e>#	172.18.0.101</span>
</span></span><span style=display:flex><span>node2					<span style=color:#75715e>#	172.18.0.102</span>
</span></span></code></pre></div><p>可以通过<code>/etc/ansible/ansible.cfg</code>文件修改inventory的默认路径：<code>inventory = /etc/ansible/hosts</code>。如果将该配置指定为目录，便可以使用多个inventory文件来管理节点，一般很少动这个。</p><p>通常，不会修改默认的路径。如果有自定义的inventory文件，可以直接在ansible命令行中使用<code>-i</code>选项指定:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># ansible -i /tmp/my_inventory.ini ...</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ansible-playbook -i /tmp/my_inventory.ini ...</span>
</span></span></code></pre></div><h3 id=查看inventory>查看inventory</h3><p>列出ansiblek可管理的所有主机</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ansible-inventory --graph all			<span style=color:#75715e># 指定文件：ansible-inventory -i /etc/ansible/hosts --graph all</span>
</span></span><span style=display:flex><span>@all:						<span style=color:#75715e># all是默认的主机组，包含所有主机</span>
</span></span><span style=display:flex><span>  |--@default:
</span></span><span style=display:flex><span>  |  |--node1
</span></span><span style=display:flex><span>  |  |--node2
</span></span><span style=display:flex><span>  |--@ungrouped:
</span></span></code></pre></div><h2 id=运行ansible命令>运行ansible命令</h2><p>完成上述的基本配置后，即可以开始使用ansible来批量管理主机了，这里的管理方式为命令行方式（又称为<code>Ad-hoc</code>方式）。</p><p>Ad-hoc方式运行ansible的命令格式：<code>ansible 主机组/主机 -m 模块 -a 参数</code></p><p>选项解析：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>-m:	指定调用的模块
</span></span><span style=display:flex><span>-a:	向模块传递的参数，模块不需要则可省略;参数需要使用引号包围
</span></span></code></pre></div><p>此外ansible命令还可以带上其它选项：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>-i:	指定本次的inventory路径，指定该参数则后面不加主机组/主机
</span></span><span style=display:flex><span>-e:	设置变量，格式为<span style=color:#e6db74>&#39;var1=&#34;aaa&#34; var=&#34;bbb&#34;&#39;</span>
</span></span><span style=display:flex><span>-v/vv/vvv:	命令输出的打印级别
</span></span></code></pre></div><p>ansible的批量管理功能依靠各个模块来完成，ansible提供了几千个模块（其中ansible团队自己维护大约100多个核心模块），每个模块完成各自的作用。</p><p>下面用ping模块和debug模块来演示一下ansible的基础功能。</p><h3 id=ping模块>ping模块</h3><p><code>ping模块</code>是ansible最基础模块之一，可用于检测远程主机是否在线。</p><p>命令：<code>ansible 主机组/主机 -m ping</code></p><p>返回值：changed、ping</p><p>命令：<code>ansible all -m ping</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@master ansible<span style=color:#f92672>]</span>$ ansible all -m ping
</span></span><span style=display:flex><span>node2 | SUCCESS <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;ansible_facts&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;discovered_interpreter_python&#34;</span>: <span style=color:#e6db74>&#34;/usr/bin/python&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;changed&#34;</span>: false,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;ping&#34;</span>: <span style=color:#e6db74>&#34;pong&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>node1 | SUCCESS <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;ansible_facts&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;discovered_interpreter_python&#34;</span>: <span style=color:#e6db74>&#34;/usr/bin/python&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;changed&#34;</span>: false,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;ping&#34;</span>: <span style=color:#e6db74>&#34;pong&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=debug模块>debug模块</h3><p>官网说明：https://docs.ansible.com/ansible/latest/collections/ansible/builtin/debug_module.html</p><p><code>debug模块</code>用于输出或调试一些变量或数据。该模块共有三个参数msg、var、verbosity。</p><pre tabindex=0><code class=language-none data-lang=none>msg：打印配置的信息
var：打印变量值
verbosity：运行级别，设置为3，则-vvv或更高才会打印输出
</code></pre><p><strong>命令：</strong></p><pre tabindex=0><code>ansible all -m debug -a &#39;msg=&#34;hello world&#34;&#39;
ansible all -e &#39;str=&#34;hello world&#34;&#39; -m debug -a &#39;var=str&#39;
ansible all -v -m debug -a &#39;msg=&#34;hello world&#34; verbosity=1&#39;
</code></pre><p><strong>示例：</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@master ansible<span style=color:#f92672>]</span>$ ansible all -m debug -a <span style=color:#e6db74>&#39;msg=&#34;hello world&#34;&#39;</span>
</span></span><span style=display:flex><span>node1 | SUCCESS <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;hello world&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>node2 | SUCCESS <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;hello world&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@master ansible<span style=color:#f92672>]</span>$ ansible all -e <span style=color:#e6db74>&#39;str=&#34;hello world&#34;&#39;</span> -m debug -a <span style=color:#e6db74>&#39;var=str&#39;</span>
</span></span><span style=display:flex><span>node1 | SUCCESS <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;str&#34;</span>: <span style=color:#e6db74>&#34;hello world&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>node2 | SUCCESS <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;str&#34;</span>: <span style=color:#e6db74>&#34;hello world&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@master ansible<span style=color:#f92672>]</span>$ ansible all -m debug -a <span style=color:#e6db74>&#39;msg=&#34;hello world&#34; verbosity=1&#39;</span>
</span></span><span style=display:flex><span>node1 | SKIPPED
</span></span><span style=display:flex><span>node2 | SKIPPED
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@master ansible<span style=color:#f92672>]</span>$ ansible all -v -m debug -a <span style=color:#e6db74>&#39;msg=&#34;hello world&#34; verbosity=1&#39;</span>
</span></span><span style=display:flex><span>Using /etc/ansible/ansible.cfg as config file
</span></span><span style=display:flex><span>node1 | SUCCESS <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;hello world&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>node2 | SUCCESS <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;hello world&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=playbook>playbook</h2><p><code>playbook</code>是一个<code>yaml</code>格式的文件，由一个或多个<code>play</code>按顺序列表的方式组成。每个<code>play</code>运行一个或多个<code>task</code>，每个<code>task</code>调用一个模块<code>module</code>。</p><h3 id=playbookplaytask的关系>playbook、play、task的关系</h3><ul><li>playbook中可以定义一个或多个play</li><li>每个play中可以定义一个或多个task<ul><li>其中还可以定义两类特殊的task：pre_tasks和post_tasks</li><li>pre_tasks表示执行执行普通任务之前执行的任务列表</li><li>post_tasks表示普通任务执行完之后执行的任务列表</li></ul></li><li>每个play都需要通过hosts指令指定要执行该play的目标主机</li><li>每个play都可以设置一些该play的环境控制行为，比如定义play级别的变量</li></ul><h3 id=编写一个playbook并执行>编写一个playbook并执行</h3><p><code>playbook</code>使用<code>yaml</code>语法格式组织各种<code>play</code>和<code>task</code>规则。</p><p>下面使用ping模块和debug模块编写一个playbook文件如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># cat test.yaml</span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>play1						# play的名称，非必须</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>all						# 指定目标主机</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>gather_facts</span>: <span style=color:#66d9ef>false</span>					<span style=color:#75715e># 收集目标主机信息，默认值true，非必须</span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>tasks:						# tasks声明任务列表</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>task1					# task任务名称，非必须</span>
</span></span><span style=display:flex><span>      <span style=color:#ae81ff>ping:						# 模块</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>data</span>: <span style=color:#e6db74>&#34;pong task1&#34;</span>				<span style=color:#75715e># 模块参数</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>task2</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>ping</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>data</span>: <span style=color:#e6db74>&#34;pong task2&#34;</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>play2</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>all</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>gather_facts</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>task1</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;hello task1 in play2&#34;</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>task2</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;hello task2 in play2&#34;</span>
</span></span></code></pre></div><blockquote><p>注意所有的<code>-</code>和<code>:</code>符号后面均需要接一个空格</p></blockquote><p>执行playbook的命令是<code>ansible-playbook test.yaml</code>：</p><p>该命令同样支持像ansile命令一样的多个选项，如<code>-e</code>、<code>-i</code>、<code>-v</code>等</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ansible-playbook -v test.yaml			
</span></span><span style=display:flex><span>Using /etc/ansible/ansible.cfg as config file
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY <span style=color:#f92672>[</span>play1<span style=color:#f92672>]</span> **********************************************************************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>task1<span style=color:#f92672>]</span> **********************************************************************************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>node2<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;ansible_facts&#34;</span>: <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;discovered_interpreter_python&#34;</span>: <span style=color:#e6db74>&#34;/usr/bin/python&#34;</span><span style=color:#f92672>}</span>, <span style=color:#e6db74>&#34;changed&#34;</span>: false, <span style=color:#e6db74>&#34;ping&#34;</span>: <span style=color:#e6db74>&#34;pong task1&#34;</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>node1<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;ansible_facts&#34;</span>: <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;discovered_interpreter_python&#34;</span>: <span style=color:#e6db74>&#34;/usr/bin/python&#34;</span><span style=color:#f92672>}</span>, <span style=color:#e6db74>&#34;changed&#34;</span>: false, <span style=color:#e6db74>&#34;ping&#34;</span>: <span style=color:#e6db74>&#34;pong task1&#34;</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>task2<span style=color:#f92672>]</span> **********************************************************************************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>node1<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;changed&#34;</span>: false, <span style=color:#e6db74>&#34;ping&#34;</span>: <span style=color:#e6db74>&#34;pong task2&#34;</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>node2<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;changed&#34;</span>: false, <span style=color:#e6db74>&#34;ping&#34;</span>: <span style=color:#e6db74>&#34;pong task2&#34;</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY <span style=color:#f92672>[</span>play2<span style=color:#f92672>]</span> **********************************************************************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>task1<span style=color:#f92672>]</span> **********************************************************************************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>node1<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;hello task1 in play2&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>node2<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;hello task1 in play2&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>task2<span style=color:#f92672>]</span> **********************************************************************************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>node1<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;hello task2 in play2&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>node2<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;hello task2 in play2&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP ************************************************************************************************************************
</span></span><span style=display:flex><span>node1                      : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>node2                      : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span></code></pre></div><h3 id=playbook文件各配置指令及含义>playbook文件各配置指令及含义</h3><p><code>yaml</code>文件中，使用<code>-</code>表示一个列表元素，多个<code>key：value</code>表示一个字典。</p><p>每个<code>playbook</code>使用列表来组织多个<code>play</code>，<code>play</code>内同样使用列表来组织多个<code>task</code>；play和task自身则采用字典的方式组织，即多个键值对。</p><p>在playbook顶层使用<code>- xxx:</code>表示这是一个play；每个play中必须包含<code>hosts</code>和<code>tasks</code>指令。</p><p><code>hosts</code>指令用来指定要执行该play的目标主机，可以是主机名、主机组或者其它多种方式。</p><p><code>tasks</code>指令用来指定该play中包含的任务列表，每个任务使用<code>- xxx:</code>方式表示。</p><p><code>name</code>指令用来设置play和task的名称，值具有唯一性。</p><p><code>gather_facts</code>指令用来收集目标主机的信息，由setup模块提供。默认情况下，每个play都先执行这个特殊任务，收集完信息才开始其它任务。如果后续任务中用不到该信息，则可以禁止掉该任务，提升效率。</p><h3 id=向模块传递参数>向模块传递参数</h3><p>yaml中，向模块传递参数的方式总结为字符串和数组两种方式。</p><p>还是以debug模块为例。</p><p>数组方式如上面test.yaml文件里的传参，即<code>key: value</code>的形式：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>...<span style=color:#ae81ff>...</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>task1</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;hello task1 in play2&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>verbosity=1</span>
</span></span></code></pre></div><p>字符串方式，由于yaml的语法规则（字符串换行将自动转换为空格），又有不同的书写形式：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>debug</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>all</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>gather_facts</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>task1</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>msg=&#34;hello task1&#34; verbosity=1			# 参数写成一行</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>task2	</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>msg=&#34;hello task2&#34;				# 参数写成多行</span>
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>verbosity=1</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>task3</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>debug</span>: <span style=color:#ae81ff>|		# 竖线|，将保留字符串的换行符，否则将自动转换成空格，在一些模块中很有用，如shell</span>
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>msg=&#34;hello task3&#34;						</span>
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>verbosity=1</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>task4</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>debug</span>: <span style=color:#ae81ff>&gt;						# 符号&gt;，效果和直接写成多行一样</span>
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>msg=&#34;hello task4&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>verbosity=1</span>
</span></span></code></pre></div><p>还可以直接使用指令args指明参数：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>...<span style=color:#ae81ff>...</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>task1</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>args</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;hello task1 in play2&#34;</span>
</span></span></code></pre></div><h3 id=默认的任务执行策略>默认的任务执行策略</h3><p>/etc/ansible/ansible.cfg文件的<code>forks</code>配置，决定ansible执行任务的并发连接数。</p><p>假如forks配置为5，那么ansible第一次将同时连接5个node节点执行任务。其中若有节点提前执行完任务， 则ansible会新建一个新进程，来连接下一个节点执行任务。</p><p>forks是保证最多有N个节点同时执行任务。</p><h2 id=常见模块>常见模块</h2><h3 id=shell模块>shell模块</h3><p><strong>说明：</strong></p><p><code>shell</code>模块接收shell命令，命令后可跟空格分割的参数列；</p><p>必须传入自由格式的命令，或者cmd参数；</p><p>它十分类似command模块，但是它在远程主机上通过shell（比如/bin/bash）来运行命令；</p><p>shell模块相比command模块，支持解析特殊符号<code>&lt;</code>、<code>></code>、<code>|</code>、<code>;</code>、<code>&</code>等。</p><p><strong>参数：</strong></p><table><thead><tr><th>Parameter</th><th>Choices/Defaults</th><th>说明</th></tr></thead><tbody><tr><td><strong><code>chdir</code></strong> path</td><td></td><td>运行脚本前，切换到相关目录</td></tr><tr><td><strong><code>cmd</code></strong> string</td><td></td><td>需要运行的命令，后跟可选的参数</td></tr><tr><td><strong><code>creates</code></strong> path</td><td></td><td>若一个文件或目录存在，则跳过该步骤</td></tr><tr><td><strong><code>removes</code></strong> path</td><td></td><td>若一个文件或目录不存在，则跳过该步骤</td></tr><tr><td><strong><code>executable</code></strong> path</td><td></td><td>改变执行命令的解释器，如/bin/bash、/usr/bin/expect、/usr/bin/python；绝对路径</td></tr><tr><td><strong>free_form</strong> string</td><td></td><td>自由格式的命令（即命令字符串，没有相关参数，直接写在shell模块后面即可）</td></tr><tr><td><strong>stdin</strong> string</td><td></td><td>Set the stdin of the command directly to the specified value.</td></tr><tr><td><strong>stdin_add_newline</strong> boolean</td><td><strong>Choices:</strong>no<strong>yes</strong> ←（default）</td><td>Whether to append a newline to stdin data.</td></tr><tr><td><strong>warn</strong> boolean</td><td><strong>Choices:</strong>no<strong>yes</strong> ←(default)</td><td>Whether to enable task warnings.</td></tr></tbody></table><p><strong>示例：</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>shell</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>all</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>gather_facts</span>: <span style=color:#66d9ef>no</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>task1</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>shell</span>:
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>hostname</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>task2</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>shell</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>cmd</span>: <span style=color:#ae81ff>date +&#34;%F %T&#34;</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>task3</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>shell</span>: 
</span></span><span style=display:flex><span>        <span style=color:#f92672>cmd</span>: <span style=color:#ae81ff>pwd</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>chdir</span>: <span style=color:#ae81ff>/etc/sysconfig</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>task4</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>shell</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>cmd</span>: <span style=color:#ae81ff>ls /tmp</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>creates</span>: <span style=color:#ae81ff>/tmp</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>task5</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>shell</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>cmd</span>: <span style=color:#ae81ff>print(&#39;hello world&#39;)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>executable</span>: <span style=color:#ae81ff>/usr/bin/python</span>
</span></span></code></pre></div><p>注意chdir参数只支持下面的方式：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>task3</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>shell</span>: 
</span></span><span style=display:flex><span>        <span style=color:#f92672>cmd</span>: <span style=color:#ae81ff>pwd</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>chdir</span>: <span style=color:#ae81ff>/etc/sysconfig</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>task3</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>shell</span>: <span style=color:#ae81ff>pwd				# free_from格式需要采用args参数，显式指定chdir参数</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>args</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>chdir</span>: <span style=color:#ae81ff>/etc/sysconfig</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 下面的方式将发生错误</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>task3</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>shell</span>: <span style=color:#ae81ff>pwd</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>chdir</span>: <span style=color:#ae81ff>/etc/sysconfig</span>
</span></span></code></pre></div><p><strong>Ad-hoc方式：</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ansible all -m shell -a <span style=color:#e6db74>&#34;ls -l | wc -l&#34;</span>
</span></span><span style=display:flex><span>$ ansible all -v -m shell -a <span style=color:#e6db74>&#34;ls chdir=/tmp &#34;</span>
</span></span></code></pre></div><blockquote><p><a href=https://docs.ansible.com/ansible/latest/collections/ansible/builtin/shell_module.html#ansible-collections-ansible-builtin-shell-module target=_blank rel="noopener noreffer">https://docs.ansible.com/ansible/latest/collections/ansible/builtin/shell_module.html#ansible-collections-ansible-builtin-shell-module</a></p></blockquote><h3 id=script模块>script模块</h3><p><strong>说明：</strong></p><p><code>script</code>模块接受一个脚本名称，后面可跟空格分割的参数列；</p><p>支持自由格式的命令，或者cmd参数；</p><p>将本地脚本传输到远程主机上执行；</p><p>在远程主机上使用shell环境执行脚本；</p><p>该模块不需要python，类似raw模块。</p><p><strong>参数：</strong></p><table><thead><tr><th>Parameter</th><th>Choices/Defaults</th><th>说明</th></tr></thead><tbody><tr><td><strong><code>chdir</code></strong> path</td><td></td><td>运行脚本前，切换到远程主机的相关目录</td></tr><tr><td><strong><code>cmd</code></strong> string</td><td></td><td>需要运行的脚本路径，后跟可选的参数</td></tr><tr><td><strong><code>creates</code></strong> path</td><td></td><td>若一个文件或目录存在，则跳过该步骤</td></tr><tr><td><strong><code>removes</code></strong> path</td><td></td><td>若一个文件或目录不存在，则跳过该步骤</td></tr></tbody></table><p><strong>示例：</strong></p><p><code>sctipt-simple.yml</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>script</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>web</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>: 
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>list files</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>script</span>: <span style=color:#ae81ff>/etc/ansible/test-yml/trans_exec.sh</span>
</span></span></code></pre></div><p><code>trans_exec.sh</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>date <span style=color:#f92672>&amp;&amp;</span> hostname 
</span></span></code></pre></div><p><strong>Ad-hoc：</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ansible all -m script -a <span style=color:#e6db74>&#34;/tmp/hello.sh world&#34;</span>
</span></span><span style=display:flex><span>$ ansible all -m script -a <span style=color:#e6db74>&#34;/tmp/hello.sh world creates=/tmp&#34;</span>
</span></span></code></pre></div><p><a href=https://docs.ansible.com/ansible/latest/collections/ansible/builtin/script_module.html#ansible-collections-ansible-builtin-script-module target=_blank rel="noopener noreffer">https://docs.ansible.com/ansible/latest/collections/ansible/builtin/script_module.html#ansible-collections-ansible-builtin-script-module</a></p><h3 id=hostname模块>hostname模块</h3><p><strong>说明：</strong></p><p>设置系统的主机名</p><p><strong>参数：</strong></p><table><thead><tr><th>Parameter</th><th>Choices/Defaults</th><th>说明</th></tr></thead><tbody><tr><td><strong><code>name</code></strong> string / required</td><td></td><td>设置主机名</td></tr></tbody></table><p><strong>示例：</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Set a hostname</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ansible.builtin.hostname</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>web01</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Set a hostname specifying strategy</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ansible.builtin.hostname</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>web01</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>use</span>: <span style=color:#ae81ff>systemd</span>
</span></span></code></pre></div><blockquote><p><a href=https://docs.ansible.com/ansible/latest/collections/ansible/builtin/hostname_module.html target=_blank rel="noopener noreffer">https://docs.ansible.com/ansible/latest/collections/ansible/builtin/hostname_module.html</a></p></blockquote><h2 id=在playbook中设置变量>在playbook中设置变量</h2><p><code>vars</code>指令可在play或task中设置变量，可以设置一个或多个。可以采用字典或列表的形式定义变量。</p><h3 id=字典变量的定义和引用><strong>字典变量的定义和引用</strong></h3><p><strong>定义：</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>vars</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>foo1</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>a</span>: <span style=color:#ae81ff>hello</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>b</span>: <span style=color:#ae81ff>world</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>foo2</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>a</span>: <span style=color:#ae81ff>aaa</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>b</span>: <span style=color:#ae81ff>bbb</span>
</span></span></code></pre></div><p><strong>引用：</strong></p><p>使用点号或方括号，在yaml文件使用jinja2语法引用，需要加单双引号，否则解析yaml的时候将报错</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>task1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;{{ foo1.a }} {{ foo1[&#39;b&#39;] }}&#34;</span>		<span style=color:#75715e># 注意{{}}是jinja2的语法，在yaml文件中需要使用引号引起来，单双引号都行</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>task2</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>var</span>: <span style=color:#ae81ff>foo1.a,foo1[&#39;b&#39;]			# debug模块的var参数，多个值使用逗号分隔，且无需花括号，前后加不加引号均可</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>task3</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#39;{{ foo2.a }} {{ foo2.b }}&#39;</span>
</span></span></code></pre></div><p><strong>示例：</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>vars play</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>all</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>gather_facts</span>: <span style=color:#66d9ef>no</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>vars</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>foo1</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>a</span>: <span style=color:#ae81ff>hello</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>b</span>: <span style=color:#ae81ff>world</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>foo2</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>a</span>: <span style=color:#ae81ff>aaa</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>b</span>: <span style=color:#ae81ff>bbb</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>task1</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;{{ foo1.a }} {{ foo1[&#39;b&#39;] }}&#34;</span>				
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>task2</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>var</span>: <span style=color:#ae81ff>foo1.a,foo1[&#39;b&#39;]</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>task3</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#39;{{ foo2.a }} {{ foo2.b }}&#39;</span>
</span></span></code></pre></div><h3 id=列表变量的定义和引用><strong>列表变量的定义和引用</strong></h3><p><strong>定义：</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>vars</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>foo</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>a</span>: <span style=color:#ae81ff>hello</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>b</span>: <span style=color:#ae81ff>world</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>a</span>: <span style=color:#ae81ff>aaa</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>b</span>: <span style=color:#ae81ff>bbb</span>
</span></span></code></pre></div><p><strong>引用：</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>task1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;{{ foo[0].a }} {{ foo[0].b }}&#34;</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>task2</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;{{foo[1][&#39;a&#39;]}} {{foo[1][&#39;b&#39;]}}&#34;</span>
</span></span></code></pre></div><blockquote><p>引用变量时，使用点号比较方便，但如果变量名本身带点，则尽量选择方括号的方式。</p></blockquote><h2 id=when指令进行条件判断>when指令进行条件判断</h2><p><code>when</code>指令是ansible提供的唯一一个通用条件指令。<code>when</code>指令后的变量引用不需要双花括号，当when指令的值为true时，执行任务。</p><p><strong>yaml文件如下：</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>when</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>all</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>gather_facts</span>: <span style=color:#66d9ef>no</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>vars</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>foo</span>: <span style=color:#ae81ff>test</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>task1</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>when</span>: <span style=color:#ae81ff>foo == &#34;test&#34;			# when指令的变量可直接引用</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;hello&#34;</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>task2</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>when</span>: <span style=color:#ae81ff>foo == &#34;dev&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;world&#34;</span>
</span></span></code></pre></div><p><strong>示例：</strong></p><p>从输出中可看出，任务task2由于条件不满足自动跳过</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@master ansible<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook -v when.yaml</span>
</span></span><span style=display:flex><span>Using /etc/ansible/ansible.cfg as config file
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY <span style=color:#f92672>[</span>when<span style=color:#f92672>]</span> ***********************************************************************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>task1<span style=color:#f92672>]</span> **********************************************************************************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>node1<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;hello&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>node2<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;hello&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>task2<span style=color:#f92672>]</span> **********************************************************************************************************************
</span></span><span style=display:flex><span>skipping: <span style=color:#f92672>[</span>node1<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{}</span>
</span></span><span style=display:flex><span>skipping: <span style=color:#f92672>[</span>node2<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP ************************************************************************************************************************
</span></span><span style=display:flex><span>node1                      : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>node2                      : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span></code></pre></div><p><strong>多个判断条件：</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>task3</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>when</span>: <span style=color:#ae81ff>foo == &#34;dev&#34; or foo == &#34;test&#34;			# 逻辑或</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;hello world&#34;</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>task4</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>when</span>: <span style=color:#ae81ff>(foo == &#34;dev&#34;) or (foo == &#34;test&#34;)		# 支持括号括起来</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;hello world&#34;</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>task5</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>when</span>: <span style=color:#ae81ff>(foo == &#34;dev&#34;) and (foo == &#34;test&#34;)		# 逻辑与</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;hello world&#34;</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>task6</span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>when:							</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>foo == &#34;dev&#34;					# 逻辑与的另一种组织方式</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>foo == &#34;test&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;hello world&#34;</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>task7</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>when</span>: <span style=color:#ae81ff>foo != &#34;dev&#34;					# 逻辑否</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;hello world&#34;</span>
</span></span></code></pre></div><h2 id=loop循环结构>loop循环结构</h2><p>loop指令中的各项元素将以item变量名进行迭代。</p><h3 id=直接迭代列表>直接迭代列表</h3><p><strong>迭代简单列表：</strong></p><p>列表元素为字符串</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>task1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>shell</span>: <span style=color:#e6db74>&#34;{{ item }}&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>loop</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>hostname</span>
</span></span><span style=display:flex><span>    - <span style=color:#e6db74>&#34;uptime -p&#34;</span>
</span></span></code></pre></div><p>示例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@master ansible<span style=color:#f92672>]</span><span style=color:#75715e># cat loop.yaml</span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>- name: loop
</span></span><span style=display:flex><span>  hosts: all
</span></span><span style=display:flex><span>  gather_facts: no
</span></span><span style=display:flex><span>  tasks:
</span></span><span style=display:flex><span>    - name: task1
</span></span><span style=display:flex><span>      shell: <span style=color:#e6db74>&#34;{{ item }}&#34;</span>
</span></span><span style=display:flex><span>      loop:
</span></span><span style=display:flex><span>        - hostname
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;uptime -p&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@master ansible<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook -v loop.yaml</span>
</span></span><span style=display:flex><span>Using /etc/ansible/ansible.cfg as config file
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY <span style=color:#f92672>[</span>loop<span style=color:#f92672>]</span> ***********************************************************************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>task1<span style=color:#f92672>]</span> **********************************************************************************************************************
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>node2<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>(</span>item<span style=color:#f92672>=</span>hostname<span style=color:#f92672>)</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;ansible_facts&#34;</span>: <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;discovered_interpreter_python&#34;</span>: <span style=color:#e6db74>&#34;/usr/bin/python&#34;</span><span style=color:#f92672>}</span>, <span style=color:#e6db74>&#34;ansible_loop_var&#34;</span>: <span style=color:#e6db74>&#34;item&#34;</span>, <span style=color:#e6db74>&#34;changed&#34;</span>: true, <span style=color:#e6db74>&#34;cmd&#34;</span>: <span style=color:#e6db74>&#34;hostname&#34;</span>, <span style=color:#e6db74>&#34;delta&#34;</span>: <span style=color:#e6db74>&#34;0:00:00.020436&#34;</span>, <span style=color:#e6db74>&#34;end&#34;</span>: <span style=color:#e6db74>&#34;2022-01-09 15:05:17.126971&#34;</span>, <span style=color:#e6db74>&#34;item&#34;</span>: <span style=color:#e6db74>&#34;hostname&#34;</span>, <span style=color:#e6db74>&#34;rc&#34;</span>: 0, <span style=color:#e6db74>&#34;start&#34;</span>: <span style=color:#e6db74>&#34;2022-01-09 15:05:17.106535&#34;</span>, <span style=color:#e6db74>&#34;stderr&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;stderr_lines&#34;</span>: <span style=color:#f92672>[]</span>, <span style=color:#e6db74>&#34;stdout&#34;</span>: <span style=color:#e6db74>&#34;node2&#34;</span>, <span style=color:#e6db74>&#34;stdout_lines&#34;</span>: <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;node2&#34;</span><span style=color:#f92672>]}</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>node1<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>(</span>item<span style=color:#f92672>=</span>hostname<span style=color:#f92672>)</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;ansible_facts&#34;</span>: <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;discovered_interpreter_python&#34;</span>: <span style=color:#e6db74>&#34;/usr/bin/python&#34;</span><span style=color:#f92672>}</span>, <span style=color:#e6db74>&#34;ansible_loop_var&#34;</span>: <span style=color:#e6db74>&#34;item&#34;</span>, <span style=color:#e6db74>&#34;changed&#34;</span>: true, <span style=color:#e6db74>&#34;cmd&#34;</span>: <span style=color:#e6db74>&#34;hostname&#34;</span>, <span style=color:#e6db74>&#34;delta&#34;</span>: <span style=color:#e6db74>&#34;0:00:00.361005&#34;</span>, <span style=color:#e6db74>&#34;end&#34;</span>: <span style=color:#e6db74>&#34;2022-01-09 15:05:17.409020&#34;</span>, <span style=color:#e6db74>&#34;item&#34;</span>: <span style=color:#e6db74>&#34;hostname&#34;</span>, <span style=color:#e6db74>&#34;rc&#34;</span>: 0, <span style=color:#e6db74>&#34;start&#34;</span>: <span style=color:#e6db74>&#34;2022-01-09 15:05:17.048015&#34;</span>, <span style=color:#e6db74>&#34;stderr&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;stderr_lines&#34;</span>: <span style=color:#f92672>[]</span>, <span style=color:#e6db74>&#34;stdout&#34;</span>: <span style=color:#e6db74>&#34;node1&#34;</span>, <span style=color:#e6db74>&#34;stdout_lines&#34;</span>: <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;node1&#34;</span><span style=color:#f92672>]}</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>node2<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>(</span>item<span style=color:#f92672>=</span>uptime -p<span style=color:#f92672>)</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;ansible_loop_var&#34;</span>: <span style=color:#e6db74>&#34;item&#34;</span>, <span style=color:#e6db74>&#34;changed&#34;</span>: true, <span style=color:#e6db74>&#34;cmd&#34;</span>: <span style=color:#e6db74>&#34;uptime -p&#34;</span>, <span style=color:#e6db74>&#34;delta&#34;</span>: <span style=color:#e6db74>&#34;0:00:00.006628&#34;</span>, <span style=color:#e6db74>&#34;end&#34;</span>: <span style=color:#e6db74>&#34;2022-01-09 15:05:17.610052&#34;</span>, <span style=color:#e6db74>&#34;item&#34;</span>: <span style=color:#e6db74>&#34;uptime -p&#34;</span>, <span style=color:#e6db74>&#34;rc&#34;</span>: 0, <span style=color:#e6db74>&#34;start&#34;</span>: <span style=color:#e6db74>&#34;2022-01-09 15:05:17.603424&#34;</span>, <span style=color:#e6db74>&#34;stderr&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;stderr_lines&#34;</span>: <span style=color:#f92672>[]</span>, <span style=color:#e6db74>&#34;stdout&#34;</span>: <span style=color:#e6db74>&#34;up 3 weeks, 2 days, 19 hours, 42 minutes&#34;</span>, <span style=color:#e6db74>&#34;stdout_lines&#34;</span>: <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;up 3 weeks, 2 days, 19 hours, 42 minutes&#34;</span><span style=color:#f92672>]}</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>node1<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>(</span>item<span style=color:#f92672>=</span>uptime -p<span style=color:#f92672>)</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;ansible_loop_var&#34;</span>: <span style=color:#e6db74>&#34;item&#34;</span>, <span style=color:#e6db74>&#34;changed&#34;</span>: true, <span style=color:#e6db74>&#34;cmd&#34;</span>: <span style=color:#e6db74>&#34;uptime -p&#34;</span>, <span style=color:#e6db74>&#34;delta&#34;</span>: <span style=color:#e6db74>&#34;0:00:00.074039&#34;</span>, <span style=color:#e6db74>&#34;end&#34;</span>: <span style=color:#e6db74>&#34;2022-01-09 15:05:18.006283&#34;</span>, <span style=color:#e6db74>&#34;item&#34;</span>: <span style=color:#e6db74>&#34;uptime -p&#34;</span>, <span style=color:#e6db74>&#34;rc&#34;</span>: 0, <span style=color:#e6db74>&#34;start&#34;</span>: <span style=color:#e6db74>&#34;2022-01-09 15:05:17.932244&#34;</span>, <span style=color:#e6db74>&#34;stderr&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;stderr_lines&#34;</span>: <span style=color:#f92672>[]</span>, <span style=color:#e6db74>&#34;stdout&#34;</span>: <span style=color:#e6db74>&#34;up 3 weeks, 2 days, 19 hours, 42 minutes&#34;</span>, <span style=color:#e6db74>&#34;stdout_lines&#34;</span>: <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;up 3 weeks, 2 days, 19 hours, 42 minutes&#34;</span><span style=color:#f92672>]}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP ************************************************************************************************************************
</span></span><span style=display:flex><span>node1                      : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>node2                      : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span></code></pre></div><p><strong>迭代hash哈希列表：</strong></p><p>列表元素为字典</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>task1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>shell</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>cmd</span>: <span style=color:#e6db74>&#34;{{ item.cmd }}&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>creates</span>: <span style=color:#e6db74>&#34;{{ item[&#39;condition&#39;] }}&#34;</span>				<span style=color:#75715e># 两种引用方式均可</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>loop</span>:
</span></span><span style=display:flex><span>    - { <span style=color:#f92672>cmd: &#39;hostname&#39;, condition</span>: <span style=color:#e6db74>&#39;/tmp&#39;</span> }			<span style=color:#75715e># 这个循环将被跳过</span>
</span></span><span style=display:flex><span>    - { <span style=color:#f92672>cmd: &#39;uptime&#39;, condition</span>: <span style=color:#e6db74>&#39;/aaa&#39;</span> }					
</span></span></code></pre></div><p>示例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@master ansible<span style=color:#f92672>]</span><span style=color:#75715e># cat loop.yaml</span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>- name: loop
</span></span><span style=display:flex><span>  hosts: all
</span></span><span style=display:flex><span>  gather_facts: no
</span></span><span style=display:flex><span>  tasks:
</span></span><span style=display:flex><span>    - name: task1
</span></span><span style=display:flex><span>      shell:
</span></span><span style=display:flex><span>        cmd: <span style=color:#e6db74>&#34;{{ item.cmd }}&#34;</span>
</span></span><span style=display:flex><span>        creates: <span style=color:#e6db74>&#34;{{ item.condition }}&#34;</span>
</span></span><span style=display:flex><span>      loop:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>{</span> cmd: <span style=color:#e6db74>&#39;hostname&#39;</span>, condition: <span style=color:#e6db74>&#39;/tmp&#39;</span> <span style=color:#f92672>}</span>		<span style=color:#75715e># 这个循环将被跳过，[&#34;skipped, since /tmp exists&#34;]，任务没有跳过</span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>{</span> cmd: <span style=color:#e6db74>&#39;uptime&#39;</span>, condition: <span style=color:#e6db74>&#39;/aaa&#39;</span> <span style=color:#f92672>}</span>				
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@master ansible<span style=color:#f92672>]</span><span style=color:#75715e>#</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@master ansible<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook -v loop.yaml</span>
</span></span><span style=display:flex><span>Using /etc/ansible/ansible.cfg as config file
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY <span style=color:#f92672>[</span>loop<span style=color:#f92672>]</span> ***********************************************************************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>task1<span style=color:#f92672>]</span> **********************************************************************************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>node2<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>(</span>item<span style=color:#f92672>={</span>u<span style=color:#e6db74>&#39;cmd&#39;</span>: u<span style=color:#e6db74>&#39;hostname&#39;</span>, u<span style=color:#e6db74>&#39;condition&#39;</span>: u<span style=color:#e6db74>&#39;/tmp&#39;</span><span style=color:#f92672>})</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;ansible_facts&#34;</span>: <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;discovered_interpreter_python&#34;</span>: <span style=color:#e6db74>&#34;/usr/bin/python&#34;</span><span style=color:#f92672>}</span>, <span style=color:#e6db74>&#34;ansible_loop_var&#34;</span>: <span style=color:#e6db74>&#34;item&#34;</span>, <span style=color:#e6db74>&#34;changed&#34;</span>: false, <span style=color:#e6db74>&#34;cmd&#34;</span>: <span style=color:#e6db74>&#34;hostname&#34;</span>, <span style=color:#e6db74>&#34;item&#34;</span>: <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;cmd&#34;</span>: <span style=color:#e6db74>&#34;hostname&#34;</span>, <span style=color:#e6db74>&#34;condition&#34;</span>: <span style=color:#e6db74>&#34;/tmp&#34;</span><span style=color:#f92672>}</span>, <span style=color:#e6db74>&#34;rc&#34;</span>: 0, <span style=color:#e6db74>&#34;stdout&#34;</span>: <span style=color:#e6db74>&#34;skipped, since /tmp exists&#34;</span>, <span style=color:#e6db74>&#34;stdout_lines&#34;</span>: <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;skipped, since /tmp exists&#34;</span><span style=color:#f92672>]}</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>node2<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>(</span>item<span style=color:#f92672>={</span>u<span style=color:#e6db74>&#39;cmd&#39;</span>: u<span style=color:#e6db74>&#39;uptime&#39;</span>, u<span style=color:#e6db74>&#39;condition&#39;</span>: u<span style=color:#e6db74>&#39;/aaa&#39;</span><span style=color:#f92672>})</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;ansible_loop_var&#34;</span>: <span style=color:#e6db74>&#34;item&#34;</span>, <span style=color:#e6db74>&#34;changed&#34;</span>: true, <span style=color:#e6db74>&#34;cmd&#34;</span>: <span style=color:#e6db74>&#34;uptime&#34;</span>, <span style=color:#e6db74>&#34;delta&#34;</span>: <span style=color:#e6db74>&#34;0:00:00.024675&#34;</span>, <span style=color:#e6db74>&#34;end&#34;</span>: <span style=color:#e6db74>&#34;2022-01-09 15:21:23.286758&#34;</span>, <span style=color:#e6db74>&#34;item&#34;</span>: <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;cmd&#34;</span>: <span style=color:#e6db74>&#34;uptime&#34;</span>, <span style=color:#e6db74>&#34;condition&#34;</span>: <span style=color:#e6db74>&#34;/aaa&#34;</span><span style=color:#f92672>}</span>, <span style=color:#e6db74>&#34;rc&#34;</span>: 0, <span style=color:#e6db74>&#34;start&#34;</span>: <span style=color:#e6db74>&#34;2022-01-09 15:21:23.262083&#34;</span>, <span style=color:#e6db74>&#34;stderr&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;stderr_lines&#34;</span>: <span style=color:#f92672>[]</span>, <span style=color:#e6db74>&#34;stdout&#34;</span>: <span style=color:#e6db74>&#34; 15:21:23 up 23 days, 19:58,  2 users,  load average: 0.13, 0.14, 0.20&#34;</span>, <span style=color:#e6db74>&#34;stdout_lines&#34;</span>: <span style=color:#f92672>[</span><span style=color:#e6db74>&#34; 15:21:23 up 23 days, 19:58,  2 users,  load average: 0.13, 0.14, 0.20&#34;</span><span style=color:#f92672>]}</span>
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>node1<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>(</span>item<span style=color:#f92672>={</span>u<span style=color:#e6db74>&#39;cmd&#39;</span>: u<span style=color:#e6db74>&#39;hostname&#39;</span>, u<span style=color:#e6db74>&#39;condition&#39;</span>: u<span style=color:#e6db74>&#39;/tmp&#39;</span><span style=color:#f92672>})</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;ansible_facts&#34;</span>: <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;discovered_interpreter_python&#34;</span>: <span style=color:#e6db74>&#34;/usr/bin/python&#34;</span><span style=color:#f92672>}</span>, <span style=color:#e6db74>&#34;ansible_loop_var&#34;</span>: <span style=color:#e6db74>&#34;item&#34;</span>, <span style=color:#e6db74>&#34;changed&#34;</span>: false, <span style=color:#e6db74>&#34;cmd&#34;</span>: <span style=color:#e6db74>&#34;hostname&#34;</span>, <span style=color:#e6db74>&#34;item&#34;</span>: <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;cmd&#34;</span>: <span style=color:#e6db74>&#34;hostname&#34;</span>, <span style=color:#e6db74>&#34;condition&#34;</span>: <span style=color:#e6db74>&#34;/tmp&#34;</span><span style=color:#f92672>}</span>, <span style=color:#e6db74>&#34;rc&#34;</span>: 0, <span style=color:#e6db74>&#34;stdout&#34;</span>: <span style=color:#e6db74>&#34;skipped, since /tmp exists&#34;</span>, <span style=color:#e6db74>&#34;stdout_lines&#34;</span>: <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;skipped, since /tmp exists&#34;</span><span style=color:#f92672>]}</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>node1<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>(</span>item<span style=color:#f92672>={</span>u<span style=color:#e6db74>&#39;cmd&#39;</span>: u<span style=color:#e6db74>&#39;uptime&#39;</span>, u<span style=color:#e6db74>&#39;condition&#39;</span>: u<span style=color:#e6db74>&#39;/aaa&#39;</span><span style=color:#f92672>})</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;ansible_loop_var&#34;</span>: <span style=color:#e6db74>&#34;item&#34;</span>, <span style=color:#e6db74>&#34;changed&#34;</span>: true, <span style=color:#e6db74>&#34;cmd&#34;</span>: <span style=color:#e6db74>&#34;uptime&#34;</span>, <span style=color:#e6db74>&#34;delta&#34;</span>: <span style=color:#e6db74>&#34;0:00:00.386491&#34;</span>, <span style=color:#e6db74>&#34;end&#34;</span>: <span style=color:#e6db74>&#34;2022-01-09 15:21:30.029184&#34;</span>, <span style=color:#e6db74>&#34;item&#34;</span>: <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;cmd&#34;</span>: <span style=color:#e6db74>&#34;uptime&#34;</span>, <span style=color:#e6db74>&#34;condition&#34;</span>: <span style=color:#e6db74>&#34;/aaa&#34;</span><span style=color:#f92672>}</span>, <span style=color:#e6db74>&#34;rc&#34;</span>: 0, <span style=color:#e6db74>&#34;start&#34;</span>: <span style=color:#e6db74>&#34;2022-01-09 15:21:29.642693&#34;</span>, <span style=color:#e6db74>&#34;stderr&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;stderr_lines&#34;</span>: <span style=color:#f92672>[]</span>, <span style=color:#e6db74>&#34;stdout&#34;</span>: <span style=color:#e6db74>&#34; 15:21:30 up 23 days, 19:58,  2 users,  load average: 0.90, 0.51, 0.35&#34;</span>, <span style=color:#e6db74>&#34;stdout_lines&#34;</span>: <span style=color:#f92672>[</span><span style=color:#e6db74>&#34; 15:21:30 up 23 days, 19:58,  2 users,  load average: 0.90, 0.51, 0.35&#34;</span><span style=color:#f92672>]}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP ************************************************************************************************************************
</span></span><span style=display:flex><span>node1                      : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>node2                      : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span></code></pre></div><h3 id=迭代字典>迭代字典</h3><p><code>loop</code>指令无法直接迭代字典，需要使用过滤器<code>dict2items</code>进行转换，如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Using dict2items</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ansible.builtin.debug</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;{{ item.key }} - {{ item.value }}&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>loop</span>: <span style=color:#e6db74>&#34;{{ tag_data | dict2items }}&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>vars</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>tag_data</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>Environment</span>: <span style=color:#ae81ff>dev</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>Application</span>: <span style=color:#ae81ff>payment</span>
</span></span></code></pre></div><p>上例中，通过迭代tag_data来打印它的key和value。</p><blockquote><p><code>when</code>指令和<code>loop</code>指令同时使用时，先进行循环，再在每个循环中进行条件判断。</p></blockquote><h2 id=notify和handlers>notify和handlers</h2><p>ansible中的一个重要概念<code>changed</code>，它表示目标状态是否发生改变，即本次任务是否执行、执行后是否影响结果。如果changed=1，则表示目标状态发生改变；如果changed=0，则表示目标状态未发生改变，或者任务没有执行。</p><p>ansible若监视到<code>changed=1</code>，就会触发<code>notify</code>指令所定义的<code>handler</code>。handler，也是一个task，只是定义在<code>handlers</code>中，需要notify来触发执行。</p><p>handlers的使用与tasks使用一样，<strong>notify和hanlders中任务名称必须一样</strong>。</p><p>**当一个play中所有任务都执行完成后，handler才会执行。**好处是可以多次触发notify，但最后只执行一次对应的handler。</p><p>示例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>notify and handlers</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>all</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>gather_facts</span>: <span style=color:#66d9ef>no</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>task1</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>shell</span>: <span style=color:#ae81ff>uptime</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>notify</span>: <span style=color:#ae81ff>hello</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>handlers</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>hello</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;hello world&#34;</span>
</span></span></code></pre></div><p>执行结果：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@master ansible<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook notify.yaml</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY <span style=color:#f92672>[</span>notify and handlers<span style=color:#f92672>]</span> ********************************************************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>task1<span style=color:#f92672>]</span> **********************************************************************************************************************
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>node2<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>node1<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>RUNNING HANDLER <span style=color:#f92672>[</span>hello<span style=color:#f92672>]</span> ***********************************************************************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>node2<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>MSG:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>hello world
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>node1<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>MSG:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>hello world
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP ************************************************************************************************************************
</span></span><span style=display:flex><span>node1                      : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>node2                      : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span></code></pre></div><h2 id=组织playbook>组织playbook</h2><p>将所有play全部写在一个yaml文件中，固然可行，但是可读性、维护性太差。</p><p>比较好的做法是，将同类任务的play放在一个文件中。多个任务，则写成多个文件，最后使用一个入口文件来引用这些任务文件。</p><p>假设入口文件名为main.yaml，在该文件中使用<code>import_playbook</code>指令引用其它playbook：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>import_playbook</span>: <span style=color:#e6db74>&#34;init_server/aaa.yaml&#34;</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>import_playbook</span>: <span style=color:#e6db74>&#34;init_server/bbb.yaml&#34;</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>import_playbook</span>: <span style=color:#e6db74>&#34;init_server/ccc.yaml&#34;</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>import_playbook</span>: <span style=color:#e6db74>&#34;init_server/ddd.yaml&#34;</span>
</span></span></code></pre></div><p>执行方式不变：<code>ansible-playbook main.yaml</code></p><h2 id=组织各类内容taskhandler变量>组织各类内容：task、handler、变量</h2><blockquote><p>上面介绍了使用playbook指令来引入多个playbook文件，从而提高可读性和维护性。</p><p>其实，ansible还提供了更加规范的方式，来组织更多的内容，即<code>role</code>和<code>colllection</code>，collection这里暂不涉及。</p></blockquote><p>ansible可组织的内容包括：</p><ul><li><code>playbook</code></li><li><code>task</code></li><li><code>variable</code></li><li><code>handler</code>（handler也是一个task，只是编写在handlers内部）</li><li><code>role</code></li></ul><p>可组织的意思是说，可将相同内容定义在同一个文件中，然后使用相关指令来引入指定文件内容。</p><ul><li>引入<code>palybook</code>：<code>import_playbook</code></li><li>引入<code>task</code>或<code>handler</code>：<code>import_tasks</code>、<code>include_tasks</code></li><li>引入<code>variable</code>：<code>vars_files</code>、<code>include_vars</code></li><li>引入<code>role</code>：<code>import_role</code>、<code>include_role</code>、<code>roles</code></li></ul><p>import和include两种引入方式有所区别，前者为<code>静态加载</code>（在playbook解析的阶段，内容将写入到引入的位置），后者为<code>动态加载</code>（解析阶段不引入，而是在执行阶段才引入）。</p><h3 id=组织tasks>组织tasks</h3><p>可将task单独写在一个文件中，然后在play里使用<code>import_tasks</code>、<code>include_tasks</code>模块引入。</p><p><strong>示例：</strong></p><p>编写一个tasks文件tasks.yaml：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>task1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;hello&#34;</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>task2</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;world&#34;</span>
</span></span></code></pre></div><p>在playbook中引入：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>play1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>node1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>gather_facts</span>: <span style=color:#66d9ef>no</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>task1 &amp; task2</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>import_tasks</span>: <span style=color:#ae81ff>tasks.yaml		# include_tasks模块也行</span>
</span></span></code></pre></div><p><strong>在循环中引入tasks文件，必须使用include_tasks指令</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>play1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>node1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>gather_facts</span>: <span style=color:#66d9ef>no</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>loop tasks</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>include_tasks</span>: <span style=color:#ae81ff>tasks.yaml</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>loop</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>one</span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>two</span>
</span></span></code></pre></div><h3 id=组织handlers>组织handlers</h3><p>一般情况下playbook的handlers如下，在task中使用handler的任务名来触发</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>play1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>node1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>gather_facts</span>: <span style=color:#66d9ef>no</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>task1</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>shell</span>: <span style=color:#ae81ff>uptime</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>notify</span>: <span style=color:#ae81ff>h1</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>task2</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>shell</span>: <span style=color:#ae81ff>date</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>notify</span>: <span style=color:#ae81ff>h2</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>handlers</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>h1</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;run h1&#34;</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>h2</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;run h2&#34;</span>
</span></span></code></pre></div><p>可将handler单独编写在一个文件中，如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cat handler1.yaml
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>- name: handler1
</span></span><span style=display:flex><span>  debug:
</span></span><span style=display:flex><span>    msg: <span style=color:#e6db74>&#34;run handler1&#34;</span>
</span></span><span style=display:flex><span>$ cat handler2.yaml
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>- name: handler2
</span></span><span style=display:flex><span>  debug:
</span></span><span style=display:flex><span>    msg: <span style=color:#e6db74>&#34;run handler2&#34;</span>
</span></span></code></pre></div><p>然后在playbook中使用<code>import_tasks</code>或<code>include_tasks</code>指令来引入，同时在<code>notify</code>中修改对应的<code>handler</code>名：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>play1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>node1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>gather_facts</span>: <span style=color:#66d9ef>no</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>task1</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>shell</span>: <span style=color:#ae81ff>uptime</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>notify</span>: <span style=color:#ae81ff>handler1				#	handler1为静态引入，notify使用handler名</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>task2</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>shell</span>: <span style=color:#ae81ff>date</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>notify</span>: <span style=color:#ae81ff>h2				#	handler2为动态引入，notify使用引入的任务名</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>handlers</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>h1</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>import_tasks</span>: <span style=color:#ae81ff>handler1.yaml		#	import_tasks静态引入</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>h2</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>include_tasks</span>: <span style=color:#ae81ff>handler2.yaml		#	include_tasks动态引入</span>
</span></span></code></pre></div><h3 id=组织变量>组织变量</h3><p>前面已经介绍了如何在playbook中使用<code>var</code>指令直接设置变量，除了这个方法，ansible还支持将变量单独放在一个文件中，然后在play中使用<code>vars_files</code>指令或<code>include_vars</code>模块来引入该变量文件。也可以在命令行中，使用<code>-e</code>选项（&ndash;extra_vars）来设置变量或引入变量文件。</p><p><code>vars_files</code>是<code>play</code>级别的指令，用于play中，在playbook解析阶段引入变量文件；</p><p><code>include_vars</code>是任务模块（类似模块一样），用在tasks中定义一个引入变量的任务，只有该任务执行之后，才会创建变量；</p><p><code>-e</code>选项在命令行中，全局有效；</p><h4 id=vars_files示例>vars_files示例</h4><p>变量文件varfile.yaml，变量的定义一样，使用yaml或json格式，可采用字典或列表的形式。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>foo</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>a</span>: <span style=color:#ae81ff>hello</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>b</span>: <span style=color:#ae81ff>world</span>
</span></span></code></pre></div><p>playbook文件如下，使用vars_files指令来引入：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>play1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>node1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>gather_facts</span>: <span style=color:#66d9ef>no</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>vars_files</span>:
</span></span><span style=display:flex><span>     - <span style=color:#ae81ff>varfile.yaml				#	多个变量文件，使用列表形式即可</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>task1</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;{{foo.a}} {{foo.b}}&#34;</span>
</span></span></code></pre></div><h4 id=include_vars模块>include_vars模块</h4><p>include_vars是模块提供的功能，它是一个手动创建的任务，和shell、debug等模块一样。所以只有当任务执行完后，相关变量才会创建。</p><p>下面介绍几个用法。</p><p>引入一个文件：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>play1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>node1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>gather_facts</span>: <span style=color:#66d9ef>no</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>vars_files</span>:
</span></span><span style=display:flex><span>     - <span style=color:#ae81ff>varfile.yaml</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>task1</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>include_vars</span>: <span style=color:#ae81ff>varfile.yaml		# 引入之后，可在后续的任务中使用</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>task2</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;{{foo.a}} {{foo.b}}&#34;</span>
</span></span></code></pre></div><p>引入多个文件，可采用循环：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>task1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>include_vars</span>: <span style=color:#e6db74>&#34;{{ item }}&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>loop</span>:
</span></span><span style=display:flex><span>  	- <span style=color:#ae81ff>varfile1.yaml</span>
</span></span><span style=display:flex><span>  	- <span style=color:#ae81ff>varfile2.yaml</span>
</span></span></code></pre></div><p>还可以引入目录，使用条件和其它参数控制引入的变量文件。这里不展开了，该模块有很多参数和用法，具体可参考官网：</p><blockquote><p><a href=https://docs.ansible.com/ansible/latest/collections/ansible/builtin/include_vars_module.html#ansible-collections-ansible-builtin-include-vars-module target=_blank rel="noopener noreffer">https://docs.ansible.com/ansible/latest/collections/ansible/builtin/include_vars_module.html#ansible-collections-ansible-builtin-include-vars-module</a></p></blockquote><h4 id=-e选项>-e选项</h4><p>ansible-playbook命令的-e选项或&ndash;extra-vars选项也可以用来定义变量或引入变量文件：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 定义单个变量</span>
</span></span><span style=display:flex><span>$ ansible-playbook -e <span style=color:#e6db74>&#39;var1=&#34;value1&#34;&#39;</span> xxx.yml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 定义多个变量</span>
</span></span><span style=display:flex><span>$ ansible-playbook -e <span style=color:#e6db74>&#39;var1=&#34;value1&#34; var2=&#34;value2&#34;&#39;</span> xxx.yml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 引入单个变量文件</span>
</span></span><span style=display:flex><span>$ ansible-playbook -e <span style=color:#e6db74>&#39;@varfile1.yml&#39;</span> xxx.yml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 引入多个变量文件</span>
</span></span><span style=display:flex><span>$ ansible-playbook -e <span style=color:#e6db74>&#39;@varfile1.yml&#39;</span> -e <span style=color:#e6db74>&#39;@varfile2.yml&#39;</span> xxx.yml
</span></span></code></pre></div><h2 id=使用role>使用role</h2><p>上面将各类内容放在单独的文件中，然后使用相关指令或模块将其引入。ansible中，有一种更为规范的组织方式，即<code>role</code>。</p><p>使用<code>role</code>，即可无需手动使用这些指令或模块了。按照role指定的文件或目录存放对应的内容，ansible就会自动引入。</p><h3 id=role的文件结构>role的文件结构</h3><p><code>ansible-galaxy init role1</code>命令，可以快速创建一个<code>role</code>框架。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cd /etc/ansible/roles
</span></span><span style=display:flex><span>$ ansible-galaxy init role01
</span></span><span style=display:flex><span>$ tree role01
</span></span><span style=display:flex><span>role01
</span></span><span style=display:flex><span>├── defaults
</span></span><span style=display:flex><span>│   └── main.yml
</span></span><span style=display:flex><span>├── files		    <span style=color:#75715e># 外部文件，放入此处的文件，在role的各种任务中直接无需使用全路径</span>
</span></span><span style=display:flex><span>├── handlers
</span></span><span style=display:flex><span>│   └── main.yml	    <span style=color:#75715e># 存放handler</span>
</span></span><span style=display:flex><span>├── meta
</span></span><span style=display:flex><span>│   └── main.yml	    <span style=color:#75715e># 该role依赖的先行role。定义在此处的role将在该role运行前执行</span>
</span></span><span style=display:flex><span>├── README.md
</span></span><span style=display:flex><span>├── tasks
</span></span><span style=display:flex><span>│   └── main.yml	    <span style=color:#75715e># 存放任务</span>
</span></span><span style=display:flex><span>├── templates		    <span style=color:#75715e># 模板文件，放入此处的文件，在role的各种任务中无需使用全路径		</span>
</span></span><span style=display:flex><span>├── tests
</span></span><span style=display:flex><span>│   ├── inventory
</span></span><span style=display:flex><span>│   └── test.yml
</span></span><span style=display:flex><span>└── vars
</span></span><span style=display:flex><span>    └── main.yml	    <span style=color:#75715e># 存放变量</span>
</span></span></code></pre></div><p>在相应目录及文件下编写对应内容，然后还需要提供一个入口playbook文件。在入口playbook文件中，使用<code>import_roles</code>、<code>include_role</code>、<code>roles</code>指令来引入role。最后使用ansible-playbook命令执行入口文件，即可执行定义在role中的各种任务了。</p><p><strong>enter.yml文件如下：</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>enter for all roles</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>node1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>gather_facts</span>: <span style=color:#66d9ef>no</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>roles</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>role01					# 多个role可使用列表一起列出</span>
</span></span></code></pre></div><h3 id=编写一个role>编写一个role</h3><h4 id=定义role的变量>定义role的变量</h4><p><code>etc/ansible/roles/role01/vars/main.yml</code>文件是role定义变量或引入变量文件的地方。</p><p><code>etc/ansible/roles/role01/defaults/main.yml</code>文件是role定义默认变量的地方，优先级较低，当然也可以引入文件。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#75715e># vars file for role01</span>
</span></span><span style=display:flex><span><span style=color:#f92672>foo1</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>a</span>: <span style=color:#ae81ff>hello</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>b</span>: <span style=color:#ae81ff>world</span>
</span></span></code></pre></div><h4 id=定义role的task>定义role的task</h4><p><code>/etc/ansible/roles/role01/tasks/main.yml</code>文件是role定义task或者引入task文件的地方。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#75715e># tasks file for role01</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>task1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;{{ foo1.a }} {{ foo1.b }}&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>notify</span>: <span style=color:#ae81ff>handler1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>changed_when</span>: <span style=color:#66d9ef>true</span>				<span style=color:#75715e># 该指令使得chenged=1，触发notify</span>
</span></span></code></pre></div><h4 id=定义role的handler>定义role的handler</h4><p><code>/etc/ansible/roles/role01/handles/main.yml</code>文件是role定义handler或者引入handler文件的地方。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#75715e># handlers file for role01</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>handler1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;run handler1&#34;</span>
</span></span></code></pre></div><p><strong>执行：</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ansible-playbook  enter.yml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY <span style=color:#f92672>[</span>enter <span style=color:#66d9ef>for</span> all roles<span style=color:#f92672>]</span> **********************************************************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>role01 : task1<span style=color:#f92672>]</span> ***************************************************************************************************************
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>node1<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>MSG:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>hello world
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>RUNNING HANDLER <span style=color:#f92672>[</span>role01 : handler1<span style=color:#f92672>]</span> *************************************************************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>node1<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>MSG:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>run handler1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP **************************************************************************************************************************
</span></span><span style=display:flex><span>node1                      : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span></code></pre></div><h2 id=playbook的执行顺序>playbook的执行顺序</h2><p><code>playbook</code>从上往下执行各个<code>play</code>，在每个<code>play</code>内，从上往下执行各个<code>task</code>。</p><p>一个节点执行任务的顺序如下：</p><ul><li>解析配置/etc/ansible/ansible.cfg</li><li>解析inventory</li><li>gather_facts任务</li><li>pre_tasks任务</li><li>pre_tasks任务触发的handler</li><li>roles指令加载的role</li><li>task指令中的任务</li><li>roles和tasks触发的handler</li><li>post_tasks指令中的任务</li><li>post_tasks中任务触发的handler</li></ul><p>多个节点时，<code>ansible</code>在所有节点上执行完成前一个任务后，才进入下一个任务的执行流程。<code>handlers</code>是在所有节点上的所有任务执行完成后，开始执行。</p><blockquote><ul><li>从inventory中选择执行play的相关主机</li><li>连接到远程主机，通常使用ssh方式</li><li>拷贝相关模块到远程主机，并开始执行</li></ul></blockquote><h3 id=理解委托任务>理解委托任务</h3><p>委托是指将原本在一个节点上执行的任务，委托给另一个节点执行。</p><p>要想理解委托，需要先了解ansible任务的执行过程：默认情况下，ansible先选择执行任务的主机，后连接该主机，再拷贝相关模块，并在该远程主机上执行模块。</p><p>但是在任务中进行了委托后，实际连接主机和执行模块动作将发生改变。比如将node1主机的任务委托给node2，ansible会根据hosts指令选择远程主机node1后，然后根据<code>delegate_to</code>指令，连接到node2节点，并将相关模块拷贝到node2并在node2上执行。</p><p>以下使用<code>dalegate_to</code>指令做个演示</p><p>test.yaml文件：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>play1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>node1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>gather_facts</span>: <span style=color:#66d9ef>no</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>task1</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>shell</span>: <span style=color:#ae81ff>hostname</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>delegate_to</span>: <span style=color:#ae81ff>node2			# 委托node2执行shell模块</span>
</span></span></code></pre></div><p>执行<code>ansible-playbook -vvv test.yaml</code>，然后查看具体的执行日志。</p><p>再将<code>delegate_to</code>指令去除，执行<code>ansible-playbook -vvv test.yaml</code>命令查看不委托的执行过程，两者对比很容易发现ansible连接的主机为委托的主机。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ansible-playbook -vvv test.yaml
</span></span></code></pre></div><p>打印输出日志如下，也可在<code>/var/log/ansible.log</code>中查看。</p><pre tabindex=0><code class=language-/var/log/ansible.log data-lang=/var/log/ansible.log>ansible-playbook 2.9.25
  config file = /etc/ansible/ansible.cfg
  configured module search path = [u&#39;/root/.ansible/plugins/modules&#39;, u&#39;/usr/share/ansible/plugins/modules&#39;]
  ansible python module location = /usr/lib/python2.7/site-packages/ansible
  executable location = /usr/bin/ansible-playbook
  python version = 2.7.5 (default, Oct 14 2020, 14:45:30) [GCC 4.8.5 20150623 (Red Hat 4.8.5-44)]
Using /etc/ansible/ansible.cfg as config file
host_list declined parsing /etc/ansible/hosts as it did not pass its verify_file() method
script declined parsing /etc/ansible/hosts as it did not pass its verify_file() method
auto declined parsing /etc/ansible/hosts as it did not pass its verify_file() method
Parsed /etc/ansible/hosts inventory source with ini plugin
Skipping callback &#39;actionable&#39;, as we already have a stdout callback.
Skipping callback &#39;counter_enabled&#39;, as we already have a stdout callback.
Skipping callback &#39;debug&#39;, as we already have a stdout callback.
Skipping callback &#39;dense&#39;, as we already have a stdout callback.
Skipping callback &#39;dense&#39;, as we already have a stdout callback.
Skipping callback &#39;full_skip&#39;, as we already have a stdout callback.
Skipping callback &#39;json&#39;, as we already have a stdout callback.
Skipping callback &#39;minimal&#39;, as we already have a stdout callback.
Skipping callback &#39;null&#39;, as we already have a stdout callback.
Skipping callback &#39;oneline&#39;, as we already have a stdout callback.
Skipping callback &#39;selective&#39;, as we already have a stdout callback.
Skipping callback &#39;skippy&#39;, as we already have a stdout callback.
Skipping callback &#39;stderr&#39;, as we already have a stdout callback.
Skipping callback &#39;unixy&#39;, as we already have a stdout callback.
Skipping callback &#39;yaml&#39;, as we already have a stdout callback.

PLAYBOOK: test.yaml *****************************************************************************************************************
1 plays in test.yaml

PLAY [play1] ************************************************************************************************************************
META: ran handlers

TASK [task1] ************************************************************************************************************************
task path: /etc/ansible/test.yaml:6
&lt;node2&gt; ESTABLISH SSH CONNECTION FOR USER: None
&lt;node2&gt; SSH: EXEC ssh -C -o ControlMaster=auto -o ControlPersist=60s -o Port=22 -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o ConnectTimeout=10 -o ControlPath=/root/.ansible/cp/0d67807d8c node2 &#39;/bin/sh -c &#39;&#34;&#39;&#34;&#39;echo ~ &amp;&amp; sleep 0&#39;&#34;&#39;&#34;&#39;&#39;
&lt;node2&gt; (0, &#39;/root\n&#39;, &#39;&#39;)
&lt;node2&gt; ESTABLISH SSH CONNECTION FOR USER: None
&lt;node2&gt; SSH: EXEC ssh -C -o ControlMaster=auto -o ControlPersist=60s -o Port=22 -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o ConnectTimeout=10 -o ControlPath=/root/.ansible/cp/0d67807d8c node2 &#39;/bin/sh -c &#39;&#34;&#39;&#34;&#39;( umask 77 &amp;&amp; mkdir -p &#34;` echo /root/.ansible/tmp `&#34;&amp;&amp; mkdir &#34;` echo /root/.ansible/tmp/ansible-tmp-1642857067.57-71643-202799162287554 `&#34; &amp;&amp; echo ansible-tmp-1642857067.57-71643-202799162287554=&#34;` echo /root/.ansible/tmp/ansible-tmp-1642857067.57-71643-202799162287554 `&#34; ) &amp;&amp; sleep 0&#39;&#34;&#39;&#34;&#39;&#39;
&lt;node2&gt; (0, &#39;ansible-tmp-1642857067.57-71643-202799162287554=/root/.ansible/tmp/ansible-tmp-1642857067.57-71643-202799162287554\n&#39;, &#39;&#39;)
&lt;node1&gt; Attempting python interpreter discovery
&lt;node2&gt; ESTABLISH SSH CONNECTION FOR USER: None
&lt;node2&gt; SSH: EXEC ssh -C -o ControlMaster=auto -o ControlPersist=60s -o Port=22 -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o ConnectTimeout=10 -o ControlPath=/root/.ansible/cp/0d67807d8c node2 &#39;/bin/sh -c &#39;&#34;&#39;&#34;&#39;echo PLATFORM; uname; echo FOUND; command -v &#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;/usr/bin/python&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;; command -v &#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;python3.7&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;; command -v &#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;python3.6&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;; command -v &#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;python3.5&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;; command -v &#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;python2.7&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;; command -v &#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;python2.6&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;; command -v &#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;/usr/libexec/platform-python&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;; command -v &#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;/usr/bin/python3&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;; command -v &#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;python&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;&#34;&#39;; echo ENDFOUND &amp;&amp; sleep 0&#39;&#34;&#39;&#34;&#39;&#39;
&lt;node2&gt; (0, &#39;PLATFORM\nLinux\nFOUND\n/usr/bin/python\n/usr/bin/python2.7\n/usr/libexec/platform-python\n/usr/bin/python\nENDFOUND\n&#39;, &#39;&#39;)
&lt;node2&gt; ESTABLISH SSH CONNECTION FOR USER: None
&lt;node2&gt; SSH: EXEC ssh -C -o ControlMaster=auto -o ControlPersist=60s -o Port=22 -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o ConnectTimeout=10 -o ControlPath=/root/.ansible/cp/0d67807d8c node2 &#39;/bin/sh -c &#39;&#34;&#39;&#34;&#39;/usr/bin/python &amp;&amp; sleep 0&#39;&#34;&#39;&#34;&#39;&#39;
&lt;node2&gt; (0, &#39;{&#34;osrelease_content&#34;: &#34;NAME=\\&#34;CentOS Linux\\&#34;\\nVERSION=\\&#34;7 (Core)\\&#34;\\nID=\\&#34;centos\\&#34;\\nID_LIKE=\\&#34;rhel fedora\\&#34;\\nVERSION_ID=\\&#34;7\\&#34;\\nPRETTY_NAME=\\&#34;CentOS Linux 7 (Core)\\&#34;\\nANSI_COLOR=\\&#34;0;31\\&#34;\\nCPE_NAME=\\&#34;cpe:/o:centos:centos:7\\&#34;\\nHOME_URL=\\&#34;https://www.centos.org/\\&#34;\\nBUG_REPORT_URL=\\&#34;https://bugs.centos.org/\\&#34;\\n\\nCENTOS_MANTISBT_PROJECT=\\&#34;CentOS-7\\&#34;\\nCENTOS_MANTISBT_PROJECT_VERSION=\\&#34;7\\&#34;\\nREDHAT_SUPPORT_PRODUCT=\\&#34;centos\\&#34;\\nREDHAT_SUPPORT_PRODUCT_VERSION=\\&#34;7\\&#34;\\n\\n&#34;, &#34;platform_dist_result&#34;: [&#34;centos&#34;, &#34;7.9.2009&#34;, &#34;Core&#34;]}\n&#39;, &#39;&#39;)
Using module file /usr/lib/python2.7/site-packages/ansible/modules/commands/command.py
&lt;node2&gt; PUT /root/.ansible/tmp/ansible-local-71634Zeeqqp/tmpWHppzz TO /root/.ansible/tmp/ansible-tmp-1642857067.57-71643-202799162287554/AnsiballZ_command.py
&lt;node2&gt; SSH: EXEC sftp -b - -C -o ControlMaster=auto -o ControlPersist=60s -o Port=22 -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o ConnectTimeout=10 -o ControlPath=/root/.ansible/cp/0d67807d8c &#39;[node2]&#39;
&lt;node2&gt; (0, &#39;sftp&gt; put /root/.ansible/tmp/ansible-local-71634Zeeqqp/tmpWHppzz /root/.ansible/tmp/ansible-tmp-1642857067.57-71643-202799162287554/AnsiballZ_command.py\n&#39;, &#39;&#39;)
&lt;node2&gt; ESTABLISH SSH CONNECTION FOR USER: None
&lt;node2&gt; SSH: EXEC ssh -C -o ControlMaster=auto -o ControlPersist=60s -o Port=22 -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o ConnectTimeout=10 -o ControlPath=/root/.ansible/cp/0d67807d8c node2 &#39;/bin/sh -c &#39;&#34;&#39;&#34;&#39;chmod u+x /root/.ansible/tmp/ansible-tmp-1642857067.57-71643-202799162287554/ /root/.ansible/tmp/ansible-tmp-1642857067.57-71643-202799162287554/AnsiballZ_command.py &amp;&amp; sleep 0&#39;&#34;&#39;&#34;&#39;&#39;
&lt;node2&gt; (0, &#39;&#39;, &#39;&#39;)
&lt;node2&gt; ESTABLISH SSH CONNECTION FOR USER: None
&lt;node2&gt; SSH: EXEC ssh -C -o ControlMaster=auto -o ControlPersist=60s -o Port=22 -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o ConnectTimeout=10 -o ControlPath=/root/.ansible/cp/0d67807d8c -tt node2 &#39;/bin/sh -c &#39;&#34;&#39;&#34;&#39;/usr/bin/python /root/.ansible/tmp/ansible-tmp-1642857067.57-71643-202799162287554/AnsiballZ_command.py &amp;&amp; sleep 0&#39;&#34;&#39;&#34;&#39;&#39;
&lt;node2&gt; (0, &#39;\r\n{&#34;changed&#34;: true, &#34;end&#34;: &#34;2022-01-22 21:11:09.433351&#34;, &#34;stdout&#34;: &#34;node2&#34;, &#34;cmd&#34;: &#34;hostname&#34;, &#34;rc&#34;: 0, &#34;start&#34;: &#34;2022-01-22 21:11:09.333195&#34;, &#34;stderr&#34;: &#34;&#34;, &#34;delta&#34;: &#34;0:00:00.100156&#34;, &#34;invocation&#34;: {&#34;module_args&#34;: {&#34;creates&#34;: null, &#34;executable&#34;: null, &#34;_uses_shell&#34;: true, &#34;strip_empty_ends&#34;: true, &#34;_raw_params&#34;: &#34;hostname&#34;, &#34;removes&#34;: null, &#34;argv&#34;: null, &#34;warn&#34;: true, &#34;chdir&#34;: null, &#34;stdin_add_newline&#34;: true, &#34;stdin&#34;: null}}}\r\n&#39;, &#39;Shared connection to node2 closed.\r\n&#39;)
&lt;node2&gt; ESTABLISH SSH CONNECTION FOR USER: None
&lt;node2&gt; SSH: EXEC ssh -C -o ControlMaster=auto -o ControlPersist=60s -o Port=22 -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o ConnectTimeout=10 -o ControlPath=/root/.ansible/cp/0d67807d8c node2 &#39;/bin/sh -c &#39;&#34;&#39;&#34;&#39;rm -f -r /root/.ansible/tmp/ansible-tmp-1642857067.57-71643-202799162287554/ &gt; /dev/null 2&gt;&amp;1 &amp;&amp; sleep 0&#39;&#34;&#39;&#34;&#39;&#39;
&lt;node2&gt; (0, &#39;&#39;, &#39;&#39;)
changed: [node1 -&gt; node2] =&gt; {
    &#34;changed&#34;: true, 
    &#34;cmd&#34;: &#34;hostname&#34;, 
    &#34;delta&#34;: &#34;0:00:00.100156&#34;, 
    &#34;end&#34;: &#34;2022-01-22 21:11:09.433351&#34;, 
    &#34;invocation&#34;: {
        &#34;module_args&#34;: {
            &#34;_raw_params&#34;: &#34;hostname&#34;, 
            &#34;_uses_shell&#34;: true, 
            &#34;argv&#34;: null, 
            &#34;chdir&#34;: null, 
            &#34;creates&#34;: null, 
            &#34;executable&#34;: null, 
            &#34;removes&#34;: null, 
            &#34;stdin&#34;: null, 
            &#34;stdin_add_newline&#34;: true, 
            &#34;strip_empty_ends&#34;: true, 
            &#34;warn&#34;: true
        }
    }, 
    &#34;rc&#34;: 0, 
    &#34;start&#34;: &#34;2022-01-22 21:11:09.333195&#34;
}

STDOUT:

node2
META: ran handlers
META: ran handlers

PLAY RECAP **************************************************************************************************************************
node1                      : ok=1    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
</code></pre><hr><p>到此为止，ansible的基础算是过了一遍，对ansible的基础概念、用法有了一个大概的了解，作为入门是够了。</p><p>但是ansible的内容和细节还有很多，包括不限于：</p><ul><li>inventory更加复杂的定义方式</li><li>各种级别的指令</li><li>众多类型的变量和其作用</li><li>各种条件判断</li><li>各类循环，以及其它控制流程</li><li>文件如何加载解析、任务执行的顺序及方式</li><li>更多的模块、插件</li><li>role、vault、jinja2</li><li>配置文件</li><li>二次开发</li></ul></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2022-04-22</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=http://example.org/posts/ansible%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/ data-title=ansible基础教程><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=http://example.org/posts/ansible%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=http://example.org/posts/ansible%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/ data-title=ansible基础教程><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=http://example.org/posts/ansible%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/ data-title=ansible基础教程><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=http://example.org/posts/ansible%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/ data-title=ansible基础教程><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/shell%E8%84%9A%E6%9C%AC%E5%BA%94%E7%94%A8%E9%95%BF%E6%9C%9F%E6%9B%B4%E6%96%B0/ class=prev rel=prev title=shell脚本应用（长期更新）><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>shell脚本应用（长期更新）</a>
<a href=/posts/git%E5%85%A5%E9%97%A8/ class=next rel=next title=git入门>git入门<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.115.3">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank></a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>