<!doctype html><html lang=zh-CN><head><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><meta name=description content="Dockerfile指令详解 - https://www.haipengv.com/posts/dockerfile%E6%8C%87%E4%BB%A4%E8%AF%A6%E8%A7%A3/"><meta name=author content="Smith - https://www.haipengv.com/"><meta name=msvalidate.01 content="B46311949B856F2A7015F366FB3CE878"><title>Dockerfile指令详解</title><base target=_self><link rel=icon type=image/png href=/favicon.ico><link rel=stylesheet href=https://www.haipengv.com/style.min.9a0cea23154ac1941e15c25aa2d31b77285a217d2606ec05b55236428cf1c3e6.css><script>const DARK=!1</script><script type=text/javascript src=/main.js defer></script></head><body class=active-animate><div class=cool-before></div><div id=header><div class=container-header><div class=right><h1 class=title>Dockerfile指令详解</h1><div id=toc>📜</div></div></div></div><div id=content><div class="container-main container-page"><div class=rel><div class=curtag-desc><a href=https://www.haipengv.com/tags/docker/><img src=/imgs/icons/tag.svg width=16> 相关文章：Docker <sup>24</sup></a></div><div class=curtag-post><div class=curtag-post-item><a href=https://www.haipengv.com/posts/centos7.3%E7%A6%BB%E7%BA%BF%E5%AE%89%E8%A3%85docker/>Centos7.3离线安装docker</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/centos7%E9%85%8D%E7%BD%AEdocker/>Centos7配置docker</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/docker-compose%E6%90%AD%E5%BB%BAmysql8/>Docker Compose搭建mysql8</a></div><div class="curtag-post-item curtag-post-item--active"><a href=https://www.haipengv.com/posts/dockerfile%E6%8C%87%E4%BB%A4%E8%AF%A6%E8%A7%A3/>Dockerfile指令详解</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/docker%E5%86%B7%E9%97%A8%E6%8A%80%E5%B7%A7/>Docker冷门技巧</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/docker%E5%88%9B%E5%BB%BA%E4%B8%93%E6%9C%89%E7%BD%91%E5%8D%A1/>Docker创建专有网卡</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/docker%E5%88%9B%E5%BB%BA%E5%AE%B9%E5%99%A8rm%E5%8F%82%E6%95%B0%E4%BD%BF%E7%94%A8/>Docker创建容器rm参数使用</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/docker%E5%9F%BA%E7%A1%80/>Docker基础</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/docker%E5%AE%89%E8%A3%85jupyter/>Docker安装jupyter</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/docker%E5%AE%9E%E7%94%A8%E6%8A%80%E5%B7%A7%E4%B8%8E%E7%AE%A1%E7%90%86%E6%8C%87%E5%8D%97/>Docker实用技巧与管理指南</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/docker%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%9101/>Docker应用开发01</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/docker%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%9102/>Docker应用开发02</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/docker%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%9103/>Docker应用开发03</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/docker%E9%85%8D%E7%BD%AEtab%E8%A1%A5%E5%85%A8%E5%91%BD%E4%BB%A4/>Docker配置tab补全命令</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/docker%E9%95%9C%E5%83%8F%E5%8A%A0%E9%80%9F/>Docker镜像加速</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/ghcr%E9%95%9C%E5%83%8F%E5%8A%A0%E9%80%9F%E6%96%B9%E5%BC%8F/>GHCR镜像加速方式</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/harbor%E4%BD%BF%E7%94%A8%E8%87%AA%E7%AD%BE%E5%90%8D%E8%AF%81%E4%B9%A6%E5%AE%9E%E7%8E%B0https%E7%99%BB%E5%BD%95/>Harbor使用自签名证书实现https登录</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/harbor%E5%AE%89%E8%A3%85%E4%B8%8E%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/>Harbor安装与简单使用</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/ubuntu20.04%E5%AE%89%E8%A3%85docker/>Ubuntu20.04安装docker</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/%E4%B8%8D%E5%90%8C%E6%9E%B6%E6%9E%84%E5%B9%B3%E5%8F%B0%E4%B8%8Bdocker%E5%AE%98%E6%96%B9%E9%95%9C%E5%83%8F%E5%8C%85%E6%9F%A5%E6%89%BE%E8%AF%B4%E6%98%8E/>不同架构平台下Docker官方镜像包查找说明</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/%E4%BD%BF%E7%94%A8dockerfile%E5%88%9B%E5%BB%BA%E9%95%9C%E5%83%8F/>使用Dockerfile创建镜像</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/%E4%BD%BF%E7%94%A8docker%E6%90%AD%E5%BB%BAopenvpn/>使用docker搭建openvpn</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/%E8%87%AA%E5%BB%BA%E4%BB%93%E5%BA%93registry%E4%BD%BF%E7%94%A8%E8%AF%81%E4%B9%A6%E8%AE%A4%E8%AF%81%E6%96%B9%E6%B3%95/>自建仓库registry使用证书认证方法</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/%E8%87%AA%E5%BB%BA%E6%9C%AC%E5%9C%B0%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93-registry/>自建本地镜像仓库Registry</a></div></div></div><div class=desc><span><svg t="1656736000388" class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="7409" width="12" height="12"><path d="M524.885333 338.986667l-324.522666 324.48c-17.28 15.274667-27.989333 36.693333-29.696 56.234666v133.76l130.730666.085334c22.784-1.621333 43.989333-12.245333 61.013334-31.701334L685.098667 499.2 524.885333 338.986667zM585.258667 278.656l160.170666 160.213333 102.144-102.144a19.712 19.712.0 000-27.861333l-132.48-132.437333a19.456 19.456.0 00-27.605333.0L585.258667 278.613333zM701.312 85.333333c27.946667.0 54.741333 11.136 74.282667 30.848L907.904 248.490667a105.045333 105.045333.0 010 148.565333L424.874667 879.957333C395.050667 914.304 352.768 935.424 304.426667 938.752H85.333333v-42.666667l.128-179.84c3.626667-44.970667 24.576-86.826667 56.448-114.944l485.12-485.034666a104.789333 104.789333.0 0174.24-30.933334z" p-id="7410" fill="#adb5bd"/></svg>2025-03-18&nbsp;&nbsp;&nbsp;<svg t="1656737270708" class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="23838" width="11" height="11"><path d="M824.264 95.36c0-23.859 25.043-44.16 48.902-44.16s49.714 20.301 49.714 44.16v190.08c0 23.859-19.054 52.868-42.913 52.868h-190.08c-23.859.0-46.696-25.96-46.696-49.819s22.55-46.249 46.409-46.249h82.025C702.344 175.534 610.22 155.853 512 155.853c-206.775.0-360.398 149.372-360.398 356.147S305.225 870.23 512 870.23c206.775.0 357.467-151.455 357.467-358.23.0-23.859 23.634-50.706 53.413-50.706 29.78.0 49.92 26.847 49.92 50.706.0 254.493-206.307 460.8-460.8 460.8s-460.8-206.307-460.8-460.8C51.2 257.507 257.507 51.2 512 51.2c122.4.0 226.684 33.296 312.264 117.369.358.351.358-24.052.0-73.209z" p-id="23839" fill="#adb5bd"/></svg>
2025-03-18&nbsp;&nbsp;&nbsp;</span>
<span><svg t="1656737548689" class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="33866" width="12" height="12"><path d="M832.038608 64.662657H192.030028c-70.774903.0-128.089859 57.325793-128.089859 128.03206v446.793671c0 70.7171050000001 57.314956 128.154884 128.089859 128.154884h133.353183a63.940169 63.940169.0 0155.219742 31.576328l76.099638 129.83828c12.358154 21.093031 33.790754 31.626903 55.216129 31.626903s42.832688-10.544709 55.198067-31.619678l76.222461-129.870792a63.940169 63.940169.0 0155.212517-31.551041h133.54103c70.576219.0 127.732228-57.289669 127.732227-127.800865V192.391272c0-70.536482-57.181295-127.728615-127.786414-127.728615zM895.884854 639.842407A63.85347 63.85347.0 01832.092795 703.703103h-133.54103a127.753903 127.753903.0 00-110.349172 63.09847l-76.222461 129.856342a.274545.274545.0 010-.050574h-.032512s-.021675.061411-.032512.061412l-76.1466-129.85273a127.804477 127.804477.0 00-110.385297-63.11292H192.030028A64.207489 64.207489.0 01127.880338 639.488388V192.694717a64.102729 64.102729.0 0164.14969-64.091891h640.00858a63.799284 63.799284.0 0163.846246 63.788446v447.451135z" fill="#adb5bd" p-id="33867"/><path d="M608.154093 288.092004a31.970084 31.970084.0 00-31.970084 31.970085v160.078006L441.53396 300.861976a31.970084 31.970084.0 00-57.531702 19.200113v255.760676a31.970084 31.970084.0 0063.940169.0V415.863969l134.650048 179.274507a31.970084 31.970084.0 0057.531703-19.200113V320.062089a31.970084 31.970084.0 00-31.970085-31.970085z" fill="#adb5bd" p-id="33868"/></svg>8440 字</span>&nbsp;
<span><svg t="1656737462334" class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="32892" width="12" height="12"><path d="M512 74.666667C270.933333 74.666667 74.666667 270.933333 74.666667 512S270.933333 949.333333 512 949.333333 949.333333 753.066667 949.333333 512 753.066667 74.666667 512 74.666667zm0 810.666666C307.2 885.333333 138.666667 716.8 138.666667 512S307.2 138.666667 512 138.666667 885.333333 307.2 885.333333 512 716.8 885.333333 512 885.333333z" p-id="32893" fill="#adb5bd"/><path d="M695.466667 567.466667 544 497.066667V277.333333c0-17.066667-14.933333-32-32-32s-32 14.933333-32 32v238.933334c0 12.8 6.4 23.466667 19.2 29.866666L669.866667 627.2c4.266667 2.133333 8.533333 2.133333 12.8 2.133333 12.8.0 23.466667-6.4 29.866666-19.2 6.4-14.933333.0-34.133333-17.066666-42.666666z" p-id="32894" fill="#adb5bd"/></svg>17 分钟</span><div class=container-ctgtag><div class=taxonomy><div class=tag><a href=/tags/docker>Docker</a></div></div></div></div><div class=toc><div class=container-page-operation><div class=page-operation><div><a href=/><img src=/imgs/icons/home-2.svg alt></a></div><div><a href=/nav><img src=/imgs/icons/iov-navigate-1.svg alt></a></div><div><a href=/wiki><img src=/imgs/icons/wiki.svg alt></a></div><div><a href=/tags><img src=/imgs/icons/treetags.svg alt></a></div><div id=light-dark><a><img src=/imgs/icons/moon2.svg alt></a></div><div><a href=#><img src=/imgs/icons/up2.svg alt></a></div></div></div><nav id=TableOfContents><ul><li><a href=#1copy复制文件>1.COPY复制文件</a></li><li><a href=#2add-更高级的复制文件>2.ADD 更高级的复制文件</a></li><li><a href=#3cmd容器启动命令>3.CMD容器启动命令</a></li><li><a href=#4entrypoint入口点>4.ENTRYPOINT入口点</a><ul><li></li></ul></li><li><a href=#5env设置环境变量>5.ENV设置环境变量</a></li><li><a href=#6arg构建参数>6.ARG构建参数</a></li><li><a href=#7volume定义匿名卷>7.VOLUME定义匿名卷</a></li><li><a href=#8expose暴露端口>8.EXPOSE暴露端口</a></li><li><a href=#9wordir指定工作目录>9.WORDIR指定工作目录</a></li><li><a href=#10user指定当前用户>10.USER指定当前用户</a></li><li><a href=#11healthcheck健康检查>11.HEALTHCHECK健康检查</a></li><li><a href=#12onbuild-为他人做嫁衣>12.ONBUILD 为他人做嫁衣</a></li><li><a href=#13label-为镜像添加元数据>13.LABEL 为镜像添加元数据</a></li><li><a href=#14shell指令>14.shell指令</a></li></ul></nav></div><div class=content><h2 id=1copy复制文件>1.COPY复制文件</h2><p>格式：</p><ul><li><p><code>COPY [--chown=&lt;user>:&lt;group>] &lt;源路径>... &lt;目标路径></code></p></li><li><p><code>COPY [--chown=&lt;user>:&lt;group>] ["&lt;源路径1>",... "&lt;目标路径>"]</code></p></li></ul><p>和 <code>RUN</code> 指令一样，也有两种格式，一种类似于命令行，一种类似于函数调用。</p><p><code>COPY</code> 指令将从构建上下文目录中 <code>&lt;源路径></code> 的文件/目录复制到新的一层的镜像内的 <code>&lt;目标路径></code> 位置。比如：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>COPY package.json <span style=color:#000;font-weight:700>/</span>usr<span style=color:#000;font-weight:700>/</span>src<span style=color:#000;font-weight:700>/</span>app<span style=color:#000;font-weight:700>/</span>
</span></span></code></pre></td></tr></table></div></div><p><code>&lt;源路径></code> 可以是多个，甚至可以是通配符，其通配符规则要满足 Go 的 <code>filepath.Match</code> 规则，如：</p><pre tabindex=0><code class=language-less data-lang=less>COPY hom* /mydir/
COPY hom?.txt /mydir/
</code></pre><p><code>&lt;目标路径></code> 可以是容器内的绝对路径，也可以是相对于工作目录的相对路径（工作目录可以用 <code>WORKDIR</code> 指令来指定）。目标路径不需要事先创建，如果目录不存在会在复制文件前先行创建缺失目录。</p><p>此外，还需要注意一点，使用 <code>COPY</code> 指令，源文件的各种元数据都会保留。比如读、写、执行权限、文件变更时间等。这个特性对于镜像定制很有用。特别是构建相关文件都在使用 Git 进行管理的时候。</p><p>在使用该指令的时候还可以加上 <code>--chown=&lt;user>:&lt;group></code> 选项来改变文件的所属用户及所属组。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>COPY</span> <span style=color:#a61717;background-color:#e3d2d2>--chown=</span><span style=color:#099>55</span><span style=color:#a61717;background-color:#e3d2d2>:mygroup</span> <span style=color:#a61717;background-color:#e3d2d2>files*</span> <span style=color:#a61717;background-color:#e3d2d2>/mydir/</span>
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>COPY</span> <span style=color:#a61717;background-color:#e3d2d2>--chown=bin</span> <span style=color:#a61717;background-color:#e3d2d2>files*</span> <span style=color:#a61717;background-color:#e3d2d2>/mydir/</span>
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>COPY</span> <span style=color:#a61717;background-color:#e3d2d2>--chown=</span><span style=color:#099>1</span> <span style=color:#a61717;background-color:#e3d2d2>files*</span> <span style=color:#a61717;background-color:#e3d2d2>/mydir/</span>
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>COPY</span> <span style=color:#a61717;background-color:#e3d2d2>--chown=</span><span style=color:#099>10</span><span style=color:#a61717;background-color:#e3d2d2>:</span><span style=color:#099>11</span> <span style=color:#a61717;background-color:#e3d2d2>files*</span> <span style=color:#a61717;background-color:#e3d2d2>/mydir/</span>
</span></span></code></pre></td></tr></table></div></div><p>如果源路径为文件夹，复制的时候不是直接复制该文件夹，而是将文件夹中的内容复制到目标路径。</p><h2 id=2add-更高级的复制文件>2.ADD 更高级的复制文件</h2><p>在 <code>COPY</code> 和 <code>ADD</code> 指令中选择的时候，可以遵循这样的原则，所有的文件复制均使用 <code>COPY</code> 指令，仅在需要自动解压缩的场合使用 <code>ADD</code>。</p><p>在某些情况下，这个自动解压缩的功能非常有用，比如官方镜像 <code>ubuntu</code> 中：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span>FROM scratch
</span></span><span style=display:flex><span>ADD ubuntu<span style=color:#000;font-weight:700>-</span>xenial<span style=color:#000;font-weight:700>-</span>core<span style=color:#000;font-weight:700>-</span>cloudimg<span style=color:#000;font-weight:700>-</span>amd64<span style=color:#000;font-weight:700>-</span>root.tar.gz <span style=color:#000;font-weight:700>/</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></td></tr></table></div></div><h2 id=3cmd容器启动命令>3.CMD容器启动命令</h2><p><code>CMD</code> 指令的格式和 <code>RUN</code> 相似，也是两种格式：</p><ul><li><p><code>shell</code> 格式：<code>CMD &lt;命令></code></p></li><li><p><code>exec</code> 格式：<code>CMD ["可执行文件", "参数1", "参数2"...]</code></p></li><li><p>参数列表格式：<code>CMD ["参数1", "参数2"...]</code>。在指定了 <code>ENTRYPOINT</code> 指令后，用 <code>CMD</code> 指定具体的参数。</p></li></ul><p>之前介绍容器的时候曾经说过，Docker 不是虚拟机，容器就是进程。既然是进程，那么在启动容器的时候，需要指定所运行的程序及参数。<code>CMD</code> 指令就是用于指定默认的容器主进程的启动命令的。</p><p>在运行时可以指定新的命令来替代镜像设置中的这个默认命令，比如，<code>ubuntu</code> 镜像默认的 <code>CMD</code> 是 <code>/bin/bash</code>，如果我们直接 <code>docker run -it ubuntu</code> 的话，会直接进入 <code>bash</code>。我们也可以在运行时指定运行别的命令，如 <code>docker run -it ubuntu cat /etc/os-release</code>。这就是用 <code>cat /etc/os-release</code> 命令替换了默认的 <code>/bin/bash</code> 命令了，输出了系统版本信息。</p><p>在指令格式上，一般推荐使用 <code>exec</code> 格式，这类格式在解析时会被解析为 JSON 数组，因此一定要使用双引号 <code>"</code>，而不要使用单引号。</p><p>如果使用 <code>shell</code> 格式的话，实际的命令会被包装为 <code>sh -c</code> 的参数的形式进行执行。比如：</p><pre tabindex=0><code class=language-less data-lang=less>CMD echo $HOME
</code></pre><p>在实际执行中，会将其变更为：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>CMD [ <span style=color:#d14>&#34;sh&#34;</span>, <span style=color:#d14>&#34;-c&#34;</span>, <span style=color:#d14>&#34;echo </span><span style=color:#d14>$HOME</span><span style=color:#d14>&#34;</span> ]
</span></span></code></pre></td></tr></table></div></div><p>这就是为什么我们可以使用环境变量的原因，因为这些环境变量会被 shell 进行解析处理。</p><p>提到 <code>CMD</code> 就不得不提容器中应用在前台执行和后台执行的问题。这是初学者常出现的一个混淆。</p><p>Docker 不是虚拟机，容器中的应用都应该以前台执行，而不是像虚拟机、物理机里面那样，用 <code>systemd</code> 去启动后台服务，容器内没有后台服务的概念。</p><p>一些初学者将 <code>CMD</code> 写为：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:teal>CMD service nginx start</span>
</span></span></code></pre></td></tr></table></div></div><p>然后发现容器执行后就立即退出了。甚至在容器内去使用 <code>systemctl</code> 命令结果却发现根本执行不了。这就是因为没有搞明白前台、后台的概念，没有区分容器和虚拟机的差异，依旧在以传统虚拟机的角度去理解容器。</p><p>对于容器而言，其启动程序就是容器应用进程，容器就是为了主进程而存在的，主进程退出，容器就失去了存在的意义，从而退出，其它辅助进程不是它需要关心的东西。</p><p>而使用 <code>service nginx start</code> 命令，则是希望 init 系统以后台守护进程的形式启动 nginx 服务。而刚才说了 <code>CMD service nginx start</code> 会被理解为 <code>CMD [ "sh", "-c", "service nginx start"]</code>，因此主进程实际上是 <code>sh</code>。那么当 <code>service nginx start</code> 命令结束后，<code>sh</code> 也就结束了，<code>sh</code> 作为主进程退出了，自然就会令容器退出。</p><p>正确的做法是直接执行 <code>nginx</code> 可执行文件，并且要求以前台形式运行。比如：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>CMD [&#34;nginx&#34;, &#34;-g&#34;, &#34;daemon off;&#34;]
</span></span></code></pre></td></tr></table></div></div><h2 id=4entrypoint入口点>4.ENTRYPOINT入口点</h2><p><code>ENTRYPOINT</code> 的格式和 <code>RUN</code> 指令格式一样，分为 <code>exec</code> 格式和 <code>shell</code> 格式。</p><p><code>ENTRYPOINT</code> 的目的和 <code>CMD</code> 一样，都是在指定容器启动程序及参数。<code>ENTRYPOINT</code> 在运行时也可以替代，不过比 <code>CMD</code> 要略显繁琐，需要通过 <code>docker run</code> 的参数 <code>--entrypoint</code> 来指定。</p><p>当指定了 <code>ENTRYPOINT</code> 后，<code>CMD</code> 的含义就发生了改变，不再是直接的运行其命令，而是将 <code>CMD</code> 的内容作为参数传给 <code>ENTRYPOINT</code> 指令，换句话说实际执行时，将变为：</p><pre tabindex=0><code class=language-less data-lang=less>&lt;ENTRYPOINT&gt; &#34;&lt;CMD&gt;&#34;
</code></pre><p>那么有了 <code>CMD</code> 后，为什么还要有 <code>ENTRYPOINT</code> 呢？这种 <code>&lt;ENTRYPOINT> "&lt;CMD>"</code> 有什么好处么？让我们来看几个场景。</p><h4 id=场景一让镜像变成像命令一样使用><strong>场景一：让镜像变成像命令一样使用</strong></h4><p>假设我们需要一个得知自己当前公网 IP 的镜像，那么可以先用 <code>CMD</code> 来实现：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>FROM ubuntu<span style=color:#000;font-weight:700>:</span><span style=color:#099>18.04</span>
</span></span><span style=display:flex><span>RUN apt<span style=color:#000;font-weight:700>-</span>get update <span style=color:#000;font-weight:700>\</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>&amp;&amp;</span> apt<span style=color:#000;font-weight:700>-</span>get install <span style=color:#000;font-weight:700>-</span>y curl <span style=color:#000;font-weight:700>\</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>&amp;&amp;</span> rm <span style=color:#000;font-weight:700>-</span>rf <span style=color:#000;font-weight:700>/</span><span style=color:#000;font-weight:700>var</span><span style=color:#a61717;background-color:#e3d2d2>/lib/apt/lists/*</span>
</span></span><span style=display:flex><span>CMD [ <span style=color:#d14>&#34;curl&#34;</span>, <span style=color:#d14>&#34;-s&#34;</span>, <span style=color:#d14>&#34;http://myip.ipip.net&#34;</span> ]
</span></span></code></pre></td></tr></table></div></div><p>假如我们使用 <code>docker build -t myip .</code> 来构建镜像的话，如果我们需要查询当前公网 IP，只需要执行：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>$ docker run myip
</span></span><span style=display:flex><span>当前 IP<span style=color:#a61717;background-color:#e3d2d2>：</span><span style=color:#099>61.148</span>.<span style=color:#099>226.66</span> 来自<span style=color:#a61717;background-color:#e3d2d2>：</span>北京市 联通
</span></span></code></pre></td></tr></table></div></div><p>嗯，这么看起来好像可以直接把镜像当做命令使用了，不过命令总有参数，如果我们希望加参数呢？比如从上面的 <code>CMD</code> 中可以看到实质的命令是 <code>curl</code>，那么如果我们希望显示 HTTP 头信息，就需要加上 <code>-i</code> 参数。那么我们可以直接加 <code>-i</code> 参数给 <code>docker run myip</code> 么？</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-graphql data-lang=graphql><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>$</span><span style=color:#bbb> </span>docker<span style=color:#bbb> </span>run<span style=color:#bbb> </span>myip<span style=color:#bbb> </span><span style=color:#a61717;background-color:#e3d2d2>-</span>i<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>docker:<span style=color:#bbb> </span><span style=color:#458;font-weight:700>Error</span><span style=color:#bbb> </span>response<span style=color:#bbb> </span>from<span style=color:#bbb> </span>daemon:<span style=color:#bbb> </span><span style=color:#458;font-weight:700>invalid</span><span style=color:#bbb> </span>header<span style=color:#bbb> </span>field<span style=color:#bbb> </span>value<span style=color:#bbb> </span><span style=color:#d14>&#34;oci runtime error: container_linux.go:247: starting container process caused \&#34;exec: \\\&#34;-i\\\&#34;: executable file not found in $PATH\&#34;\n&#34;</span><span style=color:#a61717;background-color:#e3d2d2>.</span><span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><p>我们可以看到可执行文件找不到的报错，<code>executable file not found</code>。之前我们说过，跟在镜像名后面的是 <code>command</code>，运行时会替换 <code>CMD</code> 的默认值。因此这里的 <code>-i</code> 替换了原来的 <code>CMD</code>，而不是添加在原来的 <code>curl -s http://myip.ipip.net</code> 后面。而 <code>-i</code> 根本不是命令，所以自然找不到。</p><p>那么如果我们希望加入 <code>-i</code> 这参数，我们就必须重新完整的输入这个命令：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>$</span> docker run myip curl <span style=color:#000;font-weight:700>-</span>s http:<span style=color:#998;font-style:italic>//myip.ipip.net -i
</span></span></span></code></pre></td></tr></table></div></div><p>这显然不是很好的解决方案，而使用 <code>ENTRYPOINT</code> 就可以解决这个问题。现在我们重新用 <code>ENTRYPOINT</code> 来实现这个镜像：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-css data-lang=css><span style=display:flex><span><span style=color:navy>FROM</span> <span style=color:navy>ubuntu</span>:<span style=color:#3c5d5d;font-weight:700>18</span>.<span style=color:#458;font-weight:700>04</span>
</span></span><span style=display:flex><span><span style=color:navy>RUN</span> <span style=color:navy>apt-get</span> <span style=color:navy>update</span> <span style=color:#a61717;background-color:#e3d2d2>\</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>&amp;&amp;</span> <span style=color:navy>apt-get</span> <span style=color:navy>install</span> <span style=color:navy>-y</span> <span style=color:navy>curl</span> <span style=color:#a61717;background-color:#e3d2d2>\</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>&amp;&amp;</span> <span style=color:navy>rm</span> <span style=color:navy>-rf</span> <span style=color:#000;font-weight:700>/</span><span style=color:navy>var</span><span style=color:#000;font-weight:700>/</span><span style=color:navy>lib</span><span style=color:#000;font-weight:700>/</span><span style=color:navy>apt</span><span style=color:#000;font-weight:700>/</span><span style=color:navy>lists</span><span style=color:#000;font-weight:700>/*</span>
</span></span><span style=display:flex><span><span style=color:navy>ENTRYPOINT</span> <span style=color:#000;font-weight:700>[</span> <span style=color:#d14>&#34;curl&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#d14>&#34;-s&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#d14>&#34;http://myip.ipip.net&#34;</span> <span style=color:#000;font-weight:700>]</span>
</span></span></code></pre></td></tr></table></div></div><p>这次我们再来尝试直接使用 <code>docker run myip -i</code>：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>$</span> <span style=color:#a61717;background-color:#e3d2d2>docker</span> <span style=color:#a61717;background-color:#e3d2d2>run</span> <span style=color:#a61717;background-color:#e3d2d2>myip</span>
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>当前</span> <span style=color:#a61717;background-color:#e3d2d2>IP：</span><span style=color:#099>61.148</span><span style=color:#a61717;background-color:#e3d2d2>.</span><span style=color:#099>226.66</span> <span style=color:#a61717;background-color:#e3d2d2>来自：北京市</span> <span style=color:#a61717;background-color:#e3d2d2>联通</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>$</span> <span style=color:#a61717;background-color:#e3d2d2>docker</span> <span style=color:#a61717;background-color:#e3d2d2>run</span> <span style=color:#a61717;background-color:#e3d2d2>myip</span> <span style=color:#a61717;background-color:#e3d2d2>-i</span>
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>HTTP/</span><span style=color:#099>1.1</span> <span style=color:#099>200</span> <span style=color:#a61717;background-color:#e3d2d2>OK</span>
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>Server:</span> <span style=color:#a61717;background-color:#e3d2d2>nginx/</span><span style=color:#099>1.8</span><span style=color:#a61717;background-color:#e3d2d2>.</span><span style=color:#099>0</span>
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>Date:</span> <span style=color:#a61717;background-color:#e3d2d2>Tue,</span> <span style=color:#099>22</span> <span style=color:#a61717;background-color:#e3d2d2>Nov</span> <span style=color:#099>2016</span> <span style=color:#099>05</span><span style=color:#a61717;background-color:#e3d2d2>:</span><span style=color:#099>12</span><span style=color:#a61717;background-color:#e3d2d2>:</span><span style=color:#099>40</span> <span style=color:#a61717;background-color:#e3d2d2>GMT</span>
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>Content-Type:</span> <span style=color:#a61717;background-color:#e3d2d2>text/html;</span> <span style=color:#a61717;background-color:#e3d2d2>charset=UTF</span><span style=color:#099>-8</span>
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>Vary:</span> <span style=color:#a61717;background-color:#e3d2d2>Accept-Encoding</span>
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>X-Powered-By:</span> <span style=color:#a61717;background-color:#e3d2d2>PHP/</span><span style=color:#099>5.6</span><span style=color:#a61717;background-color:#e3d2d2>.</span><span style=color:#099>24-1</span><span style=color:#a61717;background-color:#e3d2d2>~dotdeb+</span><span style=color:#099>7.1</span>
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>X-Cache:</span> <span style=color:#a61717;background-color:#e3d2d2>MISS</span> <span style=color:#a61717;background-color:#e3d2d2>from</span> <span style=color:#a61717;background-color:#e3d2d2>cache</span><span style=color:#099>-2</span>
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>X-Cache-Lookup:</span> <span style=color:#a61717;background-color:#e3d2d2>MISS</span> <span style=color:#a61717;background-color:#e3d2d2>from</span> <span style=color:#a61717;background-color:#e3d2d2>cache</span><span style=color:#099>-2</span><span style=color:#a61717;background-color:#e3d2d2>:</span><span style=color:#099>80</span>
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>X-Cache:</span> <span style=color:#a61717;background-color:#e3d2d2>MISS</span> <span style=color:#a61717;background-color:#e3d2d2>from</span> <span style=color:#a61717;background-color:#e3d2d2>proxy</span><span style=color:#099>-2</span><span style=color:#a61717;background-color:#e3d2d2>_</span><span style=color:#099>6</span>
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>Transfer-Encoding:</span> <span style=color:#a61717;background-color:#e3d2d2>chunked</span>
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>Via:</span> <span style=color:#099>1.1</span> <span style=color:#a61717;background-color:#e3d2d2>cache</span><span style=color:#099>-2</span><span style=color:#a61717;background-color:#e3d2d2>:</span><span style=color:#099>80</span><span style=color:#a61717;background-color:#e3d2d2>,</span> <span style=color:#099>1.1</span> <span style=color:#a61717;background-color:#e3d2d2>proxy</span><span style=color:#099>-2</span><span style=color:#a61717;background-color:#e3d2d2>_</span><span style=color:#099>6</span><span style=color:#a61717;background-color:#e3d2d2>:</span><span style=color:#099>8006</span>
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>Connection:</span> <span style=color:#a61717;background-color:#e3d2d2>keep-alive</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>当前</span> <span style=color:#a61717;background-color:#e3d2d2>IP：</span><span style=color:#099>61.148</span><span style=color:#a61717;background-color:#e3d2d2>.</span><span style=color:#099>226.66</span> <span style=color:#a61717;background-color:#e3d2d2>来自：北京市</span> <span style=color:#a61717;background-color:#e3d2d2>联通</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到，这次成功了。这是因为当存在 <code>ENTRYPOINT</code> 后，<code>CMD</code> 的内容将会作为参数传给 <code>ENTRYPOINT</code>，而这里 <code>-i</code> 就是新的 <code>CMD</code>，因此会作为参数传给 <code>curl</code>，从而达到了我们预期的效果。</p><h4 id=场景二应用运行前的准备工作><strong>场景二：应用运行前的准备工作</strong></h4><p>启动容器就是启动主进程，但有些时候，启动主进程前，需要一些准备工作。</p><p>比如 <code>mysql</code> 类的数据库，可能需要一些数据库配置、初始化的工作，这些工作要在最终的 mysql 服务器运行之前解决。</p><p>此外，可能希望避免使用 <code>root</code> 用户去启动服务，从而提高安全性，而在启动服务前还需要以 <code>root</code> 身份执行一些必要的准备工作，最后切换到服务用户身份启动服务。或者除了服务外，其它命令依旧可以使用 <code>root</code> 身份执行，方便调试等。</p><p>这些准备工作是和容器 <code>CMD</code> 无关的，无论 <code>CMD</code> 为什么，都需要事先进行一个预处理的工作。这种情况下，可以写一个脚本，然后放入 <code>ENTRYPOINT</code> 中去执行，而这个脚本会将接到的参数（也就是 <code>&lt;CMD></code>）作为命令，在脚本最后执行。比如官方镜像 <code>redis</code> 中就是这么做的：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>FROM alpine<span style=color:#000;font-weight:700>:</span><span style=color:#099>3.4</span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>RUN addgroup <span style=color:#000;font-weight:700>-</span>S redis <span style=color:#000;font-weight:700>&amp;&amp;</span> adduser <span style=color:#000;font-weight:700>-</span>S <span style=color:#000;font-weight:700>-</span>G redis redis
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>ENTRYPOINT [<span style=color:#d14>&#34;docker-entrypoint.sh&#34;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>EXPOSE <span style=color:#099>6379</span>
</span></span><span style=display:flex><span>CMD [ <span style=color:#d14>&#34;redis-server&#34;</span> ]
</span></span></code></pre></td></tr></table></div></div><p>可以看到其中为了 redis 服务创建了 redis 用户，并在最后指定了 <code>ENTRYPOINT</code> 为 <code>docker-entrypoint.sh</code> 脚本。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#998;font-style:italic>#!/bin/sh
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>...
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>#</span> allow the container to be started <span style=color:#000;font-weight:700>with</span> <span style=color:#d14>`--user`</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>if</span> [ <span style=color:#d14>&#34;$1&#34;</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>&#39;redis-server&#39;</span> <span style=color:#000;font-weight:700>-</span>a <span style=color:#d14>&#34;$(id -u)&#34;</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>&#39;0&#39;</span> ]; then
</span></span><span style=display:flex><span>	find . <span style=color:#a61717;background-color:#e3d2d2>\</span><span style=color:#000;font-weight:700>!</span> <span style=color:#000;font-weight:700>-</span>user redis <span style=color:#000;font-weight:700>-</span>exec chown redis <span style=color:#d14>&#39;{}&#39;</span> <span style=color:#000;font-weight:700>+</span>
</span></span><span style=display:flex><span>	exec gosu redis <span style=color:#d14>&#34;$0&#34;</span> <span style=color:#d14>&#34;$@&#34;</span>
</span></span><span style=display:flex><span>fi
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>exec <span style=color:#d14>&#34;$@&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>该脚本的内容就是根据 <code>CMD</code> 的内容来判断，如果是 <code>redis-server</code> 的话，则切换到 <code>redis</code> 用户身份启动服务器，否则依旧使用 <code>root</code> 身份执行。比如：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>$ docker run <span style=color:#000;font-weight:700>-</span>it redis id
</span></span><span style=display:flex><span>uid<span style=color:#000;font-weight:700>=</span><span style=color:#099>0</span><span style=color:#000;font-weight:700>(</span>root<span style=color:#000;font-weight:700>)</span> gid<span style=color:#000;font-weight:700>=</span><span style=color:#099>0</span><span style=color:#000;font-weight:700>(</span>root<span style=color:#000;font-weight:700>)</span> groups<span style=color:#000;font-weight:700>=</span><span style=color:#099>0</span><span style=color:#000;font-weight:700>(</span>root<span style=color:#000;font-weight:700>)</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=5env设置环境变量>5.ENV设置环境变量</h2><p>格式有两种：</p><ul><li><p><code>ENV &lt;key> &lt;value></code></p></li><li><p><code>ENV &lt;key1>=&lt;value1> &lt;key2>=&lt;value2>...</code></p></li></ul><p>这个指令很简单，就是设置环境变量而已，无论是后面的其它指令，如 <code>RUN</code>，还是运行时的应用，都可以直接使用这里定义的环境变量。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span>ENV VERSION<span style=color:#000;font-weight:700>=</span><span style=color:#099>1.0</span> DEBUG<span style=color:#000;font-weight:700>=</span>on <span style=color:#a61717;background-color:#e3d2d2>\</span>
</span></span><span style=display:flex><span>    NAME<span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;Happy Feet&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>这个例子中演示了如何换行，以及对含有空格的值用双引号括起来的办法，这和 Shell 下的行为是一致的。</p><p>定义了环境变量，那么在后续的指令中，就可以使用这个环境变量。比如在官方 <code>node</code> 镜像 <code>Dockerfile</code> 中，就有类似这样的代码：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>ENV NODE_VERSION <span style=color:#099>7.2</span>.<span style=color:#099>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>RUN curl -SLO <span style=color:#d14>&#34;https://nodejs.org/dist/v</span><span style=color:#d14>$NODE</span><span style=color:#d14>_VERSION/node-v</span><span style=color:#d14>$NODE</span><span style=color:#d14>_VERSION-linux-x64.tar.xz&#34;</span> \
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>&amp;&amp;</span> curl -SLO <span style=color:#d14>&#34;https://nodejs.org/dist/v</span><span style=color:#d14>$NODE</span><span style=color:#d14>_VERSION/SHASUMS256.txt.asc&#34;</span> \
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>&amp;&amp;</span> gpg <span style=color:#000;font-weight:700>--</span>batch <span style=color:#000;font-weight:700>--</span>decrypt <span style=color:#000;font-weight:700>--</span>output SHASUMS256.txt SHASUMS256.txt.asc \
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>&amp;&amp;</span> grep <span style=color:#d14>&#34; node-v</span><span style=color:#d14>$NODE</span><span style=color:#d14>_VERSION-linux-x64.tar.xz</span><span style=color:#d14>\$</span><span style=color:#d14>&#34;</span> SHASUMS256.txt | sha256sum -c - \
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>&amp;&amp;</span> tar -xJf <span style=color:#d14>&#34;node-v</span><span style=color:#d14>$NODE</span><span style=color:#d14>_VERSION-linux-x64.tar.xz&#34;</span> -C /usr/local <span style=color:#000;font-weight:700>--</span>strip-components=<span style=color:#099>1</span> \
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>&amp;&amp;</span> rm <span style=color:#d14>&#34;node-v</span><span style=color:#d14>$NODE</span><span style=color:#d14>_VERSION-linux-x64.tar.xz&#34;</span> SHASUMS256.txt.asc SHASUMS256.txt \
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>&amp;&amp;</span> ln -s /usr/local/bin/node /usr/local/bin/nodejs
</span></span></code></pre></td></tr></table></div></div><p>在这里先定义了环境变量 <code>NODE_VERSION</code>，其后的 <code>RUN</code> 这层里，多次使用 <code>$NODE_VERSION</code> 来进行操作定制。可以看到，将来升级镜像构建版本的时候，只需要更新 <code>7.2.0</code> 即可，<code>Dockerfile</code> 构建维护变得更轻松了。</p><p>下列指令可以支持环境变量展开： <code>ADD</code>、<code>COPY</code>、<code>ENV</code>、<code>EXPOSE</code>、<code>FROM</code>、<code>LABEL</code>、<code>USER</code>、<code>WORKDIR</code>、<code>VOLUME</code>、<code>STOPSIGNAL</code>、<code>ONBUILD</code>、<code>RUN</code>。</p><p>可以从这个指令列表里感觉到，环境变量可以使用的地方很多，很强大。通过环境变量，我们可以让一份 <code>Dockerfile</code> 制作更多的镜像，只需使用不同的环境变量即可。</p><h2 id=6arg构建参数>6.ARG构建参数</h2><p>格式：<code>ARG &lt;参数名>[=&lt;默认值>]</code></p><p>构建参数和 <code>ENV</code> 的效果一样，都是设置环境变量。所不同的是，<code>ARG</code> 所设置的构建环境的环境变量，在将来容器运行时是不会存在这些环境变量的。但是不要因此就使用 <code>ARG</code> 保存密码之类的信息，因为 <code>docker history</code> 还是可以看到所有值的。</p><p><code>Dockerfile</code> 中的 <code>ARG</code> 指令是定义参数名称，以及定义其默认值。该默认值可以在构建命令 <code>docker build</code> 中用 <code>--build-arg &lt;参数名>=&lt;值></code> 来覆盖。</p><p>灵活的使用 <code>ARG</code> 指令，能够在不修改 Dockerfile 的情况下，构建出不同的镜像。</p><p>ARG 指令有生效范围，如果在 <code>FROM</code> 指令之前指定，那么只能用于 <code>FROM</code> 指令中。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>ARG</span> <span style=color:#a61717;background-color:#e3d2d2>DOCKER_USERNAME=library</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>FROM</span> <span style=color:#a61717;background-color:#e3d2d2>$</span>{<span style=color:#a61717;background-color:#e3d2d2>DOCKER_USERNAME</span>}<span style=color:#a61717;background-color:#e3d2d2>/alpine</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>RUN</span> <span style=color:#a61717;background-color:#e3d2d2>set</span> <span style=color:#a61717;background-color:#e3d2d2>-x</span> <span style=color:#a61717;background-color:#e3d2d2>;</span> <span style=color:#a61717;background-color:#e3d2d2>echo</span> <span style=color:#a61717;background-color:#e3d2d2>$</span>{<span style=color:#a61717;background-color:#e3d2d2>DOCKER_USERNAME</span>}
</span></span></code></pre></td></tr></table></div></div><p>使用上述 Dockerfile 会发现无法输出 <code>${DOCKER_USERNAME}</code> 变量的值，要想正常输出，你必须在 <code>FROM</code> 之后再次指定 <code>ARG</code></p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>#</span> 只在 FROM 中生效
</span></span><span style=display:flex><span>ARG DOCKER_USERNAME<span style=color:#000;font-weight:700>=</span>library
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>FROM ${DOCKER_USERNAME}<span style=color:#000;font-weight:700>/</span>alpine
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>#</span> 要想在 FROM 之后使用<span style=color:#a61717;background-color:#e3d2d2>，</span>必须再次指定
</span></span><span style=display:flex><span>ARG DOCKER_USERNAME<span style=color:#000;font-weight:700>=</span>library
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>RUN set <span style=color:#000;font-weight:700>-</span>x ; echo ${DOCKER_USERNAME}
</span></span></code></pre></td></tr></table></div></div><p>对于多阶段构建，尤其要注意这个问题</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>#</span> <span style=color:#a61717;background-color:#e3d2d2>这个变量在每个</span> <span style=color:#a61717;background-color:#e3d2d2>FROM</span> <span style=color:#a61717;background-color:#e3d2d2>中都生效</span>
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>ARG</span> <span style=color:#a61717;background-color:#e3d2d2>DOCKER_USERNAME=library</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>FROM</span> <span style=color:#a61717;background-color:#e3d2d2>$</span>{<span style=color:#a61717;background-color:#e3d2d2>DOCKER_USERNAME</span>}<span style=color:#a61717;background-color:#e3d2d2>/alpine</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>RUN</span> <span style=color:#a61717;background-color:#e3d2d2>set</span> <span style=color:#a61717;background-color:#e3d2d2>-x</span> <span style=color:#a61717;background-color:#e3d2d2>;</span> <span style=color:#a61717;background-color:#e3d2d2>echo</span> <span style=color:#099>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>FROM</span> <span style=color:#a61717;background-color:#e3d2d2>$</span>{<span style=color:#a61717;background-color:#e3d2d2>DOCKER_USERNAME</span>}<span style=color:#a61717;background-color:#e3d2d2>/alpine</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>RUN</span> <span style=color:#a61717;background-color:#e3d2d2>set</span> <span style=color:#a61717;background-color:#e3d2d2>-x</span> <span style=color:#a61717;background-color:#e3d2d2>;</span> <span style=color:#a61717;background-color:#e3d2d2>echo</span> <span style=color:#099>2</span>
</span></span></code></pre></td></tr></table></div></div><p>对于上述 Dockerfile 两个 <code>FROM</code> 指令都可以使用 <code>${DOCKER_USERNAME}</code>，对于在各个阶段中使用的变量都必须在每个阶段分别指定：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>ARG</span> <span style=color:#a61717;background-color:#e3d2d2>DOCKER_USERNAME=library</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>FROM</span> <span style=color:#a61717;background-color:#e3d2d2>$</span>{<span style=color:#a61717;background-color:#e3d2d2>DOCKER_USERNAME</span>}<span style=color:#a61717;background-color:#e3d2d2>/alpine</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>#</span> <span style=color:#a61717;background-color:#e3d2d2>在FROM</span> <span style=color:#a61717;background-color:#e3d2d2>之后使用变量，必须在每个阶段分别指定</span>
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>ARG</span> <span style=color:#a61717;background-color:#e3d2d2>DOCKER_USERNAME=library</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>RUN</span> <span style=color:#a61717;background-color:#e3d2d2>set</span> <span style=color:#a61717;background-color:#e3d2d2>-x</span> <span style=color:#a61717;background-color:#e3d2d2>;</span> <span style=color:#a61717;background-color:#e3d2d2>echo</span> <span style=color:#a61717;background-color:#e3d2d2>$</span>{<span style=color:#a61717;background-color:#e3d2d2>DOCKER_USERNAME</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>FROM</span> <span style=color:#a61717;background-color:#e3d2d2>$</span>{<span style=color:#a61717;background-color:#e3d2d2>DOCKER_USERNAME</span>}<span style=color:#a61717;background-color:#e3d2d2>/alpine</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>#</span> <span style=color:#a61717;background-color:#e3d2d2>在FROM</span> <span style=color:#a61717;background-color:#e3d2d2>之后使用变量，必须在每个阶段分别指定</span>
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>ARG</span> <span style=color:#a61717;background-color:#e3d2d2>DOCKER_USERNAME=library</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>RUN</span> <span style=color:#a61717;background-color:#e3d2d2>set</span> <span style=color:#a61717;background-color:#e3d2d2>-x</span> <span style=color:#a61717;background-color:#e3d2d2>;</span> <span style=color:#a61717;background-color:#e3d2d2>echo</span> <span style=color:#a61717;background-color:#e3d2d2>$</span>{<span style=color:#a61717;background-color:#e3d2d2>DOCKER_USERNAME</span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=7volume定义匿名卷>7.VOLUME定义匿名卷</h2><p>格式为：</p><ul><li><p><code>VOLUME ["&lt;路径1>", "&lt;路径2>"...]</code></p></li><li><p><code>VOLUME &lt;路径></code></p></li></ul><p>之前我们说过，容器运行时应该尽量保持容器存储层不发生写操作，对于数据库类需要保存动态数据的应用，其数据库文件应该保存于卷(volume)中，后面的章节我们会进一步介绍 Docker 卷的概念。为了防止运行时用户忘记将动态文件所保存目录挂载为卷，在 <code>Dockerfile</code> 中，我们可以事先指定某些目录挂载为匿名卷，这样在运行时如果用户不指定挂载，其应用也可以正常运行，不会向容器存储层写入大量数据。</p><pre tabindex=0><code class=language-less data-lang=less>VOLUME /data
</code></pre><p>这里的 <code>/data</code> 目录就会在容器运行时自动挂载为匿名卷，任何向 <code>/data</code> 中写入的信息都不会记录进容器存储层，从而保证了容器存储层的无状态化。当然，运行容器时可以覆盖这个挂载设置。比如：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>$</span> docker run -d -v mydata:/data xxxx
</span></span></code></pre></td></tr></table></div></div><p>在这行命令中，就使用了 <code>mydata</code> 这个命名卷挂载到了 <code>/data</code> 这个位置，替代了 <code>Dockerfile</code> 中定义的匿名卷的挂载配置。</p><h2 id=8expose暴露端口>8.EXPOSE暴露端口</h2><p>格式为 <code>EXPOSE &lt;端口1> [&lt;端口2>...]</code>。</p><p><code>EXPOSE</code> 指令是声明容器运行时提供服务的端口，这只是一个声明，在容器运行时并不会因为这个声明应用就会开启这个端口的服务。在 Dockerfile 中写入这样的声明有两个好处，一个是帮助镜像使用者理解这个镜像服务的守护端口，以方便配置映射；另一个用处则是在运行时使用随机端口映射时，也就是 <code>docker run -P</code> 时，会自动随机映射 <code>EXPOSE</code> 的端口。</p><p>要将 <code>EXPOSE</code> 和在运行时使用 <code>-p &lt;宿主端口>:&lt;容器端口></code> 区分开来。<code>-p</code>，是映射宿主端口和容器端口，换句话说，就是将容器的对应端口服务公开给外界访问，而 <code>EXPOSE</code> 仅仅是声明容器打算使用什么端口而已，并不会自动在宿主进行端口映射。</p><h2 id=9wordir指定工作目录>9.WORDIR指定工作目录</h2><p>格式为 <code>WORKDIR &lt;工作目录路径></code>。</p><p>使用 <code>WORKDIR</code> 指令可以来指定工作目录（或者称为当前目录），以后各层的当前目录就被改为指定的目录，如该目录不存在，<code>WORKDIR</code> 会帮你建立目录。</p><p>之前提到一些初学者常犯的错误是把 <code>Dockerfile</code> 等同于 Shell 脚本来书写，这种错误的理解还可能会导致出现下面这样的错误：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>RUN</span> <span style=color:#a61717;background-color:#e3d2d2>cd</span> <span style=color:#a61717;background-color:#e3d2d2>/app</span>
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>RUN</span> <span style=color:#a61717;background-color:#e3d2d2>echo</span> <span style=color:#d14>&#34;hello&#34;</span> <span style=color:#a61717;background-color:#e3d2d2>&gt;</span> <span style=color:#a61717;background-color:#e3d2d2>world.txt</span>
</span></span></code></pre></td></tr></table></div></div><p>如果将这个 <code>Dockerfile</code> 进行构建镜像运行后，会发现找不到 <code>/app/world.txt</code> 文件，或者其内容不是 <code>hello</code>。原因其实很简单，在 Shell 中，连续两行是同一个进程执行环境，因此前一个命令修改的内存状态，会直接影响后一个命令；而在 <code>Dockerfile</code> 中，这两行 <code>RUN</code> 命令的执行环境根本不同，是两个完全不同的容器。这就是对 <code>Dockerfile</code> 构建分层存储的概念不了解所导致的错误。</p><p>之前说过每一个 <code>RUN</code> 都是启动一个容器、执行命令、然后提交存储层文件变更。第一层 <code>RUN cd /app</code> 的执行仅仅是当前进程的工作目录变更，一个内存上的变化而已，其结果不会造成任何文件变更。而到第二层的时候，启动的是一个全新的容器，跟第一层的容器更完全没关系，自然不可能继承前一层构建过程中的内存变化。</p><p>因此如果需要改变以后各层的工作目录的位置，那么应该使用 <code>WORKDIR</code> 指令。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>WORKDIR <span style=color:#000;font-weight:700>/</span>app
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>RUN echo <span style=color:#d14>&#34;hello&#34;</span> &gt; world.txt
</span></span></code></pre></td></tr></table></div></div><p>如果你的 <code>WORKDIR</code> 指令使用的相对路径，那么所切换的路径与之前的 <code>WORKDIR</code> 有关：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>WORKDIR <span style=color:#000;font-weight:700>/</span>a
</span></span><span style=display:flex><span>WORKDIR b
</span></span><span style=display:flex><span>WORKDIR c
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>RUN pwd
</span></span></code></pre></td></tr></table></div></div><p><code>RUN pwd</code> 的工作目录为 <code>/a/b/c</code>。</p><h2 id=10user指定当前用户>10.USER指定当前用户</h2><p>格式：<code>USER &lt;用户名>[:&lt;用户组>]</code></p><p><code>USER</code> 指令和 <code>WORKDIR</code> 相似，都是改变环境状态并影响以后的层。<code>WORKDIR</code> 是改变工作目录，<code>USER</code> 则是改变之后层的执行 <code>RUN</code>, <code>CMD</code> 以及 <code>ENTRYPOINT</code> 这类命令的身份。</p><p>注意，<code>USER</code> 只是帮助你切换到指定用户而已，这个用户必须是事先建立好的，否则无法切换。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-css data-lang=css><span style=display:flex><span><span style=color:navy>RUN</span> <span style=color:navy>groupadd</span> <span style=color:navy>-r</span> <span style=color:navy>redis</span> <span style=color:#000;font-weight:700>&amp;&amp;</span> <span style=color:navy>useradd</span> <span style=color:navy>-r</span> <span style=color:navy>-g</span> <span style=color:navy>redis</span> <span style=color:navy>redis</span>
</span></span><span style=display:flex><span><span style=color:navy>USER</span> <span style=color:navy>redis</span>
</span></span><span style=display:flex><span><span style=color:navy>RUN</span> <span style=color:#000;font-weight:700>[</span> <span style=color:#d14>&#34;redis-server&#34;</span> <span style=color:#000;font-weight:700>]</span>
</span></span></code></pre></td></tr></table></div></div><p>如果以 <code>root</code> 执行的脚本，在执行期间希望改变身份，比如希望以某个已经建立好的用户来运行某个服务进程，不要使用 <code>su</code> 或者 <code>sudo</code>，这些都需要比较麻烦的配置，而且在 TTY 缺失的环境下经常出错。建议使用 <code>gosu</code>。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>#</span> <span style=color:#a61717;background-color:#e3d2d2>建立</span> <span style=color:#a61717;background-color:#e3d2d2>redis</span> <span style=color:#a61717;background-color:#e3d2d2>用户，并使用</span> <span style=color:#a61717;background-color:#e3d2d2>gosu</span> <span style=color:#a61717;background-color:#e3d2d2>换另一个用户执行命令</span>
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>RUN</span> <span style=color:#a61717;background-color:#e3d2d2>groupadd</span> <span style=color:#a61717;background-color:#e3d2d2>-r</span> <span style=color:#a61717;background-color:#e3d2d2>redis</span> <span style=color:#a61717;background-color:#e3d2d2>&amp;&amp;</span> <span style=color:#a61717;background-color:#e3d2d2>useradd</span> <span style=color:#a61717;background-color:#e3d2d2>-r</span> <span style=color:#a61717;background-color:#e3d2d2>-g</span> <span style=color:#a61717;background-color:#e3d2d2>redis</span> <span style=color:#a61717;background-color:#e3d2d2>redis</span>
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>#</span> <span style=color:#a61717;background-color:#e3d2d2>下载</span> <span style=color:#a61717;background-color:#e3d2d2>gosu</span>
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>RUN</span> <span style=color:#a61717;background-color:#e3d2d2>wget</span> <span style=color:#a61717;background-color:#e3d2d2>-O</span> <span style=color:#a61717;background-color:#e3d2d2>/usr/local/bin/gosu</span> <span style=color:#d14>&#34;https://github.com/tianon/gosu/releases/download/1.12/gosu-amd64&#34;</span> <span style=color:#a61717;background-color:#e3d2d2>\</span>
</span></span><span style=display:flex><span>    <span style=color:#a61717;background-color:#e3d2d2>&amp;&amp;</span> <span style=color:#a61717;background-color:#e3d2d2>chmod</span> <span style=color:#a61717;background-color:#e3d2d2>+x</span> <span style=color:#a61717;background-color:#e3d2d2>/usr/local/bin/gosu</span> <span style=color:#a61717;background-color:#e3d2d2>\</span>
</span></span><span style=display:flex><span>    <span style=color:#a61717;background-color:#e3d2d2>&amp;&amp;</span> <span style=color:#a61717;background-color:#e3d2d2>gosu</span> <span style=color:#a61717;background-color:#e3d2d2>nobody</span> <span style=color:#000;font-weight:700>true</span>
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>#</span> <span style=color:#a61717;background-color:#e3d2d2>设置</span> <span style=color:#a61717;background-color:#e3d2d2>CMD，并以另外的用户执行</span>
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>CMD</span> [ <span style=color:#d14>&#34;exec&#34;</span>, <span style=color:#d14>&#34;gosu&#34;</span>, <span style=color:#d14>&#34;redis&#34;</span>, <span style=color:#d14>&#34;redis-server&#34;</span> ]
</span></span></code></pre></td></tr></table></div></div><h2 id=11healthcheck健康检查>11.HEALTHCHECK健康检查</h2><p>格式：</p><ul><li><p><code>HEALTHCHECK [选项] CMD &lt;命令></code>：设置检查容器健康状况的命令</p></li><li><p><code>HEALTHCHECK NONE</code>：如果基础镜像有健康检查指令，使用这行可以屏蔽掉其健康检查指令</p></li></ul><p><code>HEALTHCHECK</code> 指令是告诉 Docker 应该如何进行判断容器的状态是否正常，这是 Docker 1.12 引入的新指令。</p><p>在没有 <code>HEALTHCHECK</code> 指令前，Docker 引擎只可以通过容器内主进程是否退出来判断容器是否状态异常。很多情况下这没问题，但是如果程序进入死锁状态，或者死循环状态，应用进程并不退出，但是该容器已经无法提供服务了。在 1.12 以前，Docker 不会检测到容器的这种状态，从而不会重新调度，导致可能会有部分容器已经无法提供服务了却还在接受用户请求。</p><p>而自 1.12 之后，Docker 提供了 <code>HEALTHCHECK</code> 指令，通过该指令指定一行命令，用这行命令来判断容器主进程的服务状态是否还正常，从而比较真实的反应容器实际状态。</p><p>当在一个镜像指定了 <code>HEALTHCHECK</code> 指令后，用其启动容器，初始状态会为 <code>starting</code>，在 <code>HEALTHCHECK</code> 指令检查成功后变为 <code>healthy</code>，如果连续一定次数失败，则会变为 <code>unhealthy</code>。</p><p><code>HEALTHCHECK</code> 支持下列选项：</p><ul><li><p><code>--interval=&lt;间隔></code>：两次健康检查的间隔，默认为 30 秒；</p></li><li><p><code>--timeout=&lt;时长></code>：健康检查命令运行超时时间，如果超过这个时间，本次健康检查就被视为失败，默认 30 秒；</p></li><li><p><code>--retries=&lt;次数></code>：当连续失败指定次数后，则将容器状态视为 <code>unhealthy</code>，默认 3 次。</p></li></ul><p>和 <code>CMD</code>, <code>ENTRYPOINT</code> 一样，<code>HEALTHCHECK</code> 只可以出现一次，如果写了多个，只有最后一个生效。</p><p>在 <code>HEALTHCHECK [选项] CMD</code> 后面的命令，格式和 <code>ENTRYPOINT</code> 一样，分为 <code>shell</code> 格式，和 <code>exec</code> 格式。命令的返回值决定了该次健康检查的成功与否：<code>0</code>：成功；<code>1</code>：失败；<code>2</code>：保留，不要使用这个值。</p><p>假设我们有个镜像是个最简单的 Web 服务，我们希望增加健康检查来判断其 Web 服务是否在正常工作，我们可以用 <code>curl</code> 来帮助判断，其 <code>Dockerfile</code> 的 <code>HEALTHCHECK</code> 可以这么写：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>FROM nginx
</span></span><span style=display:flex><span>RUN apt<span style=color:#000;font-weight:700>-</span>get update <span style=color:#000;font-weight:700>&amp;&amp;</span> apt<span style=color:#000;font-weight:700>-</span>get install <span style=color:#000;font-weight:700>-</span>y curl <span style=color:#000;font-weight:700>&amp;&amp;</span> rm <span style=color:#000;font-weight:700>-</span>rf <span style=color:#000;font-weight:700>/</span>var<span style=color:#000;font-weight:700>/</span>lib<span style=color:#000;font-weight:700>/</span>apt<span style=color:#000;font-weight:700>/</span>lists<span style=color:#000;font-weight:700>/*</span>
</span></span><span style=display:flex><span>HEALTHCHECK <span style=color:#000;font-weight:700>--</span>interval<span style=color:#000;font-weight:700>=</span><span style=color:#099>5</span>s <span style=color:#000;font-weight:700>--</span>timeout<span style=color:#000;font-weight:700>=</span><span style=color:#099>3</span>s <span style=color:#a61717;background-color:#e3d2d2>\</span>
</span></span><span style=display:flex><span>  CMD curl <span style=color:#000;font-weight:700>-</span>fs http<span style=color:#000;font-weight:700>:</span><span style=color:#998;font-style:italic>//localhost/ || exit 1
</span></span></span></code></pre></td></tr></table></div></div><p>这里我们设置了每 5 秒检查一次（这里为了试验所以间隔非常短，实际应该相对较长），如果健康检查命令超过 3 秒没响应就视为失败，并且使用 <code>curl -fs http://localhost/ || exit 1</code> 作为健康检查命令。</p><p>使用 <code>docker build</code> 来构建这个镜像：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>$ docker build -t myweb:v1 .
</span></span></code></pre></td></tr></table></div></div><p>构建好了后，我们启动一个容器：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:teal>$ docker run -d --name web -p 80:80 myweb:v1</span>
</span></span></code></pre></td></tr></table></div></div><p>当运行该镜像后，可以通过 <code>docker container ls</code> 看到最初的状态为 <code>(health: starting)</code>：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>$</span> <span style=color:#a61717;background-color:#e3d2d2>docker</span> <span style=color:#a61717;background-color:#e3d2d2>container</span> <span style=color:#a61717;background-color:#e3d2d2>ls</span>
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>CONTAINER</span> <span style=color:#a61717;background-color:#e3d2d2>ID</span>        <span style=color:#a61717;background-color:#e3d2d2>IMAGE</span>               <span style=color:#a61717;background-color:#e3d2d2>COMMAND</span>                  <span style=color:#a61717;background-color:#e3d2d2>CREATED</span>             <span style=color:#a61717;background-color:#e3d2d2>STATUS</span>                            <span style=color:#a61717;background-color:#e3d2d2>PORTS</span>               <span style=color:#a61717;background-color:#e3d2d2>NAMES</span>
</span></span><span style=display:flex><span><span style=color:#099>0</span><span style=color:#099>3e28</span><span style=color:#a61717;background-color:#e3d2d2>eb</span><span style=color:#099>00</span><span style=color:#a61717;background-color:#e3d2d2>bd</span><span style=color:#099>0</span>        <span style=color:#a61717;background-color:#e3d2d2>myweb:v</span><span style=color:#099>1</span>            <span style=color:#d14>&#34;nginx -g &#39;daemon off&#34;</span>   <span style=color:#099>3</span> <span style=color:#a61717;background-color:#e3d2d2>seconds</span> <span style=color:#a61717;background-color:#e3d2d2>ago</span>       <span style=color:#a61717;background-color:#e3d2d2>Up</span> <span style=color:#099>2</span> <span style=color:#a61717;background-color:#e3d2d2>seconds</span> <span style=color:#a61717;background-color:#e3d2d2>(health:</span> <span style=color:#a61717;background-color:#e3d2d2>starting)</span>   <span style=color:#099>80</span><span style=color:#a61717;background-color:#e3d2d2>/tcp,</span> <span style=color:#099>443</span><span style=color:#a61717;background-color:#e3d2d2>/tcp</span>     <span style=color:#a61717;background-color:#e3d2d2>web</span>
</span></span></code></pre></td></tr></table></div></div><p>在等待几秒钟后，再次 <code>docker container ls</code>，就会看到健康状态变化为了 <code>(healthy)</code>：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>$</span> docker container ls
</span></span><span style=display:flex><span>CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                    PORTS               NAMES
</span></span><span style=display:flex><span><span style=color:#099>03e28</span>eb00bd0        myweb:v1            <span style=color:#d14>&#34;nginx -g &#39;daemon off&#34;</span>   <span style=color:#099>18</span> seconds ago      Up <span style=color:#099>16</span> seconds (healthy)   <span style=color:#099>80</span>/tcp, <span style=color:#099>443</span>/tcp     web
</span></span></code></pre></td></tr></table></div></div><p>如果健康检查连续失败超过了重试次数，状态就会变为 <code>(unhealthy)</code>。</p><p>为了帮助排障，健康检查命令的输出（包括 <code>stdout</code> 以及 <code>stderr</code>）都会被存储于健康状态里，可以用 <code>docker inspect</code> 来查看。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-css data-lang=css><span style=display:flex><span><span style=color:#000;font-weight:700>$</span> <span style=color:navy>docker</span> <span style=color:navy>inspect</span> <span style=color:navy>--format</span> <span style=color:#d14>&#39;{{json .State.Health}}&#39;</span> <span style=color:navy>web</span> <span style=color:#000;font-weight:700>|</span> <span style=color:navy>python</span> <span style=color:navy>-m</span> <span style=color:navy>json</span>.<span style=color:#458;font-weight:700>tool</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#a61717;background-color:#e3d2d2>&#34;FailingStreak&#34;:</span> <span style=color:#a61717;background-color:#e3d2d2>0,</span>
</span></span><span style=display:flex><span>    <span style=color:#a61717;background-color:#e3d2d2>&#34;Log&#34;:</span> <span style=color:#a61717;background-color:#e3d2d2>[</span>
</span></span><span style=display:flex><span>        <span style=color:#a61717;background-color:#e3d2d2>{</span>
</span></span><span style=display:flex><span>            <span style=color:#a61717;background-color:#e3d2d2>&#34;End&#34;:</span> <span style=color:#a61717;background-color:#e3d2d2>&#34;2016-11-25</span>T14:<span style=color:#099>35</span><span style=color:#000;font-weight:700>:</span><span style=color:#099>37.940957051</span>Z<span style=color:#d14>&#34;,
</span></span></span><span style=display:flex><span><span style=color:#d14>            &#34;</span>ExitCode<span style=color:#d14>&#34;: 0,
</span></span></span><span style=display:flex><span><span style=color:#d14>            &#34;</span>Output<span style=color:#d14>&#34;: &#34;</span><span style=color:#000;font-weight:700>&lt;!</span>DOCTYPE html<span style=color:#000;font-weight:700>&gt;</span><span style=color:#a61717;background-color:#e3d2d2>\</span>n<span style=color:#000;font-weight:700>&lt;</span>html<span style=color:#000;font-weight:700>&gt;</span><span style=color:#a61717;background-color:#e3d2d2>\</span>n<span style=color:#000;font-weight:700>&lt;</span>head<span style=color:#000;font-weight:700>&gt;</span><span style=color:#a61717;background-color:#e3d2d2>\</span>n<span style=color:#000;font-weight:700>&lt;</span>title<span style=color:#000;font-weight:700>&gt;</span>Welcome <span style=color:#000;font-weight:700>to</span> nginx<span style=color:#000;font-weight:700>!&lt;/</span>title<span style=color:#000;font-weight:700>&gt;</span><span style=color:#a61717;background-color:#e3d2d2>\</span>n<span style=color:#000;font-weight:700>&lt;</span><span style=color:#000;font-weight:700>style</span><span style=color:#000;font-weight:700>&gt;</span><span style=color:#a61717;background-color:#e3d2d2>\</span>n    body <span style=color:#a61717;background-color:#e3d2d2>{\</span>n        <span style=color:#000;font-weight:700>width</span><span style=color:#000;font-weight:700>:</span> <span style=color:#099>35</span><span style=color:#458;font-weight:700>em</span>;<span style=color:#a61717;background-color:#e3d2d2>\n</span>        <span style=color:#000;font-weight:700>margin</span>: <span style=color:#099>0</span> <span style=color:#000;font-weight:700>auto</span>;<span style=color:#a61717;background-color:#e3d2d2>\n</span>        <span style=color:#000;font-weight:700>font-family</span>: Tahoma, Verdana, Arial, <span style=color:#000;font-weight:700>sans-serif</span>;<span style=color:#a61717;background-color:#e3d2d2>\n</span>    }<span style=color:#a61717;background-color:#e3d2d2>\</span><span style=color:navy>n</span><span style=color:#000;font-weight:700>&lt;/</span><span style=color:navy>style</span><span style=color:#000;font-weight:700>&gt;</span><span style=color:#a61717;background-color:#e3d2d2>\</span><span style=color:navy>n</span><span style=color:#000;font-weight:700>&lt;/</span><span style=color:navy>head</span><span style=color:#000;font-weight:700>&gt;</span><span style=color:#a61717;background-color:#e3d2d2>\</span><span style=color:navy>n</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:navy>body</span><span style=color:#000;font-weight:700>&gt;</span><span style=color:#a61717;background-color:#e3d2d2>\</span><span style=color:navy>n</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:navy>h1</span><span style=color:#000;font-weight:700>&gt;</span><span style=color:navy>Welcome</span> <span style=color:navy>to</span> <span style=color:navy>nginx</span><span style=color:#000;font-weight:700>!&lt;/</span><span style=color:navy>h1</span><span style=color:#000;font-weight:700>&gt;</span><span style=color:#a61717;background-color:#e3d2d2>\</span><span style=color:navy>n</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:navy>p</span><span style=color:#000;font-weight:700>&gt;</span><span style=color:navy>If</span> <span style=color:navy>you</span> <span style=color:navy>see</span> <span style=color:navy>this</span> <span style=color:navy>page</span><span style=color:#000;font-weight:700>,</span> <span style=color:navy>the</span> <span style=color:navy>nginx</span> <span style=color:navy>web</span> <span style=color:navy>server</span> <span style=color:navy>is</span> <span style=color:navy>successfully</span> <span style=color:navy>installed</span> <span style=color:navy>and</span><span style=color:#a61717;background-color:#e3d2d2>\</span><span style=color:navy>nworking</span><span style=color:#000;font-weight:700>.</span> <span style=color:navy>Further</span> <span style=color:navy>configuration</span> <span style=color:navy>is</span> <span style=color:navy>required</span><span style=color:#000;font-weight:700>.&lt;/</span><span style=color:navy>p</span><span style=color:#000;font-weight:700>&gt;</span><span style=color:#a61717;background-color:#e3d2d2>\</span><span style=color:navy>n</span><span style=color:#a61717;background-color:#e3d2d2>\</span><span style=color:navy>n</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:navy>p</span><span style=color:#000;font-weight:700>&gt;</span><span style=color:navy>For</span> <span style=color:navy>online</span> <span style=color:navy>documentation</span> <span style=color:navy>and</span> <span style=color:navy>support</span> <span style=color:navy>please</span> <span style=color:navy>refer</span> <span style=color:navy>to</span><span style=color:#a61717;background-color:#e3d2d2>\</span><span style=color:navy>n</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:navy>a</span> <span style=color:navy>href</span><span style=color:#000;font-weight:700>=</span><span style=color:#a61717;background-color:#e3d2d2>\</span><span style=color:#d14>&#34;http://nginx.org/\&#34;&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;\nCommercial support is available at\n&lt;a href=\&#34;http://nginx.com/\&#34;&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;\n\n&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#d14>&#34;Start&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#d14>&#34;2016-11-25T14:35:37.780192565Z&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a61717;background-color:#e3d2d2>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>],</span>
</span></span><span style=display:flex><span>    <span style=color:#d14>&#34;Status&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#d14>&#34;healthy&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=12onbuild-为他人做嫁衣>12.ONBUILD 为他人做嫁衣</h2><p>格式：<code>ONBUILD &lt;其它指令></code>。</p><p><code>ONBUILD</code> 是一个特殊的指令，它后面跟的是其它指令，比如 <code>RUN</code>, <code>COPY</code> 等，而这些指令，在当前镜像构建时并不会被执行。只有当以当前镜像为基础镜像，去构建下一级镜像的时候才会被执行。</p><p><code>Dockerfile</code> 中的其它指令都是为了定制当前镜像而准备的，唯有 <code>ONBUILD</code> 是为了帮助别人定制自己而准备的。</p><p>假设我们要制作 Node.js 所写的应用的镜像。我们都知道 Node.js 使用 <code>npm</code> 进行包管理，所有依赖、配置、启动信息等会放到 <code>package.json</code> 文件里。在拿到程序代码后，需要先进行 <code>npm install</code> 才可以获得所有需要的依赖。然后就可以通过 <code>npm start</code> 来启动应用。因此，一般来说会这样写 <code>Dockerfile</code>：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>FROM</span> <span style=color:#a61717;background-color:#e3d2d2>node:slim</span>
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>RUN</span> <span style=color:#a61717;background-color:#e3d2d2>mkdir</span> <span style=color:#a61717;background-color:#e3d2d2>/app</span>
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>WORKDIR</span> <span style=color:#a61717;background-color:#e3d2d2>/app</span>
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>COPY</span> <span style=color:#a61717;background-color:#e3d2d2>./package.json</span> <span style=color:#a61717;background-color:#e3d2d2>/app</span>
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>RUN</span> [ <span style=color:#d14>&#34;npm&#34;</span>, <span style=color:#d14>&#34;install&#34;</span> ]
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>COPY</span> <span style=color:#a61717;background-color:#e3d2d2>.</span> <span style=color:#a61717;background-color:#e3d2d2>/app/</span>
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>CMD</span> [ <span style=color:#d14>&#34;npm&#34;</span>, <span style=color:#d14>&#34;start&#34;</span> ]
</span></span></code></pre></td></tr></table></div></div><p>把这个 <code>Dockerfile</code> 放到 Node.js 项目的根目录，构建好镜像后，就可以直接拿来启动容器运行。但是如果我们还有第二个 Node.js 项目也差不多呢？好吧，那就再把这个 <code>Dockerfile</code> 复制到第二个项目里。那如果有第三个项目呢？再复制么？文件的副本越多，版本控制就越困难，让我们继续看这样的场景维护的问题。</p><p>如果第一个 Node.js 项目在开发过程中，发现这个 <code>Dockerfile</code> 里存在问题，比如敲错字了、或者需要安装额外的包，然后开发人员修复了这个 <code>Dockerfile</code>，再次构建，问题解决。第一个项目没问题了，但是第二个项目呢？虽然最初 <code>Dockerfile</code> 是复制、粘贴自第一个项目的，但是并不会因为第一个项目修复了他们的 <code>Dockerfile</code>，而第二个项目的 <code>Dockerfile</code> 就会被自动修复。</p><p>那么我们可不可以做一个基础镜像，然后各个项目使用这个基础镜像呢？这样基础镜像更新，各个项目不用同步 <code>Dockerfile</code> 的变化，重新构建后就继承了基础镜像的更新？好吧，可以，让我们看看这样的结果。那么上面的这个 <code>Dockerfile</code> 就会变为：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>FROM node<span style=color:#000;font-weight:700>:</span>slim
</span></span><span style=display:flex><span>RUN mkdir <span style=color:#000;font-weight:700>/</span>app
</span></span><span style=display:flex><span>WORKDIR <span style=color:#000;font-weight:700>/</span>app
</span></span><span style=display:flex><span>CMD [ <span style=color:#d14>&#34;npm&#34;</span>, <span style=color:#d14>&#34;start&#34;</span> ]
</span></span></code></pre></td></tr></table></div></div><p>这里我们把项目相关的构建指令拿出来，放到子项目里去。假设这个基础镜像的名字为 <code>my-node</code> 的话，各个项目内的自己的 <code>Dockerfile</code> 就变为：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-graphql data-lang=graphql><span style=display:flex><span>FROM<span style=color:#bbb> </span>my<span style=color:#a61717;background-color:#e3d2d2>-</span>node<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>COPY<span style=color:#bbb> </span><span style=color:#a61717;background-color:#e3d2d2>./</span>package<span style=color:#a61717;background-color:#e3d2d2>.</span>json<span style=color:#bbb> </span><span style=color:#a61717;background-color:#e3d2d2>/</span>app<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>RUN<span style=color:#bbb> </span>[<span style=color:#bbb> </span><span style=color:#d14>&#34;npm&#34;</span>,<span style=color:#bbb> </span><span style=color:#d14>&#34;install&#34;</span><span style=color:#bbb> </span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>COPY<span style=color:#bbb> </span><span style=color:#a61717;background-color:#e3d2d2>.</span><span style=color:#bbb> </span><span style=color:#a61717;background-color:#e3d2d2>/</span>app<span style=color:#a61717;background-color:#e3d2d2>/</span><span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><p>基础镜像变化后，各个项目都用这个 <code>Dockerfile</code> 重新构建镜像，会继承基础镜像的更新。</p><p>那么，问题解决了么？没有。准确说，只解决了一半。如果这个 <code>Dockerfile</code> 里面有些东西需要调整呢？比如 <code>npm install</code> 都需要加一些参数，那怎么办？这一行 <code>RUN</code> 是不可能放入基础镜像的，因为涉及到了当前项目的 <code>./package.json</code>，难道又要一个个修改么？所以说，这样制作基础镜像，只解决了原来的 <code>Dockerfile</code> 的前4条指令的变化问题，而后面三条指令的变化则完全没办法处理。</p><p><code>ONBUILD</code> 可以解决这个问题。让我们用 <code>ONBUILD</code> 重新写一下基础镜像的 <code>Dockerfile</code>:</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>FROM node<span style=color:#000;font-weight:700>:</span>slim
</span></span><span style=display:flex><span>RUN mkdir <span style=color:#000;font-weight:700>/</span>app
</span></span><span style=display:flex><span>WORKDIR <span style=color:#000;font-weight:700>/</span>app
</span></span><span style=display:flex><span>ONBUILD COPY .<span style=color:#000;font-weight:700>/</span><span style=color:#000;font-weight:700>package</span>.json <span style=color:#000;font-weight:700>/</span>app
</span></span><span style=display:flex><span>ONBUILD RUN [ <span style=color:#d14>&#34;npm&#34;</span>, <span style=color:#d14>&#34;install&#34;</span> ]
</span></span><span style=display:flex><span>ONBUILD COPY . <span style=color:#000;font-weight:700>/</span>app<span style=color:#000;font-weight:700>/</span>
</span></span><span style=display:flex><span>CMD [ <span style=color:#d14>&#34;npm&#34;</span>, <span style=color:#d14>&#34;start&#34;</span> ]
</span></span></code></pre></td></tr></table></div></div><p>这次我们回到原始的 <code>Dockerfile</code>，但是这次将项目相关的指令加上 <code>ONBUILD</code>，这样在构建基础镜像的时候，这三行并不会被执行。然后各个项目的 <code>Dockerfile</code> 就变成了简单地：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>FROM my<span style=color:#000;font-weight:700>-</span>node
</span></span></code></pre></td></tr></table></div></div><p>是的，只有这么一行。当在各个项目目录中，用这个只有一行的 <code>Dockerfile</code> 构建镜像时，之前基础镜像的那三行 <code>ONBUILD</code> 就会开始执行，成功的将当前项目的代码复制进镜像、并且针对本项目执行 <code>npm install</code>，生成应用镜像。</p><h2 id=13label-为镜像添加元数据>13.LABEL 为镜像添加元数据</h2><p><code>LABEL</code> 指令用来给镜像以键值对的形式添加一些元数据（metadata）。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>LABEL &lt;key<span style=color:#000;font-weight:700>&gt;=</span>&lt;<span style=color:#000;font-weight:700>value</span>&gt; &lt;key<span style=color:#000;font-weight:700>&gt;=</span>&lt;<span style=color:#000;font-weight:700>value</span>&gt; &lt;key<span style=color:#000;font-weight:700>&gt;=</span>&lt;<span style=color:#000;font-weight:700>value</span>&gt; <span style=color:#000;font-weight:700>..</span>.
</span></span></code></pre></td></tr></table></div></div><p>我们还可以用一些标签来申明镜像的作者、文档地址等：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>LABEL org<span style=color:#000;font-weight:700>.</span><span style=color:teal>opencontainers</span><span style=color:#000;font-weight:700>.</span><span style=color:teal>image</span><span style=color:#000;font-weight:700>.</span><span style=color:teal>authors</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;yeasy&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>LABEL org<span style=color:#000;font-weight:700>.</span><span style=color:teal>opencontainers</span><span style=color:#000;font-weight:700>.</span><span style=color:teal>image</span><span style=color:#000;font-weight:700>.</span><span style=color:teal>documentation</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;https://yeasy.gitbooks.io&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>具体可以参考 <a href=https://github.com/opencontainers/image-spec/blob/master/annotations.md>https://github.com/opencontainers/image-spec/blob/master/annotations.md</a></p><h2 id=14shell指令>14.shell指令</h2><p>格式：<code>SHELL ["executable", "parameters"]</code></p><p><code>SHELL</code> 指令可以指定 <code>RUN</code> <code>ENTRYPOINT</code> <code>CMD</code> 指令的 shell，Linux 中默认为 <code>["/bin/sh", "-c"]</code></p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>SHELL [<span style=color:#d14>&#34;/bin/sh&#34;</span>, <span style=color:#d14>&#34;-c&#34;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>RUN lll ; ls
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>SHELL [<span style=color:#d14>&#34;/bin/sh&#34;</span>, <span style=color:#d14>&#34;-cex&#34;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>RUN lll ; ls
</span></span></code></pre></td></tr></table></div></div><p>两个 <code>RUN</code> 运行同一命令，第二个 <code>RUN</code> 运行的命令会打印出每条命令并当遇到错误时退出。</p><p>当 <code>ENTRYPOINT</code> <code>CMD</code> 以 shell 格式指定时，<code>SHELL</code> 指令所指定的 shell 也会成为这两个指令的 shell</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>SHELL [<span style=color:#d14>&#34;/bin/sh&#34;</span>, <span style=color:#d14>&#34;-cex&#34;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>#</span> /bin/sh -cex <span style=color:#d14>&#34;nginx&#34;</span>
</span></span><span style=display:flex><span>ENTRYPOINT nginx
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>SHELL [<span style=color:#d14>&#34;/bin/sh&#34;</span>, <span style=color:#d14>&#34;-cex&#34;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>#</span> <span style=color:#000;font-weight:700>/</span>bin<span style=color:#000;font-weight:700>/</span>sh <span style=color:#000;font-weight:700>-</span>cex <span style=color:#d14>&#34;nginx&#34;</span>
</span></span><span style=display:flex><span>CMD nginx
</span></span></code></pre></td></tr></table></div></div></div></div></div><div id=footer><div class=container-footer><div class=beian><a target=_blank href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode="></a><a href target=_blank><span class=some>icp...<span></a></div><div class=info><a href=https://github.com/loveminimal/hugo-theme-virgo>🕊️</a> 2021 - <span id=info-date></span></div></div></div><div class=cool-after></div></body></html>