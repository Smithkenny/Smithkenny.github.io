<!doctype html><html lang=zh-CN><head><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><meta name=description content="Ubuntu使用上篇 - https://www.haipengv.com/posts/ubuntu%E4%BD%BF%E7%94%A8%E4%B8%8A%E7%AF%87/"><meta name=author content="Smith - https://www.haipengv.com/"><meta name=msvalidate.01 content="B46311949B856F2A7015F366FB3CE878"><title>Ubuntu使用上篇</title><base target=_self><link rel=icon type=image/png href=/favicon.ico><link rel=stylesheet href=https://www.haipengv.com/style.min.9a0cea23154ac1941e15c25aa2d31b77285a217d2606ec05b55236428cf1c3e6.css><script>const DARK=!1</script><script type=text/javascript src=/main.js defer></script></head><body class=active-animate><div class=cool-before></div><div id=header><div class=container-header><div class=right><h1 class=title>Ubuntu使用上篇</h1><div id=toc>📜</div></div></div></div><div id=content><div class="container-main container-page"><div class=rel><div class=curtag-desc><a href=https://www.haipengv.com/tags/linux%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/><img src=/imgs/icons/tag.svg width=16> 相关文章：Linux基础知识 <sup>41</sup></a></div><div class=curtag-post><div class=curtag-post-item><a href=https://www.haipengv.com/posts/centos7-%E5%8D%87%E7%BA%A7%E5%86%85%E6%A0%B8/>CentOS7 升级内核</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/centos7.9%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86%E4%B8%8E%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AE%E7%BB%BC%E5%90%88%E6%8C%87%E5%8D%97/>CentOS7.9系统管理与服务配置综合指南</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/centos7%E4%BD%BF%E7%94%A8systemd%E7%AE%A1%E7%90%86%E7%A8%8B%E5%BA%8F/>Centos7使用systemd管理程序</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/centos7-%E5%B8%B8%E8%A7%84%E5%91%BD%E4%BB%A4/>CentOS7常规命令</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/centos7%E7%BD%91%E5%8D%A1%E6%94%B9%E5%9B%9Eeth0%E6%98%BE%E7%A4%BA/>Centos7网卡改回eth0显示</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/centos8%E9%85%8D%E7%BD%AEyum%E6%BA%90/>CentOS8配置yum源</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/centos%E6%90%AD%E5%BB%BA%E5%86%85%E7%BD%91%E9%82%AE%E4%BB%B6%E6%9C%8D%E5%8A%A1%E5%99%A8/>Centos搭建内网邮件服务器</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/crontab%E8%B8%A9%E5%9D%91%E8%AE%B0/>Crontab踩坑记</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/git%E5%85%A5%E9%97%A8/>Git入门</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/http%E5%92%8Chttps%E5%90%84%E7%A7%8D%E6%96%B9%E6%B3%95%E6%B5%8B%E8%AF%95/>Http和Https各种方法测试</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/iptables%E5%B8%B8%E7%94%A8%E6%80%BB%E7%BB%93/>Iptables常用总结</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/linux-oom%E4%BB%8B%E7%BB%8D/>Linux OOM介绍</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/linux%E4%B8%8B%E6%B7%B7%E6%9D%82%E6%A8%A1%E5%BC%8F%E5%88%A4%E6%96%AD/>Linux下混杂模式判断</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/linux%E4%B8%AD%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/>Linux中环境变量</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/linux%E4%B8%AD%E7%9A%84%E9%9A%94%E7%A6%BB/>Linux中的隔离</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/linux%E4%BF%A1%E6%81%AF%E6%9F%A5%E8%AF%A2%E5%91%BD%E4%BB%A4/>Linux信息查询命令</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/linux%E5%9E%83%E5%9C%BE%E6%A1%B6/>Linux垃圾桶</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/linux%E5%B0%8F%E6%8A%80%E5%B7%A7%E6%B1%87%E6%80%BB/>Linux小技巧汇总</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/linux%E6%97%A5%E5%BF%97%E5%A4%A7%E6%96%87%E4%BB%B6%E5%88%87%E5%89%B2/>Linux日志大文件切割</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/linux%E6%9F%A5%E7%9C%8B%E7%A8%8B%E5%BA%8F%E8%BF%9B%E7%A8%8B%E5%90%AF%E5%8A%A8%E6%97%B6%E9%97%B4/>Linux查看程序进程启动时间</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/linux%E6%A0%B9%E5%88%86%E5%8C%BA%E6%BB%A1%E4%BA%86%E5%A4%84%E7%90%86%E6%96%B9%E6%B3%95/>Linux根分区满了处理方法</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/linux%E7%A1%AC%E7%9B%98%E6%89%A9%E5%AE%B9%E5%92%8C%E7%BC%A9%E5%AE%B9/>Linux硬盘扩容和缩容</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/pam%E6%A8%A1%E5%9D%97%E9%99%90%E5%88%B6%E7%99%BB%E5%BD%95/>Pam模块限制登录</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/postman%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/>Postman简单使用</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/rsyslog%E6%97%A5%E5%BF%97%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA/>Rsyslog日志服务器搭建</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/ssh%E7%9B%B8%E5%85%B3%E8%AF%B4%E6%98%8E/>SSH相关说明</a></div><div class="curtag-post-item curtag-post-item--active"><a href=https://www.haipengv.com/posts/ubuntu%E4%BD%BF%E7%94%A8%E4%B8%8A%E7%AF%87/>Ubuntu使用上篇</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/ubuntu%E4%BD%BF%E7%94%A8%E4%B8%8B%E7%AF%87/>Ubuntu使用下篇</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/vsftpd%E7%9B%B8%E5%85%B3%E9%85%8D%E7%BD%AE/>Vsftpd相关配置</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/vsftp%E4%B8%8D%E5%90%8C%E7%94%A8%E6%88%B7%E6%8B%A5%E6%9C%89%E4%B8%8D%E5%90%8C%E6%9D%83%E9%99%90/>Vsftp不同用户拥有不同权限</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/%E4%BD%BF%E7%94%A8logrotate%E8%BF%9B%E8%A1%8C%E6%97%A5%E5%BF%97%E5%88%87%E5%89%B2/>使用logrotate进行日志切割</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/%E4%BD%BF%E7%94%A8sed%E6%89%B9%E9%87%8F%E4%BF%AE%E6%94%B9%E7%BD%91%E5%9D%80/>使用sed批量修改网址</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/%E4%BD%BF%E7%94%A8%E6%B5%8F%E8%A7%88%E5%99%A8%E7%99%BB%E5%BD%95linux%E6%9C%8D%E5%8A%A1%E5%99%A8/>使用浏览器登录linux服务器</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/%E5%86%85%E7%BD%91%E9%9A%A7%E9%81%93ssh%E6%90%AD%E5%BB%BA%E6%96%B9%E6%B3%95/>内网隧道ssh搭建方法</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/%E5%8A%9F%E8%83%BD%E5%BC%BA%E5%A4%A7%E7%9A%84%E7%A1%AC%E4%BB%B6%E4%BF%A1%E6%81%AF%E8%8E%B7%E5%8F%96%E5%B7%A5%E5%85%B7-inxi/>功能强大的硬件信息获取工具-Inxi</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/%E5%8E%8B%E7%BC%A9%E4%B8%8E%E8%A7%A3%E5%8E%8B/>压缩与解压</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/%E5%A6%82%E4%BD%95%E7%AD%9B%E9%80%89%E6%8C%87%E5%AE%9A%E6%97%B6%E9%97%B4%E6%AE%B5%E5%86%85%E7%9A%84%E6%97%A5%E5%BF%97/>如何筛选指定时间段内的日志</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/%E6%90%AD%E5%BB%BArss%E8%AE%A2%E9%98%85%E5%99%A8/>搭建rss订阅器</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/%E6%96%B0%E7%89%A9%E7%90%86%E7%A3%81%E7%9B%98%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%88%86%E5%8C%BA%E6%8C%82%E8%BD%BD%E8%BF%87%E7%A8%8B/>新物理磁盘格式化、分区、挂载过程</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/%E6%9F%A5%E7%9C%8B%E7%B3%BB%E7%BB%9F%E5%AE%89%E8%A3%85%E6%97%B6%E9%97%B4/>查看系统安装时间</a></div><div class=curtag-post-item><a href=https://www.haipengv.com/posts/%E6%A8%A1%E6%8B%9Fssh%E6%89%A7%E8%A1%8C%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4/>模拟ssh执行远程命令</a></div></div></div><div class=desc><span><svg t="1656736000388" class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="7409" width="12" height="12"><path d="M524.885333 338.986667l-324.522666 324.48c-17.28 15.274667-27.989333 36.693333-29.696 56.234666v133.76l130.730666.085334c22.784-1.621333 43.989333-12.245333 61.013334-31.701334L685.098667 499.2 524.885333 338.986667zM585.258667 278.656l160.170666 160.213333 102.144-102.144a19.712 19.712.0 000-27.861333l-132.48-132.437333a19.456 19.456.0 00-27.605333.0L585.258667 278.613333zM701.312 85.333333c27.946667.0 54.741333 11.136 74.282667 30.848L907.904 248.490667a105.045333 105.045333.0 010 148.565333L424.874667 879.957333C395.050667 914.304 352.768 935.424 304.426667 938.752H85.333333v-42.666667l.128-179.84c3.626667-44.970667 24.576-86.826667 56.448-114.944l485.12-485.034666a104.789333 104.789333.0 0174.24-30.933334z" p-id="7410" fill="#adb5bd"/></svg>2025-03-16&nbsp;&nbsp;&nbsp;<svg t="1656737270708" class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="23838" width="11" height="11"><path d="M824.264 95.36c0-23.859 25.043-44.16 48.902-44.16s49.714 20.301 49.714 44.16v190.08c0 23.859-19.054 52.868-42.913 52.868h-190.08c-23.859.0-46.696-25.96-46.696-49.819s22.55-46.249 46.409-46.249h82.025C702.344 175.534 610.22 155.853 512 155.853c-206.775.0-360.398 149.372-360.398 356.147S305.225 870.23 512 870.23c206.775.0 357.467-151.455 357.467-358.23.0-23.859 23.634-50.706 53.413-50.706 29.78.0 49.92 26.847 49.92 50.706.0 254.493-206.307 460.8-460.8 460.8s-460.8-206.307-460.8-460.8C51.2 257.507 257.507 51.2 512 51.2c122.4.0 226.684 33.296 312.264 117.369.358.351.358-24.052.0-73.209z" p-id="23839" fill="#adb5bd"/></svg>
2025-03-16&nbsp;&nbsp;&nbsp;</span>
<span><svg t="1656737548689" class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="33866" width="12" height="12"><path d="M832.038608 64.662657H192.030028c-70.774903.0-128.089859 57.325793-128.089859 128.03206v446.793671c0 70.7171050000001 57.314956 128.154884 128.089859 128.154884h133.353183a63.940169 63.940169.0 0155.219742 31.576328l76.099638 129.83828c12.358154 21.093031 33.790754 31.626903 55.216129 31.626903s42.832688-10.544709 55.198067-31.619678l76.222461-129.870792a63.940169 63.940169.0 0155.212517-31.551041h133.54103c70.576219.0 127.732228-57.289669 127.732227-127.800865V192.391272c0-70.536482-57.181295-127.728615-127.786414-127.728615zM895.884854 639.842407A63.85347 63.85347.0 01832.092795 703.703103h-133.54103a127.753903 127.753903.0 00-110.349172 63.09847l-76.222461 129.856342a.274545.274545.0 010-.050574h-.032512s-.021675.061411-.032512.061412l-76.1466-129.85273a127.804477 127.804477.0 00-110.385297-63.11292H192.030028A64.207489 64.207489.0 01127.880338 639.488388V192.694717a64.102729 64.102729.0 0164.14969-64.091891h640.00858a63.799284 63.799284.0 0163.846246 63.788446v447.451135z" fill="#adb5bd" p-id="33867"/><path d="M608.154093 288.092004a31.970084 31.970084.0 00-31.970084 31.970085v160.078006L441.53396 300.861976a31.970084 31.970084.0 00-57.531702 19.200113v255.760676a31.970084 31.970084.0 0063.940169.0V415.863969l134.650048 179.274507a31.970084 31.970084.0 0057.531703-19.200113V320.062089a31.970084 31.970084.0 00-31.970085-31.970085z" fill="#adb5bd" p-id="33868"/></svg>14957 字</span>&nbsp;
<span><svg t="1656737462334" class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="32892" width="12" height="12"><path d="M512 74.666667C270.933333 74.666667 74.666667 270.933333 74.666667 512S270.933333 949.333333 512 949.333333 949.333333 753.066667 949.333333 512 753.066667 74.666667 512 74.666667zm0 810.666666C307.2 885.333333 138.666667 716.8 138.666667 512S307.2 138.666667 512 138.666667 885.333333 307.2 885.333333 512 716.8 885.333333 512 885.333333z" p-id="32893" fill="#adb5bd"/><path d="M695.466667 567.466667 544 497.066667V277.333333c0-17.066667-14.933333-32-32-32s-32 14.933333-32 32v238.933334c0 12.8 6.4 23.466667 19.2 29.866666L669.866667 627.2c4.266667 2.133333 8.533333 2.133333 12.8 2.133333 12.8.0 23.466667-6.4 29.866666-19.2 6.4-14.933333.0-34.133333-17.066666-42.666666z" p-id="32894" fill="#adb5bd"/></svg>30 分钟</span><div class=container-ctgtag><div class=taxonomy><div class=tag><a href=/tags/linux%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86>Linux基础知识</a></div></div></div></div><div class=toc><div class=container-page-operation><div class=page-operation><div><a href=/><img src=/imgs/icons/home-2.svg alt></a></div><div><a href=/nav><img src=/imgs/icons/iov-navigate-1.svg alt></a></div><div><a href=/wiki><img src=/imgs/icons/wiki.svg alt></a></div><div><a href=/tags><img src=/imgs/icons/treetags.svg alt></a></div><div id=light-dark><a><img src=/imgs/icons/moon2.svg alt></a></div><div><a href=#><img src=/imgs/icons/up2.svg alt></a></div></div></div><nav id=TableOfContents><ul><li><ul><li><a href=#一ubuntu2010-server-lts安装>一、Ubuntu20.10 server LTS安装</a></li><li><a href=#二包管理>二、包管理</a></li><li><a href=#三无人值守批量安装ubuntu-server-20043>三、无人值守批量安装Ubuntu server 20.04.3</a></li><li><a href=#四ubuntu-网络配置>四、Ubuntu 网络配置</a></li><li><a href=#五安全>五、安全</a></li><li><a href=#六防火墙>六、防火墙</a></li><li><a href=#七日志>七、日志</a></li></ul></li></ul></nav></div><div class=content><h3 id=一ubuntu2010-server-lts安装>一、Ubuntu20.10 server LTS安装</h3><p>LTS（长期支持版）</p><p>支持以下处理器</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>amd64 <span style=color:#000;font-weight:700>(</span>Intel/AMD 64-bit<span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>arm64 <span style=color:#000;font-weight:700>(</span>64-bit ARM<span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>ppc64el <span style=color:#000;font-weight:700>(</span>POWER8 and POWER9<span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>s390x <span style=color:#000;font-weight:700>(</span>IBM Z and LinuxONE<span style=color:#000;font-weight:700>)</span>
</span></span></code></pre></td></tr></table></div></div><p>最低配置</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>CPU: 1g或者更高
</span></span><span style=display:flex><span>RAM: 1g或者更高
</span></span><span style=display:flex><span>Disk: 不小于2.5G
</span></span></code></pre></td></tr></table></div></div><h4 id=桌面版和服务器版不同><strong>桌面版和服务器版不同</strong></h4><p>Ubuntu服务器版和Ubuntu桌面版使用相同的Apt库。</p><p>一个主要区别是用于桌面版的图形环境没有为服务器安装。这包括图形服务器本身、图形实用程序和应用程序，以及桌面用户所需的各种用户支持服务。</p><h4 id=镜像下载地址>镜像下载地址</h4><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>https://releases.ubuntu.com/20.04/
</span></span></code></pre></td></tr></table></div></div><p>开机引导启动</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ESC、F2、F10、或F12
</span></span></code></pre></td></tr></table></div></div><p>快捷键</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ESC	go back
</span></span><span style=display:flex><span>F1	open <span style=color:#0086b3>help</span> menu
</span></span><span style=display:flex><span>Control-Z, F2	switch to shell
</span></span><span style=display:flex><span>Control-L, F3	redraw screen
</span></span><span style=display:flex><span>Control-T, F4	toggle rich mode <span style=color:#000;font-weight:700>(</span>colour, unicode<span style=color:#000;font-weight:700>)</span> on and off
</span></span></code></pre></td></tr></table></div></div><h4 id=更换清华源>更换清华源</h4><p><a href=https://mirrors.tuna.tsinghua.edu.cn/help/ubuntu/>参考</a></p><p>1.备份源文件</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo cp /etc/apt/sources.list /etc/apt/sources.list.bak
</span></span></code></pre></td></tr></table></div></div><p>2.打开sources.list:</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo gedit /etc/apt/sources.list
</span></span></code></pre></td></tr></table></div></div><p>加入清华源</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal main restricted
</span></span><span style=display:flex><span>deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-updates main restricted
</span></span><span style=display:flex><span>deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal universe
</span></span><span style=display:flex><span>deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-updates universe
</span></span><span style=display:flex><span>deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal multiverse
</span></span><span style=display:flex><span>deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-updates multiverse
</span></span><span style=display:flex><span>deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-backports main restricted universe multiverse
</span></span><span style=display:flex><span>deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-security main restricted
</span></span><span style=display:flex><span>deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-security universe
</span></span><span style=display:flex><span>deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-security multiverse
</span></span></code></pre></td></tr></table></div></div><p>3.刷新软件源信息：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo apt-get update
</span></span></code></pre></td></tr></table></div></div><p>4.更新软件</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo apt-get upgrade
</span></span></code></pre></td></tr></table></div></div><p>5.如果更新报以下错误</p><pre tabindex=0><code>Ign:1 https://mirrors.tuna.tsinghua.edu.cn/ubuntu focal InRelease
Ign:2 https://mirrors.tuna.tsinghua.edu.cn/ubuntu focal-updates InRelease
Ign:3 https://mirrors.tuna.tsinghua.edu.cn/ubuntu focal-backports InRelease
Ign:4 https://mirrors.tuna.tsinghua.edu.cn/ubuntu focal-security InRelease
Err:5 https://mirrors.tuna.tsinghua.edu.cn/ubuntu focal Release
  Certificate verification failed: The certificate is NOT trusted. The certificate chain uses expired certificate.  Could not handshake: Error in the certificate verification. [IP: 101.6.15.130 443]
Err:6 https://mirrors.tuna.tsinghua.edu.cn/ubuntu focal-updates Release
  Certificate verification failed: The certificate is NOT trusted. The certificate chain uses expired certificate.  Could not handshake: Error in the certificate verification. [IP: 101.6.15.130 443]
Err:7 https://mirrors.tuna.tsinghua.edu.cn/ubuntu focal-backports Release
  Certificate verification failed: The certificate is NOT trusted. The certificate chain uses expired certificate.  Could not handshake: Error in the certificate verification. [IP: 101.6.15.130 443]
Err:8 https://mirrors.tuna.tsinghua.edu.cn/ubuntu focal-security Release
  Certificate verification failed: The certificate is NOT trusted. The certificate chain uses expired certificate.  Could not handshake: Error in the certificate verification. [IP: 101.6.15.130 443]
</code></pre><p>将源中<code>https</code>改为<code>http</code>即可</p><h3 id=二包管理>二、包管理</h3><p><strong>后缀名为.deb</strong></p><h4 id=安装软件包nmap><strong>安装软件包nmap</strong></h4><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo apt install nmap
</span></span></code></pre></td></tr></table></div></div><h4 id=卸载软件包nmap><strong>卸载软件包nmap</strong></h4><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo apt remove nmap
</span></span></code></pre></td></tr></table></div></div><p>卸载多个包用空格分隔。</p><h4 id=更新包索引><strong>更新包索引</strong></h4><p>APT 包索引本质上是<code>/etc/apt/sources.list</code>文件和<code>/etc/apt/sources.list.d</code>目录中定义的存储库中可用包的数据库。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo apt update
</span></span></code></pre></td></tr></table></div></div><h4 id=aptitude-包管理工具>aptitude-包管理工具</h4><p>aptitude 在删除一个包时，会同时删除本身所依赖的包。这样，系统中不会残留无用的包，整个系统更为干净。</p><h4 id=常用包管理命令><strong>常用包管理命令</strong></h4><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>aptitude update                更新可用的包列表
</span></span><span style=display:flex><span>aptitude upgrade               升级可用的包
</span></span><span style=display:flex><span>aptitude dist-upgrade          将系统升级到新的发行版
</span></span><span style=display:flex><span>aptitude install pkgname       安装包
</span></span><span style=display:flex><span>aptitude remove pkgname        删除包
</span></span><span style=display:flex><span>aptitude purge pkgname         删除包及其配置文件
</span></span><span style=display:flex><span>aptitude search string         搜索包
</span></span><span style=display:flex><span>aptitude show pkgname          显示包的详细信息
</span></span><span style=display:flex><span>aptitude clean                 删除下载的包文件
</span></span><span style=display:flex><span>aptitude autoclean             仅删除过期的包文件
</span></span></code></pre></td></tr></table></div></div><h4 id=查看程序所需依赖包><strong>查看程序所需依赖包</strong></h4><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>root@liujie-desktop:~# apt-cache depends freeradius
</span></span><span style=display:flex><span>freeradius
</span></span><span style=display:flex><span>  依赖: lsb-base
</span></span><span style=display:flex><span>  依赖: libc6
</span></span><span style=display:flex><span>  依赖: libfreeradius2
</span></span><span style=display:flex><span>  依赖: libgdbm3
</span></span><span style=display:flex><span>  依赖: libltdl7
</span></span><span style=display:flex><span>  依赖: libpam0g
</span></span><span style=display:flex><span>  依赖: libperl5.10
</span></span><span style=display:flex><span>  依赖: libpython2.6
</span></span><span style=display:flex><span>  依赖: libssl0.9.8
</span></span><span style=display:flex><span>  依赖: zlib1g
</span></span><span style=display:flex><span>  依赖: freeradius-common
</span></span><span style=display:flex><span>  依赖: ssl-cert
</span></span><span style=display:flex><span>  依赖: adduser
</span></span><span style=display:flex><span>  建议: freeradius-ldap
</span></span><span style=display:flex><span>  建议: freeradius-postgresql
</span></span><span style=display:flex><span>  建议: freeradius-mysql
</span></span><span style=display:flex><span>  建议: freeradius-krb5
</span></span></code></pre></td></tr></table></div></div><h4 id=aptitude-安装nmap>aptitude 安装nmap</h4><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo aptitude install nmap
</span></span></code></pre></td></tr></table></div></div><h4 id=aptitude-卸载nmap>aptitude 卸载nmap</h4><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo aptitude remove nmap
</span></span></code></pre></td></tr></table></div></div><h4 id=dpkg-包管理器>dpkg-包管理器</h4><p><strong>它可以安装、删除和构建包，但与其他包管理系统不同，它不能自动下载和安装包或其依赖项。Apt和Aptitude 是较新的，并且在 dpkg 之上添加了附加功能。</strong></p><p>列出系统包数据库中的所有包，包括所有已安装和已卸载的包。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>dpkg -l
</span></span></code></pre></td></tr></table></div></div><p>通过 grep 管道输出以查看是否安装了特定的包：</p><pre tabindex=0><code>dpkg -l | grep apache2
</code></pre><p>要列出包安装的文件，在本例中为 ufw 包，请输入：</p><pre tabindex=0><code>dpkg -L ufw
</code></pre><p>如果你不确定安装了哪个包的文件，<code>dpkg -S</code>也许可以告诉你。例如：</p><pre tabindex=0><code>dpkg -S /etc/host.conf base-files: /etc/host.conf
</code></pre><p>输出显示<code>/etc/host.conf</code>属于 base-files 包。</p><p>您可以<code>.deb</code>通过输入以下内容来安装本地文件：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo dpkg -i zip_3.0-4_amd64.deb
</span></span></code></pre></td></tr></table></div></div><p>卸载软件包可以通过以下方式完成：</p><pre tabindex=0><code>sudo dpkg -r zip
</code></pre><p>注意：在大多数情况下，不推荐使用 dpkg 卸载软件包。最好使用处理依赖关系的包管理器，以确保系统处于一致状态。它不会卸载相关依赖包。</p><h3 id=三无人值守批量安装ubuntu-server-20043>三、无人值守批量安装Ubuntu server 20.04.3</h3><p>使用PXE自动从网络加载安装程序，发起安装。</p><p>使用Ubuntu的自动安装功能，自动加载cloud-init安装配置，完成操作系统的自动选择。</p><p>需要装有pxe的服务端，服务器需要安装的软件有tftp客户端，dnsmasq 服务端，tftp服务端可以在dnsmasq.conf中配置。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>apt install tftp
</span></span><span style=display:flex><span>apt install dnsmasq
</span></span></code></pre></td></tr></table></div></div><p>需要安装系统的客户端（此时用虚拟机创建一个空的虚拟机。需要第一启动项为网卡启动，并且默认uefi启动）</p><h4 id=pxe-安装流程>PXE 安装流程</h4><p>​ PXE（Pre-boot Execution Environment/预启动执行环境）的实现依赖于网卡，只有支持PXE Client的网卡才能实现网络自动安装。这种网卡实现DHCP Client和 TFTP Client，在BIOS的引导下通过DHCP协议自动分配IP地址，通过TFTP获取最小内核，然后在最小内核环境下通过HTTP协议或NFS协议获取Ubuntu安装版本。之后最小内核引导进行Ubuntu 20.04的安装。下图是详细的安装流程。</p><p><img src=/postimages/auto-install1.webp alt=无人值守1></p><p>上图有几个前提：</p><ol><li>网卡支持PXE，今年新出的网卡基本都支持，同时BIOS的启动项也要配置，请大家自行研究。</li><li>UEFI启动才会请求bootx64.efi，如果是传统启动模式（Legacy），那么PXE Client会请求pxelinux.0。</li><li>可以采用nfsboot方式，这个流程采用的是iso镜像下载再安装的方式。</li></ol><p>以下引导方式为uefi，虚拟机客户端需要将bios模式改为uefi模式，同时，将开机启动项将从网卡启动设置为第一启动项。</p><p><img src=/postimages/auto-install2.webp alt=无人值守2></p><p><img src=/postimages/noskip.webp alt=noskip></p><h4 id=安装必须的服务端软件>安装必须的服务端软件</h4><ol><li>安装DHCP、TFTP服务器
dnsmasq同时实现了DHCP、TFTP、DNS三种服务器
<code>sudo apt-get install dnsmasq</code></li><li>安装HTTP服务器
HTTP Server有很多，大家可以使用自己的熟悉的服务器如nginx，这里使用的是apache2
<code>sudo apt-get install apache2</code></li></ol><h4 id=准备启动文件>准备启动文件</h4><ol><li><p>下载uefi 引导文件，shim.signed、grub-efi-amd64-signed 安全启动链加载的引导程序</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-arduino data-lang=arduino><span style=display:flex><span>apt<span style=color:#000;font-weight:700>-</span><span style=color:#900;font-weight:700>get</span> download shim.<span style=color:#458;font-weight:700>signed</span>
</span></span><span style=display:flex><span>apt<span style=color:#000;font-weight:700>-</span><span style=color:#900;font-weight:700>get</span> download grub<span style=color:#000;font-weight:700>-</span>efi<span style=color:#000;font-weight:700>-</span>amd64<span style=color:#000;font-weight:700>-</span><span style=color:#458;font-weight:700>signed</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>下载ubuntu 20.04 server iso
这个直接去官网下载，我下载的是<code>ubuntu-20.04.3-live-server-amd64.iso</code>，需要注意的是只有live版本才能支持subiquity
<code>https://ubuntu.com/download/server</code></p></li></ol><h4 id=创建tftp-文件夹>创建TFTP 文件夹</h4><p>TFTP 文件夹是TFTP服务的根目录，PXE启动过程中下载的文件都存在在该目录中</p><pre tabindex=0><code class=language-mipsasm data-lang=mipsasm>tftp
├── boot
│   └── live-server
│       ├── initrd
│       └── vmlinuz
├── grub
│   ├── bootx64.efi
│   ├── font.pf2
│   └── grub.cfg
└── grubx64.efi
</code></pre><h4 id=说明>说明</h4><ol><li>bootx64.efi、grubx64.efi 引导程序，来自shim.signed 安装包</li><li>grub.cfg 自建</li><li>其他文件来自 ubuntu安装包</li><li>五个文件是需要的，但是目录结构是我自建的，大家可以根据自己的喜好修改</li></ol><h4 id=创建目录>创建目录</h4><p>在 /tftp (可根据实际情况修改)目录下创建 tftp目录</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-awk data-lang=awk><span style=display:flex><span>mkdir <span style=color:#000;font-weight:700>/</span>tftp
</span></span><span style=display:flex><span>mkdir <span style=color:#000;font-weight:700>/</span>tftp<span style=color:#000;font-weight:700>/</span>grub
</span></span><span style=display:flex><span>mkdir <span style=color:#000;font-weight:700>/</span>tftp<span style=color:#000;font-weight:700>/</span>boot
</span></span><span style=display:flex><span>mkdir <span style=color:#000;font-weight:700>/</span>tftp<span style=color:#000;font-weight:700>/</span>boot<span style=color:#000;font-weight:700>/</span>live<span style=color:#000;font-weight:700>-</span>server
</span></span></code></pre></td></tr></table></div></div><h4 id=获取引导文件>获取引导文件</h4><p>在安装包下载目录创建一个shim文件夹</p><p>解压shim安装包到shim文件夹
<code>dpkg -x &lt;%刚才下载的shim.signed 安装包包名%> shim</code></p><p>解压grub安装包到grub文件夹</p><p>拷贝引导文件到tftp目录</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-awk data-lang=awk><span style=display:flex><span>cp .<span style=color:#000;font-weight:700>/</span>root<span style=color:#000;font-weight:700>/</span>grub<span style=color:#000;font-weight:700>/</span>usr<span style=color:#000;font-weight:700>/</span>lib<span style=color:#000;font-weight:700>/</span>grub<span style=color:#000;font-weight:700>/</span>x86_64<span style=color:#000;font-weight:700>-</span>efi<span style=color:#000;font-weight:700>-</span>signed<span style=color:#000;font-weight:700>/</span>grubnetx64.efi.signed  <span style=color:#000;font-weight:700>/</span>tftp<span style=color:#000;font-weight:700>/</span>grubx64.efi
</span></span><span style=display:flex><span>cp .<span style=color:#000;font-weight:700>/</span>root<span style=color:#000;font-weight:700>/</span>shim<span style=color:#000;font-weight:700>/</span>usr<span style=color:#000;font-weight:700>/</span>lib<span style=color:#000;font-weight:700>/</span>shim<span style=color:#000;font-weight:700>/</span>shimx64.efi.signed  <span style=color:#000;font-weight:700>/</span>tftp<span style=color:#000;font-weight:700>/</span>grub<span style=color:#000;font-weight:700>/</span>bootx64.efi
</span></span></code></pre></td></tr></table></div></div><h4 id=获取内核镜像文件>获取内核镜像文件</h4><p>在下载目录mount iso文件</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#000;font-weight:700>sudo</span> <span style=color:#d14>mount</span> <span style=color:#d14>ubuntu-20.04.3-live-server-amd64.iso</span> <span style=color:#d14>/media</span>
</span></span></code></pre></td></tr></table></div></div><p>系统会提示只读，不影响使用</p><pre tabindex=0><code class=language-pgsql data-lang=pgsql>mount: /media: WARNING: device write-protected, mounted read-only.
</code></pre><p>拷贝内核镜像文件</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-awk data-lang=awk><span style=display:flex><span>cp <span style=color:#000;font-weight:700>/</span>media<span style=color:#000;font-weight:700>/</span>casper<span style=color:#000;font-weight:700>/</span>initrd       <span style=color:#000;font-weight:700>/</span>tftp<span style=color:#000;font-weight:700>/</span>boot<span style=color:#000;font-weight:700>/</span>live<span style=color:#000;font-weight:700>-</span>server
</span></span><span style=display:flex><span>cp <span style=color:#000;font-weight:700>/</span>media<span style=color:#000;font-weight:700>/</span>casper<span style=color:#000;font-weight:700>/</span>vmlinuz      <span style=color:#000;font-weight:700>/</span>tftp<span style=color:#000;font-weight:700>/</span>boot<span style=color:#000;font-weight:700>/</span>live<span style=color:#000;font-weight:700>-</span>server
</span></span></code></pre></td></tr></table></div></div><p>拷贝grub文件
grub.cfg拷贝过来做个参考，内容会被全部修改掉</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-awk data-lang=awk><span style=display:flex><span>cp <span style=color:#000;font-weight:700>/</span>media<span style=color:#000;font-weight:700>/</span>grub<span style=color:#000;font-weight:700>/</span>font.pf2       <span style=color:#000;font-weight:700>/</span>tftp<span style=color:#000;font-weight:700>/</span>grub
</span></span><span style=display:flex><span>cp <span style=color:#000;font-weight:700>/</span>media<span style=color:#000;font-weight:700>/</span>grub<span style=color:#000;font-weight:700>/</span>grub.cfg       <span style=color:#000;font-weight:700>/</span>tftp<span style=color:#000;font-weight:700>/</span>grub
</span></span></code></pre></td></tr></table></div></div><h4 id=配置dnsmasq默认端口53udp>配置dnsmasq（默认端口53udp）</h4><p>tftp默认端口69</p><p>关键配置有以下几个</p><ol><li>配置DHCP 地址段</li><li>配置引导文件目录</li><li>配置tftp 根目录</li><li>配置日志路径</li><li>配置服务网卡，多网卡机器需关注</li></ol><pre tabindex=0><code class=language-routeros data-lang=routeros># 配置外网DNS服务器地址
server=10.4.7.254
# 指定服务的网卡
interface=ens33,lo
# 绑定端口
bind-interfaces
# 设置DHCP分发IP端范围、地址掩码、IP地址有效时间
dhcp-range=10.4.7.240,10.4.7.241,255.255.255.0,12h
# 指定网关地址   和安装无关，应该可以不配置
dhcp-option=3,10.4.7.254
# 指定DNS服务器地址  和安装无关，应该可以不配置
dhcp-option=6,10.4.7.254
# 设置引导程序相对tftp根目录的路径
dhcp-match=set:efi-x86_64,option:client-arch,7
dhcp-boot=tag:efi-x86_64,grub/bootx64.efi
# 打开tftp服务
enable-tftp
# 设置tftp根路径
tftp-root=/tftp
# 设置日志路径
log-facility=/var/log/dnsmasq.log
</code></pre><p>修改配置后，重启dnsmasq服务才能生效。</p><h4 id=创建http文件夹>创建HTTP文件夹</h4><p>apache2的默认服务根目录是 /var/www/html，不修改他，在他下面创建目录</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-haskell data-lang=haskell><span style=display:flex><span><span style=color:#900;font-weight:700>html</span><span style=color:#000;font-weight:700>/</span>
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>├──</span> autoinstall
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>│</span>   <span style=color:#a61717;background-color:#e3d2d2>├──</span> meta<span style=color:#000;font-weight:700>-</span><span style=color:#000;font-weight:700>data</span>
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>│</span>   <span style=color:#a61717;background-color:#e3d2d2>└──</span> user<span style=color:#000;font-weight:700>-</span><span style=color:#000;font-weight:700>data</span>
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>├──</span> index<span style=color:#000;font-weight:700>.</span>html
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>└──</span> iso
</span></span><span style=display:flex><span>    <span style=color:#a61717;background-color:#e3d2d2>└──</span> ubuntu<span style=color:#000;font-weight:700>-</span><span style=color:#099>20.04</span><span style=color:#000;font-weight:700>.</span><span style=color:#099>2</span><span style=color:#000;font-weight:700>-</span>live<span style=color:#000;font-weight:700>-</span>server<span style=color:#000;font-weight:700>-</span>amd64<span style=color:#000;font-weight:700>.</span>iso
</span></span></code></pre></td></tr></table></div></div><h4 id=说明-1>说明</h4><p>autoinstall 目录存放参数自动配置文件，user-data、meta-data是cloud-init要求的文件名</p><p>iso 目录存放操作系统镜像文件</p><h4 id=创建目录-1>创建目录</h4><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-awk data-lang=awk><span style=display:flex><span>mkdir <span style=color:#000;font-weight:700>/</span>var<span style=color:#000;font-weight:700>/</span>www<span style=color:#000;font-weight:700>/</span>html<span style=color:#000;font-weight:700>/</span>autoinstall
</span></span><span style=display:flex><span>mkdir <span style=color:#000;font-weight:700>/</span>var<span style=color:#000;font-weight:700>/</span>www<span style=color:#000;font-weight:700>/</span>html<span style=color:#000;font-weight:700>/</span>iso
</span></span></code></pre></td></tr></table></div></div><h4 id=拷贝iso文件>拷贝iso文件</h4><p>到下载目录拷贝iso文件
<code>cp ubuntu-20.04.3-live-server-amd64.iso /var/www/html/iso</code></p><h4 id=创建参数自动配置文件>创建参数自动配置文件</h4><p>先创建空文件，meta-data无需修改，user-data后续章节会详细描述配置</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-awk data-lang=awk><span style=display:flex><span>touch <span style=color:#000;font-weight:700>/</span>var<span style=color:#000;font-weight:700>/</span>www<span style=color:#000;font-weight:700>/</span>html<span style=color:#000;font-weight:700>/</span>autoinstall<span style=color:#000;font-weight:700>/</span>user<span style=color:#000;font-weight:700>-</span>data
</span></span><span style=display:flex><span>touch <span style=color:#000;font-weight:700>/</span>var<span style=color:#000;font-weight:700>/</span>www<span style=color:#000;font-weight:700>/</span>html<span style=color:#000;font-weight:700>/</span>autoinstall<span style=color:#000;font-weight:700>/</span>meta<span style=color:#000;font-weight:700>-</span>data
</span></span></code></pre></td></tr></table></div></div><h4 id=配置grubcfg>配置grub.cfg</h4><pre tabindex=0><code class=language-routeros data-lang=routeros>if loadfont /grub/font.pf2 ; then
        set gfxmode=auto
        insmod efi_gop
        insmod efi_uga
        insmod gfxterm
        terminal_output gfxterm
fi

set menu_color_normal=white/black
set menu_color_highlight=black/light-gray
set timeout=5

menuentry &#34;Ubuntu server 20.04.3 autoinstall&#34; {
        set gfxpayload=keep
        linux  /boot/live-server/vmlinuz root=/dev/ram0 ramdisk_size=1500000 ip=dhcp url=&#39;http://10.4.7.150/iso/ubuntu-20.04.3-live-server-amd64.iso&#39; autoinstall ds=nocloud-net\;s=http://10.4.7.150/autoinstall/ ---
        initrd /boot/live-server/initrd
}
</code></pre><p>menuentry 之前是配置样式，也可以删除，重点关注<code>menuentry "Ubuntu server 20.04 autoinstall"</code>
内的配置。</p><ol><li>指定镜像文件相对于tftp根目录的路径 /boot/live-server/initrd</li><li>root=/dev/ram0 ramdisk_size=1500000 为了指定内核镜像挂载空间，是否可删除待确认</li><li>ip=dhcp 指定内核镜像挂载后使用DHCP 获取IP地址</li><li>url= 指定ISO文件的网络存放路径</li><li><code>autoinstall ds=nocloud-net\;s=http://10.4.7.150/autoinstall/ </code>&mdash;该配置指明参数自动填写，并指明配置文件所在路径</li></ol><h4 id=坑>坑</h4><p>网上很多文章配置是这么写的<code>ds=nocloud-net;s=http://10.4.7.150/autoinstall/</code>，我试了很多次，都没有自动安装。
在网上查到，由于UEFI启动使用了grub，grub将<code>;</code>识别为了特殊字符，所以要在<code>;</code>前加<code>\</code>转义。</p><h4 id=配置user-data>配置user-data</h4><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#998;font-style:italic>#cloud-config</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:navy>autoinstall</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:navy>version</span>:<span style=color:#bbb> </span><span style=color:#099>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#998;font-style:italic># 修改apt服务地址</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:navy>apt</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:navy>primary</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:navy>arches</span>:<span style=color:#bbb> </span>[default]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:navy>uri</span>:<span style=color:#bbb> </span>https://mirrors.tuna.tsinghua.edu.cn/ubuntu<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:navy>user-data</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#998;font-style:italic># 配置时区</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:navy>timezone</span>:<span style=color:#bbb> </span>Asia/Shanghai<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#998;font-style:italic># 使用root账号</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:navy>disable_root</span>:<span style=color:#bbb> </span><span style=color:#000;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#998;font-style:italic># 配置用户  </span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:navy>identity</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:navy>hostname</span>:<span style=color:#bbb> </span>ubuntu-server<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:navy>password</span>:<span style=color:#bbb> </span><span style=color:#d14>&#34;yours&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:navy>username</span>:<span style=color:#bbb> </span>ubuntu<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#998;font-style:italic># 配置键盘  </span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:navy>keyboard</span>:<span style=color:#bbb> </span>{<span style=color:navy>layout: us, variant</span>:<span style=color:#bbb> </span><span style=color:#d14>&#39;us&#39;</span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:navy>locale</span>:<span style=color:#bbb> </span>en_US.UTF-8<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#998;font-style:italic># 默认安装ssh server</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:navy>ssh</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:navy>install-server</span>:<span style=color:#bbb> </span><span style=color:#000;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#998;font-style:italic># 指定安装的包</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:navy>packages</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- net-tools<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- python3-pip<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#998;font-style:italic># 配置磁盘分区</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:navy>storage</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:navy>grub</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:navy>reorder_uefi</span>:<span style=color:#bbb> </span><span style=color:#000;font-weight:700>False</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:navy>config</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- {<span style=color:navy>ptable: gpt, path: /dev/sda, wipe: superblock-recursive, preserve: false, name</span>:<span style=color:#bbb> </span><span style=color:#d14>&#39;&#39;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:navy>grub_device: false, type: disk, id</span>:<span style=color:#bbb> </span>disk-sda}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- {<span style=color:navy>device: disk-sda, size: 536870912, wipe: superblock, flag: boot, number</span>:<span style=color:#bbb> </span><span style=color:#099>1</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:navy>preserve: false, grub_device: true, type: partition, id</span>:<span style=color:#bbb> </span>partition-0}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- {<span style=color:navy>fstype: fat32, volume: partition-0, preserve: false, type: format, id</span>:<span style=color:#bbb> </span>format-0}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- {<span style=color:navy>device: disk-sda, size: -1, wipe: superblock, flag: &#39;&#39;, number</span>:<span style=color:#bbb> </span><span style=color:#099>2</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:navy>preserve: false, type: partition, id</span>:<span style=color:#bbb> </span>partition-1}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- {<span style=color:navy>fstype: ext4, volume: partition-1, preserve: false, type: format, id</span>:<span style=color:#bbb> </span>format-1}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- {<span style=color:navy>device: format-1, path: /, type: mount, id</span>:<span style=color:#bbb> </span>mount-1}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- {<span style=color:navy>device: format-0, path: /boot/efi, type: mount, id</span>:<span style=color:#bbb> </span>mount-0}<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><p>说明</p><ol><li>密码需要加密，可以先用工具对自己的密码进行加密后填入</li><li>代理不是必须的配置，与网络拓扑有关</li><li>磁盘分区配置要注意，配置不对会导致自动安装走不下去，提示crash；这个配置的整体思路是先格式化disk-sda，然后在disk-sda下划分/dev/sda1 、/dev/sda2 ，然后分别mount /,/boot/efi目录</li><li>安装过程日志在 /var/log/installer/，如果安装失败可以通过nc 等工具实时发出去</li></ol><h4 id=网络拓扑>网络拓扑</h4><ol><li>我在电脑上搭建了DHCP、TFTP、HTTP三种服务</li><li>目标机器不能上网，三台机器在同一个局域网</li></ol><p>dnsmasq.log</p><p><img src=/postimages/auto-install3.webp alt=无人值守3></p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Sep <span style=color:#099>21</span> 19:26:56 dnsmasq-dhcp<span style=color:#000;font-weight:700>[</span>1910<span style=color:#000;font-weight:700>]</span>: DHCP, IP range 10.4.7.240 -- 10.4.7.241, lease <span style=color:#0086b3>time</span> 12h
</span></span><span style=display:flex><span>Sep <span style=color:#099>21</span> 19:26:56 dnsmasq-dhcp<span style=color:#000;font-weight:700>[</span>1910<span style=color:#000;font-weight:700>]</span>: DHCP, sockets bound exclusively to interface ens33
</span></span><span style=display:flex><span>Sep <span style=color:#099>21</span> 19:26:56 dnsmasq-tftp<span style=color:#000;font-weight:700>[</span>1910<span style=color:#000;font-weight:700>]</span>: TFTP root is /tftp  
</span></span><span style=display:flex><span>Sep <span style=color:#099>21</span> 19:29:33 dnsmasq-tftp<span style=color:#000;font-weight:700>[</span>1910<span style=color:#000;font-weight:700>]</span>: failed sending /tftp/grubx64.efi to 10.4.7.140
</span></span><span style=display:flex><span>Sep <span style=color:#099>21</span> 19:35:37 dnsmasq-dhcp<span style=color:#000;font-weight:700>[</span>1910<span style=color:#000;font-weight:700>]</span>: DHCPDISCOVER<span style=color:#000;font-weight:700>(</span>ens33<span style=color:#000;font-weight:700>)</span> 00:0c:29:68:21:9a 
</span></span><span style=display:flex><span>Sep <span style=color:#099>21</span> 19:35:37 dnsmasq-dhcp<span style=color:#000;font-weight:700>[</span>1910<span style=color:#000;font-weight:700>]</span>: DHCPOFFER<span style=color:#000;font-weight:700>(</span>ens33<span style=color:#000;font-weight:700>)</span> 10.4.7.240 00:0c:29:68:21:9a 
</span></span><span style=display:flex><span>Sep <span style=color:#099>21</span> 19:35:38 dnsmasq-dhcp<span style=color:#000;font-weight:700>[</span>1910<span style=color:#000;font-weight:700>]</span>: DHCPREQUEST<span style=color:#000;font-weight:700>(</span>ens33<span style=color:#000;font-weight:700>)</span> 10.4.7.240 00:0c:29:68:21:9a 
</span></span><span style=display:flex><span>Sep <span style=color:#099>21</span> 19:35:38 dnsmasq-dhcp<span style=color:#000;font-weight:700>[</span>1910<span style=color:#000;font-weight:700>]</span>: DHCPACK<span style=color:#000;font-weight:700>(</span>ens33<span style=color:#000;font-weight:700>)</span> 10.4.7.240 00:0c:29:68:21:9a 
</span></span><span style=display:flex><span>Sep <span style=color:#099>21</span> 19:35:38 dnsmasq-tftp<span style=color:#000;font-weight:700>[</span>1910<span style=color:#000;font-weight:700>]</span>: error <span style=color:#099>8</span> User aborted the transfer received from 10.4.7.240
</span></span><span style=display:flex><span>Sep <span style=color:#099>21</span> 19:35:38 dnsmasq-tftp<span style=color:#000;font-weight:700>[</span>1910<span style=color:#000;font-weight:700>]</span>: sent /tftp/grub/bootx64.efi to 10.4.7.240
</span></span><span style=display:flex><span>Sep <span style=color:#099>21</span> 19:35:38 dnsmasq-tftp<span style=color:#000;font-weight:700>[</span>1910<span style=color:#000;font-weight:700>]</span>: sent /tftp/grub/bootx64.efi to 10.4.7.240
</span></span><span style=display:flex><span>Sep <span style=color:#099>21</span> 19:35:40 dnsmasq-tftp<span style=color:#000;font-weight:700>[</span>1910<span style=color:#000;font-weight:700>]</span>: sent /tftp/grubx64.efi to 10.4.7.240
</span></span><span style=display:flex><span>Sep <span style=color:#099>21</span> 19:35:40 dnsmasq-tftp<span style=color:#000;font-weight:700>[</span>1910<span style=color:#000;font-weight:700>]</span>: file /tftp/grub/x86_64-efi/command.lst not found
</span></span><span style=display:flex><span>Sep <span style=color:#099>21</span> 19:35:40 dnsmasq-tftp<span style=color:#000;font-weight:700>[</span>1910<span style=color:#000;font-weight:700>]</span>: file /tftp/grub/x86_64-efi/fs.lst not found
</span></span><span style=display:flex><span>Sep <span style=color:#099>21</span> 19:35:40 dnsmasq-tftp<span style=color:#000;font-weight:700>[</span>1910<span style=color:#000;font-weight:700>]</span>: file /tftp/grub/x86_64-efi/crypto.lst not found
</span></span><span style=display:flex><span>Sep <span style=color:#099>21</span> 19:35:40 dnsmasq-tftp<span style=color:#000;font-weight:700>[</span>1910<span style=color:#000;font-weight:700>]</span>: file /tftp/grub/x86_64-efi/terminal.lst not found
</span></span><span style=display:flex><span>Sep <span style=color:#099>21</span> 19:35:40 dnsmasq-tftp<span style=color:#000;font-weight:700>[</span>1910<span style=color:#000;font-weight:700>]</span>: sent /tftp/grub/grub.cfg to 10.4.7.240
</span></span><span style=display:flex><span>Sep <span style=color:#099>21</span> 19:35:40 dnsmasq-tftp<span style=color:#000;font-weight:700>[</span>1910<span style=color:#000;font-weight:700>]</span>: sent /tftp/grub/font.pf2 to 10.4.7.240
</span></span><span style=display:flex><span>Sep <span style=color:#099>21</span> 19:35:51 dnsmasq-tftp<span style=color:#000;font-weight:700>[</span>1910<span style=color:#000;font-weight:700>]</span>: sent /tftp/boot/live-server/vmlinuz to 10.4.7.240
</span></span></code></pre></td></tr></table></div></div><h3 id=四ubuntu-网络配置>四、Ubuntu 网络配置</h3><p>要快速识别所有可用的以太网接口，您可以使用如下所示的 ip 命令。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>root@lhp-server:/etc/netplan# ip a
</span></span><span style=display:flex><span>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span style=color:#099>65536</span> qdisc noqueue state UNKNOWN group default qlen <span style=color:#099>1000</span>
</span></span><span style=display:flex><span>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span></span><span style=display:flex><span>    inet 127.0.0.1/8 scope host lo
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span><span style=display:flex><span>    inet6 ::1/128 scope host 
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span><span style=display:flex><span>2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style=color:#099>1500</span> qdisc fq_codel state UP group default qlen <span style=color:#099>1000</span>
</span></span><span style=display:flex><span>    link/ether 00:0c:29:da:c6:09 brd ff:ff:ff:ff:ff:ff
</span></span><span style=display:flex><span>    inet 10.4.7.142/24 brd 10.4.7.255 scope global ens33
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span><span style=display:flex><span>    inet6 fe80::20c:29ff:feda:c609/64 scope link 
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span></code></pre></td></tr></table></div></div><p>另一个可以帮助识别系统可用的所有网络接口的应用程序是 lshw 命令。此命令提供有关特定适配器的硬件功能的更多详细信息。在下面的示例中，lshw 显示了一个具有<em>eth1</em>逻辑名称的以太网接口以及总线信息、驱动程序详细信息和所有支持的功能。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>root@lhp-server:/etc/netplan# lshw -class network
</span></span><span style=display:flex><span>  *-network                 
</span></span><span style=display:flex><span>       description: Ethernet interface
</span></span><span style=display:flex><span>       product: 82545EM Gigabit Ethernet Controller <span style=color:#000;font-weight:700>(</span>Copper<span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>       vendor: Intel Corporation
</span></span><span style=display:flex><span>       physical id: <span style=color:#099>1</span>
</span></span><span style=display:flex><span>       bus info: pci@0000:02:01.0
</span></span><span style=display:flex><span>       logical name: ens33
</span></span><span style=display:flex><span>       version: <span style=color:#099>01</span>
</span></span><span style=display:flex><span>       serial: 00:0c:29:da:c6:09
</span></span><span style=display:flex><span>       size: 1Gbit/s
</span></span><span style=display:flex><span>       capacity: 1Gbit/s
</span></span><span style=display:flex><span>       width: <span style=color:#099>64</span> bits
</span></span><span style=display:flex><span>       clock: 66MHz
</span></span><span style=display:flex><span>       capabilities: pm pcix bus_master cap_list rom ethernet physical logical tp 10bt 10bt-fd 100bt 100bt-fd 1000bt-fd autonegotiation
</span></span><span style=display:flex><span>       configuration: <span style=color:teal>autonegotiation</span><span style=color:#000;font-weight:700>=</span>on <span style=color:teal>broadcast</span><span style=color:#000;font-weight:700>=</span>yes <span style=color:teal>driver</span><span style=color:#000;font-weight:700>=</span>e1000 <span style=color:teal>driverversion</span><span style=color:#000;font-weight:700>=</span>7.3.21-k8-NAPI <span style=color:teal>duplex</span><span style=color:#000;font-weight:700>=</span>full <span style=color:teal>ip</span><span style=color:#000;font-weight:700>=</span>10.4.7.142 <span style=color:teal>latency</span><span style=color:#000;font-weight:700>=</span><span style=color:#099>0</span> <span style=color:teal>link</span><span style=color:#000;font-weight:700>=</span>yes <span style=color:teal>mingnt</span><span style=color:#000;font-weight:700>=</span><span style=color:#099>255</span> <span style=color:teal>multicast</span><span style=color:#000;font-weight:700>=</span>yes <span style=color:teal>port</span><span style=color:#000;font-weight:700>=</span>twisted pair <span style=color:teal>speed</span><span style=color:#000;font-weight:700>=</span>1Gbit/s
</span></span><span style=display:flex><span>       resources: irq:19 memory:fd5c0000-fd5dffff memory:fdff0000-fdffffff ioport:2000<span style=color:#000;font-weight:700>(</span><span style=color:teal>size</span><span style=color:#000;font-weight:700>=</span>64<span style=color:#000;font-weight:700>)</span> memory:fd500000-fd50ffff
</span></span></code></pre></td></tr></table></div></div><p>ethtool 是一个程序，用于显示和更改以太网卡设置，例如自动协商、端口速度、双工模式和 LAN 唤醒。以下是如何查看以太网接口支持的功能和配置设置的示例。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>root@lhp-server:/etc/netplan# ethtool ens33 
</span></span><span style=display:flex><span>Settings <span style=color:#000;font-weight:700>for</span> ens33:
</span></span><span style=display:flex><span>	Supported ports: <span style=color:#000;font-weight:700>[</span> TP <span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span>	Supported link modes:   10baseT/Half 10baseT/Full 
</span></span><span style=display:flex><span>	                        100baseT/Half 100baseT/Full 
</span></span><span style=display:flex><span>	                        1000baseT/Full 
</span></span><span style=display:flex><span>	Supported pause frame use: No
</span></span><span style=display:flex><span>	Supports auto-negotiation: Yes
</span></span><span style=display:flex><span>	Supported FEC modes: Not reported
</span></span><span style=display:flex><span>	Advertised link modes:  10baseT/Half 10baseT/Full 
</span></span><span style=display:flex><span>	                        100baseT/Half 100baseT/Full 
</span></span><span style=display:flex><span>	                        1000baseT/Full 
</span></span><span style=display:flex><span>	Advertised pause frame use: No
</span></span><span style=display:flex><span>	Advertised auto-negotiation: Yes
</span></span><span style=display:flex><span>	Advertised FEC modes: Not reported
</span></span><span style=display:flex><span>	Speed: 1000Mb/s
</span></span><span style=display:flex><span>	Duplex: Full
</span></span><span style=display:flex><span>	Port: Twisted Pair
</span></span><span style=display:flex><span>	PHYAD: <span style=color:#099>0</span>
</span></span><span style=display:flex><span>	Transceiver: internal
</span></span><span style=display:flex><span>	Auto-negotiation: on
</span></span><span style=display:flex><span>	MDI-X: off <span style=color:#000;font-weight:700>(</span>auto<span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>	Supports Wake-on: d
</span></span><span style=display:flex><span>	Wake-on: d
</span></span><span style=display:flex><span>	Current message level: 0x00000007 <span style=color:#000;font-weight:700>(</span>7<span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>			       drv probe link
</span></span><span style=display:flex><span>	Link detected: yes
</span></span></code></pre></td></tr></table></div></div><p>要临时配置 IP 地址，可以通过以下方式使用 ip 命令。修改 IP 地址和子网掩码以符合您的网络要求。ip 命令允许您配置立即生效的设置，但是它们不是持久的并且会在重新启动后丢失。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo ip addr add 10.102.66.200/24 dev ens33
</span></span></code></pre></td></tr></table></div></div><p>然后可以使用 ip 来设置链接的开启或关闭。</p><pre tabindex=0><code>ip link set dev ens33 up
ip link set dev ens33 down
</code></pre><p>验证enp0s25的IP地址配置，可以通过以下方式使用ip命令。</p><pre tabindex=0><code>ip address show dev enp0s25
10: enp0s25: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000
    link/ether 00:16:3e:e2:52:42 brd ff:ff:ff:ff:ff:ff link-netnsid 0
    inet 10.102.66.200/24 brd 10.102.66.255 scope global dynamic eth0
       valid_lft 2857sec preferred_lft 2857sec
    inet6 fe80::216:3eff:fee2:5242/64 scope link
       valid_lft forever preferred_lft forever6
</code></pre><p>要配置默认网关，您可以按以下方式使用 ip 命令。修改默认网关地址以符合您的网络要求。</p><pre tabindex=0><code>sudo ip route add default via 10.102.66.1
</code></pre><p>要验证您的默认网关配置，您可以按以下方式使用 ip 命令。</p><pre tabindex=0><code>ip route show
default via 10.102.66.1 dev eth0 proto dhcp src 10.102.66.200 metric 100
10.102.66.0/24 dev eth0 proto kernel scope link src 10.102.66.200
10.102.66.1 dev eth0 proto dhcp scope link src 10.102.66.200 metric 100 
</code></pre><p>如果您的临时网络配置需要 DNS，您可以在文件中添加 DNS 服务器 IP 地址<code>/etc/resolv.conf</code>。一般情况下，<code>/etc/resolv.conf</code>不建议直接编辑，但这是一种临时且非持久的配置。下面的示例显示了如何将两个 DNS 服务器输入到 中<code>/etc/resolv.conf</code>，应将其更改为适合您网络的服务器。以下部分详细介绍了进行 DNS 客户端配置的正确持久方式。</p><pre tabindex=0><code>nameserver 8.8.8.8
nameserver 8.8.4.4
</code></pre><p>如果您不再需要此配置并希望从接口中清除所有 IP 配置，您可以使用带有flush 选项的ip 命令，如下所示。</p><pre tabindex=0><code>ip addr flush eth0
</code></pre><blockquote><p><strong>笔记</strong></p><p>使用 ip 命令刷新 IP 配置不会清除<code>/etc/resolv.conf</code>. 您必须手动删除或修改这些条目，或者重新启动，这也应该导致<code>/etc/resolv.conf</code>，它是到 的符号链接<code>/run/systemd/resolve/stub-resolv.conf</code>，被重写。</p></blockquote><h4 id=动态-ip-地址分配dhcp-客户端>动态 IP 地址分配（DHCP 客户端）</h4><p>要将您的服务器配置为使用 DHCP 进行动态地址分配，请在文件<code>/etc/netplan/99_config.yaml</code>. 下面的示例假设您正在配置标识为<em>enp3s0 的</em>第一个以太网接口。</p><pre tabindex=0><code>network:
  version: 2
  renderer: networkd
  ethernets:
    enp3s0:
      dhcp4: true
</code></pre><p>然后可以使用 netplan 命令应用配置。</p><pre tabindex=0><code>sudo netplan apply
</code></pre><h4 id=静态-ip-地址分配>静态 IP 地址分配</h4><p>要将系统配置为使用静态地址分配，请在文件<code>/etc/netplan/99_config.yaml</code>. 下面的示例假设您正在配置标识为<em>eth0 的</em>第一个以太网接口。更改<em>address</em>、<em>gateway4</em>和<em>nameservers</em>值以满足您的网络要求。</p><pre tabindex=0><code>network:
  version: 2
  renderer: networkd
  ethernets:
    eth0:
      addresses:
        - 10.10.10.2/24
      gateway4: 10.10.10.1
      nameservers:
          search: [mydomain, otherdomain]
          addresses: [10.10.10.1, 1.1.1.1]
</code></pre><p>然后可以使用 netplan 命令应用配置。</p><pre tabindex=0><code>sudo netplan apply
</code></pre><p><strong>注：早期版本如：Ubuntu 18.04等等，它们的配置文件在/etc/network/interface文件中。</strong></p><p>网卡重启：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ip link <span style=color:#0086b3>set</span> ens33 down ip link <span style=color:#0086b3>set</span> ens33 up 
</span></span></code></pre></td></tr></table></div></div><h4 id=环回接口>环回接口</h4><p>环回接口由系统标识为<em>lo</em>，默认 IP 地址为 127.0.0.1。可以使用ip命令查看。</p><pre tabindex=0><code>ip address show lo
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
</code></pre><h4 id=名称解析>名称解析</h4><p>与 IP 网络相关的名称解析是将 IP 地址映射到主机名的过程，从而更容易识别网络上的资源。以下部分将解释如何正确配置系统以使用 DNS 和静态主机名记录进行名称解析。</p><h4 id=dns-客户端配置>DNS 客户端配置</h4><p>传统上，该文件<code>/etc/resolv.conf</code>是一个静态配置文件，很少需要更改或通过 DCHP 客户端挂钩自动更改。Systemd-resolved 处理名称服务器配置，它应该通过<code>systemd-resolve</code>命令进行交互。Netplan 配置 systemd-resolved 以生成要放入的名称服务器和域列表<code>/etc/resolv.conf</code>，这是一个符号链接：</p><pre tabindex=0><code>/etc/resolv.conf -&gt; ../run/systemd/resolve/stub-resolv.conf
</code></pre><p>要配置解析器，请将适合您网络的名称服务器的 IP 地址添加到 netplan 配置文件中。您还可以添加可选的 DNS 后缀搜索列表以匹配您的网络域名。生成的文件可能如下所示：</p><pre tabindex=0><code>network:
  version: 2
  renderer: networkd
  ethernets:
    enp0s25:
      addresses:
        - 192.168.0.100/24
      gateway4: 192.168.0.1
      nameservers:
          search: [mydomain, otherdomain]
          addresses: [1.1.1.1, 8.8.8.8, 4.4.4.4]
</code></pre><p>该搜索选项也可以用多个域名使用，使得DNS查询将按照它们的输入顺序追加。例如，您的网络可能有多个要搜索的子域的父域*<code>example.com</code><em>，和两个子域，</em><code>sales.example.com</code><em>以及</em><code>dev.example.com</code>*.</p><p>如果您有多个要搜索的域，您的配置可能如下所示：</p><pre tabindex=0><code>network:
  version: 2
  renderer: networkd
  ethernets:
    enp0s25:
      addresses:
        - 192.168.0.100/24
      gateway4: 192.168.0.1
      nameservers:
          search: [example.com, sales.example.com, dev.example.com]
          addresses: [1.1.1.1, 8.8.8.8, 4.4.4.4]
</code></pre><p>如果您尝试 ping 名为<em>server1</em>的主机，您的系统将按以下顺序自动查询 DNS 以获取其完全限定域名 (FQDN)：</p><ol><li><code>server1.example.com</code></li><li><code>server1.sales.example.com</code></li><li><code>server1.dev.example.com</code></li></ol><p>如果未找到匹配项，DNS 服务器将提供<em>notfound</em>结果并且 DNS 查询将失败。</p><h4 id=静态主机名>静态主机名</h4><p>静态主机名是位于文件中的本地定义的主机名到 IP 的映射<code>/etc/hosts</code>。<code>hosts</code>默认情况下，文件中的条目优先于 DNS。这意味着如果您的系统尝试解析主机名并且它与 /etc/hosts 中的条目匹配，则它不会尝试在 DNS 中查找记录。在某些配置中，尤其是当不需要访问 Internet 时，可以方便地将与有限数量资源通信的服务器设置为使用静态主机名而不是 DNS。</p><p>以下是一个<code>hosts</code>文件示例，其中通过简单的主机名、别名及其等效的完全限定域名 (FQDN) 标识了多个本地服务器。</p><pre tabindex=0><code>127.0.0.1   localhost
127.0.1.1   ubuntu-server
10.0.0.11   server1 server1.example.com vpn
10.0.0.12   server2 server2.example.com mail
10.0.0.13   server3 server3.example.com www
10.0.0.14   server4 server4.example.com file
</code></pre><blockquote><p><strong>笔记</strong></p><p>在上面的示例中，请注意，除了专有名称和 FQDN 之外，每个服务器还被赋予了别名。<em>Server1</em>已映射到名称<em>vpn</em>，<em>server2</em>称为<em>mail</em>，<em>server3</em>称为<em>www</em>，<em>server4</em>称为<em>file</em>。</p></blockquote><h4 id=名称服务交换机配置>名称服务交换机配置</h4><p>系统选择将主机名解析为 IP 地址的方法的顺序由名称服务交换机 (NSS) 配置文件控制<code>/etc/nsswitch.conf</code>。如上一节所述，通常在系统<code>/etc/hosts</code>文件中定义的静态主机名优先于从 DNS 解析的名称。以下是负责文件中主机名查找顺序的行的示例<code>/etc/nsswitch.conf</code>。</p><pre tabindex=0><code>hosts:          files mdns4_minimal [NOTFOUND=return] dns mdns4
</code></pre><ul><li><strong>文件</strong>首先尝试解析位于<code>/etc/hosts</code>.</li><li><strong>mdns4_minimal</strong>尝试使用多播 DNS 解析名称。</li><li>**[NOTFOUND =返回]**意味着任何响应<em>NOTFOUND</em>由前述<em>mdns4_minimal</em>过程应为权威并且该系统不应该试图继续狩猎的答案进行处理。</li><li><strong>dns</strong>代表传统的单播 DNS 查询。</li><li><strong>mdns4</strong>表示多播 DNS 查询。</li></ul><p>要修改上述名称解析方法的顺序，您可以简单地将*hosts:*字符串更改为您选择的值。例如，如果您更喜欢使用传统的单播 DNS 而不是多播 DNS，您可以更改字符串，<code>/etc/nsswitch.conf</code>如下所示。</p><pre tabindex=0><code>hosts: files dns [NOTFOUND=return] mdns4_minimal mdns4
</code></pre><h4 id=桥接>桥接</h4><p>桥接多个接口是一种更高级的配置，但在多个场景中非常有用。一种方案是建立具有多个网络接口的网桥，然后使用防火墙过滤两个网段之间的流量。另一种情况是在具有一个接口的系统上使用桥接器，以允许虚拟机直接访问外部网络。以下示例涵盖了后一种情况。</p><p>通过编辑您在<code>/etc/netplan/</code>以下位置找到的 netplan 配置来配置网桥：</p><pre tabindex=0><code>network:
  version: 2
  renderer: networkd
  ethernets:
    enp3s0:
      dhcp4: no
  bridges:
    br0:
      dhcp4: yes
      interfaces:
        - enp3s0
</code></pre><blockquote><p><strong>笔记</strong></p><p>为您的物理接口和网络输入适当的值。</p></blockquote><p>现在应用配置以启用网桥：</p><pre tabindex=0><code>sudo netplan apply
</code></pre><p>新的桥接接口现在应该已经启动并运行了。brctl 提供有关网桥状态的有用信息，控制哪些接口是网桥的一部分等。有关<code>man brctl</code>更多信息，请参见。</p><h4 id=dhcp>DHCP</h4><p>DHCP 服务器可以使用以下方法提供配置设置：</p><ul><li>手动分配（MAC 地址）
这种方法需要使用 DHCP 来识别连接到网络的每个网卡的唯一硬件地址，然后在每次 DHCP 客户端使用该网络设备向 DHCP 服务器发出请求时不断提供恒定配置。这可确保根据其 MAC 地址自动将特定地址分配给该网卡。</li><li>动态分配（地址池）
在这种方法中，DHCP 服务器将从地址池（有时也称为范围或范围）中分配一个 IP 地址，用于一段时间或租用，即在服务器上配置或直到客户端通知服务器它不再需要该地址。这样，客户端将在“先到先得”的基础上动态接收其配置属性。当 DHCP 客户端在指定时间段内不再位于网络上时，配置将过期并释放回地址池以供其他 DHCP 客户端使用。这样，一个地址可以被租用或使用一段时间。在此期间之后，客户端必须与服务器重新协商租用以维持地址的使用。</li><li>自动分配
使用这种方法，DHCP 会自动为设备永久分配一个 IP 地址，从可用地址池中选择它。通常 DHCP 用于为客户端分配临时地址，但 DHCP 服务器可以允许无限的租用时间。</li></ul><p>后两种方法可以被认为是“自动的”，因为在每种情况下，DHCP 服务器都会分配一个地址，而无需额外干预。它们之间的唯一区别在于 IP 地址的租用时间长短，换句话说，客户端的地址是否随时间变化。Ubuntu 提供的 DHCP 服务器是 dhcpd（动态主机配置协议守护进程），它易于安装和配置，并且会在系统启动时自动启动。</p><p>安装</p><p>在终端提示符下，输入以下命令来安装 dhcpd：</p><pre tabindex=0><code>sudo apt install isc-dhcp-server
</code></pre><p>注意：dhcpd 的消息正在发送到 syslog。在那里查找诊断消息。</p><p>配置</p><p>您可能需要通过编辑来更改默认配置<code>/etc/dhcp/dhcpd.conf</code>以满足您的需要和特定配置。</p><p>最常见的是，您想要做的是随机分配一个 IP 地址。这可以通过如下设置来完成：</p><pre tabindex=0><code># minimal sample /etc/dhcp/dhcpd.conf
default-lease-time 600;
max-lease-time 7200;
ddns-update-style none;

subnet 10.4.7.0 netmask 255.255.255.0 {
  range 10.4.7.220 10.4.7.230;
  option routers 10.4.7.254;
  option subnet-mask 255.255.255.0;
  option broadcast-address 10.4.7.255;
  option domain-name-servers 10.4.7.254;
  option ntp-servers 10.4.7.254;
  option netbios-name-servers 10.4.7.254;
  option netbios-node-type 8;
}
</code></pre><p>这将导致 DHCP 服务器为客户端提供一个范围为 10.4.7.220-10.4.7.230 的 IP 地址。如果客户端不要求特定的时间范围，它将租用一个 IP 地址 600 秒。否则最大（允许）租期将为 7200 秒。服务器还将“建议”客户端使用 10.4.7.254 作为默认网关，使用 10.4.7.254 作为其 DNS 服务器。使用10.4.7.254 作为ntp服务器。使用10.4.7.254作为局域网内部主机名对应的IP。</p><p>您可能还需要编辑<code>/etc/default/isc-dhcp-server</code>以指定 dhcpd 应侦听的接口。</p><pre tabindex=0><code>INTERFACESv4=&#34;eth4&#34;
</code></pre><p>更改配置文件后，您必须重新启动 dhcpd 服务：</p><pre tabindex=0><code>sudo systemctl restart isc-dhcp-server.service
</code></pre><h4 id=ntp>NTP</h4><p>NTP 是一种 TCP/IP 协议，用于通过网络同步时间。基本上，客户端从服务器请求当前时间，并使用它来设置自己的时钟。</p><p>在这个简单的描述背后，有很多复杂性——NTP 服务器有很多层，第一层 NTP 服务器连接到原子钟，而第二层和第三层服务器则通过 Internet 分散实际处理请求的负载。Ubuntu 默认使用<em>timedatectl / timesyncd</em>来同步时间，用户可以选择使用 chrony 来为网络时间协议提供服务。</p><p>同步时间</p><p>Ubuntu 16.04 <em>timedatectl / timesyncd</em>（它们是 systemd 的一部分）替换了大部分<em>ntpdate / ntp</em>。</p><p>默认情况下，timesyncd 是可用的，它不仅替换 ntpdate，而且替换 chrony（或以前的 ntpd）的客户端部分。因此，除了 ntpdate 在启动和网络激活时提供的一次性操作之外，现在默认情况下 timesyncd 会定期检查并保持本地时间同步。它还在本地存储时间更新，以便在重新启动后单调前进（如果适用）。</p><p>如果安装了 chrony，timedatectl 会退回让 chrony 进行计时。这将确保没有两个时间同步服务发生冲突。虽然不再推荐使用，但这仍然适用于安装 ntpd 以保留您通过升级获得的任何类型的旧行为/配置。但这也意味着在从以前的版本升级时可能仍会安装 ntp/ntpdate，因此会禁用新的基于 systemd 的服务。</p><p>ntpdate 被认为已弃用，取而代之的是 timedatectl（或 chrony），因此默认情况下不再安装。timesyncd 通常会做正确的事情，使您的时间保持同步，而 chrony 将帮助处理更复杂的情况。</p><p>需要一次性同步：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>chronyd -q
</span></span></code></pre></td></tr></table></div></div><p>需要一次性检查时间，而不设置时间:</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>chronyd -Q
</span></span></code></pre></td></tr></table></div></div><p>timesyncd 和chronyd 同时存在时，只有一个生效，如果chronyd正在运行，那么chronyd生效。</p><p>通过 timedatectl 和 timesyncd 可以检查时间和时间配置的当前状态<code>timedatectl status</code>。</p><pre tabindex=0><code class=language-auto data-lang=auto>$ timedatectl status
                       Local time: Fr 2018-02-23 08:47:13 UTC
                   Universal time: Fr 2018-02-23 08:47:13 UTC
                         RTC time: Fr 2018-02-23 08:47:13
                        Time zone: Etc/UTC (UTC, +0000)
        System clock synchronized: yes
 systemd-timesyncd.service active: yes
                  RTC in local TZ: no
</code></pre><p>如果 chrony 正在运行，它将自动切换到：</p><pre tabindex=0><code class=language-auto data-lang=auto>[...]
 systemd-timesyncd.service active: no 
</code></pre><p>通过 timedatectl 管理员可以控制时区、系统时钟应该如何与 hwclock 相关以及是否应该启用永久同步。有关<code>man timedatectl</code>更多详细信息，请参阅。</p><p>timesyncd 本身仍然是一个正常的服务，所以你也可以通过它更详细地检查它的状态。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>root@lhp-server:~# systemctl status systemd-timesyncd 
</span></span><span style=display:flex><span>● systemd-timesyncd.service
</span></span><span style=display:flex><span>     Loaded: masked <span style=color:#000;font-weight:700>(</span>Reason: Unit systemd-timesyncd.service is masked.<span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>     Active: inactive <span style=color:#000;font-weight:700>(</span>dead<span style=color:#000;font-weight:700>)</span> since Thu 2021-09-23 02:41:56 UTC; 35min ago
</span></span><span style=display:flex><span>   Main PID: <span style=color:#099>736</span> <span style=color:#000;font-weight:700>(</span><span style=color:teal>code</span><span style=color:#000;font-weight:700>=</span>exited, <span style=color:teal>status</span><span style=color:#000;font-weight:700>=</span>0/SUCCESS<span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>     Status: <span style=color:#d14>&#34;Shutting down...&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Sep <span style=color:#099>23</span> 01:53:57 lhp-server systemd<span style=color:#000;font-weight:700>[</span>1<span style=color:#000;font-weight:700>]</span>: Starting Network Time Synchronization...
</span></span><span style=display:flex><span>Sep <span style=color:#099>23</span> 01:53:57 lhp-server systemd<span style=color:#000;font-weight:700>[</span>1<span style=color:#000;font-weight:700>]</span>: Started Network Time Synchronization.
</span></span><span style=display:flex><span>Sep <span style=color:#099>23</span> 01:54:05 lhp-server systemd-timesyncd<span style=color:#000;font-weight:700>[</span>736<span style=color:#000;font-weight:700>]</span>: Network configuration changed, trying to establish connection.
</span></span><span style=display:flex><span>Sep <span style=color:#099>23</span> 01:54:06 lhp-server systemd-timesyncd<span style=color:#000;font-weight:700>[</span>736<span style=color:#000;font-weight:700>]</span>: Network configuration changed, trying to establish connection.
</span></span><span style=display:flex><span>Sep <span style=color:#099>23</span> 01:54:39 lhp-server systemd-timesyncd<span style=color:#000;font-weight:700>[</span>736<span style=color:#000;font-weight:700>]</span>: Initial synchronization to <span style=color:#0086b3>time</span> server 91.189.89.199:123 <span style=color:#000;font-weight:700>(</span>ntp.ubuntu.com<span style=color:#000;font-weight:700>)</span>.
</span></span><span style=display:flex><span>Sep <span style=color:#099>23</span> 02:41:56 lhp-server systemd<span style=color:#000;font-weight:700>[</span>1<span style=color:#000;font-weight:700>]</span>: Stopping Network Time Synchronization...
</span></span><span style=display:flex><span>Sep <span style=color:#099>23</span> 02:41:56 lhp-server systemd<span style=color:#000;font-weight:700>[</span>1<span style=color:#000;font-weight:700>]</span>: systemd-timesyncd.service: Succeeded.
</span></span><span style=display:flex><span>Sep <span style=color:#099>23</span> 02:41:56 lhp-server systemd<span style=color:#000;font-weight:700>[</span>1<span style=color:#000;font-weight:700>]</span>: Stopped Network Time Synchronization.
</span></span></code></pre></td></tr></table></div></div><p>可以从这两个配置文件中获取到根域名服务器的时间：/etc/systemd/timesyncd.conf和/etc/systemd/timesyncd.conf.d/，更多信息可以查看man timesyncd.conf。</p><h4 id=chrony>Chrony</h4><p>安装</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo apt install chrony
</span></span></code></pre></td></tr></table></div></div><p>这将提供两个二进制文件：</p><ul><li>chronyd - 通过 NTP 协议同步和服务的实际守护进程</li><li>chronyc - chrony 守护进程的命令行界面</li></ul><p>配置：</p><p>编辑<code>/etc/chrony/chrony.conf</code>以添加/删除服务器行。默认情况下，这些服务器配置为：</p><pre tabindex=0><code># Use servers from the NTP Pool Project. Approved by Ubuntu Technical Board
# on 2011-02-08 (LP: #104525). See http://www.pool.ntp.org/join.html for
# more information.
pool 0.ubuntu.pool.ntp.org iburst
pool 1.ubuntu.pool.ntp.org iburst
pool 2.ubuntu.pool.ntp.org iburst
pool 3.ubuntu.pool.ntp.org iburst
</code></pre><p>有关<code>man chrony.conf</code>配置选项的更多详细信息，请参阅。更改任何配置文件后，您必须重新启动chrony：</p><pre tabindex=0><code>sudo systemctl restart chrony.service
</code></pre><p>如果需要，<code>pool 2.ubuntu.pool.ntp.org</code>以及<code>ntp.ubuntu.com</code>还支持 ipv6。如果需要强制使用 ipv6 <code>ipv6.ntp.ubuntu.com</code>，默认情况下也没有配置。</p><p>查看状态</p><p>使用 chronyc 查看查询 chrony 守护进程的状态。例如，获取当前可用和选定时间源的概览.</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>root@lhp-server:~# chronyc sources <span style=color:#099>210</span> Number of <span style=color:teal>sources</span> <span style=color:#000;font-weight:700>=</span> 8MS Name/IP address         Stratum Poll Reach LastRx Last <span style=color:teal>sample</span>               <span style=color:#000;font-weight:700>===============================================================================</span>^- chilipepper.canonical.com     <span style=color:#099>2</span>   <span style=color:#099>6</span>   <span style=color:#099>377</span>    <span style=color:#099>43</span>  +8909us<span style=color:#000;font-weight:700>[</span>+8909us<span style=color:#000;font-weight:700>]</span> +/-  192ms^- alphyn.canonical.com          <span style=color:#099>2</span>   <span style=color:#099>7</span>   <span style=color:#099>175</span>   <span style=color:#099>108</span>    +15ms<span style=color:#000;font-weight:700>[</span>  +15ms<span style=color:#000;font-weight:700>]</span> +/-  167ms^- golem.canonical.com           <span style=color:#099>2</span>   <span style=color:#099>6</span>   <span style=color:#099>377</span>    <span style=color:#099>49</span>    +17ms<span style=color:#000;font-weight:700>[</span>  +17ms<span style=color:#000;font-weight:700>]</span> +/-  188ms^- pugot.canonical.com           <span style=color:#099>2</span>   <span style=color:#099>6</span>   <span style=color:#099>377</span>    <span style=color:#099>51</span>    +16ms<span style=color:#000;font-weight:700>[</span>  +16ms<span style=color:#000;font-weight:700>]</span> +/-  178ms^- 139.199.215.251               <span style=color:#099>2</span>   <span style=color:#099>6</span>   <span style=color:#099>377</span>    <span style=color:#099>53</span>  -1308us<span style=color:#000;font-weight:700>[</span>-1350us<span style=color:#000;font-weight:700>]</span> +/-   32ms^* 202.118.1.130                 <span style=color:#099>1</span>   <span style=color:#099>6</span>   <span style=color:#099>377</span>    <span style=color:#099>53</span>   -113us<span style=color:#000;font-weight:700>[</span> -155us<span style=color:#000;font-weight:700>]</span> +/- 8565us^- tock.ntp.infomaniak.ch        <span style=color:#099>1</span>   <span style=color:#099>6</span>   <span style=color:#099>377</span>    <span style=color:#099>49</span>    +36ms<span style=color:#000;font-weight:700>[</span>  +36ms<span style=color:#000;font-weight:700>]</span> +/-  118ms^- 111.230.189.174               <span style=color:#099>2</span>   <span style=color:#099>7</span>   <span style=color:#099>237</span>    <span style=color:#099>54</span>  -2129us<span style=color:#000;font-weight:700>[</span>-2171us<span style=color:#000;font-weight:700>]</span> +/-   27ms
</span></span></code></pre></td></tr></table></div></div><p>某些 chronyc 命令是特权命令，未经明确允许无法通过网络运行。见<em>指挥和监控访问</em>中<code>man chrony.conf</code>了解更多详情。本地管理员通常可以使用 sudo ，因为这将授予他访问本地管理员套接字的权限<code>/var/run/chrony/chronyd.sock</code>。</p><h3 id=五安全>五、安全</h3><h4 id=用户管理>用户管理</h4><p>root用户默认禁止访问。</p><p>鼓励用户使用名为“sudo”的工具来执行系统管理职责。Sudo 允许授权用户使用他们自己的密码临时提升他们的权限，而不必知道属于 root 帐户的密码。这种简单而有效的方法为所有用户操作提供了问责制，并使管理员可以精细控制用户可以使用所述权限执行哪些操作。</p><p>启用root用户并设置新密码：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo passwd
</span></span></code></pre></td></tr></table></div></div><p>Sudo 将提示您输入密码，然后要求您为 root 提供一个新密码，如下所示：</p><pre tabindex=0><code>[sudo] password for username: (enter your own password)
Enter new UNIX password: (enter a new password for root)
Retype new UNIX password: (repeat new password for root)
passwd: password updated successfully
</code></pre><p>禁用 root 帐户密码</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo passwd -l root
</span></span></code></pre></td></tr></table></div></div><p>更多sudo</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>man sudo 
</span></span></code></pre></td></tr></table></div></div><p>添加和删除用户</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo adduser username
</span></span></code></pre></td></tr></table></div></div><p>删除用户帐户及其主要组，请使用以下语法：</p><pre tabindex=0><code>sudo deluser username
</code></pre><ul><li><p>删除帐户不会删除其各自的主文件夹。您是否希望手动删除文件夹或根据所需的保留策略保留它取决于您。</p><p>请记住，如果您没有采取必要的预防措施，任何后来添加的与前一个所有者具有相同 UID/GID 的用户现在都可以访问此文件夹。</p><p>您可能希望将这些 UID/GID 值更改为更合适的值，例如 root 帐户，甚至可能重新定位文件夹以避免将来发生冲突：</p><pre tabindex=0><code>sudo chown -R root:root /home/username/
sudo mkdir /home/archived_users/
sudo mv /home/username /home/archived_users/
</code></pre></li><li><p>要临时锁定或解锁用户密码，请分别使用以下语法：</p><pre tabindex=0><code>sudo passwd -l username
sudo passwd -u username
</code></pre></li><li><p>要添加或删除个性化组，请分别使用以下语法：</p><pre tabindex=0><code>sudo addgroup groupname
sudo delgroup groupname
</code></pre></li><li><p>要将用户添加到组，请使用以下语法：</p><pre tabindex=0><code>sudo adduser username groupname
</code></pre></li></ul><h4 id=用户配置文件安全>用户配置文件安全</h4><p>创建新用户时， adduser 实用程序会创建一个名为 的全新主目录<code>/home/username</code>。默认配置文件以 目录中的内容为模型<code>/etc/skel</code>，其中包括所有配置文件基础。</p><p>如果您的服务器将有多个用户使用，则应密切注意用户主目录的权限以确保机密性。默认情况下，Ubuntu 中的用户主目录是使用全局读取/执行权限创建的。这意味着所有用户都可以浏览和访问其他用户主目录的内容。这可能不适合您的环境。</p><ul><li><p>要验证您当前的用户主目录权限，请使用以下语法：</p><pre tabindex=0><code>ls -ld /home/username
</code></pre><p>以下输出显示该目录<code>/home/username</code>具有全球可读的权限：</p><pre tabindex=0><code>drwxr-xr-x  2 username username    4096 2007-10-02 20:03 username
</code></pre></li><li><p>您可以使用以下语法删除世界可读权限：</p><pre tabindex=0><code>sudo chmod 0750 /home/username
</code></pre><blockquote><p><strong>笔记</strong></p><p>有些人倾向于不加选择地使用递归选项 (-R) 来修改所有子文件夹和文件，但这不是必需的，并且可能会产生其他不良结果。仅父目录就足以防止未经授权访问父目录下的任何内容。</p></blockquote><p>一个更有效的方法是在创建用户主文件夹时修改 adduser 全局默认权限。只需编辑文件<code>/etc/adduser.conf</code>并将<code>DIR_MODE</code>变量修改为适当的内容，以便所有新的主目录都将获得正确的权限。</p><pre tabindex=0><code>DIR_MODE=0750
</code></pre></li><li><p>使用前面提到的任何技术更正目录权限后，使用以下语法验证结果：</p><pre tabindex=0><code>ls -ld /home/username
</code></pre><p>下面的结果表明，世界可读的权限已被删除：</p><pre tabindex=0><code>drwxr-x---   2 username username    4096 2007-10-02 20:03 username
</code></pre></li></ul><h4 id=密码策略>密码策略</h4><p>最小长度密码</p><p>默认情况下，Ubuntu 需要最少 6 个字符的密码长度，以及一些基本的熵检查。这些值在文件 中控制，<code>/etc/pam.d/common-password</code>概述如下。</p><pre tabindex=0><code>password        [success=1 default=ignore]      pam_unix.so obscure sha512
</code></pre><p>如果要将最小长度调整为 8 个字符，请将适当的变量更改为 min=8。修改概述如下。</p><pre tabindex=0><code>password        [success=1 default=ignore]      pam_unix.so obscure sha512 minlen=8
</code></pre><blockquote><p><strong>笔记</strong></p><p>基本密码熵检查和最小长度规则不适用于使用 sudo 级别命令设置新用户的管理员。</p></blockquote><p>密码过期</p><p>创建用户帐户时，您应该制定一项策略，设置最短和最长密码期限，迫使用户在密码到期时更改密码。</p><ul><li><p>要轻松查看用户帐户的当前状态，请使用以下语法：</p><pre tabindex=0><code>sudo chage -l username
</code></pre><p>下面的输出显示了有关用户帐户的有趣事实，即没有应用任何策略：</p><pre tabindex=0><code>Last password change                                    : Jan 20, 2015
Password expires                                        : never
Password inactive                                       : never
Account expires                                         : never
Minimum number of days between password change          : 0
Maximum number of days between password change          : 99999
Number of days of warning before password expires       : 7
</code></pre></li><li><p>要设置这些值中的任何一个，只需使用以下语法，并按照交互式提示进行操作：</p><pre tabindex=0><code>sudo chage username
</code></pre><p>下面也是一个示例，说明如何手动将显式到期日期 (-E) 更改为 01/31/2015、最短密码期限 (-m) 为 5 天、最长密码期限 (-M) 为 90 天、不活动密码到期后 30 天的时间段 (-I)，以及密码到期前 14 天的警告时间段 (-W)：</p><pre tabindex=0><code>sudo chage -E 01/31/2015 -m 5 -M 90 -I 30 -W 14 username
</code></pre></li><li><p>要验证更改，请使用与前面提到的相同的语法：</p><pre tabindex=0><code>sudo chage -l username
</code></pre><p>下面的输出显示了为账户建立的新策略：</p><pre tabindex=0><code>Last password change                                    : Jan 20, 2015
Password expires                                        : Apr 19, 2015
Password inactive                                       : May 19, 2015
Account expires                                         : Jan 31, 2015
Minimum number of days between password change          : 5
Maximum number of days between password change          : 90
Number of days of warning before password expires       : 14
</code></pre></li></ul><p>对于被禁用的用户ssh的访问</p><p>如果用户之前已经设置了 SSH 公钥身份验证，则简单地禁用/锁定用户密码不会阻止用户远程登录您的服务器。他们仍然能够获得对服务器的 shell 访问，而无需任何密码。请记住检查用户主目录中是否有允许此类经过身份验证的 SSH 访问的文件，例如<code>/home/username/.ssh/authorized_keys</code>.</p><p>删除或重命名<code>.ssh/</code>用户主文件夹中的目录，以防止进一步的 SSH 身份验证功能。</p><p>请务必检查禁用用户建立的任何 SSH 连接，因为他们可能已经存在入站或出站连接。杀死任何找到的人。</p><pre tabindex=0><code>who | grep username  (to get the pts/# terminal)
sudo pkill -f pts/#
</code></pre><p>将 SSH 访问限制为只有应该拥有它的用户帐户。例如，您可以创建一个名为“sshlogin”的组，并将组名添加为与<code>AllowGroups</code>文件中的变量关联的值<code>/etc/ssh/sshd_config</code>。</p><pre tabindex=0><code>AllowGroups sshlogin
</code></pre><p>然后将您允许的 SSH 用户添加到“sshlogin”组中，并重新启动 SSH 服务。</p><pre tabindex=0><code>sudo adduser username sshlogin
sudo systemctl restart sshd.service
</code></pre><p>查看登录日志</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>tail -f /var/log/auth.log
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Sep <span style=color:#099>23</span> 07:32:58 lhp-server sshd<span style=color:#000;font-weight:700>[</span>5801<span style=color:#000;font-weight:700>]</span>: User <span style=color:#0086b3>test</span> from 10.4.7.1 not allowed because none of user<span style=color:#a61717;background-color:#e3d2d2>&#39;</span>s groups are listed in AllowGroups
</span></span><span style=display:flex><span>Sep <span style=color:#099>23</span> 07:33:01 lhp-server sshd<span style=color:#000;font-weight:700>[</span>5801<span style=color:#000;font-weight:700>]</span>: pam_unix<span style=color:#000;font-weight:700>(</span>sshd:auth<span style=color:#000;font-weight:700>)</span>: authentication failure; <span style=color:teal>logname</span><span style=color:#000;font-weight:700>=</span> <span style=color:teal>uid</span><span style=color:#000;font-weight:700>=</span><span style=color:#099>0</span> <span style=color:teal>euid</span><span style=color:#000;font-weight:700>=</span><span style=color:#099>0</span> <span style=color:teal>tty</span><span style=color:#000;font-weight:700>=</span>ssh <span style=color:teal>ruser</span><span style=color:#000;font-weight:700>=</span> <span style=color:teal>rhost</span><span style=color:#000;font-weight:700>=</span>10.4.7.1  <span style=color:teal>user</span><span style=color:#000;font-weight:700>=</span><span style=color:#0086b3>test</span>
</span></span><span style=display:flex><span>Sep <span style=color:#099>23</span> 07:33:03 lhp-server sshd<span style=color:#000;font-weight:700>[</span>5801<span style=color:#000;font-weight:700>]</span>: Failed password <span style=color:#000;font-weight:700>for</span> invalid user <span style=color:#0086b3>test</span> from 10.4.7.1 port <span style=color:#099>1047</span> ssh2
</span></span><span style=display:flex><span>Sep <span style=color:#099>23</span> 07:33:07 lhp-server sshd<span style=color:#000;font-weight:700>[</span>5801<span style=color:#000;font-weight:700>]</span>: error: Received disconnect from 10.4.7.1 port 1047:0:  <span style=color:#000;font-weight:700>[</span>preauth<span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span>Sep <span style=color:#099>23</span> 07:33:07 lhp-server sshd<span style=color:#000;font-weight:700>[</span>5801<span style=color:#000;font-weight:700>]</span>: Disconnected from invalid user <span style=color:#0086b3>test</span> 10.4.7.1 port <span style=color:#099>1047</span> <span style=color:#000;font-weight:700>[</span>preauth<span style=color:#000;font-weight:700>]</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=六防火墙>六、防火墙</h3><p><strong>ufw</strong></p><p>Ubuntu 的默认防火墙配置工具是 ufw。为简化 iptables 防火墙配置而开发，ufw 提供了一种用户友好的方式来创建基于 IPv4 或 IPv6 的基于主机的防火墙。</p><h4 id=启用><strong>启用</strong></h4><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo ufw <span style=color:#0086b3>enable</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=添加端口本例中为-ssh>添加端口（本例中为 SSH）</h4><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo ufw allow <span style=color:#099>22</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=使用编号格式添加>使用编号格式添加</h4><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo ufw insert <span style=color:#099>1</span> allow <span style=color:#099>80</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=关闭要打开的端口>关闭要打开的端口</h4><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo ufw deny <span style=color:#099>22</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=要删除规则请使用-delete-后跟规则>要删除规则，请使用 delete 后跟规则</h4><pre tabindex=0><code>sudo ufw delete deny 22
</code></pre><p>还可以允许从特定主机或网络访问某个端口。以下示例允许从主机 192.168.0.2 SSH 访问此主机上的任何 IP 地址：</p><pre tabindex=0><code>sudo ufw allow proto tcp from 192.168.0.2 to any port 22
</code></pre><p>将 192.168.0.2 替换为 192.168.0.0/24 以允许从整个子网进行 SSH 访问。</p><ul><li><p>向<em>ufw</em>命令添加*–dry-run*选项将输出结果规则，但不会应用它们。例如，如果打开 HTTP 端口，将应用以下内容：</p><pre tabindex=0><code class=language-auto data-lang=auto> sudo ufw --dry-run allow http
</code></pre><pre tabindex=0><code>*filter
:ufw-user-input - [0:0]
:ufw-user-output - [0:0]
:ufw-user-forward - [0:0]
:ufw-user-limit - [0:0]
:ufw-user-limit-accept - [0:0]
### RULES ###

### tuple ### allow tcp 80 0.0.0.0/0 any 0.0.0.0/0
-A ufw-user-input -p tcp --dport 80 -j ACCEPT

### END RULES ###
-A ufw-user-input -j RETURN
-A ufw-user-output -j RETURN
-A ufw-user-forward -j RETURN
-A ufw-user-limit -m limit --limit 3/minute -j LOG --log-prefix &#34;[UFW LIMIT]: &#34;
-A ufw-user-limit -j REJECT
-A ufw-user-limit-accept -j ACCEPT
COMMIT
Rules updated
</code></pre></li><li><p>可以通过以下方式禁用 ufw：</p><pre tabindex=0><code>sudo ufw disable
</code></pre></li><li><p>要查看防火墙状态，请输入：</p><pre tabindex=0><code>sudo ufw status
</code></pre></li><li><p>对于更详细的状态信息，请使用：</p><pre tabindex=0><code>sudo ufw status verbose
</code></pre></li><li><p>查看编号格式：</p><pre tabindex=0><code>sudo ufw status numbered
</code></pre></li></ul><blockquote><p><strong>笔记</strong></p><p>如果要打开或关闭<code>/etc/services</code>的端口在 中定义，则可以使用端口名称而不是编号。在上面的示例中，将<em>22</em>替换为<em>ssh</em>。</p></blockquote><p>更多详细参数见：man ufw手册</p><h4 id=ufw-应用集成><strong>ufw 应用集成</strong></h4><p>打开端口的应用程序可以包含一个 ufw 配置文件，其中详细说明了应用程序正常运行所需的端口。配置文件保存在 中<code>/etc/ufw/applications.d</code>，如果默认端口已更改，则可以对其进行编辑。</p><ul><li><p>要查看哪些应用程序安装了配置文件，请在终端中输入以下内容：</p><pre tabindex=0><code>sudo ufw app list
</code></pre></li><li><p>类似于允许流量到端口，使用应用程序配置文件是通过输入：</p><pre tabindex=0><code>sudo ufw allow Samba
</code></pre></li><li><p>扩展语法也可用：</p><pre tabindex=0><code>ufw allow from 192.168.0.0/24 to any app Samba
</code></pre><p>将<em>Samba</em>和<em>192.168.0.0/24</em>替换为您正在使用的应用程序配置文件以及您网络的 IP 范围。</p><blockquote><p><strong>笔记</strong></p><p>无需为应用程序指定<em>协议</em>，因为该信息在配置文件中有详细说明。另请注意，<em>应用程序</em>名称替换了<em>端口</em>号。</p></blockquote></li><li><p>要查看有关为应用程序定义的端口、协议等的详细信息，请输入：</p><pre tabindex=0><code>sudo ufw app info Samba
</code></pre></li></ul><h4 id=ip伪装>IP伪装</h4><p>IP 伪装的目的是允许网络上具有私有、不可路由 IP 地址的机器通过执行伪装的机器访问 Internet。必须对来自您的专用网络的发往 Internet 的流量进行处理，以便回复可路由回发出请求的机器。为此，内核必须修改每个数据包的<em>源</em>IP 地址，以便将回复路由回它，而不是发送到发出请求的私有 IP 地址，这在 Internet 上是不可能的。Linux 使用<em>连接跟踪</em>(conntrack) 跟踪哪些连接属于哪些机器并相应地重新路由每个返回数据包。因此，离开您的专用网络的流量被“伪装”为源自您的 Ubuntu 网关机器。此过程在 Microsoft 文档中称为 Internet 连接共享。</p><h4 id=ufw-伪装>ufw 伪装</h4><p>可以使用自定义 ufw 规则来实现 IP 伪装。这是可能的，因为 ufw 的当前后端是 iptables-restore，规则文件位于<code>/etc/ufw/*.rules</code>. 这些文件是添加不使用 ufw 使用的遗留 iptables 规则的好地方，以及与网关或网桥相关的规则。</p><p>规则分为两个不同的文件，应该在ufw命令行规则之前执行的规则，以及在ufw命令行规则之后执行的规则。</p><ul><li><p>首先需要在ufw中开启数据包转发。需要调整两个配置文件，将<em>DEFAULT_FORWARD_POLICY</em><code>/etc/default/ufw</code>更改为“ACCEPT”：</p><pre tabindex=0><code>DEFAULT_FORWARD_POLICY=&#34;ACCEPT&#34;
</code></pre><p>然后编辑<code>/etc/ufw/sysctl.conf</code>并取消注释：</p><pre tabindex=0><code>net/ipv4/ip_forward=1
</code></pre><p>同样，对于 IPv6 转发取消注释：</p><pre tabindex=0><code>net/ipv6/conf/default/forwarding=1
</code></pre></li><li><p>现在将规则添加到<code>/etc/ufw/before.rules</code>文件中。默认规则只配置<em>过滤</em>表，并且启用伪装<em>nat</em>表需要配置。将以下内容添加到文件顶部的标题注释之后：</p><pre tabindex=0><code># nat Table rules
*nat
:POSTROUTING ACCEPT [0:0]

# Forward traffic from eth1 through eth0.
-A POSTROUTING -s 192.168.0.0/24 -o eth0 -j MASQUERADE

# don&#39;t delete the &#39;COMMIT&#39; line or these nat table rules won&#39;t be processed
COMMIT
</code></pre><p>注释不是绝对必要的，但记录您的配置被认为是一种很好的做法。此外，在修改 中的任何<em>规则</em>文件时<code>/etc/ufw</code>，请确保这些行是每个修改表的最后一行：</p><pre tabindex=0><code># don&#39;t delete the &#39;COMMIT&#39; line or these rules won&#39;t be processed
COMMIT
</code></pre><p>对于每个<em>表，<em>都需要一个相应的</em>COMMIT</em>语句。在这些示例中，只显示了<em>nat</em>和<em>filter</em>表，但您也可以为<em>raw</em>和<em>mangle</em>表添加规则。</p><blockquote><p><strong>笔记</strong></p><p>在上面的示例中，将<em>eth0</em>、<em>eth1</em>和<em>192.168.0.0/24</em>替换为适合您网络的接口和 IP 范围。</p></blockquote></li><li><p>最后，禁用并重新启用 ufw 以应用更改：</p><pre tabindex=0><code>sudo ufw disable &amp;&amp; sudo ufw enable
</code></pre></li></ul><p>现在应该启用 IP 伪装。您还可以将任何其他 FORWARD 规则添加到<code>/etc/ufw/before.rules</code>. 建议将这些附加规则添加到<code>ufw-before-forward</code>链中。</p><h4 id=iptables-伪装>iptables 伪装</h4><p>iptables 也可用于启用伪装。</p><ul><li><p>与 ufw 类似，第一步是通过编辑<code>/etc/sysctl.conf</code>并取消注释以下行来启用 IPv4 数据包转发：</p><pre tabindex=0><code>net.ipv4.ip_forward=1
</code></pre><p>如果您希望启用 IPv6 转发也取消注释：</p><pre tabindex=0><code>net.ipv6.conf.default.forwarding=1
</code></pre></li><li><p>接下来，执行 sysctl 命令以启用配置文件中的新设置：</p><pre tabindex=0><code>sudo sysctl -p
</code></pre></li><li><p>现在可以使用单个 iptables 规则完成 IP 伪装，根据您的网络配置，该规则可能略有不同：</p><pre tabindex=0><code>sudo iptables -t nat -A POSTROUTING -s 192.168.0.0/16 -o ppp0 -j MASQUERADE
</code></pre><p>上述命令假设您的私有地址空间是 192.168.0.0/16，并且您的面向 Internet 的设备是 ppp0。语法分解如下：</p><ul><li>-t nat – 规则是进入 nat 表</li><li>-A POSTROUTING – 规则将被附加 (-A) 到 POSTROUTING 链</li><li>-s 192.168.0.0/16 – 该规则适用于源自指定地址空间的流量</li><li>-o ppp0 – 该规则适用于计划通过指定网络设备路由的流量</li><li>-j MASQUERADE - 与此规则匹配的流量将“跳转”（-j）到要操作的 MASQUERADE 目标，如上所述</li></ul></li><li><p>此外，过滤器表中的每个链（默认表，以及大多数或所有数据包过滤发生的地方）都有一个默认<em>策略</em>ACCEPT，但如果除了网关设备之外，您还创建了防火墙，您可能已将策略设置为DROP 或 REJECT，在这种情况下，您的伪装流量需要通过 FORWARD 链允许才能使上述规则起作用：</p><pre tabindex=0><code>sudo iptables -A FORWARD -s 192.168.0.0/16 -o ppp0 -j ACCEPT
sudo iptables -A FORWARD -d 192.168.0.0/16 -m state \
--state ESTABLISHED,RELATED -i ppp0 -j ACCEPT
</code></pre><p>上述命令将允许从本地网络到 Internet 的所有连接以及与这些连接相关的所有流量返回到启动它们的机器。</p></li><li><p>如果您希望在重新启动时启用伪装（您可能会这样做），请编辑<code>/etc/rc.local</code>并添加上面使用的任何命令。例如添加第一个没有过滤的命令：</p><pre tabindex=0><code>iptables -t nat -A POSTROUTING -s 192.168.0.0/16 -o ppp0 -j MASQUERADE
</code></pre></li></ul><h3 id=七日志>七、日志</h3><p>防火墙日志对于识别攻击、排除防火墙规则故障以及注意网络上的异常活动至关重要。但是，您必须在防火墙中包含日志规则才能生成它们，并且日志规则必须出现在任何适用的终止规则（具有决定数据包命运的目标的规则，例如 ACCEPT、DROP 或 REJECT）之前。</p><p>如果您使用的是 ufw，则可以通过在终端中输入以下内容来打开日志记录：</p><pre tabindex=0><code>sudo ufw logging on
</code></pre><p>要在 ufw 中关闭注销，只需在上述命令中将<em>on</em>替换为<em>off</em>。</p><p>如果使用 iptables 而不是 ufw，请输入：</p><pre tabindex=0><code>sudo iptables -A INPUT -m state --state NEW -p tcp --dport 80 \ 
-j LOG --log-prefix &#34;NEW_HTTP_CONN: &#34;
</code></pre><p>然后，来自本地计算机的端口 80 上的请求将在 dmesg 中生成如下所示的日志（将单行拆分为 3 行以适合此文档）：</p><pre tabindex=0><code>[4304885.870000] NEW_HTTP_CONN: IN=lo OUT= MAC=00:00:00:00:00:00:00:00:00:00:00:00:08:00
SRC=127.0.0.1 DST=127.0.0.1 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=58288 DF PROTO=TCP
SPT=53981 DPT=80 WINDOW=32767 RES=0x00 SYN URGP=0
</code></pre><p>上面的日志也会出现在<code>/var/log/messages</code>、<code>/var/log/syslog</code>、 和 中<code>/var/log/kern.log</code>。可以通过<code>/etc/syslog.conf</code>适当编辑或安装和配置 ulogd 并使用 ULOG 目标而不是 LOG来修改此行为。ulogd 守护进程是一个用户空间服务器，它专门为防火墙侦听来自内核的日志记录指令，并且可以记录到您喜欢的任何文件，甚至是 PostgreSQL 或 MySQL 数据库。使用日志分析工具（例如 logwatch、fwanalog、fwlogwatch 或 lire）可以简化理解防火墙日志的过程。</p></div></div></div><div id=footer><div class=container-footer><div class=beian><a target=_blank href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode="></a><a href target=_blank><span class=some>icp...<span></a></div><div class=info><a href=https://github.com/loveminimal/hugo-theme-virgo>🕊️</a> 2021 - <span id=info-date></span></div></div></div><div class=cool-after></div></body></html>