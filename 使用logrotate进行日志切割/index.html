<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>使用logrotate进行日志切割 - Peng</title><meta name=Description content="One World,One Dream!"><meta property="og:title" content="使用logrotate进行日志切割"><meta property="og:description" content="简介 logrotate 程序是一个日志文件管理工具。用于分割日志文件，删除旧的日志文件，并创建新的日志文件，起到“转储”作用。可以节省磁盘空间。下面就对 logrotate 日志"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.haipengv.com/%E4%BD%BF%E7%94%A8logrotate%E8%BF%9B%E8%A1%8C%E6%97%A5%E5%BF%97%E5%88%87%E5%89%B2/"><meta property="og:image" content="https://blog.haipengv.com/logo.webp"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-02-12T10:16:19+00:00"><meta property="article:modified_time" content="2022-02-12T10:16:19+00:00"><meta property="og:site_name" content="我的网站"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.haipengv.com/logo.webp"><meta name=twitter:title content="使用logrotate进行日志切割"><meta name=twitter:description content="简介 logrotate 程序是一个日志文件管理工具。用于分割日志文件，删除旧的日志文件，并创建新的日志文件，起到“转储”作用。可以节省磁盘空间。下面就对 logrotate 日志"><meta name=application-name content="我的网站"><meta name=apple-mobile-web-app-title content="我的网站"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://blog.haipengv.com/%E4%BD%BF%E7%94%A8logrotate%E8%BF%9B%E8%A1%8C%E6%97%A5%E5%BF%97%E5%88%87%E5%89%B2/><link rel=prev href=https://blog.haipengv.com/windows%E7%BB%93%E6%9D%9F%E8%BF%9B%E7%A8%8B/><link rel=next href=https://blog.haipengv.com/redhat6.3yum%E6%BA%90%E5%A4%B1%E6%95%88%E8%A7%A3%E5%86%B3/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"使用logrotate进行日志切割","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.haipengv.com\/%E4%BD%BF%E7%94%A8logrotate%E8%BF%9B%E8%A1%8C%E6%97%A5%E5%BF%97%E5%88%87%E5%89%B2\/"},"genre":"posts","keywords":"logrotate","wordcount":7030,"url":"https:\/\/blog.haipengv.com\/%E4%BD%BF%E7%94%A8logrotate%E8%BF%9B%E8%A1%8C%E6%97%A5%E5%BF%97%E5%88%87%E5%89%B2\/","datePublished":"2022-02-12T10:16:19+00:00","dateModified":"2022-02-12T10:16:19+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Peng"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=Peng>Peng</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><a class=menu-item href=/friends/><i class='fas fa-fw fa-fan fa-spin'></i> 友链 </a><a class=menu-item href=/about/>关于 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=Peng>Peng</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>文章</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/categories/ title>分类</a><a class=menu-item href=/friends/ title><i class='fas fa-fw fa-fan fa-spin'></i>友链</a><a class=menu-item href=/about/ title>关于</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class="toc-content always-active" id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">使用logrotate进行日志切割</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Peng</a>
</span>&nbsp;<span class=post-category>included in <a href=/categories/%E5%B7%A5%E5%85%B7/><i class="far fa-folder fa-fw" aria-hidden=true></i>工具</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2022-02-12>2022-02-12</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;7030 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;15 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#logrotateconf配置>logrotate.conf配置</a><ul><li><a href=#切割nginx日志的配置>切割nginx日志的配置</a></li></ul></li><li><a href=#关于-usr1-信号解释>关于 USR1 信号解释</a><ul><li><a href=#分享一例曾经使用过的nginx日志切割处理脚本><strong>分享一例曾经使用过的nginx日志切割处理脚本：</strong></a><ul><li><a href=#logrotate日志分割配置><strong>logrotate日志分割配置</strong></a></li><li><a href=#日志分割脚本><strong>日志分割脚本</strong></a></li><li><a href=#crontab定时执行><strong>crontab定时执行</strong></a></li><li><a href=#php脚本切割><strong>php脚本切割</strong></a></li><li><a href=#nginx日志切割一例><strong>nginx日志切割一例</strong></a></li><li><a href=#系统日志切割一例><strong>系统日志切割一例</strong></a></li><li><a href=#tomcat日志切割一例><strong>tomcat日志切割一例</strong></a></li><li><a href=#早期用过的nginx日志处理一例><strong>早期用过的nginx日志处理一例</strong></a></li></ul></li><li><a href=#尝试解决logrotate无法自动轮询日志的办法><strong>尝试解决logrotate无法自动轮询日志的办法</strong></a></li><li><a href=#其他工具实现日志切割>其他工具实现日志切割</a><ul><li><a href=#python脚本实现日志切割><strong>Python脚本实现日志切割</strong></a></li><li><a href=#shell脚本实现日志切割><strong>shell脚本实现日志切割</strong></a></li></ul></li></ul></li></ul></nav></div></div><div class=content id=content><h1 id=简介>简介</h1><p>logrotate 程序是一个日志文件管理工具。用于分割日志文件，删除旧的日志文件，并创建新的日志文件，起到“转储”作用。可以节省磁盘空间。下面就对 logrotate 日志轮转操作做一梳理记录。</p><p>logrotate 是基于 crontab 运行的，所以这个时间点是由 crontab 控制的，具体可以查询 crontab 的配置文件 /etc/anacrontab。 系统会按照计划的频率运行 logrotate，通常是每天。在大多数的 Linux 发行版本上，计划每天运行的脚本位于 /etc/cron.daily/logrotate。</p><p>主流 Linux 发行版上都默认安装有 logrotate 包，如果你的 linux 系统中找不到 logrotate, 可以使用 apt-get 或 yum 命令来安装。</p><h1 id=logrotate运行机制>logrotate运行机制</h1><p>logrotate 在很多 Linux 发行版上都是默认安装的。系统会定时运行 logrotate，一般是每天一次。系统是这么实现按天执行的。crontab 会每天定时执行 /etc/cron.daily 目录下的脚本，而这个目录下有个文件叫 logrotate。在 centos 上脚本内容是这样的：</p><p>系统自带 cron task：<code>/etc/cron.daily/logrotate</code>，每天运行一次。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>[</span>root@localhost logrotate.d<span class=o>]</span><span class=c1># cat /etc/cron.daily/logrotate</span>
</span></span><span class=line><span class=cl><span class=c1>#!/bin/sh</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>/usr/sbin/logrotate -s /var/lib/logrotate/logrotate.status /etc/logrotate.conf
</span></span><span class=line><span class=cl><span class=nv>EXITVALUE</span><span class=o>=</span><span class=nv>$?</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> <span class=nv>$EXITVALUE</span> !<span class=o>=</span> <span class=m>0</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    /usr/bin/logger -t logrotate <span class=s2>&#34;ALERT exited abnormally with [</span><span class=nv>$EXITVALUE</span><span class=s2>]&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=nb>exit</span> <span class=m>0</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到这个脚本主要做的事就是以 <code>/etc/logrotate.conf</code> 为配置文件执行了 logrotate。就是这样实现了每天执行一次 logrotate。</p><h1 id=自定义周期滚动日志>自定义周期滚动日志</h1><p>因为我的系统执行 <code>/etc/cron.daily</code> 目录下的脚本不是我想滚动日志的时间，所以我把 <code>/etc/cron.daily/logrotate</code> 拷了出来，改了一下 logrotate 配置文件的路径，然后在 crontab 里加上一条指定时间执行这个脚本的记录，自定义周期滚动日志就大功告成了。这种自定义的方式有两点要注意：</p><ol><li>配置文件里一定要配置 <code>rotate 文件数目</code>这个参数。如果不配置默认是 0 个，也就是只允许存在一份日志，刚切分出来的日志会马上被删除。</li><li>执行 logrotate 命令最好加 <code>-f</code> 参数，不然有时候配置文件修改的内容不生效。</li></ol><p>很多程序的会用到 logrotate 滚动日志，比如 nginx。它们安装后，会在 <code>/etc/logrotate.d</code> 这个目录下增加自己的 logrotate 的配置文件。logrotate 什么时候执行 <code>/etc/logrotate.d</code> 下的配置呢？看到 <code>/etc/logrotate.conf</code> 里这行，一切就不言而喻了。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>include /etc/logrotate.d
</span></span></code></pre></td></tr></table></div></div><h1 id=安装>安装</h1><p>先检查服务器有没有安装</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>rpm -qa <span class=p>|</span> grep crontab
</span></span></code></pre></td></tr></table></div></div><p>安装</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>yum -y install vixie-cron
</span></span><span class=line><span class=cl>yum -y install crontabs
</span></span></code></pre></td></tr></table></div></div><p>简单说明：
vixie-cron 是 cron 的主程序；
crontabs 是用来安装、卸装、或列举用来驱动 cron 守护进程的表格的程序。</p><p>安装好后启动和配置服务</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>service crond start     //启动服务
</span></span><span class=line><span class=cl>service crond stop      //关闭服务
</span></span><span class=line><span class=cl>service crond restart   //重启服务
</span></span><span class=line><span class=cl>service crond reload    //重新载入配置
</span></span><span class=line><span class=cl>service crond status    //查看crontab服务状态
</span></span></code></pre></td></tr></table></div></div><p>设置开机自启</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>chkconfig --level <span class=m>345</span> crond on
</span></span></code></pre></td></tr></table></div></div><p>简单定时脚本</p><p>[root@localhost ~]# vim test.sh</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>nowtime=`date +&#34;%Y-%m-%d %H:%M:%S&#34;`
</span></span><span class=line><span class=cl>echo &#34;hello cron &#34;$nowtime
</span></span></code></pre></td></tr></table></div></div><p>添加执行权限
[root@localhost~]# chmod +x test.sh
运行：
[root@localhost ~]# ./test.sh
hello cron 2022-01-09 19:54:30</p><p>添加定时任务。每一分钟执行一次</p><p>运行crontab -e</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>*/1 * * * * /root/test.sh  &gt;&gt; /root/test.log
</span></span></code></pre></td></tr></table></div></div><h1 id=配置文件介绍>配置文件介绍</h1><p>Linux系统默认安装logrotate工具，它默认的配置文件在：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>/etc/logrotate.conf
</span></span><span class=line><span class=cl>/etc/logrotate.d/
</span></span></code></pre></td></tr></table></div></div><p>logrotate.conf 才是主要的配置文件，logrotate.d 是一个目录，该目录里的所有文件都会被主动的读入/etc/logrotate.conf中执行。另外，如果 /etc/logrotate.d/ 里面的文件中没有设定一些细节，则会以/etc/logrotate.conf这个文件的设定来作为默认值。</p><p>Logrotate是基于CRON来运行的，其脚本是/etc/cron.daily/logrotate，日志轮转是系统自动完成的。实际运行时，Logrotate会调用配置文件/etc/logrotate.conf。可以在/etc/logrotate.d目录里放置自定义好的配置文件，用来覆盖Logrotate的缺省值。</p><p>[root@localhost ~]# cat /etc/cron.daily/logrotate</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=cp>#!/bin/sh
</span></span></span><span class=line><span class=cl><span class=cp></span>/usr/sbin/logrotate /etc/logrotate.conf &gt;/dev/null 2&gt;<span class=p>&amp;</span><span class=m>1</span>
</span></span><span class=line><span class=cl><span class=nv>EXITVALUE</span><span class=o>=</span><span class=nv>$?</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> <span class=nv>$EXITVALUE</span> !<span class=o>=</span> <span class=m>0</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  /usr/bin/logger -t logrotate <span class=s2>&#34;ALERT exited abnormally with [</span><span class=nv>$EXITVALUE</span><span class=s2>]&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=nb>exit</span> <span class=m>0</span>
</span></span></code></pre></td></tr></table></div></div><p>如果等不及cron自动执行日志轮转，想手动强制切割日志，需要加-f参数；不过正式执行前最好通过Debug选项来验证一下（-d参数），这对调试也很重要：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>/usr/sbin/logrotate -f /etc/logrotate.d/nginx
</span></span><span class=line><span class=cl>/usr/sbin/logrotate -d -f /etc/logrotate.d/nginx
</span></span></code></pre></td></tr></table></div></div><p>logrotate 命令格式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>logrotate [OPTION...] &lt;configfile&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>-d, --debug ：debug模式，测试配置文件是否有错误。
</span></span><span class=line><span class=cl>-f, --force ：强制转储文件。
</span></span><span class=line><span class=cl>-m, --mail=command ：压缩日志后，发送日志到指定邮箱。
</span></span><span class=line><span class=cl>-s, --state=statefile ：使用指定的状态文件。
</span></span><span class=line><span class=cl>-v, --verbose ：显示转储过程。
</span></span></code></pre></td></tr></table></div></div><p>根据日志切割设置进行操作，并显示详细信息：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>[</span>root@localhost ~<span class=o>]</span><span class=c1># /usr/sbin/logrotate -v /etc/logrotate.conf</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@localhost ~<span class=o>]</span><span class=c1># /usr/sbin/logrotate -v /etc/logrotate.d/php</span>
</span></span></code></pre></td></tr></table></div></div><p>根据日志切割设置进行执行，并显示详细信息,但是不进行具体操作，debug模式</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[root@localhost ~]# /usr/sbin/logrotate -d /etc/logrotate.conf
</span></span><span class=line><span class=cl>[root@localhost ~]# /usr/sbin/logrotate -d /etc/logrotate.d/nginx
</span></span></code></pre></td></tr></table></div></div><p>查看各log文件的具体执行情况</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[root@localhost ~]# cat /var/lib/logrotate.status
</span></span></code></pre></td></tr></table></div></div><h1 id=切割介绍>切割介绍</h1><p>比如以系统日志/var/log/message做切割来简单说明下：</p><ul><li>第一次执行完rotate(轮转)之后，原本的messages会变成messages.1，而且会制造一个空的messages给系统来储存日志；</li><li>第二次执行之后，messages.1会变成messages.2，而messages会变成messages.1，又造成一个空的messages来储存日志！</li></ul><p>如果仅设定保留三个日志（即轮转3次）的话，那么执行第三次时，则 messages.3这个档案就会被删除，并由后面的较新的保存日志所取代！也就是会保存最新的几个日志。</p><p>日志究竟轮换几次，这个是根据配置文件中的dateext 参数来判定的。</p><h2 id=logrotateconf配置>logrotate.conf配置</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>cat /etc/logrotate.conf
</span></span></code></pre></td></tr></table></div></div><p>底下的设定是 &ldquo;logrotate 的默认值&rdquo; ，如果別的文件设定了其他的值，就会以其它文件的设定为主</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>weekly		//默认每一周执行一次rotate轮转工作
</span></span><span class=line><span class=cl>rotate 4	// 保留多少个日志文件<span class=o>(</span>轮转几次<span class=o>)</span>.默认保留四个.就是指定日志文件删除之前轮转的次数，0 指没有备份
</span></span><span class=line><span class=cl>create	//自动创建新的日志文件，新的日志文件具有和原来的文件相同的权限；因为日志被改名,因此要创建一个新的来继续存储之前的日志
</span></span><span class=line><span class=cl>dateext	// 这个参数很重要！就是切割后的日志文件以当前日期为格式结尾，如xxx.log-20131216这样,如果注释掉,切割出来是按数字递增,即前面说的 xxx.log-1这种格式
</span></span><span class=line><span class=cl>compress //是否通过gzip压缩转储以后的日志文件，如xxx.log-20131216.gz ；如果不需要压缩，注释掉就行
</span></span><span class=line><span class=cl>include /etc/logrotate.d  	//将 /etc/logrotate.d/ 目录中的所有文件都加载进来
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>/var/log/wtmp <span class=o>{</span>         //仅针对 /var/log/wtmp 所设定的参数
</span></span><span class=line><span class=cl>monthly          //每月一次切割,取代默认的一周
</span></span><span class=line><span class=cl>minsize 1M       //文件大小超过 1M 后才会切割
</span></span><span class=line><span class=cl>create <span class=m>0664</span> root utmp      //指定新建的日志文件权限以及所属用户和组
</span></span><span class=line><span class=cl>rotate <span class=m>1</span>          //只保留一个日志.
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这个 wtmp 可记录用户登录系统及系统重启的时间.因为有 minsize 的参数，因此不见得每个月一定会执行一次,要看文件大小。</p><p>由这个文件的设定可以知道/etc/logrotate.d其实就是由/etc/logrotate.conf 所规划出来的目录，虽然可以将所有的配置都写入 /etc/logrotate.conf ，但是这样一来这个文件就实在是太复杂了，尤其是当使用很多的服务在系统上面时， 每个服务都要去修改 /etc/logrotate.conf 的设定也似乎不太合理了。</p><p>所以，如果独立出来一个目录，那么每个要切割日志的服务， 就可以独自成为一个文件，并且放置到 /etc/logrotate.d/ 当中。</p><p>其他重要参数说明：</p><table><thead><tr><th style=text-align:center>参数</th><th style=text-align:center>说明</th></tr></thead><tbody><tr><td style=text-align:center>compress</td><td style=text-align:center>通过gzip 压缩转储以后的日志</td></tr><tr><td style=text-align:center>nocompress</td><td style=text-align:center>不做gzip压缩处理</td></tr><tr><td style=text-align:center>copytruncate</td><td style=text-align:center>用于还在打开中的日志文件，把当前日志备份并截断；是先拷贝再清空的方式，拷贝和清空之间有一个时间差，可能会丢失部分日志数据。</td></tr><tr><td style=text-align:center>nocopytruncate</td><td style=text-align:center>备份日志文件不过不截断</td></tr><tr><td style=text-align:center>create mode owner group</td><td style=text-align:center>轮转时指定创建新文件的属性，如create 0777 nobody nobody</td></tr><tr><td style=text-align:center>nocreate</td><td style=text-align:center>不建立新的日志文件</td></tr><tr><td style=text-align:center>delaycompress</td><td style=text-align:center>和compress 一起使用时，转储的日志文件到下一次转储时才压缩</td></tr><tr><td style=text-align:center>nodelaycompress</td><td style=text-align:center>覆盖 delaycompress 选项，转储同时压缩。</td></tr><tr><td style=text-align:center>missingok</td><td style=text-align:center>如果日志丢失，不报错继续滚动下一个日志</td></tr><tr><td style=text-align:center>errors address</td><td style=text-align:center>转储时的错误信息发送到指定的Email 地址</td></tr><tr><td style=text-align:center>ifempty</td><td style=text-align:center>即使日志文件为空文件也做轮转，这个是logrotate的缺省选项。</td></tr><tr><td style=text-align:center>notifempty</td><td style=text-align:center>当日志文件为空时，不进行轮转</td></tr><tr><td style=text-align:center>mail address</td><td style=text-align:center>把转储的日志文件发送到指定的E-mail 地址</td></tr><tr><td style=text-align:center>nomail</td><td style=text-align:center>转储时不发送日志文件</td></tr><tr><td style=text-align:center>olddir directory</td><td style=text-align:center>转储后的日志文件放入指定的目录，必须和当前日志文件在同一个文件系统</td></tr><tr><td style=text-align:center>noolddir</td><td style=text-align:center>转储后的日志文件和当前日志文件放在同一个目录下</td></tr><tr><td style=text-align:center>sharedscripts</td><td style=text-align:center>运行postrotate脚本，作用是在所有日志都轮转后统一执行一次脚本。如果没有配置这个，那么每个日志轮转后都会执行一次脚本</td></tr><tr><td style=text-align:center>prerotate</td><td style=text-align:center>在logrotate转储之前需要执行的指令，例如修改文件的属性等动作；必须独立成行</td></tr><tr><td style=text-align:center>postrotate</td><td style=text-align:center>在logrotate转储之后需要执行的指令，例如重新启动 (kill -HUP) 某个服务！必须独立成行</td></tr><tr><td style=text-align:center>daily</td><td style=text-align:center>指定转储周期为每天</td></tr><tr><td style=text-align:center>weekly</td><td style=text-align:center>指定转储周期为每周</td></tr><tr><td style=text-align:center>monthly</td><td style=text-align:center>指定转储周期为每月</td></tr><tr><td style=text-align:center>rotate count</td><td style=text-align:center>指定日志文件删除之前转储的次数，0 指没有备份，5 指保留5 个备份</td></tr><tr><td style=text-align:center>dateext</td><td style=text-align:center>使用当期日期作为命名格式</td></tr><tr><td style=text-align:center>dateformat .%s</td><td style=text-align:center>配合dateext使用，紧跟在下一行出现，定义文件切割后的文件名，必须配合dateext使用，只支持 %Y %m %d %s 这四个参数</td></tr><tr><td style=text-align:center>size(或minsize) log-size</td><td style=text-align:center>当日志文件到达指定的大小时才转储，log-size能指定bytes(缺省)及KB (sizek)或MB(sizem).</td></tr><tr><td style=text-align:center></td><td style=text-align:center>当日志文件 >= log-size 的时候就转储。 以下为合法格式：（其他格式的单位大小写没有试过） size = 5 或 size 5 （>= 5 个字节就转储） size = 100k 或 size 100k size = 100M 或 size 100M</td></tr></tbody></table><h3 id=切割nginx日志的配置>切割nginx日志的配置</h3><p>[root@localhost ~]# vim /etc/logrotate.d/nginx</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>/usr/local/nginx/logs/*.log <span class=o>{</span>
</span></span><span class=line><span class=cl>daily
</span></span><span class=line><span class=cl>rotate <span class=m>7</span>
</span></span><span class=line><span class=cl>missingok
</span></span><span class=line><span class=cl>notifempty
</span></span><span class=line><span class=cl>dateext
</span></span><span class=line><span class=cl>sharedscripts
</span></span><span class=line><span class=cl>postrotate
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> -f /usr/local/nginx/logs/nginx.pid <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>	<span class=nb>kill</span> -USR1 <span class=sb>`</span>cat /usr/local/nginx/logs/nginx.pid<span class=sb>`</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>endscript
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=关于-usr1-信号解释>关于 USR1 信号解释</h2><p>USR1 通常被用来告知应用程序重载配置文件；例如，向 Apache HTTP 服务器发送一个 USR1 信号将导致以下步骤的发生：停止接受新的连接，等待当前连接停止，重新载入配置文件，重新打开日志文件，重启服务器，从而实现相对平滑的不关机的更改。</p><p>对于 USR1 和 2 都可以用户自定义的，在 POSIX 兼容的平台上，SIGUSR1 和 SIGUSR2 是发送给一个进程的信号，它表示了用户定义的情况。它们的符号常量在头文件 signal.h 中定义。在不同的平台上，信号的编号可能发生变化，因此需要使用符号名称。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>kill -HUP pid
</span></span><span class=line><span class=cl>killall -HUP pName
</span></span></code></pre></td></tr></table></div></div><p>其中 pid 是进程标识，pName 是进程的名称。</p><p>如果想要更改配置而不需停止并重新启动服务，可以使用上面两个命令。在对配置文件作必要的更改后，发出该命令以动态更新服务配置。根据约定，当你发送一个挂起信号 (信号 1 或 HUP) 时，大多数服务器进程 (所有常用的进程) 都会进行复位操作并重新加载它们的配置文件。</p><h3 id=分享一例曾经使用过的nginx日志切割处理脚本><strong>分享一例曾经使用过的nginx日志切割处理脚本：</strong></h3><h4 id=logrotate日志分割配置><strong>logrotate日志分割配置</strong></h4><p>[root@localhost ~# vim /etc/logrotate.d/nginx</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>/data/nginx_logs/*.access_log
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>nocompress                  
</span></span><span class=line><span class=cl>daily                 
</span></span><span class=line><span class=cl>copytruncate                 
</span></span><span class=line><span class=cl>create               
</span></span><span class=line><span class=cl>ifempty                  
</span></span><span class=line><span class=cl>olddir /data/nginx_logs/days      
</span></span><span class=line><span class=cl>rotate <span class=m>0</span>                    
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=日志分割脚本><strong>日志分割脚本</strong></h4><p>[root@localhost ~# vim /usr/local/sbin/logrotate-nginx.sh</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1>#创建转储日志压缩存放目录</span>
</span></span><span class=line><span class=cl>mkdir -p /data/nginx_logs/days
</span></span><span class=line><span class=cl><span class=c1>#手工对nginx日志进行切割转换</span>
</span></span><span class=line><span class=cl>/usr/sbin/logrotate -vf /etc/logrotate.d/nginx
</span></span><span class=line><span class=cl><span class=c1>#当前时间</span>
</span></span><span class=line><span class=cl><span class=nv>time</span><span class=o>=</span><span class=k>$(</span>date -d <span class=s2>&#34;yesterday&#34;</span> +<span class=s2>&#34;%Y-%m-%d&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl><span class=c1>#进入转储日志存放目录</span>
</span></span><span class=line><span class=cl><span class=nb>cd</span> /data/nginx_logs/days
</span></span><span class=line><span class=cl><span class=c1>#对目录中的转储日志文件的文件名进行统一转换</span>
</span></span><span class=line><span class=cl><span class=k>for</span> i in <span class=k>$(</span>ls ./ <span class=p>|</span> grep <span class=s2>&#34;^\(.*\)\.[[:digit:]]</span>$<span class=s2>&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl><span class=k>do</span>
</span></span><span class=line><span class=cl>mv <span class=si>${</span><span class=nv>i</span><span class=si>}</span> ./<span class=k>$(</span><span class=nb>echo</span> <span class=si>${</span><span class=nv>i</span><span class=si>}</span><span class=p>|</span>sed -n <span class=s1>&#39;s/^\(.*\)\.\([[:digit:]]\)$/\1/p&#39;</span><span class=k>)</span>-<span class=k>$(</span><span class=nb>echo</span> <span class=nv>$time</span><span class=k>)</span>
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span><span class=line><span class=cl><span class=c1>#对转储的日志文件进行压缩存放，并删除原有转储的日志文件，只保存压缩后的日志文件。以节约存储空间</span>
</span></span><span class=line><span class=cl><span class=k>for</span> i in <span class=k>$(</span>ls ./ <span class=p>|</span> grep <span class=s2>&#34;^\(.*\)\-\([[:digit:]-]\+\)</span>$<span class=s2>&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl><span class=k>do</span>
</span></span><span class=line><span class=cl>tar jcvf <span class=si>${</span><span class=nv>i</span><span class=si>}</span>.bz2 ./<span class=si>${</span><span class=nv>i</span><span class=si>}</span>
</span></span><span class=line><span class=cl>rm -rf ./<span class=si>${</span><span class=nv>i</span><span class=si>}</span>
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span><span class=line><span class=cl><span class=c1>#只保留最近7天的压缩转储日志文件</span>
</span></span><span class=line><span class=cl>find /data/nginx_logs/days/* -name <span class=s2>&#34;*.bz2&#34;</span> -mtime <span class=m>7</span> -type f -exec rm -rf <span class=o>{}</span> <span class=se>\;</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=crontab定时执行><strong>crontab定时执行</strong></h4><p>[root@localhost ~# crontab -e</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1>#logrotate</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=m>0</span> <span class=m>0</span> * * * /bin/bash -x /usr/local/sbin/logrotate-nginx.sh &gt; /dev/null 2&gt;<span class=p>&amp;</span><span class=m>1</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>手动执行脚本，测试下看看：</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[root@localhost ~# /bin/bash -x /usr/local/sbin/logrotate-nginx.sh
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[root@localhost ~# cd /data/nginx_logs/days
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[root@localhost days# ls
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>huantest.access_log-2017-01-18.bz2
</span></span></code></pre></td></tr></table></div></div><h4 id=php脚本切割><strong>php脚本切割</strong></h4><p>[root@localhost ~]# cat /etc/logrotate.d/php</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>/Data/logs/php/*log <span class=o>{</span>
</span></span><span class=line><span class=cl>    daily
</span></span><span class=line><span class=cl>    rotate <span class=m>365</span>
</span></span><span class=line><span class=cl>    missingok
</span></span><span class=line><span class=cl>    notifempty
</span></span><span class=line><span class=cl>    compress
</span></span><span class=line><span class=cl>    dateext
</span></span><span class=line><span class=cl>    sharedscripts
</span></span><span class=line><span class=cl>    postrotate
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>[</span> -f /Data/app/php5.6.26/var/run/php-fpm.pid <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>            <span class=nb>kill</span> -USR1 <span class=sb>`</span>cat /Data/app/php5.6.26/var/run/php-fpm.pid<span class=sb>`</span>
</span></span><span class=line><span class=cl>        <span class=k>fi</span>
</span></span><span class=line><span class=cl>    endscript
</span></span><span class=line><span class=cl>    postrotate
</span></span><span class=line><span class=cl>        /bin/chmod <span class=m>644</span> /Data/logs/php/*gz
</span></span><span class=line><span class=cl>    endscript
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>结果</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[root@localhost ~]# ll /Data/app/php5.6.26/var/run/php-fpm.pid
</span></span><span class=line><span class=cl>-rw-r--r-- 1 root root 4 Dec 28 17:03 /Data/app/php5.6.26/var/run/php-fpm.pid
</span></span><span class=line><span class=cl>[root@localhost ~]# cd /Data/logs/php
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[root@localhost php]# ll
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>total 25676
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>-rw-r--r-- 1 root  root     0 Jun 1 2016 error.log
</span></span><span class=line><span class=cl>-rw-r--r-- 1 nobody nobody   182 Aug 30 2015 error.log-20150830.gz
</span></span><span class=line><span class=cl>-rw-r--r-- 1 nobody nobody   371 Sep 1 2015 error.log-20150901.gz
</span></span><span class=line><span class=cl>-rw-r--r-- 1 nobody nobody   315 Sep 7 2015 error.log-20150907.gz
</span></span></code></pre></td></tr></table></div></div><h4 id=nginx日志切割一例><strong>nginx日志切割一例</strong></h4><p>[root@localhost ~]# cat /etc/logrotate.d/nginx</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>/Data/logs/nginx/*/*log <span class=o>{</span>
</span></span><span class=line><span class=cl>    daily
</span></span><span class=line><span class=cl>    rotate <span class=m>365</span>
</span></span><span class=line><span class=cl>    missingok
</span></span><span class=line><span class=cl>    notifempty
</span></span><span class=line><span class=cl>    compress
</span></span><span class=line><span class=cl>    dateext
</span></span><span class=line><span class=cl>    sharedscripts
</span></span><span class=line><span class=cl>    postrotate
</span></span><span class=line><span class=cl>    /etc/init.d/nginx reload
</span></span><span class=line><span class=cl>    endscript
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>结果</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[root@localhost ~]# ll /Data/logs/nginx/www.huanqiu.com/
</span></span><span class=line><span class=cl>..........
</span></span><span class=line><span class=cl>-rw-r--r-- 1 root root      1652 Jan  1 00:00 error.log-20170101.gz
</span></span><span class=line><span class=cl>-rw-r--r-- 1 root root      1289 Jan  2 00:00 error.log-20170102.gz
</span></span><span class=line><span class=cl>-rw-r--r-- 1 root root      1633 Jan  3 00:00 error.log-20170103.gz
</span></span><span class=line><span class=cl>-rw-r--r-- 1 root root      3239 Jan  4 00:00 error.log-20170104.gz
</span></span></code></pre></td></tr></table></div></div><h4 id=系统日志切割一例><strong>系统日志切割一例</strong></h4><p>[root@localhost ~]# cat /etc/logrotate.d/syslog</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>/var/log/cron
</span></span><span class=line><span class=cl>/var/log/maillog
</span></span><span class=line><span class=cl>/var/log/messages
</span></span><span class=line><span class=cl>/var/log/secure
</span></span><span class=line><span class=cl>/var/log/spooler
</span></span><span class=line><span class=cl>{
</span></span><span class=line><span class=cl>    sharedscripts
</span></span><span class=line><span class=cl>    postrotate
</span></span><span class=line><span class=cl>    /bin/kill -HUP `cat /var/run/syslogd.pid 2&gt; /dev/null` 2&gt; /dev/null || true
</span></span><span class=line><span class=cl>    endscript
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><p>结果</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[root@localhost ~]# ll /var/log/messages*
</span></span><span class=line><span class=cl>-rw------- 1 root root 34248975 Jan 19 18:42 /var/log/messages
</span></span><span class=line><span class=cl>-rw------- 1 root root 51772994 Dec 25 03:11 /var/log/messages-20161225
</span></span><span class=line><span class=cl>-rw------- 1 root root 51800210 Jan  1 03:05 /var/log/messages-20170101
</span></span><span class=line><span class=cl>-rw------- 1 root root 51981366 Jan  8 03:36 /var/log/messages-20170108
</span></span><span class=line><span class=cl>-rw------- 1 root root 51843025 Jan 15 03:40 /var/log/messages-20170115
</span></span><span class=line><span class=cl>[root@localhost ~]# ll /var/log/cron*
</span></span><span class=line><span class=cl>-rw------- 1 root root 2155681 Jan 19 18:43 /var/log/cron
</span></span><span class=line><span class=cl>-rw------- 1 root root 2932618 Dec 25 03:11 /var/log/cron-20161225
</span></span><span class=line><span class=cl>-rw------- 1 root root 2939305 Jan  1 03:06 /var/log/cron-20170101
</span></span><span class=line><span class=cl>-rw------- 1 root root 2951820 Jan  8 03:37 /var/log/cron-20170108
</span></span><span class=line><span class=cl>-rw------- 1 root root 3203992 Jan 15 03:41 /var/log/cron-20170115
</span></span><span class=line><span class=cl>[root@localhost ~]# ll /var/log/secure*
</span></span><span class=line><span class=cl>-rw------- 1 root root  275343 Jan 19 18:36 /var/log/secure
</span></span><span class=line><span class=cl>-rw------- 1 root root 2111936 Dec 25 03:06 /var/log/secure-20161225
</span></span><span class=line><span class=cl>-rw------- 1 root root 2772744 Jan  1 02:57 /var/log/secure-20170101
</span></span><span class=line><span class=cl>-rw------- 1 root root 1115543 Jan  8 03:26 /var/log/secure-20170108
</span></span><span class=line><span class=cl>-rw------- 1 root root  731599 Jan 15 03:40 /var/log/secure-20170115
</span></span><span class=line><span class=cl>[root@localhost ~]# ll /var/log/spooler*
</span></span><span class=line><span class=cl>-rw------- 1 root root 0 Jan 15 03:41 /var/log/spooler
</span></span><span class=line><span class=cl>-rw------- 1 root root 0 Dec 18 03:21 /var/log/spooler-20161225
</span></span><span class=line><span class=cl>-rw------- 1 root root 0 Dec 25 03:11 /var/log/spooler-20170101
</span></span><span class=line><span class=cl>-rw------- 1 root root 0 Jan  1 03:06 /var/log/spooler-20170108
</span></span><span class=line><span class=cl>-rw------- 1 root root 0 Jan  8 03:37 /var/log/spooler-20170115
</span></span></code></pre></td></tr></table></div></div><h4 id=tomcat日志切割一例><strong>tomcat日志切割一例</strong></h4><p>[root@localhost ~]# cat /etc/logrotate.d/tomcat</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>/Data/app/tomcat-7-huanqiu/logs/catalina.out <span class=o>{</span>
</span></span><span class=line><span class=cl>rotate <span class=m>14</span>
</span></span><span class=line><span class=cl>daily
</span></span><span class=line><span class=cl>copytruncate
</span></span><span class=line><span class=cl>compress
</span></span><span class=line><span class=cl>notifempty
</span></span><span class=line><span class=cl>missingok
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>结果</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[root@localhost ~]# ll /Data/app/tomcat-7-huanqiu/logs/catalina.*
</span></span><span class=line><span class=cl>-rw-r--r--. 1 root root     0 Jan 19 19:11 /Data/app/tomcat-7-huanqiu/logs/catalina.out
</span></span><span class=line><span class=cl>-rw-r--r--. 1 root root 95668 Jan 19 19:11 /Data/app/tomcat-7-huanqiu/logs/catalina.out.1.gz
</span></span></code></pre></td></tr></table></div></div><h4 id=早期用过的nginx日志处理一例><strong>早期用过的nginx日志处理一例</strong></h4><p>[root@localhost ~]# vim /letv/sh/cut_nginx_log.sh</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1># 你的日志文件存放目录</span>
</span></span><span class=line><span class=cl><span class=nv>logs_path</span><span class=o>=</span><span class=s2>&#34;/letv/logs/&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># 日志文件的名字，多个需要空格隔开</span>
</span></span><span class=line><span class=cl><span class=nv>logs_names</span><span class=o>=(</span>error access pv_access<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nv>dates</span><span class=o>=</span><span class=sb>`</span>date -d <span class=s2>&#34;yesterday&#34;</span> +<span class=s2>&#34;%Y%m%d&#34;</span><span class=sb>`</span>
</span></span><span class=line><span class=cl>mkdir -p <span class=si>${</span><span class=nv>logs_path</span><span class=si>}</span><span class=nv>$dates</span>/
</span></span><span class=line><span class=cl><span class=nv>num</span><span class=o>=</span><span class=si>${#</span><span class=nv>logs_names</span><span class=p>[@]</span><span class=si>}</span>
</span></span><span class=line><span class=cl><span class=k>for</span><span class=o>((</span><span class=nv>i</span><span class=o>=</span>0<span class=p>;</span>i&lt;num<span class=p>;</span>i++<span class=o>))</span><span class=p>;</span><span class=k>do</span>
</span></span><span class=line><span class=cl>mv <span class=si>${</span><span class=nv>logs_path</span><span class=si>}${</span><span class=nv>logs_names</span><span class=p>[i]</span><span class=si>}</span>.log <span class=si>${</span><span class=nv>logs_path</span><span class=si>}</span><span class=nv>$dates</span>/<span class=si>${</span><span class=nv>logs_names</span><span class=p>[i]</span><span class=si>}</span>.log
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span><span class=line><span class=cl><span class=c1>#nginx平滑重启</span>
</span></span><span class=line><span class=cl><span class=nb>kill</span> -USR1 <span class=sb>`</span>cat /letv/logs/nginx/nginx.pid<span class=sb>`</span> 
</span></span></code></pre></td></tr></table></div></div><p>结合crontab定时执行</p><p>[root@localhost ~]# crontab -e</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1>#nginx日志切割</span>
</span></span><span class=line><span class=cl><span class=m>00</span> <span class=m>00</span> * * * <span class=nb>cd</span> /letv/logs<span class=p>;</span>/bin/bash /letv/sh/cut_nginx_log.sh &gt; /dev/null 2&gt;<span class=p>&amp;</span><span class=m>1</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=尝试解决logrotate无法自动轮询日志的办法><strong>尝试解决logrotate无法自动轮询日志的办法</strong></h3><p>现象说明：</p><p>使用logrotate轮询nginx日志，配置好之后，发现nginx日志连续两天没被切割，这是为什么呢？？</p><p>然后开始检查日志切割的配置文件是否有问题，检查后确定配置文件一切正常。</p><p>于是怀疑是logrotate预定的cron没执行，查看了cron的日志，发现有一条Dec 7 04:02:01 www crond[18959]: (root) CMD (run-parts /etc/cron.daily)这样的日志，证明cron在04:02分时已经执行/etc/cron.daily目录下的程序。</p><p>接着查看/etc /cron.daily/logrotate（这是logrotate自动轮转的脚本）的内容：</p><p>[root@localhost~]# cat /etc/cron.daily/logrotate</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=cp>#!/bin/sh
</span></span></span><span class=line><span class=cl><span class=cp></span>/usr/sbin/logrotate /etc/logrotate.conf &gt;/dev/null 2&gt;<span class=p>&amp;</span><span class=m>1</span>
</span></span><span class=line><span class=cl><span class=nv>EXITVALUE</span><span class=o>=</span><span class=nv>$?</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> <span class=nv>$EXITVALUE</span> !<span class=o>=</span> <span class=m>0</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    /usr/bin/logger -t logrotate <span class=s2>&#34;ALERT exited abnormally with [</span><span class=nv>$EXITVALUE</span><span class=s2>]&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=nb>exit</span> <span class=m>0</span>
</span></span></code></pre></td></tr></table></div></div><p>没有发现异常，配置好的日志轮转操作都是由这个脚本完成的，一切运行正常，脚本应该就没问题。</p><p>直接执行命令：</p><p>[root@localhost ~]# /usr/sbin/logrotate /etc/logrotate.conf</p><p>这些系统日志是正常轮询了，但nginx日志却还是没轮询。接着强行启动记录文件维护操作，纵使logrotate指令认为没有需要，应该有可能是logroate认为nginx日志太小，不进行轮询。</p><p>故需要强制轮询，即在/etc/cron.daily/logrotate脚本中将 -t 参数替换成 -f 参数</p><p>[root@localhost ~]# cat /etc/cron.daily/logrotate</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=cp>#!/bin/sh
</span></span></span><span class=line><span class=cl><span class=cp></span>/usr/sbin/logrotate /etc/logrotate.conf &gt;/dev/null 2&gt;<span class=p>&amp;</span><span class=m>1</span>
</span></span><span class=line><span class=cl><span class=nv>EXITVALUE</span><span class=o>=</span><span class=nv>$?</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> <span class=nv>$EXITVALUE</span> !<span class=o>=</span> <span class=m>0</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>	/usr/bin/logger -f logrotate <span class=s2>&#34;ALERT exited abnormally with [</span><span class=nv>$EXITVALUE</span><span class=s2>]&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=nb>exit</span> 
</span></span></code></pre></td></tr></table></div></div><p>最后重启下cron服务：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>[</span>root@localhost ~<span class=o>]</span><span class=c1># /etc/init.d/crond restart</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Stopping crond: <span class=o>[</span> OK <span class=o>]</span>
</span></span><span class=line><span class=cl>Starting crond: <span class=o>[</span> OK <span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>logrotate默认自动切割生效时间</strong></p><p>Logrotate是基于CRON来运行的，其脚本是/etc/cron.daily/logrotate，实际运行时，Logrotate会调用配置文件/etc/logrotate.conf。</p><p>[root@test ~]# cat /etc/cron.daily/logrotate</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=cp>#!/bin/sh
</span></span></span><span class=line><span class=cl><span class=cp></span>/usr/sbin/logrotate /etc/logrotate.conf
</span></span><span class=line><span class=cl><span class=nv>EXITVALUE</span><span class=o>=</span><span class=nv>$?</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> <span class=nv>$EXITVALUE</span> !<span class=o>=</span> <span class=m>0</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    /usr/bin/logger -t logrotate <span class=s2>&#34;ALERT exited abnormally with [</span><span class=nv>$EXITVALUE</span><span class=s2>]&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=nb>exit</span> <span class=m>0</span>
</span></span></code></pre></td></tr></table></div></div><p>时间是由CRON控制的，具体可以查询CRON的配置文件/etc/anacrontab（老版本的文件是/etc/crontab）</p><p>[root@test ~]# cat /etc/anacrontab</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># /etc/anacrontab: configuration file for anacron</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># See anacron(8) and anacrontab(5) for details.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>SHELL</span><span class=o>=</span>/bin/sh
</span></span><span class=line><span class=cl><span class=nv>PATH</span><span class=o>=</span>/sbin:/bin:/usr/sbin:/usr/bin
</span></span><span class=line><span class=cl><span class=nv>MAILTO</span><span class=o>=</span>root
</span></span><span class=line><span class=cl><span class=c1># the maximal random delay added to the base delay of the jobs</span>
</span></span><span class=line><span class=cl><span class=nv>RANDOM_DELAY</span><span class=o>=</span><span class=m>45</span>                                                                  //这个是随机的延迟时间，表示最大45分钟
</span></span><span class=line><span class=cl><span class=c1># the jobs will be started during the following hours only</span>
</span></span><span class=line><span class=cl><span class=nv>START_HOURS_RANGE</span><span class=o>=</span>3-22                                                           //这个是开始时间
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#period in days   delay in minutes   job-identifier   command</span>
</span></span><span class=line><span class=cl><span class=m>1</span> <span class=m>5</span> cron.daily    nice run-parts /etc/cron.daily
</span></span><span class=line><span class=cl><span class=m>7</span> <span class=m>25</span>  cron.weekly   nice run-parts /etc/cron.weekly
</span></span><span class=line><span class=cl>@monthly <span class=m>45</span> cron.monthly    nice run-parts /etc/cron.monthly
</span></span></code></pre></td></tr></table></div></div><p>第一个是Recurrence period</p><p>第二个是延迟时间</p><p>所以cron.daily会在3:22+(5,45)这个时间段执行，/etc/cron.daily是个文件夹.</p><p>通过默认/etc/anacrontab文件配置，会发现logrotate自动切割日志文件的默认时间是凌晨3点多。</p><p>==================================================================================================</p><p>现在需要将切割时间调整到每天的晚上12点，即每天切割的日志是前一天的0-24点之间的内容。</p><p>操作如下：</p><p>[root@localhost ~]# mv /etc/anacrontab /etc/anacrontab.bak //取消日志自动轮转的设置</p><p>[root@localhost logrotate.d]# cat nstc_nohup.out</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>/data/nstc/nohup.out <span class=o>{</span>
</span></span><span class=line><span class=cl>rotate <span class=m>30</span>
</span></span><span class=line><span class=cl>dateext
</span></span><span class=line><span class=cl>daily
</span></span><span class=line><span class=cl>copytruncate
</span></span><span class=line><span class=cl>compress
</span></span><span class=line><span class=cl>notifempty
</span></span><span class=line><span class=cl>missingok
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>[root@localhost logrotate.d]# cat syslog</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>/var/log/cron
</span></span><span class=line><span class=cl>/var/log/maillog
</span></span><span class=line><span class=cl>/var/log/messages
</span></span><span class=line><span class=cl>/var/log/secure
</span></span><span class=line><span class=cl>/var/log/history
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>    sharedscripts
</span></span><span class=line><span class=cl>    compress
</span></span><span class=line><span class=cl>    rotate <span class=m>30</span>
</span></span><span class=line><span class=cl>    daily
</span></span><span class=line><span class=cl>    dateext
</span></span><span class=line><span class=cl>    postrotate
</span></span><span class=line><span class=cl>    /bin/kill -HUP <span class=sb>`</span>cat /var/run/syslogd.pid 2&gt; /dev/null<span class=sb>`</span> 2&gt; /dev/null <span class=o>||</span> <span class=nb>true</span>
</span></span><span class=line><span class=cl>    endscript
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>结合crontab进行自定义的定时轮转操作</p><p>[root@localhost ~]# crontab -l</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>#log logrotate
</span></span><span class=line><span class=cl>59 23 * * * /usr/sbin/logrotate -f /etc/logrotate.d/syslog &gt;/dev/null 2&gt;&amp;1
</span></span><span class=line><span class=cl>59 23 * * * /usr/sbin/logrotate -f /etc/logrotate.d/nstc_nohup.out &gt;/dev/null 2&gt;&amp;1
</span></span></code></pre></td></tr></table></div></div><p>结果</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[root@localhost ~]# ll /data/nstc/nohup.out*
</span></span><span class=line><span class=cl>-rw------- 1 app app 33218 1月  25 09:43 /data/nstc/nohup.out
</span></span><span class=line><span class=cl>-rw------- 1 app app 67678 1月  25 23:59 /data/nstc/nohup.out-20180125.gz
</span></span></code></pre></td></tr></table></div></div><p>除了利用自带的Logrotate工具实现日志切割之外，还可以编写python脚本或shell脚本以实现日志切割。下面就简单列出几个实例说明下：</p><h3 id=其他工具实现日志切割>其他工具实现日志切割</h3><h4 id=python脚本实现日志切割><strong>Python脚本实现日志切割</strong></h4><p>实例1：对jumpserver日志进行切割</p><p>[root@localhost mnt]# cat log_rotate.py</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=cp>#!/usr/bin/env python
</span></span></span><span class=line><span class=cl><span class=cp></span>import datetime,os,sys,shutil
</span></span><span class=line><span class=cl><span class=nv>log_path</span> <span class=o>=</span> <span class=s1>&#39;/opt/jumpserver/logs/&#39;</span>
</span></span><span class=line><span class=cl><span class=nv>log_file</span> <span class=o>=</span> <span class=s1>&#39;jumpserver.log&#39;</span>
</span></span><span class=line><span class=cl><span class=nv>yesterday</span> <span class=o>=</span> <span class=o>(</span>datetime.datetime.now<span class=o>()</span> - datetime.timedelta<span class=o>(</span><span class=nv>days</span> <span class=o>=</span> 1<span class=o>))</span>
</span></span><span class=line><span class=cl>try:
</span></span><span class=line><span class=cl>    os.makedirs<span class=o>(</span>log_path + yesterday.strftime<span class=o>(</span><span class=s1>&#39;%Y&#39;</span><span class=o>)</span> + os.sep + <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>                yesterday.strftime<span class=o>(</span><span class=s1>&#39;%m&#39;</span><span class=o>))</span>
</span></span><span class=line><span class=cl>except OSError,e:
</span></span><span class=line><span class=cl>    print
</span></span><span class=line><span class=cl>    print e
</span></span><span class=line><span class=cl>    sys.exit<span class=o>()</span>
</span></span><span class=line><span class=cl>shutil.move<span class=o>(</span>log_path + log_file,log_path <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>            + yesterday.strftime<span class=o>(</span><span class=s1>&#39;%Y&#39;</span><span class=o>)</span> + os.sep <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>            + yesterday.strftime<span class=o>(</span><span class=s1>&#39;%m&#39;</span><span class=o>)</span> + os.sep <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>            + log_file + <span class=s1>&#39;_&#39;</span> + yesterday.strftime<span class=o>(</span><span class=s1>&#39;%Y%m%d&#39;</span><span class=o>)</span> + <span class=s1>&#39;.log&#39;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>os.popen<span class=o>(</span><span class=s2>&#34;sudo /opt/jumpserver/service.sh restart&#34;</span><span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><p>手动执行这个脚本：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[root@localhost mnt]# chmod 755 log_rotate.py
</span></span><span class=line><span class=cl>[root@localhost mnt]# python log_rotate.py
</span></span></code></pre></td></tr></table></div></div><p>查看日志切割后的效果：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[root@localhost mnt]# ls /opt/jumpserver/logs/
</span></span><span class=line><span class=cl>2017  jumpserver.log 
</span></span><span class=line><span class=cl>[root@localhost mnt]# ls /opt/jumpserver/logs/2017/
</span></span><span class=line><span class=cl>09
</span></span><span class=line><span class=cl>[root@localhost mnt]# ls /opt/jumpserver/logs/2017/09/
</span></span><span class=line><span class=cl>jumpserver.log_20170916.log
</span></span></code></pre></td></tr></table></div></div><p>然后做每日的定时切割任务：</p><p>[root@localhost mnt]# crontab -e</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=m>30</span> <span class=m>1</span> * * * /usr/bin/python /mnt/log_rotate.py &gt; /dev/null 2&gt;<span class=p>&amp;</span><span class=m>1</span>
</span></span></code></pre></td></tr></table></div></div><p>实例2:对nginx日志进行切割</p><p>[root@localhost mnt]# vim log_rotate.py</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=cp>#!/usr/bin/env python
</span></span></span><span class=line><span class=cl><span class=cp></span>import datetime,os,sys,shutil
</span></span><span class=line><span class=cl><span class=nv>log_path</span> <span class=o>=</span> <span class=s1>&#39;/app/nginx/logs/&#39;</span>
</span></span><span class=line><span class=cl><span class=nv>log_file</span> <span class=o>=</span> <span class=s1>&#39;www_access.log&#39;</span>
</span></span><span class=line><span class=cl><span class=nv>yesterday</span> <span class=o>=</span> <span class=o>(</span>datetime.datetime.now<span class=o>()</span> - datetime.timedelta<span class=o>(</span><span class=nv>days</span> <span class=o>=</span> 1<span class=o>))</span>
</span></span><span class=line><span class=cl>try:
</span></span><span class=line><span class=cl>    os.makedirs<span class=o>(</span>log_path + yesterday.strftime<span class=o>(</span><span class=s1>&#39;%Y&#39;</span><span class=o>)</span> + os.sep + <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>                yesterday.strftime<span class=o>(</span><span class=s1>&#39;%m&#39;</span><span class=o>))</span>
</span></span><span class=line><span class=cl>except OSError,e:
</span></span><span class=line><span class=cl>    print
</span></span><span class=line><span class=cl>    print e
</span></span><span class=line><span class=cl>    sys.exit<span class=o>()</span>
</span></span><span class=line><span class=cl>shutil.move<span class=o>(</span>log_path + log_file,log_path <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>            + yesterday.strftime<span class=o>(</span><span class=s1>&#39;%Y&#39;</span><span class=o>)</span> + os.sep <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>            + yesterday.strftime<span class=o>(</span><span class=s1>&#39;%m&#39;</span><span class=o>)</span> + os.sep <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>            + log_file + <span class=s1>&#39;_&#39;</span> + yesterday.strftime<span class=o>(</span><span class=s1>&#39;%Y%m%d&#39;</span><span class=o>)</span> + <span class=s1>&#39;.log&#39;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>os.popen<span class=o>(</span><span class=s2>&#34;sudo kill -USR1 `cat /app/nginx/logs/nginx.pid`&#34;</span><span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=shell脚本实现日志切割><strong>shell脚本实现日志切割</strong></h4><p>[root@localhost ~]# cat /app/script/log_rotate.sh</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=cp>#!/bin/sh
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=k>function</span> rotate<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl><span class=nv>logs_path</span><span class=o>=</span><span class=nv>$1</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> Rotating Log: <span class=nv>$1</span>
</span></span><span class=line><span class=cl>cp <span class=si>${</span><span class=nv>logs_path</span><span class=si>}</span> <span class=si>${</span><span class=nv>logs_path</span><span class=si>}</span>.<span class=k>$(</span>date -d <span class=s2>&#34;yesterday&#34;</span> +<span class=s2>&#34;%Y%m%d&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>&gt; <span class=si>${</span><span class=nv>logs_path</span><span class=si>}</span>
</span></span><span class=line><span class=cl>    rm -f <span class=si>${</span><span class=nv>logs_path</span><span class=si>}</span>.<span class=k>$(</span>date -d <span class=s2>&#34;7 days ago&#34;</span> +<span class=s2>&#34;%Y%m%d&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=k>for</span> i in <span class=nv>$*</span>
</span></span><span class=line><span class=cl><span class=k>do</span>
</span></span><span class=line><span class=cl>        rotate <span class=nv>$i</span>
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span></code></pre></td></tr></table></div></div><p>每天定时切割日志的任务制定（比如对python的一个业务/data/log/xcspam/下的日志进行切割，0K的日志不进行切割）：</p><p>[root@localhost ~]# crontab -e</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1>#xcspam 日志切割</span>
</span></span><span class=line><span class=cl><span class=m>30</span> <span class=m>0</span> * * * find /data/log/xcspam/ -size +0 -name <span class=s1>&#39;*.log&#39;</span> <span class=p>|</span> xargs /app/script/log_rotate.sh
</span></span></code></pre></td></tr></table></div></div><p>手动执行切割：</p><p>[root@localhost ~]# find /data/log/xcspam/ -size +0 -name &lsquo;*.log&rsquo; | xargs /app/script/log_rotate.sh</p><p>切割后的日志效果：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>[</span>root@qd-vpc-op-consumer01 ~<span class=o>]</span><span class=c1># ls /data/log/xcspam/</span>
</span></span><span class=line><span class=cl>xcspam_error.log xcspam_error.log-20170926
</span></span></code></pre></td></tr></table></div></div><p>比如对maridb日志进行切割</p><p>[root@localhost ~]# crontab -e</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1>#xcspam 日志切割</span>
</span></span><span class=line><span class=cl><span class=m>30</span> <span class=m>0</span> * * * find /var/log/mariadb/ -size +0 -name <span class=s1>&#39;*.log&#39;</span> <span class=p>|</span> xargs /app/script/log_rotate.sh
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>[</span>root@localhost ~<span class=o>]</span><span class=c1># find /var/log/mariadb/ -size +0 -name &#39;*.log&#39; | xargs /app/script/log_rotate.sh</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@localhost ~<span class=o>]</span><span class=c1># ll /var/log/mariadb/</span>
</span></span><span class=line><span class=cl>总用量 <span class=m>8</span>
</span></span><span class=line><span class=cl>-rw-r-----. <span class=m>1</span> mysql mysql    <span class=m>0</span> 9月  <span class=m>17</span> 20:31 mariadb.log
</span></span><span class=line><span class=cl>-rw-r-----. <span class=m>1</span> root  root  <span class=m>4532</span> 9月  <span class=m>17</span> 20:31 mariadb.log.20170916
</span></span></code></pre></td></tr></table></div></div><p>日志压缩脚本：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[root@localhost ~]# ls /var/log/fss/nginx/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>nginx.20190506.log nginx.20190507.log nginx.20190508.log
</span></span></code></pre></td></tr></table></div></div><p>[root@localhost ~]# cat /root/log_clean.sh</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=cp>#!/usr/bin/sh
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1>#根据系统/服务/日志保留天数三个参数压缩日志</span>
</span></span><span class=line><span class=cl><span class=c1>#usage: sh clearlog.sh sysname appname keepdays</span>
</span></span><span class=line><span class=cl><span class=nv>sysName</span><span class=o>=</span><span class=nv>$1</span>
</span></span><span class=line><span class=cl><span class=nv>appName</span><span class=o>=</span><span class=nv>$2</span>
</span></span><span class=line><span class=cl><span class=nv>keepDay</span><span class=o>=</span><span class=nv>$3</span>
</span></span><span class=line><span class=cl><span class=nv>logDir</span><span class=o>=</span>/var/log/<span class=si>${</span><span class=nv>sysName</span><span class=si>}</span>/<span class=si>${</span><span class=nv>appName</span><span class=si>}</span>
</span></span><span class=line><span class=cl><span class=nv>logFile</span><span class=o>=</span><span class=si>${</span><span class=nv>appName</span><span class=si>}</span>.*<span class=o>[</span>0-9<span class=o>][</span>0-9<span class=o>]</span>.log
</span></span><span class=line><span class=cl><span class=nb>cd</span> <span class=si>${</span><span class=nv>logDir</span><span class=si>}</span>
</span></span><span class=line><span class=cl>find ./ -name <span class=s2>&#34;</span><span class=si>${</span><span class=nv>logFile</span><span class=si>}</span><span class=s2>&#34;</span> -mtime -<span class=si>${</span><span class=nv>keepDay</span><span class=si>}</span> -exec gzip <span class=o>{}</span> <span class=se>\;</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[root@localhost ~]# sh /root/log_clean.sh fss nginx 3
</span></span><span class=line><span class=cl>[root@localhost ~]# ls /var/log/fss/nginx/
</span></span><span class=line><span class=cl>nginx.20190506.log.gz  nginx.20190507.log.gz  nginx.20190508.log.gz
</span></span></code></pre></td></tr></table></div></div><p>还可以针对日志保留策略，调整成日志清理脚本。</p><p>推荐用的Nginx日志轮转方法 [部署在nginx的日志目录下]</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=nv>yesterday</span><span class=o>=</span><span class=sb>`</span>date -d <span class=s2>&#34;-1 days&#34;</span> +<span class=s1>&#39;%Y%m%d&#39;</span><span class=sb>`</span>
</span></span><span class=line><span class=cl><span class=nb>cd</span> <span class=sb>`</span>dirname <span class=nv>$0</span><span class=sb>`</span>
</span></span><span class=line><span class=cl><span class=nv>basedir</span><span class=o>=</span><span class=sb>`</span><span class=nb>pwd</span><span class=sb>`</span>
</span></span><span class=line><span class=cl><span class=nv>logdir</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>basedir</span><span class=si>}</span><span class=s2>/bak&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>bindir</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>basedir</span><span class=p>%/*</span><span class=si>}</span><span class=s2>/sbin&#34;</span>
</span></span><span class=line><span class=cl>mkdir -p <span class=si>${</span><span class=nv>logdir</span><span class=si>}</span>
</span></span><span class=line><span class=cl><span class=k>for</span> log in <span class=sb>`</span>ls *.log 2&gt;/dev/null<span class=sb>`</span>
</span></span><span class=line><span class=cl><span class=k>do</span>
</span></span><span class=line><span class=cl>    mv <span class=si>${</span><span class=nv>log</span><span class=si>}</span> <span class=si>${</span><span class=nv>logdir</span><span class=si>}</span>/<span class=si>${</span><span class=nv>log</span><span class=si>}</span>.<span class=si>${</span><span class=nv>yesterday</span><span class=si>}</span>.bak
</span></span><span class=line><span class=cl>    <span class=c1># gzip ${logdir}/${log}.${yesterday}</span>
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span><span class=line><span class=cl><span class=si>${</span><span class=nv>bindir</span><span class=si>}</span>/nginx -s reload
</span></span><span class=line><span class=cl><span class=nb>cd</span> <span class=si>${</span><span class=nv>logdir</span><span class=si>}</span>
</span></span><span class=line><span class=cl>find . -type f -name <span class=s2>&#34;*.bak&#34;</span> -mtime +7 <span class=p>|</span> xargs rm -f
</span></span></code></pre></td></tr></table></div></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2022-02-12</span></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/%E4%BD%BF%E7%94%A8logrotate%E8%BF%9B%E8%A1%8C%E6%97%A5%E5%BF%97%E5%88%87%E5%89%B2/index.md target=_blank>Read Markdown</a></span></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/logrotate/>logrotate</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/windows%E7%BB%93%E6%9D%9F%E8%BF%9B%E7%A8%8B/ class=prev rel=prev title=windows结束进程><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>windows结束进程</a>
<a href=/redhat6.3yum%E6%BA%90%E5%A4%B1%E6%95%88%E8%A7%A3%E5%86%B3/ class=next rel=next title=redhat6.3的yum源失效解决>redhat6.3的yum源失效解决<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><span id=run-time></span></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2021 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>Peng</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=stylesheet href=/lib/katex/copy-tex.min.css><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.css><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/lunr/lunr.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js></script><script type=text/javascript src=/lib/katex/auto-render.min.js></script><script type=text/javascript src=/lib/katex/copy-tex.min.js></script><script type=text/javascript src=/lib/katex/mhchem.min.js></script><script type=text/javascript src=/lib/cookieconsent/cookieconsent.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:0},comment:{},cookieconsent:{content:{dismiss:"Got it!",link:"Learn more",message:"This website uses Cookies to improve your experience."},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:50,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js></script><script type=text/javascript src=/js/custom.js></script>
<script type=text/javascript src=https://cdn.jsdelivr.net/npm/jquery@2.1.3/dist/jquery.min.js></script></body></html>