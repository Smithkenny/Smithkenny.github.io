<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Ubuntu使用下篇 - Peng</title><script async src=http://umami.haipengv.com/script.js data-website-id=2300daa7-4536-434f-bd3b-504e48a633ab></script><meta name=Description content="One World,One Dream!"><meta property="og:title" content="Ubuntu使用下篇"><meta property="og:description" content="一、证书 Ubuntu server 20.04.3 给apache2创建自签名证书 介绍 TLS或“传输层安全”——及其前身**SSL——**是用于将正常流量包装在受保护的加密包装器"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.haipengv.com/ubuntu%E4%BD%BF%E7%94%A8%E4%B8%8B%E7%AF%87/"><meta property="og:image" content="https://blog.haipengv.com/logo.webp"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-08-14T14:52:07+08:00"><meta property="article:modified_time" content="2023-08-14T14:52:07+08:00"><meta property="og:site_name" content="我的网站"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.haipengv.com/logo.webp"><meta name=twitter:title content="Ubuntu使用下篇"><meta name=twitter:description content="一、证书 Ubuntu server 20.04.3 给apache2创建自签名证书 介绍 TLS或“传输层安全”——及其前身**SSL——**是用于将正常流量包装在受保护的加密包装器"><meta name=application-name content="我的网站"><meta name=apple-mobile-web-app-title content="我的网站"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://blog.haipengv.com/ubuntu%E4%BD%BF%E7%94%A8%E4%B8%8B%E7%AF%87/><link rel=prev href=https://blog.haipengv.com/%E6%96%87%E7%AB%A0%E4%B8%AD%E5%9B%BE%E7%89%87%E4%BC%98%E5%8C%96/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Ubuntu使用下篇","inLanguage":"zh-cn","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.haipengv.com\/ubuntu%E4%BD%BF%E7%94%A8%E4%B8%8B%E7%AF%87\/"},"genre":"posts","keywords":"ubuntu","wordcount":9174,"url":"https:\/\/blog.haipengv.com\/ubuntu%E4%BD%BF%E7%94%A8%E4%B8%8B%E7%AF%87\/","datePublished":"2023-08-14T14:52:07+08:00","dateModified":"2023-08-14T14:52:07+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Peng"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=Peng>Peng</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><a class=menu-item href=/friends/><i class='fas fa-fw fa-fan fa-spin'></i> 友链 </a><a class=menu-item href=/about/>关于 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=Peng>Peng</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/posts/ title>文章</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/categories/ title>分类</a><a class=menu-item href=/friends/ title><i class='fas fa-fw fa-fan fa-spin'></i>友链</a><a class=menu-item href=/about/ title>关于</a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class="toc-content always-active" id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Ubuntu使用下篇</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Peng</a>
</span>&nbsp;<span class=post-category>收录于 <a href=/categories/%E5%B7%A5%E5%85%B7/><i class="far fa-folder fa-fw" aria-hidden=true></i>工具</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2023-08-14>2023-08-14</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;约 9174 字&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;预计阅读 19 分钟&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><ul><li><a href=#一证书>一、证书</a><ul><li><a href=#步骤1启用mod_ssl>步骤1：启用mod_ssl</a></li><li><a href=#步骤2创建ssl证书>步骤2：创建ssl证书</a></li><li><a href=#步骤3配置apache使用ssl>步骤3：配置apache使用ssl</a></li><li><a href=#步骤4将http重定向到https>步骤4：将http重定向到https</a></li><li><a href=#控制台安全>控制台安全</a></li><li><a href=#multipass>multipass</a></li></ul></li><li><a href=#二容器>二、容器</a><ul><li><a href=#lxd>LXD</a><ul><li><a href=#创建容器模板>创建容器模板</a></li><li><a href=#配置共享目录>配置共享目录</a></li><li><a href=#容器克隆>容器克隆</a></li><li><a href=#可视化管理>可视化管理</a></li><li><a href=#查看容器日志>查看容器日志</a></li><li><a href=#创建快照>创建快照</a></li><li><a href=#lxd-容器端口暴露使得外面能够访问容器内业务>lxd 容器端口暴露，使得外面能够访问容器内业务。</a></li></ul></li></ul></li><li><a href=#三数据库>三、数据库</a><ul><li><a href=#postgresql>PostgreSQL</a></li></ul></li><li><a href=#四监控>四、监控</a><ul><li><a href=#集群监控软件>集群监控软件</a></li><li><a href=#所需端口>所需端口</a></li></ul></li><li><a href=#五备份>五、备份</a><ul><li><a href=#备份脚本编写>备份脚本编写</a></li><li><a href=#从备份中恢复>从备份中恢复</a></li></ul></li><li><a href=#六邮件服务>六、邮件服务</a></li><li><a href=#七web服务>七、web服务</a><ul><li><a href=#状态码>状态码</a></li><li><a href=#apache2>apache2</a><ul><li><a href=#安装>安装</a></li><li><a href=#配置>配置</a></li></ul></li></ul></li><li><a href=#八密码管理>八、密码管理</a><ul><li><a href=#root密码忘记重置>root密码忘记重置</a></li></ul></li><li><a href=#九ubuntu2004-进入命令行模式>九、ubuntu20.04 进入命令行模式</a></li></ul></li></ul></nav></div></div><div class=content id=content><h3 id=一证书>一、证书</h3><p>Ubuntu server 20.04.3 给apache2创建自签名证书</p><p><strong>介绍</strong></p><p><strong>TLS</strong>或“传输层安全”——及其前身**SSL——**是用于将正常流量包装在受保护的加密包装器中的协议。使用这项技术，服务器可以安全地向其客户端发送信息，而不会被外界拦截或读取其消息。</p><p>**注意：**自签名证书将加密您的服务器和任何客户端之间的通信。但是，由于它不是由 Web 浏览器和操作系统中包含的任何受信任的证书颁发机构签署的，因此用户无法使用该证书来自动验证您的服务器的身份。因此，您的用户在访问您的网站时会看到安全错误。</p><p>由于此限制，自签名证书不适用于为公众服务的生产环境。它们通常用于测试或保护单个用户或一小群用户使用的非关键服务，这些用户可以通过备用通信渠道建立对证书有效性的信任。如需更适合生产的证书解决方案，请查看<a href=https://letsencrypt.org/ target=_blank rel="noopener noreffer">Let&rsquo;s Encrypt</a>
，一个免费的证书颁发机构。</p><p>先决条件</p><ul><li>使用非<strong>root 用户</strong>、启用 sudo 的用户访问 Ubuntu 20.04 服务器。我们的<a href=https://www.digitalocean.com/community/tutorials/initial-server-setup-with-ubuntu-20-04 target=_blank rel="noopener noreffer">Ubuntu 20.04 初始服务器设置</a>
指南可以向您展示如何创建此帐户。</li><li>您还需要安装 Apache。</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo apt update
</span></span></code></pre></td></tr></table></div></div><p>然后，安装<code>apache2</code>软件包：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo apt install apache2
</span></span></code></pre></td></tr></table></div></div><p>最后，如果您<code>ufw</code>设置了防火墙，请打开<code>http</code>和<code>https</code>端口：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo ufw allow <span class=s2>&#34;Apache Full&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=步骤1启用mod_ssl>步骤1：启用mod_ssl</h4><p>在我们可以使用<em>任何</em>SSL 证书之前，我们首先必须启用<code>mod_ssl</code>Apache 模块，它提供对 SSL 加密的支持。</p><p><code>mod_ssl</code>使用以下<code>a2enmod</code>命令启用：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo a2enmod ssl
</span></span></code></pre></td></tr></table></div></div><p>重启Apache激活模块：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo systemctl restart apache2
</span></span></code></pre></td></tr></table></div></div><p>该<code>mod_ssl</code>模块现已启用并可以使用。</p><h4 id=步骤2创建ssl证书>步骤2：创建ssl证书</h4><p>现在 Apache 已准备好使用加密，我们可以继续生成新的 SSL 证书。该证书将存储有关您站点的一些基本信息，并附带一个允许服务器安全处理加密数据的密钥文件。</p><p>我们可以使用以下<code>openssl</code>命令创建 SSL 密钥和证书文件：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo openssl req -x509 -nodes -days <span class=m>365</span> -newkey rsa:2048 -keyout /etc/ssl/private/apache-selfsigned.key -out /etc/ssl/certs/apache-selfsigned.crt
</span></span></code></pre></td></tr></table></div></div><p>参数详解：</p><ul><li><code>openssl</code>：这是用于创建和管理 OpenSSL 证书、密钥和其他文件的命令行工具。</li><li><code>req -x509</code>：这指定我们要使用 X.509 证书签名请求 (CSR) 管理。X.509 是 SSL 和 TLS 遵守的用于密钥和证书管理的公钥基础结构标准。</li><li><code>-nodes</code>：这告诉 OpenSSL 跳过使用密码保护我们的证书的选项。当服务器启动时，我们需要 Apache 能够在没有用户干预的情况下读取文件。密码可以防止这种情况发生，因为我们必须在每次重新启动后输入它。</li><li><code>-days 365</code>：此选项设置证书被视为有效的时间长度。我们在这里设置了一年。许多现代浏览器会拒绝任何有效期超过一年的证书。</li><li><code>-newkey rsa:2048</code>：这指定我们要同时生成新证书和新密钥。我们没有在上一步中创建签署证书所需的密钥，因此我们需要将其与证书一起创建。该<code>rsa:2048</code>部分告诉它制作一个 2048 位长的 RSA 密钥。</li><li><code>-keyout</code>：这一行告诉 OpenSSL 在哪里放置我们正在创建的生成的私钥文件。</li><li><code>-out</code>：这告诉 OpenSSL 在哪里放置我们正在创建的证书。</li></ul><p><strong>最重要的一行是请求<code>Common Name</code>. 您需要输入用于访问服务器的主机名或服务器的公共 IP</strong>。重要的是，此字段与您将放入浏览器地址栏中以访问该站点的任何内容相匹配，因为不匹配会导致更多的安全错误。</p><p>完整的提示列表如下所示：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Country Name (2 letter code) [XX]:US
</span></span><span class=line><span class=cl>State or Province Name (full name) []:Example
</span></span><span class=line><span class=cl>Locality Name (eg, city) [Default City]:Example 
</span></span><span class=line><span class=cl>Organization Name (eg, company) [Default Company Ltd]:Example Inc
</span></span><span class=line><span class=cl>Organizational Unit Name (eg, section) []:Example Dept
</span></span><span class=line><span class=cl>Common Name (eg, your name or your server&#39;s hostname) []:your_domain_or_ip
</span></span><span class=line><span class=cl>Email Address []:webmaster@example.com
</span></span></code></pre></td></tr></table></div></div><p>您创建的两个文件都将放置在<code>/etc/ssl</code>.</p><p>接下来，我们将更新我们的 Apache 配置以使用新的证书和密钥。</p><h4 id=步骤3配置apache使用ssl>步骤3：配置apache使用ssl</h4><p>现在我们有了自签名证书和密钥，我们需要更新我们的 Apache 配置以使用它们。在 Ubuntu 上，您可以将新的 Apache 配置文件（它们必须以 结尾<code>.conf</code>）放入<code>/etc/apache2/sites-available/</code>，它们将在下次重新加载或重新启动 Apache 进程时加载。</p><p>在本教程中，我们将创建一个新的最小配置文件。（如果您已经<code>&lt;Virtualhost></code>设置了Apache并且只需要向其中添加 SSL，您可能需要复制以 开头的配置行<code>SSL</code>，并将<code>VirtualHost</code>端口从切换<code>80</code>到<code>443</code>。我们将<code>80</code>在下一步中处理端口。 )</p><p>在 /etc/apache2/sites-available 目录中打开一个新文件：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo nano /etc/apache2/sites-available/your_domain_or_ip.conf
</span></span></code></pre></td></tr></table></div></div><p>粘贴以下最小的 VirtualHost 配置：</p><p>/etc/apache2/sites-available/your_domain_or_ip.conf</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>&lt;VirtualHost *:443&gt;
</span></span><span class=line><span class=cl>   ServerName your_domain_or_ip
</span></span><span class=line><span class=cl>   DocumentRoot /var/www/your_domain_or_ip
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   SSLEngine on
</span></span><span class=line><span class=cl>   SSLCertificateFile /etc/ssl/certs/apache-selfsigned.crt
</span></span><span class=line><span class=cl>   SSLCertificateKeyFile /etc/ssl/private/apache-selfsigned.key
</span></span><span class=line><span class=cl>&lt;/VirtualHost&gt;
</span></span></code></pre></td></tr></table></div></div><p>请务必将<code>ServerName</code>行更新为您打算寻址服务器的任何方式。这可以是主机名、完整域名或 IP 地址。确保您选择的任何内容与<code>Common Name</code>您在制作证书时选择的内容相匹配。</p><p>剩下的几行指定一个<code>DocumentRoot</code>目录来提供文件，以及将 Apache 指向我们新创建的证书和密钥所需的 SSL 选项。</p><p>现在让我们创建我们<code>DocumentRoot</code>的 HTML 文件并将其放入其中，仅用于测试目的：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo mkdir /var/www/your_domain_or_ip
</span></span></code></pre></td></tr></table></div></div><p><code>index.html</code>使用文本编辑器打开一个新文件：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo nano /var/www/your_domain_or_ip/index.html
</span></span></code></pre></td></tr></table></div></div><p>将以下内容粘贴到空白文件中：</p><p>/var/www/your_domain_or_ip/index.html</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>&lt;h1&gt;it worked!&lt;/h1&gt;
</span></span></code></pre></td></tr></table></div></div><p>当然，这不是一个完整的 HTML 文件，但浏览器很宽松，足以验证我们的配置。</p><p>保存并关闭文件
接下来，我们需要使用<code>a2ensite</code>工具启用配置文件：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo a2ensite your_domain_or_ip.conf
</span></span></code></pre></td></tr></table></div></div><p>接下来，让我们测试一下配置错误：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo apache2ctl configtest
</span></span></code></pre></td></tr></table></div></div><p>如果一切顺利，您将得到如下所示的结果：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>OutputAH00558: apache2: Could not reliably determine the server&#39;s fully qualified domain name, using 127.0.1.1. Set the &#39;ServerName&#39; directive globally to suppress this messageSyntax OK
</span></span></code></pre></td></tr></table></div></div><p>第一行是一条消息，告诉您该<code>ServerName</code>指令未全局设置。如果你想摆脱那条消息，你可以<code>ServerName</code>在<code>/etc/apache2/apache2.conf</code>. 这是可选的，因为该消息不会造成伤害。</p><p>如果您的输出包含<code>Syntax OK</code>在其中，则您的配置文件没有语法错误。我们可以安全地重新加载 Apache 以实现我们的更改：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo systemctl reload apache2
</span></span></code></pre></td></tr></table></div></div><p>现在在浏览器中加载您的站点，确保<code>https://</code>在开始时使用。</p><p>您应该会看到一个错误。这对于自签名证书来说是正常的！浏览器警告您它无法验证服务器的身份，因为我们的证书没有由任何已知的证书颁发机构签署。对于测试目的和个人使用，这可以很好。您应该能够点击进入高级信息或更多信息，然后选择继续。</p><p>执行此操作后，您的浏览器将加载该<code>it worked!</code>消息。</p><p>**注意：**如果您的浏览器根本没有连接到服务器，请确保您的连接没有被防火墙阻止。如果您使用的是<code>ufw</code>，以下命令将打开端口<code>80</code>和<code>443</code>：<code>sudo ufw allow "Apache Full"</code> 复制</p><p>接下来，我们将<code>VirtualHost</code>在我们的配置中添加另一个部分，以提供纯 HTTP 请求并将它们重定向到 HTTPS。</p><h4 id=步骤4将http重定向到https>步骤4：将http重定向到https</h4><p>目前，我们的配置只会响应端口上的 HTTPS 请求<code>443</code>。<code>80</code>即使您想强制加密所有流量，也最好在 port 上做出响应。让我们设置一个<code>VirtualHost</code>来响应这些未加密的请求并将它们重定向到 HTTPS。</p><p>打开我们在前面的步骤中启动的同一个 Apache 配置文件：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo nano /etc/apache2/sites-available/your_domain_or_ip.conf
</span></span></code></pre></td></tr></table></div></div><p>在底部，创建另一个<code>VirtualHost</code>块以匹配端口上的请求<code>80</code>。使用该<code>ServerName</code>指令再次匹配您的域名或 IP 地址。然后，用于<code>Redirect</code>匹配任何请求并将它们发送到 SSL <code>VirtualHost</code>。确保包含尾部斜杠：</p><p>/etc/apache2/sites-available/your_domain_or_ip.conf</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>&lt;VirtualHost *:80&gt;
</span></span><span class=line><span class=cl>    ServerName your_domain_or_ip
</span></span><span class=line><span class=cl>    Redirect / https://your_domain_or_ip/
</span></span><span class=line><span class=cl>&lt;/VirtualHost&gt;
</span></span></code></pre></td></tr></table></div></div><p>完成后保存并关闭此文件，然后再次测试您的配置语法，并重新加载 Apache：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo apachectl configtest
</span></span><span class=line><span class=cl>sudo systemctl reload apache2
</span></span></code></pre></td></tr></table></div></div><p>您可以通过<code>http://</code>在地址前面使用纯文本访问您的站点来测试新的重定向功能。您应该会被<code>https://</code>自动重定向到。</p><p>结果：</p><p>未重定向前访问http://10.4.7.142</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/postimages/%e6%9c%aa%e9%87%8d%e5%ae%9a%e5%90%91%e5%89%8d.webp data-srcset="/postimages/%e6%9c%aa%e9%87%8d%e5%ae%9a%e5%90%91%e5%89%8d.webp, /postimages/%e6%9c%aa%e9%87%8d%e5%ae%9a%e5%90%91%e5%89%8d.webp 1.5x, /postimages/%e6%9c%aa%e9%87%8d%e5%ae%9a%e5%90%91%e5%89%8d.webp 2x" data-sizes=auto alt=/postimages/未重定向前.webp title=未重定向前></p><p>访问：https://10.4.7.142</p><p>将请求到http上的流量重定向到https上后访问：http://10.4.7.142 和 https://10.4.7.142</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/postimages/%e9%87%8d%e5%ae%9a%e5%90%91%e5%90%8e.webp data-srcset="/postimages/%e9%87%8d%e5%ae%9a%e5%90%91%e5%90%8e.webp, /postimages/%e9%87%8d%e5%ae%9a%e5%90%91%e5%90%8e.webp 1.5x, /postimages/%e9%87%8d%e5%ae%9a%e5%90%91%e5%90%8e.webp 2x" data-sizes=auto alt=/postimages/重定向后.webp title=重定向后></p><p>谷歌浏览器f12 security 选项可以查看自建的证书详细信息。</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/postimages/%e8%af%81%e4%b9%a6%e8%af%a6%e7%bb%86%e4%bf%a1%e6%81%af.webp data-srcset="/postimages/%e8%af%81%e4%b9%a6%e8%af%a6%e7%bb%86%e4%bf%a1%e6%81%af.webp, /postimages/%e8%af%81%e4%b9%a6%e8%af%a6%e7%bb%86%e4%bf%a1%e6%81%af.webp 1.5x, /postimages/%e8%af%81%e4%b9%a6%e8%af%a6%e7%bb%86%e4%bf%a1%e6%81%af.webp 2x" data-sizes=auto alt=/postimages/证书详细信息.webp title=证书详细信息></p><h4 id=控制台安全>控制台安全</h4><p>禁用ctrl+alt+delete</p><p>任何对键盘有物理访问权限的人都可以简单地使用Ctrl+Alt+Delete组合键来重新启动服务器，而无需登录。虽然有人可以简单地拔掉电源，但您仍应防止在生产服务器上使用此组合键。这迫使攻击者采取更严厉的措施重启服务器，同时防止意外重启。</p><p>要禁用通过按Ctrl+Alt+Delete组合键执行的重启操作，请运行以下两个命令：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>sudo systemctl mask ctrl-alt-del.target
</span></span><span class=line><span class=cl>sudo systemctl daemon-reload
</span></span></code></pre></td></tr></table></div></div><p><a href="https://multipass.run/?_ga=2.172781731.1854281748.1632272954-1233097571.1631927770" target=_blank rel="noopener noreffer">https://multipass.run/?_ga=2.172781731.1854281748.1632272954-1233097571.1631927770</a></p><h4 id=multipass>multipass</h4><p>Ubuntu虚拟机</p><p><a href="https://multipass.run/?_ga=2.172781731.1854281748.1632272954-1233097571.1631927770" target=_blank rel="noopener noreffer">Multipass</a>
是在 Ubuntu 上创建 Ubuntu VM 的推荐方法。它专为希望通过单个命令获得全新 Ubuntu 环境并可在 Linux、Windows 和 macOS 上运行的开发人员而设计。</p><p>在 Linux 上，它可以快速使用：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>sudo snap install multipass --beta --classic
</span></span></code></pre></td></tr></table></div></div><p>用法：</p><p><strong>查找镜像</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ multipass find
</span></span><span class=line><span class=cl>Image                   Aliases           Version          Description
</span></span><span class=line><span class=cl>core                    core16            <span class=m>20190424</span>         Ubuntu Core <span class=m>16</span>
</span></span><span class=line><span class=cl>core18                                    <span class=m>20190213</span>         Ubuntu Core <span class=m>18</span>
</span></span><span class=line><span class=cl>16.04                   xenial            <span class=m>20190628</span>         Ubuntu 16.04 LTS
</span></span><span class=line><span class=cl>18.04                   bionic,lts        20190627.1       Ubuntu 18.04 LTS
</span></span><span class=line><span class=cl>18.10                   cosmic            <span class=m>20190628</span>         Ubuntu 18.10
</span></span><span class=line><span class=cl>19.04                   disco             <span class=m>20190628</span>         Ubuntu 19.04
</span></span><span class=line><span class=cl>daily:19.10             devel,eoan        <span class=m>20190623</span>         Ubuntu 19.10
</span></span></code></pre></td></tr></table></div></div><p><strong>在当前Ubuntu系统中创建新实例</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ multipass launch ubuntu
</span></span><span class=line><span class=cl>Launching dancing-chipmunk...
</span></span><span class=line><span class=cl>Downloading Ubuntu 18.04 LTS..........
</span></span><span class=line><span class=cl>Launched: dancing chipmunk
</span></span></code></pre></td></tr></table></div></div><p><strong>检查正在运行中的实例</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ multipass info dancing-chipmunk
</span></span><span class=line><span class=cl>Name:           dancing-chipmunk
</span></span><span class=line><span class=cl>State:          RUNNING
</span></span><span class=line><span class=cl>IPv4:           10.125.174.247
</span></span><span class=line><span class=cl>Release:        Ubuntu 18.04.1 LTS
</span></span><span class=line><span class=cl>Image hash:     19e9853d8267 <span class=o>(</span>Ubuntu 18.04 LTS<span class=o>)</span>
</span></span><span class=line><span class=cl>Load:           0.97 0.30 0.10
</span></span><span class=line><span class=cl>Disk usage:     1.1G out of 4.7G
</span></span><span class=line><span class=cl>Memory usage:   85.1M out of 985.4M
</span></span></code></pre></td></tr></table></div></div><p><strong>显示刚才创建实例的详细信息</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ multipass info dancing-chipmunkName:           dancing-chipmunkState:          RUNNINGIPv4:           10.125.174.247Release:        Ubuntu 18.04.1 LTSImage hash:     19e9853d8267 <span class=o>(</span>Ubuntu 18.04 LTS<span class=o>)</span>Load:           0.97 0.30 0.10Disk usage:     1.1G out of 4.7GMemory usage:   85.1M out of 985.4M
</span></span></code></pre></td></tr></table></div></div><p><strong>进入到刚刚创建实例的系统中</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ multipass shell dancing-chipmunk
</span></span><span class=line><span class=cl>Welcome to Ubuntu 18.04.1 LTS <span class=o>(</span>GNU/Linux 4.15.0-42-generic x86_64<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>...
</span></span></code></pre></td></tr></table></div></div><p><strong>在刚刚创建的虚拟机外部查看创建的虚拟机的相关信息</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ multipass <span class=nb>exec</span> dancing-chipmunk -- lsb_release -a
</span></span><span class=line><span class=cl>No LSB modules are available.
</span></span><span class=line><span class=cl>Distributor ID:  Ubuntu
</span></span><span class=line><span class=cl>Description:     Ubuntu 18.04.1 LTS
</span></span><span class=line><span class=cl>Release:         18.04
</span></span><span class=line><span class=cl>Codename:        bionic
</span></span></code></pre></td></tr></table></div></div><p><strong>停止刚才创建的实例</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>multipass stop dancing-chipmunk
</span></span></code></pre></td></tr></table></div></div><p><strong>删除实例</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl> multipass delete dancing-chipmunk
</span></span></code></pre></td></tr></table></div></div><p>它会显示删除了</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>Name                    State             IPv4             Release
</span></span><span class=line><span class=cl>snapcraft-asciinema     STOPPED           --               Ubuntu Snapcraft builder <span class=k>for</span> Core <span class=m>18</span>
</span></span><span class=line><span class=cl>dancing-chipmunk        DELETED           --               Not Available
</span></span></code></pre></td></tr></table></div></div><p><strong>彻底删除</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>multipass purge
</span></span></code></pre></td></tr></table></div></div><h3 id=二容器>二、容器</h3><h4 id=lxd>LXD</h4><p>LXD（发音为 lex-dee）是更轻的管理程序，或轻量级容器管理程序。LXC (lex-see) 是一个在本地系统上创建和管理“容器”的程序。它还提供了一个 API 以允许更高级别的管理器（例如 LXD）管理容器。从某种意义上说，可以将 LXC 与 QEMU 进行比较，同时将 LXD 与 libvirt 进行比较。</p><p>LXC API 处理“容器”。LXD API 处理“远程”，它提供图像和容器。这通过网络扩展了 LXC 功能，并允许对容器迁移和容器映像发布等任务进行简洁的管理。</p><p>LXD 在幕后使用 LXC 来完成一些容器管理任务。但是，它保留自己的容器配置信息并有自己的约定，因此最好不要将经典的 LXC 命令与 LXD 容器一起使用.</p><p>ubuntu server 预装LXD。其他系统可以使用以下命令安装 lxd 包</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo snap install lxd
</span></span></code></pre></td></tr></table></div></div><p>配置</p><p>lxd 初始化（必须以root身份运行）</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo lxd init
</span></span></code></pre></td></tr></table></div></div><p>详细参数：</p><p>LXD Clustering：不需要
New storage pool：需要创建一个存储池
Name of storage pool：给存储池命名
storage backend：存储后端，使用 ZFS
Create a new ZFS pool：需要创建一个 ZFS 池
Use an existing block device：Yes
Path to block device：使用已有的磁盘分区用于 ZFS 的存储后端
MAAS server?：不知道是啥，不需要
New local network bridge?：需要，我只需要使用 LXD 默认的网桥即可
New bridge be called：给网桥命名
IPv4：默认 auto
IPv6：默认 auto
LXD available over the network？：默认 no
Stale cached？：默认 yes
YAML printed？：打印信息，yes/no 都行</p><p>如果不能用root用户，普通用户如lhp 需要加入lxd用户组。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>adduser lhp lxd 
</span></span></code></pre></td></tr></table></div></div><p>查看lxd配置信息</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo lxc info
</span></span></code></pre></td></tr></table></div></div><p>查看默认容器配置</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo lxc profile show default
</span></span></code></pre></td></tr></table></div></div><p>查看容器列表</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo lxc list
</span></span></code></pre></td></tr></table></div></div><h5 id=创建容器模板>创建容器模板</h5><ul><li>配置清华镜像源</li></ul><p><a href=https://mirrors.tuna.tsinghua.edu.cn/help/lxc-images/ target=_blank rel="noopener noreffer">https://mirrors.tuna.tsinghua.edu.cn/help/lxc-images/</a></p><p><strong>LXD/LXC 2.0及以上版本使用镜像加速的方法</strong>:</p><p>创建一个remote链接，指向镜像站即可，或替换掉默认的images链接。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># lxc remote add tuna-images https://mirrors.tuna.tsinghua.edu.cn/lxc-images/ --protocol=simplestreams --public
</span></span><span class=line><span class=cl># lxc image list tuna-images:
</span></span></code></pre></td></tr></table></div></div><ul><li>查看镜像列表，寻找合适的镜像的FINGERPRINT，用于下载(注意选择x86_64架构)</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo lxc image list tuna-images:
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>root@lhp-server:~/snap/lxd/common/config# lxc image list tuna-images:ubuntu <span class=p>|</span> grep x86_64 
</span></span><span class=line><span class=cl><span class=p>|</span> ubuntu/16.04 <span class=o>(</span><span class=m>7</span> more<span class=o>)</span>               <span class=p>|</span> 4f34b9f8a490 <span class=p>|</span> yes    <span class=p>|</span> Ubuntu xenial amd64 <span class=o>(</span>20210924_07:42<span class=o>)</span>    <span class=p>|</span> x86_64       <span class=p>|</span> VIRTUAL-MACHINE <span class=p>|</span> 204.25MB  <span class=p>|</span> Sep 24, <span class=m>2021</span> at 12:00am <span class=o>(</span>UTC<span class=o>)</span> <span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span> ubuntu/16.04 <span class=o>(</span><span class=m>7</span> more<span class=o>)</span>               <span class=p>|</span> 10c1476cf890 <span class=p>|</span> yes    <span class=p>|</span> Ubuntu xenial amd64 <span class=o>(</span>20210924_07:42<span class=o>)</span>    <span class=p>|</span> x86_64       <span class=p>|</span> CONTAINER       <span class=p>|</span> 84.59MB   <span class=p>|</span> Sep 24, <span class=m>2021</span> at 12:00am <span class=o>(</span>UTC<span class=o>)</span> <span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span> ubuntu/16.04/cloud <span class=o>(</span><span class=m>3</span> more<span class=o>)</span>         <span class=p>|</span> 31a69e3218ef <span class=p>|</span> yes    <span class=p>|</span> Ubuntu xenial amd64 <span class=o>(</span>20210924_07:42<span class=o>)</span>    <span class=p>|</span> x86_64       <span class=p>|</span> CONTAINER       <span class=p>|</span> 103.50MB  <span class=p>|</span> Sep 24, <span class=m>2021</span> at 12:00am <span class=o>(</span>UTC<span class=o>)</span> <span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span> ubuntu/16.04/cloud <span class=o>(</span><span class=m>3</span> more<span class=o>)</span>         <span class=p>|</span> b3637c07e450 <span class=p>|</span> yes    <span class=p>|</span> Ubuntu xenial amd64 <span class=o>(</span>20210924_07:42<span class=o>)</span>    <span class=p>|</span> x86_64       <span class=p>|</span> VIRTUAL-MACHINE <span class=p>|</span> 233.88MB  <span class=p>|</span> Sep 24, <span class=m>2021</span> at 12:00am <span class=o>(</span>UTC<span class=o>)</span> <span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span> ubuntu/18.04 <span class=o>(</span><span class=m>7</span> more<span class=o>)</span>               <span class=p>|</span> 89e249e9c85d <span class=p>|</span> yes    <span class=p>|</span> Ubuntu bionic amd64 <span class=o>(</span>20210924_07:42<span class=o>)</span>    <span class=p>|</span> x86_64       <span class=p>|</span> CONTAINER       <span class=p>|</span> 100.45MB  <span class=p>|</span> Sep 24, <span class=m>2021</span> at 12:00am <span class=o>(</span>UTC<span class=o>)</span> <span class=p>|</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>FINGERPRINT是镜像的指纹，在上条命令下查找，ContainerTemplateName为容器模板名称，自己定义</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo lxc launch tuna-images:&lt;FINGERPRINT&gt; &lt;ContainerTemplateName&gt;
</span></span></code></pre></td></tr></table></div></div><ul><li>举例，创建一个名为ubuntu的容器。在lxc清华源中10c1476cf890是Ubuntu16.04的fingerprint</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo lxc launch tuna-images:10c1476cf890 ubuntu
</span></span></code></pre></td></tr></table></div></div><ul><li>进行容器列表查看</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>sudo lxc list
</span></span><span class=line><span class=cl>+--------+---------+----------------------+-----------------------------------------------+-----------+-----------+
</span></span><span class=line><span class=cl>|  NAME  |  STATE  |         IPV4         |                     IPV6                      |   TYPE    | SNAPSHOTS |
</span></span><span class=line><span class=cl>+--------+---------+----------------------+-----------------------------------------------+-----------+-----------+
</span></span><span class=line><span class=cl>| ubuntu | RUNNING | 10.235.54.209 (eth0) | fd42:1082:67cd:27dd:216:3eff:fec0:6ed1 (eth0) | CONTAINER | 0         |
</span></span><span class=line><span class=cl>+--------+---------+----------------------+-----------------------------------------------+-----------+-----------+
</span></span></code></pre></td></tr></table></div></div><ul><li>可进入容器的 root 用户下 bash</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>sudo lxc exec &lt;ContainerTemplateName&gt; bash
</span></span></code></pre></td></tr></table></div></div><ul><li>用户切换</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>sudo susu ubuntu
</span></span></code></pre></td></tr></table></div></div><h5 id=配置共享目录>配置共享目录</h5><ul><li>设置共享目录来实现宿主机与容器之间的文件传输</li><li>设置键值</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo lxc config <span class=nb>set</span> &lt;ContainerTemplateName&gt; security.privileged <span class=nb>true</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>设置共享目录，其中shareName为虚拟的设备名称，lxd会虚拟出该设备并导通接通两者共享目录，path1为宿主机下共享目录路径，path2为容器下共享目录路径</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo lxc config device add &lt;ContainerTemplateName&gt; &lt;shareName&gt; disk <span class=nv>source</span><span class=o>=</span>&lt;path1&gt; <span class=nv>path</span><span class=o>=</span>&lt;path2&gt;
</span></span></code></pre></td></tr></table></div></div><p>实例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>oot@lhp-server:~# lxc config <span class=nb>set</span> ubuntu security.privileged <span class=nb>true</span>
</span></span><span class=line><span class=cl>root@lhp-server:~# lxc config device add ubuntu share disk <span class=nv>source</span><span class=o>=</span>/share <span class=nv>path</span><span class=o>=</span>/media
</span></span><span class=line><span class=cl>Device share added to ubuntu
</span></span></code></pre></td></tr></table></div></div><p>可以在宿主机/media中创建文件测试，容器/share中文件是否存在。</p><p>设置用户名密码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo lxc <span class=nb>exec</span> &lt;ContainerTemplateName&gt; bashpasswd
</span></span></code></pre></td></tr></table></div></div><h5 id=容器克隆>容器克隆</h5><ul><li>克隆容器 参数一为模板容器名称，参数二为目标容器名称</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo lxc copy &lt;ContainerTemplateName&gt; &lt;newContainerName&gt;
</span></span></code></pre></td></tr></table></div></div><ul><li>运行新容器</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo lxc start &lt;newContainerName&gt;
</span></span></code></pre></td></tr></table></div></div><ul><li>进入新容器bash</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo lxc <span class=nb>exec</span> &lt;newContainerName&gt; bash
</span></span></code></pre></td></tr></table></div></div><p>注意，此步骤后需要修改Frp的端口，重新建立内外网穿透，建议修改后使用snapshot快照备份<code>sudo lxc snapshot &lt;ContainerName></code>。</p><p>实例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>root@lhp-server:~# lxc list 
</span></span><span class=line><span class=cl>+---------+---------+----------------------+-----------------------------------------------+-----------+-----------+
</span></span><span class=line><span class=cl><span class=p>|</span>  NAME   <span class=p>|</span>  STATE  <span class=p>|</span>         IPV4         <span class=p>|</span>                     IPV6                      <span class=p>|</span>   TYPE    <span class=p>|</span> SNAPSHOTS <span class=p>|</span>
</span></span><span class=line><span class=cl>+---------+---------+----------------------+-----------------------------------------------+-----------+-----------+
</span></span><span class=line><span class=cl><span class=p>|</span> ubuntu  <span class=p>|</span> RUNNING <span class=p>|</span> 10.235.54.122 <span class=o>(</span>eth0<span class=o>)</span> <span class=p>|</span> fd42:1082:67cd:27dd:216:3eff:fefa:fea3 <span class=o>(</span>eth0<span class=o>)</span> <span class=p>|</span> CONTAINER <span class=p>|</span> <span class=m>0</span>         <span class=p>|</span>
</span></span><span class=line><span class=cl>+---------+---------+----------------------+-----------------------------------------------+-----------+-----------+
</span></span><span class=line><span class=cl><span class=p>|</span> ubuntu2 <span class=p>|</span> STOPPED <span class=p>|</span>                      <span class=p>|</span>                                               <span class=p>|</span> CONTAINER <span class=p>|</span> <span class=m>0</span>         <span class=p>|</span>
</span></span><span class=line><span class=cl>+---------+---------+----------------------+-----------------------------------------------+-----------+-----------+
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>root@lhp-server:~# lxc start ubuntu2 
</span></span><span class=line><span class=cl>root@lhp-server:~# lxc list 
</span></span><span class=line><span class=cl>+---------+---------+----------------------+-----------------------------------------------+-----------+-----------+
</span></span><span class=line><span class=cl><span class=p>|</span>  NAME   <span class=p>|</span>  STATE  <span class=p>|</span>         IPV4         <span class=p>|</span>                     IPV6                      <span class=p>|</span>   TYPE    <span class=p>|</span> SNAPSHOTS <span class=p>|</span>
</span></span><span class=line><span class=cl>+---------+---------+----------------------+-----------------------------------------------+-----------+-----------+
</span></span><span class=line><span class=cl><span class=p>|</span> ubuntu  <span class=p>|</span> RUNNING <span class=p>|</span> 10.235.54.122 <span class=o>(</span>eth0<span class=o>)</span> <span class=p>|</span> fd42:1082:67cd:27dd:216:3eff:fefa:fea3 <span class=o>(</span>eth0<span class=o>)</span> <span class=p>|</span> CONTAINER <span class=p>|</span> <span class=m>0</span>         <span class=p>|</span>
</span></span><span class=line><span class=cl>+---------+---------+----------------------+-----------------------------------------------+-----------+-----------+
</span></span><span class=line><span class=cl><span class=p>|</span> ubuntu2 <span class=p>|</span> RUNNING <span class=p>|</span> 10.235.54.50 <span class=o>(</span>eth0<span class=o>)</span>  <span class=p>|</span>                                               <span class=p>|</span> CONTAINER <span class=p>|</span> <span class=m>0</span>         <span class=p>|</span>
</span></span><span class=line><span class=cl>+---------+---------+----------------------+-----------------------------------------------+-----------+-----------+
</span></span></code></pre></td></tr></table></div></div><h5 id=可视化管理>可视化管理</h5><ul><li>下载源码</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>git clone https://github.com/AdaptiveScale/lxdui.git
</span></span></code></pre></td></tr></table></div></div><ul><li>安装前环境检查</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>https://github.com/AdaptiveScale/lxdui/wiki/Installing-the-Prerequisites
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>git status
</span></span><span class=line><span class=cl>which python 
</span></span><span class=line><span class=cl>python --version 
</span></span><span class=line><span class=cl>pip --version
</span></span><span class=line><span class=cl>apt search python3-virtualenv
</span></span><span class=line><span class=cl>apt install pip <span class=c1>#安装pip</span>
</span></span><span class=line><span class=cl>apt install python3-virtualenv <span class=c1>#安装python虚拟环境</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@lhp-server:~# pip list <span class=p>|</span> grep  virtualenv
</span></span><span class=line><span class=cl>virtualenv             20.0.17 
</span></span></code></pre></td></tr></table></div></div><ul><li>创建虚拟环境并检查环境</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nb>cd</span> /lxdui
</span></span><span class=line><span class=cl>python3 -m venv <span class=nb>test</span>
</span></span><span class=line><span class=cl><span class=nb>source</span> test/bin/activate
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>(</span><span class=nb>test</span><span class=o>)</span> root@lhp-server:~/lxdui# which pip 
</span></span><span class=line><span class=cl>/root/lxdui/test/bin/pip
</span></span><span class=line><span class=cl><span class=o>(</span><span class=nb>test</span><span class=o>)</span> root@lhp-server:~/lxdui# which python 
</span></span><span class=line><span class=cl>/root/lxdui/test/bin/python
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>(</span><span class=nb>test</span><span class=o>)</span> root@lhp-server:~/lxdui# pip list 
</span></span><span class=line><span class=cl>Package       Version
</span></span><span class=line><span class=cl>------------- -------
</span></span><span class=line><span class=cl>pip           20.0.2 
</span></span><span class=line><span class=cl>pkg-resources 0.0.0  
</span></span><span class=line><span class=cl>setuptools    44.0.0 
</span></span></code></pre></td></tr></table></div></div><ul><li>安装LXDUI面板并再次检查环境</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>python3 setup.py install
</span></span><span class=line><span class=cl><span class=o>(</span><span class=nb>test</span><span class=o>)</span> root@lhp-server:~/lxdui# pip list 
</span></span><span class=line><span class=cl>Package             Version  
</span></span><span class=line><span class=cl>------------------- ---------
</span></span><span class=line><span class=cl>certifi             2021.5.30
</span></span><span class=line><span class=cl>cffi                1.15.0rc1
</span></span><span class=line><span class=cl>chardet             3.0.4    
</span></span><span class=line><span class=cl>click               6.7      
</span></span><span class=line><span class=cl>cryptography        3.4.8    
</span></span><span class=line><span class=cl>Flask               1.0      
</span></span><span class=line><span class=cl>Flask-JWT           0.3.2    
</span></span><span class=line><span class=cl>Flask-Login         0.4.1    
</span></span><span class=line><span class=cl>idna                2.7      
</span></span><span class=line><span class=cl>itsdangerous        2.0.1    
</span></span><span class=line><span class=cl>Jinja2              3.0.1    
</span></span><span class=line><span class=cl>jsonschema          2.6.0    
</span></span><span class=line><span class=cl>LXDUI               2.1.2    
</span></span><span class=line><span class=cl>MarkupSafe          2.0.1    
</span></span><span class=line><span class=cl>netaddr             0.7.19   
</span></span><span class=line><span class=cl>pbr                 5.6.0    
</span></span><span class=line><span class=cl>pip                 20.0.2   
</span></span><span class=line><span class=cl>pkg-resources       0.0.0    
</span></span><span class=line><span class=cl>psutil              5.6.6    
</span></span><span class=line><span class=cl>ptyprocess          0.7.0    
</span></span><span class=line><span class=cl>pycparser           2.20     
</span></span><span class=line><span class=cl>PyJWT               1.4.2    
</span></span><span class=line><span class=cl>pylxd               2.2.7    
</span></span><span class=line><span class=cl>pyOpenSSL           17.5.0   
</span></span><span class=line><span class=cl>python-dateutil     2.8.2    
</span></span><span class=line><span class=cl>requests            2.20.0   
</span></span><span class=line><span class=cl>requests-toolbelt   0.9.1    
</span></span><span class=line><span class=cl>requests-unixsocket 0.2.0    
</span></span><span class=line><span class=cl>setuptools          44.0.0   
</span></span><span class=line><span class=cl>six                 1.16.0   
</span></span><span class=line><span class=cl>terminado           0.8.1    
</span></span><span class=line><span class=cl>tornado             5.0.2    
</span></span><span class=line><span class=cl>tornado-xstatic     0.2      
</span></span><span class=line><span class=cl>urllib3             1.24.3   
</span></span><span class=line><span class=cl>Werkzeug            2.0.1    
</span></span><span class=line><span class=cl>ws4py               0.5.1    
</span></span><span class=line><span class=cl>XStatic             1.0.1    
</span></span><span class=line><span class=cl>XStatic-term.js     0.0.7.0 
</span></span></code></pre></td></tr></table></div></div><ul><li>启动面板</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>python3 run.py start
</span></span></code></pre></td></tr></table></div></div><ul><li>登录面板<a href=http://127.0.0.1:15151/ target=_blank rel="noopener noreffer">http://127.0.0.1:15151</a>
，默认账户密码均为admin</li></ul><p><img class=lazyload src=/svg/loading.min.svg data-src=/postimages/lxdui.webp data-srcset="/postimages/lxdui.webp, /postimages/lxdui.webp 1.5x, /postimages/lxdui.webp 2x" data-sizes=auto alt=/postimages/lxdui.webp title=lxdui></p><p>参考：https://blog.csdn.net/CrazyBusby/article/details/114886340</p><p><a href="https://www.youtube.com/watch?v=Fzb6jN6GYL8&amp;ab_channel=JustmeandOpensource" target=_blank rel="noopener noreffer">https://www.youtube.com/watch?v=Fzb6jN6GYL8&ab_channel=JustmeandOpensource</a></p><h5 id=查看容器日志>查看容器日志</h5><p>要查看有关 LXD 本身的调试信息，请在基于 systemd 的主机上使用</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>journalctl -u lxd
</span></span></code></pre></td></tr></table></div></div><p>可以使用以下方式查看容器 c1 的容器日志文件：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>lxc info c1 --show-log
</span></span></code></pre></td></tr></table></div></div><h5 id=创建快照>创建快照</h5><p>可以使用以下<code>lxc move</code>命令重命名和实时迁移容器：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>lxc move c1 final-beta
</span></span></code></pre></td></tr></table></div></div><p>它们也可以被快照：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>lxc snapshot c1 YYYY-MM-DD
</span></span></code></pre></td></tr></table></div></div><p>然后可以通过恢复快照来恢复对 c1 的后续更改：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>lxc restore u1 YYYY-MM-DD
</span></span></code></pre></td></tr></table></div></div><p>也可以通过复制容器或快照来创建新容器：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>lxc copy u1/YYYY-MM-DD testcontainer
</span></span></code></pre></td></tr></table></div></div><p>限制：</p><p>LXD 支持灵活限制容器可以消耗的资源。限制分为以下几类：</p><ul><li>CPU：以多种方式限制容器可用的 CPU。</li><li>磁盘：配置负载下I/O请求的优先级</li><li>RAM：配置内存和交换可用性</li><li>网络：配置负载下的网络优先级</li><li>进程数：限制容器中的并发进程数。</li></ul><h5 id=lxd-容器端口暴露使得外面能够访问容器内业务>lxd 容器端口暴露，使得外面能够访问容器内业务。</h5><p>前提条件：</p><p>lxd容器:Ubuntu</p><p>宿主机:Ubuntu</p><p>lxd容器内安装apache2 ,并将访问端口更改为8080,重启apache2</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>apt install apache2
</span></span><span class=line><span class=cl>vi /etc/apache2/ports.conf 
</span></span><span class=line><span class=cl>Listen <span class=m>8080</span>
</span></span><span class=line><span class=cl>systemctl restart apache2
</span></span></code></pre></td></tr></table></div></div><p>将宿主机的80端口和容器内8080做映射。外部通过访问宿主机的ip+80来访问容器内的业务。</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/postimages/lxc-expose.webp data-srcset="/postimages/lxc-expose.webp, /postimages/lxc-expose.webp 1.5x, /postimages/lxc-expose.webp 2x" data-sizes=auto alt=/postimages/lxc-expose.webp title=lxc-expose></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>lxc config device add ubuntu myport80 proxy <span class=nv>listen</span><span class=o>=</span>tcp:0.0.0.0:80 <span class=nv>connect</span><span class=o>=</span>tcp:127.0.0.1:8080
</span></span></code></pre></td></tr></table></div></div><p>删除映射</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>lxc config device remove ubuntu myport80
</span></span></code></pre></td></tr></table></div></div><h3 id=三数据库>三、数据库</h3><h4 id=postgresql>PostgreSQL</h4><p>PostgreSQL 是一个对象关系数据库系统，它具有传统商业数据库系统的特性，并在下一代 DBMS 系统中进行了增强。</p><p>安装</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo apt install postgresql
</span></span></code></pre></td></tr></table></div></div><p>配置</p><p>要使其他计算机能够连接到您的 PostgreSQL 服务器，请编辑文件 <code>/etc/postgresql/12/main/postgresql.conf</code></p><p>找到*#listen_addresses = &rsquo;localhost&rsquo; 行*并将其更改为：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nv>listen_addresses</span> <span class=o>=</span> <span class=s1>&#39;*&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>笔记</strong></p><p>要同时允许 IPv4 和 IPv6 连接，请将 &rsquo;localhost&rsquo; 替换为 &lsquo;::&rsquo;</p><p>现在我们可以连接到我们的 PostgreSQL 服务器，下一步是为<em>postgres</em>用户设置密码。在终端提示符下运行以下命令以连接到默认的 PostgreSQL 模板数据库：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>sudo -u postgres psql template1
</span></span></code></pre></td></tr></table></div></div><p>上面的命令以用户<em>postgres</em>连接到 PostgreSQL 数据库<em>template1</em>。连接到 PostgreSQL 服务器后，您将看到 SQL 提示符。您可以在 psql 提示符下运行以下 SQL 命令来配置用户<em>postgres</em>的密码。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>ALTER USER postgres with encrypted password &#39;your_password&#39;;
</span></span></code></pre></td></tr></table></div></div><p>配置密码后，编辑文件<code>/etc/postgresql/12/main/pg_hba.conf</code>以对<em>postgres</em>用户使用<em>MD5</em>身份验证：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>local   all         postgres                          md5
</span></span></code></pre></td></tr></table></div></div><p>最后，您应该重新启动 PostgreSQL 服务以初始化新配置。从终端提示输入以下内容以重新启动 PostgreSQL：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>sudo systemctl restart postgresql.service
</span></span></code></pre></td></tr></table></div></div><blockquote><p><strong>警告</strong></p><p>以上配置无论如何都不完整。更多参数请参考《<a href=http://www.postgresql.org/docs/current/static/admin.html target=_blank rel="noopener noreffer">PostgreSQL 管理员指南》</a>
。</p></blockquote><p>您可以使用 PostgreSQL 客户端测试来自其他机器的服务器连接。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>sudo apt install postgresql-client
</span></span><span class=line><span class=cl>psql -h postgres.example.com -U postgres -W 
</span></span></code></pre></td></tr></table></div></div><blockquote><p><strong>笔记</strong></p><p>将域名替换为您的实际服务器域名。</p></blockquote><p>参考：https://ubuntu.com/server/docs/databases-postgresql</p><h3 id=四监控>四、监控</h3><h4 id=集群监控软件>集群监控软件</h4><ul><li>Prometheus</li><li>Prometheus Alertmanager</li><li>Grafana</li><li>Telegraf</li></ul><h4 id=所需端口>所需端口</h4><table><thead><tr><th>Prometheus</th><th>monitor:9090</th></tr></thead><tbody><tr><td>Alertmanager</td><td>monitor:9093</td></tr><tr><td>Grafana</td><td>monitor:3000</td></tr><tr><td>Telegraf</td><td>workload:9273</td></tr></tbody></table><p>nagios 安装</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>https://www.osradar.com/how-to-install-nagios-on-ubuntu-20-04/#:~:text<span class=o>=</span>How%20To%20Install%20Nagios%20on%20Ubuntu%2020.04%201,pre-checks%20are%20okay.%20...%209%20Access%20Web%20Dashboard
</span></span></code></pre></td></tr></table></div></div><p><img class=lazyload src=/svg/loading.min.svg data-src=/postimages/nagios.webp data-srcset="/postimages/nagios.webp, /postimages/nagios.webp 1.5x, /postimages/nagios.webp 2x" data-sizes=auto alt=/postimages/nagios.webp title=nagios></p><h3 id=五备份>五、备份</h3><p>备份软件：</p><p>方案1：bacula</p><p>方案2：NFS+shell script + crontab</p><p>场景：nfs server ：10.4.7.141 共享目录： /mnt/backup</p><p>​ nfs client : 10.4.7.142 新建目录/opt/example 需要与 10.4.7.141的/mnt/backup 目录做绑定。</p><p>server：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo apt install nfs-kernel-server
</span></span><span class=line><span class=cl>sudo systemctl start nfs-kernel-server.service
</span></span></code></pre></td></tr></table></div></div><p>配置：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>vim /etc/exports
</span></span><span class=line><span class=cl>/mnt/backup *<span class=o>(</span>ro,sync,subtree_check<span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><p>如果/mnt/backup 不存在先创建该目录。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>mkdir -p /mnt/backup
</span></span></code></pre></td></tr></table></div></div><p>配置生效</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo exportfs -a
</span></span></code></pre></td></tr></table></div></div><p>client:</p><p>安装nfs客户端</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo apt install nfs-common
</span></span></code></pre></td></tr></table></div></div><p>创建目录</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo mkdir /opt/example
</span></span><span class=line><span class=cl>sudo mount 10.4.7.141:/mnt/backup /opt/example
</span></span></code></pre></td></tr></table></div></div><p>最后需要配置fstab</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>vim /etc/fstab
</span></span><span class=line><span class=cl>10.4.7.141:/mnt/backup /opt/example nfs <span class=nv>rsize</span><span class=o>=</span>8192,wsize<span class=o>=</span>8192,timeo<span class=o>=</span>14,intr
</span></span></code></pre></td></tr></table></div></div><h4 id=备份脚本编写>备份脚本编写</h4><p>场景：定时将client中 /home /var/spool/mail /etc /opt 中文件备份到server 的/mnt/backup 中。每天凌晨12：00 备份一次。</p><p>backup.sh</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1>####################################</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># Backup to NFS mount script.</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1>####################################</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># What to backup. </span>
</span></span><span class=line><span class=cl><span class=nv>backup_files</span><span class=o>=</span><span class=s2>&#34;/home /var/spool/mail /etc /opt&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Where to backup to.</span>
</span></span><span class=line><span class=cl><span class=nv>dest</span><span class=o>=</span><span class=s2>&#34;/mnt/backup&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Create archive filename.</span>
</span></span><span class=line><span class=cl><span class=nv>day</span><span class=o>=</span><span class=k>$(</span>date +%A<span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nv>hostname</span><span class=o>=</span><span class=k>$(</span>hostname -s<span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nv>archive_file</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$hostname</span><span class=s2>-</span><span class=nv>$day</span><span class=s2>.tgz&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Print start status message.</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;Backing up </span><span class=nv>$backup_files</span><span class=s2> to </span><span class=nv>$dest</span><span class=s2>/</span><span class=nv>$archive_file</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>date
</span></span><span class=line><span class=cl><span class=nb>echo</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Backup the files using tar.</span>
</span></span><span class=line><span class=cl>tar czf <span class=nv>$dest</span>/<span class=nv>$archive_file</span> <span class=nv>$backup_files</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Print end status message.</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;Backup finished&#34;</span>
</span></span><span class=line><span class=cl>date
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Long listing of files in $dest to check file sizes.</span>
</span></span><span class=line><span class=cl>ls -lh <span class=nv>$dest</span>
</span></span></code></pre></td></tr></table></div></div><p>crontab</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=m>0</span> <span class=m>0</span> * * * bash  /usr/local/bin/backup.sh
</span></span></code></pre></td></tr></table></div></div><h4 id=从备份中恢复>从备份中恢复</h4><ul><li><p>查看存档内容的列表。从终端提示输入：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>tar -tzvf /mnt/backup/host-Monday.tgz
</span></span></code></pre></td></tr></table></div></div></li><li><p>要将文件从存档恢复到不同的目录，请输入：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>tar -xzvf /mnt/backup/host-Monday.tgz -C /tmp etc/hosts
</span></span></code></pre></td></tr></table></div></div><p>tar的*-C*选项将提取的文件重定向到指定的目录。上面的例子将<code>/etc/hosts</code>文件解压到<code>/tmp/etc/hosts</code>. tar 重新创建它包含的目录结构。</p><p>另外，请注意前导*“/”*不在要恢复的文件路径之外。</p></li><li><p>要恢复存档中的所有文件，请输入以下内容：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>cd /sudo tar -xzvf /mnt/backup/host-Monday.tgz
</span></span></code></pre></td></tr></table></div></div></li></ul><blockquote><p><strong>笔记</strong></p><p>这将覆盖当前文件系统上的文件。</p></blockquote><h3 id=六邮件服务>六、邮件服务</h3><p>dovecot</p><p>postfix</p><h3 id=七web服务>七、web服务</h3><h4 id=状态码>状态码</h4><ul><li><p><strong>1xx</strong> : <em>Informational</em> - 收到请求，继续处理</p></li><li><p><strong>2xx</strong> : <em>成功</em>- 动作被成功接收、理解和接受</p></li><li><p><strong>3xx</strong> : <em>重定向</em>- 必须采取进一步行动才能完成请求</p></li><li><p><strong>4xx</strong> : <em>客户端错误</em>- 请求包含错误的语法或无法完成</p></li><li><p><strong>5xx</strong>： <em>服务器错误</em>- 服务器未能满足明显有效的请求</p></li><li><p><strong>静态 Web 服务器</strong>：服务器响应的内容将是托管文件“原样”。</p></li><li><p><strong>动态 Web 服务器</strong>：由一个 Web 服务器和一个额外的软件组成，通常是一个应用服务器和一个数据库。例如，要生成您在 Web 浏览器中看到的 Web 页面，应用程序服务器可能会用数据库中的内容填充 HTML 模板。因此，我们说服务器响应的内容是动态生成的。</p></li></ul><h4 id=apache2>apache2</h4><p>Apache 是 Linux 系统上最常用的 Web 服务器。Web 服务器用于为客户端计算机请求的网页提供服务。客户端通常使用 Firefox、Opera、Chromium 或 Internet Explorer 等 Web 浏览器应用程序请求和查看网页.</p><p>用于传输网页的最常用协议是超文本传输协议 (HTTP)。还支持诸如基于安全套接字层的超文本传输协议 (HTTPS) 和文件传输协议 (FTP)（用于上传和下载文件的协议）等协议。</p><p>Apache Web 服务器通常与 MySQL 数据库引擎、超文本预处理器 (PHP) 脚本语言和其他流行的脚本语言（如 Python 和 Perl）结合使用。这种配置被称为 LAMP（Linux、Apache、MySQL 和 Perl/Python/PHP），它为基于 Web 的应用程序的开发和部署形成了一个强大而健壮的平台。</p><h5 id=安装>安装</h5><p>在终端提示符下输入以下命令：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>sudo apt install apache2
</span></span></code></pre></td></tr></table></div></div><h5 id=配置>配置</h5><p>Apache2 是通过在纯文本配置文件中放置<em>指令</em>来配置的。这些<em>指令</em>在以下文件和目录之间分开：</p><ul><li><em>apache2.conf：</em> Apache2 的主要配置文件。包含对 Apache2<em>全局的</em>设置。</li><li><em>httpd.conf：<em>历史上主要的 Apache2 配置文件，以 httpd 守护进程命名。在其他发行版（或旧版本的 Ubuntu）中，该文件可能存在。在 Ubuntu 中，所有配置选项已移至</em>apache2.conf</em>及以下引用目录，该文件不再存在。</li><li>*conf-available：*该目录包含可用的配置文件。以前在的所有文件<code>/etc/apache2/conf.d</code>都应移动到<code>/etc/apache2/conf-available</code>.</li><li><em>conf-enabled</em>：<em>持有</em>符号链接*到文件<code>/etc/apache2/conf-available</code>。当配置文件被符号链接时，它将在下次重新启动 apache2 时启用。</li><li><em>envvars：<em>设置Apache2</em>环境</em>变量的文件。</li><li><em>mods-available：<em>此目录包含加载</em>模块</em>和配置它们的配置文件。然而，并非所有模块都有特定的配置文件。</li><li><em>mods-enabled</em>：<em>持有</em>符号链接*到文件<code>/etc/apache2/mods-available</code>。当模块配置文件被符号链接时，它将在下次重新启动 apache2 时启用。</li><li>*ports.conf：*包含确定 Apache2 正在侦听的 TCP 端口的指令。</li><li><em>sites-available:</em>：<em>此目录包含 Apache2</em>虚拟主机的*配置文件。虚拟主机允许为具有单独配置的多个站点配置 Apache2。</li><li><em>sites-enabled</em>：<em>与</em>mods-enabled一样，<code>sites-enabled</code>包含指向<code>/etc/apache2/sites-available</code>目录的符号链接。类似地，当sites-available 中的配置文件被符号链接时，一旦Apache2 重新启动，由它配置的站点将处于活动状态。</li><li>*magic：*根据文件的前几个字节确定 MIME 类型的说明。</li></ul><p>新建站点或虚拟主机</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo cp /etc/apache2/sites-available/000-default.conf /etc/apache2/sites-available/mynewsite.conf
</span></span></code></pre></td></tr></table></div></div><p><strong>最终要访问的域名或IP和/etc/apache2/sites-available/中.conf文件同名</strong></p><p>更改默认监听端口在：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>/etc/apache2/ports.conf
</span></span></code></pre></td></tr></table></div></div><p>您可能还希望您的站点响应<code>www.mynewsite.com</code>，因为许多用户会认为 www 前缀是合适的。为此使用<em>ServerAlias</em>指令。您还可以在 ServerAlias 指令中使用通配符。</p><p>例如，以下配置将使您的站点响应任何以*.mynewsite.com*结尾的域请求。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>ServerAlias *.mynewsite.com
</span></span></code></pre></td></tr></table></div></div><p>默认站点位置：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>/var/www/html
</span></span></code></pre></td></tr></table></div></div><p>示例：将80端口重定向到443端口</p><p>/etc/apache2/sites-available/10.4.7.142.conf</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>&lt;VirtualHost *:443&gt;
</span></span><span class=line><span class=cl>   ServerName 10.4.7.142
</span></span><span class=line><span class=cl>   DocumentRoot /var/www/10.4.7.142
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   SSLEngine on
</span></span><span class=line><span class=cl>   SSLCertificateFile /etc/ssl/certs/apache-selfsigned.crt
</span></span><span class=line><span class=cl>   SSLCertificateKeyFile /etc/ssl/private/apache-selfsigned.key
</span></span><span class=line><span class=cl>&lt;/VirtualHost&gt;
</span></span><span class=line><span class=cl>&lt;VirtualHost *:80&gt;
</span></span><span class=line><span class=cl>    ServerName 10.4.7.142
</span></span><span class=line><span class=cl>    Redirect / https://10.4.7.142/
</span></span><span class=line><span class=cl>&lt;/VirtualHost&gt;
</span></span></code></pre></td></tr></table></div></div><p>站点主页：</p><p>/var/www/10.4.7.142/index.html</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>&lt;h1&gt;it worked!&lt;/h1&gt;
</span></span></code></pre></td></tr></table></div></div><p>自签名证书需要自行创建：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>/etc/ssl/certs/apache-selfsigned.crt 和/etc/ssl/private/apache-selfsigned.key
</span></span></code></pre></td></tr></table></div></div><p>开启应用配置：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo a2ensite l0.4.7.142
</span></span><span class=line><span class=cl>sudo systemctl restart apache2.service
</span></span></code></pre></td></tr></table></div></div><p>禁用站点配置：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo a2dissite 10.4.7.142
</span></span><span class=line><span class=cl>sudo systemctl restart apache2.service
</span></span></code></pre></td></tr></table></div></div><p>启动ssl模块</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo a2enmod ssl
</span></span></code></pre></td></tr></table></div></div><p>您可以通过<code>https://your_hostname/url/</code>在浏览器地址栏中键入来访问安全服务器页面。</p><h3 id=八密码管理>八、密码管理</h3><h4 id=root密码忘记重置>root密码忘记重置</h4><p>重启系统 按F1进入。</p><p>重启Ubuntu 在启动界面选择 （高级）-》</p><p>选择 recovery mode-》</p><p>首先重建GRUB引导，否则改密码可能会出现 <strong>Authentication token manipulation error</strong> 错误-》</p><p>完成后回车，继续选择root</p><p>接下来输入，按照提示修改密码就可以</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>passwd root
</span></span></code></pre></td></tr></table></div></div><p>修改完成后，重启服务器</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>reboot
</span></span></code></pre></td></tr></table></div></div><h3 id=九ubuntu2004-进入命令行模式>九、ubuntu20.04 进入命令行模式</h3><p>启动时禁用GUI</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo systemctl set-default multi-user
</span></span></code></pre></td></tr></table></div></div><p>重新启动或退出当前会话以退出GUI:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>gnome-session-quit
</span></span></code></pre></td></tr></table></div></div><p><strong>恢复图形模式</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo systemctl set-default graphical
</span></span></code></pre></td></tr></table></div></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2023-08-14</span></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/ubuntu%E4%BD%BF%E7%94%A8%E4%B8%8B%E7%AF%87/index.md target=_blank>阅读原始文档</a></span></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/ubuntu/>ubuntu</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/%E6%96%87%E7%AB%A0%E4%B8%AD%E5%9B%BE%E7%89%87%E4%BC%98%E5%8C%96/ class=prev rel=prev title=文章中图片优化><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>文章中图片优化</a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><span id=run-time></span></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2021 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>Peng</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=stylesheet href=/lib/katex/copy-tex.min.css><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.css><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/algoliasearch/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js></script><script type=text/javascript src=/lib/katex/auto-render.min.js></script><script type=text/javascript src=/lib/katex/copy-tex.min.js></script><script type=text/javascript src=/lib/katex/mhchem.min.js></script><script type=text/javascript src=/lib/cookieconsent/cookieconsent.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:0},comment:{},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验."},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{algoliaAppID:"6P2DFXYAL4",algoliaIndex:"myblog",algoliaSearchKey:"97d66d369583b3cd4c58a5890d58ea96",highlightTag:"em",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"algolia"}}</script><script type=text/javascript src=/js/theme.min.js></script><script type=text/javascript src=/js/custom.js></script>
<script type=text/javascript src=https://cdn.jsdelivr.net/npm/jquery@2.1.3/dist/jquery.min.js></script></body></html>