<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>ansible基本环境搭建及升级版本 - Peng</title><meta name=Description content="One World,One Dream!"><meta property="og:title" content="ansible基本环境搭建及升级版本"><meta property="og:description" content="应用场景 Ansible是一个基于Python开发的配置管理和应用部署工具，现在也在自动化管理领域大放异彩。它融合了众多老牌运维工具的优点，P"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.haipengv.com/ansible/"><meta property="og:image" content="https://blog.haipengv.com/logo.webp"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-04-12T10:51:17+00:00"><meta property="article:modified_time" content="2023-07-22T12:59:34+08:00"><meta property="og:site_name" content="我的网站"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.haipengv.com/logo.webp"><meta name=twitter:title content="ansible基本环境搭建及升级版本"><meta name=twitter:description content="应用场景 Ansible是一个基于Python开发的配置管理和应用部署工具，现在也在自动化管理领域大放异彩。它融合了众多老牌运维工具的优点，P"><meta name=application-name content="我的网站"><meta name=apple-mobile-web-app-title content="我的网站"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://blog.haipengv.com/ansible/><link rel=prev href=https://blog.haipengv.com/%E5%9F%BA%E4%BA%8Etcp%E7%9A%84%E7%AE%80%E5%8D%95%E5%A5%97%E6%8E%A5%E5%AD%97%E9%80%9A%E4%BF%A1/><link rel=next href=https://blog.haipengv.com/%E6%A8%A1%E6%8B%9Fssh%E6%89%A7%E8%A1%8C%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"ansible基本环境搭建及升级版本","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.haipengv.com\/ansible\/"},"genre":"posts","keywords":"ansible","wordcount":2485,"url":"https:\/\/blog.haipengv.com\/ansible\/","datePublished":"2022-04-12T10:51:17+00:00","dateModified":"2023-07-22T12:59:34+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Peng"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=Peng>Peng</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><a class=menu-item href=/friends/><i class='fas fa-fw fa-fan fa-spin'></i> 友链 </a><a class=menu-item href=/about/>关于 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=Peng>Peng</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>文章</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/categories/ title>分类</a><a class=menu-item href=/friends/ title><i class='fas fa-fw fa-fan fa-spin'></i>友链</a><a class=menu-item href=/about/ title>关于</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class="toc-content always-active" id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">ansible基本环境搭建及升级版本</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Peng</a>
</span>&nbsp;<span class=post-category>included in <a href=/categories/%E5%B7%A5%E5%85%B7/><i class="far fa-folder fa-fw" aria-hidden=true></i>工具</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2022-04-12>2022-04-12</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;2485 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;5 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#应用场景>应用场景</a></li><li><a href=#ansible主控端搭建>ansible主控端搭建</a><ul><li><a href=#基于docker构建一个ansible镜像>基于docker构建一个ansible镜像</a><ul><li><a href=#编写dockerfile>编写Dockerfile</a></li><li><a href=#创建sourceslist文件>创建sources.list文件</a></li><li><a href=#开始构建>开始构建</a></li><li><a href=#验证镜像>验证镜像</a></li></ul></li><li><a href=#主控端容器创建>主控端容器创建</a><ul><li><a href=#查看容器是否正常启动>查看容器是否正常启动</a></li><li><a href=#进入容器>进入容器</a></li></ul></li></ul></li><li><a href=#ansible被控节点搭建>ansible被控节点搭建</a><ul><li><a href=#使用dockerfile创建被控节点镜像>使用Dockerfile创建被控节点镜像</a></li><li><a href=#创建sourceslist文件同主控端>创建sources.list文件(同主控端)</a></li><li><a href=#开始构建-1>开始构建</a></li><li><a href=#创建3个被控端容器>创建3个被控端容器</a></li><li><a href=#分别进入容器并修改root密码>分别进入容器并修改root密码</a></li></ul></li><li><a href=#在控制端添加所有被控端主机信息>在控制端添加所有被控端主机信息</a><ul><li><a href=#一种明文方式不安全>一种明文方式(不安全)</a></li><li><a href=#另一种密文方式推荐>另一种密文方式（推荐）</a><ul><li><a href=#使用openssl生成随机密码>使用openssl生成随机密码</a></li><li><a href=#使用ansible-vault生成加密后的字符串>使用<code>ansible-vault</code>生成加密后的字符串</a></li><li><a href=#测试>测试</a></li></ul></li><li><a href=#最后还可以免密登录>最后还可以免密登录</a></li></ul></li><li><a href=#ansible参数补全功能><strong>Ansible参数补全功能</strong></a></li><li><a href=#ansible升级到特定版本>ansible升级到特定版本</a><ul><li><a href=#卸载>卸载</a></li><li><a href=#安装新版本>安装新版本</a></li><li><a href=#查询>查询</a></li></ul></li><li><a href=#其他>其他</a><ul><li><a href=#关于debain10系统鼠标右键粘连的解决方法>关于<code>debain10系统</code>鼠标右键粘连的解决方法</a></li></ul></li></ul></nav></div></div><div class=content id=content><h2 id=应用场景>应用场景</h2><p><code>Ansible</code>是一个基于<code>Python</code>开发的配置管理和应用部署工具，现在也在自动化管理领域大放异彩。它融合了众多老牌运维工具的优点，<code>Pubbet和Saltstack</code>能实现的功能，<code>Ansible</code>基本上都可以实现。</p><p><code>Ansible</code>能批量配置、部署、管理一大堆的主机。比如以前需要切换到每个主机上执行的一或多个操作，使用<code>Ansible</code>只需在固定的一台<code>Ansible</code>控制节点上去完成所有主机的操作。</p><h2 id=ansible主控端搭建>ansible主控端搭建</h2><h3 id=基于docker构建一个ansible镜像>基于docker构建一个ansible镜像</h3><h4 id=编写dockerfile>编写Dockerfile</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>FROM debian:10
</span></span><span class=line><span class=cl>COPY sources.list /etc/apt/sources.list
</span></span><span class=line><span class=cl>RUN apt update<span class=p>;</span>apt install -y ansible sshpass vim net-tools procps
</span></span><span class=line><span class=cl>RUN sed -i <span class=s1>&#39;s/^#host_key_checking.*/host_key_checking = False/g&#39;</span> /etc/ansible/ansible.cfg
</span></span><span class=line><span class=cl>CMD <span class=o>[</span><span class=s2>&#34;/bin/bash&#34;</span><span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><p>说明：基于debain10搭建的基础ansible镜像包。</p><h4 id=创建sourceslist文件>创建sources.list文件</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF &gt; sources.list 
</span></span></span><span class=line><span class=cl><span class=s>deb http://mirrors.ustc.edu.cn/debian/ buster main
</span></span></span><span class=line><span class=cl><span class=s>deb-src http://mirrors.ustc.edu.cn/debian/ buster main
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>deb http://mirrors.ustc.edu.cn/debian-security buster/updates main
</span></span></span><span class=line><span class=cl><span class=s>deb-src http://mirrors.ustc.edu.cn/debian-security buster/updates main
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># buster-updates, previously known as &#39;volatile&#39;
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>deb http://mirrors.ustc.edu.cn/debian/ buster-updates main
</span></span></span><span class=line><span class=cl><span class=s>deb-src http://mirrors.ustc.edu.cn/debian/ buster-updates main
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>deb http://mirrors.ustc.edu.cn/debian/ buster-backports main non-free contrib
</span></span></span><span class=line><span class=cl><span class=s>deb-src http://mirrors.ustc.edu.cn/debian/ buster-backports main non-free contrib
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></td></tr></table></div></div><p>注意：<code>sources.list</code>是一个源配置文件，和<code>Dockerfile</code>文件在同一级。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>FROM 意思就是使用哪个基础镜像
</span></span><span class=line><span class=cl>COPY 就是复制本地的哪个文件到容器镜像
</span></span><span class=line><span class=cl>RUN 就是执行一个Linux命令
</span></span><span class=line><span class=cl>CMD 就是设置容器启动的时候需要运行什么程序
</span></span></code></pre></td></tr></table></div></div><h4 id=开始构建>开始构建</h4><p>语法</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl> docker build -t <span class=si>${</span><span class=p>镜像名称:版本</span><span class=si>}</span> .
</span></span></code></pre></td></tr></table></div></div><p>例如</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl> docker build -t debian10/ansible .
</span></span></code></pre></td></tr></table></div></div><p>当不设置版本的时候，默认会给予latest的一个版本标签。</p><p>注意构建过程中报错信息，根据报错信息更改Dockerfile文件内容。</p><h4 id=验证镜像>验证镜像</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>root@localhost ~<span class=o>]</span><span class=c1># docker images | grep ansible</span>
</span></span><span class=line><span class=cl>debain10/ansible       latest      03216dab3d76        <span class=m>23</span> minutes ago      349MB
</span></span></code></pre></td></tr></table></div></div><h3 id=主控端容器创建>主控端容器创建</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker run -it --name ansible-control --privilaged<span class=o>=</span><span class=nb>true</span> -d debain10/ansible sh
</span></span></code></pre></td></tr></table></div></div><h4 id=查看容器是否正常启动>查看容器是否正常启动</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker ps 
</span></span><span class=line><span class=cl>ccb07fbb3515  debain10/ansible  <span class=s2>&#34;sh&#34;</span>  <span class=m>25</span> minutes ago  Up <span class=m>25</span> minutes  ansible-control
</span></span></code></pre></td></tr></table></div></div><h4 id=进入容器>进入容器</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker <span class=nb>exec</span> -it ansible-control bash
</span></span></code></pre></td></tr></table></div></div><p>查看ansible版本</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>root@ccb07fbb3515:/etc/ansible# ansible --version 
</span></span><span class=line><span class=cl>ansible 2.7.7
</span></span><span class=line><span class=cl>  config <span class=nv>file</span> <span class=o>=</span> /etc/ansible/ansible.cfg
</span></span><span class=line><span class=cl>  configured module search <span class=nv>path</span> <span class=o>=</span> <span class=o>[</span><span class=s1>&#39;/root/.ansible/plugins/modules&#39;</span>, <span class=s1>&#39;/usr/share/ansible/plugins/modules&#39;</span><span class=o>]</span>
</span></span><span class=line><span class=cl>  ansible python module <span class=nv>location</span> <span class=o>=</span> /usr/lib/python3/dist-packages/ansible
</span></span><span class=line><span class=cl>  executable <span class=nv>location</span> <span class=o>=</span> /usr/bin/ansible
</span></span><span class=line><span class=cl>  python <span class=nv>version</span> <span class=o>=</span> 3.7.3 <span class=o>(</span>default, Jan <span class=m>22</span> 2021, 20:04:44<span class=o>)</span> <span class=o>[</span>GCC 8.3.0<span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=ansible被控节点搭建>ansible被控节点搭建</h2><h3 id=使用dockerfile创建被控节点镜像>使用Dockerfile创建被控节点镜像</h3><p>Dockerfile文件内容如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>FROM debian:10
</span></span><span class=line><span class=cl>COPY sources.list /etc/apt/sources.list
</span></span><span class=line><span class=cl>RUN apt update<span class=p>;</span>apt install -y vim net-tools procps openssh-server python3.7
</span></span><span class=line><span class=cl>RUN sed -i <span class=s1>&#39;s/^#PermitRootLogin.*/PermitRootLogin yes/g&#39;</span> /etc/ssh/sshd_config<span class=p>;</span>cp /usr/bin/python3.7 /usr/bin/python
</span></span><span class=line><span class=cl>CMD <span class=o>[</span><span class=s2>&#34;/bin/bash&#34;</span><span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><p>这里有一个坑，被控节点中必须安装python，ansible默认会去<code>/usr/bin</code>内找python执行文件。如果没有就会报错。这里安装镜像时就默认安装了<code>python3.7</code>。并将执行文件复制为<code>/usr/bin/python</code>。</p><p>当然<code>openssh-server</code>是必备的，<code>ansible</code>就是基于ssh服务控制服务器的。</p><h3 id=创建sourceslist文件同主控端>创建sources.list文件(同主控端)</h3><h3 id=开始构建-1>开始构建</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl> docker build -t debian10/ansible-node .
</span></span></code></pre></td></tr></table></div></div><h3 id=创建3个被控端容器>创建3个被控端容器</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker run -it --name ansible-node1 --privilaged<span class=o>=</span><span class=nb>true</span> -d debain10/ansible init
</span></span><span class=line><span class=cl>docker run -it --name ansible-node2 --privilaged<span class=o>=</span><span class=nb>true</span> -d debain10/ansible init
</span></span><span class=line><span class=cl>docker run -it --name ansible-node3 --privilaged<span class=o>=</span><span class=nb>true</span> -d debain10/ansible init
</span></span></code></pre></td></tr></table></div></div><h3 id=分别进入容器并修改root密码>分别进入容器并修改root密码</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1>#密码统一修改为123456</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;123456&#34;</span> <span class=p>|</span> passwd --stdin root <span class=c1>#debain10试了下不生效</span>
</span></span><span class=line><span class=cl><span class=c1>#使用以下命令更改</span>
</span></span><span class=line><span class=cl>passwd root
</span></span><span class=line><span class=cl><span class=m>123456</span>
</span></span></code></pre></td></tr></table></div></div><p>最后可以看到一个主控端和3个被控端容器。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>e8e005edfab9        debain/ansible-node                    <span class=s2>&#34;init&#34;</span>                   About an hour ago   Up About an hour                             ansible-node3
</span></span><span class=line><span class=cl>cd03436b2424        debain/ansible-node                    <span class=s2>&#34;init&#34;</span>                   About an hour ago   Up About an hour                             ansible-node2
</span></span><span class=line><span class=cl>88bf589578f5        debain/ansible-node                    <span class=s2>&#34;init&#34;</span>                   About an hour ago   Up About an hour                             ansible-node1
</span></span><span class=line><span class=cl>ccb07fbb3515        debain10/ansible                       <span class=s2>&#34;sh&#34;</span>                     About an hour ago   Up About an hour                             ansible-control
</span></span></code></pre></td></tr></table></div></div><h2 id=在控制端添加所有被控端主机信息>在控制端添加所有被控端主机信息</h2><p>有两种方法</p><h3 id=一种明文方式不安全>一种明文方式(不安全)</h3><p>在/etc/ansible/hosts文件添加下面的内容（覆盖）</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>node1 <span class=nv>ansible_ssh_host</span><span class=o>=</span>172.18.0.5 <span class=nv>ansible_ssh_port</span><span class=o>=</span><span class=m>22</span> <span class=nv>ansible_ssh_pass</span><span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl>node2 <span class=nv>ansible_ssh_host</span><span class=o>=</span>172.18.0.6 <span class=nv>ansible_ssh_port</span><span class=o>=</span><span class=m>22</span> <span class=nv>ansible_ssh_pass</span><span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl>node3 <span class=nv>ansible_ssh_host</span><span class=o>=</span>172.18.0.7 <span class=nv>ansible_ssh_port</span><span class=o>=</span><span class=m>22</span> <span class=nv>ansible_ssh_pass</span><span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl><span class=o>[</span>hello<span class=o>]</span>
</span></span><span class=line><span class=cl>node1
</span></span><span class=line><span class=cl>node2
</span></span><span class=line><span class=cl>node3
</span></span></code></pre></td></tr></table></div></div><h3 id=另一种密文方式推荐>另一种密文方式（推荐）</h3><h4 id=使用openssl生成随机密码>使用openssl生成随机密码</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>openssl rand -out vault_password_file -base64 <span class=m>128</span> 
</span></span><span class=line><span class=cl><span class=c1>#cat vault_password_file</span>
</span></span><span class=line><span class=cl>eBqrIFYQ7XDJKjTywZwc26KElu1NQwwx5su3pzj21c4H33RQUV4kslL+UHVEJzxN
</span></span><span class=line><span class=cl>sYIEbklwL7la+sugcSoK5PutqZ79bXnvT7FkEk2pMFNUO4W13/R3pH1AFAddAvsC
</span></span><span class=line><span class=cl>h+YG1mxTCUsNbCwgtngCkAe9cBcLbkbLMVxjQ+dZym4<span class=o>=</span>
</span></span><span class=line><span class=cl><span class=c1>#最小化权限并上锁。</span>
</span></span><span class=line><span class=cl>chmod a-w vault_password_file
</span></span><span class=line><span class=cl>chattr +i vault_password_file
</span></span></code></pre></td></tr></table></div></div><p>删除文件前先解锁</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>chattr -i vault_password_file
</span></span></code></pre></td></tr></table></div></div><p>关于openssl补充：</p><p>openssl生成随机数</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>openssl rand <span class=o>[</span>-out file<span class=o>]</span> <span class=o>[</span>-rand file<span class=o>(</span>s<span class=o>)]</span> <span class=o>[</span>-base64<span class=o>]</span> <span class=o>[</span>-hex<span class=o>]</span> num
</span></span><span class=line><span class=cl>常用选项有：
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>-out file：将生成的随机数保存至指定文件中
</span></span><span class=line><span class=cl>-base64：使用base64 编码格式
</span></span><span class=line><span class=cl>-hex：使用16进制编码格式
</span></span></code></pre></td></tr></table></div></div><h4 id=使用ansible-vault生成加密后的字符串>使用<code>ansible-vault</code>生成加密后的字符串</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>root@ccb07fbb3515:~# ansible-vault encrypt_string &#34;123456&#34; -name ansible_ssh_pass 
</span></span><span class=line><span class=cl>The number of --name options do not match the number of args.
</span></span><span class=line><span class=cl>The last named variable will be &#34;ame&#34;. The rest will not have names.
</span></span><span class=line><span class=cl># The encrypted version of variable (&#34;ame&#34;, the string #1 from the command line args).
</span></span><span class=line><span class=cl>ame: !vault |
</span></span><span class=line><span class=cl>         $ANSIBLE_VAULT;1.1;AES256
</span></span><span class=line><span class=cl>         35643865643061373962376261653765333233333839353937643134643437396262646338363965
</span></span><span class=line><span class=cl>		 3366666561653365663164386536363963353961313362350a626662366361303434383665306531
</span></span><span class=line><span class=cl>		 34386161363965363634626663343832363664623139336665313131623732343437633439386264
</span></span><span class=line><span class=cl>		 6534663962663337640a363166383137613835383966396431326165663732646337653235646239
</span></span><span class=line><span class=cl>		 3534
</span></span><span class=line><span class=cl># The encrypted version of the string #2 from the command line args.)
</span></span><span class=line><span class=cl>!vault |
</span></span><span class=line><span class=cl>         $ANSIBLE_VAULT;1.1;AES256
</span></span><span class=line><span class=cl>         34306239353764383165316133636366633131366332326362323830613638633263353638656562
</span></span><span class=line><span class=cl>	     3736396133633063623863623739326132383062373533300a613036646534353033363134383532          66333366633537643737333065313866396137663965393530653262616132633236663561336164
</span></span><span class=line><span class=cl>	     3633393361616162340a343931653762613765366339356632366135326464336532313562643432
</span></span><span class=line><span class=cl>	     38386533653231626365303837653831346263646464633430643765396239366334
</span></span><span class=line><span class=cl>Encryption successful
</span></span></code></pre></td></tr></table></div></div><p>最后修改主机文件<code>/etc/ansible/hosts</code>配置(使用yaml风格)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>all</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>node1</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ansible_host</span><span class=p>:</span><span class=w> </span><span class=m>172.18.0.5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ansible_ssh_port</span><span class=p>:</span><span class=w> </span><span class=m>22</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ansible_ssh_pass</span><span class=p>:</span><span class=w> </span>!<span class=l>vault |</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=l>$ANSIBLE_VAULT;1.1;AES256</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=m>35643865643061373962376261653765333233333839353937643134643437396262646338363965</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=l>3366666561653365663164386536363963353961313362350a626662366361303434383665306531</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=m>34386161363965363634626663343832363664623139336665313131623732343437633439386264</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=l>6534663962663337640a363166383137613835383966396431326165663732646337653235646239</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=m>3534</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>node2</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ansible_host</span><span class=p>:</span><span class=w> </span><span class=m>172.18.0.6</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ansible_ssh_port</span><span class=p>:</span><span class=w> </span><span class=m>22</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ansible_ssh_pass</span><span class=p>:</span><span class=w> </span>!<span class=l>vault |</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=l>$ANSIBLE_VAULT;1.1;AES256</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=m>35643865643061373962376261653765333233333839353937643134643437396262646338363965</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=l>3366666561653365663164386536363963353961313362350a626662366361303434383665306531</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=m>34386161363965363634626663343832363664623139336665313131623732343437633439386264</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=l>6534663962663337640a363166383137613835383966396431326165663732646337653235646239</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=m>3534</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>node3</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ansible_host</span><span class=p>:</span><span class=w> </span><span class=m>172.18.0.7</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ansible_ssh_port</span><span class=p>:</span><span class=w> </span><span class=m>22</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ansible_ssh_pass</span><span class=p>:</span><span class=w> </span>!<span class=l>vault |</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=l>$ANSIBLE_VAULT;1.1;AES256</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=m>35643865643061373962376261653765333233333839353937643134643437396262646338363965</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=l>3366666561653365663164386536363963353961313362350a626662366361303434383665306531</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=m>34386161363965363634626663343832363664623139336665313131623732343437633439386264</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=l>6534663962663337640a363166383137613835383966396431326165663732646337653235646239</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=m>3534</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>...</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>yaml格式参考<a href=https://docs.ansible.com/ansible-core/devel/reference_appendices/YAMLSyntax.html target=_blank rel="noopener noreffer">官网</a></p><p>这里的ssh端口还有另一种写法</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ansible_port: <span class=m>22</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=测试>测试</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>root@ccb07fbb3515:/etc/ansible# ansible all -m ping
</span></span><span class=line><span class=cl>node1 <span class=p>|</span> <span class=nv>SUCCESS</span> <span class=o>=</span>&gt; <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;changed&#34;</span>: false,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;ping&#34;</span>: <span class=s2>&#34;pong&#34;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>node3 <span class=p>|</span> <span class=nv>SUCCESS</span> <span class=o>=</span>&gt; <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;changed&#34;</span>: false,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;ping&#34;</span>: <span class=s2>&#34;pong&#34;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>node2 <span class=p>|</span> <span class=nv>SUCCESS</span> <span class=o>=</span>&gt; <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;changed&#34;</span>: false,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;ping&#34;</span>: <span class=s2>&#34;pong&#34;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>重启其中一个主机的服务</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>root@ccb07fbb3515:/etc/ansible# ansible node1 -m <span class=nb>command</span> -a <span class=s2>&#34;systemctl restart cron&#34;</span>
</span></span><span class=line><span class=cl>node1 <span class=p>|</span> CHANGED <span class=p>|</span> <span class=nv>rc</span><span class=o>=</span><span class=m>0</span> &gt;&gt;
</span></span></code></pre></td></tr></table></div></div><p>查看所有主机的内核版本</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ansible all -m <span class=nb>command</span> -a <span class=s2>&#34;uname -a&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>node1 <span class=p>|</span> CHANGED <span class=p>|</span> <span class=nv>rc</span><span class=o>=</span><span class=m>0</span> &gt;&gt;
</span></span><span class=line><span class=cl>Linux cd03436b2424 4.18.0-147.5.1.el8_1.x86_64 <span class=c1>#1 SMP Wed Feb 5 02:00:39 UTC 2020 x86_64 GNU/Linux</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>node2 <span class=p>|</span> CHANGED <span class=p>|</span> <span class=nv>rc</span><span class=o>=</span><span class=m>0</span> &gt;&gt;
</span></span><span class=line><span class=cl>Linux e8e005edfab9 4.18.0-147.5.1.el8_1.x86_64 <span class=c1>#1 SMP Wed Feb 5 02:00:39 UTC 2020 x86_64 GNU/Linux</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>node3 <span class=p>|</span> CHANGED <span class=p>|</span> <span class=nv>rc</span><span class=o>=</span><span class=m>0</span> &gt;&gt;
</span></span><span class=line><span class=cl>Linux 88bf589578f5 4.18.0-147.5.1.el8_1.x86_64 <span class=c1>#1 SMP Wed Feb 5 02:00:39 UTC 2020 x86_64 GNU/Linux</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=最后还可以免密登录>最后还可以免密登录</h3><p>主控端使用ssh-keygen生成公钥和私钥，通过sshpass传递到被控端。输入被控端用户名和密码。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=nb>read</span> -p <span class=s1>&#39;input user: &#39;</span> USER
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$USER</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>read</span> -s -p <span class=s1>&#39;input pass: &#39;</span> PASS
</span></span><span class=line><span class=cl>rm -f /root/.ssh/id_rsa
</span></span><span class=line><span class=cl><span class=o>(</span>ssh-keygen -P <span class=s2>&#34;&#34;</span> -f /root/.ssh/id_rsa<span class=o>)</span> <span class=p>&amp;</span>&gt;/dev/null
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> i in <span class=o>{</span>5..7<span class=o>}</span>
</span></span><span class=line><span class=cl><span class=k>do</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nv>IP_host</span><span class=o>=</span>172.18.0.<span class=si>${</span><span class=nv>i</span><span class=si>}</span>
</span></span><span class=line><span class=cl>    ping  -c <span class=m>1</span> -w <span class=m>1</span> <span class=si>${</span><span class=nv>IP_host</span><span class=si>}</span> <span class=p>&amp;</span>&gt;/dev/null
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[</span> <span class=nv>$?</span> -eq <span class=m>0</span> <span class=o>]</span><span class=p>;</span><span class=k>then</span>
</span></span><span class=line><span class=cl>        <span class=o>(</span>sshpass -p <span class=si>${</span><span class=nv>PASS</span><span class=si>}</span> ssh-copy-id -o <span class=nv>StrictHostKeyChecking</span><span class=o>=</span>no <span class=si>${</span><span class=nv>IP_host</span><span class=si>}</span><span class=o>)</span> <span class=p>&amp;</span>&gt;/dev/null
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> -e <span class=s2>&#34;\e[1;32m </span><span class=si>${</span><span class=nv>IP_host</span><span class=si>}</span><span class=s2>    ok \e[0m&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span></code></pre></td></tr></table></div></div><p>然后ansible的配置文件hosts里可以不写密码了。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>web</span><span class=p>:</span><span class=w> </span><span class=c>#组名1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>node1</span><span class=p>:</span><span class=w> </span><span class=c>#被控主机1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ansible_host</span><span class=p>:</span><span class=w> </span><span class=m>172.18.0.5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ansible_ssh_port</span><span class=p>:</span><span class=w> </span><span class=m>22</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>node2</span><span class=p>:</span><span class=w> </span><span class=c>#被控主机2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ansible_host</span><span class=p>:</span><span class=w> </span><span class=m>172.18.0.6</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ansible_ssh_port</span><span class=p>:</span><span class=w> </span><span class=m>22</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apache</span><span class=p>:</span><span class=w> </span><span class=c>#组名2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>node3</span><span class=p>:</span><span class=w> </span><span class=c>#被控主机3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ansible_host</span><span class=p>:</span><span class=w> </span><span class=m>172.18.0.7</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ansible_ssh_port</span><span class=p>:</span><span class=w> </span><span class=m>22</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>node4</span><span class=p>:</span><span class=w> </span><span class=c>#被控主机4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ansible_host</span><span class=p>:</span><span class=w> </span><span class=m>172.18.0.8</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ansible_ssh_port</span><span class=p>:</span><span class=w> </span><span class=m>22</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>...</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=ansible参数补全功能><strong>Ansible参数补全功能</strong></h2><p>从Ansible 2.9版本开始，ansible支持命令的选项补全功能，它依赖于python的argcomplete插件</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>aptitude install python-argcomplete -y <span class=c1>#安装</span>
</span></span><span class=line><span class=cl>activate-global-python-argcomplete   <span class=c1>#激活</span>
</span></span></code></pre></td></tr></table></div></div><p>激活后，就可以按两次tab补全命令和选项了。</p><h2 id=ansible升级到特定版本>ansible升级到特定版本</h2><h3 id=卸载>卸载</h3><p>查看当前版本</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ansible --version
</span></span><span class=line><span class=cl>ansible 2.7.7
</span></span></code></pre></td></tr></table></div></div><p>安装debain包管理器<code>aptitude</code>,它可以自动解决包依赖问题。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>apt install aptitude -y
</span></span></code></pre></td></tr></table></div></div><p>卸载旧版本的ansible</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>aptitude remove ansible*
</span></span></code></pre></td></tr></table></div></div><p>查看ansible依赖包是否没卸载干净</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>apt list <span class=p>|</span> grep ansible*
</span></span></code></pre></td></tr></table></div></div><h3 id=安装新版本>安装新版本</h3><p>debain 系统下ansible所有版本</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>https://packages.debian.org/buster-backports/all/ansible/download
</span></span></code></pre></td></tr></table></div></div><p>本次下载2.9.16版本的安装包进行升级</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>wget http://ftp.cn.debian.org/debian/pool/main/a/ansible/ansible_2.9.16+dfsg-1~bpo10+2_all.deb
</span></span></code></pre></td></tr></table></div></div><p>安装</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>aptitude install ansible_2.9.16+dfsg-1~bpo10+2_all.deb
</span></span></code></pre></td></tr></table></div></div><p>最新版支持<code>python3</code>，可以下载。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>aptitude install python3
</span></span></code></pre></td></tr></table></div></div><h3 id=查询>查询</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ansible --version 
</span></span><span class=line><span class=cl>ansible 2.9.16
</span></span><span class=line><span class=cl>  config <span class=nv>file</span> <span class=o>=</span> /etc/ansible/ansible.cfg
</span></span><span class=line><span class=cl>  configured module search <span class=nv>path</span> <span class=o>=</span> <span class=o>[</span><span class=s1>&#39;/root/.ansible/plugins/modules&#39;</span>, <span class=s1>&#39;/usr/share/ansible/plugins/modules&#39;</span><span class=o>]</span>
</span></span><span class=line><span class=cl>  ansible python module <span class=nv>location</span> <span class=o>=</span> /usr/lib/python3/dist-packages/ansible
</span></span><span class=line><span class=cl>  executable <span class=nv>location</span> <span class=o>=</span> /usr/bin/ansible
</span></span><span class=line><span class=cl>  python <span class=nv>version</span> <span class=o>=</span> 3.7.3 <span class=o>(</span>default, Jan <span class=m>22</span> 2021, 20:04:44<span class=o>)</span> <span class=o>[</span>GCC 8.3.0<span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=其他>其他</h2><h3 id=关于debain10系统鼠标右键粘连的解决方法>关于<code>debain10系统</code>鼠标右键粘连的解决方法</h3><p>编辑<code> vim</code> 的默认配置文件</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>vi /usr/share/vim/vim81/defaults.vim
</span></span><span class=line><span class=cl><span class=c1>#第79行</span>
</span></span><span class=line><span class=cl><span class=k>if</span> has<span class=o>(</span><span class=s1>&#39;mouse&#39;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nb>set</span> <span class=nv>mouse</span><span class=o>=</span>a
</span></span><span class=line><span class=cl>endif
</span></span><span class=line><span class=cl><span class=c1>#set mouse=a 改为set mouse-=a</span>
</span></span><span class=line><span class=cl>保存退出
</span></span></code></pre></td></tr></table></div></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2023-07-22</span></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/ansible/index.md target=_blank>Read Markdown</a></span></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/ansible/>ansible</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/%E5%9F%BA%E4%BA%8Etcp%E7%9A%84%E7%AE%80%E5%8D%95%E5%A5%97%E6%8E%A5%E5%AD%97%E9%80%9A%E4%BF%A1/ class=prev rel=prev title=基于tcp的简单套接字通信><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>基于tcp的简单套接字通信</a>
<a href=/%E6%A8%A1%E6%8B%9Fssh%E6%89%A7%E8%A1%8C%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4/ class=next rel=next title=模拟ssh执行远程命令>模拟ssh执行远程命令<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><span id=run-time></span></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2021 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>Peng</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=stylesheet href=/lib/katex/copy-tex.min.css><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.css><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/lunr/lunr.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js></script><script type=text/javascript src=/lib/katex/auto-render.min.js></script><script type=text/javascript src=/lib/katex/copy-tex.min.js></script><script type=text/javascript src=/lib/katex/mhchem.min.js></script><script type=text/javascript src=/lib/cookieconsent/cookieconsent.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:0},comment:{},cookieconsent:{content:{dismiss:"Got it!",link:"Learn more",message:"This website uses Cookies to improve your experience."},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:50,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>