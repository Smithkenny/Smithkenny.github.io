<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>k8s集群搭建 - Peng</title><meta name=Description content="One World,One Dream!"><meta property="og:title" content="k8s集群搭建"><meta property="og:description" content="Kubernetes （1.22.2）安装手册（Ubuntu非高可用版） 安装前准备工作 （重要！）安装k8s 1.22.2 版本需要的硬件条件： 所有节点： cpu数量2个及以上 4G"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.haipengv.com/k8s%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/"><meta property="og:image" content="https://blog.haipengv.com/logo.webp"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-01-02T18:15:28+00:00"><meta property="article:modified_time" content="2022-01-02T18:15:28+00:00"><meta property="og:site_name" content="我的网站"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.haipengv.com/logo.webp"><meta name=twitter:title content="k8s集群搭建"><meta name=twitter:description content="Kubernetes （1.22.2）安装手册（Ubuntu非高可用版） 安装前准备工作 （重要！）安装k8s 1.22.2 版本需要的硬件条件： 所有节点： cpu数量2个及以上 4G"><meta name=application-name content="我的网站"><meta name=apple-mobile-web-app-title content="我的网站"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://blog.haipengv.com/k8s%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/><link rel=prev href=https://blog.haipengv.com/ubuntu%E7%B3%BB%E7%BB%9F%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E/><link rel=next href=https://blog.haipengv.com/nginx%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"k8s集群搭建","inLanguage":"zh-cn","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.haipengv.com\/k8s%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA\/"},"genre":"posts","keywords":"k8s","wordcount":3773,"url":"https:\/\/blog.haipengv.com\/k8s%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA\/","datePublished":"2022-01-02T18:15:28+00:00","dateModified":"2022-01-02T18:15:28+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Peng"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=Peng>Peng</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><a class=menu-item href=/friends/><i class='fas fa-fw fa-fan fa-spin'></i> 友链 </a><a class=menu-item href=/about/>关于 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=Peng>Peng</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/posts/ title>文章</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/categories/ title>分类</a><a class=menu-item href=/friends/ title><i class='fas fa-fw fa-fan fa-spin'></i>友链</a><a class=menu-item href=/about/ title>关于</a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class="toc-content always-active" id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">k8s集群搭建</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Peng</a>
</span>&nbsp;<span class=post-category>收录于 <a href=/categories/%E7%BC%96%E7%A8%8B/><i class="far fa-folder fa-fw" aria-hidden=true></i>编程</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2022-01-02>2022-01-02</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;约 3773 字&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;预计阅读 8 分钟&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#安装前准备工作>安装前准备工作</a><ul><li><a href=#重要安装k8s-1222-版本需要的硬件条件>（重要！）安装k8s 1.22.2 版本需要的硬件条件：</a></li><li><a href=#1-设置hosts解析>1. 设置hosts解析</a></li><li><a href=#2-调整系统配置>2. 调整系统配置</a></li><li><a href=#3-安装docker>3. 安装docker</a></li><li><a href=#给kubectl-设置别名为k永久生效>给kubectl 设置别名为k，永久生效。</a></li><li><a href=#使用kubectl中的强制删除命令>使用kubectl中的强制删除命令</a></li><li><a href=#自动补全>自动补全</a></li></ul></li><li><a href=#部署kubernetes>部署kubernetes</a><ul><li><a href=#1-安装-kubeadm-kubelet-和-kubectl>1. 安装 kubeadm, kubelet 和 kubectl</a></li><li><a href=#2-初始化配置文件>2. 初始化配置文件</a></li><li><a href=#3-提前下载镜像>3. 提前下载镜像</a></li><li><a href=#4-初始化master节点>4. 初始化master节点</a></li><li><a href=#5-添加slave节点到集群中>5. 添加slave节点到集群中</a></li><li><a href=#6-安装calico插件>6. 安装calico插件</a></li><li><a href=#7-验证集群>7. 验证集群</a></li><li><a href=#8-清理环境>8. 清理环境</a></li></ul></li></ul></nav></div></div><div class=content id=content><h1 id=kubernetes-1222安装手册ubuntu非高可用版>Kubernetes （1.22.2）安装手册（Ubuntu非高可用版）</h1><h2 id=安装前准备工作>安装前准备工作</h2><h3 id=重要安装k8s-1222-版本需要的硬件条件>（重要！）安装k8s 1.22.2 版本需要的硬件条件：</h3><p>所有节点：</p><p><strong>cpu数量2个及以上</strong></p><p>4G 以上内存</p><p>不用开虚拟化</p><p><strong>(重要！！)虚拟机不要用克隆，每台都要单独创建否则会出问题。</strong></p><p>未安装docker 之前创建一个快照。</p><p>安装docker、kubelet，并初始化集群后在创建一个快照。</p><p>未安装cni插件之前创建一个快照，以便于随时更改calico 和fluence</p><p>kubeadm 初始化失败检查，重置kubeadm。</p><p>ip 地址规划：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Shell data-lang=Shell><span class=line><span class=cl>master: 10.4.7.60/24 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>gw:10.4.7.254
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>dns:114.114.114.114
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>worker1: 10.4.7.61/24
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>gw:10.4.7.254
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>dns:114.114.114.114
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>worker1: 10.4.7.61/24
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>gw:10.4.7.254
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>dns:114.114.114.114
</span></span></code></pre></td></tr></table></div></div><p><strong>各节点安装时需要更换apt源：(更新和安装deb包都很快！！！)</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Shell data-lang=Shell><span class=line><span class=cl>http://mirrors.tuna.tsinghua.edu.cn/ubuntu/
</span></span></code></pre></td></tr></table></div></div><h3 id=1-设置hosts解析>1. 设置hosts解析</h3><p>操作节点：所有节点（<code>master</code>）均需执行</p><ul><li><strong>修改hostname</strong>
hostname必须只能包含小写字母、数字、","、"-"，且开头结尾必须是小写字母或数字</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Shell data-lang=Shell><span class=line><span class=cl><span class=c1># 在master节点</span>
</span></span><span class=line><span class=cl>hostnamectl set-hostname master <span class=c1>#设置master节点的hostname</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># slave1节点</span>
</span></span><span class=line><span class=cl>hostnamectl set-hostname worker1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># slave2节点</span>
</span></span><span class=line><span class=cl>hostnamectl set-hostname worker2
</span></span></code></pre></td></tr></table></div></div><h3 id=2-调整系统配置>2. 调整系统配置</h3><p>操作节点： 所有的master和slave节点（<code>master,k8s-slave</code>）需要执行</p><blockquote><p>本章下述操作均以master为例，其他节点均是相同的操作（ip和hostname的值换成对应机器的真实值）</p></blockquote><p><strong>设置iptables</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Shell data-lang=Shell><span class=line><span class=cl>iptables -P FORWARD ACCEPT
</span></span><span class=line><span class=cl>/etc/init.d/ufw stop
</span></span><span class=line><span class=cl>ufw disable
</span></span></code></pre></td></tr></table></div></div><ul><li><strong>关闭swap</strong></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Shell data-lang=Shell><span class=line><span class=cl>swapoff -a
</span></span><span class=line><span class=cl><span class=c1># 防止开机自动挂载 swap 分区</span>
</span></span><span class=line><span class=cl>rm /swap.img  
</span></span><span class=line><span class=cl>sed -i <span class=s1>&#39;/ swap / s/^\(.*\)$/#\1/g&#39;</span> /etc/fstab
</span></span></code></pre></td></tr></table></div></div><ul><li><strong>修改内核参数</strong></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Shell data-lang=Shell><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF &gt;  /etc/sysctl.d/k8s.conf
</span></span></span><span class=line><span class=cl><span class=s>net.bridge.bridge-nf-call-ip6tables = 1
</span></span></span><span class=line><span class=cl><span class=s>net.bridge.bridge-nf-call-iptables = 1
</span></span></span><span class=line><span class=cl><span class=s>net.ipv4.ip_forward=1
</span></span></span><span class=line><span class=cl><span class=s>vm.max_map_count=262144
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>modprobe br_netfilter
</span></span><span class=line><span class=cl>sysctl -p /etc/sysctl.d/k8s.conf
</span></span></code></pre></td></tr></table></div></div><ul><li>设置apt源</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Shell data-lang=Shell><span class=line><span class=cl>apt-get update <span class=o>&amp;&amp;</span> apt-get install -y apt-transport-https ca-certificates software-properties-common 
</span></span><span class=line><span class=cl>curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg <span class=p>|</span> apt-key add - 
</span></span><span class=line><span class=cl>curl -fsSL https://mirrors.ustc.edu.cn/docker-ce/linux/ubuntu/gpg <span class=p>|</span> sudo apt-key add -
</span></span><span class=line><span class=cl>add-apt-repository <span class=s2>&#34;deb [arch=amd64] https://mirrors.ustc.edu.cn/docker-ce/linux/ubuntu </span><span class=k>$(</span>lsb_release -cs<span class=k>)</span><span class=s2> stable&#34;</span>
</span></span><span class=line><span class=cl>add-apt-repository <span class=s2>&#34;deb [arch=amd64] https://mirrors.aliyun.com/kubernetes/apt kubernetes-xenial main&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>apt-get update   
</span></span><span class=line><span class=cl><span class=c1>#若上步出现NO_PUBLICKEY问题，参考https://www.cnblogs.com/jiangzuo/p/13667011.html</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=3-安装docker>3. 安装docker</h3><p>操作节点： 所有节点</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>apt</span><span class=o>-</span><span class=n>get</span> <span class=n>install</span> <span class=n>docker</span><span class=o>-</span><span class=n>ce</span><span class=o>=</span><span class=mi>5</span><span class=p>:</span><span class=mf>20.10.9</span><span class=o>~</span><span class=mi>3</span><span class=o>-</span><span class=mi>0</span><span class=o>~</span><span class=n>ubuntu</span><span class=o>-</span><span class=n>focal</span>
</span></span><span class=line><span class=cl><span class=n>systemctl</span> <span class=n>enable</span> <span class=n>docker</span> <span class=o>&amp;&amp;</span> <span class=n>systemctl</span> <span class=n>start</span> <span class=n>docker</span>
</span></span></code></pre></td></tr></table></div></div><p>注意要关闭docker 默认的cgroup 否则会出现kubeadm 初始化失败！！！！</p><p>这是cgroup驱动问题。默认情况下Kubernetes cgroup驱动程序设置为system，但docker设置为systemd。我们需要更改Docker cgroup驱动，通过创建配置文件<code>/etc/docker/daemon.json</code>并添加以下行：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=p>{</span><span class=s2>&#34;exec-opts&#34;</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;native.cgroupdriver=systemd&#34;</span><span class=p>]}</span>
</span></span></code></pre></td></tr></table></div></div><p>然后，为使配置生效，你必须重启docker和kubelet。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Shell data-lang=Shell><span class=line><span class=cl>systemctl daemon-reloadsystemctl restart dockersystemctl restart kubelet
</span></span></code></pre></td></tr></table></div></div><p>重置kubeadm</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Shell data-lang=Shell><span class=line><span class=cl>sudo kubeadm reset
</span></span></code></pre></td></tr></table></div></div><p>查看所有节点是否有污点</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Shell data-lang=Shell><span class=line><span class=cl>kubectl get nodes -o json <span class=p>|</span> jq <span class=s1>&#39;.items[].spec.taints&#39;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=给kubectl-设置别名为k永久生效>给kubectl 设置别名为k，永久生效。</h3><p>退出当前用户在进入就生效了。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Shell data-lang=Shell><span class=line><span class=cl>vi .bashrc
</span></span><span class=line><span class=cl><span class=nb>alias</span> <span class=nv>k</span><span class=o>=</span><span class=s1>&#39;kubectl&#39;</span>
</span></span><span class=line><span class=cl><span class=nb>source</span> ~/.bashrc
</span></span></code></pre></td></tr></table></div></div><p>删除master节点上的污点，删除后pod可以调度到master上。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Shell data-lang=Shell><span class=line><span class=cl>kubectl taint nodes --all node-role.kubernetes.io/master-
</span></span></code></pre></td></tr></table></div></div><h3 id=使用kubectl中的强制删除命令>使用kubectl中的强制删除命令</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Shell data-lang=Shell><span class=line><span class=cl>kubectl delete pod podName -n NAMESPACE --force --grace-period<span class=o>=</span><span class=m>0</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=自动补全>自动补全</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Shell data-lang=Shell><span class=line><span class=cl>apt install bash-completion
</span></span><span class=line><span class=cl>// locate bash_completion
</span></span><span class=line><span class=cl><span class=nb>source</span> /usr/share/bash-completion/bash_completion
</span></span><span class=line><span class=cl><span class=nb>source</span> &lt;<span class=o>(</span>kubectl completion bash<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;source &lt;(kubectl completion bash)&#34;</span> &gt;&gt; ~/.bashrc
</span></span><span class=line><span class=cl><span class=nb>source</span> ~/.bashrc
</span></span></code></pre></td></tr></table></div></div><p>查看所有pod</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Shell data-lang=Shell><span class=line><span class=cl>kubectl get po -owide  -A 
</span></span></code></pre></td></tr></table></div></div><h2 id=部署kubernetes>部署kubernetes</h2><h3 id=1-安装-kubeadm-kubelet-和-kubectl>1. 安装 kubeadm, kubelet 和 kubectl</h3><p>操作节点： 所有的master和slave节点(<code>master,k8s-slave</code>) 需要执行</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Shell data-lang=Shell><span class=line><span class=cl>apt-get install <span class=nv>kubelet</span><span class=o>=</span>1.22.2-00 <span class=nv>kubectl</span><span class=o>=</span>1.22.2-00 <span class=nv>kubeadm</span><span class=o>=</span>1.22.2-00
</span></span><span class=line><span class=cl><span class=c1>## 查看kubeadm 版本</span>
</span></span><span class=line><span class=cl>kubeadm version
</span></span><span class=line><span class=cl><span class=c1>## 设置kubelet开机启动</span>
</span></span><span class=line><span class=cl>systemctl <span class=nb>enable</span> kubelet 
</span></span></code></pre></td></tr></table></div></div><h3 id=2-初始化配置文件>2. 初始化配置文件</h3><p>操作节点： 只在master节点（<code>master</code>）执行</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Shell data-lang=Shell><span class=line><span class=cl>kubeadm config print init-defaults &gt; kubeadm.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>apiVersion: kubeadm.k8s.io/v1beta3
</span></span><span class=line><span class=cl>bootstrapTokens:
</span></span><span class=line><span class=cl>- groups:
</span></span><span class=line><span class=cl>  - system:bootstrappers:kubeadm:default-node-token
</span></span><span class=line><span class=cl>  token: abcdef.0123456789abcdef
</span></span><span class=line><span class=cl>  ttl: 24h0m0s
</span></span><span class=line><span class=cl>  usages:
</span></span><span class=line><span class=cl>  - signing
</span></span><span class=line><span class=cl>  - authentication
</span></span><span class=line><span class=cl>kind: InitConfigurationx
</span></span><span class=line><span class=cl>localAPIEndpoint:
</span></span><span class=line><span class=cl>  advertiseAddress: 10.4.7.60 <span class=c1>#修改为master 的IP</span>
</span></span><span class=line><span class=cl>  bindPort: <span class=m>6443</span>
</span></span><span class=line><span class=cl>nodeRegistration:
</span></span><span class=line><span class=cl>  criSocket: /var/run/dockershim.sock
</span></span><span class=line><span class=cl>  name: node     <span class=c1># 删掉此行，删掉此行，删掉此行</span>
</span></span><span class=line><span class=cl>  imagePullPolicy: IfNotPresent
</span></span><span class=line><span class=cl>  taints: null
</span></span><span class=line><span class=cl>---
</span></span><span class=line><span class=cl>apiServer:
</span></span><span class=line><span class=cl>  timeoutForControlPlane: 4m0s
</span></span><span class=line><span class=cl>apiVersion: kubeadm.k8s.io/v1beta3
</span></span><span class=line><span class=cl>certificatesDir: /etc/kubernetes/pki
</span></span><span class=line><span class=cl>clusterName: kubernetes
</span></span><span class=line><span class=cl>controllerManager: <span class=o>{}</span>
</span></span><span class=line><span class=cl>dns: <span class=o>{}</span>
</span></span><span class=line><span class=cl>etcd:
</span></span><span class=line><span class=cl>  local:
</span></span><span class=line><span class=cl>    dataDir: /var/lib/etcd
</span></span><span class=line><span class=cl>imageRepository: registry.aliyuncs.com/google_containers
</span></span><span class=line><span class=cl>kind: ClusterConfiguration
</span></span><span class=line><span class=cl>kubernetesVersion: 1.22.2
</span></span><span class=line><span class=cl>networking:
</span></span><span class=line><span class=cl>  dnsDomain: cluster.local
</span></span><span class=line><span class=cl>  podSubnet: 10.244.0.0/16   <span class=c1>#添加此行</span>
</span></span><span class=line><span class=cl>  serviceSubnet: 10.96.0.0/12
</span></span><span class=line><span class=cl>scheduler: <span class=o>{}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=3-提前下载镜像>3. 提前下载镜像</h3><p>操作节点：只在master节点（<code>master</code>）执行</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Shell data-lang=Shell><span class=line><span class=cl><span class=c1># 提前下载镜像到本地</span>
</span></span><span class=line><span class=cl>kubeadm config images pull --config kubeadm.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>config/images<span class=o>]</span> Pulled registry.aliyuncs.com/google_containers/kube-apiserver:v1.22.2
</span></span><span class=line><span class=cl><span class=o>[</span>config/images<span class=o>]</span> Pulled registry.aliyuncs.com/google_containers/kube-controller-manager:v1.22.2
</span></span><span class=line><span class=cl><span class=o>[</span>config/images<span class=o>]</span> Pulled registry.aliyuncs.com/google_containers/kube-scheduler:v1.22.2
</span></span><span class=line><span class=cl><span class=o>[</span>config/images<span class=o>]</span> Pulled registry.aliyuncs.com/google_containers/kube-proxy:v1.22.2
</span></span><span class=line><span class=cl><span class=o>[</span>config/images<span class=o>]</span> Pulled registry.aliyuncs.com/google_containers/pause:3.5
</span></span><span class=line><span class=cl><span class=o>[</span>config/images<span class=o>]</span> Pulled registry.aliyuncs.com/google_containers/etcd:3.5.0-0
</span></span><span class=line><span class=cl><span class=o>[</span>config/images<span class=o>]</span> Pulled registry.aliyuncs.com/google_containers/coredns:v1.8.4
</span></span></code></pre></td></tr></table></div></div><h3 id=4-初始化master节点>4. 初始化master节点</h3><p>操作节点：只在master节点（<code>k8s-master</code>）执行</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Shell data-lang=Shell><span class=line><span class=cl>kubeadm init --config kubeadm.yaml
</span></span></code></pre></td></tr></table></div></div><p>若初始化成功后，最后会提示如下信息：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Shell data-lang=Shell><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>To start using your cluster, you need to run the following as a regular user:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  mkdir -p <span class=nv>$HOME</span>/.kube
</span></span><span class=line><span class=cl>  sudo cp -i /etc/kubernetes/admin.conf <span class=nv>$HOME</span>/.kube/config
</span></span><span class=line><span class=cl>  sudo chown <span class=k>$(</span>id -u<span class=k>)</span>:<span class=k>$(</span>id -g<span class=k>)</span> <span class=nv>$HOME</span>/.kube/config
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Alternatively, <span class=k>if</span> you are the root user, you can run:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nb>export</span> <span class=nv>KUBECONFIG</span><span class=o>=</span>/etc/kubernetes/admin.conf
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>You should now deploy a pod network to the cluster.
</span></span><span class=line><span class=cl>Run <span class=s2>&#34;kubectl apply -f [podnetwork].yaml&#34;</span> with one of the options listed at:
</span></span><span class=line><span class=cl>  https://kubernetes.io/docs/concepts/cluster-administration/addons/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Then you can join any number of worker nodes by running the following on each as root:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kubeadm join 10.4.7.60:6443 --token abcdef.0123456789abcdef <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>        --discovery-token-ca-cert-hash sha256:3a7987c9f5007ebac7980e6614281ee0e064c760c8db012471f9f662289cc9ce
</span></span></code></pre></td></tr></table></div></div><p>接下来按照上述提示信息操作，配置kubectl客户端的认证</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Shell data-lang=Shell><span class=line><span class=cl>mkdir -p <span class=nv>$HOME</span>/.kube
</span></span><span class=line><span class=cl>sudo cp -i /etc/kubernetes/admin.conf <span class=nv>$HOME</span>/.kube/config
</span></span><span class=line><span class=cl>sudo chown <span class=k>$(</span>id -u<span class=k>)</span>:<span class=k>$(</span>id -g<span class=k>)</span> <span class=nv>$HOME</span>/.kube/config
</span></span></code></pre></td></tr></table></div></div><blockquote><p>**⚠️注意：**此时使用 kubectl get nodes查看节点应该处于notReady状态，因为还未配置网络插件</p><p>若执行初始化过程中出错，根据错误信息调整后，执行kubeadm reset后再次执行init操作即可</p></blockquote><h3 id=5-添加slave节点到集群中>5. 添加slave节点到集群中</h3><p>操作节点：所有的slave节点（<code>worker1</code>`worker2`）需要执行
在每台slave节点，执行如下命令，该命令是在kubeadm init成功后提示信息中打印出来的，需要替换成实际init后打印出的命令。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Shell data-lang=Shell><span class=line><span class=cl>kubeadm join 10.4.7.60:6443 --token abcdef.0123456789abcdef <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>        --discovery-token-ca-cert-hash sha256:3a7987c9f5007ebac7980e6614281ee0e064c760c8db012471f9f662289cc9ce
</span></span></code></pre></td></tr></table></div></div><h3 id=6-安装calico插件>6. 安装calico插件</h3><p>操作节点：只在master节点（<code>master</code>）执行</p><p><strong>方式一：直接安装</strong>（未使用！！！）</p><ul><li><p>下载资源文件</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Shell data-lang=Shell><span class=line><span class=cl>wget https://docs.projectcalico.org/manifests/calico-etcd.yaml
</span></span></code></pre></td></tr></table></div></div></li><li><p>修改配置</p><ul><li><p>注释掉文件的前22行</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=m>1</span><span class=w> </span>---<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>2 # Source</span><span class=p>:</span><span class=w> </span><span class=l>calico/templates/calico-etcd-secrets.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=m>3</span><span class=w> </span><span class=c># The following contains k8s Secrets for use with a TLS enabled etcd cluster.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=m>4</span><span class=w> </span><span class=c># For information on populating Secrets, see http://kubernetes.io/docs/user-guide/secrets/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>5 #apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>6 #kind</span><span class=p>:</span><span class=w> </span><span class=l>Secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>7 #type</span><span class=p>:</span><span class=w> </span><span class=l>Opaque</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>8 #metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>9 #  name</span><span class=p>:</span><span class=w> </span><span class=l>calico-etcd-secrets</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>10 #  namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>11 #data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=m>12</span><span class=w>   </span><span class=c># Populate the following with etcd TLS configuration if desired, but leave blank if</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=m>13</span><span class=w>   </span><span class=c># not using TLS for etcd.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=m>14</span><span class=w>   </span><span class=c># The keys below should be uncommented and the values populated with the base64</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=m>15</span><span class=w>   </span><span class=c># encoded contents of each file that would be associated with the TLS data.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>16   # Example command for encoding a file contents</span><span class=p>:</span><span class=w> </span><span class=l>cat &lt;file&gt; | base64 -w 0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>17   # etcd-key</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>18   # etcd-cert</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>19   # etcd-ca</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=m>20</span><span class=w> </span>---<span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>21 # Source</span><span class=p>:</span><span class=w> </span><span class=l>calico/templates/calico-config.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=m>22</span><span class=w> </span><span class=c># This ConfigMap is used to configure a self-hosted Calico installation.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>23 kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>24 apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>25 metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>26   name</span><span class=p>:</span><span class=w> </span><span class=l>calico-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>27   namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=l>...</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>修改configmap</p><p>注意30-35行，其中etcd_endpoints换成环境的etcd地址</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w> </span><span class=nt>23 kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>24 apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>25 metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>26   name</span><span class=p>:</span><span class=w> </span><span class=l>calico-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>27   namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>28 data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=m>29</span><span class=w>   </span><span class=c># Configure this with the location of your etcd cluster.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>30   etcd_endpoints</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;https://10.4.7.60:2379&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=m>31</span><span class=w>   </span><span class=c># If you&#39;re using TLS enabled etcd uncomment the following.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=m>32</span><span class=w>   </span><span class=c># You must also populate the Secret below with these files.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>33   etcd_ca</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/calico-secrets/etcd-ca&#34;</span><span class=w>   </span><span class=c># &#34;/calico-secrets/etcd-ca&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>34   etcd_cert</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/calico-secrets/etcd-cert&#34;</span><span class=w> </span><span class=c># &#34;/calico-secrets/etcd-cert&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>35   etcd_key</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/calico-secrets/etcd-key&#34;</span><span class=w>  </span><span class=c># &#34;/calico-secrets/etcd-key&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=m>36</span><span class=w>   </span><span class=c># Typha is disabled.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>37   typha_service_name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;none&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=m>38</span><span class=w>   </span><span class=c># Configure the backend to use.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>39   calico_backend</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;bird&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>添加calico-node环境变量</p><p>注意297-302行为新添加</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>285       containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=m>286</span><span class=w>         </span><span class=c># Runs calico-node container on each Kubernetes node. This</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=m>287</span><span class=w>         </span><span class=c># container programs network policy and routes on each</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=m>288</span><span class=w>         </span><span class=c># host.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>289         - name</span><span class=p>:</span><span class=w> </span><span class=l>calico-node</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>290           image</span><span class=p>:</span><span class=w> </span><span class=l>docker.io/calico/node:v3.20.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>291           envFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>292           - configMapRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=m>293</span><span class=w>               </span><span class=c># Allow KUBERNETES_SERVICE_HOST and KUBERNETES_SERVICE_PORT to be overridden for eBPF mode.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>294               name</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes-services-endpoint</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>295               optional</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>296           env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>297             - name</span><span class=p>:</span><span class=w> </span><span class=l>KUBERNETES_SERVICE_HOST</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>298               value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;10.4.7.60&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>299             - name</span><span class=p>:</span><span class=w> </span><span class=l>KUBERNETES_SERVICE_PORT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>300               value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;6443&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>301             - name</span><span class=p>:</span><span class=w> </span><span class=l>KUBERNETES_SERVICE_PORT_HTTPS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>302               value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;6443&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=m>303</span><span class=w>             </span><span class=c># The location of the etcd cluster.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>304             - name</span><span class=p>:</span><span class=w> </span><span class=l>ETCD_ENDPOINTS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>305               valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>306                 configMapKeyRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>307                   name</span><span class=p>:</span><span class=w> </span><span class=l>calico-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>308                   key</span><span class=p>:</span><span class=w> </span><span class=l>etcd_endpoints</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=m>309</span><span class=w>             </span><span class=c># Location of the CA certificate for etcd.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>310             - name</span><span class=p>:</span><span class=w> </span><span class=l>ETCD_CA_CERT_FILE</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>修改CIDR</p><p>注意371-372行，value值为k8s集群初始化的pod-network-cidr</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=m>370</span><span class=w>             </span><span class=c># no effect. This should fall within `--cluster-cidr`.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>371             - name</span><span class=p>:</span><span class=w> </span><span class=l>CALICO_IPV4POOL_CIDR</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>372               value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;10.244.0.0/16&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=m>373</span><span class=w>             </span><span class=c># Disable file logging so `kubectl logs` works.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>374             - name</span><span class=p>:</span><span class=w> </span><span class=l>CALICO_DISABLE_FILE_LOGGING</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>375               value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>创建secret</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Shell data-lang=Shell><span class=line><span class=cl>kubectl -n kube-system create secret generic calico-etcd-secrets --from-file<span class=o>=</span>etcd-ca<span class=o>=</span>/etc/kubernetes/pki/etcd/ca.crt --from-file<span class=o>=</span>etcd-cert<span class=o>=</span>/etc/kubernetes/pki/etcd/healthcheck-client.crt --from-file<span class=o>=</span>etcd-key<span class=o>=</span>/etc/kubernetes/pki/etcd/healthcheck-client.key
</span></span></code></pre></td></tr></table></div></div><p>创建calico资源清单</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Shell data-lang=Shell><span class=line><span class=cl>kubectl apply -f calico-etcd.yaml
</span></span></code></pre></td></tr></table></div></div></li></ul></li></ul><p>​ 等待pod启动完成</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Shell data-lang=Shell><span class=line><span class=cl>kubectl -n kube-system get po 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>NAME                                       READY   STATUS    RESTARTS   AGE
</span></span><span class=line><span class=cl>calico-kube-controllers-59db5cf8fd-fpzdq   1/1     Running   <span class=m>1</span>          32m
</span></span><span class=line><span class=cl>calico-node-d2xq4                          1/1     Running   <span class=m>1</span>          32m
</span></span><span class=line><span class=cl>calico-node-ppzjk     
</span></span></code></pre></td></tr></table></div></div><p>calico插件包：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Shell data-lang=Shell><span class=line><span class=cl>docker.io/calico/cni:v3.20.2
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>docker.io/calico/pod2daemon-flexvol:v3.20.2
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>docker.io/calico/node:v3.20.2
</span></span></code></pre></td></tr></table></div></div><p><strong>方式二：使用operator安装</strong>(已成功！！！！！！)</p><ul><li><p>安装operator</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Shell data-lang=Shell><span class=line><span class=cl>kubectl create -f https://docs.projectcalico.org/manifests/tigera-operator.yaml
</span></span></code></pre></td></tr></table></div></div></li><li><p>等待operator pod安装启动完成</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Shell data-lang=Shell><span class=line><span class=cl>kubectl -n tigera-operator get po
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>NAME                               READY   STATUS    RESTARTS   AGE
</span></span><span class=line><span class=cl>tigera-operator-698876cbb5-kfpb2   1/1     Running   <span class=m>0</span>          38m
</span></span></code></pre></td></tr></table></div></div><blockquote><p>镜像拉取比较慢，可以手动去节点docker pull拉取</p></blockquote></li><li><p>编辑calico配置</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Shell data-lang=Shell><span class=line><span class=cl>vim custom-resources.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>apiVersion: operator.tigera.io/v1
</span></span><span class=line><span class=cl>kind: Installation
</span></span><span class=line><span class=cl>metadata:
</span></span><span class=line><span class=cl>  name: default
</span></span><span class=line><span class=cl>spec:
</span></span><span class=line><span class=cl>  <span class=c1># Configures Calico networking.</span>
</span></span><span class=line><span class=cl>  calicoNetwork:
</span></span><span class=line><span class=cl>    <span class=c1># Note: The ipPools section cannot be modified post-install.</span>
</span></span><span class=line><span class=cl>    ipPools:
</span></span><span class=line><span class=cl>    - blockSize: <span class=m>26</span>
</span></span><span class=line><span class=cl>      cidr: 10.244.0.0/16        <span class=c1>#修改和pod cidr一致</span>
</span></span><span class=line><span class=cl>      encapsulation: VXLANCrossSubnet
</span></span><span class=line><span class=cl>      natOutgoing: Enabled
</span></span><span class=line><span class=cl>      nodeSelector: all<span class=o>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>---
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># This section configures the Calico API server.</span>
</span></span><span class=line><span class=cl><span class=c1># For more information, see: https://docs.projectcalico.org/v3.20/reference/installation/api#operator.tigera.io/v1.APIServer</span>
</span></span><span class=line><span class=cl>apiVersion: operator.tigera.io/v1
</span></span><span class=line><span class=cl>kind: APIServer
</span></span><span class=line><span class=cl>metadata:
</span></span><span class=line><span class=cl>  name: default
</span></span><span class=line><span class=cl>spec: <span class=o>{}</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>创建calico配置</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Shell data-lang=Shell><span class=line><span class=cl>kubectl apply -f custom-resources.yaml
</span></span></code></pre></td></tr></table></div></div></li><li><p>等待operator自动创建calico的pod</p></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Shell data-lang=Shell><span class=line><span class=cl><span class=c1># operator会自动创建calico-apiserver和calico-system两个命名空间以及必要的pod，等待pod启动完成即可</span>
</span></span><span class=line><span class=cl>kubectl get ns
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>NAME               STATUS   AGE
</span></span><span class=line><span class=cl>calico-apiserver   Active   13m
</span></span><span class=line><span class=cl>calico-system      Active   19m
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kubectl -n calico-apiserver get po
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>NAME                                READY   STATUS    RESTARTS   AGE
</span></span><span class=line><span class=cl>calico-apiserver-554fbf9554-b6kzv   1/1     Running   <span class=m>0</span>          13m
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kubectl -n calico-system get po
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>NAME                                       READY   STATUS    RESTARTS   AGE
</span></span><span class=line><span class=cl>calico-kube-controllers-868b656ff4-hn6qv   1/1     Running   <span class=m>0</span>          20m
</span></span><span class=line><span class=cl>calico-node-qqrp9                          1/1     Running   <span class=m>0</span>          20m
</span></span><span class=line><span class=cl>calico-node-r45z2                          1/1     Running   <span class=m>0</span>          20m
</span></span><span class=line><span class=cl>calico-typha-5b64cf4b48-vws5j              1/1     Running   <span class=m>0</span>          20m
</span></span><span class=line><span class=cl>calico-typha-5b64cf4b48-w6wqf              1/1     Running   <span class=m>0</span>          20m
</span></span></code></pre></td></tr></table></div></div><h3 id=7-验证集群>7. 验证集群</h3><p>操作节点： 在master节点（<code>k8s-master</code>）执行</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Shell data-lang=Shell><span class=line><span class=cl>kubectl get nodes  <span class=c1>#观察集群节点是否全部Ready</span>
</span></span></code></pre></td></tr></table></div></div><p>创建测试nginx服务</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Shell data-lang=Shell><span class=line><span class=cl>kubectl run  test-nginx --image<span class=o>=</span>nginx:alpine
</span></span></code></pre></td></tr></table></div></div><p>查看pod是否创建成功，并访问pod ip测试是否可用</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Shell data-lang=Shell><span class=line><span class=cl>kubectl get po -o wide
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>NAME                          READY   STATUS    RESTARTS   AGE   IP           NODE         NOMINATED NODE   READINESS GATES
</span></span><span class=line><span class=cl>test-nginx-5bd8859b98-5nnnw   1/1     Running   <span class=m>0</span>          9s    10.244.1.2   k8s-slave1   &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>curl 10.244.1.2
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;
</span></span><span class=line><span class=cl>&lt;p&gt;If you see this page, the nginx web server is successfully installed and
</span></span><span class=line><span class=cl>working. Further configuration is required.&lt;/p&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&lt;p&gt;For online documentation and support please refer to
</span></span><span class=line><span class=cl>&lt;a <span class=nv>href</span><span class=o>=</span><span class=s2>&#34;http://nginx.org/&#34;</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;
</span></span><span class=line><span class=cl>Commercial support is available at
</span></span><span class=line><span class=cl>&lt;a <span class=nv>href</span><span class=o>=</span><span class=s2>&#34;http://nginx.com/&#34;</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&lt;p&gt;&lt;em&gt;Thank you <span class=k>for</span> using nginx.&lt;/em&gt;&lt;/p&gt;
</span></span><span class=line><span class=cl>&lt;/body&gt;
</span></span><span class=line><span class=cl>&lt;/html&gt;
</span></span></code></pre></td></tr></table></div></div><h3 id=8-清理环境>8. 清理环境</h3><p>如果你的集群安装过程中遇到了其他问题，我们可以使用下面的命令来进行重置：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Shell data-lang=Shell><span class=line><span class=cl><span class=c1># 在全部集群节点执行</span>
</span></span><span class=line><span class=cl>kubeadm reset
</span></span><span class=line><span class=cl>ifconfig cni0 down <span class=o>&amp;&amp;</span> ip link delete cni0
</span></span><span class=line><span class=cl>ifconfig flannel.1 down <span class=o>&amp;&amp;</span> ip link delete flannel.1
</span></span><span class=line><span class=cl>rm -rf /run/flannel/subnet.env
</span></span><span class=line><span class=cl>rm -rf /var/lib/cni/
</span></span><span class=line><span class=cl>mv /etc/kubernetes/ /tmp
</span></span><span class=line><span class=cl>mv /var/lib/etcd /tmp
</span></span><span class=line><span class=cl>mv ~/.kube /tmp
</span></span><span class=line><span class=cl>iptables -F
</span></span><span class=line><span class=cl>iptables -t nat -F
</span></span><span class=line><span class=cl>ipvsadm -C
</span></span><span class=line><span class=cl>ip link del kube-ipvs0
</span></span><span class=line><span class=cl>ip link del dummy0
</span></span></code></pre></td></tr></table></div></div><p>设置apt源报错。换源</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Shell data-lang=Shell><span class=line><span class=cl>apt-get update <span class=o>&amp;&amp;</span> apt-get install -y apt-transport-https ca-certificates software-properties-common 
</span></span><span class=line><span class=cl>curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg <span class=p>|</span> apt-key add - 
</span></span><span class=line><span class=cl>curl -fsSL http://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg <span class=p>|</span> apt-key add -
</span></span><span class=line><span class=cl>add-apt-repository <span class=s2>&#34;deb [arch=amd64] http://mirrors.aliyun.com/docker-ce/linux/ubuntu </span><span class=k>$(</span>lsb_release -cs<span class=k>)</span><span class=s2> stable&#34;</span>
</span></span><span class=line><span class=cl>add-apt-repository <span class=s2>&#34;deb [arch=amd64] https://mirrors.aliyun.com/kubernetes/apt kubernetes-xenial main&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>apt-get update   
</span></span><span class=line><span class=cl><span class=c1>#若上步出现NO_PUBLICKEY问题，参考https://www.cnblogs.com/jiangzuo/p/13667011.html</span>
</span></span></code></pre></td></tr></table></div></div><p>未安装cni插件pod状态</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Shell data-lang=Shell><span class=line><span class=cl> coredns-7f6cbbb7b8-c778v pod 不能启动因为未安装cni插件。 
</span></span><span class=line><span class=cl>  events:
</span></span><span class=line><span class=cl>  Warning  FailedScheduling  43s <span class=o>(</span>x2 over 2m13s<span class=o>)</span>  default-scheduler  0/3 nodes are available: <span class=m>3</span> node<span class=o>(</span>s<span class=o>)</span> had taint <span class=o>{</span>node.kubernetes.io/not-ready: <span class=o>}</span>, that the pod didn<span class=err>&#39;</span>t tolerate.
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  root@master:~# k get po -A -owide 
</span></span><span class=line><span class=cl>NAMESPACE     NAME                             READY   STATUS    RESTARTS   AGE     IP          NODE      NOMINATED NODE   READINESS GATES
</span></span><span class=line><span class=cl>kube-system   coredns-7f6cbbb7b8-c778v         0/1     Pending   <span class=m>0</span>          3m54s   &lt;none&gt;      &lt;none&gt;    &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>kube-system   coredns-7f6cbbb7b8-px7cm         0/1     Pending   <span class=m>0</span>          3m54s   &lt;none&gt;      &lt;none&gt;    &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>kube-system   etcd-master                      1/1     Running   <span class=m>0</span>          4m7s    10.4.7.70   master    &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>kube-system   kube-apiserver-master            1/1     Running   <span class=m>0</span>          4m7s    10.4.7.70   master    &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>kube-system   kube-controller-manager-master   1/1     Running   <span class=m>0</span>          4m7s    10.4.7.70   master    &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>kube-system   kube-proxy-5w6c4                 1/1     Running   <span class=m>0</span>          3m23s   10.4.7.71   worker1   &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>kube-system   kube-proxy-6jnkr                 1/1     Running   <span class=m>0</span>          3m20s   10.4.7.72   worker2   &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>kube-system   kube-proxy-hcwtz                 1/1     Running   <span class=m>0</span>          3m54s   10.4.7.70   master    &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>kube-system   kube-scheduler-master            1/1     Running   <span class=m>0</span>          4m8s    10.4.7.70   master    &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></td></tr></table></div></div><div class="details admonition warning open"><div class="details-summary admonition-title"><i class="icon fas fa-exclamation-triangle fa-fwwarning"></i>警告<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content>本文最后更新于 <span class=timeago datetime=2022-01-02T18:15:28 title="January 2, 2022">January 2, 2022</span>，文中内容可能已过时，请谨慎使用。</div></div></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2022-01-02</span></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/k8s%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/index.md target=_blank>阅读原始文档</a></span></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/k8s/>k8s</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/ubuntu%E7%B3%BB%E7%BB%9F%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E/ class=prev rel=prev title=ubuntu系统使用说明><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>ubuntu系统使用说明</a>
<a href=/nginx%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8/ class=next rel=next title=nginx安装与使用>nginx安装与使用<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><span id=run-time></span></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2021 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>Peng</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=stylesheet href=/lib/katex/copy-tex.min.css><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.css><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/lunr/lunr.min.js></script><script type=text/javascript src=/lib/lunr/lunr.stemmer.support.min.js></script><script type=text/javascript src=/lib/lunr/lunr.zh.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js></script><script type=text/javascript src=/lib/katex/auto-render.min.js></script><script type=text/javascript src=/lib/katex/copy-tex.min.js></script><script type=text/javascript src=/lib/katex/mhchem.min.js></script><script type=text/javascript src=/lib/cookieconsent/cookieconsent.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:0},comment:{},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验."},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",lunrIndexURL:"/index.json",lunrLanguageCode:"zh",lunrSegmentitURL:"/lib/lunr/lunr.segmentit.js",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js></script><script type=text/javascript src=/js/custom.js></script>
<script type=text/javascript src=https://cdn.jsdelivr.net/npm/jquery@2.1.3/dist/jquery.min.js></script></body></html>